<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ê³„ë¶€</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f7f7fb;
            min-height: 100vh;
            padding: 20px;
            color: #111827;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 16px;
            backdrop-filter: none;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }
        
        .header {
            background: #ffffff;
            color: #111827;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .stats { display: none; }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-card .emoji {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .stat-card h3 {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .table-container {
            padding: 30px;
            overflow-x: auto;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-box { display: none; }
        
        .search-box:focus-within {
            border-color: #4f46e5;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.1);
        }
        
        .search-box input {
            border: none;
            outline: none;
            font-size: 14px;
            padding: 5px;
            width: 200px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .filter-btn:hover {
            border-color: #4f46e5;
            color: #4f46e5;
        }
        
        .filter-btn.active {
            background: #4f46e5;
            border-color: #4f46e5;
            color: white;
        }
        
        .budget-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: visible;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            table-layout: fixed;
        }
        
        .budget-table th {
            background: #f8fafc;
            padding: 18px 15px;
            text-align: center;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .budget-table td {
            padding: 16px 15px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }

        /* ë°ìŠ¤í¬íƒ‘/ê¸°ë³¸ ì»¬ëŸ¼ ê³ ì • ë„ˆë¹„ (ìš”ì²­ ë¹„ìœ¨) */
        .budget-table th:nth-child(1),
        .budget-table td:nth-child(1) { /* ë‚ ì§œ */
            width: 10%;
            text-align: center;
        }
        .budget-table th:nth-child(2),
        .budget-table td:nth-child(2) { /* í•­ëª© */
            width: 12% !important;
            min-width: 80px;
            max-width: 80px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .budget-table th:nth-child(3),
        .budget-table td:nth-child(3) { /* ë‚´ìš© */
            width: 33%;
        }
        .budget-table th:nth-child(4),
        .budget-table td:nth-child(4) { /* ê²°ì œë°©ë²• */
            width: 12%;
            text-align: center;
        }
        .budget-table th:nth-child(5) { /* ê¸ˆì•¡ í—¤ë” */
            width: 16%;
            text-align: center;
        }
        .budget-table td:nth-child(5) { /* ê¸ˆì•¡ ê°’ */
            width: 16%;
            text-align: right;
        }
        .budget-table th:nth-child(6),
        .budget-table td:nth-child(6) { /* ì‚­ì œ */
            width: 10%;
            text-align: center;
            white-space: nowrap;
        }
        
        .budget-table tr:hover {
            background: rgba(79, 70, 229, 0.02);
        }
        
        .category-cell {
            /* flex ë ˆì´ì•„ì›ƒ ì œê±°í•˜ì—¬ ë‹¤ë¥¸ ì…€ê³¼ ë™ì¼í•œ í‘œì‹œ */
        }
        
        .category-emoji { display: none; }
        
        .amount-cell {
            font-weight: 600;
            text-align: right;
        }
        
        .amount-krw {
            color: #2563eb; /* íŒŒë€ìƒ‰ */
        }
        
        .amount-jpy {
            color: #dc2626; /* ë¹¨ê°„ìƒ‰ ìœ ì§€ */
        }
        
        .payment-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .payment-card {
            background: #dbeafe;
            color: #1d4ed8;
        }
        
        .payment-cash {
            background: #dcfce7;
            color: #166534;
        }
        
        .date-cell {
            color: #6b7280;
            font-weight: 500;
        }
        
        .content-cell {
            max-width: 200px;
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .editable-cell {
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s ease;
        }
        
        .editable-cell:hover {
            background-color: rgba(79, 70, 229, 0.05);
        }
        
        .editable-cell.editing {
            background-color: rgba(79, 70, 229, 0.1);
        }
        
        .inline-input {
            width: 100%;
            border: 2px solid #4f46e5;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
            outline: none;
            background: white;
        }
        
        .inline-select {
            width: 100%;
            border: 2px solid #4f46e5;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
            outline: none;
            background: white;
        }
        
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .no-data .emoji { display: none; }
        
        .export-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            font-size: 14px;
        }
        
        .export-btn:hover {
            transform: translateY(-1px);
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 15px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                padding: 15px;
                gap: 10px;
            }
            
            .table-container {
                padding: 10px;
                overflow-x: auto;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            

            
            .filter-buttons {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .filter-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .export-btn {
                padding: 10px 20px;
                font-size: 12px;
            }
            
            .search-box input {
                width: 100%;
            }
            
            .budget-table {
                font-size: 11px;
                min-width: 100%;
                table-layout: fixed;
                white-space: normal;
            }
            
            .budget-table th,
            .budget-table td {
                padding: 8px 4px;
                font-size: 11px;
            }
            
            /* 768px ì´í•˜ ì»¬ëŸ¼ ê³ ì • ë„ˆë¹„ (ìš”ì²­ ë¹„ìœ¨) */
            .budget-table th:nth-child(1),
            .budget-table td:nth-child(1) { /* ë‚ ì§œ */
                width: 10%;
                text-align: center;
            }

            .budget-table th:nth-child(2),
            .budget-table td:nth-child(2) { /* í•­ëª© */
                width: 12% !important;
                min-width: 60px;
                max-width: 60px;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .budget-table th:nth-child(3),
            .budget-table td:nth-child(3) { /* ë‚´ìš© */
                width: 36%;
            }

            .budget-table th:nth-child(4),
            .budget-table td:nth-child(4) { /* ê²°ì œë°©ë²• */
                width: 12%;
                text-align: center;
            }

            .budget-table th:nth-child(5) { /* ê¸ˆì•¡ (í—¤ë” ê°€ìš´ë°) */
                width: 16%;
                text-align: center;
            }

            .budget-table td:nth-child(5) { /* ê¸ˆì•¡ ê°’ì€ ì˜¤ë¥¸ìª½ ì •ë ¬ */
                width: 16%;
                text-align: right;
            }

            .budget-table th:nth-child(6),
            .budget-table td:nth-child(6) { /* ì‚­ì œ */
                width: 10%;
                text-align: center;
                white-space: nowrap;
            }

            .content-cell {
                max-width: none;
                word-break: break-all;
                white-space: normal;
                line-height: 1.2;
            }
            
            .date-cell {
                min-width: 60px;
                font-size: 10px;
            }
            
            .amount-cell {
                min-width: 70px;
                font-size: 11px;
                font-weight: 600;
            }
            
            .payment-badge {
                padding: 2px 6px;
                font-size: 10px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                margin: 0;
            }
            
            .header {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .stats {
                grid-template-columns: 1fr;
                padding: 10px;
            }
            
            .table-container {
                padding: 5px;
            }
            
            .budget-table {
                font-size: 10px;
                table-layout: fixed;
                white-space: normal;
            }
            
            .budget-table th,
            .budget-table td {
                padding: 6px 2px;
                font-size: 10px;
            }
            
            /* 480px ì´í•˜ ì»¬ëŸ¼ ê³ ì • ë„ˆë¹„ (ìš”ì²­ ë¹„ìœ¨) */
            .budget-table th:nth-child(1),
            .budget-table td:nth-child(1) { /* ë‚ ì§œ */
                width: 10%;
                text-align: center;
            }

            .budget-table th:nth-child(2),
            .budget-table td:nth-child(2) { /* í•­ëª© */
                width: 12% !important;
                min-width: 50px;
                max-width: 50px;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .budget-table th:nth-child(3),
            .budget-table td:nth-child(3) { /* ë‚´ìš© */
                width: 23%;
            }

            .budget-table th:nth-child(4),
            .budget-table td:nth-child(4) { /* ê²°ì œë°©ë²• */
                width: 12%;
                text-align: center;
            }

            .budget-table th:nth-child(5) { /* ê¸ˆì•¡ (í—¤ë” ê°€ìš´ë°) */
                width: 23%;
                text-align: center;
            }

            .budget-table td:nth-child(5) { /* ê¸ˆì•¡ ê°’ì€ ì˜¤ë¥¸ìª½ ì •ë ¬ */
                width: 23%;
                text-align: right;
            }

            .budget-table th:nth-child(6),
            .budget-table td:nth-child(6) { /* ì‚­ì œ */
                width: 10%;
                text-align: center;
                white-space: nowrap;
            }
            
            .content-cell {
                max-width: none;
                word-break: break-all;
                white-space: normal;
                line-height: 1.1;
            }
            
            .date-cell {
                font-size: 9px;
            }
            
            .amount-cell {
                font-size: 10px;
            }
            
            .payment-badge {
                padding: 1px 4px;
                font-size: 9px;
            }
            
            /* ì‚­ì œ ë²„íŠ¼ í¬ê¸° ì¡°ì • */
            .budget-table button {
                padding: 2px 4px;
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ê°€ê³„ë¶€</h1>
            <p>ì—¬í–‰ ì§€ì¶œ ë‚´ì—­ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
        </div>
        
        <div class="stats" id="statsContainer">
            <!-- í†µê³„ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>
        
        <div class="table-container">
            <div class="controls">
                <div style="display: flex; gap: 10px; justify-content: space-between;">
                    <button class="export-btn" onclick="exportToCSV()" style="flex: 1; background: white; color: #333; border: 2px solid white; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);">CSV ë‚´ë³´ë‚´ê¸°</button>
                    <button class="export-btn" onclick="showAddBudgetDialog()" style="flex: 1; background: white; color: #333; border: 2px solid white; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);">í•­ëª© ì¶”ê°€</button>
                </div>
            </div>
            
            <table class="budget-table" id="budgetTable">
                <thead>
                    <tr>
                        <th onclick="toggleDateSort()" style="cursor: pointer; user-select: none;" id="dateHeader">ë‚ ì§œ â†“</th>
                        <th onclick="toggleCategoryDropdown(event)" style="cursor: pointer; user-select: none; position: relative; z-index: 3; overflow: visible;" id="categoryHeader">
                            í•­ëª©
                            <div id="categoryDropdown" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #e5e7eb; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 9999; margin-top: 5px; min-width: 140px;">
                                <div onclick="event.stopPropagation(); selectCategory('all')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6; font-weight: 600;">ì „ì²´</div>
                                <div onclick="event.stopPropagation(); selectCategory('ì‹ë¹„')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6;">ì‹ë¹„</div>
                                <div onclick="event.stopPropagation(); selectCategory('êµí†µë¹„')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6;">êµí†µë¹„</div>
                                <div onclick="event.stopPropagation(); selectCategory('ìˆ™ë°•ë¹„')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6;">ìˆ™ë°•ë¹„</div>
                                <div onclick="event.stopPropagation(); selectCategory('ì‡¼í•‘')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6;">ì‡¼í•‘</div>
                                <div onclick="event.stopPropagation(); selectCategory('ê¸°íƒ€')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding: 8px 12px; cursor: pointer;">ê¸°íƒ€</div>
                            </div>
                        </th>
                        <th>ë‚´ìš©</th>
                        <th onclick="togglePaymentFilter()" style="cursor: pointer; user-select: none;" id="paymentHeader">ê²°ì œë°©ë²•</th>
                        <th>ê¸ˆì•¡</th>
                        <th>ì‚­ì œ</th>
                    </tr>
                </thead>
                <tbody id="budgetTableBody">
                    <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </tbody>
                <tfoot id="budgetTableFooter"></tfoot>
            </table>
            
            <div class="no-data" id="noDataMessage" style="display: none;">
                <div class="emoji">ğŸ“</div>
                <h3>ê°€ê³„ë¶€ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>í™‹ì¹´ì´ë„ ì—¬í–‰ì§€ë„ì—ì„œ ê°€ê³„ë¶€ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (v9 modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, arrayUnion, arrayRemove, getDoc, serverTimestamp, orderBy, query } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        
        // Firebase ì„¤ì • (index47m.htmlê³¼ ë™ì¼)
        const firebaseConfig = {
            apiKey: "AIzaSyBhndv9tfh_Uu8Nkm7AZxjRCNIgvnGEj_c",
            authDomain: "travelplan250826.firebaseapp.com",
            projectId: "travelplan250826",
            storageBucket: "travelplan250826.firebasestorage.app",
            messagingSenderId: "918345537744",
            appId: "1:918345537744:web:08d0daace8cb0ec021e6d5",
            measurementId: "G-18R59NTNBT"
        };
        
        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì • (ê¸°ì¡´ ë°©ì‹ê³¼ í˜¸í™˜)
        window.db = db;
        window.firestore = {
            doc: doc,
            updateDoc: updateDoc,
            getDoc: getDoc,
            arrayUnion: arrayUnion,
            arrayRemove: arrayRemove,
            serverTimestamp: serverTimestamp,
            query: query,
            orderBy: orderBy,
            getDocs: getDocs
        };
        
        console.log('ê°€ê³„ë¶€ Firebase ì—°ê²° ì™„ë£Œ!');
    </script>
    
    <script>
        
        let budgetData = [];
        let filteredData = [];
        let dateSortOrder = 'desc'; // 'desc' = ë‚´ë¦¼ì°¨ìˆœ(ìµœì‹ ìˆœ), 'asc' = ì˜¤ë¦„ì°¨ìˆœ(ì˜¤ë˜ëœìˆœ)
        let currentCategoryFilter = 'all'; // í˜„ì¬ ì¹´í…Œê³ ë¦¬ í•„í„°
        let currentPaymentFilter = 'all'; // 'all', 'card', 'cash'
        
        // ì¹´í…Œê³ ë¦¬ë³„ ì´ëª¨ì§€ ë§¤í•‘
        const categoryEmojis = {
            'ì‹ë¹„': 'ğŸ½ï¸',
            'êµí†µë¹„': 'ğŸšŒ',
            'ìˆ™ë°•ë¹„': 'ğŸ¨',
            'ì‡¼í•‘': 'ğŸ›’',
            'ê¸°íƒ€': 'ğŸ’¡'
        };
        
        // Firebaseì—ì„œ ê°€ê³„ë¶€ ë°ì´í„° ë¡œë“œ (ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©)
        async function loadBudgetDataFromFirebase() {
            try {
                if (!window.db || !window.firestore) {
                    console.warn('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    loadBudgetDataFromURL();
                    return;
                }
                
                const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
                const docSnap = await window.firestore.getDoc(userDocRef);
                
                if (docSnap.exists() && docSnap.data().budgetItems) {
                    budgetData = docSnap.data().budgetItems || [];
                    // ë‚ ì§œ ê¸°ì¤€ ìµœì‹ ìˆœ ì •ë ¬ (ë‚ ì§œê°€ ê°™ìœ¼ë©´ timestamp ê¸°ì¤€)
                    budgetData.sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        if (dateA.getTime() !== dateB.getTime()) {
                            return dateB.getTime() - dateA.getTime(); // ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ
                        }
                        return (b.timestamp || 0) - (a.timestamp || 0); // ê°™ì€ ë‚ ì§œë©´ ì…ë ¥ì‹œê°„ ë‚´ë¦¼ì°¨ìˆœ
                    });
                } else {
                    budgetData = [];
                }
                
                filteredData = [...budgetData];
                
                // localStorageì—ì„œ ì„ì‹œ ì €ì¥ëœ ë°ì´í„°ê°€ ìˆë‹¤ë©´ Firebaseë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
                await migrateLocalStorageToFirebase();
                
                renderStats();
                renderTable();
                console.log('Firebaseì—ì„œ ê°€ê³„ë¶€ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', budgetData.length + 'ê°œ í•­ëª©');
            } catch (error) {
                console.error('Firebase ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                // Firebase ë¡œë“œ ì‹¤íŒ¨ì‹œ URL íŒŒë¼ë¯¸í„°ì—ì„œ ë¡œë“œ ì‹œë„
                loadBudgetDataFromURL();
            }
        }
        
        // localStorage ì„ì‹œ ë°ì´í„°ë¥¼ Firebaseë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
        async function migrateLocalStorageToFirebase() {
            try {
                const localData = JSON.parse(localStorage.getItem('budgetList') || '[]');
                if (localData.length === 0) return;
                
                console.log('localStorageì—ì„œ ' + localData.length + 'ê°œ í•­ëª© ë°œê²¬, Firebaseë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...');
                
                // ê¸°ì¡´ Firebase ë°ì´í„°ì™€ ì¤‘ë³µ í™•ì¸ì„ ìœ„í•œ timestamp ëª©ë¡
                const existingTimestamps = budgetData.map(item => item.timestamp);
                
                let migratedCount = 0;
                for (const item of localData) {
                    // ì¤‘ë³µ í™•ì¸ (timestamp ê¸°ì¤€)
                    if (!existingTimestamps.includes(item.timestamp)) {
                        try {
                            // Firebaseì— ê°œë³„ í•­ëª© ì¶”ê°€
                            const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
                            await window.firestore.updateDoc(userDocRef, {
                                budgetItems: window.firestore.arrayUnion(item)
                            });
                            migratedCount++;
                        } catch (error) {
                            console.error('ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨í•œ í•­ëª©:', item, error);
                        }
                    }
                }
                
                if (migratedCount > 0) {
                    console.log(migratedCount + 'ê°œ í•­ëª© Firebase ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ');
                    // ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í›„ localStorage ì •ë¦¬
                    localStorage.removeItem('budgetList');
                    
                    // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                    const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
                    const docSnap = await window.firestore.getDoc(userDocRef);
                    if (docSnap.exists() && docSnap.data().budgetItems) {
                        budgetData = docSnap.data().budgetItems || [];
                        // ë‚ ì§œ ê¸°ì¤€ ìµœì‹ ìˆœ ì •ë ¬
                        budgetData.sort((a, b) => {
                            const dateA = new Date(a.date);
                            const dateB = new Date(b.date);
                            if (dateA.getTime() !== dateB.getTime()) {
                                return dateB.getTime() - dateA.getTime();
                            }
                            return (b.timestamp || 0) - (a.timestamp || 0);
                        });
                        filteredData = [...budgetData];
                    }
                } else {
                    // ì¤‘ë³µ ë°ì´í„°ë§Œ ìˆì—ˆë‹¤ë©´ localStorage ì •ë¦¬
                    localStorage.removeItem('budgetList');
                    console.log('ì¤‘ë³µ ë°ì´í„°ë§Œ ìˆì–´ì„œ localStorage ì •ë¦¬');
                }
            } catch (error) {
                console.error('localStorage ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨:', error);
            }
        }
        
        // Firebaseì— ê°€ê³„ë¶€ ë°ì´í„° ì €ì¥ (ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©)
        async function saveBudgetDataToFirebase(budgetItem) {
            try {
                if (!window.db || !window.firestore) {
                    throw new Error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
                await window.firestore.updateDoc(userDocRef, {
                    budgetItems: window.firestore.arrayUnion(budgetItem),
                    lastUpdated: window.firestore.serverTimestamp()
                });
                
                console.log('Firebaseì— ê°€ê³„ë¶€ ë°ì´í„° ì €ì¥ ì™„ë£Œ:', budgetItem.id);
                return budgetItem.id;
            } catch (error) {
                console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', error);
                throw error;
            }
        }
        
        // Firebaseì—ì„œ ê°€ê³„ë¶€ ë°ì´í„° ì‚­ì œ (ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©)
        async function deleteBudgetDataFromFirebase(itemId) {
            try {
                if (!window.db || !window.firestore) {
                    throw new Error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                // ì‚­ì œí•  í•­ëª© ì°¾ê¸° (id ë˜ëŠ” timestampë¡œ)
                const itemToDelete = budgetData.find(item => (item.id || item.timestamp) === itemId);
                if (!itemToDelete) {
                    throw new Error('ì‚­ì œí•  í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
                await window.firestore.updateDoc(userDocRef, {
                    budgetItems: window.firestore.arrayRemove(itemToDelete),
                    lastUpdated: window.firestore.serverTimestamp()
                });
                
                console.log('Firebaseì—ì„œ ê°€ê³„ë¶€ ë°ì´í„° ì‚­ì œ ì™„ë£Œ:', itemId);
            } catch (error) {
                console.error('Firebase ì‚­ì œ ì‹¤íŒ¨:', error);
                throw error;
            }
        }
        
        // Firebaseì—ì„œ ê°€ê³„ë¶€ ë°ì´í„° ìˆ˜ì • (ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©)
        async function updateBudgetDataInFirebase(itemId, updatedData) {
            try {
                if (!window.db || !window.firestore) {
                    throw new Error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                // ê¸°ì¡´ í•­ëª© ì°¾ê¸° (id ë˜ëŠ” timestampë¡œ)
                const oldItem = budgetData.find(item => (item.id || item.timestamp) === itemId);
                if (!oldItem) {
                    throw new Error('ìˆ˜ì •í•  í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ìƒˆ í•­ëª© ìƒì„±
                const updatedItem = { ...oldItem, ...updatedData };
                
                const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
                
                // ê¸°ì¡´ í•­ëª© ì œê±° í›„ ìƒˆ í•­ëª© ì¶”ê°€
                await window.firestore.updateDoc(userDocRef, {
                    budgetItems: window.firestore.arrayRemove(oldItem)
                });
                
                await window.firestore.updateDoc(userDocRef, {
                    budgetItems: window.firestore.arrayUnion(updatedItem),
                    lastUpdated: window.firestore.serverTimestamp()
                });
                
                console.log('Firebaseì—ì„œ ê°€ê³„ë¶€ ë°ì´í„° ìˆ˜ì • ì™„ë£Œ:', itemId);
            } catch (error) {
                console.error('Firebase ìˆ˜ì • ì‹¤íŒ¨:', error);
                throw error;
            }
        }
        
        // URLì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (Firebase ì‹¤íŒ¨ì‹œ ë°±ì—…ìš©)
        function loadBudgetDataFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            
            if (dataParam) {
                try {
                    budgetData = JSON.parse(decodeURIComponent(dataParam));
                    filteredData = [...budgetData];
                    
                    // ë‚ ì§œ ê¸°ì¤€ ìµœì‹ ìˆœ ì •ë ¬
                    const sortByDate = (a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        if (dateA.getTime() !== dateB.getTime()) {
                            return dateB.getTime() - dateA.getTime();
                        }
                        return (b.timestamp || 0) - (a.timestamp || 0);
                    };
                    budgetData.sort(sortByDate);
                    filteredData.sort(sortByDate);
                    
                    renderStats();
                    renderTable();
                    console.log('URLì—ì„œ ê°€ê³„ë¶€ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', budgetData.length + 'ê°œ í•­ëª©');
                } catch (error) {
                    console.error('URL ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', error);
                    showNoData();
                }
            } else {
                showNoData();
            }
        }
        
        // í†µê³„ ì¹´ë“œ ë Œë”ë§ (ë¯¸ì‚¬ìš©: ë¯¸ë‹ˆë©€ UI)
        function renderStats() {
            const statsContainer = document.getElementById('statsContainer');
            if (statsContainer) statsContainer.innerHTML = '';
        }
        
        // ë‚ ì§œ ì •ë ¬ í† ê¸€ í•¨ìˆ˜
        function toggleDateSort() {
            dateSortOrder = dateSortOrder === 'desc' ? 'asc' : 'desc';
            sortDataByDate();
            updateDateHeader();
            renderTable();
        }
        
        // ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„° ì •ë ¬
        function sortDataByDate() {
            const sortFunction = (a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA.getTime() !== dateB.getTime()) {
                    if (dateSortOrder === 'desc') {
                        return dateB.getTime() - dateA.getTime(); // ë‚´ë¦¼ì°¨ìˆœ
                    } else {
                        return dateA.getTime() - dateB.getTime(); // ì˜¤ë¦„ì°¨ìˆœ
                    }
                }
                // ê°™ì€ ë‚ ì§œë©´ timestamp ê¸°ì¤€
                if (dateSortOrder === 'desc') {
                    return (b.timestamp || 0) - (a.timestamp || 0);
                } else {
                    return (a.timestamp || 0) - (b.timestamp || 0);
                }
            };
            
            budgetData.sort(sortFunction);
            filteredData.sort(sortFunction);
        }
        
        // ë‚ ì§œ í—¤ë” ì—…ë°ì´íŠ¸
        function updateDateHeader() {
            const dateHeader = document.getElementById('dateHeader');
            if (dateHeader) {
                dateHeader.textContent = dateSortOrder === 'desc' ? 'ë‚ ì§œ â†“' : 'ë‚ ì§œ â†‘';
            }
        }
        
        // ê²°ì œë°©ë²• í•„í„° í† ê¸€
        function togglePaymentFilter() {
            if (currentPaymentFilter === 'all') {
                currentPaymentFilter = 'cash';
            } else if (currentPaymentFilter === 'cash') {
                currentPaymentFilter = 'card';
            } else {
                currentPaymentFilter = 'all';
            }
            updatePaymentHeader();
            applyFilters();
        }
        
        // ê²°ì œë°©ë²• í—¤ë” ì—…ë°ì´íŠ¸
        function updatePaymentHeader() {
            const paymentHeader = document.getElementById('paymentHeader');
            if (paymentHeader) {
                switch (currentPaymentFilter) {
                    case 'cash':
                        paymentHeader.textContent = 'ê²°ì œë°©ë²•(í˜„ê¸ˆ)';
                        paymentHeader.style.color = '#166534';
                        break;
                    case 'card':
                        paymentHeader.textContent = 'ê²°ì œë°©ë²•(ì¹´ë“œ)';
                        paymentHeader.style.color = '#1d4ed8';
                        break;
                    default:
                        paymentHeader.textContent = 'ê²°ì œë°©ë²•';
                        paymentHeader.style.color = '#374151';
                        break;
                }
            }
        }
        
        // ì¹´í…Œê³ ë¦¬ ë“œë¡­ë‹¤ìš´ í† ê¸€
        function toggleCategoryDropdown(event) {
            if (event) {
                event.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
            }
            
            const dropdown = document.getElementById('categoryDropdown');
            console.log('toggleCategoryDropdown í˜¸ì¶œë¨'); // ë””ë²„ê¹…ìš©
            console.log('dropdown ìš”ì†Œ:', dropdown); // ë””ë²„ê¹…ìš©
            
            if (dropdown) {
                const currentDisplay = window.getComputedStyle(dropdown).display;
                const isHidden = currentDisplay === 'none';
                dropdown.style.display = isHidden ? 'block' : 'none';
                console.log('í˜„ì¬ display:', currentDisplay, 'â†’ ë³€ê²½ í›„:', dropdown.style.display); // ë””ë²„ê¹…ìš©
            } else {
                console.error('categoryDropdown ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                // ë“œë¡­ë‹¤ìš´ì´ ì—†ë‹¤ë©´ í—¤ë”ë¥¼ ë‹¤ì‹œ ìƒì„±
                updateCategoryHeader();
            }
        }
        
        // ì¹´í…Œê³ ë¦¬ ì„ íƒ
        function selectCategory(category) {
            currentCategoryFilter = category;
            updateCategoryHeader();
            hideDropdown();
            applyFilters();
        }
        
        // ì¹´í…Œê³ ë¦¬ í—¤ë” ì—…ë°ì´íŠ¸
        function updateCategoryHeader() {
            const categoryHeader = document.getElementById('categoryHeader');
            if (categoryHeader) {
                const headerText = currentCategoryFilter === 'all' ? 'í•­ëª©' : `í•­ëª©(${currentCategoryFilter})`;
                
                // ê¸°ì¡´ ë“œë¡­ë‹¤ìš´ HTMLì„ ë³´ì¡´
                const dropdownHTML = `
                    <div id="categoryDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e5e7eb; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 1000; margin-top: 5px;">
                        <div onclick="event.stopPropagation(); selectCategory('all')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6; font-weight: 600;">ì „ì²´</div>
                        <div onclick="event.stopPropagation(); selectCategory('ì‹ë¹„')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6;">ì‹ë¹„</div>
                        <div onclick="event.stopPropagation(); selectCategory('êµí†µë¹„')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6;">êµí†µë¹„</div>
                        <div onclick="event.stopPropagation(); selectCategory('ìˆ™ë°•ë¹„')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6;">ìˆ™ë°•ë¹„</div>
                        <div onclick="event.stopPropagation(); selectCategory('ì‡¼í•‘')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6;">ì‡¼í•‘</div>
                        <div onclick="event.stopPropagation(); selectCategory('ê¸°íƒ€')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding: 8px 12px; cursor: pointer;">ê¸°íƒ€</div>
                    </div>
                `;
                
                categoryHeader.innerHTML = headerText + dropdownHTML;
                
                // ìƒ‰ìƒ ë³€ê²½
                if (currentCategoryFilter === 'all') {
                    categoryHeader.style.color = '#374151';
                } else {
                    categoryHeader.style.color = '#4f46e5';
                }
            }
        }
        
        // ë“œë¡­ë‹¤ìš´ ìˆ¨ê¸°ê¸°
        function hideDropdown() {
            const dropdown = document.getElementById('categoryDropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }
        
        // ëª¨ë“  í•„í„° ì ìš©
        function applyFilters() {
            filteredData = budgetData.filter(item => {
                // ì¹´í…Œê³ ë¦¬ í•„í„°
                const categoryMatch = currentCategoryFilter === 'all' || item.category === currentCategoryFilter;
                
                // ê²°ì œë°©ë²• í•„í„°
                let paymentMatch = true;
                if (currentPaymentFilter === 'cash') {
                    paymentMatch = item.payment === 'í˜„ê¸ˆ';
                } else if (currentPaymentFilter === 'card') {
                    paymentMatch = item.payment === 'ì¹´ë“œ';
                }
                
                return categoryMatch && paymentMatch;
            });
            
            // í˜„ì¬ ì •ë ¬ ìˆœì„œ ì ìš©
            sortDataByDate();
            renderTable();
        }
        
        // í…Œì´ë¸” ë Œë”ë§
        function renderTable() {
            const tableBody = document.getElementById('budgetTableBody');
            const noDataMessage = document.getElementById('noDataMessage');
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = '';
                noDataMessage.style.display = 'block';
                return;
            }
            
            noDataMessage.style.display = 'none';
            
            const tableHTML = filteredData.map(item => {
                const dateObj = new Date(item.date);
                const formattedDate = `${dateObj.getMonth() + 1}/${dateObj.getDate().toString().padStart(2, '0')}`;
                
                const currencySymbol = item.currency === 'ì›í™”' ? 'ì›' : 'Â¥';
                const amountClass = item.currency === 'ì›í™”' ? 'amount-krw' : 'amount-jpy';
                const paymentClass = item.payment === 'ì¹´ë“œ' ? 'payment-card' : 'payment-cash';
                
                return `
                    <tr data-item-id="${item.id || item.timestamp}">
                        <td class="date-cell editable-cell" data-field="date" data-type="date" onclick="editCell(this, '${item.id || item.timestamp}')">${formattedDate}</td>
                        <td class="category-cell editable-cell" data-field="category" data-type="select" onclick="event.stopPropagation(); editCell(this, '${item.id || item.timestamp}')">
                            <span>${item.category}</span>
                        </td>
                        <td class="content-cell editable-cell" data-field="content" data-type="text" onclick="editCell(this, '${item.id || item.timestamp}')">${item.content || '-'}</td>
                        <td class="editable-cell" data-field="payment" data-type="select" onclick="event.stopPropagation(); editCell(this, '${item.id || item.timestamp}')">
                            <span class="payment-badge ${paymentClass}">${item.payment}</span>
                        </td>
                        <td class="amount-cell ${amountClass} editable-cell" data-field="amount" data-type="number" onclick="editCell(this, '${item.id || item.timestamp}')">
                            ${item.amount.toLocaleString()}${currencySymbol}
                        </td>
                        <td style="text-align: center;">
                            <button onclick="deleteBudgetItem('${item.id || item.timestamp}')" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tableBody.innerHTML = tableHTML;

            // í•©ê³„ í‘œì‹œ (í˜„ì¬ í•„í„°ë§ëœ ë°ì´í„° ê¸°ì¤€)
            const totalKRW = filteredData.filter(i => i.currency === 'ì›í™”').reduce((s, i) => s + (Number(i.amount) || 0), 0);
            const totalJPY = filteredData.filter(i => i.currency === 'ì—”í™”').reduce((s, i) => s + (Number(i.amount) || 0), 0);
            const footer = document.getElementById('budgetTableFooter');
            if (footer) {
                footer.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align:right; font-weight:700; color:#374151; background:#f9fafb;">í•©ê³„</td>
                        <td style="text-align:right; font-weight:700; background:#f9fafb; white-space:nowrap; overflow:visible; min-width:max-content;">
                            <span style="color: #2563eb;">${totalKRW.toLocaleString()}ì›</span>${totalJPY ? ` / <span style="color: #dc2626;">Â¥${totalJPY.toLocaleString()}</span>` : ''}
                        </td>
                        <td style="background:#f9fafb;"></td>
                    </tr>
                `;
            }
        }
        
        // ë°ì´í„° ì—†ìŒ í‘œì‹œ
        function showNoData() {
            const stats = document.getElementById('statsContainer');
            if (stats) stats.innerHTML = '';
            document.getElementById('noDataMessage').style.display = 'block';
            const footer = document.getElementById('budgetTableFooter');
            if (footer) footer.innerHTML = '';
        }
        
        // ê²€ìƒ‰ ê¸°ëŠ¥
        function setupSearch() { /* ê²€ìƒ‰ ê¸°ëŠ¥ ì œê±° */ }
        
        // í•„í„° ê¸°ëŠ¥ (ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°)
        function setupFilters() {
            // ë¬¸ì„œ ì „ì²´ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€í•˜ì—¬ ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
            document.addEventListener('click', function(e) {
                const categoryHeader = document.getElementById('categoryHeader');
                const categoryDropdown = document.getElementById('categoryDropdown');
                
                // ì¹´í…Œê³ ë¦¬ í—¤ë”ë‚˜ ë“œë¡­ë‹¤ìš´ì„ í´ë¦­í•œ ê²½ìš°ê°€ ì•„ë‹ˆë©´ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
                if (categoryHeader && categoryDropdown && 
                    !categoryHeader.contains(e.target)) {
                    hideDropdown();
                }
            });
            
            // ì´ˆê¸° ì¹´í…Œê³ ë¦¬ í—¤ë” ì„¤ì •
            updateCategoryHeader();
        }
        
        // CSV ë‚´ë³´ë‚´ê¸°
        function exportToCSV() {
            if (budgetData.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const headers = ['ë‚ ì§œ', 'í•­ëª©', 'ë‚´ìš©', 'ê²°ì œë°©ë²•', 'í†µí™”', 'ê¸ˆì•¡'];
            const csvContent = [
                headers.join(','),
                ...budgetData.map(item => [
                    item.date,
                    item.category,
                    `"${item.content.replace(/"/g, '""')}"`,
                    item.payment,
                    item.currency,
                    item.amount
                ].join(','))
            ].join('\n');
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `í™‹ì¹´ì´ë„_ê°€ê³„ë¶€_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ê°€ê³„ë¶€ í•­ëª© ì¶”ê°€ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
        function showAddBudgetDialog() {
            const dialogHTML = `
                <div id="budgetDialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 20px; text-align: center;">ê°€ê³„ë¶€ í•­ëª© ì¶”ê°€</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ë‚ ì§œ</label>
                            <input type="date" id="dialogDate" value="${new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ì¹´í…Œê³ ë¦¬</label>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button type="button" onclick="selectDialogCategory('ì‹ë¹„')" id="dialog-ì‹ë¹„" style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">ì‹ë¹„</button>
                                <button type="button" onclick="selectDialogCategory('êµí†µë¹„')" id="dialog-êµí†µë¹„" style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">êµí†µë¹„</button>
                                <button type="button" onclick="selectDialogCategory('ìˆ™ë°•ë¹„')" id="dialog-ìˆ™ë°•ë¹„" style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">ìˆ™ë°•ë¹„</button>
                                <button type="button" onclick="selectDialogCategory('ì‡¼í•‘')" id="dialog-ì‡¼í•‘" style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">ì‡¼í•‘</button>
                                <button type="button" onclick="selectDialogCategory('ê¸°íƒ€')" id="dialog-ê¸°íƒ€" style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">ê¸°íƒ€</button>
                            </div>
                            <input type="hidden" id="dialogCategory">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ë‚´ìš©</label>
                            <input type="text" id="dialogContent" placeholder="ìƒì„¸ ë‚´ìš© ì…ë ¥" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ê²°ì œë°©ë²•</label>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" onclick="selectDialogPayment('ì¹´ë“œ')" id="dialog-ì¹´ë“œ" style="flex: 1; padding: 10px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">ì¹´ë“œ</button>
                                <button type="button" onclick="selectDialogPayment('í˜„ê¸ˆ')" id="dialog-í˜„ê¸ˆ" style="flex: 1; padding: 10px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">í˜„ê¸ˆ</button>
                            </div>
                            <input type="hidden" id="dialogPayment">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">í†µí™”</label>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" onclick="selectDialogCurrency('ì›í™”')" id="dialog-ì›í™”" style="flex: 1; padding: 10px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">ì›í™”</button>
                                <button type="button" onclick="selectDialogCurrency('ì—”í™”')" id="dialog-ì—”í™”" style="flex: 1; padding: 10px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">ì—”í™”</button>
                            </div>
                            <input type="hidden" id="dialogCurrency">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ê¸ˆì•¡</label>
                            <input type="number" id="dialogAmount" placeholder="ê¸ˆì•¡ ì…ë ¥" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveBudgetFromDialog()" style="flex: 1; background: #4f46e5; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer;">ì €ì¥</button>
                            <button onclick="closeBudgetDialog()" style="flex: 1; background: #6b7280; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer;">ì·¨ì†Œ</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
            
            // ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const contentInput = document.getElementById('dialogContent');
            const amountInput = document.getElementById('dialogAmount');
            
            // ë‚´ìš© ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸
            if (contentInput) {
                // ì—”í„° í‚¤ë¡œ ì…ë ¥ ì™„ë£Œ
                contentInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        checkAndSaveIfComplete();
                    }
                });
                
                // blur ì´ë²¤íŠ¸ë¡œ ì…ë ¥ ì™„ë£Œ ì²´í¬
                contentInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        checkAndSaveIfComplete();
                    }, 200);
                });
            }
            
            // ê¸ˆì•¡ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸
            if (amountInput) {
                // blur ì´ë²¤íŠ¸ë¡œ ì…ë ¥ ì™„ë£Œ ì²´í¬
                amountInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        checkAndSaveIfComplete();
                    }, 200);
                });
                
                // ì—”í„° í‚¤ë¡œ ì…ë ¥ ì™„ë£Œ
                amountInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        checkAndSaveIfComplete();
                    }
                });
            }
        }
        
        // ëª¨ë“  í•„ë“œê°€ ì…ë ¥ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  ìë™ ì €ì¥
        function checkAndSaveIfComplete() {
            const date = document.getElementById('dialogDate')?.value;
            const category = document.getElementById('dialogCategory')?.value;
            const content = document.getElementById('dialogContent')?.value?.trim();
            const payment = document.getElementById('dialogPayment')?.value;
            const currency = document.getElementById('dialogCurrency')?.value;
            const amount = document.getElementById('dialogAmount')?.value?.trim();
            
            // ëª¨ë“  í•„ë“œê°€ ì…ë ¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (date && category && content && payment && currency && amount && Number(amount) > 0) {
                saveBudgetFromDialog();
            }
        }
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ì„ íƒ í•¨ìˆ˜ë“¤
        function selectDialogCategory(category) {
            ['ì‹ë¹„', 'êµí†µë¹„', 'ìˆ™ë°•ë¹„', 'ì‡¼í•‘', 'ê¸°íƒ€'].forEach(cat => {
                const btn = document.getElementById(`dialog-${cat}`);
                if (btn) btn.style.background = '#f3f4f6';
            });
            document.getElementById(`dialog-${category}`).style.background = '#4f46e5';
            document.getElementById(`dialog-${category}`).style.color = 'white';
            document.getElementById('dialogCategory').value = category;
        }
        
        function selectDialogPayment(payment) {
            ['ì¹´ë“œ', 'í˜„ê¸ˆ'].forEach(method => {
                const btn = document.getElementById(`dialog-${method}`);
                if (btn) btn.style.background = '#f3f4f6';
            });
            document.getElementById(`dialog-${payment}`).style.background = '#4f46e5';
            document.getElementById(`dialog-${payment}`).style.color = 'white';
            document.getElementById('dialogPayment').value = payment;
        }
        
        function selectDialogCurrency(currency) {
            ['ì›í™”', 'ì—”í™”'].forEach(curr => {
                const btn = document.getElementById(`dialog-${curr}`);
                if (btn) btn.style.background = '#f3f4f6';
            });
            document.getElementById(`dialog-${currency}`).style.background = '#4f46e5';
            document.getElementById(`dialog-${currency}`).style.color = 'white';
            document.getElementById('dialogCurrency').value = currency;
        }
        
        // ë‹¤ì´ì–¼ë¡œê·¸ì—ì„œ Firebaseì— ì €ì¥
        async function saveBudgetFromDialog() {
            const date = document.getElementById('dialogDate').value;
            const category = document.getElementById('dialogCategory').value;
            const content = document.getElementById('dialogContent').value.trim();
            const payment = document.getElementById('dialogPayment').value;
            const currency = document.getElementById('dialogCurrency').value;
            const amount = document.getElementById('dialogAmount').value.trim();
            
            if (!date || !category || !content || !payment || !currency || !amount) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (isNaN(amount) || Number(amount) <= 0) {
                alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const budgetItem = {
                    id: 'budget_' + Date.now(),
                    date: date,
                    category: category,
                    content: content,
                    payment: payment,
                    currency: currency,
                    amount: Number(amount),
                    timestamp: Date.now()
                };
                
                await saveBudgetDataToFirebase(budgetItem);
                alert('ê°€ê³„ë¶€ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeBudgetDialog();
                
                // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                await loadBudgetDataFromFirebase();
            } catch (error) {
                alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
        function closeBudgetDialog() {
            const dialog = document.getElementById('budgetDialog');
            if (dialog) dialog.remove();
        }
        
        // ê°€ê³„ë¶€ í•­ëª© ì‚­ì œ
        async function deleteBudgetItem(itemId) {
            if (!confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                await deleteBudgetDataFromFirebase(itemId);
                alert('í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadBudgetDataFromFirebase();
            } catch (error) {
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
        
        // ì¸ë¼ì¸ í¸ì§‘ ê¸°ëŠ¥
        let currentEditingCell = null;
        
        function editCell(cell, itemId) {
            // ì´ë¯¸ í¸ì§‘ ì¤‘ì¸ ì…€ì´ ìˆìœ¼ë©´ ì·¨ì†Œ
            if (currentEditingCell && currentEditingCell !== cell) {
                cancelEditWithoutWarning();
            }
            
            // ê°™ì€ ì…€ì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´ í¸ì§‘ ì¢…ë£Œ
            if (currentEditingCell === cell) {
                cancelEditWithoutWarning();
                return;
            }
            
            const field = cell.dataset.field;
            const type = cell.dataset.type;
            const item = budgetData.find(item => (item.id || item.timestamp) === itemId);
            if (!item) return;
            
            currentEditingCell = cell;
            cell.classList.add('editing');
            
            const originalContent = cell.innerHTML;
            let currentValue = '';
            
            // í˜„ì¬ ê°’ ì¶”ì¶œ
            switch (field) {
                case 'date':
                    currentValue = item.date;
                    break;
                case 'category':
                    currentValue = item.category;
                    break;
                case 'content':
                    currentValue = item.content;
                    break;
                case 'payment':
                    currentValue = item.payment;
                    break;
                case 'amount':
                    currentValue = item.amount;
                    break;
            }
            
            // í¸ì§‘ ìš”ì†Œ ìƒì„±
            let editElement;
            if (type === 'select' && field === 'category') {
                editElement = createCategorySelect(currentValue);
            } else if (type === 'select' && field === 'payment') {
                editElement = createPaymentSelect(currentValue);
            } else if (type === 'date') {
                editElement = document.createElement('input');
                editElement.type = 'date';
                editElement.value = currentValue;
                editElement.className = 'inline-input';
            } else if (type === 'number') {
                editElement = document.createElement('input');
                editElement.type = 'number';
                editElement.value = currentValue;
                editElement.className = 'inline-input';
            } else {
                editElement = document.createElement('input');
                editElement.type = 'text';
                editElement.value = currentValue;
                editElement.className = 'inline-input';
            }
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            editElement.addEventListener('blur', function(e) {
                // blur ì´ë²¤íŠ¸ì—ì„œëŠ” ì·¨ì†Œë§Œ ìˆ˜í–‰ (ì €ì¥í•˜ì§€ ì•ŠìŒ)
                setTimeout(() => {
                    if (currentEditingCell === cell) {
                        cancelEditWithoutWarning();
                    }
                }, 100);
            });
            editElement.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    saveCurrentEdit();
                } else if (e.key === 'Escape') {
                    cancelEdit(originalContent);
                }
            });
            
            // ì…€ ë‚´ìš© êµì²´ ë° í¬ì»¤ìŠ¤
            cell.innerHTML = '';
            cell.appendChild(editElement);
            editElement.focus();
            if (editElement.select) editElement.select();
        }
        
        function createCategorySelect(currentValue) {
            const select = document.createElement('select');
            select.className = 'inline-select';
            
            const categories = ['ì‹ë¹„', 'êµí†µë¹„', 'ìˆ™ë°•ë¹„', 'ì‡¼í•‘', 'ê¸°íƒ€'];
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                if (category === currentValue) option.selected = true;
                select.appendChild(option);
            });
            
            return select;
        }
        
        function createPaymentSelect(currentValue) {
            const select = document.createElement('select');
            select.className = 'inline-select';
            
            const payments = ['ì¹´ë“œ', 'í˜„ê¸ˆ'];
            payments.forEach(payment => {
                const option = document.createElement('option');
                option.value = payment;
                option.textContent = payment;
                if (payment === currentValue) option.selected = true;
                select.appendChild(option);
            });
            
            return select;
        }
        
        async function saveCurrentEdit() {
            if (!currentEditingCell) return;
            
            const cell = currentEditingCell;
            const itemId = cell.closest('tr').dataset.itemId;
            const field = cell.dataset.field;
            const editElement = cell.querySelector('input, select');
            
            if (!editElement) {
                currentEditingCell = null;
                return;
            }
            
            const newValue = editElement.value.trim();
            const item = budgetData.find(item => (item.id || item.timestamp) === itemId);
            
            if (!item) {
                cancelEdit();
                return;
            }
            
            // ê°’ ê²€ì¦
            if (field === 'amount' && (isNaN(newValue) || Number(newValue) <= 0)) {
                alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                editElement.focus();
                return;
            }
            
            if (!newValue && field !== 'content') {
                alert('ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                editElement.focus();
                return;
            }
            
            try {
                // Firebase ì—…ë°ì´íŠ¸
                const updateData = {};
                if (field === 'amount') {
                    updateData[field] = Number(newValue);
                } else {
                    updateData[field] = newValue;
                }
                
                await updateBudgetDataInFirebase(itemId, updateData);
                
                // ì„±ê³µì‹œ UI ì—…ë°ì´íŠ¸
                currentEditingCell.classList.remove('editing');
                currentEditingCell = null;
                
                // í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§
                await loadBudgetDataFromFirebase();
                
            } catch (error) {
                alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                editElement.focus();
            }
        }
        
        function cancelEdit(originalContent = '') {
            if (!currentEditingCell) return;
            
            if (originalContent) {
                currentEditingCell.innerHTML = originalContent;
            }
            currentEditingCell.classList.remove('editing');
            currentEditingCell = null;
        }
        
        // ê²½ê³ ì°½ ì—†ì´ í¸ì§‘ ì·¨ì†Œ (ë‹¤ë¥¸ ê³³ í´ë¦­ì‹œ ì‚¬ìš©)
        function cancelEditWithoutWarning() {
            if (!currentEditingCell) return;
            
            // ì›ë˜ ë°ì´í„°ë¡œ ë³µì›
            const itemId = currentEditingCell.closest('tr').dataset.itemId;
            const field = currentEditingCell.dataset.field;
            const item = budgetData.find(item => (item.id || item.timestamp) === itemId);
            
            if (item) {
                // ì›ë˜ ê°’ìœ¼ë¡œ ì…€ ë‚´ìš© ë³µì›
                let originalValue = '';
                switch (field) {
                    case 'date':
                        const dateObj = new Date(item.date);
                        originalValue = `${dateObj.getMonth() + 1}/${dateObj.getDate().toString().padStart(2, '0')}`;
                        break;
                    case 'category':
                        originalValue = `<span>${item.category}</span>`;
                        break;
                    case 'content':
                        originalValue = item.content || '-';
                        break;
                    case 'payment':
                        const paymentClass = item.payment === 'ì¹´ë“œ' ? 'payment-card' : 'payment-cash';
                        originalValue = `<span class="payment-badge ${paymentClass}">${item.payment}</span>`;
                        break;
                    case 'amount':
                        const currencySymbol = item.currency === 'ì›í™”' ? 'ì›' : 'Â¥';
                        originalValue = `${item.amount.toLocaleString()}${currencySymbol}`;
                        break;
                }
                currentEditingCell.innerHTML = originalValue;
            }
            
            currentEditingCell.classList.remove('editing');
            currentEditingCell = null;
        }
        
        // í…Œì´ë¸” ì™¸ë¶€ í´ë¦­ì‹œ í¸ì§‘ ì·¨ì†Œ ë° ìƒˆ í¸ì§‘ ì‹œì‘
        document.addEventListener('click', function(e) {
            if (currentEditingCell) {
                // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì…€ ë˜ëŠ” ê·¸ ì•ˆì˜ ìš”ì†Œë¥¼ í´ë¦­í•œ ê²½ìš°ëŠ” ë¬´ì‹œ
                if (currentEditingCell.contains(e.target)) {
                    return;
                }
                
                // í¸ì§‘ ê°€ëŠ¥í•œ ì…€ì„ í´ë¦­í•œ ê²½ìš°
                const clickedEditableCell = e.target.closest('.editable-cell');
                if (clickedEditableCell && clickedEditableCell !== currentEditingCell) {
                    // í˜„ì¬ í¸ì§‘ ì·¨ì†Œí•˜ê³  ìƒˆ ì…€ í¸ì§‘ ì‹œì‘
                    cancelEditWithoutWarning();
                    // ìƒˆ ì…€ í¸ì§‘ì€ í•´ë‹¹ ì…€ì˜ onclick ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬ë¨
                    return;
                }
                
                // í¸ì§‘ ê°€ëŠ¥í•œ ì…€ì´ ì•„ë‹Œ ê³³ì„ í´ë¦­í•œ ê²½ìš° í¸ì§‘ ì·¨ì†Œ
                if (!clickedEditableCell) {
                    setTimeout(() => {
                        if (currentEditingCell) {
                            cancelEditWithoutWarning();
                        }
                    }, 50);
                }
            }
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            // Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ (ìš°ì„ ìˆœìœ„)
            loadBudgetDataFromFirebase();
            setupSearch();
            setupFilters();
        });
    </script>
</body>
</html>

