<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í∞ÄÍ≥ÑÎ∂Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f7f7fb;
            min-height: 100vh;
            padding: 20px;
            color: #111827;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 16px;
            backdrop-filter: none;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }
        
        .header {
            background: #ffffff;
            color: #111827;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .stats { display: none; }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-card .emoji {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .stat-card h3 {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .table-container {
            padding: 30px;
            overflow-x: auto;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-box { display: none; }
        
        .search-box:focus-within {
            border-color: #4f46e5;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.1);
        }
        
        .search-box input {
            border: none;
            outline: none;
            font-size: 14px;
            padding: 5px;
            width: 200px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .filter-btn:hover {
            border-color: #4f46e5;
            color: #4f46e5;
        }
        
        .filter-btn.active {
            background: #4f46e5;
            border-color: #4f46e5;
            color: white;
        }
        
        .budget-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: visible;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            table-layout: fixed;
        }
        
        .budget-table th {
            background: #f8fafc;
            padding: 18px 15px;
            text-align: center;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .budget-table td {
            padding: 16px 15px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }

        /* Îç∞Ïä§ÌÅ¨ÌÉë/Í∏∞Î≥∏ Ïª¨Îüº Í≥†Ï†ï ÎÑàÎπÑ (ÏöîÏ≤≠ ÎπÑÏú®) */
        .budget-table th:nth-child(1),
        .budget-table td:nth-child(1) { /* ÎÇ†Ïßú */
            width: 10%;
            text-align: center;
        }
        .budget-table th:nth-child(2),
        .budget-table td:nth-child(2) { /* Ìï≠Î™© */
            width: 12% !important;
            min-width: 80px;
            max-width: 80px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .budget-table th:nth-child(3),
        .budget-table td:nth-child(3) { /* ÎÇ¥Ïö© */
            width: 33%;
        }
        .budget-table th:nth-child(4),
        .budget-table td:nth-child(4) { /* Í≤∞Ï†úÎ∞©Î≤ï */
            width: 12%;
            text-align: center;
        }
        .budget-table th:nth-child(5) { /* Í∏àÏï° Ìó§Îçî */
            width: 16%;
            text-align: center;
        }
        .budget-table td:nth-child(5) { /* Í∏àÏï° Í∞í */
            width: 16%;
            text-align: right;
        }
        .budget-table th:nth-child(6),
        .budget-table td:nth-child(6) { /* ÏÇ≠Ï†ú */
            width: 10%;
            text-align: center;
            white-space: nowrap;
        }
        
        .budget-table tr:hover {
            background: rgba(79, 70, 229, 0.02);
        }
        
        
        
        .category-emoji { display: none; }
        
        .amount-cell {
            font-weight: 600;
            text-align: right;
        }
        
        .amount-krw {
            color: #2563eb; /* ÌååÎûÄÏÉâ */
        }
        
        .amount-jpy {
            color: #dc2626; /* Îπ®Í∞ÑÏÉâ Ïú†ÏßÄ */
        }
        
        .payment-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .payment-card {
            background: #dbeafe;
            color: #1d4ed8;
        }
        
        .payment-cash {
            background: #dcfce7;
            color: #166534;
        }
        
        .date-cell {
            color: #6b7280;
            font-weight: 500;
        }
        
        .content-cell {
            max-width: 200px;
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .editable-cell {
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s ease;
        }
        
        .editable-cell:hover {
            background-color: rgba(79, 70, 229, 0.05);
        }
        
        .editable-cell.editing {
            background-color: rgba(79, 70, 229, 0.1);
        }
        
        .inline-input {
            width: 100%;
            border: 2px solid #4f46e5;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
            outline: none;
            background: white;
        }
        
        .inline-select {
            width: 100%;
            border: 2px solid #4f46e5;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
            outline: none;
            background: white;
        }
        
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .no-data .emoji { display: none; }
        
        .export-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            font-size: 14px;
        }
        
        .export-btn:hover {
            transform: translateY(-1px);
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 15px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                padding: 15px;
                gap: 10px;
            }
            
            .table-container {
                padding: 10px;
                overflow-x: auto;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            

            
            .filter-buttons {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .filter-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .export-btn {
                padding: 10px 20px;
                font-size: 12px;
            }
            
            .search-box input {
                width: 100%;
            }
            
            .budget-table {
                font-size: 11px;
                min-width: 100%;
                table-layout: fixed;
                white-space: normal;
            }
            
            .budget-table th,
            .budget-table td {
                padding: 8px 4px;
                font-size: 11px;
            }
            
            /* 768px Ïù¥Ìïò Ïª¨Îüº Í≥†Ï†ï ÎÑàÎπÑ (ÏöîÏ≤≠ ÎπÑÏú®) */
            .budget-table th:nth-child(1),
            .budget-table td:nth-child(1) { /* ÎÇ†Ïßú */
                width: 10%;
                text-align: center;
            }

            .budget-table th:nth-child(2),
            .budget-table td:nth-child(2) { /* Ìï≠Î™© */
                width: 12% !important;
                min-width: 60px;
                max-width: 60px;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .budget-table th:nth-child(3),
            .budget-table td:nth-child(3) { /* ÎÇ¥Ïö© */
                width: 36%;
            }

            .budget-table th:nth-child(4),
            .budget-table td:nth-child(4) { /* Í≤∞Ï†úÎ∞©Î≤ï */
                width: 12%;
                text-align: center;
            }

            .budget-table th:nth-child(5) { /* Í∏àÏï° (Ìó§Îçî Í∞ÄÏö¥Îç∞) */
                width: 16%;
                text-align: center;
            }

            .budget-table td:nth-child(5) { /* Í∏àÏï° Í∞íÏùÄ Ïò§Î•∏Ï™Ω Ï†ïÎ†¨ */
                width: 16%;
                text-align: right;
            }

            .budget-table th:nth-child(6),
            .budget-table td:nth-child(6) { /* ÏÇ≠Ï†ú */
                width: 10%;
                text-align: center;
                white-space: nowrap;
            }

            .content-cell {
                max-width: none;
                word-break: break-all;
                white-space: normal;
                line-height: 1.2;
            }
            
            .date-cell {
                min-width: 60px;
                font-size: 10px;
            }
            
            .amount-cell {
                min-width: 70px;
                font-size: 11px;
                font-weight: 600;
            }
            
            .payment-badge {
                padding: 2px 6px;
                font-size: 10px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                margin: 0;
            }
            
            .header {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .stats {
                grid-template-columns: 1fr;
                padding: 10px;
            }
            
            .table-container {
                padding: 5px;
            }
            
            .budget-table {
                font-size: 10px;
                table-layout: fixed;
                white-space: normal;
            }
            
            .budget-table th,
            .budget-table td {
                padding: 6px 2px;
                font-size: 10px;
            }
            
            /* 480px Ïù¥Ìïò Ïª¨Îüº Í≥†Ï†ï ÎÑàÎπÑ (ÏöîÏ≤≠ ÎπÑÏú®) */
            .budget-table th:nth-child(1),
            .budget-table td:nth-child(1) { /* ÎÇ†Ïßú */
                width: 10%;
                text-align: center;
            }

            .budget-table th:nth-child(2),
            .budget-table td:nth-child(2) { /* Ìï≠Î™© */
                width: 12% !important;
                min-width: 50px;
                max-width: 50px;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .budget-table th:nth-child(3),
            .budget-table td:nth-child(3) { /* ÎÇ¥Ïö© */
                width: 23%;
            }

            .budget-table th:nth-child(4),
            .budget-table td:nth-child(4) { /* Í≤∞Ï†úÎ∞©Î≤ï */
                width: 12%;
                text-align: center;
            }

            .budget-table th:nth-child(5) { /* Í∏àÏï° (Ìó§Îçî Í∞ÄÏö¥Îç∞) */
                width: 23%;
                text-align: center;
            }

            .budget-table td:nth-child(5) { /* Í∏àÏï° Í∞íÏùÄ Ïò§Î•∏Ï™Ω Ï†ïÎ†¨ */
                width: 23%;
                text-align: right;
            }

            .budget-table th:nth-child(6),
            .budget-table td:nth-child(6) { /* ÏÇ≠Ï†ú */
                width: 10%;
                text-align: center;
                white-space: nowrap;
            }
            
            .content-cell {
                max-width: none;
                word-break: break-all;
                white-space: normal;
                line-height: 1.1;
            }
            
            .date-cell {
                font-size: 9px;
            }
            
            .amount-cell {
                font-size: 10px;
            }
            
            .payment-badge {
                padding: 1px 4px;
                font-size: 9px;
            }
            
            /* ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¨Í∏∞ Ï°∞Ï†ï */
            .budget-table button {
                padding: 2px 4px;
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Í∞ÄÍ≥ÑÎ∂Ä</h1>
            <p>Ïó¨Ìñâ ÏßÄÏ∂ú ÎÇ¥Ïó≠ÏùÑ ÌïúÎààÏóê ÌôïÏù∏ÌïòÏÑ∏Ïöî</p>
        </div>
        
        <div class="stats" id="statsContainer">
            <!-- ÌÜµÍ≥Ñ Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
        </div>
        
        <div class="table-container">
            <div class="controls">
                <div style="display: flex; gap: 10px; justify-content: space-between;">
                    <button class="export-btn" onclick="exportToCSV()" style="flex: 1; background: white; color: #333; border: 2px solid white; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);">CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
                    <button class="export-btn" onclick="showAddBudgetDialog()" style="flex: 1; background: white; color: #333; border: 2px solid white; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);">Ìï≠Î™© Ï∂îÍ∞Ä</button>
                </div>
            </div>
            
            <table class="budget-table" id="budgetTable">
                <thead>
                    <tr>
                        <th onclick="toggleDateSort()" style="cursor: pointer; user-select: none;" id="dateHeader">ÎÇ†Ïßú ‚Üì</th>
                        <th onclick="toggleCategoryDropdown(event)" style="cursor: pointer; user-select: none; position: relative;" id="categoryHeader">Ìï≠Î™©</th>
                        <th>ÎÇ¥Ïö©</th>
                        <th onclick="togglePaymentFilter()" style="cursor: pointer; user-select: none;" id="paymentHeader">Í≤∞Ï†úÎ∞©Î≤ï</th>
                        <th>Í∏àÏï°</th>
                        <th>ÏÇ≠Ï†ú</th>
                    </tr>
                </thead>
                <tbody id="budgetTableBody">
                    <!-- Îç∞Ïù¥ÌÑ∞Í∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                </tbody>
                <tfoot id="budgetTableFooter"></tfoot>
            </table>
            
            <div class="no-data" id="noDataMessage" style="display: none;">
                <div class="emoji">üìù</div>
                <h3>Í∞ÄÍ≥ÑÎ∂Ä ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§</h3>
                <p>ÌôãÏπ¥Ïù¥ÎèÑ Ïó¨ÌñâÏßÄÎèÑÏóêÏÑú Í∞ÄÍ≥ÑÎ∂ÄÎ•º ÏûëÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî!</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (v9 modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, arrayUnion, arrayRemove, getDoc, serverTimestamp, orderBy, query } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        
        // Firebase ÏÑ§Ï†ï (index47m.htmlÍ≥º ÎèôÏùº)
        const firebaseConfig = {
            apiKey: "AIzaSyBhndv9tfh_Uu8Nkm7AZxjRCNIgvnGEj_c",
            authDomain: "travelplan250826.firebaseapp.com",
            projectId: "travelplan250826",
            storageBucket: "travelplan250826.firebasestorage.app",
            messagingSenderId: "918345537744",
            appId: "1:918345537744:web:08d0daace8cb0ec021e6d5",
            measurementId: "G-18R59NTNBT"
        };
        
        // Firebase Ï¥àÍ∏∞Ìôî
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú ÏÑ§Ï†ï (Í∏∞Ï°¥ Î∞©ÏãùÍ≥º Ìò∏Ìôò)
        window.db = db;
        window.firestore = {
            doc: doc,
            updateDoc: updateDoc,
            getDoc: getDoc,
            arrayUnion: arrayUnion,
            arrayRemove: arrayRemove,
            serverTimestamp: serverTimestamp,
            query: query,
            orderBy: orderBy,
            getDocs: getDocs
        };
        
        console.log('Í∞ÄÍ≥ÑÎ∂Ä Firebase Ïó∞Í≤∞ ÏôÑÎ£å!');
    </script>
    
    <script>
        // Ïò§ÌîÑÎùºÏù∏ ÏßÄÏõê ÏãúÏä§ÌÖú (index.htmlÍ≥º ÎèôÏùº)
        const PENDING_OPERATIONS_KEY = 'pendingFirebaseOperations';
        const MAX_PENDING_OPERATIONS = 50;
        
        const OPERATION_TYPES = {
          BUDGET_ADD: 'budgetAdd',
          BUDGET_UPDATE: 'budgetUpdate',
          BUDGET_DELETE: 'budgetDelete'
        };
        
        // ÎåÄÍ∏∞ ÏûëÏóÖ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
        function getPendingOperations() {
          try {
            const pending = localStorage.getItem(PENDING_OPERATIONS_KEY);
            return pending ? JSON.parse(pending) : [];
          } catch (error) {
            console.error('ÎåÄÍ∏∞ ÏûëÏóÖ Î°úÎìú Ïã§Ìå®:', error);
            return [];
          }
        }
        
        function savePendingOperations(operations) {
          try {
            const limitedOps = operations.slice(-MAX_PENDING_OPERATIONS);
            localStorage.setItem(PENDING_OPERATIONS_KEY, JSON.stringify(limitedOps));
          } catch (error) {
            console.error('ÎåÄÍ∏∞ ÏûëÏóÖ Ï†ÄÏû• Ïã§Ìå®:', error);
          }
        }
        
        function addPendingOperation(operation) {
          const pending = getPendingOperations();
          const newOperation = {
            id: `${operation.type}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            timestamp: Date.now(),
            retryCount: 0,
            ...operation
          };
          
          pending.push(newOperation);
          savePendingOperations(pending);
          
          console.log('Ïò§ÌîÑÎùºÏù∏ ÏûëÏóÖ Ï∂îÍ∞ÄÎê®:', newOperation);
          return newOperation.id;
        }
        
        function removePendingOperation(operationId) {
          const pending = getPendingOperations();
          const filtered = pending.filter(op => op.id !== operationId);
          savePendingOperations(filtered);
          console.log('ÎåÄÍ∏∞ ÏûëÏóÖ Ï†úÍ±∞Îê®:', operationId);
        }
        
        // ÏûêÎèô Ïû¨ÏãúÎèÑ ÏãúÏä§ÌÖú
        async function processPendingOperations() {
          if (!navigator.onLine || !window.db || !window.firestore) {
            console.log('Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉú ÎòêÎäî Firebase ÎØ∏Ï¥àÍ∏∞ÌôîÎ°ú ÎåÄÍ∏∞ ÏûëÏóÖ Ï≤òÎ¶¨ Í±¥ÎÑàÎúÄ');
            return;
          }
          
          const pending = getPendingOperations();
          if (pending.length === 0) return;
          
          console.log(`ÎåÄÍ∏∞ Ï§ëÏù∏ Í∞ÄÍ≥ÑÎ∂Ä ÏûëÏóÖ ${pending.length}Í∞ú Ï≤òÎ¶¨ ÏãúÏûë`);
          
          for (const operation of pending) {
            try {
              await retryPendingOperation(operation);
              removePendingOperation(operation.id);
            } catch (error) {
              console.error('ÎåÄÍ∏∞ ÏûëÏóÖ Ïû¨ÏãúÎèÑ Ïã§Ìå®:', operation.id, error);
              operation.retryCount = (operation.retryCount || 0) + 1;
              
              if (operation.retryCount >= 3) {
                console.warn('ÏµúÎåÄ Ïû¨ÏãúÎèÑ ÌöüÏàò Ï¥àÍ≥ºÎ°ú ÏûëÏóÖ Ï†úÍ±∞:', operation.id);
                removePendingOperation(operation.id);
              } else {
                const pending = getPendingOperations();
                const index = pending.findIndex(op => op.id === operation.id);
                if (index !== -1) {
                  pending[index] = operation;
                  savePendingOperations(pending);
                }
              }
            }
          }
        }
        
        async function retryPendingOperation(operation) {
          const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
          
          switch (operation.type) {
            case OPERATION_TYPES.BUDGET_ADD:
              await window.firestore.updateDoc(userDocRef, {
                budgetItems: window.firestore.arrayUnion(operation.data),
                lastUpdated: window.firestore.serverTimestamp()
              });
              console.log('Í∞ÄÍ≥ÑÎ∂Ä Ï∂îÍ∞Ä ÎåÄÍ∏∞ ÏûëÏóÖ ÏôÑÎ£å:', operation.id);
              break;
              
            case OPERATION_TYPES.BUDGET_UPDATE:
              await window.firestore.updateDoc(userDocRef, {
                budgetItems: window.firestore.arrayRemove(operation.oldData)
              });
              await window.firestore.updateDoc(userDocRef, {
                budgetItems: window.firestore.arrayUnion(operation.newData),
                lastUpdated: window.firestore.serverTimestamp()
              });
              console.log('Í∞ÄÍ≥ÑÎ∂Ä ÏàòÏ†ï ÎåÄÍ∏∞ ÏûëÏóÖ ÏôÑÎ£å:', operation.id);
              break;
              
            case OPERATION_TYPES.BUDGET_DELETE:
              await window.firestore.updateDoc(userDocRef, {
                budgetItems: window.firestore.arrayRemove(operation.data),
                lastUpdated: window.firestore.serverTimestamp()
              });
              console.log('Í∞ÄÍ≥ÑÎ∂Ä ÏÇ≠Ï†ú ÎåÄÍ∏∞ ÏûëÏóÖ ÏôÑÎ£å:', operation.id);
              break;
              
            default:
              throw new Error(`Ïïå Ïàò ÏóÜÎäî ÏûëÏóÖ ÌÉÄÏûÖ: ${operation.type}`);
          }
        }
        
        // ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉú Í∞êÏßÄ
        window.addEventListener('online', function() {
          console.log('ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞Îê® - Í∞ÄÍ≥ÑÎ∂Ä ÎåÄÍ∏∞ ÏûëÏóÖ Ï≤òÎ¶¨ ÏãúÏûë');
          setTimeout(() => {
            processPendingOperations().catch(error => {
              console.error('Ïò®ÎùºÏù∏ Ï†ÑÌôò Ïãú ÎåÄÍ∏∞ ÏûëÏóÖ Ï≤òÎ¶¨ Ïã§Ìå®:', error);
            });
          }, 1000);
        });
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÎåÄÍ∏∞ ÏûëÏóÖ Ï≤òÎ¶¨
        if (navigator.onLine) {
          setTimeout(() => {
            processPendingOperations().catch(error => {
              console.error('Ï¥àÍ∏∞ ÎåÄÍ∏∞ ÏûëÏóÖ Ï≤òÎ¶¨ Ïã§Ìå®:', error);
            });
          }, 2000);
        }
    </script>
    
    <script>
        
        let budgetData = [];
        let filteredData = [];
        let dateSortOrder = 'desc'; // 'desc' = ÎÇ¥Î¶ºÏ∞®Ïàú(ÏµúÏã†Ïàú), 'asc' = Ïò§Î¶ÑÏ∞®Ïàú(Ïò§ÎûòÎêúÏàú)
        let currentCategoryFilter = 'all'; // ÌòÑÏû¨ Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞
        let currentPaymentFilter = 'all'; // 'all', 'card', 'cash'
        let categoryDropdownPortal = null; // Î∞îÎîî Ìè¨ÌÉà ÎìúÎ°≠Îã§Ïö¥ Ï∞∏Ï°∞
        
        // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Ïù¥Î™®ÏßÄ Îß§Ìïë
        const categoryEmojis = {
            'ÏãùÎπÑ': 'üçΩÔ∏è',
            'ÍµêÌÜµÎπÑ': 'üöå',
            'ÏàôÎ∞ïÎπÑ': 'üè®',
            'ÏáºÌïë': 'üõí',
            'Í∏∞ÌÉÄ': 'üí°'
        };
        
        // FirebaseÏóêÏÑú Í∞ÄÍ≥ÑÎ∂Ä Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Í∞úÏÑ†Îêú Î∞©Ïãù)
        async function loadBudgetDataFromFirebase() {
            try {
                if (!window.db || !window.firestore) {
                    console.warn('FirebaseÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                    loadBudgetDataFromURL();
                    return;
                }
                
                const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
                const docSnap = await window.firestore.getDoc(userDocRef);
                
                if (docSnap.exists() && docSnap.data().budgetItems) {
                    budgetData = docSnap.data().budgetItems || [];
                    
                    // Îç∞Ïù¥ÌÑ∞ ÏùºÍ¥ÄÏÑ± Í≤ÄÏÇ¨ Î∞è ÏàòÏ†ï
                    budgetData = budgetData.map(item => {
                        // IDÍ∞Ä ÏóÜÎäî Ìï≠Î™©Ïóê ID Ï∂îÍ∞Ä
                        if (!item.id && item.timestamp) {
                            item.id = item.timestamp.toString();
                        } else if (!item.id) {
                            item.id = Date.now().toString();
                        }
                        return item;
                    });
                    
                    // ÎÇ†Ïßú Í∏∞Ï§Ä ÏµúÏã†Ïàú Ï†ïÎ†¨ (ÎÇ†ÏßúÍ∞Ä Í∞ôÏúºÎ©¥ timestamp Í∏∞Ï§Ä)
                    budgetData.sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        if (dateA.getTime() !== dateB.getTime()) {
                            return dateB.getTime() - dateA.getTime(); // ÎÇ†Ïßú ÎÇ¥Î¶ºÏ∞®Ïàú
                        }
                        return (b.timestamp || 0) - (a.timestamp || 0); // Í∞ôÏùÄ ÎÇ†ÏßúÎ©¥ ÏûÖÎ†•ÏãúÍ∞Ñ ÎÇ¥Î¶ºÏ∞®Ïàú
                    });
                    
                    // ÏàòÏ†ïÎêú Îç∞Ïù¥ÌÑ∞Î•º FirebaseÏóê Îã§Ïãú Ï†ÄÏû• (ÏùºÍ¥ÄÏÑ± Ïú†ÏßÄ)
                    if (budgetData.length > 0) {
                        await window.firestore.updateDoc(userDocRef, {
                            budgetItems: budgetData,
                            lastUpdated: window.firestore.serverTimestamp()
                        });
                    }
                } else {
                    budgetData = [];
                }
                
                filteredData = [...budgetData];
                
                renderStats();
                renderTable();
                console.log('FirebaseÏóêÏÑú Í∞ÄÍ≥ÑÎ∂Ä Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', budgetData.length + 'Í∞ú Ìï≠Î™©');
            } catch (error) {
                console.error('Firebase Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                // Firebase Î°úÎìú Ïã§Ìå®Ïãú URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú Î°úÎìú ÏãúÎèÑ
                loadBudgetDataFromURL();
            }
        }
        
        // localStorage ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ìï®Ïàò Ï†úÍ±∞Îê® (Firebase ÏßÅÏ†ë Ï†ÄÏû•ÏúºÎ°ú Î≥ÄÍ≤Ω)
        
        // FirebaseÏóê Í∞ÄÍ≥ÑÎ∂Ä Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (Í∞úÏÑ†Îêú Î∞©Ïãù)
        async function saveBudgetDataToFirebase(budgetItem) {
            try {
                if (!window.db || !window.firestore) {
                    throw new Error('FirebaseÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }
                
                // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Ïóê Ï∂îÍ∞Ä
                budgetData.push(budgetItem);
                filteredData = [...budgetData];
                
                const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
                
                // Ï†ÑÏ≤¥ Î∞∞Ïó¥ÏùÑ Ìïú Î≤àÏóê ÏóÖÎç∞Ïù¥Ìä∏ (Îçî ÏïàÏ†ïÏ†Å)
                await window.firestore.updateDoc(userDocRef, {
                    budgetItems: budgetData,
                    lastUpdated: window.firestore.serverTimestamp()
                });
                
                console.log('FirebaseÏóê Í∞ÄÍ≥ÑÎ∂Ä Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å:', budgetItem.id);
                return budgetItem.id;
            } catch (error) {
                console.error('Firebase Ï†ÄÏû• Ïã§Ìå®:', error);
                throw error;
            }
        }
        
        // FirebaseÏóêÏÑú Í∞ÄÍ≥ÑÎ∂Ä Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú (Í∞úÏÑ†Îêú Î∞©Ïãù)
        async function deleteBudgetDataFromFirebase(itemId) {
            try {
                if (!window.db || !window.firestore) {
                    throw new Error('FirebaseÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }
                
                // ÏÇ≠Ï†úÌï† Ìï≠Î™© Ï∞æÍ∏∞ (id ÎòêÎäî timestampÎ°ú)
                const itemIndex = budgetData.findIndex(item => (item.id || item.timestamp) === itemId);
                if (itemIndex === -1) {
                    throw new Error('ÏÇ≠Ï†úÌï† Ìï≠Î™©ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
                
                // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ï†úÍ±∞
                budgetData.splice(itemIndex, 1);
                filteredData = [...budgetData];
                
                const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
                
                // Ï†ÑÏ≤¥ Î∞∞Ïó¥ÏùÑ Ìïú Î≤àÏóê ÏóÖÎç∞Ïù¥Ìä∏ (Îçî ÏïàÏ†ïÏ†Å)
                await window.firestore.updateDoc(userDocRef, {
                    budgetItems: budgetData,
                    lastUpdated: window.firestore.serverTimestamp()
                });
                
                console.log('FirebaseÏóêÏÑú Í∞ÄÍ≥ÑÎ∂Ä Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú ÏôÑÎ£å:', itemId);
            } catch (error) {
                console.error('Firebase ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                throw error;
            }
        }
        
        // FirebaseÏóêÏÑú Í∞ÄÍ≥ÑÎ∂Ä Îç∞Ïù¥ÌÑ∞ ÏàòÏ†ï (Í∞úÏÑ†Îêú Î∞©Ïãù)
        async function updateBudgetDataInFirebase(itemId, updatedData) {
            try {
                if (!window.db || !window.firestore) {
                    throw new Error('FirebaseÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }
                
                // Í∏∞Ï°¥ Ìï≠Î™© Ï∞æÍ∏∞ (id ÎòêÎäî timestampÎ°ú)
                const oldItemIndex = budgetData.findIndex(item => (item.id || item.timestamp) === itemId);
                if (oldItemIndex === -1) {
                    throw new Error('ÏàòÏ†ïÌï† Ìï≠Î™©ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
                
                // ÏÉà Ìï≠Î™© ÏÉùÏÑ± (Í∏∞Ï°¥ ID Ïú†ÏßÄ)
                const updatedItem = { 
                    ...budgetData[oldItemIndex], 
                    ...updatedData,
                    id: budgetData[oldItemIndex].id || budgetData[oldItemIndex].timestamp // ID Ïú†ÏßÄ
                };
                
                // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                budgetData[oldItemIndex] = updatedItem;
                filteredData = [...budgetData];
                
                const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
                
                // Ï†ÑÏ≤¥ Î∞∞Ïó¥ÏùÑ Ìïú Î≤àÏóê ÏóÖÎç∞Ïù¥Ìä∏ (Îçî ÏïàÏ†ïÏ†Å)
                await window.firestore.updateDoc(userDocRef, {
                    budgetItems: budgetData,
                    lastUpdated: window.firestore.serverTimestamp()
                });
                
                console.log('FirebaseÏóêÏÑú Í∞ÄÍ≥ÑÎ∂Ä Îç∞Ïù¥ÌÑ∞ ÏàòÏ†ï ÏôÑÎ£å:', itemId);
            } catch (error) {
                console.error('Firebase ÏàòÏ†ï Ïã§Ìå®:', error);
                throw error;
            }
        }
        
        // URLÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (Firebase Ïã§Ìå®Ïãú Î∞±ÏóÖÏö©)
        function loadBudgetDataFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            
            if (dataParam) {
                try {
                    budgetData = JSON.parse(decodeURIComponent(dataParam));
                    filteredData = [...budgetData];
                    
                    // ÎÇ†Ïßú Í∏∞Ï§Ä ÏµúÏã†Ïàú Ï†ïÎ†¨
                    const sortByDate = (a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        if (dateA.getTime() !== dateB.getTime()) {
                            return dateB.getTime() - dateA.getTime();
                        }
                        return (b.timestamp || 0) - (a.timestamp || 0);
                    };
                    budgetData.sort(sortByDate);
                    filteredData.sort(sortByDate);
                    
                    renderStats();
                    renderTable();
                    console.log('URLÏóêÏÑú Í∞ÄÍ≥ÑÎ∂Ä Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', budgetData.length + 'Í∞ú Ìï≠Î™©');
                } catch (error) {
                    console.error('URL Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò:', error);
                    showNoData();
                }
            } else {
                showNoData();
            }
        }
        
        // ÌÜµÍ≥Ñ Ïπ¥Îìú Î†åÎçîÎßÅ (ÎØ∏ÏÇ¨Ïö©: ÎØ∏ÎãàÎ©Ä UI)
        function renderStats() {
            const statsContainer = document.getElementById('statsContainer');
            if (statsContainer) statsContainer.innerHTML = '';
        }
        
        // ÎÇ†Ïßú Ï†ïÎ†¨ ÌÜ†Í∏Ä Ìï®Ïàò
        function toggleDateSort() {
            dateSortOrder = dateSortOrder === 'desc' ? 'asc' : 'desc';
            sortDataByDate();
            updateDateHeader();
            renderTable();
        }
        
        // ÎÇ†Ïßú Í∏∞Ï§ÄÏúºÎ°ú Îç∞Ïù¥ÌÑ∞ Ï†ïÎ†¨
        function sortDataByDate() {
            const sortFunction = (a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA.getTime() !== dateB.getTime()) {
                    if (dateSortOrder === 'desc') {
                        return dateB.getTime() - dateA.getTime(); // ÎÇ¥Î¶ºÏ∞®Ïàú
                    } else {
                        return dateA.getTime() - dateB.getTime(); // Ïò§Î¶ÑÏ∞®Ïàú
                    }
                }
                // Í∞ôÏùÄ ÎÇ†ÏßúÎ©¥ timestamp Í∏∞Ï§Ä
                if (dateSortOrder === 'desc') {
                    return (b.timestamp || 0) - (a.timestamp || 0);
                } else {
                    return (a.timestamp || 0) - (b.timestamp || 0);
                }
            };
            
            budgetData.sort(sortFunction);
            filteredData.sort(sortFunction);
        }
        
        // ÎÇ†Ïßú Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏
        function updateDateHeader() {
            const dateHeader = document.getElementById('dateHeader');
            if (dateHeader) {
                dateHeader.textContent = dateSortOrder === 'desc' ? 'ÎÇ†Ïßú ‚Üì' : 'ÎÇ†Ïßú ‚Üë';
            }
        }
        
        // Í≤∞Ï†úÎ∞©Î≤ï ÌïÑÌÑ∞ ÌÜ†Í∏Ä
        function togglePaymentFilter() {
            if (currentPaymentFilter === 'all') {
                currentPaymentFilter = 'cash';
            } else if (currentPaymentFilter === 'cash') {
                currentPaymentFilter = 'card';
            } else {
                currentPaymentFilter = 'all';
            }
            updatePaymentHeader();
            applyFilters();
        }
        
        // Í≤∞Ï†úÎ∞©Î≤ï Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏
        function updatePaymentHeader() {
            const paymentHeader = document.getElementById('paymentHeader');
            if (paymentHeader) {
                switch (currentPaymentFilter) {
                    case 'cash':
                        paymentHeader.textContent = 'Í≤∞Ï†úÎ∞©Î≤ï(ÌòÑÍ∏à)';
                        paymentHeader.style.color = '#166534';
                        break;
                    case 'card':
                        paymentHeader.textContent = 'Í≤∞Ï†úÎ∞©Î≤ï(Ïπ¥Îìú)';
                        paymentHeader.style.color = '#1d4ed8';
                        break;
                    default:
                        paymentHeader.textContent = 'Í≤∞Ï†úÎ∞©Î≤ï';
                        paymentHeader.style.color = '#374151';
                        break;
                }
            }
        }
        
        // Ïπ¥ÌÖåÍ≥†Î¶¨ ÎìúÎ°≠Îã§Ïö¥ ÌÜ†Í∏Ä (Î∞îÎîî Ìè¨ÌÉà)
        function toggleCategoryDropdown(event) {
            if (event) event.stopPropagation();
            
            const header = document.getElementById('categoryHeader');
            if (!header) return;
            
            // Ìè¨ÌÉà ÏöîÏÜå ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
            if (!categoryDropdownPortal) {
                categoryDropdownPortal = document.createElement('div');
                categoryDropdownPortal.id = 'categoryDropdown';
                categoryDropdownPortal.style.position = 'fixed';
                categoryDropdownPortal.style.background = 'white';
                categoryDropdownPortal.style.border = '1px solid #e5e7eb';
                categoryDropdownPortal.style.borderRadius = '6px';
                categoryDropdownPortal.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                categoryDropdownPortal.style.zIndex = '99999';
                categoryDropdownPortal.style.minWidth = '140px';
                categoryDropdownPortal.style.display = 'none';
                categoryDropdownPortal.innerHTML = `
                    <div onclick="event.stopPropagation(); selectCategory('all')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding:8px 12px; cursor:pointer; border-bottom:1px solid #f3f4f6; font-weight:600;">Ï†ÑÏ≤¥</div>
                    <div onclick="event.stopPropagation(); selectCategory('ÏãùÎπÑ')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding:8px 12px; cursor:pointer; border-bottom:1px solid #f3f4f6;">ÏãùÎπÑ</div>
                    <div onclick="event.stopPropagation(); selectCategory('ÍµêÌÜµÎπÑ')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding:8px 12px; cursor:pointer; border-bottom:1px solid #f3f4f6;">ÍµêÌÜµÎπÑ</div>
                    <div onclick="event.stopPropagation(); selectCategory('ÏàôÎ∞ïÎπÑ')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding:8px 12px; cursor:pointer; border-bottom:1px solid #f3f4f6;">ÏàôÎ∞ïÎπÑ</div>
                    <div onclick="event.stopPropagation(); selectCategory('ÏáºÌïë')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding:8px 12px; cursor:pointer; border-bottom:1px solid #f3f4f6;">ÏáºÌïë</div>
                    <div onclick="event.stopPropagation(); selectCategory('Í∏∞ÌÉÄ')" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" style="padding:8px 12px; cursor:pointer;">Í∏∞ÌÉÄ</div>`;
                document.body.appendChild(categoryDropdownPortal);
            }
            
            // ÏúÑÏπò Í≥ÑÏÇ∞ (Ìó§Îçî ÏïÑÎûò)
            const rect = header.getBoundingClientRect();
            categoryDropdownPortal.style.top = (rect.bottom + 6) + 'px';
            categoryDropdownPortal.style.left = rect.left + 'px';
            
            // ÌôîÎ©¥ Ïö∞Ï∏° ÎÑòÏñ¥Í∞ÄÎ©¥ Ï¢åÌëú Î≥¥Ï†ï
            const portalWidth = 160;
            const overflowX = rect.left + portalWidth - window.innerWidth;
            if (overflowX > 0) {
                categoryDropdownPortal.style.left = (rect.left - overflowX - 10) + 'px';
            }
            
            // ÌÜ†Í∏Ä ÌëúÏãú
            categoryDropdownPortal.style.display = (categoryDropdownPortal.style.display === 'none' || categoryDropdownPortal.style.display === '') ? 'block' : 'none';
        }
        
        // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù
        function selectCategory(category) {
            currentCategoryFilter = category;
            updateCategoryHeader();
            hideDropdown();
            applyFilters();
        }
        
        // Ïπ¥ÌÖåÍ≥†Î¶¨ Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏
        function updateCategoryHeader() {
            const categoryHeader = document.getElementById('categoryHeader');
            if (categoryHeader) {
                const headerText = currentCategoryFilter === 'all' ? 'Ìï≠Î™©' : `Ìï≠Î™©(${currentCategoryFilter})`;
                categoryHeader.textContent = headerText;
                
                // ÏÉâÏÉÅ Î≥ÄÍ≤Ω
                if (currentCategoryFilter === 'all') {
                    categoryHeader.style.color = '#374151';
                } else {
                    categoryHeader.style.color = '#4f46e5';
                }
            }
        }
        
        // ÎìúÎ°≠Îã§Ïö¥ Ïà®Í∏∞Í∏∞
        function hideDropdown() {
            if (categoryDropdownPortal) {
                categoryDropdownPortal.style.display = 'none';
            }
        }
        
        // Î™®Îì† ÌïÑÌÑ∞ Ï†ÅÏö©
        function applyFilters() {
            filteredData = budgetData.filter(item => {
                // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞
                const categoryMatch = currentCategoryFilter === 'all' || item.category === currentCategoryFilter;
                
                // Í≤∞Ï†úÎ∞©Î≤ï ÌïÑÌÑ∞
                let paymentMatch = true;
                if (currentPaymentFilter === 'cash') {
                    paymentMatch = item.payment === 'ÌòÑÍ∏à';
                } else if (currentPaymentFilter === 'card') {
                    paymentMatch = item.payment === 'Ïπ¥Îìú';
                }
                
                return categoryMatch && paymentMatch;
            });
            
            // ÌòÑÏû¨ Ï†ïÎ†¨ ÏàúÏÑú Ï†ÅÏö©
            sortDataByDate();
            renderTable();
        }
        
        // ÌÖåÏù¥Î∏î Î†åÎçîÎßÅ
        function renderTable() {
            const tableBody = document.getElementById('budgetTableBody');
            const noDataMessage = document.getElementById('noDataMessage');
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = '';
                noDataMessage.style.display = 'block';
                return;
            }
            
            noDataMessage.style.display = 'none';
            
            const tableHTML = filteredData.map(item => {
                const dateObj = new Date(item.date);
                const formattedDate = `${dateObj.getMonth() + 1}/${dateObj.getDate().toString().padStart(2, '0')}`;
                
                const currencySymbol = item.currency === 'ÏõêÌôî' ? 'Ïõê' : '¬•';
                const amountClass = item.currency === 'ÏõêÌôî' ? 'amount-krw' : 'amount-jpy';
                const paymentClass = item.payment === 'Ïπ¥Îìú' ? 'payment-card' : 'payment-cash';
                
                return `
                    <tr data-item-id="${item.id || item.timestamp}">
                        <td class="date-cell editable-cell" data-field="date" data-type="date" onclick="editCell(this, '${item.id || item.timestamp}')">${formattedDate}</td>
                        <td class="category-cell editable-cell" data-field="category" data-type="select" onclick="event.stopPropagation(); editCell(this, '${item.id || item.timestamp}')">
                            <span>${item.category}</span>
                        </td>
                        <td class="content-cell editable-cell" data-field="content" data-type="text" onclick="editCell(this, '${item.id || item.timestamp}')">${item.content || '-'}</td>
                        <td class="editable-cell" data-field="payment" data-type="select" onclick="event.stopPropagation(); editCell(this, '${item.id || item.timestamp}')">
                            <span class="payment-badge ${paymentClass}">${item.payment}</span>
                        </td>
                        <td class="amount-cell ${amountClass} editable-cell" data-field="amount" data-type="number" onclick="editCell(this, '${item.id || item.timestamp}')">
                            ${item.amount.toLocaleString()}${currencySymbol}
                        </td>
                        <td style="text-align: center;">
                            <button onclick="deleteBudgetItem('${item.id || item.timestamp}')" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">ÏÇ≠Ï†ú</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tableBody.innerHTML = tableHTML;

            // Ìï©Í≥Ñ ÌëúÏãú (ÌòÑÏû¨ ÌïÑÌÑ∞ÎßÅÎêú Îç∞Ïù¥ÌÑ∞ Í∏∞Ï§Ä)
            const totalKRW = filteredData.filter(i => i.currency === 'ÏõêÌôî').reduce((s, i) => s + (Number(i.amount) || 0), 0);
            const totalJPY = filteredData.filter(i => i.currency === 'ÏóîÌôî').reduce((s, i) => s + (Number(i.amount) || 0), 0);
            const footer = document.getElementById('budgetTableFooter');
            if (footer) {
                footer.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align:right; font-weight:700; color:#374151; background:#f9fafb;">Ìï©Í≥Ñ</td>
                        <td style="text-align:right; font-weight:700; background:#f9fafb; white-space:nowrap; overflow:visible; min-width:max-content;">
                            <span style="color: #2563eb;">${totalKRW.toLocaleString()}Ïõê</span>${totalJPY ? ` / <span style="color: #dc2626;">¬•${totalJPY.toLocaleString()}</span>` : ''}
                        </td>
                        <td style="background:#f9fafb;"></td>
                    </tr>
                `;
            }
        }
        
        // Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå ÌëúÏãú
        function showNoData() {
            const stats = document.getElementById('statsContainer');
            if (stats) stats.innerHTML = '';
            document.getElementById('noDataMessage').style.display = 'block';
            const footer = document.getElementById('budgetTableFooter');
            if (footer) footer.innerHTML = '';
        }
        
        // Í≤ÄÏÉâ Í∏∞Îä•
        function setupSearch() { /* Í≤ÄÏÉâ Í∏∞Îä• Ï†úÍ±∞ */ }
        
        // ÌïÑÌÑ∞ Í∏∞Îä• (ÎìúÎ°≠Îã§Ïö¥ Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú Îã´Í∏∞)
        function setupFilters() {
            // Î¨∏ÏÑú Ï†ÑÏ≤¥Ïóê ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞ÄÌïòÏó¨ ÎìúÎ°≠Îã§Ïö¥ Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú Îã´Í∏∞
            document.addEventListener('click', function(e) {
                const categoryHeader = document.getElementById('categoryHeader');
                const categoryDropdown = document.getElementById('categoryDropdown');
                
                // Ïπ¥ÌÖåÍ≥†Î¶¨ Ìó§ÎçîÎÇò ÎìúÎ°≠Îã§Ïö¥ÏùÑ ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞Í∞Ä ÏïÑÎãàÎ©¥ ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞
                if (categoryHeader && categoryDropdown && 
                    !categoryHeader.contains(e.target)) {
                    hideDropdown();
                }
            });
            
            // Ï¥àÍ∏∞ Ïπ¥ÌÖåÍ≥†Î¶¨ Ìó§Îçî ÏÑ§Ï†ï
            updateCategoryHeader();
        }
        
        // CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞
        function exportToCSV() {
            if (budgetData.length === 0) {
                alert('ÎÇ¥Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const headers = ['ÎÇ†Ïßú', 'Ìï≠Î™©', 'ÎÇ¥Ïö©', 'Í≤∞Ï†úÎ∞©Î≤ï', 'ÌÜµÌôî', 'Í∏àÏï°'];
            const csvContent = [
                headers.join(','),
                ...budgetData.map(item => [
                    item.date,
                    item.category,
                    `"${item.content.replace(/"/g, '""')}"`,
                    item.payment,
                    item.currency,
                    item.amount
                ].join(','))
            ].join('\n');
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ÌôãÏπ¥Ïù¥ÎèÑ_Í∞ÄÍ≥ÑÎ∂Ä_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Í∞ÄÍ≥ÑÎ∂Ä Ìï≠Î™© Ï∂îÍ∞Ä Îã§Ïù¥ÏñºÎ°úÍ∑∏ ÌëúÏãú
        function showAddBudgetDialog() {
            const dialogHTML = `
                <div id="budgetDialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 20px; text-align: center;">Í∞ÄÍ≥ÑÎ∂Ä Ìï≠Î™© Ï∂îÍ∞Ä</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ÎÇ†Ïßú</label>
                            <input type="date" id="dialogDate" value="${new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button type="button" onclick="selectDialogCategory('ÏãùÎπÑ')" id="dialog-ÏãùÎπÑ" style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">ÏãùÎπÑ</button>
                                <button type="button" onclick="selectDialogCategory('ÍµêÌÜµÎπÑ')" id="dialog-ÍµêÌÜµÎπÑ" style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">ÍµêÌÜµÎπÑ</button>
                                <button type="button" onclick="selectDialogCategory('ÏàôÎ∞ïÎπÑ')" id="dialog-ÏàôÎ∞ïÎπÑ" style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">ÏàôÎ∞ïÎπÑ</button>
                                <button type="button" onclick="selectDialogCategory('ÏáºÌïë')" id="dialog-ÏáºÌïë" style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">ÏáºÌïë</button>
                                <button type="button" onclick="selectDialogCategory('Í∏∞ÌÉÄ')" id="dialog-Í∏∞ÌÉÄ" style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">Í∏∞ÌÉÄ</button>
                            </div>
                            <input type="hidden" id="dialogCategory">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ÎÇ¥Ïö©</label>
                            <input type="text" id="dialogContent" placeholder="ÏÉÅÏÑ∏ ÎÇ¥Ïö© ÏûÖÎ†•" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Í≤∞Ï†úÎ∞©Î≤ï</label>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" onclick="selectDialogPayment('Ïπ¥Îìú')" id="dialog-Ïπ¥Îìú" style="flex: 1; padding: 10px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">Ïπ¥Îìú</button>
                                <button type="button" onclick="selectDialogPayment('ÌòÑÍ∏à')" id="dialog-ÌòÑÍ∏à" style="flex: 1; padding: 10px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">ÌòÑÍ∏à</button>
                            </div>
                            <input type="hidden" id="dialogPayment">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ÌÜµÌôî</label>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" onclick="selectDialogCurrency('ÏõêÌôî')" id="dialog-ÏõêÌôî" style="flex: 1; padding: 10px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">ÏõêÌôî</button>
                                <button type="button" onclick="selectDialogCurrency('ÏóîÌôî')" id="dialog-ÏóîÌôî" style="flex: 1; padding: 10px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">ÏóîÌôî</button>
                            </div>
                            <input type="hidden" id="dialogCurrency">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Í∏àÏï°</label>
                            <input type="number" id="dialogAmount" placeholder="Í∏àÏï° ÏûÖÎ†•" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveBudgetFromDialog()" style="flex: 1; background: #4f46e5; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer;">Ï†ÄÏû•</button>
                            <button onclick="closeBudgetDialog()" style="flex: 1; background: #6b7280; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer;">Ï∑®ÏÜå</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
            
            // ÏûÖÎ†• ÌïÑÎìú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
            const contentInput = document.getElementById('dialogContent');
            const amountInput = document.getElementById('dialogAmount');
            
            // ÎÇ¥Ïö© ÏûÖÎ†• ÌïÑÎìú Ïù¥Î≤§Ìä∏
            if (contentInput) {
                // ÏóîÌÑ∞ ÌÇ§Î°ú ÏûÖÎ†• ÏôÑÎ£å
                contentInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        checkAndSaveIfComplete();
                    }
                });
                
                // blur Ïù¥Î≤§Ìä∏Î°ú ÏûÖÎ†• ÏôÑÎ£å Ï≤¥ÌÅ¨
                contentInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        checkAndSaveIfComplete();
                    }, 200);
                });
            }
            
            // Í∏àÏï° ÏûÖÎ†• ÌïÑÎìú Ïù¥Î≤§Ìä∏
            if (amountInput) {
                // blur Ïù¥Î≤§Ìä∏Î°ú ÏûÖÎ†• ÏôÑÎ£å Ï≤¥ÌÅ¨
                amountInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        checkAndSaveIfComplete();
                    }, 200);
                });
                
                // ÏóîÌÑ∞ ÌÇ§Î°ú ÏûÖÎ†• ÏôÑÎ£å
                amountInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        checkAndSaveIfComplete();
                    }
                });
            }
        }
        
        // Î™®Îì† ÌïÑÎìúÍ∞Ä ÏûÖÎ†•ÎêòÏóàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥† ÏûêÎèô Ï†ÄÏû•
        function checkAndSaveIfComplete() {
            const date = document.getElementById('dialogDate')?.value;
            const category = document.getElementById('dialogCategory')?.value;
            const content = document.getElementById('dialogContent')?.value?.trim();
            const payment = document.getElementById('dialogPayment')?.value;
            const currency = document.getElementById('dialogCurrency')?.value;
            const amount = document.getElementById('dialogAmount')?.value?.trim();
            
            // Î™®Îì† ÌïÑÎìúÍ∞Ä ÏûÖÎ†•ÎêòÏóàÎäîÏßÄ ÌôïÏù∏
            if (date && category && content && payment && currency && amount && Number(amount) > 0) {
                saveBudgetFromDialog();
            }
        }
        
        // Îã§Ïù¥ÏñºÎ°úÍ∑∏ ÏÑ†ÌÉù Ìï®ÏàòÎì§
        function selectDialogCategory(category) {
            ['ÏãùÎπÑ', 'ÍµêÌÜµÎπÑ', 'ÏàôÎ∞ïÎπÑ', 'ÏáºÌïë', 'Í∏∞ÌÉÄ'].forEach(cat => {
                const btn = document.getElementById(`dialog-${cat}`);
                if (btn) btn.style.background = '#f3f4f6';
            });
            document.getElementById(`dialog-${category}`).style.background = '#4f46e5';
            document.getElementById(`dialog-${category}`).style.color = 'white';
            document.getElementById('dialogCategory').value = category;
        }
        
        function selectDialogPayment(payment) {
            ['Ïπ¥Îìú', 'ÌòÑÍ∏à'].forEach(method => {
                const btn = document.getElementById(`dialog-${method}`);
                if (btn) btn.style.background = '#f3f4f6';
            });
            document.getElementById(`dialog-${payment}`).style.background = '#4f46e5';
            document.getElementById(`dialog-${payment}`).style.color = 'white';
            document.getElementById('dialogPayment').value = payment;
        }
        
        function selectDialogCurrency(currency) {
            ['ÏõêÌôî', 'ÏóîÌôî'].forEach(curr => {
                const btn = document.getElementById(`dialog-${curr}`);
                if (btn) btn.style.background = '#f3f4f6';
            });
            document.getElementById(`dialog-${currency}`).style.background = '#4f46e5';
            document.getElementById(`dialog-${currency}`).style.color = 'white';
            document.getElementById('dialogCurrency').value = currency;
        }
        
        // Îã§Ïù¥ÏñºÎ°úÍ∑∏ÏóêÏÑú FirebaseÏóê Ï†ÄÏû•
        async function saveBudgetFromDialog() {
            const date = document.getElementById('dialogDate').value;
            const category = document.getElementById('dialogCategory').value;
            const content = document.getElementById('dialogContent').value.trim();
            const payment = document.getElementById('dialogPayment').value;
            const currency = document.getElementById('dialogCurrency').value;
            const amount = document.getElementById('dialogAmount').value.trim();
            
            if (!date || !category || !content || !payment || !currency || !amount) {
                alert('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (isNaN(amount) || Number(amount) <= 0) {
                alert('Ïò¨Î∞îÎ•∏ Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            try {
                const budgetItem = {
                    id: 'budget_' + Date.now(),
                    date: date,
                    category: category,
                    content: content,
                    payment: payment,
                    currency: currency,
                    amount: Number(amount),
                    timestamp: Date.now()
                };
                
                await saveBudgetDataToFirebase(budgetItem);
                alert('Í∞ÄÍ≥ÑÎ∂ÄÏóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!');
                closeBudgetDialog();
                
                // Îç∞Ïù¥ÌÑ∞ Îã§Ïãú Î°úÎìú
                await loadBudgetDataFromFirebase();
            } catch (error) {
                console.error('Í∞ÄÍ≥ÑÎ∂Ä Ï†ÄÏû• Ïã§Ìå®:', error);
                
                // Ïò§ÌîÑÎùºÏù∏ ÏßÄÏõê - Ïã§Ìå®Ìïú ÏûëÏóÖÏùÑ ÎåÄÍ∏∞ ÌÅêÏóê Ï∂îÍ∞Ä
                const operationId = addPendingOperation({
                  type: OPERATION_TYPES.BUDGET_ADD,
                  data: budgetItem
                });
                
                // Íµ¨Ï≤¥Ï†ÅÏù∏ Ïò§Î•ò Î©îÏãúÏßÄ
                let errorMessage = 'Í∞ÄÍ≥ÑÎ∂ÄÍ∞Ä ÏûÑÏãú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.';
                if (error.message.includes('Firebase') || error.code === 'unavailable') {
                  errorMessage = 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ Î¨∏Ï†úÎ°ú ÏûÑÏãú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§. Ïó∞Í≤∞ Ïãú ÏûêÎèôÏúºÎ°ú ÎèôÍ∏∞ÌôîÎê©ÎãàÎã§.';
                } else if (error.code === 'permission-denied') {
                  errorMessage = 'Í∂åÌïú Î¨∏Ï†úÎ°ú ÏûÑÏãú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§. Î°úÍ∑∏Ïù∏ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.';
                }
                
                console.log(`Í∞ÄÍ≥ÑÎ∂Ä Ïò§ÌîÑÎùºÏù∏ Ï†ÄÏû• ÏôÑÎ£å (ÏûëÏóÖ ID: ${operationId})`);
                alert(errorMessage);
                closeBudgetDialog();
                
                // ÏûÑÏãúÎ°ú Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Ïóê Ï∂îÍ∞Ä (UI Î∞òÏòÅ)
                budgetData.unshift(budgetItem);
                filteredData = [...budgetData];
                renderStats();
                renderTable();
            }
        }
        
        // Îã§Ïù¥ÏñºÎ°úÍ∑∏ Îã´Í∏∞
        function closeBudgetDialog() {
            const dialog = document.getElementById('budgetDialog');
            if (dialog) dialog.remove();
        }
        
        // Í∞ÄÍ≥ÑÎ∂Ä Ìï≠Î™© ÏÇ≠Ï†ú
        async function deleteBudgetItem(itemId) {
            if (!confirm('Ïù¥ Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            try {
                await deleteBudgetDataFromFirebase(itemId);
                alert('Ìï≠Î™©Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                await loadBudgetDataFromFirebase();
            } catch (error) {
                console.error('Í∞ÄÍ≥ÑÎ∂Ä ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                
                // Ïò§ÌîÑÎùºÏù∏ ÏßÄÏõê - Ïã§Ìå®Ìïú ÏûëÏóÖÏùÑ ÎåÄÍ∏∞ ÌÅêÏóê Ï∂îÍ∞Ä
                const itemToDelete = budgetData.find(item => (item.id || item.timestamp) === itemId);
                if (itemToDelete) {
                  const operationId = addPendingOperation({
                    type: OPERATION_TYPES.BUDGET_DELETE,
                    data: itemToDelete
                  });
                  
                  // ÏûÑÏãúÎ°ú Î°úÏª¨ÏóêÏÑú Ï†úÍ±∞ (UI Î∞òÏòÅ)
                  budgetData = budgetData.filter(item => (item.id || item.timestamp) !== itemId);
                  filteredData = [...budgetData];
                  renderStats();
                  renderTable();
                  
                  console.log(`Í∞ÄÍ≥ÑÎ∂Ä ÏÇ≠Ï†ú Ïò§ÌîÑÎùºÏù∏ Ï†ÄÏû• ÏôÑÎ£å (ÏûëÏóÖ ID: ${operationId})`);
                  alert('Ìï≠Î™©Ïù¥ ÏûÑÏãú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§. ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ Ïãú ÏûêÎèôÏúºÎ°ú ÎèôÍ∏∞ÌôîÎê©ÎãàÎã§.');
                } else {
                  alert('ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                }
            }
        }
        
        // Ïù∏ÎùºÏù∏ Ìé∏Ïßë Í∏∞Îä•
        let currentEditingCell = null;
        
        function editCell(cell, itemId) {
            // Ïù¥ÎØ∏ Ìé∏Ïßë Ï§ëÏù∏ ÏÖÄÏù¥ ÏûàÏúºÎ©¥ Ï∑®ÏÜå
            if (currentEditingCell && currentEditingCell !== cell) {
                cancelEditWithoutWarning();
            }
            
            // Í∞ôÏùÄ ÏÖÄÏùÑ Îã§Ïãú ÌÅ¥Î¶≠ÌïòÎ©¥ Ìé∏Ïßë Ï¢ÖÎ£å
            if (currentEditingCell === cell) {
                cancelEditWithoutWarning();
                return;
            }
            
            const field = cell.dataset.field;
            const type = cell.dataset.type;
            const item = budgetData.find(item => (item.id || item.timestamp) === itemId);
            if (!item) return;
            
            currentEditingCell = cell;
            cell.classList.add('editing');
            
            const originalContent = cell.innerHTML;
            let currentValue = '';
            
            // ÌòÑÏû¨ Í∞í Ï∂îÏ∂ú
            switch (field) {
                case 'date':
                    currentValue = item.date;
                    break;
                case 'category':
                    currentValue = item.category;
                    break;
                case 'content':
                    currentValue = item.content;
                    break;
                case 'payment':
                    currentValue = item.payment;
                    break;
                case 'amount':
                    currentValue = item.amount;
                    break;
            }
            
            // Ìé∏Ïßë ÏöîÏÜå ÏÉùÏÑ±
            let editElement;
            if (type === 'select' && field === 'category') {
                editElement = createCategorySelect(currentValue);
            } else if (type === 'select' && field === 'payment') {
                editElement = createPaymentSelect(currentValue);
            } else if (type === 'date') {
                editElement = document.createElement('input');
                editElement.type = 'date';
                editElement.value = currentValue;
                editElement.className = 'inline-input';
            } else if (type === 'number') {
                editElement = document.createElement('input');
                editElement.type = 'number';
                editElement.value = currentValue;
                editElement.className = 'inline-input';
            } else {
                editElement = document.createElement('input');
                editElement.type = 'text';
                editElement.value = currentValue;
                editElement.className = 'inline-input';
            }
            
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
            editElement.addEventListener('blur', function(e) {
                // ÎÇ†Ïßú ÌïÑÎìúÏùò Í≤ΩÏö∞ blur Ïù¥Î≤§Ìä∏ Î¨¥Ïãú (change Ïù¥Î≤§Ìä∏Î°ú Ï≤òÎ¶¨)
                if (type === 'date') {
                    return;
                }
                // blur Ïù¥Î≤§Ìä∏ÏóêÏÑúÎäî Ï∑®ÏÜåÎßå ÏàòÌñâ (Ï†ÄÏû•ÌïòÏßÄ ÏïäÏùå)
                setTimeout(() => {
                    if (currentEditingCell === cell) {
                        cancelEditWithoutWarning();
                    }
                }, 100);
            });
            
            // ÎÇ†Ïßú ÌïÑÎìúÏùò Í≤ΩÏö∞ change Ïù¥Î≤§Ìä∏Î°ú ÏûêÎèô Ï†ÄÏû•
            if (type === 'date') {
                editElement.addEventListener('change', function(e) {
                    saveCurrentEdit();
                });
            }
            
            editElement.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    saveCurrentEdit();
                } else if (e.key === 'Escape') {
                    cancelEdit(originalContent);
                }
            });
            
            // ÏÖÄ ÎÇ¥Ïö© ÍµêÏ≤¥ Î∞è Ìè¨Ïª§Ïä§
            cell.innerHTML = '';
            cell.appendChild(editElement);
            editElement.focus();
            if (editElement.select) editElement.select();
        }
        
        function createCategorySelect(currentValue) {
            const select = document.createElement('select');
            select.className = 'inline-select';
            
            const categories = ['ÏãùÎπÑ', 'ÍµêÌÜµÎπÑ', 'ÏàôÎ∞ïÎπÑ', 'ÏáºÌïë', 'Í∏∞ÌÉÄ'];
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                if (category === currentValue) option.selected = true;
                select.appendChild(option);
            });
            
            return select;
        }
        
        function createPaymentSelect(currentValue) {
            const select = document.createElement('select');
            select.className = 'inline-select';
            
            const payments = ['Ïπ¥Îìú', 'ÌòÑÍ∏à'];
            payments.forEach(payment => {
                const option = document.createElement('option');
                option.value = payment;
                option.textContent = payment;
                if (payment === currentValue) option.selected = true;
                select.appendChild(option);
            });
            
            return select;
        }
        
        async function saveCurrentEdit() {
            if (!currentEditingCell) return;
            
            const cell = currentEditingCell;
            const itemId = cell.closest('tr').dataset.itemId;
            const field = cell.dataset.field;
            const editElement = cell.querySelector('input, select');
            
            if (!editElement) {
                currentEditingCell = null;
                return;
            }
            
            const newValue = editElement.value.trim();
            const item = budgetData.find(item => (item.id || item.timestamp) === itemId);
            
            if (!item) {
                cancelEdit();
                return;
            }
            
            // Í∞í Í≤ÄÏ¶ù
            if (field === 'amount' && (isNaN(newValue) || Number(newValue) <= 0)) {
                alert('Ïò¨Î∞îÎ•∏ Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                editElement.focus();
                return;
            }
            
            if (!newValue && field !== 'content') {
                alert('Í∞íÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                editElement.focus();
                return;
            }
            
            try {
                // Firebase ÏóÖÎç∞Ïù¥Ìä∏
                const updateData = {};
                if (field === 'amount') {
                    updateData[field] = Number(newValue);
                } else {
                    updateData[field] = newValue;
                }
                
                await updateBudgetDataInFirebase(itemId, updateData);
                
                // ÏÑ±Í≥µÏãú UI ÏóÖÎç∞Ïù¥Ìä∏
                currentEditingCell.classList.remove('editing');
                currentEditingCell = null;
                
                // ÌÖåÏù¥Î∏î Îã§Ïãú Î†åÎçîÎßÅ (Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Îã§Ïãú Î°úÎìúÌïòÏßÄ ÏïäÍ≥† Î°úÏª¨ ÏóÖÎç∞Ïù¥Ìä∏)
                renderStats();
                renderTable();
                
            } catch (error) {
                console.error('Í∞ÄÍ≥ÑÎ∂Ä ÏàòÏ†ï Ïã§Ìå®:', error);
                
                // Ïò§ÌîÑÎùºÏù∏ ÏßÄÏõê - Ïã§Ìå®Ìïú ÏûëÏóÖÏùÑ ÎåÄÍ∏∞ ÌÅêÏóê Ï∂îÍ∞Ä
                const operationId = addPendingOperation({
                  type: OPERATION_TYPES.BUDGET_UPDATE,
                  oldData: item,
                  newData: { ...item, ...updateData }
                });
                
                // ÏûÑÏãúÎ°ú Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏàòÏ†ï (UI Î∞òÏòÅ)
                Object.assign(item, updateData);
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                currentEditingCell.classList.remove('editing');
                currentEditingCell = null;
                renderStats();
                renderTable();
                
                console.log(`Í∞ÄÍ≥ÑÎ∂Ä ÏàòÏ†ï Ïò§ÌîÑÎùºÏù∏ Ï†ÄÏû• ÏôÑÎ£å (ÏûëÏóÖ ID: ${operationId})`);
                alert('Ìï≠Î™©Ïù¥ ÏûÑÏãú ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§. ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ Ïãú ÏûêÎèôÏúºÎ°ú ÎèôÍ∏∞ÌôîÎê©ÎãàÎã§.');
            }
        }
        
        function cancelEdit(originalContent = '') {
            if (!currentEditingCell) return;
            
            if (originalContent) {
                currentEditingCell.innerHTML = originalContent;
            }
            currentEditingCell.classList.remove('editing');
            currentEditingCell = null;
        }
        
        // Í≤ΩÍ≥†Ï∞Ω ÏóÜÏù¥ Ìé∏Ïßë Ï∑®ÏÜå (Îã§Î•∏ Í≥≥ ÌÅ¥Î¶≠Ïãú ÏÇ¨Ïö©)
        function cancelEditWithoutWarning() {
            if (!currentEditingCell) return;
            
            // ÏõêÎûò Îç∞Ïù¥ÌÑ∞Î°ú Î≥µÏõê
            const itemId = currentEditingCell.closest('tr').dataset.itemId;
            const field = currentEditingCell.dataset.field;
            const item = budgetData.find(item => (item.id || item.timestamp) === itemId);
            
            if (item) {
                // ÏõêÎûò Í∞íÏúºÎ°ú ÏÖÄ ÎÇ¥Ïö© Î≥µÏõê
                let originalValue = '';
                switch (field) {
                    case 'date':
                        const dateObj = new Date(item.date);
                        originalValue = `${dateObj.getMonth() + 1}/${dateObj.getDate().toString().padStart(2, '0')}`;
                        break;
                    case 'category':
                        originalValue = `<span>${item.category}</span>`;
                        break;
                    case 'content':
                        originalValue = item.content || '-';
                        break;
                    case 'payment':
                        const paymentClass = item.payment === 'Ïπ¥Îìú' ? 'payment-card' : 'payment-cash';
                        originalValue = `<span class="payment-badge ${paymentClass}">${item.payment}</span>`;
                        break;
                    case 'amount':
                        const currencySymbol = item.currency === 'ÏõêÌôî' ? 'Ïõê' : '¬•';
                        originalValue = `${item.amount.toLocaleString()}${currencySymbol}`;
                        break;
                }
                currentEditingCell.innerHTML = originalValue;
            }
            
            currentEditingCell.classList.remove('editing');
            currentEditingCell = null;
        }
        
        // ÌÖåÏù¥Î∏î Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú Ìé∏Ïßë Ï∑®ÏÜå Î∞è ÏÉà Ìé∏Ïßë ÏãúÏûë
        document.addEventListener('click', function(e) {
            if (currentEditingCell) {
                // ÌòÑÏû¨ Ìé∏Ïßë Ï§ëÏù∏ ÏÖÄ ÎòêÎäî Í∑∏ ÏïàÏùò ÏöîÏÜåÎ•º ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞Îäî Î¨¥Ïãú
                if (currentEditingCell.contains(e.target)) {
                    return;
                }
                
                // Ìé∏Ïßë Í∞ÄÎä•Ìïú ÏÖÄÏùÑ ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞
                const clickedEditableCell = e.target.closest('.editable-cell');
                if (clickedEditableCell && clickedEditableCell !== currentEditingCell) {
                    // ÌòÑÏû¨ Ìé∏Ïßë Ï∑®ÏÜåÌïòÍ≥† ÏÉà ÏÖÄ Ìé∏Ïßë ÏãúÏûë
                    cancelEditWithoutWarning();
                    // ÏÉà ÏÖÄ Ìé∏ÏßëÏùÄ Ìï¥Îãπ ÏÖÄÏùò onclick Ïù¥Î≤§Ìä∏ÏóêÏÑú Ï≤òÎ¶¨Îê®
                    return;
                }
                
                // Ìé∏Ïßë Í∞ÄÎä•Ìïú ÏÖÄÏù¥ ÏïÑÎãå Í≥≥ÏùÑ ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞ Ìé∏Ïßë Ï∑®ÏÜå
                if (!clickedEditableCell) {
                    setTimeout(() => {
                        if (currentEditingCell) {
                            cancelEditWithoutWarning();
                        }
                    }, 50);
                }
            }
        });
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            // FirebaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Ïö∞ÏÑ†ÏàúÏúÑ)
            loadBudgetDataFromFirebase();
            setupSearch();
            setupFilters();
        });
    </script>
</body>
</html>

