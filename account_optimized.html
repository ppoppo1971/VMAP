<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가계부</title>
    
    <!-- CSS 파일들 -->
    <link rel="stylesheet" href="css/account.css">
    
    <!-- JavaScript 파일들 -->
    <script src="js/utils.js"></script>
    <script src="js/account.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>홋카이도 여행 가계부</h1>
            <p>여행 경비를 체계적으로 관리하세요</p>
        </div>
        
        <div class="table-container">
            <div class="controls">
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterData('all')">전체</button>
                    <button class="filter-btn" onclick="filterData('transportation')">교통</button>
                    <button class="filter-btn" onclick="filterData('accommodation')">숙박</button>
                    <button class="filter-btn" onclick="filterData('food')">식사</button>
                    <button class="filter-btn" onclick="filterData('shopping')">쇼핑</button>
                    <button class="filter-btn" onclick="filterData('activity')">활동</button>
                    <button class="filter-btn" onclick="filterData('other')">기타</button>
                </div>
                <button class="export-btn" onclick="exportToCSV()">CSV 내보내기</button>
            </div>
            
            <table class="budget-table" id="budgetTable">
                <thead>
                    <tr>
                        <th>날짜</th>
                        <th>항목</th>
                        <th>내용</th>
                        <th>결제방법</th>
                        <th>금액</th>
                        <th>삭제</th>
                    </tr>
                </thead>
                <tbody id="budgetTableBody">
                    <!-- 데이터가 여기에 동적으로 추가됩니다 -->
                </tbody>
            </table>
            
            <div id="noData" class="no-data" style="display: none;">
                <p>등록된 지출 내역이 없습니다.</p>
            </div>
        </div>
    </div>
    
    <!-- 추가/편집 폼 모달 -->
    <div id="expenseModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">지출 추가</h3>
                <button class="close-btn" onclick="closeExpenseModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="expenseForm">
                    <div class="form-group">
                        <label for="expenseDate">날짜</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseCategory">항목</label>
                        <select id="expenseCategory" required>
                            <option value="">선택하세요</option>
                            <option value="transportation">교통</option>
                            <option value="accommodation">숙박</option>
                            <option value="food">식사</option>
                            <option value="shopping">쇼핑</option>
                            <option value="activity">활동</option>
                            <option value="other">기타</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expenseDescription">내용</label>
                        <input type="text" id="expenseDescription" placeholder="지출 내용을 입력하세요" required>
                    </div>
                    <div class="form-group">
                        <label for="expensePayment">결제방법</label>
                        <select id="expensePayment" required>
                            <option value="">선택하세요</option>
                            <option value="card">카드</option>
                            <option value="cash">현금</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expenseAmount">금액</label>
                        <input type="number" id="expenseAmount" placeholder="금액을 입력하세요" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseCurrency">통화</label>
                        <select id="expenseCurrency" required>
                            <option value="KRW">원 (KRW)</option>
                            <option value="JPY">엔 (JPY)</option>
                        </select>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" class="save-btn">저장</button>
                        <button type="button" class="cancel-btn" onclick="closeExpenseModal()">취소</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 추가 버튼 -->
    <button id="addExpenseBtn" class="floating-btn" onclick="openExpenseModal()">+</button>
    
    <!-- 통계 모달 -->
    <div id="statsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>지출 통계</h3>
                <button class="close-btn" onclick="closeStatsModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="stats-grid" id="statsGrid">
                    <!-- 통계 데이터가 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 통계 버튼 -->
    <button id="statsBtn" class="floating-btn stats-btn" onclick="openStatsModal()">📊</button>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, connectFirestoreEmulator } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, connectAuthEmulator } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getStorage, connectStorageEmulator } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyDVwJrvIcbqAOX24g9JODhD7DGtTz7z2Pg",
            authDomain: "hokkaido-travel-plan.firebaseapp.com",
            projectId: "hokkaido-travel-plan",
            storageBucket: "hokkaido-travel-plan.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };
        
        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        
        // 개발 환경에서 에뮬레이터 연결
        if (window.location.hostname === 'localhost') {
            try {
                connectFirestoreEmulator(db, 'localhost', 8080);
                connectAuthEmulator(auth, 'http://localhost:9099');
                connectStorageEmulator(storage, 'localhost', 9199);
            } catch (error) {
                console.log('에뮬레이터 연결 실패:', error);
            }
        }
        
        // 전역으로 Firebase 객체 내보내기
        window.firebase = { app, db, auth, storage };
        
        // Firebase 준비 완료 이벤트 발생
        window.dispatchEvent(new CustomEvent('firebaseReady'));
    </script>
    
    <!-- 메인 스크립트 -->
    <script>
        // 페이지 로드 완료 후 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('가계부 페이지 로드 완료');
            
            // 가계부 초기화
            if (typeof initAccount === 'function') {
                initAccount();
            }
            
            // 데이터 로드
            if (typeof loadBudgetData === 'function') {
                loadBudgetData();
            }
        });
        
        // Firebase 준비 완료 대기
        window.addEventListener('firebaseReady', function() {
            console.log('Firebase 준비 완료');
            
            // Firebase 관련 초기화 작업
            if (typeof initFirebase === 'function') {
                initFirebase();
            }
        });
        
        // 에러 핸들링
        window.addEventListener('error', function(event) {
            console.error('전역 에러:', event.error);
            if (typeof handleError === 'function') {
                handleError(event.error, '전역 에러');
            }
        });
        
        // Promise rejection 핸들링
        window.addEventListener('unhandledrejection', function(event) {
            console.error('처리되지 않은 Promise rejection:', event.reason);
            if (typeof handleError === 'function') {
                handleError(event.reason, 'Promise rejection');
            }
        });
        
        // 페이지 언로드 시 정리
        window.addEventListener('beforeunload', function() {
            if (typeof cleanupOnUnload === 'function') {
                cleanupOnUnload();
            }
        });
    </script>
</body>
</html>
