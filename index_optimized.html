<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1d4ed8">
    <title>í™‹ì¹´ì´ë„ ì—¬í–‰</title>
    
    <!-- CSS íŒŒì¼ë“¤ -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/dialogs.css">
    
    <!-- JavaScript íŒŒì¼ë“¤ -->
    <script src="js/utils.js"></script>
    <script src="js/map.js"></script>
    <script src="js/menu.js"></script>
    <script src="js/markers.js"></script>
    <script src="js/routes.js"></script>
    <script src="js/schedule.js"></script>
    <script src="js/firebase.js"></script>
</head>
<body>
    <!-- ì§€ë„ ì»¨í…Œì´ë„ˆ -->
    <div id="map"></div>
    
    <!-- ì‚¬ì´ë“œ ë©”ë‰´ -->
    <div id="customMapMenu">
        <h2>í™‹ì¹´ì´ë„ ì—¬í–‰</h2>
        
        <!-- ë©”ë‰´ í† ê¸€ ë²„íŠ¼ -->
        <button id="menuToggleBtn" class="toggle-btn" onclick="toggleMenu()">â˜°</button>
        
        <!-- êµ¬ê¸€ë§µ ë©”ë‰´ -->
        <div class="menu-group">
            <label>êµ¬ê¸€ë§µ</label>
            <button class="toggle-btn" onclick="toggleGoogleMapMenu()">êµ¬ê¸€ë§µ ë©”ë‰´</button>
            <div id="googleMapMenu" class="submenu" style="display: none;">
                <button class="toggle-btn" onclick="toggleTraffic()">êµí†µì •ë³´</button>
                <button class="toggle-btn" onclick="toggleTransit()">ëŒ€ì¤‘êµí†µ</button>
                <button class="toggle-btn" onclick="toggleBicycling()">ìì „ê±°</button>
            </div>
        </div>
        
        <!-- ì§€ë„ íƒ€ì… ì„ íƒ -->
        <div class="menu-group">
            <label>ì§€ë„ íƒ€ì…</label>
            <button class="toggle-btn" onclick="toggleMapTypeMenu()">ì§€ë„ íƒ€ì…</button>
            <div id="mapTypeMenu" class="submenu" style="display: none;">
                <button class="map-type-btn" onclick="changeMapType('roadmap')">ì¼ë°˜</button>
                <button class="map-type-btn" onclick="changeMapType('satellite')">ìœ„ì„±</button>
                <button class="map-type-btn" onclick="changeMapType('hybrid')">í•˜ì´ë¸Œë¦¬ë“œ</button>
                <button class="map-type-btn" onclick="changeMapType('terrain')">ì§€í˜•</button>
            </div>
        </div>
        
        <!-- ê²½ë¡œ ìƒì„± -->
        <div class="menu-group">
            <label>ê²½ë¡œ</label>
            <button class="toggle-btn" onclick="toggleRouteMode()">ê²½ë¡œ ìƒì„±</button>
            <div id="routeMenu" class="submenu" style="display: none;">
                <button class="toggle-btn" onclick="startRouteMode()">ê²½ë¡œ ì‹œì‘</button>
                <button class="toggle-btn" onclick="endRouteMode()">ê²½ë¡œ ì¢…ë£Œ</button>
                <button class="toggle-btn" onclick="clearRoute()">ê²½ë¡œ ì§€ìš°ê¸°</button>
                <button class="toggle-btn" onclick="saveRoute()">ê²½ë¡œ ì €ì¥</button>
            </div>
        </div>
        
        <!-- ë§ˆì»¤ ìƒì„± -->
        <div class="menu-group">
            <label>ë§ˆì»¤</label>
            <button class="toggle-btn" onclick="toggleMarkerMode()">ë§ˆì»¤ ìƒì„±</button>
            <div id="markerMenu" class="submenu" style="display: none;">
                <button class="toggle-btn" onclick="startMarkerMode()">ë§ˆì»¤ ì‹œì‘</button>
                <button class="toggle-btn" onclick="endMarkerMode()">ë§ˆì»¤ ì¢…ë£Œ</button>
                <button class="toggle-btn" onclick="clearMarkers()">ë§ˆì»¤ ì§€ìš°ê¸°</button>
                <button class="toggle-btn" onclick="saveMarkers()">ë§ˆì»¤ ì €ì¥</button>
            </div>
        </div>
        
        <!-- ì¼ì • ê´€ë¦¬ -->
        <div class="menu-group">
            <label>ì¼ì •</label>
            <button class="toggle-btn" onclick="toggleScheduleMenu()">ì¼ì • ê´€ë¦¬</button>
            <div id="scheduleMenu" class="submenu" style="display: none;">
                <button class="toggle-btn" onclick="showSchedule()">ì¼ì • ë³´ê¸°</button>
                <button class="toggle-btn" onclick="addSchedule()">ì¼ì • ì¶”ê°€</button>
                <button class="toggle-btn" onclick="editSchedule()">ì¼ì • í¸ì§‘</button>
                <button class="toggle-btn" onclick="deleteSchedule()">ì¼ì • ì‚­ì œ</button>
            </div>
        </div>
        
        <!-- ì‚¬ì „ì¤€ë¹„ -->
        <div class="menu-group">
            <label>ì¤€ë¹„</label>
            <button class="toggle-btn" onclick="showPreparationInfo()">ì‚¬ì „ì¤€ë¹„</button>
        </div>
        
        <!-- ê°€ê³„ë¶€ -->
        <div class="menu-group">
            <label>ê°€ê³„ë¶€</label>
            <button id="budgetBtn" class="toggle-btn" onclick="openBudget()">ê°€ê³„ë¶€</button>
        </div>
    </div>
    
    <!-- ì§€ë„ íƒ€ì… ì„ íƒê¸° -->
    <div id="mapTypeSelector">
        <button class="map-type-btn active" onclick="changeMapType('roadmap')">ì¼ë°˜</button>
        <button class="map-type-btn" onclick="changeMapType('satellite')">ìœ„ì„±</button>
        <button class="map-type-btn" onclick="changeMapType('hybrid')">í•˜ì´ë¸Œë¦¬ë“œ</button>
        <button class="map-type-btn" onclick="changeMapType('terrain')">ì§€í˜•</button>
    </div>
    
    <!-- ë©”ë‰´ í† ê¸€ ë²„íŠ¼ë“¤ -->
    <button id="menuToggleBtn" class="toggle-btn" onclick="toggleMenu()">â˜°</button>
    <button id="rightMenuToggleBtn" class="toggle-btn" onclick="toggleRightMenu()">ğŸ—ºï¸</button>
    
    <!-- GPS ìœ„ì¹˜ ë²„íŠ¼ -->
    <button id="locationBtn" onclick="showCurrentLocation()">ğŸ“</button>
    
    <!-- ì‚¬ì „ì¤€ë¹„ ì •ë³´ì°½ -->
    <div id="preparationInfo" style="display: none;">
        <div class="info-header">
            <h3>í™‹ì¹´ì´ë„ ì—¬í–‰ ì‚¬ì „ì¤€ë¹„</h3>
            <button class="close-btn" onclick="hidePreparationInfo()">Ã—</button>
        </div>
        <div class="info-content">
            <div class="info-section">
                <h4>ğŸ“‹ í•„ìˆ˜ ì¤€ë¹„ë¬¼</h4>
                <ul>
                    <li>ì—¬ê¶Œ (ìœ íš¨ê¸°ê°„ 6ê°œì›” ì´ìƒ)</li>
                    <li>ë¹„ì (í•œêµ­ì¸ì€ 90ì¼ ë¬´ë¹„ì)</li>
                    <li>í•­ê³µê¶Œ</li>
                    <li>ìˆ™ë°• ì˜ˆì•½ í™•ì¸ì„œ</li>
                </ul>
            </div>
            <div class="info-section">
                <h4>ğŸ’° í™˜ì „ ë° ê²°ì œ</h4>
                <ul>
                    <li>ì¼ë³¸ ì—”í™” í™˜ì „</li>
                    <li>ì‹ ìš©ì¹´ë“œ (VISA, MasterCard)</li>
                    <li>í˜„ê¸ˆ (ì¼ë¶€ ì§€ì—­ì—ì„œ í•„ìš”)</li>
                </ul>
            </div>
            <div class="info-section">
                <h4>ğŸ“± í†µì‹  ë° ì¸í„°ë„·</h4>
                <ul>
                    <li>ë¡œë° ì„œë¹„ìŠ¤ ì‹ ì²­</li>
                    <li>í¬ì¼“ì™€ì´íŒŒì´ ëŒ€ì—¬</li>
                    <li>ì¼ë³¸ í˜„ì§€ SIMì¹´ë“œ</li>
                </ul>
            </div>
            <div class="info-section">
                <h4>ğŸš— êµí†µ</h4>
                <ul>
                    <li>JR íŒ¨ìŠ¤ (ì¼ë³¸ì² ë„íŒ¨ìŠ¤)</li>
                    <li>ì§€ì—­ë³„ êµí†µíŒ¨ìŠ¤</li>
                    <li>ë Œí„°ì¹´ ì˜ˆì•½ (í•„ìš”ì‹œ)</li>
                </ul>
            </div>
            <button class="ticket-btn" onclick="openBudget()">ê°€ê³„ë¶€ ì—´ê¸°</button>
        </div>
    </div>
    
    <!-- ê²½ë¡œ ì €ì¥ ë‹¤ì´ì–¼ë¡œê·¸ -->
    <div id="routeSaveDialog" style="display: none;">
        <div class="info-header">
            <h3>ê²½ë¡œ ì €ì¥</h3>
            <button class="close-btn" onclick="hideRouteSaveDialog()">Ã—</button>
        </div>
        <div class="info-content">
            <div class="form-group">
                <input type="text" id="routeName" placeholder="ê²½ë¡œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
                <textarea id="routeDescription" placeholder="ê²½ë¡œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>
            <div class="route-save-options">
                <button class="route-save-btn" onclick="saveRouteToFirebase()">ì €ì¥</button>
                <button class="route-save-btn" onclick="hideRouteSaveDialog()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    
    <!-- ë§ˆì»¤ ì €ì¥ ë‹¤ì´ì–¼ë¡œê·¸ -->
    <div id="markerSaveDialog" style="display: none;">
        <div class="info-header">
            <h3>ë§ˆì»¤ ì €ì¥</h3>
            <button class="close-btn" onclick="hideMarkerSaveDialog()">Ã—</button>
        </div>
        <div class="info-content">
            <div class="form-group">
                <input type="text" id="markerGroupName" placeholder="ë§ˆì»¤ ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
                <textarea id="markerDescription" placeholder="ë§ˆì»¤ ê·¸ë£¹ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>
            <div class="route-save-options">
                <button class="route-save-btn" onclick="saveMarkersToFirebase()">ì €ì¥</button>
                <button class="route-save-btn" onclick="hideMarkerSaveDialog()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, connectFirestoreEmulator } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, connectAuthEmulator } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getStorage, connectStorageEmulator } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyDVwJrvIcbqAOX24g9JODhD7DGtTz7z2Pg",
            authDomain: "hokkaido-travel-plan.firebaseapp.com",
            projectId: "hokkaido-travel-plan",
            storageBucket: "hokkaido-travel-plan.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };
        
        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        
        // ê°œë°œ í™˜ê²½ì—ì„œ ì—ë®¬ë ˆì´í„° ì—°ê²°
        if (window.location.hostname === 'localhost') {
            try {
                connectFirestoreEmulator(db, 'localhost', 8080);
                connectAuthEmulator(auth, 'http://localhost:9099');
                connectStorageEmulator(storage, 'localhost', 9199);
            } catch (error) {
                console.log('ì—ë®¬ë ˆì´í„° ì—°ê²° ì‹¤íŒ¨:', error);
            }
        }
        
        // ì „ì—­ìœ¼ë¡œ Firebase ê°ì²´ ë‚´ë³´ë‚´ê¸°
        window.firebase = { app, db, auth, storage };
        
        // Firebase ì¤€ë¹„ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œìƒ
        window.dispatchEvent(new CustomEvent('firebaseReady'));
    </script>
    
    <!-- êµ¬ê¸€ ë§µ API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDVwJrvIcbqAOX24g9JODhD7DGtTz7z2Pg&libraries=geometry,directions,places&callback=initMap" async defer></script>
    
    <!-- ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('í™‹ì¹´ì´ë„ ì—¬í–‰ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            
            // ëª¨ë°”ì¼ ìµœì í™” ì ìš©
            if (typeof optimizeForMobile === 'function') {
                optimizeForMobile();
            }
            
            // ë©”ë‰´ ì´ˆê¸°í™”
            if (typeof initMenu === 'function') {
                initMenu();
            }
            
            // ë§ˆì»¤ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            if (typeof initMarkers === 'function') {
                initMarkers();
            }
            
            // ê²½ë¡œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            if (typeof initRoutes === 'function') {
                initRoutes();
            }
            
            // ì¼ì • ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            if (typeof initSchedule === 'function') {
                initSchedule();
            }
        });
        
        // Firebase ì¤€ë¹„ ì™„ë£Œ ëŒ€ê¸°
        window.addEventListener('firebaseReady', function() {
            console.log('Firebase ì¤€ë¹„ ì™„ë£Œ');
            
            // Firebase ê´€ë ¨ ì´ˆê¸°í™” ì‘ì—…
            if (typeof initFirebase === 'function') {
                initFirebase();
            }
        });
        
        // ì—ëŸ¬ í•¸ë“¤ë§
        window.addEventListener('error', function(event) {
            console.error('ì „ì—­ ì—ëŸ¬:', event.error);
            if (typeof handleError === 'function') {
                handleError(event.error, 'ì „ì—­ ì—ëŸ¬');
            }
        });
        
        // Promise rejection í•¸ë“¤ë§
        window.addEventListener('unhandledrejection', function(event) {
            console.error('ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise rejection:', event.reason);
            if (typeof handleError === 'function') {
                handleError(event.reason, 'Promise rejection');
            }
        });
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            if (typeof cleanupOnUnload === 'function') {
                cleanupOnUnload();
            }
        });
    </script>
</body>
</html>
