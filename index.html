<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¸Œì´ì›”ë“œ ì—°ì†ì§€ì ë„01</title>
    
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css" type="text/css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 300px;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #3498db;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, 
        .form-group select,
        .form-group button {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #34495e;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #27ae60;
        }
        
        .btn-success:hover {
            background-color: #229954;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .status.success {
            background-color: #d5f4e6;
            color: #27ae60;
            border: 1px solid #27ae60;
        }
        
        .status.error {
            background-color: #faddd5;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .coordinates {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 2000;
            display: none;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 200px;
            max-width: 300px;
            font-size: 12px;
        }
        
        .popup:after {
            top: 100%;
            left: 48px;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
            border-color: rgba(255, 255, 255, 0);
            border-top-color: #ffffff;
            border-width: 10px;
            margin-left: -10px;
        }
        
        .popup h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .popup table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .popup td {
            padding: 2px 5px;
            border-bottom: 1px solid #eee;
            font-size: 11px;
        }
        
        .popup td:first-child {
            font-weight: bold;
            color: #34495e;
            width: 80px;
        }
        
        .input-error {
            color: #e74c3c;
            font-size: 11px;
            display: block;
            margin-top: 2px;
            min-height: 14px;
        }
        
        .form-group input.error {
            border-color: #e74c3c;
            box-shadow: 0 0 5px rgba(231, 76, 60, 0.3);
        }
        
        .form-group input.valid {
            border-color: #27ae60;
            box-shadow: 0 0 5px rgba(39, 174, 96, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="title">ë¸Œì´ì›”ë“œ ì—°ì†ì§€ì ë„</div>
            
            <div class="control-group">
                <h3>ğŸ—ºï¸ ì§€ë„ ì„¤ì •</h3>
                <div class="form-group">
                    <label for="centerLon">ì¤‘ì‹¬ ê²½ë„:</label>
                    <input type="number" id="centerLon" value="127.024612" step="0.000001" min="-180" max="180" onchange="validateInput('centerLon')">
                    <small id="centerLon-error" class="input-error"></small>
                </div>
                <div class="form-group">
                    <label for="centerLat">ì¤‘ì‹¬ ìœ„ë„:</label>
                    <input type="number" id="centerLat" value="37.532600" step="0.000001" min="-90" max="90" onchange="validateInput('centerLat')">
                    <small id="centerLat-error" class="input-error"></small>
                </div>
                <div class="form-group">
                    <label for="zoomLevel">í™•ëŒ€ ë ˆë²¨:</label>
                    <input type="number" id="zoomLevel" value="15" min="1" max="19" onchange="validateInput('zoomLevel')">
                    <small id="zoomLevel-error" class="input-error"></small>
                </div>
                <div class="form-group">
                    <button class="btn" onclick="moveToLocation()">ìœ„ì¹˜ë¡œ ì´ë™</button>
                </div>
            </div>
            
            <div class="control-group">
                <h3>ğŸ“ ë ˆì´ì–´ ì„¤ì •</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="baseMapToggle" checked onchange="toggleBaseMap()">
                        ë°°ê²½ì§€ë„ í‘œì‹œ
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="cadastralToggle" checked onchange="toggleCadastralLayer()">
                        ì—°ì†ì§€ì ë„ í‘œì‹œ
                    </label>
                </div>
                <div class="form-group">
                    <label for="opacity">íˆ¬ëª…ë„:</label>
                    <input type="range" id="opacity" min="0" max="1" step="0.1" value="0.8" onchange="changeCadastralOpacity(this.value)">
                </div>
            </div>
            
            <div class="control-group">
                <h3>ğŸ”§ WFS ì„¤ì •</h3>
                <div class="form-group">
                    <label for="maxFeatures">ìµœëŒ€ í”¼ì²˜ ìˆ˜:</label>
                    <input type="number" id="maxFeatures" value="1000" min="1" max="10000" onchange="validateInput('maxFeatures')">
                    <small id="maxFeatures-error" class="input-error"></small>
                </div>
                <div class="form-group">
                    <button class="btn btn-success" onclick="refreshCadastralLayer()">ë ˆì´ì–´ ìƒˆë¡œê³ ì¹¨</button>
                </div>
                <div class="form-group">
                    <button class="btn" onclick="testApiConnection()">API ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                </div>
            </div>
            
            <div class="control-group">
                <h3>ğŸ“Š ì •ë³´</h3>
                <div id="status" class="status info">
                    ì§€ë„ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘...
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div id="coordinates" class="coordinates">ì¢Œí‘œ: </div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
        </div>
    </div>

    <!-- Popup overlay -->
    <div id="popup" class="popup" style="display: none;"></div>

    <!-- OpenLayers JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let map;
        let baseLayer;
        let cadastralLayer;
        let overlay;
        
        // API ì„¤ì •
        const VWORLD_API_KEY = '46F4304E-84DC-3F56-92F1-6A98A0370A31';
        const WFS_URL = 'https://api.vworld.kr/ned/wfs/getCtnlgsSpceWFS';
        
        // ìƒíƒœ ê´€ë¦¬
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            updateStatus('ì§€ë„ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘...', 'info');
            
            // ë°°ê²½ì§€ë„ ë ˆì´ì–´ (ë¸Œì´ì›”ë“œ ë°°ê²½ì§€ë„)
            baseLayer = new ol.layer.Tile({
                title: 'ë¸Œì´ì›”ë“œ ê¸°ë³¸ì§€ë„',
                source: new ol.source.XYZ({
                    url: `https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_API_KEY}/Base/{z}/{y}/{x}.png`
                })
            });
            
            // ì—°ì†ì§€ì ë„ WFS ë ˆì´ì–´
            const vectorSource = new ol.source.Vector({
                format: new ol.format.GeoJSON(),
                url: function(extent) {
                    // íŒŒë¼ë¯¸í„° ê²€ì¦ ë° ìƒì„±
                    const params = createValidatedParams(extent);
                    
                    // íŒŒë¼ë¯¸í„° ê²€ì¦ ì‹¤íŒ¨ ì‹œ ë¹ˆ URL ë°˜í™˜ (ìš”ì²­í•˜ì§€ ì•ŠìŒ)
                    if (!params) {
                        return '';
                    }
                    
                    const paramString = Object.keys(params)
                        .map(key => `${key}=${encodeURIComponent(params[key])}`)
                        .join('&');
                    
                    const finalUrl = `${WFS_URL}?${paramString}`;
                    console.log('WFS ìš”ì²­ URL:', finalUrl);
                    
                    return finalUrl;
                },
                strategy: ol.loadingstrategy.bbox
            });
            
            // ë¡œë”© ìƒíƒœ ê´€ë¦¬
            vectorSource.on('loadstart', function() {
                showLoading();
                updateStatus('ì§€ì ë„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');
            });
            
            vectorSource.on('loadend', function() {
                hideLoading();
                const features = vectorSource.getFeatures();
                updateStatus(`ì§€ì ë„ ${features.length}ê°œ ë¡œë“œ ì™„ë£Œ`, 'success');
            });
            
            vectorSource.on('loaderror', function(event) {
                hideLoading();
                checkErrorType();
            });
            
            // ì˜¤ë¥˜ íƒ€ì… í™•ì¸ í•¨ìˆ˜
            function checkErrorType() {
                // í…ŒìŠ¤íŠ¸ ìš”ì²­ìœ¼ë¡œ ì˜¤ë¥˜ íƒ€ì… í™•ì¸
                const testParams = {
                    key: VWORLD_API_KEY,
                    domain: 'https://ppoppo1971.github.io/VMAP',
                    geomFilter: 'BBOX(SHAPE,126.9784,37.5665,126.9884,37.5765)',
                    maxFeatures: 1,
                    resultType: 'results',
                    srsName: 'EPSG:4326',
                    format: 'json'
                };
                
                const testUrl = WFS_URL + '?' + Object.keys(testParams)
                    .map(key => `${key}=${encodeURIComponent(testParams[key])}`)
                    .join('&');
                
                fetch(testUrl)
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(`HTTP ${response.status}: ${text}`);
                            });
                        }
                        return response.text();
                    })
                    .then(data => {
                        try {
                            const jsonData = JSON.parse(data);
                            if (jsonData.error || jsonData.message) {
                                analyzeErrorMessage(jsonData.error || jsonData.message || data);
                            } else {
                                updateStatus('ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                            }
                        } catch (e) {
                            // JSONì´ ì•„ë‹Œ ì‘ë‹µì¸ ê²½ìš° í…ìŠ¤íŠ¸ë¡œ ë¶„ì„
                            analyzeErrorMessage(data);
                        }
                    })
                    .catch(error => {
                        console.error('Error details:', error);
                        
                        // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” CORS ì˜¤ë¥˜ ë¶„ì„
                        if (error.message.includes('CORS') || error.message.includes('Cross-Origin')) {
                            updateStatus('ğŸš« ë„ë©”ì¸ ì˜¤ë¥˜: ë“±ë¡ë˜ì§€ ì•Šì€ ë„ë©”ì¸ì—ì„œ ì ‘ê·¼í–ˆìŠµë‹ˆë‹¤', 'error');
                        } else if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                            updateStatus('ğŸ”‘ í‚¤ ì˜¤ë¥˜: API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
                        } else if (error.message.includes('403') || error.message.includes('Forbidden')) {
                            updateStatus('ğŸš« ë„ë©”ì¸ ì˜¤ë¥˜: ë„ë©”ì¸ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                        } else if (error.message.includes('404')) {
                            updateStatus('ğŸ”— API ì—”ë“œí¬ì¸íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
                        } else {
                            updateStatus(`âŒ ì—°ê²° ì˜¤ë¥˜: ${error.message}`, 'error');
                        }
                    });
            }
            
                    // ì˜¤ë¥˜ ë©”ì‹œì§€ ë¶„ì„ í•¨ìˆ˜
        function analyzeErrorMessage(errorMessage) {
            const message = errorMessage.toLowerCase();
            
            // API í‚¤ ê´€ë ¨ ì˜¤ë¥˜
            if (message.includes('invalid api key') || 
                message.includes('api key') || 
                message.includes('unauthorized') ||
                message.includes('ì¸ì¦') ||
                message.includes('í‚¤')) {
                updateStatus('ğŸ”‘ í‚¤ ì˜¤ë¥˜: API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
            } 
            // ë„ë©”ì¸ ê´€ë ¨ ì˜¤ë¥˜
            else if (message.includes('domain') || 
                     message.includes('referer') || 
                     message.includes('origin') ||
                     message.includes('ë„ë©”ì¸') ||
                     message.includes('ì ‘ê·¼') ||
                     message.includes('í—ˆìš©ë˜ì§€ ì•Šì€')) {
                updateStatus('ğŸš« ë„ë©”ì¸ ì˜¤ë¥˜: ë“±ë¡ë˜ì§€ ì•Šì€ ë„ë©”ì¸ì—ì„œ ì ‘ê·¼í–ˆìŠµë‹ˆë‹¤', 'error');
            } 
            // CORS ì˜¤ë¥˜
            else if (message.includes('cors')) {
                updateStatus('ğŸš« ë„ë©”ì¸ ì˜¤ë¥˜: CORS ì •ì±…ìœ¼ë¡œ ì¸í•œ ë„ë©”ì¸ ì ‘ê·¼ ì œí•œ', 'error');
            }
            // íŒŒë¼ë¯¸í„° ê´€ë ¨ ì˜¤ë¥˜
            else if (message.includes('invalid parameter') || 
                     message.includes('missing parameter') ||
                     message.includes('parameter') ||
                     message.includes('íŒŒë¼ë¯¸í„°') ||
                     message.includes('ë§¤ê°œë³€ìˆ˜')) {
                updateStatus('âš™ï¸ íŒŒë¼ë¯¸í„° ì˜¤ë¥˜: ì˜ëª»ëœ íŒŒë¼ë¯¸í„°ê°€ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'error');
            }
            // ì¢Œí‘œ/ë²”ìœ„ ê´€ë ¨ ì˜¤ë¥˜
            else if (message.includes('bbox') || 
                     message.includes('coordinate') ||
                     message.includes('extent') ||
                     message.includes('ì¢Œí‘œ') ||
                     message.includes('ë²”ìœ„') ||
                     message.includes('ê²½ê³„')) {
                updateStatus('ğŸ“ ì¢Œí‘œ ì˜¤ë¥˜: ì¢Œí‘œ ë²”ìœ„ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
            }
            // ì„œë¹„ìŠ¤ ê´€ë ¨ ì˜¤ë¥˜
            else if (message.includes('service not found') ||
                     message.includes('invalid service') ||
                     message.includes('ì„œë¹„ìŠ¤') ||
                     message.includes('service')) {
                updateStatus('ğŸ”§ ì„œë¹„ìŠ¤ ì˜¤ë¥˜: ìš”ì²­í•œ ì„œë¹„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
            // ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜
            else if (message.includes('format') ||
                     message.includes('invalid format') ||
                     message.includes('í˜•ì‹') ||
                     message.includes('í¬ë§·')) {
                updateStatus('ğŸ“„ í˜•ì‹ ì˜¤ë¥˜: ìš”ì²­í•œ ë°ì´í„° í˜•ì‹ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
            }
            // í”¼ì²˜ ìˆ˜ ì œí•œ ì˜¤ë¥˜
            else if (message.includes('maxfeatures') ||
                     message.includes('limit exceeded') ||
                     message.includes('too many') ||
                     message.includes('ì œí•œ') ||
                     message.includes('ì´ˆê³¼')) {
                updateStatus('ğŸ“Š ë°ì´í„° ì œí•œ ì˜¤ë¥˜: ìš”ì²­í•œ ë°ì´í„°ê°€ í—ˆìš© í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤', 'error');
            }
            // ì¢Œí‘œê³„ ì˜¤ë¥˜
            else if (message.includes('srs') ||
                     message.includes('crs') ||
                     message.includes('projection') ||
                     message.includes('epsg') ||
                     message.includes('ì¢Œí‘œê³„')) {
                updateStatus('ğŸ—ºï¸ ì¢Œí‘œê³„ ì˜¤ë¥˜: ì§€ì›ë˜ì§€ ì•ŠëŠ” ì¢Œí‘œê³„ì…ë‹ˆë‹¤', 'error');
            }
            // ì¼ë°˜ì ì¸ ì˜¤ë¥˜
            else {
                updateStatus(`âŒ API ì˜¤ë¥˜: ${errorMessage}`, 'error');
            }
        }
        
        // íŒŒë¼ë¯¸í„° ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
        function validateParameters() {
            const errors = [];
            
            // API í‚¤ ê²€ì‚¬
            if (!VWORLD_API_KEY || VWORLD_API_KEY.trim() === '') {
                errors.push('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
            } else if (VWORLD_API_KEY.length !== 36) {
                errors.push('API í‚¤ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤ (36ìë¦¬ UUID í˜•íƒœì—¬ì•¼ í•¨)');
            }
            
            // ì¢Œí‘œ ê²€ì‚¬
            const centerLon = parseFloat(document.getElementById('centerLon').value);
            const centerLat = parseFloat(document.getElementById('centerLat').value);
            
            if (isNaN(centerLon) || centerLon < -180 || centerLon > 180) {
                errors.push('ê²½ë„ ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤ (-180 ~ 180 ë²”ìœ„)');
            }
            
            if (isNaN(centerLat) || centerLat < -90 || centerLat > 90) {
                errors.push('ìœ„ë„ ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤ (-90 ~ 90 ë²”ìœ„)');
            }
            
            // í”¼ì²˜ ìˆ˜ ê²€ì‚¬
            const maxFeatures = parseInt(document.getElementById('maxFeatures').value);
            if (isNaN(maxFeatures) || maxFeatures < 1 || maxFeatures > 10000) {
                errors.push('ìµœëŒ€ í”¼ì²˜ ìˆ˜ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤ (1 ~ 10,000 ë²”ìœ„)');
            }
            
            // ì¤Œ ë ˆë²¨ ê²€ì‚¬
            const zoomLevel = parseInt(document.getElementById('zoomLevel').value);
            if (isNaN(zoomLevel) || zoomLevel < 1 || zoomLevel > 19) {
                errors.push('í™•ëŒ€ ë ˆë²¨ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤ (1 ~ 19 ë²”ìœ„)');
            }
            
            return errors;
        }
        
        // API íŒŒë¼ë¯¸í„° ìƒì„± ë° ê²€ì¦ í•¨ìˆ˜
        function createValidatedParams(extent) {
            // íŒŒë¼ë¯¸í„° ìœ íš¨ì„± ê²€ì‚¬ ë¨¼ì € ì‹¤í–‰
            const validationErrors = validateParameters();
            if (validationErrors.length > 0) {
                updateStatus(`âš™ï¸ íŒŒë¼ë¯¸í„° ì˜¤ë¥˜: ${validationErrors[0]}`, 'error');
                return null;
            }
            
            const maxFeatures = document.getElementById('maxFeatures').value;
            const bbox = ol.proj.transformExtent(extent, 'EPSG:3857', 'EPSG:4326');
            
            // BBOX ìœ íš¨ì„± ê²€ì‚¬
            if (!bbox || bbox.length !== 4) {
                updateStatus('ğŸ“ ì¢Œí‘œ ì˜¤ë¥˜: ì§€ë„ ë²”ìœ„ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                return null;
            }
            
            const [minX, minY, maxX, maxY] = bbox;
            
            // ì¢Œí‘œ ë²”ìœ„ ê²€ì‚¬
            if (minX >= maxX || minY >= maxY) {
                updateStatus('ğŸ“ ì¢Œí‘œ ì˜¤ë¥˜: ì§€ë„ ë²”ìœ„ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
                return null;
            }
            
            // ë„ˆë¬´ í° ë²”ìœ„ ì²´í¬ (ì „ì„¸ê³„ ë²”ìœ„)
            if ((maxX - minX) > 180 || (maxY - minY) > 90) {
                updateStatus('ğŸ“ ì¢Œí‘œ ì˜¤ë¥˜: ìš”ì²­ ë²”ìœ„ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤', 'error');
                return null;
            }
            
            return {
                key: VWORLD_API_KEY,
                domain: 'https://ppoppo1971.github.io/VMAP/index.html',
                geomFilter: `BBOX(SHAPE,${bbox.join(',')})`,
                maxFeatures: maxFeatures,
                resultType: 'results',
                srsName: 'EPSG:4326',
                format: 'json'
            };
        }
            
            cadastralLayer = new ol.layer.Vector({
                title: 'ì—°ì†ì§€ì ë„',
                source: vectorSource,
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: '#ff6b6b',
                        width: 2
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 107, 107, 0.1)'
                    })
                }),
                opacity: 0.8
            });
            
            // íŒì—… ì˜¤ë²„ë ˆì´
            const popupElement = document.getElementById('popup');
            overlay = new ol.Overlay({
                element: popupElement,
                positioning: 'bottom-center',
                stopEvent: false,
                offset: [0, -50]
            });
            
            // ì§€ë„ ìƒì„±
            map = new ol.Map({
                target: 'map',
                layers: [baseLayer, cadastralLayer],
                overlays: [overlay],
                view: new ol.View({
                    center: ol.proj.fromLonLat([127.024612, 37.532600]),
                    zoom: 15,
                    maxZoom: 19
                })
            });
            
            // ë§ˆìš°ìŠ¤ ì¢Œí‘œ í‘œì‹œ
            map.on('pointermove', function(evt) {
                const coordinate = ol.proj.toLonLat(evt.coordinate);
                document.getElementById('coordinates').textContent = 
                    `ì¢Œí‘œ: ${coordinate[0].toFixed(6)}, ${coordinate[1].toFixed(6)}`;
            });
            
            // í´ë¦­ ì´ë²¤íŠ¸ - ì§€ì ë„ ì •ë³´ í‘œì‹œ
            map.on('singleclick', function(evt) {
                const features = map.getFeaturesAtPixel(evt.pixel, {
                    layerFilter: function(layer) {
                        return layer === cadastralLayer;
                    }
                });
                
                if (features.length > 0) {
                    const feature = features[0];
                    const properties = feature.getProperties();
                    
                    let popupContent = '<h4>ì§€ì ë„ ì •ë³´</h4><table>';
                    
                    // ì§€ì ë„ ì†ì„± ì •ë³´ í‘œì‹œ
                    const displayFields = {
                        'PNU': 'ê³ ìœ ë²ˆí˜¸',
                        'JIBUN': 'ì§€ë²ˆ',
                        'BCHK': 'ë²ˆì§€ì²´í¬',
                        'SGG_OID': 'ì‹œêµ°êµ¬ì½”ë“œ',
                        'COL_ADM_SE': 'ê´€ë¦¬êµ¬ë¶„'
                    };
                    
                    Object.keys(displayFields).forEach(key => {
                        if (properties[key] && key !== 'geometry') {
                            popupContent += `<tr><td>${displayFields[key]}:</td><td>${properties[key]}</td></tr>`;
                        }
                    });
                    
                    popupContent += '</table>';
                    
                    popupElement.innerHTML = popupContent;
                    popupElement.style.display = 'block';
                    overlay.setPosition(evt.coordinate);
                } else {
                    popupElement.style.display = 'none';
                }
            });
            
            updateStatus('ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ', 'success');
        }
        
        // ì‹¤ì‹œê°„ ì…ë ¥ ê²€ì¦ í•¨ìˆ˜
        function validateInput(fieldId) {
            const input = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + '-error');
            const value = parseFloat(input.value);
            
            // ì…ë ¥ í´ë˜ìŠ¤ ì´ˆê¸°í™”
            input.classList.remove('error', 'valid');
            
            let isValid = true;
            let errorMessage = '';
            
            switch(fieldId) {
                case 'centerLon':
                    if (isNaN(value) || value < -180 || value > 180) {
                        isValid = false;
                        errorMessage = 'ê²½ë„ëŠ” -180 ~ 180 ë²”ìœ„ì—¬ì•¼ í•©ë‹ˆë‹¤';
                    }
                    break;
                    
                case 'centerLat':
                    if (isNaN(value) || value < -90 || value > 90) {
                        isValid = false;
                        errorMessage = 'ìœ„ë„ëŠ” -90 ~ 90 ë²”ìœ„ì—¬ì•¼ í•©ë‹ˆë‹¤';
                    }
                    break;
                    
                case 'zoomLevel':
                    if (isNaN(value) || value < 1 || value > 19 || !Number.isInteger(value)) {
                        isValid = false;
                        errorMessage = 'í™•ëŒ€ ë ˆë²¨ì€ 1 ~ 19 ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤';
                    }
                    break;
                    
                case 'maxFeatures':
                    if (isNaN(value) || value < 1 || value > 10000 || !Number.isInteger(value)) {
                        isValid = false;
                        errorMessage = 'í”¼ì²˜ ìˆ˜ëŠ” 1 ~ 10,000 ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤';
                    }
                    break;
            }
            
            // ê²°ê³¼ ì ìš©
            if (isValid) {
                input.classList.add('valid');
                errorElement.textContent = '';
            } else {
                input.classList.add('error');
                errorElement.textContent = errorMessage;
            }
            
            return isValid;
        }
        
        // ëª¨ë“  ì…ë ¥ ê²€ì¦
        function validateAllInputs() {
            const fields = ['centerLon', 'centerLat', 'zoomLevel', 'maxFeatures'];
            let allValid = true;
            
            fields.forEach(fieldId => {
                if (!validateInput(fieldId)) {
                    allValid = false;
                }
            });
            
            return allValid;
        }
        
        // ìœ„ì¹˜ ì´ë™
        function moveToLocation() {
            // ì…ë ¥ê°’ ê²€ì¦
            if (!validateAllInputs()) {
                updateStatus('âš™ï¸ íŒŒë¼ë¯¸í„° ì˜¤ë¥˜: ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            const lon = parseFloat(document.getElementById('centerLon').value);
            const lat = parseFloat(document.getElementById('centerLat').value);
            const zoom = parseInt(document.getElementById('zoomLevel').value);
            
            map.getView().animate({
                center: ol.proj.fromLonLat([lon, lat]),
                zoom: zoom,
                duration: 1000
            });
            
            updateStatus(`ìœ„ì¹˜ ì´ë™: ${lat.toFixed(6)}, ${lon.toFixed(6)}`, 'success');
        }
        
        // ë°°ê²½ì§€ë„ í† ê¸€
        function toggleBaseMap() {
            const isVisible = document.getElementById('baseMapToggle').checked;
            baseLayer.setVisible(isVisible);
            updateStatus(`ë°°ê²½ì§€ë„ ${isVisible ? 'í‘œì‹œ' : 'ìˆ¨ê¹€'}`, 'info');
        }
        
        // ì§€ì ë„ ë ˆì´ì–´ í† ê¸€
        function toggleCadastralLayer() {
            const isVisible = document.getElementById('cadastralToggle').checked;
            cadastralLayer.setVisible(isVisible);
            updateStatus(`ì—°ì†ì§€ì ë„ ${isVisible ? 'í‘œì‹œ' : 'ìˆ¨ê¹€'}`, 'info');
        }
        
        // ì§€ì ë„ íˆ¬ëª…ë„ ë³€ê²½
        function changeCadastralOpacity(opacity) {
            cadastralLayer.setOpacity(parseFloat(opacity));
            updateStatus(`íˆ¬ëª…ë„ ë³€ê²½: ${Math.round(opacity * 100)}%`, 'info');
        }
        
        // ì§€ì ë„ ë ˆì´ì–´ ìƒˆë¡œê³ ì¹¨
        function refreshCadastralLayer() {
            updateStatus('ë ˆì´ì–´ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ëŠ” ì¤‘...', 'info');
            cadastralLayer.getSource().clear();
            cadastralLayer.getSource().refresh();
        }
        
        // API ì—°ê²° í…ŒìŠ¤íŠ¸
        function testApiConnection() {
            updateStatus('ğŸ” API ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•˜ëŠ” ì¤‘...', 'info');
            showLoading();
            
            const testParams = {
                key: VWORLD_API_KEY,
                domain: 'https://ppoppo1971.github.io/VMAP/index.html',
                geomFilter: 'BBOX(SHAPE,126.9784,37.5665,126.9884,37.5765)',
                maxFeatures: 1,
                resultType: 'results',
                srsName: 'EPSG:4326',
                format: 'json'
            };
            
            const testUrl = WFS_URL + '?' + Object.keys(testParams)
                .map(key => `${key}=${encodeURIComponent(testParams[key])}`)
                .join('&');
            
            console.log('í…ŒìŠ¤íŠ¸ URL:', testUrl);
            
            fetch(testUrl)
                .then(response => {
                    console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
                    console.log('ì‘ë‹µ í—¤ë”:', response.headers);
                    
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP ${response.status}: ${text}`);
                        });
                    }
                    return response.text();
                })
                .then(data => {
                    hideLoading();
                    console.log('ì‘ë‹µ ë°ì´í„°:', data);
                    
                    try {
                        const jsonData = JSON.parse(data);
                        if (jsonData.error || jsonData.message) {
                            analyzeErrorMessage(jsonData.error || jsonData.message || data);
                        } else if (jsonData.features) {
                            updateStatus(`âœ… API ì—°ê²° ì„±ê³µ! (${jsonData.features.length}ê°œ í”¼ì²˜ í™•ì¸)`, 'success');
                        } else {
                            updateStatus('âœ… API ì—°ê²° ì„±ê³µ! (ë°ì´í„° í˜•ì‹ í™•ì¸ í•„ìš”)', 'success');
                        }
                    } catch (e) {
                        // HTML ì‘ë‹µì¸ ê²½ìš° (ì¼ë°˜ì ìœ¼ë¡œ ì˜¤ë¥˜ í˜ì´ì§€)
                        if (data.includes('<html>') || data.includes('<!DOCTYPE')) {
                            updateStatus('ğŸš« ë„ë©”ì¸ ì˜¤ë¥˜: ì›¹í˜ì´ì§€ ì‘ë‹µ (HTML) - ë„ë©”ì¸ ë“±ë¡ í™•ì¸ í•„ìš”', 'error');
                        } else {
                            analyzeErrorMessage(data);
                        }
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('ì—°ê²° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
                    
                    if (error.message.includes('CORS') || error.message.includes('Cross-Origin')) {
                        updateStatus('ğŸš« ë„ë©”ì¸ ì˜¤ë¥˜: CORS ì •ì±…ìœ¼ë¡œ ì°¨ë‹¨ë¨', 'error');
                    } else if (error.message.includes('401')) {
                        updateStatus('ğŸ”‘ í‚¤ ì˜¤ë¥˜: API í‚¤ ì¸ì¦ ì‹¤íŒ¨', 'error');
                    } else if (error.message.includes('403')) {
                        updateStatus('ğŸš« ë„ë©”ì¸ ì˜¤ë¥˜: ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ', 'error');
                    } else if (error.message.includes('404')) {
                        updateStatus('ğŸ”— API ì—”ë“œí¬ì¸íŠ¸ ì˜¤ë¥˜: ì„œë¹„ìŠ¤ ì£¼ì†Œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŒ', 'error');
                    } else if (error.message.includes('Failed to fetch')) {
                        updateStatus('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ë¸Œì´ì›”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŒ', 'error');
                    } else {
                        updateStatus(`âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                    }
                });
        }
        
        // íŒì—… ë‹«ê¸° (ì§€ë„ í´ë¦­ ì‹œ)
        map.on('singleclick', function(evt) {
            const features = map.getFeaturesAtPixel(evt.pixel, {
                layerFilter: function(layer) {
                    return layer === cadastralLayer;
                }
            });
            
            if (features.length === 0) {
                document.getElementById('popup').style.display = 'none';
            }
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            // ì´ˆê¸° ì…ë ¥ê°’ ê²€ì¦
            validateAllInputs();
            initMap();
        });
    </script>
</body>
</html>

