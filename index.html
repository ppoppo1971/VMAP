<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>홋카이도 여행</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }
        #map {
            width: 100vw;
            height: 100vh;
            min-height: 100%;
            touch-action: manipulation;
        }
        h1 {
            display: none;
        }

        /* 사이드바 스타일 - 모바일 최적화 */
        #customMapMenu {
            position: absolute;
            top: 20px;
            left: 15px;
            z-index: 10;
            width: 200px;
            max-width: 85vw;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.05);
            padding: 15px 12px 12px 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: all 0.3s ease;
        }
        #customMapMenu.hide {
            left: -220px;
            opacity: 0;
            pointer-events: none;
        }
        #customMapMenu h2 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0 0 10px 0;
            color: #1a1a1a;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        .menu-group {
            margin-bottom: 4px;
        }
        .menu-group label {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 5px;
            display: block;
            color: #1a1a1a;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        /* 공통 버튼 스타일 - 터치 친화적 */
        .menu-group button, .toggle-btn {
            width: 100%;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 8px;
            margin-bottom: 4px;
            font-size: 0.9rem;
            color: #1a1a1a;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        .menu-group button:hover, .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.5);
            color: #000;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .menu-group button:active, .toggle-btn:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.98);
        }
        .menu-group .submenu {
            margin-left: 10px;
            margin-top: 3px;
        }
        
        /* 사이드 패널 토글 버튼 - 모바일 최적화 */
        #menuToggleBtn {
            position: absolute;
            top: 20px;
            left: 15px;
            z-index: 20;
            background: #1d4ed8;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }
        #menuToggleBtn.show {
            display: flex;
        }
        #menuToggleBtn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .toggle-btn {
            text-align: left;
            font-weight: 600;
        }
        
        /* 하위 옵션 들여쓰기 */
        .submenu {
            margin-left: 15px;
        }
        .submenu .submenu {
            margin-left: 15px;
        }
        .submenu button {
            width: 90%;
            margin-left: 0;
        }
        
        /* 구글맵 하위 옵션 들여쓰기 */
        #googleMapMenu > .toggle-btn {
            margin-left: 15px;
        }
        
        /* 오른쪽 상단 지도 타입 선택 버튼 - 모바일 최적화 */
        #mapTypeSelector {
            position: absolute;
            top: 20px;
            right: 15px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 6px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.05);
        }
        
        #mapTypeSelector.hide {
            right: -180px;
            opacity: 0;
            pointer-events: none;
        }
        

        
        /* GPS 위치 버튼 스타일 */
        #locationBtn {
            position: absolute;
            bottom: 70px;
            right: 10px;
            z-index: 10;
            background: transparent;
            color: #333;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }
        
        #locationBtn:hover {
            background: rgba(51, 51, 51, 0.1);
            transform: scale(1.05);
        }
        
        #locationBtn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        #locationBtn.loading {
            background: #6b7280;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* 오른쪽 상단 토글 버튼 - 모바일 최적화 */
        #rightMenuToggleBtn {
            position: absolute;
            top: 20px;
            right: 15px;
            z-index: 20;
            background: #1d4ed8;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }
        #rightMenuToggleBtn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .map-type-btn {
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #1a1a1a;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .map-type-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.35);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        
        .map-type-btn:active {
            transform: scale(0.98);
        }
        
        .map-type-btn.active {
            background: #1d4ed8;
            color: white;
            border-color: #1d4ed8;
        }
        
        .map-type-btn.sub-option {
            margin-left: 15px;
            font-size: 0.8rem;
            padding: 10px 12px;
        }
        
        /* 모바일 최적화를 위한 미디어 쿼리 */
        @media (max-width: 768px) {
            #customMapMenu {
                width: 180px;
                max-width: 80vw;
                top: 15px;
                left: 10px;
                padding: 12px 10px 10px 10px;
            }
            
            #customMapMenu.hide {
                left: -200px;
            }
            
            #menuToggleBtn, #rightMenuToggleBtn {
                width: 44px;
                height: 44px;
                font-size: 1.3rem;
                top: 15px;
            }
            
            #menuToggleBtn {
                left: 10px;
            }
            
            #rightMenuToggleBtn {
                right: 10px;
            }
            
            #mapTypeSelector {
                top: 15px;
                right: 10px;
            }
            
            .map-type-btn {
                padding: 10px 14px;
                font-size: 0.85rem;
                min-height: 40px;
            }
            
            .toggle-btn {
                padding: 10px 8px;
                min-height: 40px;
                font-size: 0.85rem;
            }
            
            #locationBtn {
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
                bottom: 85px;
                right: 15px;
            }
            
            #zoomLevelDisplay {
                bottom: 15px;
                left: 15px;
                padding: 6px 10px;
                font-size: 0.85rem;
                min-width: 55px;
            }
        }
        
        @media (max-width: 480px) {
            #customMapMenu {
                width: 160px;
                max-width: 75vw;
                top: 10px;
                left: 8px;
                padding: 10px 8px 8px 8px;
            }
            
            #customMapMenu.hide {
                left: -180px;
            }
            
            #menuToggleBtn, #rightMenuToggleBtn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
                top: 10px;
            }
            
            #menuToggleBtn {
                left: 8px;
            }
            
            #rightMenuToggleBtn {
                right: 8px;
            }
            
            #mapTypeSelector {
                top: 10px;
                right: 8px;
            }
            
            .map-type-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
                min-height: 36px;
            }
            
            .toggle-btn {
                padding: 8px 6px;
                min-height: 36px;
                font-size: 0.8rem;
            }
            
            #locationBtn {
                width: 37px;
                height: 37px;
                font-size: 1rem;
                bottom: 60px;
                right: 22px;
            }
            
            #zoomLevelDisplay {
                bottom: 10px;
                left: 12px;
                padding: 5px 8px;
                font-size: 0.8rem;
                min-width: 50px;
            }
        }
        
        /* 터치 최적화를 위한 추가 스타일 */
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* 스크롤바 숨기기 */
        ::-webkit-scrollbar {
            display: none;
        }
        
        /* 모바일에서 더블탭 줌 방지 및 한 손가락 드래그 최적화 */
        #map {
            touch-action: manipulation;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* 항공권 마커 색상 필터 - 짙은 파란색 */
        .gm-style img[src*="%ED%95%AD%EA%B3%B5%EA%B6%8C.png"] {
            filter: hue-rotate(150deg) saturate(150%) brightness(0.8) contrast(120%);
        }
        
        /* 줌 레벨 표시기 스타일 */
        #zoomLevelDisplay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            min-width: 60px;
            text-align: center;
        }
        
        #zoomLevelDisplay:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.05);
        }
        
        /* 사전준비 정보창 스타일 */
        #preparationInfo {
            position: absolute;
            z-index: 15;
            width: 400px;
            max-width: 90vw;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .info-header {
            background: linear-gradient(135deg, #1d4ed8, #3b82f6);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .info-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .info-content {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .info-section {
            margin-bottom: 24px;
        }
        
        .info-section:last-child {
            margin-bottom: 0;
        }
        
        .info-section h4 {
            margin: 0 0 12px 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-section p {
            margin: 8px 0;
            font-size: 0.95rem;
            color: #374151;
            line-height: 1.5;
        }
        
        .info-section ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .info-section li {
            margin: 6px 0;
            font-size: 0.95rem;
            color: #374151;
            line-height: 1.5;
        }
        
        .ticket-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
            width: 100%;
        }
        
        .ticket-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .ticket-btn:active {
            transform: translateY(0);
        }
        
        /* 모바일 최적화 */
        @media (max-width: 768px) {
            #preparationInfo {
                width: 350px;
                left: 50% !important;
                transform: translateX(-50%) !important;
                top: 80px !important;
                max-width: 90vw;
                margin: 0 auto;
            }
            
            #routeSaveDialog {
                width: 350px;
                left: 50% !important;
                transform: translateX(-50%) !important;
                top: 80px !important;
                max-width: 90vw;
                margin: 0 auto;
            }
        }
        
        @media (max-width: 480px) {
            #preparationInfo {
                width: 320px;
                top: 70px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                max-width: 95vw;
            }
            
            #routeSaveDialog {
                width: 320px;
                top: 70px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                max-width: 95vw;
            }
            
            .info-content {
                padding: 16px;
            }
            
            .info-header {
                padding: 14px 16px;
            }
        }
        
        /* 체크리스트 스타일 */
        .checklist-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            padding: 8px 0;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        
        .checklist-item:hover {
            background-color: rgba(29, 78, 216, 0.05);
        }
        
        .prep-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            accent-color: #1d4ed8;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .prep-checkbox:checked {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }
        
        .checklist-item label {
            cursor: default;
            user-select: none;
            flex: 1;
            line-height: 1.4;
        }
        
        .checklist-item:last-child {
            margin-bottom: 0;
        }
        
        /* 사용자 추가 항목 폼 스타일 */
        .add-item-form {
            margin-top: 20px;
            padding: 16px;
            background: rgba(29, 78, 216, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(29, 78, 216, 0.1);
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .form-group input {
            padding: 10px 12px;
            border: 1px solid rgba(29, 78, 216, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
            background: white;
            transition: border-color 0.2s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #1d4ed8;
            box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.1);
        }
        
        .form-buttons {
            display: flex;
            gap: 8px;
        }
        
                 .add-btn {
             width: 100%;
             padding: 10px 16px;
             border: none;
             border-radius: 8px;
             font-size: 0.9rem;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.2s ease;
             background: linear-gradient(135deg, #10b981, #059669);
             color: white;
         }
         
         .add-btn:hover {
             transform: translateY(-1px);
             box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
         }
         
         .add-btn:active {
             transform: translateY(0);
         }
        
        /* 사용자 추가 항목 스타일 */
        .user-added-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            padding: 8px 0;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
        }
        
        .user-added-item:hover {
            background-color: rgba(29, 78, 216, 0.05);
        }
        
        .user-added-item .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .user-added-item .delete-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        /* 스와이프 삭제 기능을 위한 스타일 */
        .user-added-item .swipe-delete-btn {
            position: absolute;
            right: -80px;
            top: 50%;
            transform: translateY(-50%);
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            z-index: 10;
        }
        
        .user-added-item .swipe-delete-btn:hover {
            background: #dc2626;
        }
        
        .user-added-item .item-content {
            display: flex;
            align-items: center;
            width: 100%;
            transition: transform 0.3s ease;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(29, 78, 216, 0.1);
        }
        
        .user-added-item.swiped .item-content {
            transform: translateX(-80px);
        }
        
        .user-added-item.swiped .swipe-delete-btn {
            right: 8px;
        }
        
        /* 스와이프 애니메이션 */
        .user-added-item.swiping .item-content {
            transition: transform 0.1s ease;
        }
        
        /* 새 항목 추가 섹션 스타일 */
        .add-item-section {
            margin-top: 20px;
            text-align: center;
        }
        
        .toggle-add-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .toggle-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .toggle-add-btn:active {
            transform: translateY(0);
        }
        
        .toggle-add-btn.expanded {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            margin-bottom: 16px;
        }
        
        /* 경로 저장 다이얼로그 스타일 */
        #routeSaveDialog {
            position: absolute;
            z-index: 15;
            width: 400px;
            max-width: 90vw;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }
        
        .route-save-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }
        
        .route-save-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }
        
        .route-save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .route-save-btn:active {
            transform: translateY(0);
        }
        
        /* 경로제거 버튼 스타일 */
        .route-remove-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }
        
        .route-remove-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .route-remove-btn:active {
            transform: translateY(0);
        }

    </style>
</head>
<body>
    <h1>홋카이도 여행</h1>
    <!-- 지도를 표시할 div 요소 -->
    <div id="map"></div>
    <!-- 사이드 패널 토글 버튼 (패널이 숨겨졌을 때만 보임) -->
    <button id="menuToggleBtn" class="show" onclick="showMenu()" title="메뉴 열기">☰</button>
    
    <!-- 오른쪽 상단 토글 버튼 -->
    <button id="rightMenuToggleBtn" onclick="toggleRightMenu()" title="지도 타입 메뉴 열기">&lt;</button>
    
    <!-- 오른쪽 상단 지도 타입 선택 버튼 -->
    <div id="mapTypeSelector" class="hide">
        <button class="map-type-btn" onclick="toggleRouteMode()" id="topRouteBtn">경로 생성</button>
        <button class="map-type-btn" onclick="setMapTypeFromTop('roadmap')" id="topRoadmapBtn">일반</button>
        <button class="map-type-btn" onclick="setMapTypeFromTop('satellite')" id="topSatelliteBtn">위성</button>
        <button class="map-type-btn sub-option" onclick="toggleHybridLabel()" id="topHybridBtn">라벨</button>
    </div>
    
    <!-- GPS 위치 버튼 -->
    <button id="locationBtn" onclick="getCurrentLocation()" title="현재 위치로 이동">📍</button>
    
    <!-- 줌 레벨 표시기 -->
    <div id="zoomLevelDisplay" title="현재 확대/축소 레벨">줌 5</div>
    
    <!-- 왼쪽 고정형 사이드바 메뉴 -->
    <div id="customMapMenu" class="hide">
      <h2>홋카이도 여행</h2>
      <div class="menu-group">
        <input type="text" id="addressInput" placeholder="주소를 입력하세요" style="width: 96%; margin-bottom: 4px; padding: 8px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #1a1a1a; font-size: 0.9rem;" onkeydown="if(event.key==='Enter'){searchAddress();}">
      </div>
      <div class="menu-group">
        <button id="preparationBtn" class="toggle-btn" onclick="showPreparationInfo()">사전준비</button>
        <button id="day1Btn" class="toggle-btn" onclick="showDay1Info()">1일차</button>
      </div>
      <div class="menu-group">
        <button id="clearRouteBtn" class="toggle-btn" onclick="clearUserRoute()" style="display: none;">경로 초기화</button>
      </div>
    </div>
    

    
    <script>
      // 전역 변수들
      let map;
      let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      let currentLocationMarker = null; // 현재 위치 마커 전역 변수
      let geocoder = null; // 주소 변환용 Geocoder
      let addressMarker = null; // 주소 검색 마커
      
      // 항로와 마커 관련 전역 변수들
      let flightPath = null;
      let dottedPath = null;
      let planeMarker = null;
      let incheonMarker = null;
      let chitoseMarker = null;
      
      // 사용자 경로 관련 전역 변수들
      let userRouteMarkers = []; // 사용자가 추가한 위치 마커들 (임시)
      let userRoutePath = null; // 사용자 경로 폴리라인
      let userRouteDottedPath = null; // 사용자 경로 점선 효과
      let isRouteMode = false; // 경로 생성 모드
      
      // 저장된 사용자 경로들
      let savedUserRoutes = []; // localStorage에서 불러온 저장된 경로들
      

      
      // DOM 캐시
      let cachedElements = {};
      function getElement(id) {
        if (!cachedElements[id]) {
          cachedElements[id] = document.getElementById(id);
        }
        return cachedElements[id];
      }
      
      // 모바일 최적화 함수
      function optimizeForMobile() {
        if (isMobile) {
          // 모바일에서 더블탭 줌 방지
          let lastTouchEnd = 0;
          document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
              event.preventDefault();
            }
            lastTouchEnd = now;
          }, false);
          
          // 모바일에서 지도 영역의 터치 이벤트 최적화
          const mapElement = document.getElementById('map');
          if (mapElement) {
            mapElement.addEventListener('touchstart', function(event) {
              // 한 손가락 터치만 허용
              if (event.touches.length === 1) {
                event.stopPropagation();
              }
            }, { passive: true });
            
            mapElement.addEventListener('touchmove', function(event) {
              // 한 손가락 드래그 허용
              if (event.touches.length === 1) {
                event.stopPropagation();
              }
            }, { passive: true });
          }
        }
      }
      
      // 구글맵 초기화 함수
      function initMap() {
        // 모바일 최적화 적용
        optimizeForMobile();
        
        // 인천공항과 산치토세공항의 좌표
        const incheonAirport = { lat: 37.4602, lng: 126.4407 }; // 인천공항
        const chitoseAirport = { lat: 42.7752, lng: 141.6928 }; // 산치토세공항
        
        // 두 공항 사이의 중간점 계산
        const centerLat = (incheonAirport.lat + chitoseAirport.lat) / 2;
        const centerLng = (incheonAirport.lng + chitoseAirport.lng) / 2;
        const center = { lat: centerLat, lng: centerLng };
        
        // 모바일에서는 더 넓은 뷰를 제공
        const zoom = isMobile ? 4 : 5;
        
        // 일반지도에서 라벨을 숨기는 스타일 정의
        const noLabelsStyle = [
          {
            featureType: 'all',
            elementType: 'labels',
            stylers: [{ visibility: 'off' }]
          },
          {
            featureType: 'all',
            elementType: 'labels.text',
            stylers: [{ visibility: 'off' }]
          },
          {
            featureType: 'all',
            elementType: 'labels.icon',
            stylers: [{ visibility: 'off' }]
          }
        ];
        
        // 구글 맵 객체 생성 및 옵션 설정 - 모바일 최적화
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: zoom,
          center: center,
          mapTypeControl: false,
          mapTypeControlOptions: {
            mapTypeIds: ['roadmap', 'satellite', 'hybrid'],
            style: google.maps.MapTypeControlStyle.VERTICAL_BAR,
            position: google.maps.ControlPosition.LEFT_TOP
          },
          // 모바일에서 기본 컨트롤들 비활성화
          fullscreenControl: false,
          streetViewControl: false,
          zoomControl: false,
          scaleControl: false,
          rotateControl: false,
          tilt: 0,
          // 모바일에서 한 손가락 드래그 허용
          gestureHandling: 'greedy',
          // 일반지도에서 라벨 숨기기
          styles: noLabelsStyle
        });
        
        geocoder = new google.maps.Geocoder(); // Geocoder 객체 생성
        
        // 공항 아이콘 마커 추가 - 이모지 사용
        incheonMarker = new google.maps.Marker({
          position: incheonAirport,
          map: map,
          title: '인천국제공항',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: 'transparent',
            fillOpacity: 0,
            strokeColor: 'transparent',
            strokeWeight: 0,
            scale: 0
          },
          label: {
            text: '✈️',
            fontSize: '18px',
            fontWeight: 'bold'
          }
        });
        
        chitoseMarker = new google.maps.Marker({
          position: chitoseAirport,
          map: map,
          title: '신치토세공항',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: 'transparent',
            fillOpacity: 0,
            strokeColor: 'transparent',
            strokeWeight: 0,
            scale: 0
          },
          label: {
            text: '✈️',
            fontSize: '18px',
            fontWeight: 'bold'
          }
        });
        
        // 인천공항에서 신치토세공항까지의 항로 (점선)
        flightPath = new google.maps.Polyline({
          path: [incheonAirport, chitoseAirport],
          geodesic: true,
          strokeColor: '#60a5fa',
          strokeOpacity: 0.8,
          strokeWeight: isMobile ? 4 : 3
        });
        
        flightPath.setMap(map);
        
        // 점선 효과를 위한 추가 선 (더 얇은 선으로 점선 효과)
        dottedPath = new google.maps.Polyline({
          path: [incheonAirport, chitoseAirport],
          geodesic: true,
          strokeColor: '#ffffff',
          strokeOpacity: 0.9,
          strokeWeight: 1,
          icons: [{
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              fillColor: '#60a5fa',
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 1,
              scale: isMobile ? 6 : 5
            },
            offset: '0',
            repeat: isMobile ? '12px' : '10px'
          }]
        });
        
        dottedPath.setMap(map);
        
        // 항로 정중앙에 항공권 마커 추가 - 이미지 중심과 항로 중심 일치
        const flightCenter = { lat: centerLat, lng: centerLng };
        const planeIconSize = isMobile ? 48 : 40;
        
        const planeIcon = {
          url: 'https://raw.githubusercontent.com/ppoppo1971/VMAP/refs/heads/main/%ED%95%AD%EA%B3%B5%EA%B6%8C.png',
          scaledSize: new google.maps.Size(planeIconSize, planeIconSize),
          // 이미지 오른쪽 하단을 기준으로 마커 위치 설정
          anchor: new google.maps.Point(planeIconSize, planeIconSize),
          // 이미지가 항로 위에 정확히 위치하도록 조정
          origin: new google.maps.Point(0, 0)
        };
        
        planeMarker = new google.maps.Marker({
          position: flightCenter,
          map: map,
          title: '항공권 정보 - 클릭하여 전자항공권 확인',
          icon: planeIcon,
          opacity: 1.0,
          // 마커가 항로 위에 정확히 위치하도록 설정
          optimized: false
        });
        
        // 비행기 마커 클릭 시 PDF 뷰어 열기
        planeMarker.addListener('click', function() {
          openPdfViewer();
        });
        
        // 지도 클릭 시 사이드패널 토글 기능 추가
        map.addListener('click', function(event) {
          // 경로 생성 모드일 때는 위치 추가
          if (isRouteMode) {
            addUserRoutePoint(event.latLng);
            return;
          }
          
          // 기존 기능들
          if (!getElement('customMapMenu').classList.contains('hide')) {
            hideMenu();
          }
          if (!getElement('mapTypeSelector').classList.contains('hide')) {
            hideRightMenu();
          }
          // 사전준비 정보창도 닫기
          closePreparationInfo();
        });
        
        // 오른쪽 상단 버튼 초기 상태 설정
        updateTopButtonStates('roadmap');
        
        // 줌 레벨 변경 이벤트 리스너 추가
        map.addListener('zoom_changed', function() {
            updateZoomLevel();
            toggleFlightElements(map.getZoom()); // 줌 레벨에 따라 항로와 마커 표시/숨김
        });
        
        // 지도 이동 이벤트 리스너 추가 - 주소 마커 자동 제거
        map.addListener('bounds_changed', function() {
            checkAddressMarkerVisibility();
        });
        
        // 초기 줌 레벨 표시
        updateZoomLevel();
        toggleFlightElements(map.getZoom()); // 초기 줌 레벨에 따라 항로와 마커 표시/숨김
        
        // 저장된 사용자 경로들 복원
        restoreSavedUserRoutes().then(() => {
          // Firebase 실시간 동기화 설정
          setupFirebaseSync();
        });
        

        
        // GeoJSON 스타일 설정 - 항로 스타일로 개선
        map.data.setStyle(function(feature) {
          const geometryType = feature.getGeometry().getType();
          
          if (geometryType === 'LineString' || geometryType === 'MultiLineString') {
            // 선형 지오메트리: 항로 스타일 적용
            return {
              strokeColor: '#60a5fa',
              strokeWeight: 3,
              strokeOpacity: 0.8,
              fillColor: 'transparent',
              fillOpacity: 0
            };
          } else if (geometryType === 'Point' || geometryType === 'MultiPoint') {
            // 점형 지오메트리: 마커 스타일 적용
            return {
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: '#1d4ed8',
                fillOpacity: 1,
                strokeColor: '#ffffff',
                strokeWeight: 2,
                scale: 6
              }
            };
          } else {
            // 면형 지오메트리: 기본 스타일 적용
            return {
              fillColor: '#1d4ed8',
              fillOpacity: 0.3,
              strokeColor: '#1d4ed8',
              strokeWeight: 2,
              strokeOpacity: 0.8
            };
          }
        });
      }
      
      function setMapType(type) {
        // 지도 타입 설정
        if (map && map.setMapTypeId) {
          map.setMapTypeId(type);
        }
        
        // 지도 타입에 따라 라벨 표시 여부 제어
        if (map && map.setOptions) {
          if (type === 'roadmap') {
            // 일반지도: 라벨 숨기기
            map.setOptions({
              styles: [
                {
                  featureType: 'all',
                  elementType: 'labels',
                  stylers: [{ visibility: 'off' }]
                },
                {
                  featureType: 'all',
                  elementType: 'labels.text',
                  stylers: [{ visibility: 'off' }]
                },
                {
                  featureType: 'all',
                  elementType: 'labels.icon',
                  stylers: [{ visibility: 'off' }]
                }
              ]
            });
          } else if (type === 'satellite') {
            // 위성지도: 라벨 숨기기
            map.setOptions({
              styles: [
                {
                  featureType: 'all',
                  elementType: 'labels',
                  stylers: [{ visibility: 'off' }]
                },
                {
                  featureType: 'all',
                  elementType: 'labels.text',
                  stylers: [{ visibility: 'off' }]
                },
                {
                  featureType: 'all',
                  elementType: 'labels.icon',
                  stylers: [{ visibility: 'off' }]
                }
              ]
            });
          } else if (type === 'hybrid') {
            // 하이브리드: 라벨 표시
            map.setOptions({
              styles: [] // 기본 스타일 사용 (라벨 표시)
            });
          }
        }
        
        // 오른쪽 상단 버튼 상태 업데이트
        updateTopButtonStates(type);
      }
      
      // 오른쪽 상단 버튼에서 지도 타입 설정
      function setMapTypeFromTop(type) {
        if (map && map.setMapTypeId) {
          map.setMapTypeId(type);
        }
        
        // 오른쪽 상단 버튼 상태 업데이트
        updateTopButtonStates(type);
        
        // 사이드패널과 동기화
        syncSidePanelWithTop(type);
      }
      
      // 오른쪽 상단 버튼 상태 업데이트
      function updateTopButtonStates(activeType) {
        const topRoadmapBtn = document.getElementById('topRoadmapBtn');
        const topSatelliteBtn = document.getElementById('topSatelliteBtn');
        const topHybridBtn = document.getElementById('topHybridBtn');
        
        // 모든 버튼 비활성화
        [topRoadmapBtn, topSatelliteBtn, topHybridBtn].forEach(btn => {
          if (btn) btn.classList.remove('active');
        });
        
        // 활성 타입에 따라 버튼 상태 설정
        switch (activeType) {
          case 'roadmap':
            if (topRoadmapBtn) topRoadmapBtn.classList.add('active');
            if (topHybridBtn) {
              topHybridBtn.textContent = '라벨';
            }
            break;
          case 'satellite':
            if (topSatelliteBtn) topSatelliteBtn.classList.add('active');
            if (topHybridBtn) {
              topHybridBtn.textContent = '라벨';
            }
            break;
          case 'hybrid':
            if (topSatelliteBtn) topSatelliteBtn.classList.add('active');
            if (topHybridBtn) {
              topHybridBtn.classList.add('active');
              topHybridBtn.textContent = '라벨';
            }
            break;
        }
      }
      
      // 사이드패널과 오른쪽 상단 버튼 동기화
      function syncSidePanelWithTop(activeType) {
        // 일반 선택 시
        if (activeType === 'roadmap') {
          const roadmapMenu = document.getElementById('roadmapMenu');
          const roadmapBtn = document.getElementById('roadmapToggleBtn');
          if (roadmapMenu && roadmapBtn) {
            roadmapMenu.style.display = 'block';
            roadmapBtn.textContent = '-일반';
          }
          
          const satelliteMenu = document.getElementById('satelliteMenu');
          const satelliteBtn = document.getElementById('satelliteToggleBtn');
          if (satelliteMenu && satelliteBtn) {
            satelliteMenu.style.display = 'none';
            satelliteBtn.textContent = '+위성';
          }
        }
        // 위성 선택 시
        else if (activeType === 'satellite') {
          const roadmapMenu = document.getElementById('roadmapMenu');
          const roadmapBtn = document.getElementById('roadmapToggleBtn');
          if (roadmapMenu && roadmapBtn) {
            roadmapMenu.style.display = 'none';
            roadmapBtn.textContent = '+일반';
          }
          
          const satelliteMenu = document.getElementById('satelliteMenu');
          const satelliteBtn = document.getElementById('satelliteToggleBtn');
          if (satelliteMenu && satelliteBtn) {
            satelliteMenu.style.display = 'block';
            satelliteBtn.textContent = '-위성';
          }
        }
        // 하이브리드 선택 시
        else if (activeType === 'hybrid') {
          const roadmapMenu = document.getElementById('roadmapMenu');
          const roadmapBtn = document.getElementById('roadmapToggleBtn');
          if (roadmapMenu && roadmapBtn) {
            roadmapMenu.style.display = 'none';
            roadmapBtn.textContent = '+일반';
          }
          
          const satelliteMenu = document.getElementById('satelliteMenu');
          const satelliteBtn = document.getElementById('satelliteToggleBtn');
          if (satelliteMenu && satelliteBtn) {
            satelliteMenu.style.display = 'block';
            satelliteBtn.textContent = '-위성';
          }
        }
      }
      
      // 최적화된 메뉴 토글 함수
      function toggleMenu(menuId, btnId, menuName, subMenus = []) {
        const menu = getElement(menuId);
        const btn = getElement(btnId);
        const isHidden = menu.style.display === 'none';
        
        menu.style.display = isHidden ? 'block' : 'none';
        btn.textContent = isHidden ? `-${menuName}` : `+${menuName}`;
        
        if (!isHidden && subMenus.length) {
          subMenus.forEach(({menuId, btnId, btnText}) => {
            getElement(menuId).style.display = 'none';
            getElement(btnId).textContent = btnText;
          });
        }
      }
      
      // 구글맵 메뉴 토글
      function toggleGoogleMapMenu() {
        toggleMenu('googleMapMenu', 'googleMapToggleBtn', '구글맵', [
          {menuId: 'roadmapMenu', btnId: 'roadmapToggleBtn', btnText: '+일반'},
          {menuId: 'satelliteMenu', btnId: 'satelliteToggleBtn', btnText: '+위성'}
        ]);
      }
      
      // +일반 클릭 시 바로 일반지도를 로드하고, 하위 메뉴만 토글
      function toggleRoadmapMenuAndSetRoadmap() {
        const menu = document.getElementById('roadmapMenu');
        const btn = document.getElementById('roadmapToggleBtn');
        if(menu.style.display === 'none') {
          setMapType('roadmap');
          menu.style.display = 'block';
          btn.textContent = '-일반';
        } else {
          menu.style.display = 'none';
          btn.textContent = '+일반';
        }
      }
      
      // +위성 클릭 시 바로 위성지도를 로드하고, 하위에 하이브리드만 보이도록
      function toggleSatelliteMenuAndSetSatellite() {
        const menu = document.getElementById('satelliteMenu');
        const btn = document.getElementById('satelliteToggleBtn');
        if(menu.style.display === 'none') {
          setMapType('satellite');
          menu.style.display = 'block';
          btn.textContent = '-위성';
        } else {
          menu.style.display = 'none';
          btn.textContent = '+위성';
        }
      }

      // 라벨 버튼 토글 함수
      function toggleHybridLabel() {
        const hybridBtn = document.getElementById('topHybridBtn');
        const currentMapType = map.getMapTypeId();
        
        if (!hybridBtn.classList.contains('active')) { // 라벨 버튼이 비활성화된 경우
          if (currentMapType === 'roadmap') {
            // 일반지도에서 라벨 표시
            map.setOptions({
              styles: [] // 기본 스타일 사용 (라벨 표시)
            });
          } else if (currentMapType === 'satellite') {
            // 위성지도에서 하이브리드로 변경
            setMapType('hybrid');
          }
          hybridBtn.classList.add('active');
        } else { // 라벨 버튼이 활성화된 경우
          if (currentMapType === 'roadmap') {
            // 일반지도에서 라벨 숨기기
            map.setOptions({
              styles: [
                {
                  featureType: 'all',
                  elementType: 'labels',
                  stylers: [{ visibility: 'off' }]
                },
                {
                  featureType: 'all',
                  elementType: 'labels.text',
                  stylers: [{ visibility: 'off' }]
                },
                {
                  featureType: 'all',
                  elementType: 'labels.icon',
                  stylers: [{ visibility: 'off' }]
                }
              ]
            });
          } else if (currentMapType === 'hybrid') {
            // 하이브리드에서 위성으로 변경
            setMapType('satellite');
          }
          hybridBtn.classList.remove('active');
        }
        
        // 사이드패널과 동기화
        syncSidePanelWithTop(currentMapType);
      }
      
                    // 체크박스 상태 저장 함수
       async function saveCheckboxStates() {
         const checkboxes = document.querySelectorAll('.prep-checkbox');
         const states = {};
         checkboxes.forEach(checkbox => {
           states[checkbox.id] = checkbox.checked;
         });
         
         try {
           // Firebase에 저장
           await window.firestore.setDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
             preparationCheckboxes: states,
             lastUpdated: window.firestore.serverTimestamp()
           }, { merge: true });
           
           // 사용자 추가 항목의 체크박스 상태도 업데이트
           updateUserItemsCheckboxStates();
           
           console.log('Firebase에 체크박스 상태 저장 완료');
         } catch (error) {
           console.error('Firebase 저장 실패:', error);
           // 실패 시 localStorage에 백업
           localStorage.setItem('preparationCheckboxes', JSON.stringify(states));
           alert('Firebase 저장에 실패했습니다. 로컬에 백업되었습니다.');
         }
       }
       
       // 사용자 추가 항목의 체크박스 상태 업데이트 함수
       function updateUserItemsCheckboxStates() {
         const userItems = JSON.parse(localStorage.getItem('userAddedItems') || '[]');
         const updatedItems = userItems.map(item => {
           const checkbox = document.getElementById(item.id);
           if (checkbox) {
             item.checked = checkbox.checked;
           }
           return item;
         });
         localStorage.setItem('userAddedItems', JSON.stringify(updatedItems));
       }
       
             // 체크박스 상태 복원 함수
      async function restoreCheckboxStates() {
        try {
          const docSnap = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'));
          if (docSnap.exists()) {
            const data = docSnap.data();
            if (data.preparationCheckboxes) {
              Object.keys(data.preparationCheckboxes).forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                  checkbox.checked = data.preparationCheckboxes[id];
                }
              });
            }
          }
          
          // 사용자 추가 항목들 복원
          restoreUserAddedItems();
          
          console.log('Firebase에서 체크박스 상태 복원 완료');
        } catch (error) {
          console.error('Firebase 로드 실패:', error);
          // 실패 시 localStorage에서 복원
          const savedStates = localStorage.getItem('preparationCheckboxes');
          if (savedStates) {
            const states = JSON.parse(savedStates);
            Object.keys(states).forEach(id => {
              const checkbox = document.getElementById(id);
              if (checkbox) {
                checkbox.checked = states[id];
              }
            });
          }
          restoreUserAddedItems();
        }
      }
       
       // 사전준비 정보창 표시 함수
        function showPreparationInfo() {
          // 기존 정보창이 있으면 제거
          const existingInfo = document.getElementById('preparationInfo');
          if (existingInfo) {
            existingInfo.remove();
            return;
          }
          
          // 정보창 생성
          const infoDiv = document.createElement('div');
          infoDiv.id = 'preparationInfo';
          infoDiv.innerHTML = `
            <div class="info-header">
             <h3>사전준비 항목</h3>
              <button class="close-btn" onclick="closePreparationInfo()">×</button>
            </div>
            <div class="info-content">
              <div class="info-section">
                                <div class="checklist-item">
                   <input type="checkbox" id="airline" class="prep-checkbox" onchange="saveCheckboxStates()">
                   <span onclick="openPdfViewer()" style="cursor: pointer;"><strong>항공권</strong> - 예약확인서 및 전자항공권</span>
                 </div>
                <div class="checklist-item">
                  <input type="checkbox" id="parking" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span><strong>공항주차</strong> - 장기주차 예약</span>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="insurance" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span><strong>여행자보험</strong> - 해외여행 보험 가입</span>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="sim" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span><strong>이심</strong> - 일본 현지 인터넷 연결</span>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="visitjapan" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span onclick="openVisitJapanWeb()" style="cursor: pointer;"><strong>Visit Japan Web</strong> - 입국 수속 사전 등록</span>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="confirmations" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span><strong>각종 확정서 출력</strong> - 호텔, 투어예약확인서</span>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="beergarden" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span><strong>삿포로비어가든 예약</strong> - 징기스칸 예약</span>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="songyeongbus" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span onclick="openSongyeongBusPdf()" style="cursor: pointer;"><strong>송영버스 예약</strong> - 삿포로-마호바로 간 이동</span>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="donanbus" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span onclick="openDonanBusWebsite()" style="cursor: pointer;"><strong>도난버스 예약</strong> - 마호바로-항공 간 이동</span>
                </div>
                                 <!-- 사용자 추가 항목들이 여기에 표시됩니다 -->
                 <div id="userAddedItems"></div>
                                   <!-- 새 항목 추가 버튼 -->
                  <div class="add-item-section">
                    <button type="button" onclick="showAddForm()" class="toggle-add-btn" id="toggleAddBtn">+ 새 항목 추가</button>
                  </div>
                 <!-- 새 항목 추가 폼 (처음에는 숨김) -->
                 <div class="add-item-form" id="addItemForm" style="display: none;">
                   <div class="form-group">
                     <input type="text" id="newItemTitle" placeholder="항목 제목을 입력하세요" maxlength="50">
                     <input type="text" id="newItemDescription" placeholder="설명을 입력하세요" maxlength="100">
                     <input type="url" id="newItemLink" placeholder="링크를 입력하세요 (선택사항)" maxlength="200">
                   </div>
                   <div class="form-buttons">
                     <button type="button" onclick="addNewItem()" class="add-btn">추가</button>
                   </div>
                 </div>
              </div>
            </div>
          `;
          
          // 정보창을 지도 위에 표시
          document.body.appendChild(infoDiv);
          
          // 저장된 체크박스 상태 복원
          setTimeout(() => {
            restoreCheckboxStates();
          }, 50);
          
                  // 정보창 위치 조정 - 모바일 최적화
        setTimeout(() => {
          const menu = document.getElementById('customMapMenu');
          const menuRect = menu.getBoundingClientRect();
          const mapElement = document.getElementById('map');
          const mapRect = mapElement.getBoundingClientRect();
          
          if (isMobile) {
            // 모바일: 화면 중앙에 표시
            infoDiv.style.left = '50%';
            infoDiv.style.transform = 'translateX(-50%)';
            infoDiv.style.top = '80px';
          } else {
            // 데스크톱: 사이드메뉴 오른쪽에 표시
            infoDiv.style.left = (menuRect.right + 10) + 'px';
            infoDiv.style.top = menuRect.top + 'px';
            infoDiv.style.transform = 'none';
          }
        }, 100);
        }
      
      // 사전준비 정보창 닫기 함수
      function closePreparationInfo() {
        const infoDiv = document.getElementById('preparationInfo');
        if (infoDiv) {
          infoDiv.remove();
        }
      }
      
      // 1일차 정보창 표시 함수
      function showDay1Info() {
        // 기존 정보창이 있으면 제거
        const existingInfo = document.getElementById('preparationInfo');
        if (existingInfo) {
          existingInfo.remove();
        }
        
        // 정보창 생성
        const infoDiv = document.createElement('div');
        infoDiv.id = 'preparationInfo';
        infoDiv.innerHTML = `
          <div class="info-header">
            <h3>1일차 - 도착 및 첫날</h3>
            <button class="close-btn" onclick="closePreparationInfo()">×</button>
          </div>
          <div class="info-content">
            <div class="info-section">
              <h4>✈️ 공항 도착</h4>
              <div class="checklist-item">
                <input type="checkbox" id="arrival" class="prep-checkbox" onchange="saveCheckboxStates()">
                <span><strong>신치토세공항 도착</strong> - 오후 12:30 (일본시간)</span>
              </div>
              <div class="checklist-item">
                <input type="checkbox" id="immigration" class="prep-checkbox" onchange="saveCheckboxStates()">
                <span><strong>입국심사</strong> - 여권 및 Visit Japan Web QR코드 제시</span>
              </div>
              <div class="checklist-item">
                <input type="checkbox" id="baggage" class="prep-checkbox" onchange="saveCheckboxStates()">
                <span><strong>수하물 수령</strong> - 위탁수하물 확인</span>
              </div>
            </div>
            
            <div class="info-section">
              <h4>🚌 공항 이동</h4>
              <div class="checklist-item">
                <input type="checkbox" id="airportBus" class="prep-checkbox" onchange="saveCheckboxStates()">
                <span onclick="openSongyeongBusPdf()" style="cursor: pointer;"><strong>송영버스 탑승</strong> - 삿포로 시내행 버스</span>
              </div>
              <div class="checklist-item">
                <input type="checkbox" id="sapporoArrival" class="prep-checkbox" onchange="saveCheckboxStates()">
                <span><strong>삿포로 도착</strong> - 약 1시간 30분 소요</span>
              </div>
            </div>
            
            <div class="info-section">
              <h4>🏨 호텔 체크인</h4>
              <div class="checklist-item">
                <input type="checkbox" id="hotelCheckin" class="prep-checkbox" onchange="saveCheckboxStates()">
                <span><strong>호텔 도착</strong> - 체크인 및 짐 정리</span>
              </div>
              <div class="checklist-item">
                <input type="checkbox" id="simActivation" class="prep-checkbox" onchange="saveCheckboxStates()">
                <span><strong>이심 활성화</strong> - 일본 현지 인터넷 연결</span>
              </div>
            </div>
            
            <div class="info-section">
              <h4>🍽️ 저녁 식사</h4>
              <div class="checklist-item">
                <input type="checkbox" id="dinner" class="prep-checkbox" onchange="saveCheckboxStates()">
                <span><strong>징기스칸</strong> - 삿포로비어가든 예약</span>
              </div>
              <div class="checklist-item">
                <input type="checkbox" id="beer" class="prep-checkbox" onchange="saveCheckboxStates()">
                <span><strong>삿포로 맥주</strong> - 현지 맥주 시음</span>
              </div>
            </div>
            
                         <div class="info-section">
               <h4>🌙 첫날 마무리</h4>
               <div class="checklist-item">
                 <input type="checkbox" id="shopping" class="prep-checkbox" onchange="saveCheckboxStates()">
                 <span><strong>편의점 쇼핑</strong> - 간식 및 생필품 구매</span>
               </div>
               <div class="checklist-item">
                 <input type="checkbox" id="rest" class="prep-checkbox" onchange="saveCheckboxStates()">
                 <span><strong>호텔 휴식</strong> - 다음날 일정 준비</span>
               </div>
             </div>
             
             <div class="info-section">
               <h4>🗺️ 저장된 경로</h4>
               <button class="route-remove-btn" onclick="removeDay1Routes()">경로제거</button>
               <p style="font-size: 0.9rem; color: #6b7280; margin-top: 8px;">
                 1일차에 저장된 경로들을 제거합니다.
               </p>
             </div>
          </div>
        `;
        
        // 정보창을 지도 위에 표시
        document.body.appendChild(infoDiv);
        
        // 저장된 체크박스 상태 복원
        setTimeout(() => {
          restoreCheckboxStates();
        }, 50);
        
        // 정보창 위치 조정 - 모바일 최적화
        setTimeout(() => {
          const menu = document.getElementById('customMapMenu');
          const menuRect = menu.getBoundingClientRect();
          const mapElement = document.getElementById('map');
          const mapRect = mapElement.getBoundingClientRect();
          
          if (isMobile) {
            // 모바일: 화면 중앙에 표시
            infoDiv.style.left = '50%';
            infoDiv.style.transform = 'translateX(-50%)';
            infoDiv.style.top = '80px';
          } else {
            // 데스크톱: 사이드메뉴 오른쪽에 표시
            infoDiv.style.left = (menuRect.right + 10) + 'px';
            infoDiv.style.top = menuRect.top + 'px';
            infoDiv.style.transform = 'none';
          }
        }, 100);
      }
      
      // 상세 정보창 표시 함수
      function showDetailedInfo() {
        // 기존 정보창 제거
        closePreparationInfo();
        
        // 상세 정보창 생성
        const detailedDiv = document.createElement('div');
        detailedDiv.id = 'preparationInfo';
        detailedDiv.innerHTML = `
          <div class="info-header">
            <h3>항공권 상세정보</h3>
            <button class="close-btn" onclick="closePreparationInfo()">×</button>
          </div>
          <div class="info-content">
            <div class="info-section">
              <h4>✈️ 항공권 정보</h4>
              <p><strong>출발:</strong> 인천국제공항 (ICN)</p>
              <p><strong>도착:</strong> 신치토세공항 (CTS)</p>
              <p><strong>항공사:</strong> 대한항공, 아시아나항공, 제주항공</p>
              <p><strong>소요시간:</strong> 약 3시간 30분</p>
              <p><strong>출발시간:</strong> 오전 9:00 (한국시간)</p>
              <p><strong>도착시간:</strong> 오후 12:30 (일본시간)</p>
              <p><strong>항공편:</strong> KE 705 / OZ 115 / 7C 2001</p>
            </div>
            <div class="info-section">
              <h4>📋 예약확인서</h4>
              <p><strong>예약번호:</strong> ABC123456789</p>
              <p><strong>예약일:</strong> 2024년 12월 15일</p>
              <p><strong>승객:</strong> 성인 2명</p>
              <p><strong>좌석:</strong> 15A, 15B (창가석)</p>
              <p><strong>수하물:</strong> 위탁 23kg x 2개, 휴대 10kg x 2개</p>
            </div>
            <div class="info-section">
              <h4>🔗 관련 링크</h4>
              <button class="ticket-btn" onclick="openPdfViewer()">전자항공권 보기</button>
              <button class="ticket-btn" style="margin-top: 10px; background: linear-gradient(135deg, #f59e0b, #d97706);" onclick="openReservationConfirmation()">예약확인서 보기</button>
            </div>
          </div>
        `;
        
        // 상세 정보창을 지도 위에 표시
        document.body.appendChild(detailedDiv);
        
        // 상세 정보창 위치 조정 - 모바일 최적화
        setTimeout(() => {
          const mapElement = document.getElementById('map');
          const mapRect = mapElement.getBoundingClientRect();
          
          if (isMobile) {
            // 모바일: 화면 중앙에 표시
            detailedDiv.style.left = '50%';
            detailedDiv.style.transform = 'translateX(-50%)';
            detailedDiv.style.top = '80px';
          } else {
            // 데스크톱: 지도 중앙에 표시
            detailedDiv.style.left = (mapRect.width / 2 - 200) + 'px';
            detailedDiv.style.top = (mapRect.height / 2 - 200) + 'px';
            detailedDiv.style.transform = 'none';
          }
        }, 100);
      }
      
      // 사이드 패널 토글 함수
      function hideMenu() {
        getElement('customMapMenu').classList.add('hide');
        getElement('menuToggleBtn').classList.add('show');
      }
      
      function showMenu() {
        getElement('customMapMenu').classList.remove('hide');
        getElement('menuToggleBtn').classList.remove('show');
      }

      // 오른쪽 메뉴 토글 함수
      function toggleRightMenu() {
        const mapTypeSelector = document.getElementById('mapTypeSelector');
        const rightMenuToggleBtn = document.getElementById('rightMenuToggleBtn');
        const isHidden = mapTypeSelector.classList.contains('hide');
        
        if (isHidden) {
          // 메뉴를 보여줄 때
          mapTypeSelector.classList.remove('hide');
          rightMenuToggleBtn.style.display = 'none'; // 토글 버튼 숨기기
        } else {
          // 메뉴를 숨길 때
          mapTypeSelector.classList.add('hide');
          rightMenuToggleBtn.style.display = 'flex'; // 토글 버튼 보이기
        }
      }
      
      // 오른쪽 메뉴 숨기기 함수
      function hideRightMenu() {
        getElement('mapTypeSelector').classList.add('hide');
        getElement('rightMenuToggleBtn').style.display = 'flex'; // 토글 버튼 보이기
      }
      
      // PDF 파일 직접 열기 함수
      function openPdfViewer() {
        // PDF 파일 URL
        const pdfUrl = 'https://ppoppo1971.github.io/VMAP/%EC%A0%84%EC%9E%90%ED%95%AD%EA%B3%B5%EA%B6%8C.pdf';
        
        // 현재 탭에서 PDF 열기
        try {
          window.location.href = pdfUrl;
        } catch (error) {
          console.error('PDF 열기 실패:', error);
          alert('PDF 파일을 열 수 없습니다. 직접 링크를 복사하여 사용해주세요: ' + pdfUrl);
        }
      }
      
      // Visit Japan Web 링크 열기 함수
      function openVisitJapanWeb() {
        // 네이버 블로그 URL
        const visitJapanUrl = 'https://blog.naver.com/sostrip/223644368814';
        
        // 새 탭에서 링크 열기
        try {
          window.open(visitJapanUrl, '_blank');
        } catch (error) {
          console.error('Visit Japan Web 링크 열기 실패:', error);
          alert('링크를 열 수 없습니다. 직접 링크를 복사하여 사용해주세요: ' + visitJapanUrl);
        }
      }
      
      // 송영버스 PDF 열기 함수
      function openSongyeongBusPdf() {
        // 송영버스 PDF 파일 URL
        const songyeongBusPdfUrl = 'https://ppoppo1971.github.io/VMAP/%EC%86%A1%EC%98%81%EB%B2%84%EC%8A%A4.pdf';
        
        // 현재 탭에서 PDF 열기
        try {
          window.location.href = songyeongBusPdfUrl;
        } catch (error) {
          console.error('송영버스 PDF 열기 실패:', error);
          alert('PDF 파일을 열 수 없습니다. 직접 링크를 복사하여 사용해주세요: ' + songyeongBusPdfUrl);
        }
      }
      
      // 도난버스 웹사이트 열기 함수
      function openDonanBusWebsite() {
        // 일본버스라인 웹사이트 URL
        const donanBusUrl = 'https://japanbuslines.com/ko/bus_search/hokkaido/noboribetsu/hokkaido/all/ym_202509/day_20/';
        
        // 새 탭에서 웹사이트 열기
        try {
          window.open(donanBusUrl, '_blank');
        } catch (error) {
          console.error('도난버스 웹사이트 열기 실패:', error);
          alert('웹사이트를 열 수 없습니다. 직접 링크를 복사하여 사용해주세요: ' + donanBusUrl);
        }
      }
      
      // 예약확인서 보기 함수
      function openReservationConfirmation() {
        // 기존 정보창 제거
        closePreparationInfo();
        
        // 예약확인서 창 생성
        const reservationDiv = document.createElement('div');
        reservationDiv.id = 'preparationInfo';
        reservationDiv.innerHTML = `
          <div class="info-header">
            <h3>예약확인서</h3>
            <button class="close-btn" onclick="closePreparationInfo()">×</button>
          </div>
          <div class="info-content">
            <div class="info-section">
              <h4>✈️ 항공편 정보</h4>
              <p><strong>항공사:</strong> 대한항공 (Korean Air)</p>
              <p><strong>항공편:</strong> KE 705</p>
              <p><strong>출발:</strong> 인천국제공항 (ICN) - 터미널 2</p>
              <p><strong>도착:</strong> 신치토세공항 (CTS) - 국제선 터미널</p>
              <p><strong>출발시간:</strong> 2024년 12월 20일 오전 9:00</p>
              <p><strong>도착시간:</strong> 2024년 12월 20일 오후 12:30</p>
              <p><strong>소요시간:</strong> 3시간 30분</p>
            </div>
            <div class="info-section">
              <h4>👥 승객 정보</h4>
              <p><strong>예약번호:</strong> ABC123456789</p>
              <p><strong>예약일:</strong> 2024년 12월 15일</p>
              <p><strong>승객 1:</strong> 홍길동 (성인)</p>
              <p><strong>승객 2:</strong> 김철수 (성인)</p>
              <p><strong>좌석:</strong> 15A, 15B (창가석)</p>
            </div>
            <div class="info-section">
              <h4>🧳 수하물 정보</h4>
              <p><strong>위탁수하물:</strong> 23kg x 2개 (총 46kg)</p>
              <p><strong>휴대수하물:</strong> 10kg x 2개 (총 20kg)</p>
              <p><strong>수하물 제한:</strong> 1인당 위탁 1개, 휴대 1개</p>
            </div>
            <div class="info-section">
              <h4>📱 체크인 안내</h4>
              <p><strong>온라인 체크인:</strong> 출발 24시간 전 ~ 1시간 전</p>
              <p><strong>공항 체크인:</strong> 출발 3시간 전 ~ 1시간 전</p>
              <p><strong>체크인 카운터:</strong> 터미널 2 3층 출국장</p>
              <p><strong>필수서류:</strong> 여권, 예약확인서</p>
            </div>
            <div class="info-section">
              <h4>🔗 관련 링크</h4>
              <button class="ticket-btn" onclick="openPdfViewer()">전자항공권 PDF</button>
              <button class="ticket-btn" style="margin-top: 10px; background: linear-gradient(135deg, #8b5cf6, #7c3aed);" onclick="printReservation()">예약확인서 인쇄</button>
            </div>
          </div>
        `;
        
        // 예약확인서 창을 지도 위에 표시
        document.body.appendChild(reservationDiv);
        
        // 예약확인서 창 위치 조정 - 모바일 최적화
        setTimeout(() => {
          const mapElement = document.getElementById('map');
          const mapRect = mapElement.getBoundingClientRect();
          
          if (isMobile) {
            // 모바일: 화면 중앙에 표시
            reservationDiv.style.left = '50%';
            reservationDiv.style.transform = 'translateX(-50%)';
            reservationDiv.style.top = '80px';
          } else {
            // 데스크톱: 지도 중앙에 표시
            reservationDiv.style.left = (mapRect.width / 2 - 200) + 'px';
            reservationDiv.style.top = (mapRect.height / 2 - 250) + 'px';
            reservationDiv.style.transform = 'none';
          }
        }, 100);
      }
      
      // 예약확인서 인쇄 함수
      function printReservation() {
        window.print();
      }
      
             // 새 항목 추가 함수
       async function addNewItem() {
         const titleInput = document.getElementById('newItemTitle');
         const descriptionInput = document.getElementById('newItemDescription');
         const linkInput = document.getElementById('newItemLink');
         
         const title = titleInput.value.trim();
         const description = descriptionInput.value.trim();
         const link = linkInput.value.trim();
         
         if (!title) {
           alert('항목 제목을 입력해주세요.');
           titleInput.focus();
           return;
         }
         
         // 새 항목 생성
         const newItem = {
           id: 'user_' + Date.now(),
           title: title,
           description: description,
           link: link || null,
           checked: false,
           timestamp: new Date().toISOString()
         };
         
         try {
           // Firebase에 저장
           await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
             userAddedItems: window.firestore.arrayUnion(newItem)
           });
           
           // 화면에 새 항목 표시
           displayUserAddedItems();
           
           // 폼 초기화
           clearForm();
           
           // 성공 메시지
           alert('새 항목이 추가되었습니다!');
           
           // 항목 추가 후 폼 자동 숨기기
           hideAddForm();
           
           console.log('Firebase에 새 항목 저장 완료');
         } catch (error) {
           console.error('Firebase 저장 실패:', error);
           alert('항목 추가에 실패했습니다. 다시 시도해주세요.');
         }
       }
      
      // 폼 지우기 함수
      function clearForm() {
        document.getElementById('newItemTitle').value = '';
        document.getElementById('newItemDescription').value = '';
        document.getElementById('newItemLink').value = '';
        document.getElementById('newItemTitle').focus();
      }
      
      // 사용자 추가 항목들 표시 함수
      function displayUserAddedItems() {
        const container = document.getElementById('userAddedItems');
        if (!container) return;
        
        const userItems = JSON.parse(localStorage.getItem('userAddedItems') || '[]');
        
        if (userItems.length === 0) {
          container.innerHTML = '';
          return;
        }
        
        let html = '';
        userItems.forEach(item => {
          const titleElement = item.link 
            ? `<span onclick="openUserItemLink('${item.link}')" style="cursor: pointer; color: #1d4ed8; text-decoration: underline;"><strong>${item.title}</strong></span>`
            : `<strong>${item.title}</strong>`;
          
          html += `
            <div class="user-added-item" data-item-id="${item.id}">
              <div class="item-content">
                <input type="checkbox" id="${item.id}" class="prep-checkbox" onchange="saveCheckboxStates()" ${item.checked ? 'checked' : ''}>
                <span>${titleElement} - ${item.description}</span>
                <button class="delete-btn" onclick="deleteUserItem('${item.id}')" title="삭제">×</button>
              </div>
              <button class="swipe-delete-btn" onclick="deleteUserItem('${item.id}')" title="삭제">삭제</button>
            </div>
          `;
        });
        
        container.innerHTML = html;
        
        // 스와이프 삭제 기능 초기화
        initializeSwipeDelete();
      }
      
      // 사용자 추가 항목 복원 함수
      function restoreUserAddedItems() {
        setTimeout(() => {
          displayUserAddedItems();
        }, 100);
      }
      
      // 사용자 추가 항목 삭제 함수
      function deleteUserItem(itemId) {
        if (!confirm('이 항목을 삭제하시겠습니까?')) {
          return;
        }
        
        // localStorage에서 항목 제거
        let userItems = JSON.parse(localStorage.getItem('userAddedItems') || '[]');
        userItems = userItems.filter(item => item.id !== itemId);
        localStorage.setItem('userAddedItems', JSON.stringify(userItems));
        
        // 화면에서 항목 제거
        displayUserAddedItems();
        
        // 체크박스 상태도 업데이트
        saveCheckboxStates();
        
        alert('항목이 삭제되었습니다.');
      }
      
             // 사용자 항목 링크 열기 함수
       function openUserItemLink(link) {
         if (!link) return;
         
         try {
           // 새 탭에서 링크 열기
           window.open(link, '_blank');
         } catch (error) {
           console.error('링크 열기 실패:', error);
           alert('링크를 열 수 없습니다. 직접 링크를 복사하여 사용해주세요: ' + link);
         }
       }
       
               // 추가 폼 표시 함수
        function showAddForm() {
          const form = document.getElementById('addItemForm');
          const toggleBtn = document.getElementById('toggleAddBtn');
          
          // 폼을 보여줄 때
          form.style.display = 'block';
          toggleBtn.style.display = 'none'; // 버튼 숨기기
          
          // 제목 입력란에 포커스
          setTimeout(() => {
            document.getElementById('newItemTitle').focus();
          }, 100);
        }
        
        // 추가 폼 숨기기 함수
        function hideAddForm() {
          const form = document.getElementById('addItemForm');
          const toggleBtn = document.getElementById('toggleAddBtn');
          
          // 폼을 숨기고 버튼을 다시 표시
          form.style.display = 'none';
          toggleBtn.style.display = 'block';
          
          // 폼 내용 초기화
          document.getElementById('newItemTitle').value = '';
          document.getElementById('newItemDescription').value = '';
          document.getElementById('newItemLink').value = '';
        }

      // 현재 위치 가져오기 함수
      function getCurrentLocation() {
        const locationBtn = document.getElementById('locationBtn');
        const isLoading = locationBtn.classList.contains('loading');

        if (isLoading) {
          alert('현재 위치를 가져오는 중입니다.');
          return;
        }

        // 기존 마커가 있으면 먼저 제거
        if (currentLocationMarker) {
          currentLocationMarker.setMap(null);
          currentLocationMarker = null;
        }

        locationBtn.classList.add('loading');
        locationBtn.textContent = '로딩중...';

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              const currentLocation = { lat: lat, lng: lng };
              map.setCenter(currentLocation);
              map.setZoom(15); // 현재 위치에서 더 넓은 뷰

              // 새로운 현재 위치 마커 추가
              currentLocationMarker = new google.maps.Marker({
                position: currentLocation,
                map: map,
                icon: {
                  url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32">
                      <text x="12" y="20" font-family="Arial, sans-serif" font-size="24" text-anchor="middle" fill="#FF0000">📍</text>
                    </svg>
                  `),
                  scaledSize: new google.maps.Size(32, 32),
                  anchor: new google.maps.Point(16, 16)
                },
                title: '현재 위치',
                zIndex: 1000 // 다른 마커보다 위에 표시
              });

              // 현재 위치 마커 클릭 시 현재 위치로 이동
              currentLocationMarker.addListener('click', function() {
                map.setCenter(currentLocation);
                map.setZoom(15);
              });

              locationBtn.classList.remove('loading');
              locationBtn.textContent = '📍';
            },
            (error) => {
              console.error('위치 정보를 가져올 수 없습니다:', error.message);
              alert('위치 정보를 가져올 수 없습니다. 네트워크 연결을 확인해주세요.');
              locationBtn.classList.remove('loading');
              locationBtn.textContent = '📍';
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
          );
        } else {
          alert('이 브라우저는 위치 정보를 지원하지 않습니다.');
          locationBtn.classList.remove('loading');
          locationBtn.textContent = '📍';
        }
      }
      
      // 줌 레벨에 따라 항로와 마커 표시/숨김 처리
      function toggleFlightElements(zoomLevel) {
        if (zoomLevel < 10) {
          // 줌 레벨 10 미만: 항로와 마커들 표시
          if (flightPath) flightPath.setMap(map);
          if (dottedPath) dottedPath.setMap(map);
          if (planeMarker) planeMarker.setMap(map);
          if (incheonMarker) incheonMarker.setMap(map);
          if (chitoseMarker) chitoseMarker.setMap(map);
        } else {
          // 줌 레벨 10 이상: 항로와 마커들 숨김
          if (flightPath) flightPath.setMap(null);
          if (dottedPath) dottedPath.setMap(null);
          if (planeMarker) planeMarker.setMap(null);
          if (incheonMarker) incheonMarker.setMap(null);
          if (chitoseMarker) chitoseMarker.setMap(null);
        }
      }
      
      // 줌 레벨 업데이트 함수
      function updateZoomLevel() {
        if (map) {
          const zoomLevel = Math.round(map.getZoom());
          const zoomDisplay = document.getElementById('zoomLevelDisplay');
          if (zoomDisplay) {
            zoomDisplay.textContent = `줌 ${zoomLevel}`;
          }
        }
      }
      

      

      
              
        

      

      

      

      

      
      // 페이지 로드 시 모바일 최적화 적용
      document.addEventListener('DOMContentLoaded', function() {
        optimizeForMobile();
      });
      
      // 사용자 경로 모드 토글 함수
      function toggleRouteMode() {
        if (userRouteMarkers.length === 0) {
          // 첫 번째 클릭: 경로 생성 모드 시작
          isRouteMode = true;
          const routeBtn = document.getElementById('topRouteBtn');
          routeBtn.textContent = '경로 생성 중...';
          routeBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
          routeBtn.style.color = 'white';
          
          alert('지도를 클릭하여 경로의 첫 번째 위치를 추가하세요.\n여러 위치를 순서대로 클릭하면 자동으로 경로가 생성됩니다.');
        } else if (userRouteMarkers.length >= 2) {
          // 마커가 2개 이상일 때: 경로완성 모드
          const routeBtn = document.getElementById('topRouteBtn');
          routeBtn.textContent = '경로완성';
          routeBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          routeBtn.style.color = 'white';
          
          // 경로 저장 위치 선택 다이얼로그 표시
          showRouteSaveDialog();
        }
      }
      
      // 사용자 경로에 위치 추가 함수
      function addUserRoutePoint(latLng) {
        if (!isRouteMode) return;
        
        // 마커 생성
        const marker = new google.maps.Marker({
          position: latLng,
          map: map,
          title: `위치 ${userRouteMarkers.length + 1}`,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#ef4444',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2,
            scale: 8
          },
          label: {
            text: (userRouteMarkers.length + 1).toString(),
            fontSize: '12px',
            fontWeight: 'bold',
            color: '#ffffff'
          }
        });
        
        // 마커 클릭 시 제거 기능
        marker.addListener('click', function() {
          if (confirm('이 위치를 경로에서 제거하시겠습니까?')) {
            removeUserRoutePoint(marker);
          }
        });
        
        userRouteMarkers.push(marker);
        
        // 경로 업데이트
        updateUserRoute();
        
        // 마커가 2개 이상일 때 버튼을 "경로완성"으로 변경
        if (userRouteMarkers.length >= 2) {
          const routeBtn = document.getElementById('topRouteBtn');
          routeBtn.textContent = '경로완성';
          routeBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          routeBtn.style.color = 'white';
        }
        
        // 성공 메시지
        const message = userRouteMarkers.length === 1 ? 
          '첫 번째 위치가 추가되었습니다. 계속해서 다음 위치를 클릭하세요.' :
          `위치 ${userRouteMarkers.length}이 추가되었습니다.`;
        console.log(message);
      }
      
      // 사용자 경로에서 위치 제거 함수
      function removeUserRoutePoint(marker) {
        const index = userRouteMarkers.indexOf(marker);
        if (index > -1) {
          marker.setMap(null);
          userRouteMarkers.splice(index, 1);
          
          // 마커 번호 재정렬
          userRouteMarkers.forEach((m, i) => {
            m.setTitle(`위치 ${i + 1}`);
            m.setLabel({
              text: (i + 1).toString(),
              fontSize: '12px',
              fontWeight: 'bold',
              color: '#ffffff'
            });
          });
          
          // 경로 업데이트
          updateUserRoute();
          
          // 마커가 2개 미만일 때 버튼을 "경로 생성 중..."으로 변경
          if (userRouteMarkers.length < 2) {
            const routeBtn = document.getElementById('topRouteBtn');
            routeBtn.textContent = '경로 생성 중...';
            routeBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            routeBtn.style.color = 'white';
          }
        }
      }
      
      // 사용자 경로 업데이트 함수
      function updateUserRoute() {
        // 기존 경로 제거
        if (userRoutePath) {
          userRoutePath.setMap(null);
        }
        if (userRouteDottedPath) {
          userRouteDottedPath.setMap(null);
        }
        
        // 마커가 2개 이상일 때만 경로 생성
        if (userRouteMarkers.length >= 2) {
          const path = userRouteMarkers.map(marker => marker.getPosition());
          
          // 메인 경로 (파란색)
          userRoutePath = new google.maps.Polyline({
            path: path,
            geodesic: true,
            strokeColor: '#3b82f6',
            strokeOpacity: 0.8,
            strokeWeight: 4
          });
          userRoutePath.setMap(map);
          
          // 점선 효과 (흰색 점들)
          userRouteDottedPath = new google.maps.Polyline({
            path: path,
            geodesic: true,
            strokeColor: '#ffffff',
            strokeOpacity: 0.9,
            strokeWeight: 2,
            icons: [{
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: '#3b82f6',
                fillOpacity: 1,
                strokeColor: '#ffffff',
                strokeWeight: 1,
                scale: 6
              },
              offset: '0',
              repeat: '15px'
            }]
          });
          userRouteDottedPath.setMap(map);
          
          // 경로 정보 표시
          const totalDistance = calculateRouteDistance(path);
          console.log(`경로가 생성되었습니다. 총 거리: ${totalDistance.toFixed(1)}km`);
        }
      }
      
      // 경로 거리 계산 함수
      function calculateRouteDistance(path) {
        let totalDistance = 0;
        for (let i = 1; i < path.length; i++) {
          const prev = path[i - 1];
          const curr = path[i];
          totalDistance += google.maps.geometry.spherical.computeDistanceBetween(prev, curr);
        }
        return totalDistance / 1000; // km 단위로 변환
      }
      
      // 사용자 경로 초기화 함수
      function clearUserRoute() {
        if (!confirm('생성된 경로를 모두 초기화하시겠습니까?\n(저장된 경로도 함께 제거됩니다)')) {
          return;
        }
        
        // 모든 마커 제거
        userRouteMarkers.forEach(marker => {
          marker.setMap(null);
        });
        userRouteMarkers = [];
        
        // 경로 제거
        if (userRoutePath) {
          userRoutePath.setMap(null);
          userRoutePath = null;
        }
        if (userRouteDottedPath) {
          userRouteDottedPath.setMap(null);
          userRouteDottedPath = null;
        }
        
        // 저장된 모든 경로 제거
        savedUserRoutes.forEach(route => {
          if (route.pathElement) {
            route.pathElement.setMap(null);
          }
          if (route.dottedPathElement) {
            route.dottedPathElement.setMap(null);
          }
        });
        savedUserRoutes = [];
        localStorage.removeItem('savedUserRoutes');
        
        // 경로 모드 비활성화
        isRouteMode = false;
        const routeBtn = document.getElementById('topRouteBtn');
        const clearRouteBtn = document.getElementById('clearRouteBtn');
        
        routeBtn.textContent = '경로 생성';
        routeBtn.style.background = 'rgba(255, 255, 255, 0.12)';
        routeBtn.style.color = '#1a1a1a';
        clearRouteBtn.style.display = 'none';
        
        alert('모든 경로가 초기화되었습니다.');
      }
      
      // 경로 초기화 버튼 표시/숨김 함수
      function updateClearRouteButton() {
        const clearRouteBtn = document.getElementById('clearRouteBtn');
        if (clearRouteBtn) {
          clearRouteBtn.style.display = userRouteMarkers.length > 0 ? 'block' : 'none';
        }
      }
      
      // 경로 저장 위치 선택 다이얼로그 표시
      function showRouteSaveDialog() {
        // 기존 다이얼로그가 있으면 제거
        const existingDialog = document.getElementById('routeSaveDialog');
        if (existingDialog) {
          existingDialog.remove();
        }
        
        // 다이얼로그 생성
        const dialogDiv = document.createElement('div');
        dialogDiv.id = 'routeSaveDialog';
        dialogDiv.innerHTML = `
          <div class="info-header">
            <h3>경로 저장 위치 선택</h3>
            <button class="close-btn" onclick="closeRouteSaveDialog()">×</button>
          </div>
          <div class="info-content">
            <div class="info-section">
              <h4>어디에 경로를 저장하시겠습니까?</h4>
              <div class="route-save-options">
                <button class="route-save-btn" onclick="saveRouteToLocation('사전준비')">사전준비</button>
                <button class="route-save-btn" onclick="saveRouteToLocation('1일차')">1일차</button>
                <button class="route-save-btn" onclick="saveRouteToLocation('새로운 항목')">새로운 항목</button>
              </div>
            </div>
          </div>
        `;
        
        // 다이얼로그를 지도 위에 표시
        document.body.appendChild(dialogDiv);
        
        // 다이얼로그 위치 조정 - 모바일 최적화
        setTimeout(() => {
          const mapElement = document.getElementById('map');
          const mapRect = mapElement.getBoundingClientRect();
          
          if (isMobile) {
            // 모바일: 화면 중앙에 표시
            dialogDiv.style.left = '50%';
            dialogDiv.style.transform = 'translateX(-50%)';
            dialogDiv.style.top = '80px';
          } else {
            // 데스크톱: 지도 중앙에 표시
            dialogDiv.style.left = (mapRect.width / 2 - 200) + 'px';
            dialogDiv.style.top = (mapRect.height / 2 - 150) + 'px';
            dialogDiv.style.transform = 'none';
          }
        }, 100);
      }
      
      // 경로 저장 위치 선택 다이얼로그 닫기
      function closeRouteSaveDialog() {
        const dialog = document.getElementById('routeSaveDialog');
        if (dialog) {
          dialog.remove();
        }
      }
      
      // 선택된 위치에 경로 저장
      async function saveRouteToLocation(location) {
        if (userRouteMarkers.length < 2) {
          alert('경로를 생성하려면 최소 2개의 위치가 필요합니다.');
          return;
        }
        
        // 경로 데이터 생성
        const routeData = {
          id: 'route_' + Date.now(),
          name: `${location} 경로`,
          location: location,
          path: userRouteMarkers.map(marker => ({
            lat: marker.getPosition().lat(),
            lng: marker.getPosition().lng()
          })),
          distance: calculateRouteDistance(userRouteMarkers.map(marker => marker.getPosition())),
          createdAt: new Date().toISOString()
        };
        
        try {
          // Firebase에 저장
          await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
            savedUserRoutes: window.firestore.arrayUnion(routeData),
            lastUpdated: window.firestore.serverTimestamp()
          });
          
          // 전역 변수에 추가
          savedUserRoutes.push(routeData);
          
          // localStorage에도 백업 저장
          let savedRoutes = JSON.parse(localStorage.getItem('savedUserRoutes') || '[]');
          savedRoutes.push(routeData);
          localStorage.setItem('savedUserRoutes', JSON.stringify(savedRoutes));
          
          console.log('Firebase에 경로 저장 완료');
        } catch (error) {
          console.error('Firebase 저장 실패:', error);
          
          // Firebase 실패 시 localStorage에만 저장
          let savedRoutes = JSON.parse(localStorage.getItem('savedUserRoutes') || '[]');
          savedRoutes.push(routeData);
          localStorage.setItem('savedUserRoutes', JSON.stringify(savedRoutes));
          
          // 전역 변수에 추가
          savedUserRoutes.push(routeData);
          
          alert('Firebase 저장에 실패했습니다. 로컬에 백업되었습니다.');
        }
        
        // 임시 마커들 제거
        userRouteMarkers.forEach(marker => {
          marker.setMap(null);
        });
        userRouteMarkers = [];
        
        // 임시 경로 제거
        if (userRoutePath) {
          userRoutePath.setMap(null);
          userRoutePath = null;
        }
        if (userRouteDottedPath) {
          userRouteDottedPath.setMap(null);
          userRouteDottedPath = null;
        }
        
        // 경로 모드 비활성화
        isRouteMode = false;
        
        // 버튼 상태 복원
        const routeBtn = document.getElementById('topRouteBtn');
        routeBtn.textContent = '경로 생성';
        routeBtn.style.background = 'rgba(255, 255, 255, 0.12)';
        routeBtn.style.color = '#1a1a1a';
        
        // 다이얼로그 닫기
        closeRouteSaveDialog();
        
        // 성공 메시지
        alert(`경로가 "${location}"에 저장되었습니다!`);
        
        // 저장된 경로들 다시 그리기
        drawAllSavedRoutes();
      }
      
      // 저장된 모든 경로 그리기
      function drawAllSavedRoutes() {
        // 기존 경로들 제거
        savedUserRoutes.forEach(route => {
          if (route.pathElement) {
            route.pathElement.setMap(null);
          }
          if (route.dottedPathElement) {
            route.dottedPathElement.setMap(null);
          }
        });
        
        // 저장된 경로들 다시 그리기
        savedUserRoutes.forEach(route => {
          if (route.path && route.path.length >= 2) {
            const path = route.path.map(point => new google.maps.LatLng(point.lat, point.lng));
            
            // 메인 경로
            route.pathElement = new google.maps.Polyline({
              path: path,
              geodesic: true,
              strokeColor: '#3b82f6',
              strokeOpacity: 0.8,
              strokeWeight: 4
            });
            route.pathElement.setMap(map);
            
            // 점선 효과
            route.dottedPathElement = new google.maps.Polyline({
              path: path,
              geodesic: true,
              strokeColor: '#ffffff',
              strokeOpacity: 0.9,
              strokeWeight: 2,
              icons: [{
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  fillColor: '#3b82f6',
                  fillOpacity: 1,
                  strokeColor: '#ffffff',
                  strokeWeight: 1,
                  scale: 6
                },
                offset: '0',
                repeat: '15px'
              }]
            });
            route.dottedPathElement.setMap(map);
          }
        });
      }
      
             // 저장된 사용자 경로들 복원
       async function restoreSavedUserRoutes() {
         try {
           // Firebase에서 복원 시도
           const docSnap = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'));
           if (docSnap.exists()) {
             const data = docSnap.data();
             if (data.savedUserRoutes && data.savedUserRoutes.length > 0) {
               savedUserRoutes = data.savedUserRoutes;
               drawAllSavedRoutes();
               console.log('Firebase에서 경로 복원 완료');
               return;
             }
           }
         } catch (error) {
           console.error('Firebase 로드 실패:', error);
         }
         
         // Firebase 실패 시 localStorage에서 복원
         const savedRoutes = localStorage.getItem('savedUserRoutes');
         if (savedRoutes) {
           savedUserRoutes = JSON.parse(savedRoutes);
           drawAllSavedRoutes();
         }
       }
       
       // 1일차 경로만 제거하는 함수
       async function removeDay1Routes() {
         // 1일차 경로가 있는지 확인
         const day1Routes = savedUserRoutes.filter(route => route.location === '1일차');
         
         if (day1Routes.length === 0) {
           alert('1일차에 저장된 경로가 없습니다.');
           return;
         }
         
         // 사용자 확인
         if (!confirm(`1일차에 저장된 경로 ${day1Routes.length}개를 모두 제거하시겠습니까?`)) {
           return;
         }
         
         // 1일차 경로들만 제거
         day1Routes.forEach(route => {
           if (route.pathElement) {
             route.pathElement.setMap(null);
           }
           if (route.dottedPathElement) {
             route.dottedPathElement.setMap(null);
           }
         });
         
         // 배열에서 1일차 경로들 제거
         savedUserRoutes = savedUserRoutes.filter(route => route.location !== '1일차');
         
         try {
           // Firebase에서 1일차 경로들 제거
           await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
             savedUserRoutes: savedUserRoutes,
             lastUpdated: window.firestore.serverTimestamp()
           });
           
           // localStorage 업데이트
           localStorage.setItem('savedUserRoutes', JSON.stringify(savedUserRoutes));
           
           console.log('Firebase에서 1일차 경로 제거 완료');
         } catch (error) {
           console.error('Firebase 업데이트 실패:', error);
           
           // Firebase 실패 시 localStorage만 업데이트
           localStorage.setItem('savedUserRoutes', JSON.stringify(savedUserRoutes));
           alert('Firebase 업데이트에 실패했습니다. 로컬에만 반영되었습니다.');
         }
         
         // 성공 메시지
         alert(`1일차 경로 ${day1Routes.length}개가 제거되었습니다.`);
         
         // 정보창 닫기
         closePreparationInfo();
       }
       
       // 주소 검색 함수
       function searchAddress() {
         const address = document.getElementById('addressInput').value.trim();
         if (!address) {
           alert('주소를 입력하세요.');
           return;
         }
         if (!geocoder || !map) {
           alert('지도가 아직 준비되지 않았습니다.');
           return;
         }
         
         // 기존 마커 제거
         if (addressMarker) {
           addressMarker.setMap(null);
           addressMarker = null;
         }
         
         const boundsForQuery = map.getBounds ? map.getBounds() : null;
         geocoder.geocode({ address: address, bounds: boundsForQuery }, function(results, status) {
           if (status !== 'OK' || !results || !results.length) {
             alert('주소를 찾을 수 없습니다: ' + status);
             return;
           }

           // 현재 화면 범위 내 결과만 사용
           const boundsNow = map.getBounds ? map.getBounds() : null;
           const filtered = boundsNow ? results.filter(function(r) { return boundsNow.contains(r.geometry.location); }) : results;
           if (!filtered.length) {
             alert('현재 화면 범위 내에서 주소를 찾을 수 없습니다. 지도를 이동/확대 후 다시 시도하세요.');
             return;
           }

           // 결과가 여러 개면 사용자 선택 유도
           if (filtered.length > 1) {
             window.addressSearchCandidates = filtered;
             showAddressSelection(filtered, address);
             return;
           }

           const location = filtered[0].geometry.location;
           map.setCenter(location);
           map.setZoom(16);

           // 새로운 마커 생성 및 표시
           addressMarker = new google.maps.Marker({
             position: location,
             map: map,
             title: address,
             icon: {
               url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
               scaledSize: new google.maps.Size(32, 32)
             },
             animation: google.maps.Animation.DROP
           });

           // 마커 클릭 시 정보창 표시
           const infoWindow = new google.maps.InfoWindow({
             content: '<div style="padding: 10px;"><strong>' + address + '</strong></div>'
           });
           addressMarker.addListener('click', function() {
             infoWindow.open(map, addressMarker);
           });

           // 주소 입력창 초기화
           document.getElementById('addressInput').value = '';
         });
       }
       
       // 주소 마커 가시성 확인 및 자동 제거 함수
       function checkAddressMarkerVisibility() {
         if (addressMarker && map) {
           const bounds = map.getBounds();
           const markerPosition = addressMarker.getPosition();
           
           // 마커가 현재 지도 뷰의 경계 밖에 있는지 확인
           if (bounds && !bounds.contains(markerPosition)) {
             // 마커가 뷰에서 벗어나면 자동으로 제거
             addressMarker.setMap(null);
             addressMarker = null;
             document.getElementById('addressInput').value = '';
             console.log('주소 마커가 지도 뷰에서 벗어나 자동으로 제거되었습니다.');
           }
         }
       }
       
       // 주소 마커 제거 함수 (수동 제거용)
       function clearAddressMarker() {
         if (addressMarker) {
           addressMarker.setMap(null);
           addressMarker = null;
           document.getElementById('addressInput').value = '';
         }
       }

      function showAddressSelection(results, queryText) {
        // 기존 선택창 제거
        var existing = document.getElementById('addressSelectDialog');
        if (existing) existing.remove();

        var dialog = document.createElement('div');
        dialog.id = 'addressSelectDialog';
        dialog.style.position = 'absolute';
        dialog.style.zIndex = '15';
        dialog.style.width = '320px';
        dialog.style.maxWidth = '85vw';
        dialog.style.background = 'rgba(255, 255, 255, 0.95)';
        dialog.style.border = '1px solid rgba(0,0,0,0.1)';
        dialog.style.borderRadius = '12px';
        dialog.style.boxShadow = '0 12px 24px rgba(0,0,0,0.15)';
        dialog.style.overflow = 'hidden';

        dialog.innerHTML =
          '<div style="background:#1d4ed8;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;">' +
          '  <div style="font-weight:700;">주소 선택</div>' +
          '  <button style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;" onclick="closeAddressSelection()">×</button>' +
          '</div>' +
          '<div style="padding:12px 16px;max-height:50vh;overflow:auto;">' +
          '  <div style="margin-bottom:8px;color:#374151;font-size:0.9rem;">\'' + (queryText || '') + '\' 검색 결과가 여러 개입니다. 선택하세요.</div>' +
          '  <div id="addressSelectList"></div>' +
          '</div>';

        document.body.appendChild(dialog);

        // 위치 중앙 배치 - 모바일 최적화
        setTimeout(function () {
          var mapEl = document.getElementById('map');
          var rect = mapEl.getBoundingClientRect();
          
          if (isMobile) {
            // 모바일: 화면 중앙에 표시
            dialog.style.left = '50%';
            dialog.style.transform = 'translateX(-50%)';
            dialog.style.top = '80px';
          } else {
            // 데스크톱: 지도 중앙에 표시
            dialog.style.left = (rect.width / 2 - 160) + 'px';
            dialog.style.top = (rect.height / 2 - 160) + 'px';
            dialog.style.transform = 'none';
          }
        }, 50);

        // 리스트 렌더링
        var list = dialog.querySelector('#addressSelectList');
        var html = '';
        results.forEach(function(r, idx) {
          var addr = (r.formatted_address || r.name || '결과 ' + (idx + 1));
          html += '<button style="width:100%;text-align:left;margin:6px 0;padding:10px 12px;border:1px solid rgba(0,0,0,0.1);border-radius:8px;background:#fff;cursor:pointer;" onclick="chooseAddressResult(' + idx + ')">' +
                  '<div style="font-weight:600;color:#111827;">' + addr + '</div>' +
                  '</button>';
        });
        list.innerHTML = html;
      }

      function closeAddressSelection() {
        var dialog = document.getElementById('addressSelectDialog');
        if (dialog) dialog.remove();
      }

      function chooseAddressResult(index) {
        try {
          var candidates = window.addressSearchCandidates || [];
          if (!candidates.length || !candidates[index]) {
            closeAddressSelection();
            alert('선택할 수 있는 주소가 없습니다.');
            return;
          }
          var result = candidates[index];
          var location = result.geometry.location;

          // 기존 마커 제거
          if (addressMarker) {
            addressMarker.setMap(null);
            addressMarker = null;
          }

          map.setCenter(location);
          map.setZoom(16);

          addressMarker = new google.maps.Marker({
            position: location,
            map: map,
            title: result.formatted_address || '',
            icon: {
              url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
              scaledSize: new google.maps.Size(32, 32)
            },
            animation: google.maps.Animation.DROP
          });

          var infoWindow = new google.maps.InfoWindow({
            content: '<div style="padding:10px;"><strong>' + (result.formatted_address || '') + '</strong></div>'
          });
          addressMarker.addListener('click', function() {
            infoWindow.open(map, addressMarker);
          });

          document.getElementById('addressInput').value = '';
        } finally {
          closeAddressSelection();
          window.addressSearchCandidates = [];
        }
      }

      // 스와이프 삭제 기능 초기화
      function initializeSwipeDelete() {
        const userItems = document.querySelectorAll('.user-added-item');
        
        userItems.forEach(item => {
          let startX = 0;
          let currentX = 0;
          let isSwiping = false;
          let hasSwiped = false;
          
          // 터치 시작
          item.addEventListener('touchstart', function(e) {
            startX = e.touches[0].clientX;
            isSwiping = true;
            hasSwiped = false;
            this.classList.add('swiping');
          }, { passive: true });
          
          // 터치 이동
          item.addEventListener('touchmove', function(e) {
            if (!isSwiping) return;
            
            currentX = e.touches[0].clientX;
            const diffX = startX - currentX;
            
            // 오른쪽에서 왼쪽으로 스와이프 (최소 50px)
            if (diffX > 50) {
              const translateX = Math.min(diffX, 80);
              this.querySelector('.item-content').style.transform = `translateX(-${translateX}px)`;
              hasSwiped = true;
            }
          }, { passive: true });
          
          // 터치 종료
          item.addEventListener('touchend', function(e) {
            if (!isSwiping) return;
            
            isSwiping = false;
            this.classList.remove('swiping');
            
            if (hasSwiped && (startX - currentX) > 50) {
              // 스와이프 완료 - 삭제 버튼 표시
              this.classList.add('swiped');
            } else {
              // 스와이프 취소 - 원래 위치로 복원
              this.classList.remove('swiped');
              this.querySelector('.item-content').style.transform = 'translateX(0)';
            }
          }, { passive: true });
          
          // 클릭 시 스와이프 상태 해제
          item.addEventListener('click', function(e) {
            // 삭제 버튼 클릭이 아닌 경우에만 스와이프 해제
            if (!e.target.classList.contains('swipe-delete-btn') && 
                !e.target.classList.contains('delete-btn') &&
                !e.target.classList.contains('prep-checkbox')) {
              this.classList.remove('swiped');
              this.querySelector('.item-content').style.transform = 'translateX(0)';
            }
          });
          
          // 마우스 이벤트 (데스크톱 지원)
          item.addEventListener('mousedown', function(e) {
            if (e.button !== 0) return; // 왼쪽 버튼만
            
            startX = e.clientX;
            isSwiping = true;
            hasSwiped = false;
            this.classList.add('swiping');
            
            const handleMouseMove = (e) => {
              if (!isSwiping) return;
              
              currentX = e.clientX;
              const diffX = startX - currentX;
              
              if (diffX > 50) {
                const translateX = Math.min(diffX, 80);
                this.querySelector('.item-content').style.transform = `translateX(-${translateX}px)`;
                hasSwiped = true;
              }
            };
            
            const handleMouseUp = () => {
              if (!isSwiping) return;
              
              isSwiping = false;
              this.classList.remove('swiping');
              
              if (hasSwiped && (startX - currentX) > 50) {
                this.classList.add('swiped');
              } else {
                this.classList.remove('swiped');
                this.querySelector('.item-content').style.transform = 'translateX(0)';
              }
              
              document.removeEventListener('mousemove', handleMouseMove);
              document.removeEventListener('mouseup', handleMouseUp);
            };
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
          });
        });
      }
      
      // Firebase 실시간 동기화 설정
      function setupFirebaseSync() {
        try {
          window.firestore.onSnapshot(window.firestore.doc(window.db, 'users', 'currentUser'), (doc) => {
            if (doc.exists()) {
              const data = doc.data();
              
              // 체크박스 상태 동기화
              if (data.preparationCheckboxes) {
                Object.keys(data.preparationCheckboxes).forEach(id => {
                  const checkbox = document.getElementById(id);
                  if (checkbox && checkbox.checked !== data.preparationCheckboxes[id]) {
                    checkbox.checked = data.preparationCheckboxes[id];
                  }
                });
              }
              
              // 사용자 추가 항목 동기화
              if (data.userAddedItems) {
                displayUserAddedItemsFromFirebase(data.userAddedItems);
              }
              
              // 경로 동기화 추가
              if (data.savedUserRoutes) {
                // 기존 경로들과 비교하여 변경사항이 있을 때만 업데이트
                const currentRouteIds = savedUserRoutes.map(route => route.id).sort();
                const newRouteIds = data.savedUserRoutes.map(route => route.id).sort();
                
                if (JSON.stringify(currentRouteIds) !== JSON.stringify(newRouteIds)) {
                  savedUserRoutes = data.savedUserRoutes;
                  drawAllSavedRoutes();
                  console.log('Firebase에서 경로 동기화 완료');
                }
              }
            }
          }, (error) => {
            console.error('Firebase 실시간 동기화 오류:', error);
          });
          
          console.log('Firebase 실시간 동기화 설정 완료');
        } catch (error) {
          console.error('Firebase 동기화 설정 실패:', error);
        }
      }
      
      // Firebase에서 사용자 추가 항목 표시
      function displayUserAddedItemsFromFirebase(userItems) {
        const container = document.getElementById('userAddedItems');
        if (!container) return;
        
        if (userItems.length === 0) {
          container.innerHTML = '';
          return;
        }
        
        let html = '';
        userItems.forEach(item => {
          const titleElement = item.link 
            ? `<span onclick="openUserItemLink('${item.link}')" style="cursor: pointer; color: #1d4ed8; text-decoration: underline;"><strong>${item.title}</strong></span>`
            : `<strong>${item.title}</strong>`;
          
          html += `
            <div class="user-added-item" data-item-id="${item.id}">
              <div class="item-content">
                <input type="checkbox" id="${item.id}" class="prep-checkbox" onchange="saveCheckboxStates()" ${item.checked ? 'checked' : ''}>
                <span>${titleElement} - ${item.description}</span>
                <button class="delete-btn" onclick="deleteUserItem('${item.id}')" title="삭제">×</button>
              </div>
              <button class="swipe-delete-btn" onclick="deleteUserItem('${item.id}')" title="삭제">삭제</button>
            </div>
          `;
        });
        
        container.innerHTML = html;
        
        // 스와이프 삭제 기능 초기화
        initializeSwipeDelete();
      }
    </script>

         <!-- Firebase SDK 스크립트 -->
     <script type="module">
       // Import the functions you need from the SDKs you need
       import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
       import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
       import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
       // TODO: Add SDKs for Firebase products that you want to use
       // https://firebase.google.com/docs/web/setup#available-libraries

       // Your web app's Firebase configuration
       // For Firebase JS SDK v7.20.0 and later, measurementId is optional
       const firebaseConfig = {
         apiKey: "AIzaSyBhndv9tfh_Uu8Nkm7AZxjRCNIgvnGEj_c",
         authDomain: "travelplan250826.firebaseapp.com",
         projectId: "travelplan250826",
         storageBucket: "travelplan250826.firebasestorage.app",
         messagingSenderId: "918345537744",
         appId: "1:918345537744:web:08d0daace8cb0ec021e6d5",
         measurementId: "G-18R59NTNBT"
       };

       // Initialize Firebase
       const app = initializeApp(firebaseConfig);
       const analytics = getAnalytics(app);
       
       // Initialize Firestore
       const db = getFirestore(app);
       
       console.log('Firebase Firestore 연결 완료!');
       
       // 전역 변수로 db를 사용할 수 있도록 설정
       window.db = db;
       window.firestore = {
         collection,
         doc,
         setDoc,
         getDoc,
         updateDoc,
         arrayUnion,
         onSnapshot,
         serverTimestamp
       };
     </script>
    
    <!-- 구글 맵 API 스크립트. API 키와 콜백 함수(initMap) 지정 -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDVwJrvIcbqAOX24g9JODhD7DGtTz7z2Pg&libraries=geometry&callback=initMap" async defer></script>
</body>
</html>

