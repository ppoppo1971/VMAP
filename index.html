<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1d4ed8">
    <title>í™‹ì¹´ì´ë„ ì—¬í–‰</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }
        #map {
            width: 100vw;
            height: 100vh;
            min-height: 100%;
            touch-action: manipulation;
        }
        h1 {
            display: none;
        }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ - ëª¨ë°”ì¼ ìµœì í™” */
        #customMapMenu {
            position: absolute;
            top: 20px;
            left: 15px;
            z-index: 10;
            width: 200px;
            max-width: 85vw;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.05);
            padding: 15px 12px 12px 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: all 0.3s ease;
        }
        #customMapMenu.hide {
            left: -220px;
            opacity: 0;
            pointer-events: none;
        }
        #customMapMenu h2 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0 0 10px 0;
            color: #1a1a1a;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        .menu-group {
            margin-bottom: 4px;
        }
        .menu-group label {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 5px;
            display: block;
            color: #1a1a1a;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ - í„°ì¹˜ ì¹œí™”ì  */
        .menu-group button, .toggle-btn {
            width: 100%;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 8px;
            margin-bottom: 4px;
            font-size: 0.9rem;
            color: #1a1a1a;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        .menu-group button:hover, .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.5);
            color: #000;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .menu-group button:active, .toggle-btn:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.98);
        }
        .menu-group .submenu {
            margin-left: 10px;
            margin-top: 3px;
        }
        
        /* ì‚¬ì´ë“œ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ - ëª¨ë°”ì¼ ìµœì í™” */
        #menuToggleBtn {
            position: absolute;
            top: 20px;
            left: 15px;
            z-index: 20;
            background: #1d4ed8;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }
        #menuToggleBtn.show {
            display: flex;
        }
        #menuToggleBtn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .toggle-btn {
            text-align: left;
            font-weight: 600;
        }
        
        /* í•˜ìœ„ ì˜µì…˜ ë“¤ì—¬ì“°ê¸° */
        .submenu {
            margin-left: 15px;
        }
        .submenu .submenu {
            margin-left: 15px;
        }
        .submenu button {
            width: 90%;
            margin-left: 0;
        }
        
        /* êµ¬ê¸€ë§µ í•˜ìœ„ ì˜µì…˜ ë“¤ì—¬ì“°ê¸° */
        #googleMapMenu > .toggle-btn {
            margin-left: 15px;
        }
        
        /* ì˜¤ë¥¸ìª½ ìƒë‹¨ ì§€ë„ íƒ€ì… ì„ íƒ ë²„íŠ¼ - ëª¨ë°”ì¼ ìµœì í™” */
        #mapTypeSelector {
            position: absolute;
            top: 20px;
            right: 15px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 6px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.05);
        }
        
        #mapTypeSelector.hide {
            right: -180px;
            opacity: 0;
            pointer-events: none;
        }
        

        
        /* GPS ìœ„ì¹˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #locationBtn {
            position: absolute;
            bottom: 70px;
            right: 10px;
            z-index: 10;
            background: transparent;
            color: #333;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }
        
        #locationBtn:hover {
            background: rgba(51, 51, 51, 0.1);
            transform: scale(1.05);
        }
        
        #locationBtn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        #locationBtn.loading {
            background: #6b7280;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* ì˜¤ë¥¸ìª½ ìƒë‹¨ í† ê¸€ ë²„íŠ¼ - ëª¨ë°”ì¼ ìµœì í™” */
        #rightMenuToggleBtn {
            position: absolute;
            top: 20px;
            right: 15px;
            z-index: 20;
            background: #1d4ed8;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }
        #rightMenuToggleBtn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .map-type-btn {
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #1a1a1a;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .map-type-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.35);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        
        .map-type-btn:active {
            transform: scale(0.98);
        }
        
        .map-type-btn.active {
            background: #1d4ed8;
            color: white;
            border-color: #1d4ed8;
        }
        
        .map-type-btn.sub-option {
            margin-left: 15px;
            font-size: 0.8rem;
            padding: 10px 12px;
        }
        
        /* ëª¨ë°”ì¼ ìµœì í™”ë¥¼ ìœ„í•œ ë¯¸ë””ì–´ ì¿¼ë¦¬ */
        @media (max-width: 768px) {
            #customMapMenu {
                width: 180px;
                max-width: 80vw;
                top: 15px;
                left: 10px;
                padding: 12px 10px 10px 10px;
            }
            
            #customMapMenu.hide {
                left: -200px;
            }
            
            #menuToggleBtn, #rightMenuToggleBtn {
                width: 44px;
                height: 44px;
                font-size: 1.3rem;
                top: 15px;
            }
            
            #menuToggleBtn {
                left: 10px;
            }
            
            #rightMenuToggleBtn {
                right: 10px;
            }
            
            #mapTypeSelector {
                top: 15px;
                right: 10px;
            }
            
            .map-type-btn {
                padding: 10px 14px;
                font-size: 0.85rem;
                min-height: 40px;
            }
            
            .toggle-btn {
                padding: 10px 8px;
                min-height: 40px;
                font-size: 0.85rem;
            }
            
            #locationBtn {
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
                bottom: 85px;
                right: 15px;
            }
            
            #zoomLevelDisplay {
                bottom: 15px;
                left: 15px;
                padding: 6px 10px;
                font-size: 0.85rem;
                min-width: 55px;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ ìµœì í™” */
            .menu-group button, .toggle-btn, .map-type-btn {
                min-height: 48px; /* iOS ê¶Œì¥ ìµœì†Œ í„°ì¹˜ ì˜ì—­ */
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ ìµœì í™” */
            .info-content {
                max-height: 60vh;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media (max-width: 480px) {
            #customMapMenu {
                width: 160px;
                max-width: 75vw;
                top: 10px;
                left: 8px;
                padding: 10px 8px 8px 8px;
            }
            
            #customMapMenu.hide {
                left: -180px;
            }
            
            #menuToggleBtn, #rightMenuToggleBtn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
                top: 10px;
            }
            
            #menuToggleBtn {
                left: 8px;
            }
            
            #rightMenuToggleBtn {
                right: 8px;
            }
            
            #mapTypeSelector {
                top: 10px;
                right: 8px;
            }
            
            .map-type-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
                min-height: 36px;
            }
            
            .toggle-btn {
                padding: 8px 6px;
                min-height: 36px;
                font-size: 0.8rem;
            }
            
            #locationBtn {
                width: 37px;
                height: 37px;
                font-size: 1rem;
                bottom: 60px;
                right: 22px;
            }
            
            #zoomLevelDisplay {
                bottom: 10px;
                left: 12px;
                padding: 5px 8px;
                font-size: 0.8rem;
                min-width: 50px;
            }
            
            /* ì‘ì€ í™”ë©´ì—ì„œ ì •ë³´ì°½ ìµœì í™” */
            #preparationInfo, #routeSaveDialog, #markerSaveDialog {
                width: 95vw;
                max-width: 95vw;
                left: 2.5vw !important;
                transform: none !important;
            }
            

            
            .user-added-item .swipe-delete-btn {
                min-height: 52px;
                min-width: 80px;
                font-size: 1.1rem;
                padding: 14px 24px;
            }
        }
        
        /* í„°ì¹˜ ìµœì í™”ë¥¼ ìœ„í•œ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
        ::-webkit-scrollbar {
            display: none;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ë”ë¸”íƒ­ ì¤Œ ë°©ì§€ ë° í•œ ì†ê°€ë½ ë“œë˜ê·¸ ìµœì í™” */
        #map {
            touch-action: manipulation;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-overflow-scrolling: touch;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ í„°ì¹˜ ìµœì í™” */
        button, .toggle-btn, .map-type-btn {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            cursor: pointer;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ì…ë ¥ í•„ë“œ ìµœì í™” */
        input[type="text"], input[type="url"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 6px;
            font-size: 16px; /* iOSì—ì„œ ì¤Œ ë°©ì§€ */
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ì²´í¬ë°•ìŠ¤ ìµœì í™” */
        input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #1d4ed8;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            position: relative;
        }
        
        input[type="checkbox"]:checked {
            background: #1d4ed8;
        }
        
        input[type="checkbox"]:checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ì¶”ê°€ ì„±ëŠ¥ ìµœì í™” */
        @media (max-width: 768px) {
            /* ëª¨ë°”ì¼ì—ì„œ í•˜ë“œì›¨ì–´ ê°€ì† í™œì„±í™” */
            #map, .info-content, .user-added-item {
                -webkit-transform: translateZ(0);
                -moz-transform: translateZ(0);
                -ms-transform: translateZ(0);
                transform: translateZ(0);
                will-change: transform;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ í”¼ë“œë°± ìµœì í™” */
            button:active, .toggle-btn:active, .map-type-btn:active {
                -webkit-transform: scale(0.95) translateZ(0);
                transform: scale(0.95) translateZ(0);
                transition: transform 0.1s ease;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ ì„±ëŠ¥ í–¥ìƒ */
            .info-content::-webkit-scrollbar {
                width: 4px;
            }
            
            .info-content::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.1);
                border-radius: 2px;
            }
            
            .info-content::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.3);
                border-radius: 2px;
            }
            

            
            .user-added-item .swipe-delete-btn {
                min-height: 48px;
                min-width: 70px;
                font-size: 1rem;
                padding: 12px 20px;
            }
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ì•ˆì „ ì˜ì—­ ì§€ì› */
        @supports (padding: max(0px)) {
            @media (max-width: 768px) {
                #customMapMenu {
                    padding-top: max(15px, env(safe-area-inset-top));
                    padding-left: max(10px, env(safe-area-inset-left));
                }
                
                #menuToggleBtn, #rightMenuToggleBtn {
                    top: max(15px, env(safe-area-inset-top));
                }
                
                #menuToggleBtn {
                    left: max(10px, env(safe-area-inset-left));
                }
                
                #rightMenuToggleBtn {
                    right: max(10px, env(safe-area-inset-right));
                }
            }
        }
        
        /* í•­ê³µê¶Œ ë§ˆì»¤ ìƒ‰ìƒ í•„í„° - ì§™ì€ íŒŒë€ìƒ‰ */
        .gm-style img[src*="%ED%95%AD%EA%B3%B5%EA%B6%8C.png"] {
            filter: hue-rotate(150deg) saturate(150%) brightness(0.8) contrast(120%);
        }
        
        /* ì¤Œ ë ˆë²¨ í‘œì‹œê¸° ìŠ¤íƒ€ì¼ */
        #zoomLevelDisplay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            min-width: 60px;
            text-align: center;
        }
        
        #zoomLevelDisplay:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.05);
        }
        
        /* ì‚¬ì „ì¤€ë¹„ ì •ë³´ì°½ ìŠ¤íƒ€ì¼ */
        #preparationInfo {
            position: absolute;
            z-index: 15;
            width: 400px;
            max-width: 90vw;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .info-header {
            background: linear-gradient(135deg, #1d4ed8, #3b82f6);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .info-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .info-content {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .info-section {
            margin-bottom: 12px;
        }
        
        .info-section:last-child {
            margin-bottom: 0;
        }
        
        .info-section h4 {
            margin: 0 0 6px 0;
            font-size: 0.77rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .info-section p {
            margin: 4px 0;
            font-size: 0.665rem;
            color: #374151;
            line-height: 1.5;
        }
        
        .info-section ul {
            margin: 4px 0;
            padding-left: 20px;
        }
        
        .info-section li {
            margin: 3px 0;
            font-size: 0.665rem;
            color: #374151;
            line-height: 1.5;
        }
        
        .ticket-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
            width: 100%;
        }
        
        .ticket-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .ticket-btn:active {
            transform: translateY(0);
        }
        
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            #preparationInfo {
                width: 350px;
                left: 50% !important;
                transform: translateX(-50%) !important;
                top: 80px !important;
                max-width: 90vw;
                margin: 0 auto;
            }
            
            #routeSaveDialog, #markerSaveDialog {
                width: 350px;
                left: 50% !important;
                transform: translateX(-50%) !important;
                top: 80px !important;
                max-width: 90vw;
                margin: 0 auto;
            }
        }
        
        @media (max-width: 480px) {
            #preparationInfo {
                width: 320px;
                top: 70px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                max-width: 95vw;
            }
            
            #routeSaveDialog, #markerSaveDialog {
                width: 320px;
                top: 70px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                max-width: 95vw;
            }
            
            .info-content {
                padding: 16px;
            }
            
            .info-header {
                padding: 14px 16px;
            }
        }
        
        /* ì²´í¬ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .checklist-item {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
            padding: 4px 0;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            position: relative; /* ìŠ¤ì™€ì´í”„ ë²„íŠ¼ ìœ„ì¹˜ë¥¼ ìœ„í•´ ì¶”ê°€ */
        }
        
        .checklist-item:hover {
            background-color: rgba(29, 78, 216, 0.05);
        }
        
        .prep-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            accent-color: #1d4ed8;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .prep-checkbox:checked {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }
        
        .checklist-item label {
            cursor: default;
            user-select: none;
            flex: 1;
            line-height: 1.4;
            font-size: 0.665rem;
        }
        
        .checklist-item:last-child {
            margin-bottom: 0;
        }
        
        /* ê¸°ì¡´ í•­ëª©ì˜ item-content ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .checklist-item .item-content {
            display: flex;
            align-items: center;
            width: 100%;
            transition: transform 0.3s ease;
            flex: 1;
        }
        
        /* ì‚¬ìš©ì ì¶”ê°€ í•­ëª© í¼ ìŠ¤íƒ€ì¼ */
        .add-item-form {
            margin-top: 20px;
            padding: 16px;
            background: rgba(29, 78, 216, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(29, 78, 216, 0.1);
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 6px;
        }
        
        .form-group input {
            padding: 5px 12px;
            border: 1px solid rgba(29, 78, 216, 0.2);
            border-radius: 8px;
            font-size: 0.63rem;
            font-family: inherit;
            background: white;
            transition: border-color 0.2s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #1d4ed8;
            box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.1);
        }
        
        .form-buttons {
            display: flex;
            gap: 8px;
        }
        
                 .add-btn {
             width: 100%;
             padding: 5px 16px;
             border: none;
             border-radius: 8px;
             font-size: 0.63rem;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.2s ease;
             background: linear-gradient(135deg, #10b981, #059669);
             color: white;
         }
         
         .add-btn:hover {
             transform: translateY(-1px);
             box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
         }
         
                 .add-btn:active {
            transform: translateY(0);
        }
        
        /* ìˆ˜ì • í¼ ìŠ¤íƒ€ì¼ */
        .edit-item-form {
            position: fixed;
            z-index: 20;
            width: 400px;
            max-width: 90vw;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }
        
        .edit-form-header {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .edit-form-header h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .edit-form-header .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .edit-form-header .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .edit-item-form .form-group {
            padding: 20px;
            margin: 0;
        }
        
        .edit-item-form .form-buttons {
            padding: 0 20px 20px 20px;
            gap: 12px;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }
        
        .save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }
        
        .cancel-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }
        
        /* ì‚¬ìš©ì ì¶”ê°€ í•­ëª© ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ì²´í¬ë¦¬ìŠ¤íŠ¸ì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼) */
        .user-added-item {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
            padding: 4px 0;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
        }
        
        .user-added-item:hover {
            background-color: rgba(29, 78, 216, 0.05);
        }
        
        /* ìŠ¤ì™€ì´í”„ ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ */
        .user-added-item .swipe-edit-btn,
        .checklist-item .swipe-edit-btn {
            position: absolute;
            right: -160px;
            top: 50%;
            transform: translateY(-50%);
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px;
            min-width: 60px;
        }
        
        .user-added-item .swipe-edit-btn:hover,
        .checklist-item .swipe-edit-btn:hover {
            background: #2563eb;
        }
        
        .user-added-item .swipe-edit-btn:active,
        .checklist-item .swipe-edit-btn:active {
            background: #2563eb;
            transform: translateY(-50%) scale(0.95);
        }
        
        .user-added-item .swipe-delete-btn,
        .checklist-item .swipe-delete-btn {
            position: absolute;
            right: -80px;
            top: 50%;
            transform: translateY(-50%);
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px;
            min-width: 60px;
        }
        
        .user-added-item .swipe-delete-btn:hover,
        .checklist-item .swipe-delete-btn:hover {
            background: #dc2626;
        }
        
        .user-added-item .swipe-delete-btn:active,
        .checklist-item .swipe-delete-btn:active {
            background: #dc2626;
            transform: translateY(-50%) scale(0.95);
        }
        
        .user-added-item .item-content {
            display: flex;
            align-items: center;
            width: 100%;
            transition: transform 0.3s ease;
            font-size: inherit;
            flex: 1;
        }
        
        .user-added-item.swiped .item-content,
        .checklist-item.swiped .item-content {
            transform: translateX(-160px);
        }
        
        .user-added-item.swiped .swipe-edit-btn,
        .checklist-item.swiped .swipe-edit-btn {
            right: 88px;
        }
        
        .user-added-item.swiped .swipe-delete-btn,
        .checklist-item.swiped .swipe-delete-btn {
            right: 8px;
        }
        
        /* ìŠ¤ì™€ì´í”„ ì• ë‹ˆë©”ì´ì…˜ */
        .user-added-item.swiping .item-content,
        .checklist-item.swiping .item-content {
            transition: transform 0.1s ease;
        }
        
        /* ìƒˆ í•­ëª© ì¶”ê°€ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .add-item-section {
            margin-top: 10px;
            text-align: center;
        }
        
        .toggle-add-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 6px 20px;
            font-size: 0.665rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .toggle-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .toggle-add-btn:active {
            transform: translateY(0);
        }
        
        .toggle-add-btn.expanded {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            margin-bottom: 8px;
        }
        
        /* ê²½ë¡œ ì €ì¥ ë‹¤ì´ì–¼ë¡œê·¸ ìŠ¤íƒ€ì¼ */
        #routeSaveDialog, #markerSaveDialog {
            position: absolute;
            z-index: 15;
            width: 400px;
            max-width: 90vw;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }
        
        .route-save-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }
        
        .route-save-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }
        
        .route-save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .route-save-btn:active {
            transform: translateY(0);
        }
        
        /* ê²½ë¡œì œê±° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .route-remove-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }
        
        .route-remove-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .route-remove-btn:active {
            transform: translateY(0);
        }
        
        /* ê²½ë¡œ/ë§ˆì»¤ ì œê±° ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        #preparationRemoveButtons .route-remove-btn,
        #day1RemoveButtons .route-remove-btn {
            width: auto;
            flex: 1;
            min-width: 0;
            padding: 10px 12px;
            font-size: 0.9rem;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ í¬ê¸° ìµœì í™” */
        @media (max-width: 768px) {
            #preparationRemoveButtons .route-remove-btn,
            #day1RemoveButtons .route-remove-btn {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
        }

    </style>
</head>
<body>
    <h1>í™‹ì¹´ì´ë„ ì—¬í–‰</h1>
    <!-- ì§€ë„ë¥¼ í‘œì‹œí•  div ìš”ì†Œ -->
    <div id="map"></div>
    <!-- ì‚¬ì´ë“œ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ (íŒ¨ë„ì´ ìˆ¨ê²¨ì¡Œì„ ë•Œë§Œ ë³´ì„) -->
    <button id="menuToggleBtn" class="show" onclick="showMenu()" title="ë©”ë‰´ ì—´ê¸°">â˜°</button>
    
    <!-- ì˜¤ë¥¸ìª½ ìƒë‹¨ í† ê¸€ ë²„íŠ¼ -->
    <button id="rightMenuToggleBtn" onclick="toggleRightMenu()" title="ì§€ë„ íƒ€ì… ë©”ë‰´ ì—´ê¸°">&lt;</button>
    
    <!-- ì˜¤ë¥¸ìª½ ìƒë‹¨ ì§€ë„ íƒ€ì… ì„ íƒ ë²„íŠ¼ -->
    <div id="mapTypeSelector" class="hide">
        <button class="map-type-btn" onclick="toggleMarkerMode()" id="topMarkerBtn">ë§ˆì»¤ìƒì„±</button>
        <button class="map-type-btn" onclick="toggleRouteMode()" id="topRouteBtn">ê²½ë¡œìƒì„±</button>
        <button class="map-type-btn" onclick="setMapTypeFromTop('roadmap')" id="topRoadmapBtn">ì¼ë°˜</button>
        <button class="map-type-btn" onclick="setMapTypeFromTop('satellite')" id="topSatelliteBtn">ìœ„ì„±</button>
        <button class="map-type-btn sub-option" onclick="toggleHybridLabel()" id="topHybridBtn">ë¼ë²¨</button>
    </div>
    
    <!-- GPS ìœ„ì¹˜ ë²„íŠ¼ -->
    <button id="locationBtn" onclick="getCurrentLocation()" title="í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™">ğŸ“</button>
    
    <!-- ì¤Œ ë ˆë²¨ í‘œì‹œê¸° -->
    <div id="zoomLevelDisplay" title="í˜„ì¬ í™•ëŒ€/ì¶•ì†Œ ë ˆë²¨">ì¤Œ 5</div>
    
    <!-- ì™¼ìª½ ê³ ì •í˜• ì‚¬ì´ë“œë°” ë©”ë‰´ -->
    <div id="customMapMenu" class="hide">
      <h2>í™‹ì¹´ì´ë„ ì—¬í–‰</h2>
      <div class="menu-group">
        <input type="text" id="addressInput" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width: 90%; margin-bottom: 4px; padding: 8px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #1a1a1a; font-size: 0.9rem;" onkeydown="if(event.key==='Enter'){searchAddress();}">
      </div>
      <div class="menu-group">
        <button id="preparationBtn" class="toggle-btn" onclick="showPreparationInfo()">ì‚¬ì „ì¤€ë¹„</button>
        <button id="day1Btn" class="toggle-btn" onclick="showDay1Info()">1ì¼ì°¨</button>
      </div>
      <div class="menu-group">
        <button id="clearRouteBtn" class="toggle-btn" onclick="clearUserRoute()" style="display: none;">ê²½ë¡œ ì´ˆê¸°í™”</button>
      </div>
    </div>
    

    
    <script>
      // ì „ì—­ ë³€ìˆ˜ë“¤
      let map;
      let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      let currentLocationMarker = null; // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì „ì—­ ë³€ìˆ˜
      let geocoder = null; // ì£¼ì†Œ ë³€í™˜ìš© Geocoder
      let addressMarker = null; // ì£¼ì†Œ ê²€ìƒ‰ ë§ˆì»¤
      let currentInfoWindow = null; // í˜„ì¬ ì—´ë¦° ì •ë³´ì°½
      let addressSearchCandidates = []; // ì£¼ì†Œ ê²€ìƒ‰ í›„ë³´ë“¤
      
      // í•­ë¡œì™€ ë§ˆì»¤ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ë“¤
      let flightPath = null;
      let dottedPath = null;
      let planeMarker = null;
      let incheonMarker = null;
      let chitoseMarker = null;
      
      // ì‚¬ìš©ì ê²½ë¡œ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ë“¤
      let userRouteMarkers = []; // ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ìœ„ì¹˜ ë§ˆì»¤ë“¤ (ì„ì‹œ)
      let userRoutePath = null; // ì‚¬ìš©ì ê²½ë¡œ í´ë¦¬ë¼ì¸
      let userRouteDottedPath = null; // ì‚¬ìš©ì ê²½ë¡œ ì ì„  íš¨ê³¼
      let isRouteMode = false; // ê²½ë¡œ ìƒì„± ëª¨ë“œ
      
      // ë§ˆì»¤ìƒì„± ëª¨ë“œ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ë“¤
      let isMarkerMode = false; // ë§ˆì»¤ìƒì„± ëª¨ë“œ
      let customMarkers = []; // ì‚¬ìš©ìê°€ ìƒì„±í•œ ë§ˆì»¤ë“¤
      
      // ì €ì¥ëœ ì‚¬ìš©ì ê²½ë¡œë“¤
      let savedUserRoutes = []; // Firestoreê°€ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤. ë¡œì»¬ ë°±ì—… ì œê±°
      

      
      // DOM ìºì‹œ
      let cachedElements = {};
      function getElement(id) {
        if (!cachedElements[id]) {
          cachedElements[id] = document.getElementById(id);
        }
        return cachedElements[id];
      }
      
      // ëª¨ë°”ì¼ ìµœì í™” í•¨ìˆ˜
      function optimizeForMobile() {
        if (isMobile) {
          // ëª¨ë°”ì¼ì—ì„œ ë”ë¸”íƒ­ ì¤Œ ë°©ì§€
          let lastTouchEnd = 0;
          document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
              event.preventDefault();
            }
            lastTouchEnd = now;
          }, false);
          
          // ëª¨ë°”ì¼ì—ì„œ ì§€ë„ ì˜ì—­ì˜ í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™”
          const mapElement = document.getElementById('map');
          if (mapElement) {
            mapElement.addEventListener('touchstart', function(event) {
              // í•œ ì†ê°€ë½ í„°ì¹˜ë§Œ í—ˆìš©
              if (event.touches.length === 1) {
                event.stopPropagation();
              }
            }, { passive: true });
            
            mapElement.addEventListener('touchmove', function(event) {
              // í•œ ì†ê°€ë½ ë“œë˜ê·¸ í—ˆìš©
              if (event.touches.length === 1) {
                event.stopPropagation();
              }
            }, { passive: true });
            
            // ëª¨ë°”ì¼ì—ì„œ í•€ì¹˜ ì¤Œ ìµœì í™”
            mapElement.addEventListener('gesturestart', function(event) {
              event.preventDefault();
            }, { passive: false });
            
            mapElement.addEventListener('gesturechange', function(event) {
              event.preventDefault();
            }, { passive: false });
            
            mapElement.addEventListener('gestureend', function(event) {
              event.preventDefault();
            }, { passive: false });
          }
          
          // ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ ì„±ëŠ¥ ìµœì í™”
          document.addEventListener('touchmove', function(event) {
            if (event.target.closest('.info-content')) {
              event.stopPropagation();
            }
          }, { passive: true });
          
          // ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ í„°ì¹˜ í”¼ë“œë°± ìµœì í™”
          const buttons = document.querySelectorAll('button, .toggle-btn, .map-type-btn');
          buttons.forEach(button => {
            button.addEventListener('touchstart', function() {
              this.style.transform = 'scale(0.95)';
            }, { passive: true });
            
            button.addEventListener('touchend', function() {
              this.style.transform = 'scale(1)';
            }, { passive: true });
          });
        }
      }
      
      // êµ¬ê¸€ë§µ ì´ˆê¸°í™” í•¨ìˆ˜
      function initMap() {
        // ëª¨ë°”ì¼ ìµœì í™” ì ìš©
        optimizeForMobile();
        
        // ì¸ì²œê³µí•­ê³¼ ì‚°ì¹˜í† ì„¸ê³µí•­ì˜ ì¢Œí‘œ
        const incheonAirport = { lat: 37.4602, lng: 126.4407 }; // ì¸ì²œê³µí•­
        const chitoseAirport = { lat: 42.7752, lng: 141.6928 }; // ì‚°ì¹˜í† ì„¸ê³µí•­
        
        // ë‘ ê³µí•­ ì‚¬ì´ì˜ ì¤‘ê°„ì  ê³„ì‚°
        const centerLat = (incheonAirport.lat + chitoseAirport.lat) / 2;
        const centerLng = (incheonAirport.lng + chitoseAirport.lng) / 2;
        const center = { lat: centerLat, lng: centerLng };
        
        // ëª¨ë°”ì¼ì—ì„œëŠ” ë” ë„“ì€ ë·°ë¥¼ ì œê³µ
        const zoom = isMobile ? 4 : 5;
        
        // ì¼ë°˜ì§€ë„ì—ì„œ ë¼ë²¨ì„ ìˆ¨ê¸°ëŠ” ìŠ¤íƒ€ì¼ ì •ì˜
        const noLabelsStyle = [
          {
            featureType: 'all',
            elementType: 'labels',
            stylers: [{ visibility: 'off' }]
          },
          {
            featureType: 'all',
            elementType: 'labels.text',
            stylers: [{ visibility: 'off' }]
          },
          {
            featureType: 'all',
            elementType: 'labels.icon',
            stylers: [{ visibility: 'off' }]
          }
        ];
        
        // êµ¬ê¸€ ë§µ ê°ì²´ ìƒì„± ë° ì˜µì…˜ ì„¤ì • - ëª¨ë°”ì¼ ìµœì í™”
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: zoom,
          center: center,
          mapTypeControl: false,
          mapTypeControlOptions: {
            mapTypeIds: ['roadmap', 'satellite', 'hybrid'],
            style: google.maps.MapTypeControlStyle.VERTICAL_BAR,
            position: google.maps.ControlPosition.LEFT_TOP
          },
          // ëª¨ë°”ì¼ì—ì„œ ê¸°ë³¸ ì»¨íŠ¸ë¡¤ë“¤ ë¹„í™œì„±í™”
          fullscreenControl: false,
          streetViewControl: false,
          zoomControl: false,
          scaleControl: false,
          rotateControl: false,
          tilt: 0,
          // ëª¨ë°”ì¼ì—ì„œ í•œ ì†ê°€ë½ ë“œë˜ê·¸ í—ˆìš©
          gestureHandling: 'greedy',
          // ì¼ë°˜ì§€ë„ì—ì„œ ë¼ë²¨ ìˆ¨ê¸°ê¸°
          styles: noLabelsStyle,
          // ëª¨ë°”ì¼ ì„±ëŠ¥ ìµœì í™”
          disableDefaultUI: true,
          clickableIcons: false,
          // ëª¨ë°”ì¼ì—ì„œ ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜
          animation: google.maps.Animation.NONE,
          // ëª¨ë°”ì¼ì—ì„œ ë°°í„°ë¦¬ ì ˆì•½
          backgroundColor: '#f5f5f5'
        });
        
        geocoder = new google.maps.Geocoder(); // Geocoder ê°ì²´ ìƒì„±
        
        // ê³µí•­ ì•„ì´ì½˜ ë§ˆì»¤ ì¶”ê°€ - ì´ëª¨ì§€ ì‚¬ìš©
        incheonMarker = new google.maps.Marker({
          position: incheonAirport,
          map: map,
          title: 'ì¸ì²œêµ­ì œê³µí•­',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: 'transparent',
            fillOpacity: 0,
            strokeColor: 'transparent',
            strokeWeight: 0,
            scale: 0
          },
          label: {
            text: 'âœˆï¸',
            fontSize: '18px',
            fontWeight: 'bold'
          }
        });
        
        chitoseMarker = new google.maps.Marker({
          position: chitoseAirport,
          map: map,
          title: 'ì‹ ì¹˜í† ì„¸ê³µí•­',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: 'transparent',
            fillOpacity: 0,
            strokeColor: 'transparent',
            strokeWeight: 0,
            scale: 0
          },
          label: {
            text: 'âœˆï¸',
            fontSize: '18px',
            fontWeight: 'bold'
          }
        });
        
        // ì¸ì²œê³µí•­ì—ì„œ ì‹ ì¹˜í† ì„¸ê³µí•­ê¹Œì§€ì˜ í•­ë¡œ (ì ì„ )
        flightPath = new google.maps.Polyline({
          path: [incheonAirport, chitoseAirport],
          geodesic: true,
          strokeColor: '#60a5fa',
          strokeOpacity: 0.8,
          strokeWeight: isMobile ? 4 : 3
        });
        
        flightPath.setMap(map);
        
        // ì ì„  íš¨ê³¼ë¥¼ ìœ„í•œ ì¶”ê°€ ì„  (ë” ì–‡ì€ ì„ ìœ¼ë¡œ ì ì„  íš¨ê³¼)
        dottedPath = new google.maps.Polyline({
          path: [incheonAirport, chitoseAirport],
          geodesic: true,
          strokeColor: '#ffffff',
          strokeOpacity: 0.9,
          strokeWeight: 1,
          icons: [{
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              fillColor: '#60a5fa',
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 1,
              scale: isMobile ? 6 : 5
            },
            offset: '0',
            repeat: isMobile ? '12px' : '10px'
          }]
        });
        
        dottedPath.setMap(map);
        
        // í•­ë¡œ ì •ì¤‘ì•™ì— í•­ê³µê¶Œ ë§ˆì»¤ ì¶”ê°€ - ì´ë¯¸ì§€ ì¤‘ì‹¬ê³¼ í•­ë¡œ ì¤‘ì‹¬ ì¼ì¹˜
        const flightCenter = { lat: centerLat, lng: centerLng };
        const planeIconSize = isMobile ? 48 : 40;
        
        const planeIcon = {
          url: 'https://raw.githubusercontent.com/ppoppo1971/VMAP/refs/heads/main/%ED%95%AD%EA%B3%B5%EA%B6%8C.png',
          scaledSize: new google.maps.Size(planeIconSize, planeIconSize),
          // ì´ë¯¸ì§€ ì˜¤ë¥¸ìª½ í•˜ë‹¨ì„ ê¸°ì¤€ìœ¼ë¡œ ë§ˆì»¤ ìœ„ì¹˜ ì„¤ì •
          anchor: new google.maps.Point(planeIconSize, planeIconSize),
          // ì´ë¯¸ì§€ê°€ í•­ë¡œ ìœ„ì— ì •í™•íˆ ìœ„ì¹˜í•˜ë„ë¡ ì¡°ì •
          origin: new google.maps.Point(0, 0)
        };
        
        planeMarker = new google.maps.Marker({
          position: flightCenter,
          map: map,
          title: 'í•­ê³µê¶Œ ì •ë³´ - í´ë¦­í•˜ì—¬ ì „ìí•­ê³µê¶Œ í™•ì¸',
          icon: planeIcon,
          opacity: 1.0,
          // ë§ˆì»¤ê°€ í•­ë¡œ ìœ„ì— ì •í™•íˆ ìœ„ì¹˜í•˜ë„ë¡ ì„¤ì •
          optimized: false
        });
        
        // ë¹„í–‰ê¸° ë§ˆì»¤ í´ë¦­ ì‹œ PDF ë·°ì–´ ì—´ê¸°
        planeMarker.addListener('click', function() {
          openPdfViewer();
        });
        
        // ì§€ë„ í´ë¦­ ì‹œ ì‚¬ì´ë“œíŒ¨ë„ í† ê¸€ ê¸°ëŠ¥ ì¶”ê°€ - ëª¨ë°”ì¼ ìµœì í™”
        map.addListener('click', function(event) {
          // ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™”
          if (isMobile && event.placeId) {
            return; // ì¥ì†Œ í´ë¦­ ì‹œ ë¬´ì‹œ
          }
          
          // ë§ˆì»¤ìƒì„± ëª¨ë“œì¼ ë•ŒëŠ” ë§ˆì»¤ ìƒì„±
          if (isMarkerMode) {
            addCustomMarker(event.latLng);
            return;
          }
          
          // ê²½ë¡œ ìƒì„± ëª¨ë“œì¼ ë•ŒëŠ” ìœ„ì¹˜ ì¶”ê°€
          if (isRouteMode) {
            addUserRoutePoint(event.latLng);
            return;
          }
          
          // ì—´ë¦° ì •ë³´ì°½ ë‹«ê¸°
          if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }
          
          // ê¸°ì¡´ ê¸°ëŠ¥ë“¤
          if (!getElement('customMapMenu').classList.contains('hide')) {
            hideMenu();
          }
          if (!getElement('mapTypeSelector').classList.contains('hide')) {
            hideRightMenu();
          }
          // ì‚¬ì „ì¤€ë¹„ ì •ë³´ì°½ë„ ë‹«ê¸°
          closePreparationInfo();
        });
        
        // ì˜¤ë¥¸ìª½ ìƒë‹¨ ë²„íŠ¼ ì´ˆê¸° ìƒíƒœ ì„¤ì •
        updateTopButtonStates('roadmap');
        
        // ì¤Œ ë ˆë²¨ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ - ëª¨ë°”ì¼ ìµœì í™”
        let zoomTimeout;
        map.addListener('zoom_changed', function() {
            // ë””ë°”ìš´ì‹±ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
            clearTimeout(zoomTimeout);
            zoomTimeout = setTimeout(function() {
                updateZoomLevel();
                toggleFlightElements(map.getZoom()); // ì¤Œ ë ˆë²¨ì— ë”°ë¼ í•­ë¡œì™€ ë§ˆì»¤ í‘œì‹œ/ìˆ¨ê¹€
            }, 100);
        });
        
        // ì§€ë„ ì´ë™ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ - ì£¼ì†Œ ë§ˆì»¤ì™€ í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ìë™ ì œê±° (ëª¨ë°”ì¼ ìµœì í™”)
        let boundsTimeout;
        map.addListener('bounds_changed', function() {
            // ë””ë°”ìš´ì‹±ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
            clearTimeout(boundsTimeout);
            boundsTimeout = setTimeout(function() {
                checkAddressMarkerVisibility();
                checkCurrentLocationMarkerVisibility();
            }, 200);
        });
        
        // ì´ˆê¸° ì¤Œ ë ˆë²¨ í‘œì‹œ
        updateZoomLevel();
        toggleFlightElements(map.getZoom()); // ì´ˆê¸° ì¤Œ ë ˆë²¨ì— ë”°ë¼ í•­ë¡œì™€ ë§ˆì»¤ í‘œì‹œ/ìˆ¨ê¹€
        
        // ì €ì¥ëœ ì‚¬ìš©ì ê²½ë¡œë“¤ ë³µì›
        restoreSavedUserRoutes().then(() => {
          // Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ì„¤ì •
          setupFirebaseSync();
          
          // ê²½ë¡œì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
          updateRouteRemoveButtons();
          // ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
          updateMarkerRemoveButtons();
        });
        
        // ì €ì¥ëœ ì‚¬ìš©ì ë§ˆì»¤ë“¤ ë³µì›
        restoreSavedUserMarkers();
        

        
        // GeoJSON ìŠ¤íƒ€ì¼ ì„¤ì • - í•­ë¡œ ìŠ¤íƒ€ì¼ë¡œ ê°œì„ 
        map.data.setStyle(function(feature) {
          const geometryType = feature.getGeometry().getType();
          
          if (geometryType === 'LineString' || geometryType === 'MultiLineString') {
            // ì„ í˜• ì§€ì˜¤ë©”íŠ¸ë¦¬: í•­ë¡œ ìŠ¤íƒ€ì¼ ì ìš©
            return {
              strokeColor: '#60a5fa',
              strokeWeight: 3,
              strokeOpacity: 0.8,
              fillColor: 'transparent',
              fillOpacity: 0
            };
          } else if (geometryType === 'Point' || geometryType === 'MultiPoint') {
            // ì í˜• ì§€ì˜¤ë©”íŠ¸ë¦¬: ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì ìš©
            return {
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: '#1d4ed8',
                fillOpacity: 1,
                strokeColor: '#ffffff',
                strokeWeight: 2,
                scale: 6
              }
            };
          } else {
            // ë©´í˜• ì§€ì˜¤ë©”íŠ¸ë¦¬: ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì ìš©
            return {
              fillColor: '#1d4ed8',
              fillOpacity: 0.3,
              strokeColor: '#1d4ed8',
              strokeWeight: 2,
              strokeOpacity: 0.8
            };
          }
        });
      }
      
      function setMapType(type) {
        // ì§€ë„ íƒ€ì… ì„¤ì •
        if (map && map.setMapTypeId) {
          map.setMapTypeId(type);
        }
        
        // ì§€ë„ íƒ€ì…ì— ë”°ë¼ ë¼ë²¨ í‘œì‹œ ì—¬ë¶€ ì œì–´
        if (map && map.setOptions) {
          if (type === 'roadmap') {
            // ì¼ë°˜ì§€ë„: ë¼ë²¨ ìˆ¨ê¸°ê¸°
            map.setOptions({
              styles: [
                {
                  featureType: 'all',
                  elementType: 'labels',
                  stylers: [{ visibility: 'off' }]
                },
                {
                  featureType: 'all',
                  elementType: 'labels.text',
                  stylers: [{ visibility: 'off' }]
                },
                {
                  featureType: 'all',
                  elementType: 'labels.icon',
                  stylers: [{ visibility: 'off' }]
                }
              ]
            });
          } else if (type === 'satellite') {
            // ìœ„ì„±ì§€ë„: ë¼ë²¨ ìˆ¨ê¸°ê¸°
            map.setOptions({
              styles: [
                {
                  featureType: 'all',
                  elementType: 'labels',
                  stylers: [{ visibility: 'off' }]
                },
                {
                  featureType: 'all',
                  elementType: 'labels.text',
                  stylers: [{ visibility: 'off' }]
                },
                {
                  featureType: 'all',
                  elementType: 'labels.icon',
                  stylers: [{ visibility: 'off' }]
                }
              ]
            });
          } else if (type === 'hybrid') {
            // í•˜ì´ë¸Œë¦¬ë“œ: ë¼ë²¨ í‘œì‹œ
            map.setOptions({
              styles: [] // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì‚¬ìš© (ë¼ë²¨ í‘œì‹œ)
            });
          }
        }
        
        // ì˜¤ë¥¸ìª½ ìƒë‹¨ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateTopButtonStates(type);
      }
      
      // ì˜¤ë¥¸ìª½ ìƒë‹¨ ë²„íŠ¼ì—ì„œ ì§€ë„ íƒ€ì… ì„¤ì •
      function setMapTypeFromTop(type) {
        if (map && map.setMapTypeId) {
          map.setMapTypeId(type);
        }
        
        // ì˜¤ë¥¸ìª½ ìƒë‹¨ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateTopButtonStates(type);
        
        // ì‚¬ì´ë“œíŒ¨ë„ê³¼ ë™ê¸°í™”
        syncSidePanelWithTop(type);
      }
      
      // ì˜¤ë¥¸ìª½ ìƒë‹¨ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateTopButtonStates(activeType) {
        const topRoadmapBtn = document.getElementById('topRoadmapBtn');
        const topSatelliteBtn = document.getElementById('topSatelliteBtn');
        const topHybridBtn = document.getElementById('topHybridBtn');
        
        // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
        [topRoadmapBtn, topSatelliteBtn, topHybridBtn].forEach(btn => {
          if (btn) btn.classList.remove('active');
        });
        
        // í™œì„± íƒ€ì…ì— ë”°ë¼ ë²„íŠ¼ ìƒíƒœ ì„¤ì •
        switch (activeType) {
          case 'roadmap':
            if (topRoadmapBtn) topRoadmapBtn.classList.add('active');
            if (topHybridBtn) {
              topHybridBtn.textContent = 'ë¼ë²¨';
            }
            break;
          case 'satellite':
            if (topSatelliteBtn) topSatelliteBtn.classList.add('active');
            if (topHybridBtn) {
              topHybridBtn.textContent = 'ë¼ë²¨';
            }
            break;
          case 'hybrid':
            if (topSatelliteBtn) topSatelliteBtn.classList.add('active');
            if (topHybridBtn) {
              topHybridBtn.classList.add('active');
              topHybridBtn.textContent = 'ë¼ë²¨';
            }
            break;
        }
      }
      
      // ì‚¬ì´ë“œíŒ¨ë„ê³¼ ì˜¤ë¥¸ìª½ ìƒë‹¨ ë²„íŠ¼ ë™ê¸°í™”
      function syncSidePanelWithTop(activeType) {
        // ì¼ë°˜ ì„ íƒ ì‹œ
        if (activeType === 'roadmap') {
          const roadmapMenu = document.getElementById('roadmapMenu');
          const roadmapBtn = document.getElementById('roadmapToggleBtn');
          if (roadmapMenu && roadmapBtn) {
            roadmapMenu.style.display = 'block';
            roadmapBtn.textContent = '-ì¼ë°˜';
          }
          
          const satelliteMenu = document.getElementById('satelliteMenu');
          const satelliteBtn = document.getElementById('satelliteToggleBtn');
          if (satelliteMenu && satelliteBtn) {
            satelliteMenu.style.display = 'none';
            satelliteBtn.textContent = '+ìœ„ì„±';
          }
        }
        // ìœ„ì„± ì„ íƒ ì‹œ
        else if (activeType === 'satellite') {
          const roadmapMenu = document.getElementById('roadmapMenu');
          const roadmapBtn = document.getElementById('roadmapToggleBtn');
          if (roadmapMenu && roadmapBtn) {
            roadmapMenu.style.display = 'none';
            roadmapBtn.textContent = '+ì¼ë°˜';
          }
          
          const satelliteMenu = document.getElementById('satelliteMenu');
          const satelliteBtn = document.getElementById('satelliteToggleBtn');
          if (satelliteMenu && satelliteBtn) {
            satelliteMenu.style.display = 'block';
            satelliteBtn.textContent = '-ìœ„ì„±';
          }
        }
        // í•˜ì´ë¸Œë¦¬ë“œ ì„ íƒ ì‹œ
        else if (activeType === 'hybrid') {
          const roadmapMenu = document.getElementById('roadmapMenu');
          const roadmapBtn = document.getElementById('roadmapToggleBtn');
          if (roadmapMenu && roadmapBtn) {
            roadmapMenu.style.display = 'none';
            roadmapBtn.textContent = '+ì¼ë°˜';
          }
          
          const satelliteMenu = document.getElementById('satelliteMenu');
          const satelliteBtn = document.getElementById('satelliteToggleBtn');
          if (satelliteMenu && satelliteBtn) {
            satelliteMenu.style.display = 'block';
            satelliteBtn.textContent = '-ìœ„ì„±';
          }
        }
      }
      
      // ìµœì í™”ëœ ë©”ë‰´ í† ê¸€ í•¨ìˆ˜
      function toggleMenu(menuId, btnId, menuName, subMenus = []) {
        const menu = getElement(menuId);
        const btn = getElement(btnId);
        const isHidden = menu.style.display === 'none';
        
        menu.style.display = isHidden ? 'block' : 'none';
        btn.textContent = isHidden ? `-${menuName}` : `+${menuName}`;
        
        if (!isHidden && subMenus.length) {
          subMenus.forEach(({menuId, btnId, btnText}) => {
            getElement(menuId).style.display = 'none';
            getElement(btnId).textContent = btnText;
          });
        }
      }
      
      // êµ¬ê¸€ë§µ ë©”ë‰´ í† ê¸€
      function toggleGoogleMapMenu() {
        toggleMenu('googleMapMenu', 'googleMapToggleBtn', 'êµ¬ê¸€ë§µ', [
          {menuId: 'roadmapMenu', btnId: 'roadmapToggleBtn', btnText: '+ì¼ë°˜'},
          {menuId: 'satelliteMenu', btnId: 'satelliteToggleBtn', btnText: '+ìœ„ì„±'}
        ]);
      }
      
      // +ì¼ë°˜ í´ë¦­ ì‹œ ë°”ë¡œ ì¼ë°˜ì§€ë„ë¥¼ ë¡œë“œí•˜ê³ , í•˜ìœ„ ë©”ë‰´ë§Œ í† ê¸€
      function toggleRoadmapMenuAndSetRoadmap() {
        const menu = document.getElementById('roadmapMenu');
        const btn = document.getElementById('roadmapToggleBtn');
        if(menu.style.display === 'none') {
          setMapType('roadmap');
          menu.style.display = 'block';
          btn.textContent = '-ì¼ë°˜';
        } else {
          menu.style.display = 'none';
          btn.textContent = '+ì¼ë°˜';
        }
      }
      
      // +ìœ„ì„± í´ë¦­ ì‹œ ë°”ë¡œ ìœ„ì„±ì§€ë„ë¥¼ ë¡œë“œí•˜ê³ , í•˜ìœ„ì— í•˜ì´ë¸Œë¦¬ë“œë§Œ ë³´ì´ë„ë¡
      function toggleSatelliteMenuAndSetSatellite() {
        const menu = document.getElementById('satelliteMenu');
        const btn = document.getElementById('satelliteToggleBtn');
        if(menu.style.display === 'none') {
          setMapType('satellite');
          menu.style.display = 'block';
          btn.textContent = '-ìœ„ì„±';
        } else {
          menu.style.display = 'none';
          btn.textContent = '+ìœ„ì„±';
        }
      }

      // ë¼ë²¨ ë²„íŠ¼ í† ê¸€ í•¨ìˆ˜
      function toggleHybridLabel() {
        const hybridBtn = document.getElementById('topHybridBtn');
        const currentMapType = map.getMapTypeId();
        
        if (!hybridBtn.classList.contains('active')) { // ë¼ë²¨ ë²„íŠ¼ì´ ë¹„í™œì„±í™”ëœ ê²½ìš°
          if (currentMapType === 'roadmap') {
            // ì¼ë°˜ì§€ë„ì—ì„œ ë¼ë²¨ í‘œì‹œ
            map.setOptions({
              styles: [] // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì‚¬ìš© (ë¼ë²¨ í‘œì‹œ)
            });
          } else if (currentMapType === 'satellite') {
            // ìœ„ì„±ì§€ë„ì—ì„œ í•˜ì´ë¸Œë¦¬ë“œë¡œ ë³€ê²½
            setMapType('hybrid');
          }
          hybridBtn.classList.add('active');
        } else { // ë¼ë²¨ ë²„íŠ¼ì´ í™œì„±í™”ëœ ê²½ìš°
          if (currentMapType === 'roadmap') {
            // ì¼ë°˜ì§€ë„ì—ì„œ ë¼ë²¨ ìˆ¨ê¸°ê¸°
            map.setOptions({
              styles: [
                {
                  featureType: 'all',
                  elementType: 'labels',
                  stylers: [{ visibility: 'off' }]
                },
                {
                  featureType: 'all',
                  elementType: 'labels.text',
                  stylers: [{ visibility: 'off' }]
                },
                {
                  featureType: 'all',
                  elementType: 'labels.icon',
                  stylers: [{ visibility: 'off' }]
                }
              ]
            });
          } else if (currentMapType === 'hybrid') {
            // í•˜ì´ë¸Œë¦¬ë“œì—ì„œ ìœ„ì„±ìœ¼ë¡œ ë³€ê²½
            setMapType('satellite');
          }
          hybridBtn.classList.remove('active');
        }
        
        // ì‚¬ì´ë“œíŒ¨ë„ê³¼ ë™ê¸°í™”
        syncSidePanelWithTop(currentMapType);
      }
      
                    // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì €ì¥ í•¨ìˆ˜ (localStorage ì œê±° ë²„ì „)
       async function saveCheckboxStates() {
         // ë™ê¸°í™” ì¤‘ì´ë©´ ë¬´ì‹œ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
         if (isSyncing) {
           console.log('ë™ê¸°í™” ì¤‘ì´ë¯€ë¡œ ì²´í¬ë°•ìŠ¤ ì €ì¥ ê±´ë„ˆëœ€');
           return;
         }
         
         const checkboxes = document.querySelectorAll('.prep-checkbox');
         const states = {};
         checkboxes.forEach(checkbox => {
           states[checkbox.id] = checkbox.checked;
         });
         
         try {
           // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
           isSyncing = true;
           updateSyncStatus('ì²´í¬ë°•ìŠ¤ ì €ì¥ ì¤‘...', 'info');
           
           // Firebaseì— ì €ì¥
           await window.firestore.setDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
             preparationCheckboxes: states,
             lastUpdated: window.firestore.serverTimestamp()
           }, { merge: true });
           
           // ì‚¬ìš©ì ì¶”ê°€ í•­ëª©ì˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœë„ ì—…ë°ì´íŠ¸
           updateUserItemsCheckboxStates();
           
           console.log('Firebaseì— ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì €ì¥ ì™„ë£Œ');
           updateSyncStatus('ì²´í¬ë°•ìŠ¤ ì €ì¥ ì™„ë£Œ', 'success');
           
         } catch (error) {
           console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', error);
           updateSyncStatus('ì €ì¥ ì‹¤íŒ¨', 'error');
           
           // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
           setTimeout(() => {
             updateSyncStatus('Firebase ì—°ê²° ì‹¤íŒ¨', 'error');
           }, 2000);
         } finally {
           // ë™ê¸°í™” ìƒíƒœ í•´ì œ (ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í—ˆìš©)
           isSyncing = false;
         }
       }
       
       // ì‚¬ìš©ì ì¶”ê°€ í•­ëª©ì˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (localStorage ì œê±°)
       function updateUserItemsCheckboxStates() {
         if (!window.firebaseUserItems) return;
         
         const updatedItems = window.firebaseUserItems.map(item => {
           const checkbox = document.getElementById(item.id);
           if (checkbox) {
             item.checked = checkbox.checked;
           }
           return item;
         });
         
         // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
         window.firebaseUserItems = updatedItems;
       }
       
             // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì› í•¨ìˆ˜ (localStorage ì œê±° ë²„ì „)
      async function restoreCheckboxStates() {
        try {
          const docSnap = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'));
          if (docSnap.exists()) {
            const data = docSnap.data();
            
            // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì›
            if (data.preparationCheckboxes) {
              Object.keys(data.preparationCheckboxes).forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                  checkbox.checked = data.preparationCheckboxes[id];
                }
              });
            }
            
            // ì‚¬ìš©ì ì¶”ê°€ í•­ëª© ë³µì› - ì¦‰ì‹œ í‘œì‹œ
            if (data.userAddedItems && data.userAddedItems.length > 0) {
              // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥í•˜ê³  UI ì—…ë°ì´íŠ¸
              window.firebaseUserItems = data.userAddedItems;
              setTimeout(() => {
                displayUserAddedItemsFromFirebase(data.userAddedItems);
              }, 100);
            } else {
              window.firebaseUserItems = [];
              setTimeout(() => {
                displayUserAddedItemsFromFirebase([]);
              }, 100);
            }
            
            // ê²½ë¡œì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateRouteRemoveButtons();
            // ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateMarkerRemoveButtons();
            
            console.log('Firebaseì—ì„œ ìƒíƒœ ë³µì› ì™„ë£Œ');
            // ê¸°ì¡´ í•­ëª© ìˆ¨ê¹€/ì˜¤ë²„ë¼ì´ë“œ ìƒíƒœ ë³µì› (ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’)
            window.hiddenExistingItems = data.hiddenExistingItems || [];
            window.existingItemOverrides = data.existingItemOverrides || {};
            if (typeof applyOverridesAndHides === 'function') {
              setTimeout(() => applyOverridesAndHides(), 0);
            }
          } else {
            // Firebase ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°
            console.log('Firebase ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
            
            // UI ì´ˆê¸°í™”
            window.firebaseUserItems = [];
            displayUserAddedItemsFromFirebase([]);
            updateRouteRemoveButtons();
            updateMarkerRemoveButtons();
          }
          
        } catch (error) {
          console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', error);
          updateSyncStatus('Firebase ë¡œë“œ ì‹¤íŒ¨', 'error');
          
          // UI ì´ˆê¸°í™”
          window.firebaseUserItems = [];
          displayUserAddedItemsFromFirebase([]);
          updateRouteRemoveButtons();
          updateMarkerRemoveButtons();
        }
      }
       
       // ì‚¬ì „ì¤€ë¹„ ì •ë³´ì°½ í‘œì‹œ í•¨ìˆ˜
        function showPreparationInfo() {
          // ê¸°ì¡´ ì •ë³´ì°½ì´ ìˆìœ¼ë©´ ì œê±°
          const existingInfo = document.getElementById('preparationInfo');
          if (existingInfo) {
            existingInfo.remove();
            return;
          }
          
          // ì •ë³´ì°½ ìƒì„±
          const infoDiv = document.createElement('div');
          infoDiv.id = 'preparationInfo';
          infoDiv.innerHTML = `
            <div class="info-header">
             <h3>ì‚¬ì „ì¤€ë¹„ í•­ëª©</h3>
              <button class="close-btn" onclick="closePreparationInfo()">Ã—</button>
            </div>
            <div class="info-content">
              <div class="info-section">
                                              <div class="checklist-item" data-item-id="airline" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="airline" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span onclick="openPdfViewer()" style="cursor: pointer;">í•­ê³µê¶Œ - ì˜ˆì•½í™•ì¸ì„œ ë° ì „ìí•­ê³µê¶Œ</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('airline', 'í•­ê³µê¶Œ', 'ì˜ˆì•½í™•ì¸ì„œ ë° ì „ìí•­ê³µê¶Œ', 'https://ppoppo1971.github.io/VMAP/%EC%A0%84%EC%9E%90%ED%95%AD%EA%B3%B5%EA%B6%8C.pdf')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('airline')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
              <div class="checklist-item" data-item-id="parking" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="parking" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span>ê³µí•­ì£¼ì°¨ - ì¥ê¸°ì£¼ì°¨ ì˜ˆì•½</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('parking', 'ê³µí•­ì£¼ì°¨', 'ì¥ê¸°ì£¼ì°¨ ì˜ˆì•½', '')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('parking')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
              <div class="checklist-item" data-item-id="insurance" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="insurance" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span>ì—¬í–‰ìë³´í—˜ - í•´ì™¸ì—¬í–‰ ë³´í—˜ ê°€ì…</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('insurance', 'ì—¬í–‰ìë³´í—˜', 'í•´ì™¸ì—¬í–‰ ë³´í—˜ ê°€ì…', '')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('insurance')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
              <div class="checklist-item" data-item-id="sim" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="sim" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span>ì´ì‹¬ - ì¼ë³¸ í˜„ì§€ ì¸í„°ë„· ì—°ê²°</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('sim', 'ì´ì‹¬', 'ì¼ë³¸ í˜„ì§€ ì¸í„°ë„· ì—°ê²°', '')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('sim')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
              <div class="checklist-item" data-item-id="visitjapan" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="visitjapan" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span onclick="openVisitJapanWeb()" style="cursor: pointer;">Visit Japan Web - ì…êµ­ ìˆ˜ì† ì‚¬ì „ ë“±ë¡</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('visitjapan', 'Visit Japan Web', 'ì…êµ­ ìˆ˜ì† ì‚¬ì „ ë“±ë¡', 'https://blog.naver.com/sostrip/223644368814')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('visitjapan')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
              <div class="checklist-item" data-item-id="confirmations" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="confirmations" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span>ê°ì¢… í™•ì •ì„œ ì¶œë ¥ - í˜¸í…”, íˆ¬ì–´ì˜ˆì•½í™•ì¸ì„œ</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('confirmations', 'ê°ì¢… í™•ì •ì„œ ì¶œë ¥', 'í˜¸í…”, íˆ¬ì–´ì˜ˆì•½í™•ì¸ì„œ', '')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('confirmations')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
              <div class="checklist-item" data-item-id="beergarden" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="beergarden" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span>ì‚¿í¬ë¡œë¹„ì–´ê°€ë“  ì˜ˆì•½ - ì§•ê¸°ìŠ¤ì¹¸ ì˜ˆì•½</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('beergarden', 'ì§•ê¸°ìŠ¤ì¹¸ ì˜ˆì•½', '')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('beergarden')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
              <div class="checklist-item" data-item-id="songyeongbus" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="songyeongbus" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span onclick="openSongyeongBusPdf()" style="cursor: pointer;">ì†¡ì˜ë²„ìŠ¤ ì˜ˆì•½ - ì‚¿í¬ë¡œ-ë§ˆí˜¸ë°”ë¡œ ê°„ ì´ë™</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('songyeongbus', 'ì†¡ì˜ë²„ìŠ¤ ì˜ˆì•½', 'ì‚¿í¬ë¡œ-ë§ˆí˜¸ë°”ë¡œ ê°„ ì´ë™', 'https://ppoppo1971.github.io/VMAP/%EC%86%A1%EC%98%81%EB%B2%84%EC%8A%A4.pdf')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('songyeongbus')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
              <div class="checklist-item" data-item-id="donanbus" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="donanbus" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span onclick="openDonanBusWebsite()" style="cursor: pointer;">ë„ë‚œë²„ìŠ¤ ì˜ˆì•½ - ë§ˆí˜¸ë°”ë¡œ-í•­ê³µ ê°„ ì´ë™</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('donanbus', 'ë„ë‚œë²„ìŠ¤ ì˜ˆì•½', 'ë§ˆí˜¸ë°”ë¡œ-í•­ê³µ ê°„ ì´ë™', 'https://japanbuslines.com/ko/bus_search/hokkaido/noboribetsu/hokkaido/all/ym_202509/day_20/')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('donanbus')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
                                 <!-- ì‚¬ìš©ì ì¶”ê°€ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                 <div id="userAddedItems"></div>
                                   <!-- ìƒˆ í•­ëª© ì¶”ê°€ ë²„íŠ¼ -->
                  <div class="add-item-section">
                    <button type="button" onclick="showAddForm()" class="toggle-add-btn" id="toggleAddBtn">+ ìƒˆ í•­ëª© ì¶”ê°€</button>
                  </div>
                 <!-- ìƒˆ í•­ëª© ì¶”ê°€ í¼ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
                 <div class="add-item-form" id="addItemForm" style="display: none;">
                   <div class="form-group">
                     <input type="text" id="newItemTitle" placeholder="í•­ëª© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="50">
                     <input type="url" id="newItemLink" placeholder="ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)" maxlength="200">
                   </div>
                   <div class="form-buttons">
                     <button type="button" onclick="addNewItem()" class="add-btn">ì¶”ê°€</button>
                   </div>
                 </div>
              </div>
              
              <!-- ì €ì¥ëœ ê²½ë¡œ/ë§ˆì»¤ ì œê±° ë²„íŠ¼ ì„¹ì…˜ -->
              <div class="info-section">
                <div id="preparationRemoveButtons" style="display: none;">
                  <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <button class="route-remove-btn" onclick="removeRoutesByLocation('ì‚¬ì „ì¤€ë¹„')" style="flex: 1;">ê²½ë¡œì œê±°</button>
                    <button class="route-remove-btn" onclick="removeMarkersByLocation('ì‚¬ì „ì¤€ë¹„')" style="flex: 1;">ë§ˆì»¤ì œê±°</button>
                  </div>
                  <p style="font-size: 0.63rem; color: #6b7280; margin: 0;">
                    ì‚¬ì „ì¤€ë¹„ì— ì €ì¥ëœ ê²½ë¡œì™€ ë§ˆì»¤ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
                  </p>
                </div>
              </div>
            </div>
          `;
          
          // ì •ë³´ì°½ì„ ì§€ë„ ìœ„ì— í‘œì‹œ
          document.body.appendChild(infoDiv);
          
          // í´ë¦­ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸ ëì— â— í‘œì‹œ ì¶”ê°€
          if (typeof appendExclamationToLinks === 'function') {
            appendExclamationToLinks(infoDiv);
          }
          
          // ì €ì¥ëœ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì›
          setTimeout(() => {
            restoreCheckboxStates();
            // ìŠ¤ì™€ì´í”„ ê¸°ëŠ¥ ì´ˆê¸°í™”
            initializeSwipeDelete();
          }, 50);
          
                  // ì •ë³´ì°½ ìœ„ì¹˜ ì¡°ì • - ëª¨ë°”ì¼ ìµœì í™”
        setTimeout(() => {
          const menu = document.getElementById('customMapMenu');
          const menuRect = menu.getBoundingClientRect();
          const mapElement = document.getElementById('map');
          const mapRect = mapElement.getBoundingClientRect();
          
          if (isMobile) {
            // ëª¨ë°”ì¼: í™”ë©´ ì¤‘ì•™ì— í‘œì‹œ
            infoDiv.style.left = '50%';
            infoDiv.style.transform = 'translateX(-50%)';
            infoDiv.style.top = '80px';
          } else {
            // ë°ìŠ¤í¬í†±: ì‚¬ì´ë“œë©”ë‰´ ì˜¤ë¥¸ìª½ì— í‘œì‹œ
            infoDiv.style.left = (menuRect.right + 10) + 'px';
            infoDiv.style.top = menuRect.top + 'px';
            infoDiv.style.transform = 'none';
          }
        }, 100);
        }
      
      // ì‚¬ì „ì¤€ë¹„ ì •ë³´ì°½ ë‹«ê¸° í•¨ìˆ˜
      function closePreparationInfo() {
        const infoDiv = document.getElementById('preparationInfo');
        if (infoDiv) {
          infoDiv.remove();
        }
      }
      
      // 1ì¼ì°¨ ì •ë³´ì°½ í‘œì‹œ í•¨ìˆ˜
      function showDay1Info() {
        // ê¸°ì¡´ ì •ë³´ì°½ì´ ìˆìœ¼ë©´ ì œê±°
        const existingInfo = document.getElementById('preparationInfo');
        if (existingInfo) {
          existingInfo.remove();
        }
        
        // ì •ë³´ì°½ ìƒì„±
        const infoDiv = document.createElement('div');
        infoDiv.id = 'preparationInfo';
        infoDiv.innerHTML = `
          <div class="info-header">
            <h3>1ì¼ì°¨ - ë„ì°© ë° ì²«ë‚ </h3>
            <button class="close-btn" onclick="closePreparationInfo()">Ã—</button>
          </div>
          <div class="info-content">
            <div class="info-section">
              <div class="checklist-item" data-item-id="arrival" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="arrival" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span>ì‹ ì¹˜í† ì„¸ê³µí•­ ë„ì°© - ì˜¤í›„ 12:30 (ì¼ë³¸ì‹œê°„)</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('arrival', 'ì‹ ì¹˜í† ì„¸ê³µí•­ ë„ì°©', 'ì˜¤í›„ 12:30 (ì¼ë³¸ì‹œê°„)', '')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('arrival')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
              <div class="checklist-item" data-item-id="immigration" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="immigration" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span>ì…êµ­ì‹¬ì‚¬ - ì—¬ê¶Œ ë° Visit Japan Web QRì½”ë“œ ì œì‹œ</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('immigration', 'ì…êµ­ì‹¬ì‚¬', 'ì—¬ê¶Œ ë° Visit Japan Web QRì½”ë“œ ì œì‹œ', '')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('immigration')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
              <div class="checklist-item" data-item-id="baggage" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="baggage" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span>ìˆ˜í•˜ë¬¼ ìˆ˜ë ¹ - ìœ„íƒìˆ˜í•˜ë¬¼ í™•ì¸</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('baggage', 'ìˆ˜í•˜ë¬¼ ìˆ˜ë ¹', 'ìœ„íƒìˆ˜í•˜ë¬¼ í™•ì¸', '')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('baggage')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
            </div>
            
            <div class="info-section">
              <div class="checklist-item" data-item-id="airportBus" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="airportBus" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span onclick="openSongyeongBusPdf()" style="cursor: pointer;">ì†¡ì˜ë²„ìŠ¤ íƒ‘ìŠ¹ - ì‚¿í¬ë¡œ ì‹œë‚´í–‰ ë²„ìŠ¤</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('airportBus', 'ì†¡ì˜ë²„ìŠ¤ íƒ‘ìŠ¹', 'ì‚¿í¬ë¡œ ì‹œë‚´í–‰ ë²„ìŠ¤', 'https://ppoppo1971.github.io/VMAP/%EC%86%A1%EC%98%81%EB%B2%84%EC%8A%A4.pdf')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('airportBus')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
              <div class="checklist-item" data-item-id="sapporoArrival" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="sapporoArrival" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span>ì‚¿í¬ë¡œ ë„ì°© - ì•½ 1ì‹œê°„ 30ë¶„ ì†Œìš”</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('sapporoArrival', 'ì‚¿í¬ë¡œ ë„ì°©', 'ì•½ 1ì‹œê°„ 30ë¶„ ì†Œìš”', '')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('sapporoArrival')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
            </div>
            
            <div class="info-section">
              <div class="checklist-item" data-item-id="hotelCheckin" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="hotelCheckin" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span>í˜¸í…” ë„ì°© - ì²´í¬ì¸ ë° ì§ ì •ë¦¬</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('hotelCheckin', 'í˜¸í…” ë„ì°©', 'ì²´í¬ì¸ ë° ì§ ì •ë¦¬', '')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('hotelCheckin')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
              <div class="checklist-item" data-item-id="simActivation" data-item-type="existing">
                <div class="item-content">
                  <input type="checkbox" id="simActivation" class="prep-checkbox" onchange="saveCheckboxStates()">
                  <span>ì´ì‹¬ í™œì„±í™” - ì¼ë³¸ í˜„ì§€ ì¸í„°ë„· ì—°ê²°</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('simActivation', 'ì´ì‹¬ í™œì„±í™”', 'ì¼ë³¸ í˜„ì§€ ì¸í„°ë„· ì—°ê²°', '')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('simActivation')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
            </div>
            
            <div class="info-section">
                             <div class="checklist-item" data-item-id="dinner" data-item-type="existing">
                 <div class="item-content">
                   <input type="checkbox" id="dinner" class="prep-checkbox" onchange="saveCheckboxStates()">
                   <span>ì§•ê¸°ìŠ¤ì¹¸ - ì‚¿í¬ë¡œë¹„ì–´ê°€ë“  ì˜ˆì•½</span>
                 </div>
                 <button class="swipe-edit-btn" onclick="editExistingItem('dinner', 'ì§•ê¸°ìŠ¤ì¹¸', 'ì‚¿í¬ë¡œë¹„ì–´ê°€ë“  ì˜ˆì•½', '')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                 <button class="swipe-delete-btn" onclick="deleteExistingItem('dinner')" title="ì‚­ì œ">ì‚­ì œ</button>
               </div>
               <div class="checklist-item" data-item-id="beer" data-item-type="existing">
                 <div class="item-content">
                   <input type="checkbox" id="beer" class="prep-checkbox" onchange="saveCheckboxStates()">
                   <span>ì‚¿í¬ë¡œ ë§¥ì£¼ - í˜„ì§€ ë§¥ì£¼ ì‹œìŒ</span>
                 </div>
                 <button class="swipe-edit-btn" onclick="editExistingItem('beer', 'ì‚¿í¬ë¡œ ë§¥ì£¼', 'í˜„ì§€ ë§¥ì£¼ ì‹œìŒ', '')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                 <button class="swipe-delete-btn" onclick="deleteExistingItem('beer')" title="ì‚­ì œ">ì‚­ì œ</button>
               </div>
            </div>
            
                         <div class="info-section">
               <div class="checklist-item" data-item-id="shopping" data-item-type="existing">
                 <div class="item-content">
                   <input type="checkbox" id="shopping" class="prep-checkbox" onchange="saveCheckboxStates()">
                   <span>í¸ì˜ì  ì‡¼í•‘ - ê°„ì‹ ë° ìƒí•„í’ˆ êµ¬ë§¤</span>
                 </div>
                 <button class="swipe-edit-btn" onclick="editExistingItem('shopping', 'í¸ì˜ì  ì‡¼í•‘', 'ê°„ì‹ ë° ìƒí•„í’ˆ êµ¬ë§¤', '')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                 <button class="swipe-delete-btn" onclick="deleteExistingItem('shopping')" title="ì‚­ì œ">ì‚­ì œ</button>
               </div>
               <div class="checklist-item" data-item-id="rest" data-item-type="existing">
                 <div class="item-content">
                   <input type="checkbox" id="rest" class="prep-checkbox" onchange="saveCheckboxStates()">
                   <span>í˜¸í…” íœ´ì‹ - ë‹¤ìŒë‚  ì¼ì • ì¤€ë¹„</span>
                </div>
                <button class="swipe-edit-btn" onclick="editExistingItem('rest', 'í˜¸í…” íœ´ì‹', 'ë‹¤ìŒë‚  ì¼ì • ì¤€ë¹„', '')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="swipe-delete-btn" onclick="deleteExistingItem('rest')" title="ì‚­ì œ">ì‚­ì œ</button>
              </div>
             </div>
             
             <div class="info-section">
              <div id="userAddedItems"></div>
              <div class="add-item-section">
                <button type="button" onclick="showAddForm()" class="toggle-add-btn" id="toggleAddBtn">+ ìƒˆ í•­ëª© ì¶”ê°€</button>
              </div>
              <div class="add-item-form" id="addItemForm" style="display: none;">
                <div class="form-group">
                  <input type="text" id="newItemTitle" placeholder="í•­ëª© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="50">
                  <input type="url" id="newItemLink" placeholder="ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)" maxlength="200">
                </div>
                <div class="form-buttons">
                  <button type="button" onclick="addNewItem()" class="add-btn">ì¶”ê°€</button>
                </div>
              </div>
            </div>
            
            <!-- ì €ì¥ëœ ê²½ë¡œ/ë§ˆì»¤ ì œê±° ë²„íŠ¼ ì„¹ì…˜ -->
            <div class="info-section">
              <div id="day1RemoveButtons" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                  <button class="route-remove-btn" onclick="removeRoutesByLocation('1ì¼ì°¨')" style="flex: 1;">ê²½ë¡œì œê±°</button>
                  <button class="route-remove-btn" onclick="removeMarkersByLocation('1ì¼ì°¨')" style="flex: 1;">ë§ˆì»¤ì œê±°</button>
                </div>
                <p style="font-size: 0.63rem; color: #6b7280; margin: 0;">
                  1ì¼ì°¨ì— ì €ì¥ëœ ê²½ë¡œì™€ ë§ˆì»¤ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
                </p>
              </div>
            </div>
          </div>
        `;
        
        // ì •ë³´ì°½ì„ ì§€ë„ ìœ„ì— í‘œì‹œ
        document.body.appendChild(infoDiv);
        
        // í´ë¦­ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸ ëì— â— í‘œì‹œ ì¶”ê°€
        if (typeof appendExclamationToLinks === 'function') {
          appendExclamationToLinks(infoDiv);
        }
        
        // ì €ì¥ëœ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì›
        setTimeout(() => {
          restoreCheckboxStates();
          // ìŠ¤ì™€ì´í”„ ê¸°ëŠ¥ ì´ˆê¸°í™”
          initializeSwipeDelete();
          if (typeof applyOverridesAndHides === 'function') {
            applyOverridesAndHides();
          }
        }, 50);
        
        // ê²½ë¡œì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateRouteRemoveButtons();
        // ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateMarkerRemoveButtons();
        
        // ì •ë³´ì°½ ìœ„ì¹˜ ì¡°ì • - ëª¨ë°”ì¼ ìµœì í™”
        setTimeout(() => {
          const menu = document.getElementById('customMapMenu');
          const menuRect = menu.getBoundingClientRect();
          const mapElement = document.getElementById('map');
          const mapRect = mapElement.getBoundingClientRect();
          
          if (isMobile) {
            // ëª¨ë°”ì¼: í™”ë©´ ì¤‘ì•™ì— í‘œì‹œ
            infoDiv.style.left = '50%';
            infoDiv.style.transform = 'translateX(-50%)';
            infoDiv.style.top = '80px';
          } else {
            // ë°ìŠ¤í¬í†±: ì‚¬ì´ë“œë©”ë‰´ ì˜¤ë¥¸ìª½ì— í‘œì‹œ
            infoDiv.style.left = (menuRect.right + 10) + 'px';
            infoDiv.style.top = menuRect.top + 'px';
            infoDiv.style.transform = 'none';
          }
        }, 100);
      }
      
      // ìƒì„¸ ì •ë³´ì°½ í‘œì‹œ í•¨ìˆ˜
      function showDetailedInfo() {
        // ê¸°ì¡´ ì •ë³´ì°½ ì œê±°
        closePreparationInfo();
        
        // ìƒì„¸ ì •ë³´ì°½ ìƒì„±
        const detailedDiv = document.createElement('div');
        detailedDiv.id = 'preparationInfo';
        detailedDiv.innerHTML = `
          <div class="info-header">
            <h3>í•­ê³µê¶Œ ìƒì„¸ì •ë³´</h3>
            <button class="close-btn" onclick="closePreparationInfo()">Ã—</button>
          </div>
          <div class="info-content">
            <div class="info-section">
              <h4>âœˆï¸ í•­ê³µê¶Œ ì •ë³´</h4>
              <p><strong>ì¶œë°œ:</strong> ì¸ì²œêµ­ì œê³µí•­ (ICN)</p>
              <p><strong>ë„ì°©:</strong> ì‹ ì¹˜í† ì„¸ê³µí•­ (CTS)</p>
              <p><strong>í•­ê³µì‚¬:</strong> ëŒ€í•œí•­ê³µ, ì•„ì‹œì•„ë‚˜í•­ê³µ, ì œì£¼í•­ê³µ</p>
              <p><strong>ì†Œìš”ì‹œê°„:</strong> ì•½ 3ì‹œê°„ 30ë¶„</p>
              <p><strong>ì¶œë°œì‹œê°„:</strong> ì˜¤ì „ 9:00 (í•œêµ­ì‹œê°„)</p>
              <p><strong>ë„ì°©ì‹œê°„:</strong> ì˜¤í›„ 12:30 (ì¼ë³¸ì‹œê°„)</p>
              <p><strong>í•­ê³µí¸:</strong> KE 705 / OZ 115 / 7C 2001</p>
            </div>
            <div class="info-section">
              <h4>ğŸ“‹ ì˜ˆì•½í™•ì¸ì„œ</h4>
              <p><strong>ì˜ˆì•½ë²ˆí˜¸:</strong> ABC123456789</p>
              <p><strong>ì˜ˆì•½ì¼:</strong> 2024ë…„ 12ì›” 15ì¼</p>
              <p><strong>ìŠ¹ê°:</strong> ì„±ì¸ 2ëª…</p>
              <p><strong>ì¢Œì„:</strong> 15A, 15B (ì°½ê°€ì„)</p>
              <p><strong>ìˆ˜í•˜ë¬¼:</strong> ìœ„íƒ 23kg x 2ê°œ, íœ´ëŒ€ 10kg x 2ê°œ</p>
            </div>
            <div class="info-section">
              <h4>ğŸ”— ê´€ë ¨ ë§í¬</h4>
              <button class="ticket-btn" onclick="openPdfViewer()">ì „ìí•­ê³µê¶Œ ë³´ê¸°</button>
              <button class="ticket-btn" style="margin-top: 10px; background: linear-gradient(135deg, #f59e0b, #d97706);" onclick="openReservationConfirmation()">ì˜ˆì•½í™•ì¸ì„œ ë³´ê¸°</button>
            </div>
          </div>
        `;
        
        // ìƒì„¸ ì •ë³´ì°½ì„ ì§€ë„ ìœ„ì— í‘œì‹œ
        document.body.appendChild(detailedDiv);
        
        // ìƒì„¸ ì •ë³´ì°½ ìœ„ì¹˜ ì¡°ì • - ëª¨ë°”ì¼ ìµœì í™”
        setTimeout(() => {
          const mapElement = document.getElementById('map');
          const mapRect = mapElement.getBoundingClientRect();
          
          if (isMobile) {
            // ëª¨ë°”ì¼: í™”ë©´ ì¤‘ì•™ì— í‘œì‹œ
            detailedDiv.style.left = '50%';
            detailedDiv.style.transform = 'translateX(-50%)';
            detailedDiv.style.top = '80px';
          } else {
            // ë°ìŠ¤í¬í†±: ì§€ë„ ì¤‘ì•™ì— í‘œì‹œ
            detailedDiv.style.left = (mapRect.width / 2 - 200) + 'px';
            detailedDiv.style.top = (mapRect.height / 2 - 200) + 'px';
            detailedDiv.style.transform = 'none';
          }
        }, 100);
      }

      // ê¸°ì¡´ í•­ëª© ìˆ¨ê¹€/ì˜¤ë²„ë¼ì´ë“œ ì ìš© í•¨ìˆ˜
      function applyOverridesAndHides() {
        try {
          const hidden = Array.isArray(window.hiddenExistingItems) ? window.hiddenExistingItems : [];
          const overrides = window.existingItemOverrides || {};
          document.querySelectorAll('.checklist-item[data-item-type="existing"]').forEach(el => {
            const id = el.getAttribute('data-item-id');
            // ìˆ¨ê¹€ ì ìš©
            if (hidden.includes(id)) {
              el.style.display = 'none';
              return;
            } else {
              el.style.display = '';
            }
            // ì œëª©/ë§í¬ ì˜¤ë²„ë¼ì´ë“œ ì ìš©
            if (overrides[id]) {
              const span = el.querySelector('.item-content span');
              if (span) {
                const { title, link } = overrides[id];
                if (link) {
                  span.innerHTML = `<span onclick="openUserItemLink('${link}')" style="cursor: pointer; color: #1d4ed8; text-decoration: underline;">${title}</span>`;
                } else {
                  span.textContent = title;
                }
              }
            }
          });
        } catch (e) {
          console.error('applyOverridesAndHides ì‹¤íŒ¨:', e);
        }
      }
      
      // ì‚¬ì´ë“œ íŒ¨ë„ í† ê¸€ í•¨ìˆ˜
      function hideMenu() {
        getElement('customMapMenu').classList.add('hide');
        getElement('menuToggleBtn').classList.add('show');
      }
      
      function showMenu() {
        getElement('customMapMenu').classList.remove('hide');
        getElement('menuToggleBtn').classList.remove('show');
      }

      // ì˜¤ë¥¸ìª½ ë©”ë‰´ í† ê¸€ í•¨ìˆ˜
      function toggleRightMenu() {
        const mapTypeSelector = document.getElementById('mapTypeSelector');
        const rightMenuToggleBtn = document.getElementById('rightMenuToggleBtn');
        const isHidden = mapTypeSelector.classList.contains('hide');
        
        if (isHidden) {
          // ë©”ë‰´ë¥¼ ë³´ì—¬ì¤„ ë•Œ
          mapTypeSelector.classList.remove('hide');
          rightMenuToggleBtn.style.display = 'none'; // í† ê¸€ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        } else {
          // ë©”ë‰´ë¥¼ ìˆ¨ê¸¸ ë•Œ
          mapTypeSelector.classList.add('hide');
          rightMenuToggleBtn.style.display = 'flex'; // í† ê¸€ ë²„íŠ¼ ë³´ì´ê¸°
        }
      }
      
      // ì˜¤ë¥¸ìª½ ë©”ë‰´ ìˆ¨ê¸°ê¸° í•¨ìˆ˜
      function hideRightMenu() {
        getElement('mapTypeSelector').classList.add('hide');
        getElement('rightMenuToggleBtn').style.display = 'flex'; // í† ê¸€ ë²„íŠ¼ ë³´ì´ê¸°
      }
      
      // PDF íŒŒì¼ ì§ì ‘ ì—´ê¸° í•¨ìˆ˜
      function openPdfViewer() {
        // PDF íŒŒì¼ URL
        const pdfUrl = 'https://ppoppo1971.github.io/VMAP/%EC%A0%84%EC%9E%90%ED%95%AD%EA%B3%B5%EA%B6%8C.pdf';
        
        // í˜„ì¬ íƒ­ì—ì„œ PDF ì—´ê¸°
        try {
          window.location.href = pdfUrl;
        } catch (error) {
          console.error('PDF ì—´ê¸° ì‹¤íŒ¨:', error);
          alert('PDF íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ë§í¬ë¥¼ ë³µì‚¬í•˜ì—¬ ì‚¬ìš©í•´ì£¼ì„¸ìš”: ' + pdfUrl);
        }
      }
      
      // Visit Japan Web ë§í¬ ì—´ê¸° í•¨ìˆ˜
      function openVisitJapanWeb() {
        // ë„¤ì´ë²„ ë¸”ë¡œê·¸ URL
        const visitJapanUrl = 'https://blog.naver.com/sostrip/223644368814';
        
        // ìƒˆ íƒ­ì—ì„œ ë§í¬ ì—´ê¸°
        try {
          window.open(visitJapanUrl, '_blank');
        } catch (error) {
          console.error('Visit Japan Web ë§í¬ ì—´ê¸° ì‹¤íŒ¨:', error);
          alert('ë§í¬ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ë§í¬ë¥¼ ë³µì‚¬í•˜ì—¬ ì‚¬ìš©í•´ì£¼ì„¸ìš”: ' + visitJapanUrl);
        }
      }
      
      // ì†¡ì˜ë²„ìŠ¤ PDF ì—´ê¸° í•¨ìˆ˜
      function openSongyeongBusPdf() {
        // ì†¡ì˜ë²„ìŠ¤ PDF íŒŒì¼ URL
        const songyeongBusPdfUrl = 'https://ppoppo1971.github.io/VMAP/%EC%86%A1%EC%98%81%EB%B2%84%EC%8A%A4.pdf';
        
        // í˜„ì¬ íƒ­ì—ì„œ PDF ì—´ê¸°
        try {
          window.location.href = songyeongBusPdfUrl;
        } catch (error) {
          console.error('ì†¡ì˜ë²„ìŠ¤ PDF ì—´ê¸° ì‹¤íŒ¨:', error);
          alert('PDF íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ë§í¬ë¥¼ ë³µì‚¬í•˜ì—¬ ì‚¬ìš©í•´ì£¼ì„¸ìš”: ' + songyeongBusPdfUrl);
        }
      }
      
      // ë„ë‚œë²„ìŠ¤ ì›¹ì‚¬ì´íŠ¸ ì—´ê¸° í•¨ìˆ˜
      function openDonanBusWebsite() {
        // ì¼ë³¸ë²„ìŠ¤ë¼ì¸ ì›¹ì‚¬ì´íŠ¸ URL
        const donanBusUrl = 'https://japanbuslines.com/ko/bus_search/hokkaido/noboribetsu/hokkaido/all/ym_202509/day_20/';
        
        // ìƒˆ íƒ­ì—ì„œ ì›¹ì‚¬ì´íŠ¸ ì—´ê¸°
        try {
          window.open(donanBusUrl, '_blank');
        } catch (error) {
          console.error('ë„ë‚œë²„ìŠ¤ ì›¹ì‚¬ì´íŠ¸ ì—´ê¸° ì‹¤íŒ¨:', error);
          alert('ì›¹ì‚¬ì´íŠ¸ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ë§í¬ë¥¼ ë³µì‚¬í•˜ì—¬ ì‚¬ìš©í•´ì£¼ì„¸ìš”: ' + donanBusUrl);
        }
      }
      
      // ì˜ˆì•½í™•ì¸ì„œ ë³´ê¸° í•¨ìˆ˜
      function openReservationConfirmation() {
        // ê¸°ì¡´ ì •ë³´ì°½ ì œê±°
        closePreparationInfo();
        
        // ì˜ˆì•½í™•ì¸ì„œ ì°½ ìƒì„±
        const reservationDiv = document.createElement('div');
        reservationDiv.id = 'preparationInfo';
        reservationDiv.innerHTML = `
          <div class="info-header">
            <h3>ì˜ˆì•½í™•ì¸ì„œ</h3>
            <button class="close-btn" onclick="closePreparationInfo()">Ã—</button>
          </div>
          <div class="info-content">
            <div class="info-section">
              <h4>âœˆï¸ í•­ê³µí¸ ì •ë³´</h4>
              <p><strong>í•­ê³µì‚¬:</strong> ëŒ€í•œí•­ê³µ (Korean Air)</p>
              <p><strong>í•­ê³µí¸:</strong> KE 705</p>
              <p><strong>ì¶œë°œ:</strong> ì¸ì²œêµ­ì œê³µí•­ (ICN) - í„°ë¯¸ë„ 2</p>
              <p><strong>ë„ì°©:</strong> ì‹ ì¹˜í† ì„¸ê³µí•­ (CTS) - êµ­ì œì„  í„°ë¯¸ë„</p>
              <p><strong>ì¶œë°œì‹œê°„:</strong> 2024ë…„ 12ì›” 20ì¼ ì˜¤ì „ 9:00</p>
              <p><strong>ë„ì°©ì‹œê°„:</strong> 2024ë…„ 12ì›” 20ì¼ ì˜¤í›„ 12:30</p>
              <p><strong>ì†Œìš”ì‹œê°„:</strong> 3ì‹œê°„ 30ë¶„</p>
            </div>
            <div class="info-section">
              <h4>ğŸ‘¥ ìŠ¹ê° ì •ë³´</h4>
              <p><strong>ì˜ˆì•½ë²ˆí˜¸:</strong> ABC123456789</p>
              <p><strong>ì˜ˆì•½ì¼:</strong> 2024ë…„ 12ì›” 15ì¼</p>
              <p><strong>ìŠ¹ê° 1:</strong> í™ê¸¸ë™ (ì„±ì¸)</p>
              <p><strong>ìŠ¹ê° 2:</strong> ê¹€ì² ìˆ˜ (ì„±ì¸)</p>
              <p><strong>ì¢Œì„:</strong> 15A, 15B (ì°½ê°€ì„)</p>
            </div>
            <div class="info-section">
              <h4>ğŸ§³ ìˆ˜í•˜ë¬¼ ì •ë³´</h4>
              <p><strong>ìœ„íƒìˆ˜í•˜ë¬¼:</strong> 23kg x 2ê°œ (ì´ 46kg)</p>
              <p><strong>íœ´ëŒ€ìˆ˜í•˜ë¬¼:</strong> 10kg x 2ê°œ (ì´ 20kg)</p>
              <p><strong>ìˆ˜í•˜ë¬¼ ì œí•œ:</strong> 1ì¸ë‹¹ ìœ„íƒ 1ê°œ, íœ´ëŒ€ 1ê°œ</p>
            </div>
            <div class="info-section">
              <h4>ğŸ“± ì²´í¬ì¸ ì•ˆë‚´</h4>
              <p><strong>ì˜¨ë¼ì¸ ì²´í¬ì¸:</strong> ì¶œë°œ 24ì‹œê°„ ì „ ~ 1ì‹œê°„ ì „</p>
              <p><strong>ê³µí•­ ì²´í¬ì¸:</strong> ì¶œë°œ 3ì‹œê°„ ì „ ~ 1ì‹œê°„ ì „</p>
              <p><strong>ì²´í¬ì¸ ì¹´ìš´í„°:</strong> í„°ë¯¸ë„ 2 3ì¸µ ì¶œêµ­ì¥</p>
              <p><strong>í•„ìˆ˜ì„œë¥˜:</strong> ì—¬ê¶Œ, ì˜ˆì•½í™•ì¸ì„œ</p>
            </div>
            <div class="info-section">
              <h4>ğŸ”— ê´€ë ¨ ë§í¬</h4>
              <button class="ticket-btn" onclick="openPdfViewer()">ì „ìí•­ê³µê¶Œ PDF</button>
              <button class="ticket-btn" style="margin-top: 10px; background: linear-gradient(135deg, #8b5cf6, #7c3aed);" onclick="printReservation()">ì˜ˆì•½í™•ì¸ì„œ ì¸ì‡„</button>
            </div>
          </div>
        `;
        
        // ì˜ˆì•½í™•ì¸ì„œ ì°½ì„ ì§€ë„ ìœ„ì— í‘œì‹œ
        document.body.appendChild(reservationDiv);
        
        // ì˜ˆì•½í™•ì¸ì„œ ì°½ ìœ„ì¹˜ ì¡°ì • - ëª¨ë°”ì¼ ìµœì í™”
        setTimeout(() => {
          const mapElement = document.getElementById('map');
          const mapRect = mapElement.getBoundingClientRect();
          
          if (isMobile) {
            // ëª¨ë°”ì¼: í™”ë©´ ì¤‘ì•™ì— í‘œì‹œ
            reservationDiv.style.left = '50%';
            reservationDiv.style.transform = 'translateX(-50%)';
            reservationDiv.style.top = '80px';
          } else {
            // ë°ìŠ¤í¬í†±: ì§€ë„ ì¤‘ì•™ì— í‘œì‹œ
            reservationDiv.style.left = (mapRect.width / 2 - 200) + 'px';
            reservationDiv.style.top = (mapRect.height / 2 - 250) + 'px';
            reservationDiv.style.transform = 'none';
          }
        }, 100);
      }
      
      // ì˜ˆì•½í™•ì¸ì„œ ì¸ì‡„ í•¨ìˆ˜
      function printReservation() {
        window.print();
      }
      
             // ìƒˆ í•­ëª© ì¶”ê°€ í•¨ìˆ˜ (localStorage ì œê±° ë²„ì „)
       async function addNewItem() {
         const titleInput = document.getElementById('newItemTitle');
         const linkInput = document.getElementById('newItemLink');
         
         const title = titleInput.value.trim();
         const link = linkInput.value.trim();
         
         if (!title) {
           updateSyncStatus('í•­ëª© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
           titleInput.focus();
           return;
         }
         
         // ë™ê¸°í™” ì¤‘ì´ë©´ ë¬´ì‹œ
         if (isSyncing) {
           updateSyncStatus('ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'warning');
           return;
         }
         
         // ìƒˆ í•­ëª© ìƒì„± (ê¸°ì¡´ í•­ëª©ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼)
         const newItem = {
           id: 'user_' + Date.now(),
           title: title,
           description: '', // ë¹ˆ ì„¤ëª…ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ê¸°ì¡´ í•­ëª©ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼ ìœ ì§€
           link: link || null,
           checked: false,
           timestamp: new Date().toISOString()
         };
         
         try {
           // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
           isSyncing = true;
           updateSyncStatus('ìƒˆ í•­ëª© ì €ì¥ ì¤‘...', 'info');
           
           // Firebaseì— ì €ì¥
           await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
             userAddedItems: window.firestore.arrayUnion(newItem)
           });
           
           // ì „ì—­ ë³€ìˆ˜ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ë°˜ì˜ì„ ìœ„í•´)
           if (!window.firebaseUserItems) {
             window.firebaseUserItems = [];
           }
           window.firebaseUserItems.push(newItem);
           
           // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
           displayUserAddedItemsFromFirebase(window.firebaseUserItems);
           
           // í¼ ì´ˆê¸°í™”
           clearForm();
           
           // ì„±ê³µ ë©”ì‹œì§€
           updateSyncStatus('ìƒˆ í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
           
           // í•­ëª© ì¶”ê°€ í›„ í¼ ìë™ ìˆ¨ê¸°ê¸°
           hideAddForm();
           
           console.log('Firebaseì— ìƒˆ í•­ëª© ì €ì¥ ì™„ë£Œ ë° UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸');
           
         } catch (error) {
           console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', error);
           updateSyncStatus('í•­ëª© ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
           
           // Firebase ì‹¤íŒ¨ ì‹œ UIë§Œ ì—…ë°ì´íŠ¸ (ì „ì—­ ë³€ìˆ˜ì— ì„ì‹œ ì €ì¥)
           if (!window.firebaseUserItems) {
             window.firebaseUserItems = [];
           }
           window.firebaseUserItems.push(newItem);
           displayUserAddedItemsFromFirebase(window.firebaseUserItems);
           
           // í¼ ì´ˆê¸°í™” ë° ìˆ¨ê¸°ê¸°
           clearForm();
           hideAddForm();
           
           updateSyncStatus('ì„ì‹œ ì €ì¥ë¨ - ì—°ê²° ë³µêµ¬ ì‹œ ë™ê¸°í™”', 'warning');
         } finally {
           // ë™ê¸°í™” ìƒíƒœ í•´ì œ (ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í—ˆìš©)
           isSyncing = false;
         }
       }
      
      // í¼ ì§€ìš°ê¸° í•¨ìˆ˜
      function clearForm() {
        document.getElementById('newItemTitle').value = '';
        document.getElementById('newItemLink').value = '';
        document.getElementById('newItemTitle').focus();
      }
      
      // ì‚¬ìš©ì ì¶”ê°€ í•­ëª©ë“¤ í‘œì‹œ í•¨ìˆ˜ (localStorage ì œê±° - Firebase ì „ìš©)
      function displayUserAddedItems() {
        // ì´ í•¨ìˆ˜ëŠ” í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€í•˜ì§€ë§Œ, 
        // ì‹¤ì œë¡œëŠ” displayUserAddedItemsFromFirebaseë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤
        const userItems = window.firebaseUserItems || [];
        displayUserAddedItemsFromFirebase(userItems);
      }
      

      
      // ì‚¬ìš©ì ì¶”ê°€ í•­ëª© ì‚­ì œ í•¨ìˆ˜ (localStorage ì œê±° ë²„ì „)
      async function deleteUserItem(itemId) {
        if (!confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
        
        // ë™ê¸°í™” ì¤‘ì´ë©´ ë¬´ì‹œ
        if (isSyncing) {
          updateSyncStatus('ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'warning');
          return;
        }
        
        try {
          // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
          isSyncing = true;
          updateSyncStatus('í•­ëª© ì‚­ì œ ì¤‘...', 'info');
          
          // í˜„ì¬ Firebase í•­ëª©ë“¤ì—ì„œ í•´ë‹¹ í•­ëª© ì œê±°
          const currentItems = window.firebaseUserItems || [];
          const updatedUserItems = currentItems.filter(item => item.id !== itemId);
          
          // Firebaseì—ì„œ í•­ëª© ì œê±°
          await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
            userAddedItems: updatedUserItems,
            lastUpdated: window.firestore.serverTimestamp()
          });
          
          // Firebaseì—ì„œ í•´ë‹¹ í•­ëª©ì˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœë„ ì œê±°
          const docSnap = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'));
          if (docSnap.exists() && docSnap.data().preparationCheckboxes) {
            const currentCheckboxStates = { ...docSnap.data().preparationCheckboxes };
            delete currentCheckboxStates[itemId];
            await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
              preparationCheckboxes: currentCheckboxStates,
              lastUpdated: window.firestore.serverTimestamp()
            });
          }
          
          // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
          window.firebaseUserItems = updatedUserItems;
          
          // í™”ë©´ì—ì„œ í•­ëª© ì œê±°
          displayUserAddedItemsFromFirebase(updatedUserItems);
          
          // ê²½ë¡œì œê±°/ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
          updateRouteRemoveButtons();
          
          updateSyncStatus('í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          console.log('Firebaseì—ì„œ í•­ëª© ì‚­ì œ ì™„ë£Œ');
          
                 } catch (error) {
           console.error('Firebase ì‚­ì œ ì‹¤íŒ¨:', error);
           updateSyncStatus('ì‚­ì œ ì‹¤íŒ¨', 'error');
           
           // Firebase ì‹¤íŒ¨ ì‹œ UIë§Œ ì—…ë°ì´íŠ¸
           const currentItems = window.firebaseUserItems || [];
           const updatedUserItems = currentItems.filter(item => item.id !== itemId);
           window.firebaseUserItems = updatedUserItems;
           displayUserAddedItemsFromFirebase(updatedUserItems);
           
           // ê²½ë¡œì œê±°/ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
           updateRouteRemoveButtons();
           
           setTimeout(() => {
             updateSyncStatus('Firebase ì—°ê²° ì‹¤íŒ¨', 'error');
           }, 2000);
         } finally {
           // ë™ê¸°í™” ìƒíƒœ í•´ì œ (ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í—ˆìš©)
           isSyncing = false;
         }
      }
      
             // ì‚¬ìš©ì í•­ëª© ìˆ˜ì • í•¨ìˆ˜
      function editUserItem(itemId, currentTitle, currentDescription, currentLink) {
        // ìˆ˜ì • í¼ í‘œì‹œ
        showEditForm(itemId, currentTitle, currentDescription, currentLink, 'user');
      }
      
      // ê¸°ì¡´ í•­ëª© ìˆ˜ì • í•¨ìˆ˜
      function editExistingItem(itemId, currentTitle, currentDescription, currentLink) {
        // ìˆ˜ì • í¼ í‘œì‹œ
        showEditForm(itemId, currentTitle, currentDescription, currentLink, 'existing');
      }
      
      // ê¸°ì¡´ í•­ëª© ì‚­ì œ í•¨ìˆ˜
      function deleteExistingItem(itemId) {
        if (!confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
        
        // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì œê±°
        const checkbox = document.getElementById(itemId);
        if (checkbox) {
          checkbox.remove();
        }
        
        // í•­ëª© ì œê±°
        const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
        if (itemElement) {
          itemElement.remove();
        }
        
        // ìˆ¨ê¹€ ëª©ë¡ì— ë°˜ì˜ ë° Firebase ì €ì¥
        (async () => {
          try {
            window.hiddenExistingItems = Array.isArray(window.hiddenExistingItems) ? window.hiddenExistingItems : [];
            if (!window.hiddenExistingItems.includes(itemId)) {
              window.hiddenExistingItems.push(itemId);
            }
            // ì¦‰ì‹œ UI ë°˜ì˜
            if (typeof applyOverridesAndHides === 'function') {
              applyOverridesAndHides();
            }
            // ì²´í¬ë°•ìŠ¤ ìƒíƒœë„ ë™ê¸° ì €ì¥
            saveCheckboxStates();
            // Firebase ì €ì¥
            await window.firestore.setDoc(
              window.firestore.doc(window.db, 'users', 'currentUser'),
              { hiddenExistingItems: window.firestore.arrayUnion(itemId), lastUpdated: window.firestore.serverTimestamp() },
              { merge: true }
            );
            updateSyncStatus('í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          } catch (e) {
            console.error('í•­ëª© ì‚­ì œ ë™ê¸°í™” ì‹¤íŒ¨:', e);
            updateSyncStatus('ì‚­ì œëŠ” ë¡œì»¬ì—ë§Œ ë°˜ì˜ë¨', 'warning');
          }
        })();
      }
      
      // ìˆ˜ì • í¼ í‘œì‹œ í•¨ìˆ˜
      function showEditForm(itemId, currentTitle, currentDescription, currentLink, itemType) {
        // ê¸°ì¡´ ìˆ˜ì • í¼ì´ ìˆìœ¼ë©´ ì œê±°
        const existingForm = document.getElementById('editItemForm');
        if (existingForm) {
          existingForm.remove();
        }
        
        // ìˆ˜ì • í¼ ìƒì„±
        const editForm = document.createElement('div');
        editForm.id = 'editItemForm';
        editForm.className = 'edit-item-form';
        editForm.innerHTML = `
          <div class="edit-form-header">
            <h4>í•­ëª© ìˆ˜ì •</h4>
            <button class="close-btn" onclick="closeEditForm()">Ã—</button>
          </div>
          <div class="form-group">
            <input type="text" id="editItemTitle" placeholder="í•­ëª© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="50" value="${currentTitle}">
            <input type="url" id="editItemLink" placeholder="ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)" maxlength="200" value="${currentLink}">
          </div>
          <div class="form-buttons">
            <button type="button" onclick="saveEditedItem('${itemId}', '${itemType}')" class="save-btn">ì €ì¥</button>
            <button type="button" onclick="closeEditForm()" class="cancel-btn">ì·¨ì†Œ</button>
          </div>
        `;
        
        // í¼ì„ í™”ë©´ì— ì¶”ê°€
        document.body.appendChild(editForm);
        
        // í¼ ìœ„ì¹˜ ì¡°ì •
        setTimeout(() => {
          const form = document.getElementById('editItemForm');
          if (form) {
            form.style.left = '50%';
            form.style.transform = 'translateX(-50%)';
            form.style.top = '120px';
          }
        }, 100);
        
        // ì œëª© ì…ë ¥ë€ì— í¬ì»¤ìŠ¤
        setTimeout(() => {
          document.getElementById('editItemTitle').focus();
        }, 100);
      }
      
      // ìˆ˜ì • í¼ ë‹«ê¸° í•¨ìˆ˜
      function closeEditForm() {
        const editForm = document.getElementById('editItemForm');
        if (editForm) {
          editForm.remove();
        }
      }
      
      // ìˆ˜ì •ëœ í•­ëª© ì €ì¥ í•¨ìˆ˜
      async function saveEditedItem(itemId, itemType) {
        const titleInput = document.getElementById('editItemTitle');
        const linkInput = document.getElementById('editItemLink');
        
        const title = titleInput.value.trim();
        const link = linkInput.value.trim();
        
        if (!title) {
          updateSyncStatus('í•­ëª© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
          titleInput.focus();
          return;
        }
        
        if (itemType === 'user') {
          // ì‚¬ìš©ì ì¶”ê°€ í•­ëª© ìˆ˜ì •
          await updateUserItem(itemId, title, link);
        } else {
          // ê¸°ì¡´ í•­ëª© ìˆ˜ì •: ì˜¤ë²„ë¼ì´ë“œ ì €ì¥
          await updateExistingItem(itemId, title, link);
          // ì˜¤ë²„ë¼ì´ë“œ ì •ë³´ Firebase ì €ì¥ ë° ì¦‰ì‹œ ì ìš©
          try {
            window.existingItemOverrides = window.existingItemOverrides || {};
            window.existingItemOverrides[itemId] = { title, link };
            if (typeof applyOverridesAndHides === 'function') {
              applyOverridesAndHides();
            }
            await window.firestore.setDoc(
              window.firestore.doc(window.db, 'users', 'currentUser'),
              { existingItemOverrides: { [itemId]: { title, link } }, lastUpdated: window.firestore.serverTimestamp() },
              { merge: true }
            );
          } catch (e) {
            console.error('ì˜¤ë²„ë¼ì´ë“œ ì €ì¥ ì‹¤íŒ¨:', e);
          }
        }
        
        // ìˆ˜ì • í¼ ë‹«ê¸°
        closeEditForm();
      }
      
      // ì‚¬ìš©ì í•­ëª© ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      async function updateUserItem(itemId, title, link) {
        try {
          // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
          isSyncing = true;
          updateSyncStatus('í•­ëª© ìˆ˜ì • ì¤‘...', 'info');
          
          // í˜„ì¬ í•­ëª© ì°¾ê¸°
          const currentItems = window.firebaseUserItems || [];
          const itemIndex = currentItems.findIndex(item => item.id === itemId);
          
          if (itemIndex === -1) {
            updateSyncStatus('í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            return;
          }
          
          // í•­ëª© ì—…ë°ì´íŠ¸
          const updatedItem = {
            ...currentItems[itemIndex],
            title: title,
            link: link || null,
            timestamp: new Date().toISOString()
          };
          
          currentItems[itemIndex] = updatedItem;
          
          // Firebaseì— ì €ì¥
          await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
            userAddedItems: currentItems,
            lastUpdated: window.firestore.serverTimestamp()
          });
          
          // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
          window.firebaseUserItems = currentItems;
          
          // UI ì—…ë°ì´íŠ¸
          displayUserAddedItemsFromFirebase(currentItems);
          
          updateSyncStatus('í•­ëª©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          
        } catch (error) {
          console.error('Firebase ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
          updateSyncStatus('ìˆ˜ì • ì‹¤íŒ¨', 'error');
        } finally {
          isSyncing = false;
        }
      }
      
      // ê¸°ì¡´ í•­ëª© ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      async function updateExistingItem(itemId, title, link) {
        try {
          // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
          isSyncing = true;
          updateSyncStatus('í•­ëª© ìˆ˜ì • ì¤‘...', 'info');
          
          // HTML ìš”ì†Œ ì—…ë°ì´íŠ¸
          const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
          if (itemElement) {
            const titleSpan = itemElement.querySelector('span');
            if (titleSpan) {
              titleSpan.innerHTML = `${title} - ${link || ''}`;
            }
          }
          
          // Firebaseì— ì €ì¥ (ê¸°ì¡´ í•­ëª©ì€ ì²´í¬ë°•ìŠ¤ ìƒíƒœë§Œ ì €ì¥)
          await saveCheckboxStates();
          
          // ì˜¤ë²„ë¼ì´ë“œ ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸ (í™”ë©´ ì¬ì˜¤í”ˆ ì‹œ ë°˜ì˜)
          window.existingItemOverrides = window.existingItemOverrides || {};
          window.existingItemOverrides[itemId] = { title, link };
          
          updateSyncStatus('í•­ëª©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          
        } catch (error) {
          console.error('í•­ëª© ìˆ˜ì • ì‹¤íŒ¨:', error);
          updateSyncStatus('ìˆ˜ì • ì‹¤íŒ¨', 'error');
        } finally {
          isSyncing = false;
        }
      }
      
      // ì‚¬ìš©ì í•­ëª© ë§í¬ ì—´ê¸° í•¨ìˆ˜
       function openUserItemLink(link) {
         if (!link) return;
         
         try {
           // ìƒˆ íƒ­ì—ì„œ ë§í¬ ì—´ê¸°
           window.open(link, '_blank');
         } catch (error) {
           console.error('ë§í¬ ì—´ê¸° ì‹¤íŒ¨:', error);
           alert('ë§í¬ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ë§í¬ë¥¼ ë³µì‚¬í•˜ì—¬ ì‚¬ìš©í•´ì£¼ì„¸ìš”: ' + link);
         }
       }
       
               // ì¶”ê°€ í¼ í‘œì‹œ í•¨ìˆ˜
        function showAddForm() {
          const form = document.getElementById('addItemForm');
          const toggleBtn = document.getElementById('toggleAddBtn');
          
          // í¼ì„ ë³´ì—¬ì¤„ ë•Œ
          form.style.display = 'block';
          toggleBtn.style.display = 'none'; // ë²„íŠ¼ ìˆ¨ê¸°ê¸°
          
          // ì œëª© ì…ë ¥ë€ì— í¬ì»¤ìŠ¤
          setTimeout(() => {
            document.getElementById('newItemTitle').focus();
          }, 100);
        }
        
        // ì¶”ê°€ í¼ ìˆ¨ê¸°ê¸° í•¨ìˆ˜
        function hideAddForm() {
          const form = document.getElementById('addItemForm');
          const toggleBtn = document.getElementById('toggleAddBtn');
          
          // í¼ì„ ìˆ¨ê¸°ê³  ë²„íŠ¼ì„ ë‹¤ì‹œ í‘œì‹œ
          form.style.display = 'none';
          toggleBtn.style.display = 'block';
          
          // í¼ ë‚´ìš© ì´ˆê¸°í™”
          document.getElementById('newItemTitle').value = '';
          document.getElementById('newItemDescription').value = '';
          document.getElementById('newItemLink').value = '';
        }

      // í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ - ëª¨ë°”ì¼ ìµœì í™”
      function getCurrentLocation() {
        const locationBtn = document.getElementById('locationBtn');
        const isLoading = locationBtn.classList.contains('loading');

        if (isLoading) {
          alert('í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.');
          return;
        }

        // ê¸°ì¡´ ë§ˆì»¤ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì œê±°
        if (currentLocationMarker) {
          // ì—´ë¦° ì •ë³´ì°½ ë‹«ê¸°
          if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }
          currentLocationMarker.setMap(null);
          currentLocationMarker = null;
        }

        locationBtn.classList.add('loading');
        locationBtn.textContent = 'ë¡œë”©ì¤‘...';

        if (navigator.geolocation) {
          // ëª¨ë°”ì¼ì—ì„œ ìœ„ì¹˜ ì •í™•ë„ ìµœì í™”
          const options = {
            enableHighAccuracy: isMobile ? false : true, // ëª¨ë°”ì¼ì—ì„œëŠ” ë°°í„°ë¦¬ ì ˆì•½
            timeout: isMobile ? 10000 : 5000, // ëª¨ë°”ì¼ì—ì„œëŠ” ë” ê¸´ íƒ€ì„ì•„ì›ƒ
            maximumAge: isMobile ? 60000 : 0 // ëª¨ë°”ì¼ì—ì„œëŠ” 1ë¶„ê°„ ìºì‹œëœ ìœ„ì¹˜ í—ˆìš©
          };
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              const currentLocation = { lat: lat, lng: lng };
              
              // í˜„ì¬ ì¤Œ ë ˆë²¨ ìœ ì§€í•˜ë©´ì„œ ì¤‘ì‹¬ë§Œ ì´ë™
              const currentZoom = map.getZoom();
              map.setCenter(currentLocation);
              map.setZoom(currentZoom); // í˜„ì¬ ì¤Œ ë ˆë²¨ ìœ ì§€

              // ìƒˆë¡œìš´ í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€ - ëª¨ë°”ì¼ ìµœì í™”
              currentLocationMarker = new google.maps.Marker({
                position: currentLocation,
                map: map,
                icon: {
                  url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32">
                      <text x="12" y="20" font-family="Arial, sans-serif" font-size="24" text-anchor="middle" fill="#FF0000">ğŸ“</text>
                    </svg>
                  `),
                  scaledSize: new google.maps.Size(isMobile ? 28 : 32, isMobile ? 28 : 32),
                  anchor: new google.maps.Point(isMobile ? 14 : 16, isMobile ? 14 : 16)
                },
                title: 'í˜„ì¬ ìœ„ì¹˜',
                zIndex: 1000, // ë‹¤ë¥¸ ë§ˆì»¤ë³´ë‹¤ ìœ„ì— í‘œì‹œ
                optimized: isMobile ? false : true // ëª¨ë°”ì¼ì—ì„œëŠ” ìµœì í™” ë¹„í™œì„±í™”ë¡œ ì„±ëŠ¥ í–¥ìƒ
              });

              // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ì°½ í‘œì‹œ ë° ì¤Œ ë ˆë²¨ 15ë¡œ ì¡°ì •
              const currentLocationInfoWindow = new google.maps.InfoWindow({
                content: '<div style="padding: 8px; font-size: 14px; line-height: 1.3;"><strong>í˜„ì¬ ìœ„ì¹˜</strong></div>',
                disableAutoPan: false,
                maxWidth: isMobile ? 250 : 300
              });
              
              currentLocationMarker.addListener('click', function() {
                // ê¸°ì¡´ ì •ë³´ì°½ ë‹«ê¸°
                if (currentInfoWindow) {
                  currentInfoWindow.close();
                }
                currentLocationInfoWindow.open(map, currentLocationMarker);
                currentInfoWindow = currentLocationInfoWindow;
                
                // ë§ˆì»¤ ì£¼ìœ„ë¡œ ì¤Œ ë ˆë²¨ 15ë¡œ ì¡°ì •
                map.setCenter(currentLocation);
                map.setZoom(15);
              });

              locationBtn.classList.remove('loading');
              locationBtn.textContent = 'ğŸ“';
            },
            (error) => {
              console.error('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error.message);
              let errorMessage = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
              
              // ëª¨ë°”ì¼ì—ì„œ ë” ìì„¸í•œ ì˜¤ë¥˜ ë©”ì‹œì§€
              if (isMobile) {
                switch(error.code) {
                  case error.PERMISSION_DENIED:
                    errorMessage = 'ìœ„ì¹˜ ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                    break;
                  case error.POSITION_UNAVAILABLE:
                    errorMessage = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    break;
                  case error.TIMEOUT:
                    errorMessage = 'ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    break;
                }
              }
              
              alert(errorMessage);
              locationBtn.classList.remove('loading');
              locationBtn.textContent = 'ğŸ“';
            },
            options
          );
        } else {
          alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          locationBtn.classList.remove('loading');
          locationBtn.textContent = 'ğŸ“';
        }
      }
      
      // ì¤Œ ë ˆë²¨ì— ë”°ë¼ í•­ë¡œì™€ ë§ˆì»¤ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
      function toggleFlightElements(zoomLevel) {
        if (zoomLevel < 10) {
          // ì¤Œ ë ˆë²¨ 10 ë¯¸ë§Œ: í•­ë¡œì™€ ë§ˆì»¤ë“¤ í‘œì‹œ
          if (flightPath) flightPath.setMap(map);
          if (dottedPath) dottedPath.setMap(map);
          if (planeMarker) planeMarker.setMap(map);
          if (incheonMarker) incheonMarker.setMap(map);
          if (chitoseMarker) chitoseMarker.setMap(map);
        } else {
          // ì¤Œ ë ˆë²¨ 10 ì´ìƒ: í•­ë¡œì™€ ë§ˆì»¤ë“¤ ìˆ¨ê¹€
          if (flightPath) flightPath.setMap(null);
          if (dottedPath) dottedPath.setMap(null);
          if (planeMarker) planeMarker.setMap(null);
          if (incheonMarker) incheonMarker.setMap(null);
          if (chitoseMarker) chitoseMarker.setMap(null);
        }
      }
      
      // ì¤Œ ë ˆë²¨ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateZoomLevel() {
        if (map) {
          const zoomLevel = Math.round(map.getZoom());
          const zoomDisplay = document.getElementById('zoomLevelDisplay');
          if (zoomDisplay) {
            zoomDisplay.textContent = `ì¤Œ ${zoomLevel}`;
          }
        }
      }
      

      

      
              
        

      

      

      

      

      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë°”ì¼ ìµœì í™” ë° ë™ê¸°í™” ìƒíƒœ í™•ì¸
      document.addEventListener('DOMContentLoaded', function() {
        optimizeForMobile();
        
        // ë™ê¸°í™” ìƒíƒœ ì´ˆê¸°í™”
        initializeSyncSystem();
        
        // ëª¨ë°”ì¼ì—ì„œ ì¶”ê°€ ìµœì í™”
        if (isMobile) {
          // ëª¨ë°”ì¼ì—ì„œ ë©”íƒ€ íƒœê·¸ ë™ì  ì„¤ì •
          const viewport = document.querySelector('meta[name="viewport"]');
          if (viewport) {
            viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
          }
          
          // ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™”
          document.addEventListener('touchstart', function() {}, { passive: true });
          document.addEventListener('touchmove', function() {}, { passive: true });
          
          // ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ ì„±ëŠ¥ ìµœì í™”
          document.body.style.webkitOverflowScrolling = 'touch';
          
          // ëª¨ë°”ì¼ì—ì„œ ë°°í„°ë¦¬ ì ˆì•½ì„ ìœ„í•œ ì• ë‹ˆë©”ì´ì…˜ ìµœì í™”
          if ('requestAnimationFrame' in window) {
            const originalRAF = window.requestAnimationFrame;
            window.requestAnimationFrame = function(callback) {
              return originalRAF(function(timestamp) {
                callback(timestamp);
              });
            };
          }
        }
        
        // ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (ê°œë°œ ëª¨ë“œì—ì„œë§Œ)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.log('ëª¨ë°”ì¼ ìµœì í™” ì ìš© ì™„ë£Œ');
          console.log('ë””ë°”ì´ìŠ¤ ì •ë³´:', navigator.userAgent);
          console.log('í™”ë©´ í•´ìƒë„:', window.screen.width + 'x' + window.screen.height);
          console.log('ë·°í¬íŠ¸ í¬ê¸°:', window.innerWidth + 'x' + window.innerHeight);
        }
      });
      
      // ë™ê¸°í™” ì‹œìŠ¤í…œ ì´ˆê¸°í™”
      function initializeSyncSystem() {
        // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
        window.addEventListener('online', function() {
          console.log('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨ - ë™ê¸°í™” ì¬ì‹œë„');
          updateSyncStatus('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨ - ë™ê¸°í™” ì¬ì‹œë„', 'info');
          
          // Firebase ë™ê¸°í™” ì¬ì„¤ì •
          if (window.unsubscribeFirebase) {
            window.unsubscribeFirebase();
          }
          setTimeout(() => {
            setupFirebaseSync();
          }, 1000);
        });
        
        window.addEventListener('offline', function() {
          console.log('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€ - ì˜¤í”„ë¼ì¸ ëª¨ë“œ');
          updateSyncStatus('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€ - ì˜¤í”„ë¼ì¸ ëª¨ë“œ', 'warning');
          enableOfflineMode();
        });
        
        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ë™ê¸°í™” ìƒíƒœ í™•ì¸
        document.addEventListener('visibilitychange', function() {
          if (!document.hidden && navigator.onLine) {
            console.log('í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ - ë™ê¸°í™” ìƒíƒœ í™•ì¸');
            updateSyncStatus('ë™ê¸°í™” ìƒíƒœ í™•ì¸ ì¤‘...', 'info');
            
            // Firebase ì—°ê²° ìƒíƒœ í™•ì¸
            setTimeout(() => {
              if (window.db) {
                updateSyncStatus('ë™ê¸°í™” ì—°ê²°ë¨', 'success');
              } else {
                updateSyncStatus('ë™ê¸°í™” ì—°ê²° ì‹¤íŒ¨', 'error');
              }
            }, 1000);
          }
        });
        
        // ì£¼ê¸°ì  ë™ê¸°í™” ìƒíƒœ í™•ì¸ (5ë¶„ë§ˆë‹¤)
        setInterval(() => {
          if (navigator.onLine && window.db && !isSyncing) {
            console.log('ì£¼ê¸°ì  ë™ê¸°í™” ìƒíƒœ í™•ì¸');
            updateSyncStatus('ë™ê¸°í™” ìƒíƒœ í™•ì¸ ì¤‘...', 'info');
            
            // ê°„ë‹¨í•œ ì—°ê²° í…ŒìŠ¤íŠ¸
            window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'))
              .then(() => {
                updateSyncStatus('ë™ê¸°í™” ì •ìƒ', 'success');
              })
              .catch(() => {
                updateSyncStatus('ë™ê¸°í™” ì—°ê²° ì‹¤íŒ¨', 'error');
                enableOfflineMode();
              });
          }
        }, 5 * 60 * 1000); // 5ë¶„
      }
      
      // ë§ˆì»¤ìƒì„± ëª¨ë“œ í† ê¸€ í•¨ìˆ˜
      function toggleMarkerMode() {
        console.log('toggleMarkerMode í˜¸ì¶œë¨, isMarkerMode:', isMarkerMode, 'customMarkers.length:', customMarkers.length);
        
        if (isMarkerMode) {
          console.log('ë§ˆì»¤ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìŒ');
          console.log('customMarkers ë°°ì—´:', customMarkers);
          console.log('customMarkers.length:', customMarkers.length);
          
          // ë²„íŠ¼ í…ìŠ¤íŠ¸ í™•ì¸
          const markerBtn = document.getElementById('topMarkerBtn');
          const buttonText = markerBtn.textContent;
          console.log('í˜„ì¬ ë²„íŠ¼ í…ìŠ¤íŠ¸:', buttonText);
          
          // ë§ˆì»¤ê°€ ìƒì„±ë˜ì–´ ìˆê³  "ë§ˆì»¤ì™„ì„±" ìƒíƒœë¼ë©´ ì €ì¥ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
          if (customMarkers.length > 0 || buttonText === 'ë§ˆì»¤ì™„ì„±') {
            console.log('ë§ˆì»¤ì™„ì„± ìƒíƒœ: showMarkerSaveDialog í˜¸ì¶œ');
            
            try {
              showMarkerSaveDialog();
              console.log('showMarkerSaveDialog í˜¸ì¶œ ì„±ê³µ');
            } catch (error) {
              console.error('showMarkerSaveDialog í˜¸ì¶œ ì‹¤íŒ¨:', error);
              // ëŒ€ì•ˆ: ì§ì ‘ ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
              createMarkerSaveDialogDirectly();
            }
            
            // ë§ˆì»¤ ëª¨ë“œ ë¹„í™œì„±í™”í•˜ì—¬ ë” ì´ìƒ ë§ˆì»¤ ìƒì„± ë°©ì§€
            isMarkerMode = false;
            markerBtn.textContent = 'ë§ˆì»¤ìƒì„±';
            markerBtn.style.background = 'rgba(255, 255, 255, 0.12)';
            markerBtn.style.color = '#1a1a1a';
            return;
          }
          
          // ë§ˆì»¤ìƒì„± ëª¨ë“œ ë¹„í™œì„±í™”
          isMarkerMode = false;
          markerBtn.textContent = 'ë§ˆì»¤ìƒì„±';
          markerBtn.style.background = 'rgba(255, 255, 255, 0.12)';
          markerBtn.style.color = '#1a1a1a';
          
          // ë§ˆì»¤ìƒì„± ëª¨ë“œ ì•ˆë‚´ ë©”ì‹œì§€ ì œê±°
          if (window.markerModeMessage) {
            window.markerModeMessage.remove();
            window.markerModeMessage = null;
          }
          
          console.log('ë§ˆì»¤ìƒì„± ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          // ê²½ë¡œ ìƒì„± ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë¹„í™œì„±í™”
          if (isRouteMode) {
            // ê²½ë¡œ ìƒì„± ëª¨ë“œ ë¹„í™œì„±í™”
            isRouteMode = false;
            const routeBtn = document.getElementById('topRouteBtn');
            routeBtn.textContent = 'ê²½ë¡œ ìƒì„±';
            routeBtn.style.background = 'rgba(255, 255, 255, 0.12)';
            routeBtn.style.color = '#1a1a1a';
            
            // ê²½ë¡œ ê´€ë ¨ ë§ˆì»¤ë“¤ ì œê±°
            userRouteMarkers.forEach(marker => marker.setMap(null));
            userRouteMarkers = [];
            
            // ê²½ë¡œ í´ë¦¬ë¼ì¸ ì œê±°
            if (userRoutePath) {
              userRoutePath.setMap(null);
              userRoutePath = null;
            }
            if (userRouteDottedPath) {
              userRouteDottedPath.setMap(null);
              userRouteDottedPath = null;
            }
          }
          
          // ë§ˆì»¤ìƒì„± ëª¨ë“œ í™œì„±í™”
          isMarkerMode = true;
          const markerBtn = document.getElementById('topMarkerBtn');
          markerBtn.textContent = 'ë§ˆì»¤ìƒì„± ì¤‘...';
          markerBtn.style.background = 'linear-gradient(135deg, #8b5cf6, #7c3aed)';
          markerBtn.style.color = 'white';
          
          // ì•ˆë‚´ ë©”ì‹œì§€ ì—†ì´ ë°”ë¡œ ì‹œì‘
          console.log('ë§ˆì»¤ìƒì„± ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ë§ˆì»¤ë¥¼ ìƒì„±í•˜ì„¸ìš”.');
        }
      }
      
      // ë§ˆì»¤ìƒì„± ëª¨ë“œ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
      function showMarkerModeMessage() {
        // ê¸°ì¡´ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì œê±°
        if (window.markerModeMessage) {
          window.markerModeMessage.remove();
        }
        
        // ì•ˆë‚´ ë©”ì‹œì§€ ìƒì„±
        const message = document.createElement('div');
        message.id = 'markerModeMessage';
        message.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          z-index: 1000;
          font-size: 16px;
          max-width: 300px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        `;
        message.innerHTML = `
          <div style="margin-bottom: 15px;">ğŸ“</div>
          <div style="font-weight: bold; margin-bottom: 10px;">ë§ˆì»¤ìƒì„± ëª¨ë“œ</div>
          <div>ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì›í•˜ëŠ” ìœ„ì¹˜ì— ë§ˆì»¤ë¥¼ ìƒì„±í•˜ì„¸ìš”.</div>
          <div style="margin-top: 10px; font-size: 14px; opacity: 0.8;">ë§ˆì»¤ë¥¼ í´ë¦­í•˜ë©´ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        `;
        
        document.body.appendChild(message);
        window.markerModeMessage = message;
        
        // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ë©”ì‹œì§€ ì œê±°
        setTimeout(() => {
          if (message.parentNode) {
            message.remove();
            window.markerModeMessage = null;
          }
        }, 3000);
      }
      
      // ì‚¬ìš©ì ì •ì˜ ë§ˆì»¤ ì¶”ê°€ í•¨ìˆ˜
      function addCustomMarker(latLng) {
        // ë§ˆì»¤ ìƒì„±
        const marker = new google.maps.Marker({
          position: latLng,
          map: map,
          title: `ì‚¬ìš©ì ë§ˆì»¤ ${customMarkers.length + 1}`,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#8b5cf6',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2,
            scale: 10
          },
          label: {
            text: (customMarkers.length + 1).toString(),
            fontSize: '14px',
            fontWeight: 'bold',
            color: '#ffffff'
          }
        });
        
        // ë§ˆì»¤ í´ë¦­ ì‹œ ì œê±° ê¸°ëŠ¥
        marker.addListener('click', function() {
          if (confirm('ì´ ë§ˆì»¤ë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            removeCustomMarker(marker);
          }
        });
        
        customMarkers.push(marker);
        console.log('ë§ˆì»¤ ì¶”ê°€ë¨, í˜„ì¬ customMarkers.length:', customMarkers.length);
        
        // ë§ˆì»¤ê°€ ìƒì„±ë˜ë©´ ë²„íŠ¼ì„ "ë§ˆì»¤ì™„ì„±"ìœ¼ë¡œ ë³€ê²½
        if (customMarkers.length >= 1) {
          const markerBtn = document.getElementById('topMarkerBtn');
          markerBtn.textContent = 'ë§ˆì»¤ì™„ì„±';
          markerBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          markerBtn.style.color = 'white';
          console.log('ë²„íŠ¼ì„ "ë§ˆì»¤ì™„ì„±"ìœ¼ë¡œ ë³€ê²½');
        }
        
        // ì„±ê³µ ë©”ì‹œì§€
        console.log(`ë§ˆì»¤ ${customMarkers.length}ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
      
      // ì‚¬ìš©ì ì •ì˜ ë§ˆì»¤ ì œê±° í•¨ìˆ˜
      function removeCustomMarker(marker) {
        console.log('removeCustomMarker í˜¸ì¶œë¨, í˜„ì¬ customMarkers.length:', customMarkers.length);
        const index = customMarkers.indexOf(marker);
        if (index > -1) {
          marker.setMap(null);
          customMarkers.splice(index, 1);
          console.log('ë§ˆì»¤ ì œê±°ë¨, í˜„ì¬ customMarkers.length:', customMarkers.length);
          
          // ë§ˆì»¤ ë²ˆí˜¸ ì¬ì •ë ¬
          customMarkers.forEach((m, i) => {
            m.setTitle(`ì‚¬ìš©ì ë§ˆì»¤ ${i + 1}`);
            m.setLabel({
              text: (i + 1).toString(),
              fontSize: '14px',
              fontWeight: 'bold',
              color: '#ffffff'
            });
          });
          
          // ë§ˆì»¤ê°€ ëª¨ë‘ ì œê±°ë˜ë©´ ë²„íŠ¼ì„ "ë§ˆì»¤ìƒì„± ì¤‘..."ìœ¼ë¡œ ë³€ê²½
          if (customMarkers.length === 0) {
            const markerBtn = document.getElementById('topMarkerBtn');
            markerBtn.textContent = 'ë§ˆì»¤ìƒì„± ì¤‘...';
            markerBtn.style.background = 'linear-gradient(135deg, #8b5cf6, #7c3aed)';
            markerBtn.style.color = 'white';
            console.log('ë²„íŠ¼ì„ "ë§ˆì»¤ìƒì„± ì¤‘..."ìœ¼ë¡œ ë³€ê²½');
          }
          
          console.log(`ë§ˆì»¤ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚¨ì€ ë§ˆì»¤: ${customMarkers.length}ê°œ`);
        }
      }
      
      // ì‚¬ìš©ì ê²½ë¡œ ëª¨ë“œ í† ê¸€ í•¨ìˆ˜
      function toggleRouteMode() {
        // ë§ˆì»¤ìƒì„± ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë¹„í™œì„±í™”
        if (isMarkerMode) {
          toggleMarkerMode();
        }
        
        if (userRouteMarkers.length === 0) {
          // ì²« ë²ˆì§¸ í´ë¦­: ê²½ë¡œ ìƒì„± ëª¨ë“œ ì‹œì‘
          isRouteMode = true;
          const routeBtn = document.getElementById('topRouteBtn');
          routeBtn.textContent = 'ê²½ë¡œ ìƒì„± ì¤‘...';
          routeBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
          routeBtn.style.color = 'white';
          
          alert('ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ê²½ë¡œì˜ ì²« ë²ˆì§¸ ìœ„ì¹˜ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.\nì—¬ëŸ¬ ìœ„ì¹˜ë¥¼ ìˆœì„œëŒ€ë¡œ í´ë¦­í•˜ë©´ ìë™ìœ¼ë¡œ ê²½ë¡œê°€ ìƒì„±ë©ë‹ˆë‹¤.');
        } else if (userRouteMarkers.length >= 2) {
          // ë§ˆì»¤ê°€ 2ê°œ ì´ìƒì¼ ë•Œ: ê²½ë¡œì™„ì„± ëª¨ë“œ
          const routeBtn = document.getElementById('topRouteBtn');
          routeBtn.textContent = 'ê²½ë¡œì™„ì„±';
          routeBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          routeBtn.style.color = 'white';
          
          // ê²½ë¡œ ì €ì¥ ìœ„ì¹˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
          showRouteSaveDialog();
        }
      }
      
      // ì‚¬ìš©ì ê²½ë¡œì— ìœ„ì¹˜ ì¶”ê°€ í•¨ìˆ˜
      function addUserRoutePoint(latLng) {
        if (!isRouteMode) return;
        
        // ë§ˆì»¤ ìƒì„±
        const marker = new google.maps.Marker({
          position: latLng,
          map: map,
          title: `ìœ„ì¹˜ ${userRouteMarkers.length + 1}`,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#ef4444',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2,
            scale: 8
          },
          label: {
            text: (userRouteMarkers.length + 1).toString(),
            fontSize: '12px',
            fontWeight: 'bold',
            color: '#ffffff'
          }
        });
        
        // ë§ˆì»¤ í´ë¦­ ì‹œ ì œê±° ê¸°ëŠ¥
        marker.addListener('click', function() {
          if (confirm('ì´ ìœ„ì¹˜ë¥¼ ê²½ë¡œì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            removeUserRoutePoint(marker);
          }
        });
        
        userRouteMarkers.push(marker);
        
        // ê²½ë¡œ ì—…ë°ì´íŠ¸
        updateUserRoute();
        
        // ë§ˆì»¤ê°€ 2ê°œ ì´ìƒì¼ ë•Œ ë²„íŠ¼ì„ "ê²½ë¡œì™„ì„±"ìœ¼ë¡œ ë³€ê²½
        if (userRouteMarkers.length >= 2) {
          const routeBtn = document.getElementById('topRouteBtn');
          routeBtn.textContent = 'ê²½ë¡œì™„ì„±';
          routeBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          routeBtn.style.color = 'white';
        }
        
        // ì„±ê³µ ë©”ì‹œì§€
        const message = userRouteMarkers.length === 1 ? 
          'ì²« ë²ˆì§¸ ìœ„ì¹˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ê³„ì†í•´ì„œ ë‹¤ìŒ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.' :
          `ìœ„ì¹˜ ${userRouteMarkers.length}ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`;
        console.log(message);
      }
      
      // ì‚¬ìš©ì ê²½ë¡œì—ì„œ ìœ„ì¹˜ ì œê±° í•¨ìˆ˜
      function removeUserRoutePoint(marker) {
        const index = userRouteMarkers.indexOf(marker);
        if (index > -1) {
          marker.setMap(null);
          userRouteMarkers.splice(index, 1);
          
          // ë§ˆì»¤ ë²ˆí˜¸ ì¬ì •ë ¬
          userRouteMarkers.forEach((m, i) => {
            m.setTitle(`ìœ„ì¹˜ ${i + 1}`);
            m.setLabel({
              text: (i + 1).toString(),
              fontSize: '12px',
              fontWeight: 'bold',
              color: '#ffffff'
            });
          });
          
          // ê²½ë¡œ ì—…ë°ì´íŠ¸
          updateUserRoute();
          
          // ë§ˆì»¤ê°€ 2ê°œ ë¯¸ë§Œì¼ ë•Œ ë²„íŠ¼ì„ "ê²½ë¡œ ìƒì„± ì¤‘..."ìœ¼ë¡œ ë³€ê²½
          if (userRouteMarkers.length < 2) {
            const routeBtn = document.getElementById('topRouteBtn');
            routeBtn.textContent = 'ê²½ë¡œ ìƒì„± ì¤‘...';
            routeBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            routeBtn.style.color = 'white';
          }
        }
      }
      
      // ì‚¬ìš©ì ê²½ë¡œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateUserRoute() {
        // ê¸°ì¡´ ê²½ë¡œ ì œê±°
        if (userRoutePath) {
          userRoutePath.setMap(null);
        }
        if (userRouteDottedPath) {
          userRouteDottedPath.setMap(null);
        }
        
        // ë§ˆì»¤ê°€ 2ê°œ ì´ìƒì¼ ë•Œë§Œ ê²½ë¡œ ìƒì„±
        if (userRouteMarkers.length >= 2) {
          const path = userRouteMarkers.map(marker => marker.getPosition());
          
          // ë©”ì¸ ê²½ë¡œ (íŒŒë€ìƒ‰)
          userRoutePath = new google.maps.Polyline({
            path: path,
            geodesic: true,
            strokeColor: '#3b82f6',
            strokeOpacity: 0.8,
            strokeWeight: 4
          });
          userRoutePath.setMap(map);
          
          // ì ì„  íš¨ê³¼ (í°ìƒ‰ ì ë“¤)
          userRouteDottedPath = new google.maps.Polyline({
            path: path,
            geodesic: true,
            strokeColor: '#ffffff',
            strokeOpacity: 0.9,
            strokeWeight: 2,
            icons: [{
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: '#3b82f6',
                fillOpacity: 1,
                strokeColor: '#ffffff',
                strokeWeight: 1,
                scale: 6
              },
              offset: '0',
              repeat: '15px'
            }]
          });
          userRouteDottedPath.setMap(map);
          
          // ê²½ë¡œ ì •ë³´ í‘œì‹œ
          const totalDistance = calculateRouteDistance(path);
          console.log(`ê²½ë¡œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ê±°ë¦¬: ${totalDistance.toFixed(1)}km`);
        }
      }
      
      // ê²½ë¡œ ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜
      function calculateRouteDistance(path) {
        let totalDistance = 0;
        for (let i = 1; i < path.length; i++) {
          const prev = path[i - 1];
          const curr = path[i];
          totalDistance += google.maps.geometry.spherical.computeDistanceBetween(prev, curr);
        }
        return totalDistance / 1000; // km ë‹¨ìœ„ë¡œ ë³€í™˜
      }
      
      // ì‚¬ìš©ì ê²½ë¡œ ì´ˆê¸°í™” í•¨ìˆ˜
      function clearUserRoute() {
        if (!confirm('ìƒì„±ëœ ê²½ë¡œë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì €ì¥ëœ ê²½ë¡œë„ í•¨ê»˜ ì œê±°ë©ë‹ˆë‹¤)')) {
          return;
        }
        
        // ëª¨ë“  ë§ˆì»¤ ì œê±°
        userRouteMarkers.forEach(marker => {
          marker.setMap(null);
        });
        userRouteMarkers = [];
        
        // ê²½ë¡œ ì œê±°
        if (userRoutePath) {
          userRoutePath.setMap(null);
          userRoutePath = null;
        }
        if (userRouteDottedPath) {
          userRouteDottedPath.setMap(null);
          userRouteDottedPath = null;
        }
        
        // ì €ì¥ëœ ëª¨ë“  ê²½ë¡œ ì œê±°
        savedUserRoutes.forEach(route => {
          if (route.pathElement) {
            route.pathElement.setMap(null);
          }
          if (route.dottedPathElement) {
            route.dottedPathElement.setMap(null);
          }
        });
        savedUserRoutes = [];
        
        // ê²½ë¡œ ëª¨ë“œ ë¹„í™œì„±í™”
        isRouteMode = false;
        const routeBtn = document.getElementById('topRouteBtn');
        const clearRouteBtn = document.getElementById('clearRouteBtn');
        
        routeBtn.textContent = 'ê²½ë¡œ ìƒì„±';
        routeBtn.style.background = 'rgba(255, 255, 255, 0.12)';
        routeBtn.style.color = '#1a1a1a';
        clearRouteBtn.style.display = 'none';
        
        alert('ëª¨ë“  ê²½ë¡œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
      
      // ê²½ë¡œ ì´ˆê¸°í™” ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜
      function updateClearRouteButton() {
        const clearRouteBtn = document.getElementById('clearRouteBtn');
        if (clearRouteBtn) {
          clearRouteBtn.style.display = userRouteMarkers.length > 0 ? 'block' : 'none';
        }
      }
      
      // ê²½ë¡œ ì €ì¥ ìœ„ì¹˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
      function showRouteSaveDialog() {
        // ê¸°ì¡´ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ìˆìœ¼ë©´ ì œê±°
        const existingDialog = document.getElementById('routeSaveDialog');
        if (existingDialog) {
          existingDialog.remove();
        }
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
        const dialogDiv = document.createElement('div');
        dialogDiv.id = 'routeSaveDialog';
        dialogDiv.innerHTML = `
          <div class="info-header">
            <h3>ê²½ë¡œ ì €ì¥ ìœ„ì¹˜ ì„ íƒ</h3>
            <button class="close-btn" onclick="closeRouteSaveDialog()">Ã—</button>
          </div>
          <div class="info-content">
            <div class="info-section">
              <h4>ì–´ë””ì— ê²½ë¡œë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h4>
              <div class="route-save-options">
                <button class="route-save-btn" onclick="saveRouteToLocation('ì‚¬ì „ì¤€ë¹„')">ì‚¬ì „ì¤€ë¹„</button>
                <button class="route-save-btn" onclick="saveRouteToLocation('1ì¼ì°¨')">1ì¼ì°¨</button>
                <button class="route-save-btn" onclick="saveRouteToLocation('ìƒˆë¡œìš´ í•­ëª©')">ìƒˆë¡œìš´ í•­ëª©</button>
              </div>
            </div>
          </div>
        `;
        
        // ë‹¤ì´ì–¼ë¡œê·¸ë¥¼ ì§€ë„ ìœ„ì— í‘œì‹œ
        document.body.appendChild(dialogDiv);
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ìœ„ì¹˜ ì¡°ì • - ëª¨ë°”ì¼ ìµœì í™”
        setTimeout(() => {
          const mapElement = document.getElementById('map');
          const mapRect = mapElement.getBoundingClientRect();
          
          if (isMobile) {
            // ëª¨ë°”ì¼: í™”ë©´ ì¤‘ì•™ì— í‘œì‹œ
            dialogDiv.style.left = '50%';
            dialogDiv.style.transform = 'translateX(-50%)';
            dialogDiv.style.top = '80px';
          } else {
            // ë°ìŠ¤í¬í†±: ì§€ë„ ì¤‘ì•™ì— í‘œì‹œ
            dialogDiv.style.left = (mapRect.width / 2 - 200) + 'px';
            dialogDiv.style.top = (mapRect.height / 2 - 150) + 'px';
            dialogDiv.style.transform = 'none';
          }
        }, 100);
      }
      
      // ê²½ë¡œ ì €ì¥ ìœ„ì¹˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
      function closeRouteSaveDialog() {
        const dialog = document.getElementById('routeSaveDialog');
        if (dialog) {
          dialog.remove();
        }
      }
      
      // ì„ íƒëœ ìœ„ì¹˜ì— ê²½ë¡œ ì €ì¥ (ê°œì„ ëœ ë²„ì „)
      async function saveRouteToLocation(location) {
        if (userRouteMarkers.length < 2) {
          updateSyncStatus('ê²½ë¡œë¥¼ ìƒì„±í•˜ë ¤ë©´ ìµœì†Œ 2ê°œì˜ ìœ„ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤', 'error');
          return;
        }
        
        // ë™ê¸°í™” ì¤‘ì´ë©´ ë¬´ì‹œ
        if (isSyncing) {
          updateSyncStatus('ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'warning');
          return;
        }
        
        // ê²½ë¡œ ë°ì´í„° ìƒì„±
        const routeData = {
          id: 'route_' + Date.now(),
          name: `${location} ê²½ë¡œ`,
          location: location,
          path: userRouteMarkers.map(marker => ({
            lat: marker.getPosition().lat(),
            lng: marker.getPosition().lng()
          })),
          distance: calculateRouteDistance(userRouteMarkers.map(marker => marker.getPosition())),
          createdAt: new Date().toISOString()
        };
        
        try {
          // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
          isSyncing = true;
          updateSyncStatus('ê²½ë¡œ ì €ì¥ ì¤‘...', 'info');
          
          // Firebaseì— ì €ì¥
          await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
            savedUserRoutes: window.firestore.arrayUnion(routeData),
            lastUpdated: window.firestore.serverTimestamp()
          });
          
          // ì „ì—­ ë³€ìˆ˜ì— ì¶”ê°€
          savedUserRoutes.push(routeData);
          
          // ë¡œì»¬ ë°±ì—… ì œê±°: Firestoreë§Œ ì‚¬ìš©
          
          console.log('Firebaseì— ê²½ë¡œ ì €ì¥ ì™„ë£Œ');
          updateSyncStatus('ê²½ë¡œ ì €ì¥ ì™„ë£Œ', 'success');
          
        } catch (error) {
          console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', error);
          updateSyncStatus('Firebase ì €ì¥ ì‹¤íŒ¨', 'error');
          
          // ì „ì—­ ë³€ìˆ˜ì— ì¶”ê°€
          savedUserRoutes.push(routeData);
          
          setTimeout(() => {
            updateSyncStatus('Firebase ì—°ê²° ì‹¤íŒ¨', 'error');
          }, 2000);
        } finally {
          // ë™ê¸°í™” ìƒíƒœ í•´ì œ (ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í—ˆìš©)
          isSyncing = false;
        }
        
        // ì„ì‹œ ë§ˆì»¤ë“¤ ì œê±°
        userRouteMarkers.forEach(marker => {
          marker.setMap(null);
        });
        userRouteMarkers = [];
        
        // ì„ì‹œ ê²½ë¡œ ì œê±°
        if (userRoutePath) {
          userRoutePath.setMap(null);
          userRoutePath = null;
        }
        if (userRouteDottedPath) {
          userRouteDottedPath.setMap(null);
          userRouteDottedPath = null;
        }
        
        // ê²½ë¡œ ëª¨ë“œ ë¹„í™œì„±í™”
        isRouteMode = false;
        
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        const routeBtn = document.getElementById('topRouteBtn');
        routeBtn.textContent = 'ê²½ë¡œ ìƒì„±';
        routeBtn.style.background = 'rgba(255, 255, 255, 0.12)';
        routeBtn.style.color = '#1a1a1a';
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
        closeRouteSaveDialog();
        
        // ì €ì¥ëœ ê²½ë¡œë“¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        drawAllSavedRoutes();
        
        // ê²½ë¡œì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateRouteRemoveButtons();
        // ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateMarkerRemoveButtons();
      }
      
      // ë§ˆì»¤ ì €ì¥ ìœ„ì¹˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ì§ì ‘ ìƒì„± (ëŒ€ì•ˆ í•¨ìˆ˜)
      function createMarkerSaveDialogDirectly() {
        console.log('createMarkerSaveDialogDirectly í•¨ìˆ˜ í˜¸ì¶œë¨');
        
        // ê¸°ì¡´ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ìˆìœ¼ë©´ ì œê±°
        const existingDialog = document.getElementById('markerSaveDialog');
        if (existingDialog) {
          existingDialog.remove();
        }
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
        const dialogDiv = document.createElement('div');
        dialogDiv.id = 'markerSaveDialog';
        dialogDiv.style.cssText = `
          position: fixed;
          z-index: 1000;
          width: 400px;
          max-width: 90vw;
          background: rgba(255, 255, 255, 0.95);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 16px;
          box-shadow: 0 12px 32px rgba(0,0,0,0.15);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          overflow: hidden;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
        `;
        
        dialogDiv.innerHTML = `
          <div style="padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.1);">
            <h3 style="margin: 0; color: #1a1a1a;">ë§ˆì»¤ ì €ì¥ ìœ„ì¹˜ ì„ íƒ</h3>
            <button onclick="closeMarkerSaveDialog()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">Ã—</button>
          </div>
          <div style="padding: 20px;">
            <h4 style="margin: 0 0 20px 0; color: #1a1a1a;">ì–´ë””ì— ë§ˆì»¤ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h4>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <button onclick="saveMarkersToLocation('ì‚¬ì „ì¤€ë¹„')" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; border-radius: 8px; padding: 12px 16px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">ì‚¬ì „ì¤€ë¹„</button>
              <button onclick="saveMarkersToLocation('1ì¼ì°¨')" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; border-radius: 8px; padding: 12px 16px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">1ì¼ì°¨</button>
              <button onclick="saveMarkersToLocation('ìƒˆë¡œìš´ í•­ëª©')" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; border-radius: 8px; padding: 12px 16px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">ìƒˆë¡œìš´ í•­ëª©</button>
            </div>
          </div>
        `;
        
        console.log('ëŒ€ì•ˆ ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„± ì™„ë£Œ');
        document.body.appendChild(dialogDiv);
      }
      
      // ë§ˆì»¤ ì €ì¥ ìœ„ì¹˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
      function showMarkerSaveDialog() {
        console.log('showMarkerSaveDialog í•¨ìˆ˜ í˜¸ì¶œë¨');
        
        // ê¸°ì¡´ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ìˆìœ¼ë©´ ì œê±°
        const existingDialog = document.getElementById('markerSaveDialog');
        if (existingDialog) {
          existingDialog.remove();
        }
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
        const dialogDiv = document.createElement('div');
        dialogDiv.id = 'markerSaveDialog';
        dialogDiv.innerHTML = `
          <div class="info-header">
            <h3>ë§ˆì»¤ ì €ì¥ ìœ„ì¹˜ ì„ íƒ</h3>
            <button class="close-btn" onclick="closeMarkerSaveDialog()">Ã—</button>
          </div>
          <div class="info-content">
            <div class="info-section">
              <h4>ì–´ë””ì— ë§ˆì»¤ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h4>
              <div class="route-save-options">
                <button class="route-save-btn" onclick="saveMarkersToLocation('ì‚¬ì „ì¤€ë¹„')">ì‚¬ì „ì¤€ë¹„</button>
                <button class="route-save-btn" onclick="saveMarkersToLocation('1ì¼ì°¨')">1ì¼ì°¨</button>
                <button class="route-save-btn" onclick="saveMarkersToLocation('ìƒˆë¡œìš´ í•­ëª©')">ìƒˆë¡œìš´ í•­ëª©</button>
              </div>
            </div>
          </div>
        `;
        
        // ë‹¤ì´ì–¼ë¡œê·¸ë¥¼ ì§€ë„ ìœ„ì— í‘œì‹œ
        console.log('ë‹¤ì´ì–¼ë¡œê·¸ DOMì— ì¶”ê°€:', dialogDiv);
        document.body.appendChild(dialogDiv);
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ìœ„ì¹˜ ì¡°ì • - ëª¨ë°”ì¼ ìµœì í™”
        setTimeout(() => {
          const mapElement = document.getElementById('map');
          const mapRect = mapElement.getBoundingClientRect();
          
          if (isMobile) {
            // ëª¨ë°”ì¼: í™”ë©´ ì¤‘ì•™ì— í‘œì‹œ
            dialogDiv.style.left = '50%';
            dialogDiv.style.transform = 'translateX(-50%)';
            dialogDiv.style.top = '80px';
          } else {
            // ë°ìŠ¤í¬í†±: ì§€ë„ ì¤‘ì•™ì— í‘œì‹œ
            dialogDiv.style.left = (mapRect.width / 2 - 200) + 'px';
            dialogDiv.style.top = (mapRect.height / 2 - 150) + 'px';
            dialogDiv.style.transform = 'none';
          }
          console.log('ë‹¤ì´ì–¼ë¡œê·¸ ìœ„ì¹˜ ì„¤ì • ì™„ë£Œ');
        }, 100);
      }
      
      // ë§ˆì»¤ ì €ì¥ ìœ„ì¹˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
      function closeMarkerSaveDialog() {
        const dialog = document.getElementById('markerSaveDialog');
        if (dialog) {
          dialog.remove();
        }
        
        // ë‹¤ì´ì–¼ë¡œê·¸ê°€ ë‹«í ë•Œ ë§ˆì»¤ ëª¨ë“œê°€ ì™„ì „íˆ ë¹„í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (isMarkerMode) {
          isMarkerMode = false;
          const markerBtn = document.getElementById('topMarkerBtn');
          markerBtn.textContent = 'ë§ˆì»¤ìƒì„±';
          markerBtn.style.background = 'rgba(255, 255, 255, 0.12)';
          markerBtn.style.color = '#1a1a1a';
        }
      }
      
      // ì„ íƒëœ ìœ„ì¹˜ì— ë§ˆì»¤ ì €ì¥
      // ì„ íƒëœ ìœ„ì¹˜ì— ë§ˆì»¤ ì €ì¥ (ê°œì„ ëœ ë²„ì „)
      async function saveMarkersToLocation(location) {
        if (customMarkers.length === 0) {
          updateSyncStatus('ì €ì¥í•  ë§ˆì»¤ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
          return;
        }
        
        // ë™ê¸°í™” ì¤‘ì´ë©´ ë¬´ì‹œ
        if (isSyncing) {
          updateSyncStatus('ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'warning');
          return;
        }
        
        // ë§ˆì»¤ ë°ì´í„° ìƒì„±
        const markerData = {
          id: 'marker_' + Date.now(),
          name: `${location} ë§ˆì»¤`,
          location: location,
          markers: customMarkers.map(marker => ({
            lat: marker.getPosition().lat(),
            lng: marker.getPosition().lng(),
            title: marker.getTitle()
          })),
          createdAt: new Date().toISOString()
        };
        
        try {
          // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
          isSyncing = true;
          updateSyncStatus('ë§ˆì»¤ ì €ì¥ ì¤‘...', 'info');
          
          // Firebaseì— ì €ì¥
          await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
            savedUserMarkers: window.firestore.arrayUnion(markerData),
            lastUpdated: window.firestore.serverTimestamp()
          });
          
          // ì „ì—­ ë³€ìˆ˜ì— ì¶”ê°€
          if (!window.savedUserMarkers) {
            window.savedUserMarkers = [];
          }
          window.savedUserMarkers.push(markerData);
          
          // ë¡œì»¬ ë°±ì—… ì œê±°: Firestoreë§Œ ì‚¬ìš©
          
          console.log('Firebaseì— ë§ˆì»¤ ì €ì¥ ì™„ë£Œ');
          updateSyncStatus('ë§ˆì»¤ ì €ì¥ ì™„ë£Œ', 'success');
          
        } catch (error) {
          console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', error);
          updateSyncStatus('Firebase ì €ì¥ ì‹¤íŒ¨', 'error');
          
          // ì „ì—­ ë³€ìˆ˜ì— ì¶”ê°€
          if (!window.savedUserMarkers) {
            window.savedUserMarkers = [];
          }
          window.savedUserMarkers.push(markerData);
          
          setTimeout(() => {
            updateSyncStatus('Firebase ì—°ê²° ì‹¤íŒ¨', 'error');
          }, 2000);
        } finally {
          // ë™ê¸°í™” ìƒíƒœ í•´ì œ (ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í—ˆìš©)
          isSyncing = false;
        }
        
        // ì„ì‹œ ë§ˆì»¤ë“¤ ì œê±°
        customMarkers.forEach(marker => {
          marker.setMap(null);
        });
        customMarkers = [];
        
        // ë§ˆì»¤ ëª¨ë“œê°€ ì•„ì§ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ë¹„í™œì„±í™” (ì¤‘ë³µ ë°©ì§€)
        if (isMarkerMode) {
          isMarkerMode = false;
          
          // ë²„íŠ¼ ìƒíƒœ ë³µì›
          const markerBtn = document.getElementById('topMarkerBtn');
          markerBtn.textContent = 'ë§ˆì»¤ìƒì„±';
          markerBtn.style.background = 'rgba(255, 255, 255, 0.12)';
          markerBtn.style.color = '#1a1a1a';
        }
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
        closeMarkerSaveDialog();
        
        // ì €ì¥ëœ ë§ˆì»¤ë“¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        drawAllSavedMarkers();
        
        // ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateMarkerRemoveButtons();
      }
      
      // ì €ì¥ëœ ëª¨ë“  ë§ˆì»¤ ê·¸ë¦¬ê¸°
      function drawAllSavedMarkers() {
        // ê¸°ì¡´ ì €ì¥ëœ ë§ˆì»¤ë“¤ ì œê±°
        if (window.savedUserMarkers) {
          window.savedUserMarkers.forEach(markerGroup => {
            if (markerGroup.markerElements) {
              markerGroup.markerElements.forEach(marker => {
                marker.setMap(null);
              });
            }
          });
        }
        
        // ì €ì¥ëœ ë§ˆì»¤ë“¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        if (window.savedUserMarkers) {
          window.savedUserMarkers.forEach(markerGroup => {
            if (markerGroup.markers && markerGroup.markers.length > 0) {
              markerGroup.markerElements = [];
              
              markerGroup.markers.forEach((markerData, index) => {
                const marker = new google.maps.Marker({
                  position: new google.maps.LatLng(markerData.lat, markerData.lng),
                  map: map,
                  title: markerData.title || `${markerGroup.name} ${index + 1}`,
                  icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: '#8b5cf6',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2,
                    scale: 8
                  },
                  label: {
                    text: (index + 1).toString(),
                    fontSize: '12px',
                    fontWeight: 'bold',
                    color: '#ffffff'
                  }
                });
                
                // ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ í‘œì‹œ
                marker.addListener('click', function() {
                  showMarkerInfo(markerGroup, markerData, index);
                });
                
                markerGroup.markerElements.push(marker);
              });
            }
          });
        }
      }
      
      // ë§ˆì»¤ ì •ë³´ í‘œì‹œ
      function showMarkerInfo(markerGroup, markerData, index) {
        const info = `
          <div style="padding: 10px;">
            <h4 style="margin: 0 0 10px 0; color: #8b5cf6;">${markerGroup.name}</h4>
            <p style="margin: 5px 0;"><strong>ìœ„ì¹˜:</strong> ${index + 1}</p>
            <p style="margin: 5px 0;"><strong>ì¢Œí‘œ:</strong> ${markerData.lat.toFixed(6)}, ${markerData.lng.toFixed(6)}</p>
            <p style="margin: 5px 0;"><strong>ì €ì¥ì¼:</strong> ${new Date(markerGroup.createdAt).toLocaleDateString()}</p>
          </div>
        `;
        
        // ê¸°ì¡´ ì •ë³´ì°½ì´ ìˆìœ¼ë©´ ì œê±°
        if (window.currentInfoWindow) {
          window.currentInfoWindow.close();
        }
        
        // ìƒˆ ì •ë³´ì°½ ìƒì„±
        window.currentInfoWindow = new google.maps.InfoWindow({
          content: info
        });
        
        // ë§ˆì»¤ ìœ„ì¹˜ì— ì •ë³´ì°½ í‘œì‹œ
        const marker = markerGroup.markerElements[index];
        window.currentInfoWindow.open(map, marker);
      }
      
      // ì €ì¥ëœ ëª¨ë“  ê²½ë¡œ ê·¸ë¦¬ê¸°
      function drawAllSavedRoutes() {
        // ê¸°ì¡´ ê²½ë¡œë“¤ ì œê±°
        savedUserRoutes.forEach(route => {
          if (route.pathElement) {
            route.pathElement.setMap(null);
          }
          if (route.dottedPathElement) {
            route.dottedPathElement.setMap(null);
          }
        });
        
        // ì €ì¥ëœ ê²½ë¡œë“¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        savedUserRoutes.forEach(route => {
          if (route.path && route.path.length >= 2) {
            const path = route.path.map(point => new google.maps.LatLng(point.lat, point.lng));
            
            // ë©”ì¸ ê²½ë¡œ
            route.pathElement = new google.maps.Polyline({
              path: path,
              geodesic: true,
              strokeColor: '#3b82f6',
              strokeOpacity: 0.8,
              strokeWeight: 4
            });
            route.pathElement.setMap(map);
            
            // ì ì„  íš¨ê³¼
            route.dottedPathElement = new google.maps.Polyline({
              path: path,
              geodesic: true,
              strokeColor: '#ffffff',
              strokeOpacity: 0.9,
              strokeWeight: 2,
              icons: [{
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  fillColor: '#3b82f6',
                  fillOpacity: 1,
                  strokeColor: '#ffffff',
                  strokeWeight: 1,
                  scale: 6
                },
                offset: '0',
                repeat: '15px'
              }]
            });
            route.dottedPathElement.setMap(map);
          }
        });
      }
      
             // ì €ì¥ëœ ì‚¬ìš©ì ê²½ë¡œë“¤ ë³µì›
       async function restoreSavedUserRoutes() {
         try {
           // Firebaseì—ì„œ ë³µì› ì‹œë„
           const docSnap = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'));
           if (docSnap.exists()) {
             const data = docSnap.data();
             if (data.savedUserRoutes && data.savedUserRoutes.length > 0) {
               savedUserRoutes = data.savedUserRoutes;
               drawAllSavedRoutes();
               // ê²½ë¡œì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
               updateRouteRemoveButtons();
               // ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
               updateMarkerRemoveButtons();
               console.log('Firebaseì—ì„œ ê²½ë¡œ ë³µì› ì™„ë£Œ');
               return;
             }
           }
         } catch (error) {
           console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', error);
         }
         
         // Firebase ì‹¤íŒ¨ ì‹œ localStorageì—ì„œ ë³µì›
         const savedRoutes = localStorage.getItem('savedUserRoutes');
         if (savedRoutes) {
           savedUserRoutes = JSON.parse(savedRoutes);
           drawAllSavedRoutes();
           // ê²½ë¡œì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
           updateRouteRemoveButtons();
           // ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
           updateMarkerRemoveButtons();
         }
       }
       
       // ì €ì¥ëœ ì‚¬ìš©ì ë§ˆì»¤ë“¤ ë³µì›
       async function restoreSavedUserMarkers() {
         try {
           // Firebaseì—ì„œ ë³µì› ì‹œë„
           const docSnap = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'));
           if (docSnap.exists()) {
             const data = docSnap.data();
             if (data.savedUserMarkers && data.savedUserMarkers.length > 0) {
               window.savedUserMarkers = data.savedUserMarkers;
               drawAllSavedMarkers();
               console.log('Firebaseì—ì„œ ë§ˆì»¤ ë³µì› ì™„ë£Œ');
               return;
             }
           }
         } catch (error) {
           console.error('Firebase ë§ˆì»¤ ë¡œë“œ ì‹¤íŒ¨:', error);
         }
         
         // Firebase ì‹¤íŒ¨ ì‹œ localStorageì—ì„œ ë³µì›
         const savedMarkers = localStorage.getItem('savedUserMarkers');
         if (savedMarkers) {
           window.savedUserMarkers = JSON.parse(savedMarkers);
           drawAllSavedMarkers();
         }
       }
       
       // íŠ¹ì • ìœ„ì¹˜ì˜ ê²½ë¡œë¥¼ ì œê±°í•˜ëŠ” í•¨ìˆ˜
       async function removeRoutesByLocation(location) {
         // ë™ê¸°í™” ì¤‘ì´ë©´ ë¬´ì‹œ
         if (isSyncing) {
           updateSyncStatus('ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'warning');
           return;
         }
         
         // í•´ë‹¹ ìœ„ì¹˜ì˜ ê²½ë¡œê°€ ìˆëŠ”ì§€ í™•ì¸
         const locationRoutes = savedUserRoutes.filter(route => route.location === location);
         
         if (locationRoutes.length === 0) {
           alert(`${location}ì— ì €ì¥ëœ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.`);
           return;
         }
         
         // ì‚¬ìš©ì í™•ì¸
         if (!confirm(`${location}ì— ì €ì¥ëœ ê²½ë¡œ ${locationRoutes.length}ê°œë¥¼ ëª¨ë‘ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
           return;
         }
         
         try {
           // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
           isSyncing = true;
           updateSyncStatus('ê²½ë¡œ ì œê±° ì¤‘...', 'info');
           
           // í•´ë‹¹ ìœ„ì¹˜ì˜ ê²½ë¡œë“¤ë§Œ ì œê±°
           locationRoutes.forEach(route => {
             if (route.pathElement) {
               route.pathElement.setMap(null);
             }
             if (route.dottedPathElement) {
               route.dottedPathElement.setMap(null);
             }
           });
           
           // ë°°ì—´ì—ì„œ í•´ë‹¹ ìœ„ì¹˜ ê²½ë¡œë“¤ ì œê±°
           const updatedRoutes = savedUserRoutes.filter(route => route.location !== location);
           
           // Firebaseì—ì„œ í•´ë‹¹ ìœ„ì¹˜ ê²½ë¡œë“¤ ì œê±°
           await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
             savedUserRoutes: updatedRoutes,
             lastUpdated: window.firestore.serverTimestamp()
           });
           
           // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
           savedUserRoutes = updatedRoutes;
           
           // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
           drawAllSavedRoutes();
           updateRouteRemoveButtons();
           
           updateSyncStatus('ê²½ë¡œ ì œê±° ì™„ë£Œ', 'success');
           console.log(`Firebaseì—ì„œ ${location} ê²½ë¡œ ì œê±° ì™„ë£Œ`);
           
           // ì„±ê³µ ë©”ì‹œì§€
           alert(`${location} ê²½ë¡œ ${locationRoutes.length}ê°œê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
           
           // ì •ë³´ì°½ ë‹«ê¸°
           closePreparationInfo();
           
         } catch (error) {
           console.error('Firebase ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
           updateSyncStatus('ê²½ë¡œ ì œê±° ì‹¤íŒ¨', 'error');
           
           // Firebase ì‹¤íŒ¨ ì‹œ UIë§Œ ì—…ë°ì´íŠ¸
           const updatedRoutes = savedUserRoutes.filter(route => route.location !== location);
           savedUserRoutes = updatedRoutes;
           drawAllSavedRoutes();
           updateRouteRemoveButtons();
           
           setTimeout(() => {
             updateSyncStatus('Firebase ì—°ê²° ì‹¤íŒ¨', 'error');
           }, 2000);
           
           alert('Firebase ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œì»¬ì—ë§Œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
         } finally {
           // ë™ê¸°í™” ìƒíƒœ í•´ì œ (ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í—ˆìš©)
           isSyncing = false;
         }
       }
       
       // íŠ¹ì • ìœ„ì¹˜ì˜ ë§ˆì»¤ë¥¼ ì œê±°í•˜ëŠ” í•¨ìˆ˜
       async function removeMarkersByLocation(location) {
         // ë™ê¸°í™” ì¤‘ì´ë©´ ë¬´ì‹œ
         if (isSyncing) {
           updateSyncStatus('ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'warning');
           return;
         }
         
         // í•´ë‹¹ ìœ„ì¹˜ì˜ ë§ˆì»¤ê°€ ìˆëŠ”ì§€ í™•ì¸
         const locationMarkers = (window.savedUserMarkers || []).filter(marker => marker.location === location);
         
         if (locationMarkers.length === 0) {
           alert(`${location}ì— ì €ì¥ëœ ë§ˆì»¤ê°€ ì—†ìŠµë‹ˆë‹¤.`);
           return;
         }
         
         // ì‚¬ìš©ì í™•ì¸
         if (!confirm(`${location}ì— ì €ì¥ëœ ë§ˆì»¤ ${locationMarkers.length}ê°œë¥¼ ëª¨ë‘ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
           return;
         }
         
         try {
           // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
           isSyncing = true;
           updateSyncStatus('ë§ˆì»¤ ì œê±° ì¤‘...', 'info');
           
           // í•´ë‹¹ ìœ„ì¹˜ì˜ ë§ˆì»¤ë“¤ë§Œ ì œê±°
           locationMarkers.forEach(markerGroup => {
             if (markerGroup.markerElements) {
               markerGroup.markerElements.forEach(marker => {
                 marker.setMap(null);
               });
             }
           });
           
           // ë°°ì—´ì—ì„œ í•´ë‹¹ ìœ„ì¹˜ ë§ˆì»¤ë“¤ ì œê±°
           const updatedMarkers = (window.savedUserMarkers || []).filter(marker => marker.location !== location);
           
           // Firebaseì—ì„œ í•´ë‹¹ ìœ„ì¹˜ ë§ˆì»¤ë“¤ ì œê±°
           await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
             savedUserMarkers: updatedMarkers,
             lastUpdated: window.firestore.serverTimestamp()
           });
           
           // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
           window.savedUserMarkers = updatedMarkers;
           
           // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
           drawAllSavedMarkers();
           updateRouteRemoveButtons();
           
           updateSyncStatus('ë§ˆì»¤ ì œê±° ì™„ë£Œ', 'success');
           console.log(`Firebaseì—ì„œ ${location} ë§ˆì»¤ ì œê±° ì™„ë£Œ`);
           
           // ì„±ê³µ ë©”ì‹œì§€
           alert(`${location} ë§ˆì»¤ ${locationMarkers.length}ê°œê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
           
           // ì •ë³´ì°½ ë‹«ê¸°
           closePreparationInfo();
           
         } catch (error) {
           console.error('Firebase ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
           updateSyncStatus('ë§ˆì»¤ ì œê±° ì‹¤íŒ¨', 'error');
           
           // Firebase ì‹¤íŒ¨ ì‹œ UIë§Œ ì—…ë°ì´íŠ¸
           const updatedMarkers = (window.savedUserMarkers || []).filter(marker => marker.location !== location);
           window.savedUserMarkers = updatedMarkers;
           drawAllSavedMarkers();
           updateRouteRemoveButtons();
           
           setTimeout(() => {
             updateSyncStatus('Firebase ì—°ê²° ì‹¤íŒ¨', 'error');
           }, 2000);
           
           alert('Firebase ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œì»¬ì—ë§Œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
         } finally {
           // ë™ê¸°í™” ìƒíƒœ í•´ì œ (ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í—ˆìš©)
           isSyncing = false;
         }
       }
       
       // ê²½ë¡œ/ë§ˆì»¤ ì œê±° ë²„íŠ¼ë“¤ì„ ë™ì ìœ¼ë¡œ í‘œì‹œ/ìˆ¨ê¹€í•˜ëŠ” í•¨ìˆ˜
       function updateRouteRemoveButtons() {
         // ì‚¬ì „ì¤€ë¹„ ê²½ë¡œ/ë§ˆì»¤ ì œê±° ë²„íŠ¼
         const prepBtn = document.getElementById('preparationRemoveButtons');
         if (prepBtn) {
           const prepRoutes = savedUserRoutes.filter(route => route.location === 'ì‚¬ì „ì¤€ë¹„');
           const prepMarkers = (window.savedUserMarkers || []).filter(marker => marker.location === 'ì‚¬ì „ì¤€ë¹„');
           prepBtn.style.display = (prepRoutes.length > 0 || prepMarkers.length > 0) ? 'block' : 'none';
         }
         
         // 1ì¼ì°¨ ê²½ë¡œ/ë§ˆì»¤ ì œê±° ë²„íŠ¼
         const day1Btn = document.getElementById('day1RemoveButtons');
         if (day1Btn) {
           const day1Routes = savedUserRoutes.filter(route => route.location === '1ì¼ì°¨');
           const day1Markers = (window.savedUserMarkers || []).filter(marker => marker.location === '1ì¼ì°¨');
           day1Btn.style.display = (day1Routes.length > 0 || day1Markers.length > 0) ? 'block' : 'none';
         }
       }
       
       // ë§ˆì»¤ì œê±° ë²„íŠ¼ë“¤ì„ ë™ì ìœ¼ë¡œ í‘œì‹œ/ìˆ¨ê¹€í•˜ëŠ” í•¨ìˆ˜ (í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€)
       function updateMarkerRemoveButtons() {
         // ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•Šìœ¼ë©°, updateRouteRemoveButtonsì—ì„œ í†µí•© ì²˜ë¦¬ë©ë‹ˆë‹¤.
         updateRouteRemoveButtons();
       }
       
       // ì£¼ì†Œ ê²€ìƒ‰ í•¨ìˆ˜ - ëª¨ë°”ì¼ ìµœì í™”
       function searchAddress() {
         const address = document.getElementById('addressInput').value.trim();
         if (!address) {
           alert('ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
           return;
         }
         if (!geocoder || !map) {
           alert('ì§€ë„ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
           return;
         }
         
         // ëª¨ë°”ì¼ì—ì„œ ê²€ìƒ‰ ì¤‘ í‘œì‹œ
         if (isMobile) {
           const searchBtn = document.querySelector('#addressInput + button') || document.getElementById('addressInput');
           const originalText = searchBtn.textContent || searchBtn.placeholder;
           searchBtn.textContent = 'ê²€ìƒ‰ì¤‘...';
           searchBtn.disabled = true;
         }
         
         // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
         if (addressMarker) {
           addressMarker.setMap(null);
           addressMarker = null;
         }
         
         const boundsForQuery = map.getBounds ? map.getBounds() : null;
         geocoder.geocode({ 
           address: address, 
           bounds: boundsForQuery,
           // ëª¨ë°”ì¼ì—ì„œ ê²€ìƒ‰ ë²”ìœ„ ìµœì í™”
           region: isMobile ? 'JP' : undefined // ì¼ë³¸ ì§€ì—­ ìš°ì„  ê²€ìƒ‰
         }, function(results, status) {
           // ëª¨ë°”ì¼ì—ì„œ ê²€ìƒ‰ ì™„ë£Œ í‘œì‹œ ë³µì›
           if (isMobile) {
             const searchBtn = document.querySelector('#addressInput + button') || document.getElementById('addressInput');
             searchBtn.textContent = originalText;
             searchBtn.disabled = false;
           }
           
           if (status !== 'OK' || !results || !results.length) {
             alert('ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + status);
             return;
           }

           // í˜„ì¬ í™”ë©´ ë²”ìœ„ ë‚´ ê²°ê³¼ë§Œ ì‚¬ìš©
           const boundsNow = map.getBounds ? map.getBounds() : null;
           const filtered = boundsNow ? results.filter(function(r) { return boundsNow.contains(r.geometry.location); }) : results;
           if (!filtered.length) {
             alert('í˜„ì¬ í™”ë©´ ë²”ìœ„ ë‚´ì—ì„œ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§€ë„ë¥¼ ì´ë™/í™•ëŒ€ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
             return;
           }

           // ê²°ê³¼ê°€ ì—¬ëŸ¬ ê°œë©´ ì‚¬ìš©ì ì„ íƒ ìœ ë„
           if (filtered.length > 1) {
             addressSearchCandidates = filtered;
             showAddressSelection(filtered, address);
             return;
           }

           const location = filtered[0].geometry.location;
           
           // í˜„ì¬ ì¤Œ ë ˆë²¨ ìœ ì§€í•˜ë©´ì„œ ì¤‘ì‹¬ë§Œ ì´ë™
           const currentZoom = map.getZoom();
           map.setCenter(location);
           map.setZoom(currentZoom); // í˜„ì¬ ì¤Œ ë ˆë²¨ ìœ ì§€

           // ìƒˆë¡œìš´ ë§ˆì»¤ ìƒì„± ë° í‘œì‹œ - ëª¨ë°”ì¼ ìµœì í™”
           addressMarker = new google.maps.Marker({
             position: location,
             map: map,
             title: address,
             icon: {
               url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
               scaledSize: new google.maps.Size(isMobile ? 28 : 32, isMobile ? 28 : 32)
             },
             animation: isMobile ? google.maps.Animation.NONE : google.maps.Animation.DROP, // ëª¨ë°”ì¼ì—ì„œëŠ” ì• ë‹ˆë©”ì´ì…˜ ì œê±°ë¡œ ì„±ëŠ¥ í–¥ìƒ
             optimized: isMobile ? false : true // ëª¨ë°”ì¼ì—ì„œëŠ” ìµœì í™” ë¹„í™œì„±í™”ë¡œ ì„±ëŠ¥ í–¥ìƒ
           });

           // ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ì°½ í‘œì‹œ - ëª¨ë°”ì¼ ìµœì í™”
           const infoWindow = new google.maps.InfoWindow({
             content: '<div style="padding: 8px; font-size: 14px; line-height: 1.3;"><strong>' + address + '</strong></div>',
             disableAutoPan: false,
             maxWidth: isMobile ? 250 : 300
           });
           addressMarker.addListener('click', function() {
             // ê¸°ì¡´ ì •ë³´ì°½ ë‹«ê¸°
             if (currentInfoWindow) {
               currentInfoWindow.close();
             }
             infoWindow.open(map, addressMarker);
             currentInfoWindow = infoWindow;
             
             // ë§ˆì»¤ ì£¼ìœ„ë¡œ ì¤Œ ë ˆë²¨ 15ë¡œ ì¡°ì •
             map.setCenter(location);
             map.setZoom(15);
           });

           // ì£¼ì†Œ ì…ë ¥ì°½ ì´ˆê¸°í™”
           document.getElementById('addressInput').value = '';
         });
       }
       
       // ì£¼ì†Œ ë§ˆì»¤ ê°€ì‹œì„± í™•ì¸ ë° ìë™ ì œê±° í•¨ìˆ˜
       function checkAddressMarkerVisibility() {
         if (addressMarker && map) {
           const bounds = map.getBounds();
           const markerPosition = addressMarker.getPosition();
           
           // ë§ˆì»¤ê°€ í˜„ì¬ ì§€ë„ ë·°ì˜ ê²½ê³„ ë°–ì— ìˆëŠ”ì§€ í™•ì¸
           if (bounds && !bounds.contains(markerPosition)) {
             // ì—´ë¦° ì •ë³´ì°½ ë‹«ê¸°
             if (currentInfoWindow) {
               currentInfoWindow.close();
               currentInfoWindow = null;
             }
             // ë§ˆì»¤ê°€ ë·°ì—ì„œ ë²—ì–´ë‚˜ë©´ ìë™ìœ¼ë¡œ ì œê±°
             addressMarker.setMap(null);
             addressMarker = null;
             document.getElementById('addressInput').value = '';
             console.log('ì£¼ì†Œ ë§ˆì»¤ê°€ ì§€ë„ ë·°ì—ì„œ ë²—ì–´ë‚˜ ìë™ìœ¼ë¡œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
           }
         }
       }
       
       // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ê°€ì‹œì„± í™•ì¸ ë° ìë™ ì œê±° í•¨ìˆ˜
       function checkCurrentLocationMarkerVisibility() {
         if (currentLocationMarker && map) {
           const bounds = map.getBounds();
           const markerPosition = currentLocationMarker.getPosition();
           
           // ë§ˆì»¤ê°€ í˜„ì¬ ì§€ë„ ë·°ì˜ ê²½ê³„ ë°–ì— ìˆëŠ”ì§€ í™•ì¸
           if (bounds && !bounds.contains(markerPosition)) {
             // ì—´ë¦° ì •ë³´ì°½ ë‹«ê¸°
             if (currentInfoWindow) {
               currentInfoWindow.close();
               currentInfoWindow = null;
             }
             // ë§ˆì»¤ê°€ ë·°ì—ì„œ ë²—ì–´ë‚˜ë©´ ìë™ìœ¼ë¡œ ì œê±°
             currentLocationMarker.setMap(null);
             currentLocationMarker = null;
             console.log('í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ê°€ ì§€ë„ ë·°ì—ì„œ ë²—ì–´ë‚˜ ìë™ìœ¼ë¡œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
           }
         }
       }
       
       // ì£¼ì†Œ ë§ˆì»¤ ì œê±° í•¨ìˆ˜ (ìˆ˜ë™ ì œê±°ìš©)
       function clearAddressMarker() {
         if (addressMarker) {
           // ì—´ë¦° ì •ë³´ì°½ ë‹«ê¸°
           if (currentInfoWindow) {
             currentInfoWindow.close();
             currentInfoWindow = null;
           }
           addressMarker.setMap(null);
           addressMarker = null;
           document.getElementById('addressInput').value = '';
         }
       }
       
       // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì œê±° í•¨ìˆ˜ (ìˆ˜ë™ ì œê±°ìš©)
       function clearCurrentLocationMarker() {
         if (currentLocationMarker) {
           // ì—´ë¦° ì •ë³´ì°½ ë‹«ê¸°
           if (currentInfoWindow) {
             currentInfoWindow.close();
             currentInfoWindow = null;
           }
           currentLocationMarker.setMap(null);
           currentLocationMarker = null;
         }
       }

      function showAddressSelection(results, queryText) {
        // ê¸°ì¡´ ì„ íƒì°½ ì œê±°
        var existing = document.getElementById('addressSelectDialog');
        if (existing) existing.remove();

        var dialog = document.createElement('div');
        dialog.id = 'addressSelectDialog';
        dialog.style.position = 'absolute';
        dialog.style.zIndex = '15';
        dialog.style.width = '320px';
        dialog.style.maxWidth = '85vw';
        dialog.style.background = 'rgba(255, 255, 255, 0.95)';
        dialog.style.border = '1px solid rgba(0,0,0,0.1)';
        dialog.style.borderRadius = '12px';
        dialog.style.boxShadow = '0 12px 24px rgba(0,0,0,0.15)';
        dialog.style.overflow = 'hidden';

        dialog.innerHTML =
          '<div style="background:#1d4ed8;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;">' +
          '  <div style="font-weight:700;">ì£¼ì†Œ ì„ íƒ</div>' +
          '  <button style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;" onclick="closeAddressSelection()">Ã—</button>' +
          '</div>' +
          '<div style="padding:12px 16px;max-height:50vh;overflow:auto;">' +
          '  <div style="margin-bottom:8px;color:#374151;font-size:0.9rem;">\'' + (queryText || '') + '\' ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ëŸ¬ ê°œì…ë‹ˆë‹¤. ì„ íƒí•˜ì„¸ìš”.</div>' +
          '  <div id="addressSelectList"></div>' +
          '</div>';

        document.body.appendChild(dialog);

        // ìœ„ì¹˜ ì¤‘ì•™ ë°°ì¹˜ - ëª¨ë°”ì¼ ìµœì í™”
        setTimeout(function () {
          var mapEl = document.getElementById('map');
          var rect = mapEl.getBoundingClientRect();
          
          if (isMobile) {
            // ëª¨ë°”ì¼: í™”ë©´ ì¤‘ì•™ì— í‘œì‹œ
            dialog.style.left = '50%';
            dialog.style.transform = 'translateX(-50%)';
            dialog.style.top = '80px';
          } else {
            // ë°ìŠ¤í¬í†±: ì§€ë„ ì¤‘ì•™ì— í‘œì‹œ
            dialog.style.left = (rect.width / 2 - 160) + 'px';
            dialog.style.top = (rect.height / 2 - 160) + 'px';
            dialog.style.transform = 'none';
          }
        }, 50);

        // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        var list = dialog.querySelector('#addressSelectList');
        var html = '';
        results.forEach(function(r, idx) {
          var addr = (r.formatted_address || r.name || 'ê²°ê³¼ ' + (idx + 1));
          html += '<button style="width:100%;text-align:left;margin:6px 0;padding:10px 12px;border:1px solid rgba(0,0,0,0.1);border-radius:8px;background:#fff;cursor:pointer;" onclick="chooseAddressResult(' + idx + ')">' +
                  '<div style="font-weight:600;color:#111827;">' + addr + '</div>' +
                  '</button>';
        });
        list.innerHTML = html;
      }

      function closeAddressSelection() {
        var dialog = document.getElementById('addressSelectDialog');
        if (dialog) dialog.remove();
      }

      function chooseAddressResult(index) {
        try {
          var candidates = addressSearchCandidates || [];
          if (!candidates.length || !candidates[index]) {
            closeAddressSelection();
            alert('ì„ íƒí•  ìˆ˜ ìˆëŠ” ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          var result = candidates[index];
          var location = result.geometry.location;

          // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
          if (addressMarker) {
            addressMarker.setMap(null);
            addressMarker = null;
          }

          map.setCenter(location);
          map.setZoom(16);

          addressMarker = new google.maps.Marker({
            position: location,
            map: map,
            title: result.formatted_address || '',
            icon: {
              url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
              scaledSize: new google.maps.Size(32, 32)
            },
            animation: google.maps.Animation.DROP
          });

          var infoWindow = new google.maps.InfoWindow({
            content: '<div style="padding: 8px; font-size: 14px; line-height: 1.3;"><strong>' + (result.formatted_address || '') + '</strong></div>',
            disableAutoPan: false,
            maxWidth: 300
          });
          addressMarker.addListener('click', function() {
            // ê¸°ì¡´ ì •ë³´ì°½ ë‹«ê¸°
            if (currentInfoWindow) {
              currentInfoWindow.close();
            }
            infoWindow.open(map, addressMarker);
            currentInfoWindow = infoWindow;
            
            // ë§ˆì»¤ ì£¼ìœ„ë¡œ ì¤Œ ë ˆë²¨ 15ë¡œ ì¡°ì •
            map.setCenter(location);
            map.setZoom(15);
          });

          document.getElementById('addressInput').value = '';
        } finally {
          closeAddressSelection();
          addressSearchCandidates = [];
        }
      }

      // ìŠ¤ì™€ì´í”„ ì‚­ì œ/ìˆ˜ì • ê¸°ëŠ¥ ì´ˆê¸°í™” - ëª¨ë°”ì¼ ìµœì í™”
      function initializeSwipeDelete() {
        const allItems = document.querySelectorAll('.user-added-item, .checklist-item');
        
        allItems.forEach(item => {
          let startX = 0;
          let currentX = 0;
          let isSwiping = false;
          let hasSwiped = false;
          let startTime = 0;
          
          // í„°ì¹˜ ì‹œì‘ - ëª¨ë°”ì¼ ìµœì í™”
          item.addEventListener('touchstart', function(e) {
            // ì‚­ì œ ë²„íŠ¼ì´ë‚˜ ì²´í¬ë°•ìŠ¤ í´ë¦­ ì‹œì—ëŠ” ìŠ¤ì™€ì´í”„ ë°©ì§€
            if (e.target.classList.contains('swipe-delete-btn') ||
                e.target.classList.contains('prep-checkbox')) {
              return;
            }
            
            startX = e.touches[0].clientX;
            startTime = Date.now();
            isSwiping = true;
            hasSwiped = false;
            this.classList.add('swiping');
          }, { passive: true });
          
          // í„°ì¹˜ ì´ë™ - ëª¨ë°”ì¼ ìµœì í™”
          item.addEventListener('touchmove', function(e) {
            if (!isSwiping) return;
            
            currentX = e.touches[0].clientX;
            const diffX = startX - currentX;
            const diffTime = Date.now() - startTime;
            
            // ë¹ ë¥¸ ìŠ¤ì™€ì´í”„ ê°ì§€ (ëª¨ë°”ì¼ì—ì„œ ë” ë¯¼ê°í•˜ê²Œ)
            if (diffX > 30 && diffTime < 500) {
              const translateX = Math.min(diffX, 160);
              const contentEl = this.querySelector('.item-content');
              if (contentEl) {
                contentEl.style.transform = `translateX(-${translateX}px)`;
              }
              hasSwiped = true;
              // ê°€ë¡œ ìŠ¤ì™€ì´í”„ ì¤‘ì—ëŠ” ê¸°ë³¸ ìŠ¤í¬ë¡¤ ë°©ì§€ (í…ìŠ¤íŠ¸ë§Œ ì´ë™)
              e.preventDefault();
            }
          }, { passive: false });
          
          // í„°ì¹˜ ì¢…ë£Œ - ëª¨ë°”ì¼ ìµœì í™”
          item.addEventListener('touchend', function(e) {
            if (!isSwiping) return;
            
            isSwiping = false;
            this.classList.remove('swiping');
            
            const diffX = startX - currentX;
            const diffTime = Date.now() - startTime;
            
            // ëª¨ë°”ì¼ì—ì„œ ë” ë¯¼ê°í•œ ìŠ¤ì™€ì´í”„ ê°ì§€
            if (hasSwiped && diffX > 30 && diffTime < 1000) {
              // ìŠ¤ì™€ì´í”„ ì™„ë£Œ - ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
              this.classList.add('swiped');
            } else {
              // ìŠ¤ì™€ì´í”„ ì·¨ì†Œ - ì›ë˜ ìœ„ì¹˜ë¡œ ë³µì›
              this.classList.remove('swiped');
              this.querySelector('.item-content').style.transform = 'translateX(0)';
            }
          }, { passive: true });
          
          // í´ë¦­ ì‹œ ìŠ¤ì™€ì´í”„ ìƒíƒœ í•´ì œ - ëª¨ë°”ì¼ ìµœì í™”
          item.addEventListener('click', function(e) {
            // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í´ë¦­ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ìŠ¤ì™€ì´í”„ í•´ì œ
            if (!e.target.classList.contains('swipe-edit-btn') &&
                !e.target.classList.contains('swipe-delete-btn') &&
                !e.target.classList.contains('prep-checkbox')) {
              this.classList.remove('swiped');
              this.querySelector('.item-content').style.transform = 'translateX(0)';
            }
          });
          
          // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ (ë°ìŠ¤í¬í†± ì§€ì›) - ëª¨ë°”ì¼ì—ì„œëŠ” ë¹„í™œì„±í™”
          if (!isMobile) {
            item.addEventListener('mousedown', function(e) {
              if (e.button !== 0) return; // ì™¼ìª½ ë²„íŠ¼ë§Œ
              
              startX = e.clientX;
              isSwiping = true;
              hasSwiped = false;
              this.classList.add('swiping');
              
              const handleMouseMove = (e) => {
                if (!isSwiping) return;
                
                currentX = e.clientX;
                const diffX = startX - currentX;
                
                if (diffX > 50) {
                  const translateX = Math.min(diffX, 160);
                  this.querySelector('.item-content').style.transform = `translateX(-${translateX}px)`;
                  hasSwiped = true;
                }
              };
              
              const handleMouseUp = () => {
                if (!isSwiping) return;
                
                isSwiping = false;
                this.classList.remove('swiping');
                
                if (hasSwiped && (startX - currentX) > 50) {
                  // ìŠ¤ì™€ì´í”„ ì™„ë£Œ - ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
                  this.classList.add('swiped');
                } else {
                  // ìŠ¤ì™€ì´í”„ ì·¨ì†Œ - ì›ë˜ ìœ„ì¹˜ë¡œ ë³µì›
                  this.classList.remove('swiped');
                  this.querySelector('.item-content').style.transform = 'translateX(0)';
                }
                
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
              };
              
              document.addEventListener('mousemove', handleMouseMove);
              document.addEventListener('mouseup', handleMouseUp);
            });
          }
        });
      }
      
      // ì „ì—­ ë™ê¸°í™” ìƒíƒœ ê´€ë¦¬
      let isSyncing = false;
      let lastSyncTimestamp = 0;
      let syncRetryCount = 0;
      const MAX_SYNC_RETRIES = 3;
      const SYNC_COOLDOWN = 1000; // 1ì´ˆ ì¿¨ë‹¤ìš´
      
      // Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ì„¤ì • (localStorage ì œê±° ë²„ì „)
      function setupFirebaseSync() {
        try {
          // ë™ê¸°í™” ìƒíƒœ í‘œì‹œê¸° ì¶”ê°€
          addSyncStatusIndicator();
          
          const unsubscribe = window.firestore.onSnapshot(
            window.firestore.doc(window.db, 'users', 'currentUser'), 
            (doc) => {
              if (doc.exists()) {
                const data = doc.data();
                const currentTime = Date.now();
                
                // ë§ˆì§€ë§‰ ë™ê¸°í™” í›„ ì¿¨ë‹¤ìš´ ì‹œê°„ í™•ì¸
                if (currentTime - lastSyncTimestamp < SYNC_COOLDOWN) {
                  console.log('ì¿¨ë‹¤ìš´ ì‹œê°„ìœ¼ë¡œ ì¸í•´ ë™ê¸°í™” ê±´ë„ˆëœ€');
                  return;
                }
                
                console.log('Firebaseì—ì„œ ë°ì´í„° ìˆ˜ì‹ :', Object.keys(data));
                
                // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë™ê¸°í™” (Firebaseì—ì„œ ì§ì ‘)
                if (data.preparationCheckboxes) {
                  console.log('ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë™ê¸°í™” ì¤‘...');
                  Object.keys(data.preparationCheckboxes).forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox && checkbox.checked !== data.preparationCheckboxes[id]) {
                      checkbox.checked = data.preparationCheckboxes[id];
                    }
                  });
                  updateSyncStatus('ì²´í¬ë°•ìŠ¤ ë™ê¸°í™” ì™„ë£Œ', 'success');
                }
                
                // ì‚¬ìš©ì ì¶”ê°€ í•­ëª© ë™ê¸°í™” (Firebaseì—ì„œ ì§ì ‘)
                if (data.userAddedItems) {
                  console.log('ì‚¬ìš©ì í•­ëª© ë™ê¸°í™” ì¤‘...');
                  
                  // ê¸°ì¡´ í•­ëª©ê³¼ ë¹„êµí•˜ì—¬ ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
                  const currentItems = window.firebaseUserItems || [];
                  const newItems = data.userAddedItems;
                  
                  // í•­ëª© ê°œìˆ˜ë‚˜ IDê°€ ë‹¤ë¥´ë©´ ì—…ë°ì´íŠ¸
                  if (currentItems.length !== newItems.length || 
                      JSON.stringify(currentItems.map(item => item.id).sort()) !== 
                      JSON.stringify(newItems.map(item => item.id).sort())) {
                    
                    console.log('ì‚¬ìš©ì í•­ëª© ë³€ê²½ ê°ì§€ - UI ì—…ë°ì´íŠ¸');
                    // ì „ì—­ ë³€ìˆ˜ì— ì§ì ‘ ì €ì¥
                    window.firebaseUserItems = newItems;
                    // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    displayUserAddedItemsFromFirebase(newItems);
                    updateSyncStatus('ì‚¬ìš©ì í•­ëª© ë™ê¸°í™” ì™„ë£Œ', 'success');
                  } else {
                    console.log('ì‚¬ìš©ì í•­ëª© ë³€ê²½ ì—†ìŒ - UI ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€');
                  }
                }
                // ê¸°ì¡´ í•­ëª© ìˆ¨ê¹€/ì˜¤ë²„ë¼ì´ë“œ ì‹¤ì‹œê°„ ë™ê¸°í™”
                window.hiddenExistingItems = data.hiddenExistingItems || [];
                window.existingItemOverrides = data.existingItemOverrides || {};
                if (typeof applyOverridesAndHides === 'function') {
                  applyOverridesAndHides();
                }
                
                // ê²½ë¡œ ë™ê¸°í™” (Firebaseì—ì„œ ì§ì ‘)
                if (data.savedUserRoutes) {
                  console.log('ê²½ë¡œ ë™ê¸°í™” ì¤‘...');
                  
                  // ê¸°ì¡´ ê²½ë¡œì™€ ë¹„êµí•˜ì—¬ ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
                  const currentRoutes = savedUserRoutes || [];
                  const newRoutes = data.savedUserRoutes;
                  
                  // ê²½ë¡œ ê°œìˆ˜ë‚˜ IDê°€ ë‹¤ë¥´ë©´ ì—…ë°ì´íŠ¸
                  if (currentRoutes.length !== newRoutes.length || 
                      JSON.stringify(currentRoutes.map(route => route.id).sort()) !== 
                      JSON.stringify(newRoutes.map(route => route.id).sort())) {
                    
                    console.log('ê²½ë¡œ ë³€ê²½ ê°ì§€ - UI ì—…ë°ì´íŠ¸');
                    savedUserRoutes = newRoutes;
                    drawAllSavedRoutes();
                    updateRouteRemoveButtons();
                    updateSyncStatus('ê²½ë¡œ ë™ê¸°í™” ì™„ë£Œ', 'success');
                  } else {
                    console.log('ê²½ë¡œ ë³€ê²½ ì—†ìŒ - UI ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€');
                  }
                }
                
                // ë§ˆì»¤ ë™ê¸°í™” (Firebaseì—ì„œ ì§ì ‘)
                if (data.savedUserMarkers) {
                  console.log('ë§ˆì»¤ ë™ê¸°í™” ì¤‘...');
                  
                  // ê¸°ì¡´ ë§ˆì»¤ì™€ ë¹„êµí•˜ì—¬ ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
                  const currentMarkers = window.savedUserMarkers || [];
                  const newMarkers = data.savedUserMarkers;
                  
                  // ë§ˆì»¤ ê°œìˆ˜ë‚˜ IDê°€ ë‹¤ë¥´ë©´ ì—…ë°ì´íŠ¸
                  if (currentMarkers.length !== newMarkers.length || 
                      JSON.stringify(currentMarkers.map(marker => marker.id).sort()) !== 
                      JSON.stringify(newMarkers.map(marker => marker.id).sort())) {
                    
                    console.log('ë§ˆì»¤ ë³€ê²½ ê°ì§€ - UI ì—…ë°ì´íŠ¸');
                    window.savedUserMarkers = newMarkers;
                    drawAllSavedMarkers();
                    updateRouteRemoveButtons();
                    updateSyncStatus('ë§ˆì»¤ ë™ê¸°í™” ì™„ë£Œ', 'success');
                  } else {
                    console.log('ë§ˆì»¤ ë³€ê²½ ì—†ìŒ - UI ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€');
                  }
                }
                
                lastSyncTimestamp = currentTime;
                syncRetryCount = 0;
                updateSyncStatus('ë™ê¸°í™” ì™„ë£Œ', 'success');
                
              } else {
                // ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°
                console.log('Firebase ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ - ë°ì´í„° ì´ˆê¸°í™”');
                clearAllData();
                updateSyncStatus('ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ', 'warning');
              }
            }, 
            (error) => {
              console.error('Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ì˜¤ë¥˜:', error);
              syncRetryCount++;
              
              if (syncRetryCount <= MAX_SYNC_RETRIES) {
                updateSyncStatus(`ë™ê¸°í™” ì˜¤ë¥˜ (${syncRetryCount}/${MAX_SYNC_RETRIES})`, 'error');
                // ìë™ ì¬ì‹œë„
                setTimeout(() => {
                  console.log('ë™ê¸°í™” ì¬ì‹œë„ ì¤‘...');
                  setupFirebaseSync();
                }, 2000 * syncRetryCount);
              } else {
                updateSyncStatus('ë™ê¸°í™” ì‹¤íŒ¨ - ì˜¤í”„ë¼ì¸ ëª¨ë“œ', 'error');
                // ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì „í™˜
                enableOfflineMode();
              }
            }
          );
          
          // êµ¬ë… í•´ì œ í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ì €ì¥
          window.unsubscribeFirebase = unsubscribe;
          
          console.log('Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ì„¤ì • ì™„ë£Œ');
          updateSyncStatus('ë™ê¸°í™” ì—°ê²°ë¨', 'success');
          
        } catch (error) {
          console.error('Firebase ë™ê¸°í™” ì„¤ì • ì‹¤íŒ¨:', error);
          updateSyncStatus('ë™ê¸°í™” ì„¤ì • ì‹¤íŒ¨', 'error');
          enableOfflineMode();
        }
      }
      
      // Firebase ë°ì´í„° ì´ˆê¸°í™” í•¨ìˆ˜ (localStorage ì œê±°)
      function clearAllData() {
        // UI ì´ˆê¸°í™”
        document.querySelectorAll('.prep-checkbox').forEach(cb => cb.checked = false);
        
        // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
        savedUserRoutes = [];
        window.savedUserMarkers = [];
        window.firebaseUserItems = [];
        
        // UI ì—…ë°ì´íŠ¸
        displayUserAddedItemsFromFirebase([]);
        drawAllSavedRoutes();
        drawAllSavedMarkers();
        updateRouteRemoveButtons();
      }
      
      // Firebaseì—ì„œ ì§ì ‘ ì‚¬ìš©ì í•­ëª© í‘œì‹œ (localStorage ì œê±°)
      function displayUserAddedItemsFromFirebase(userItems) {
        const container = document.getElementById('userAddedItems');
        if (!container) return;
        
        if (!userItems || userItems.length === 0) {
          container.innerHTML = '';
          return;
        }
        
        let html = '';
        userItems.forEach(item => {
          const titleElement = item.link 
            ? `<span onclick="openUserItemLink('${item.link}')" style="cursor: pointer; color: #1d4ed8; text-decoration: underline;">${item.title}</span>`
            : `${item.title}`;
          
          html += `
            <div class="user-added-item" data-item-id="${item.id}" data-item-type="user">
              <div class="item-content">
                <input type="checkbox" id="${item.id}" class="prep-checkbox" onchange="saveCheckboxStates()" ${item.checked ? 'checked' : ''}>
                <span>${titleElement}</span>
              </div>
              <button class="swipe-edit-btn" onclick="editUserItem('${item.id}', '${item.title}', '${item.description || ''}', '${item.link || ''}')" title="ìˆ˜ì •">ìˆ˜ì •</button>
              <button class="swipe-delete-btn" onclick="deleteUserItem('${item.id}')" title="ì‚­ì œ">ì‚­ì œ</button>
            </div>
          `;
        });
        
        container.innerHTML = html;
        
        // í´ë¦­ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸ ëì— â— í‘œì‹œ ì¶”ê°€
        if (typeof appendExclamationToLinks === 'function') {
          appendExclamationToLinks(container);
        }
        
        // ìŠ¤ì™€ì´í”„ ì‚­ì œ ê¸°ëŠ¥ ì´ˆê¸°í™”
        initializeSwipeDelete();
        
        // ëª¨ë°”ì¼ì—ì„œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€
        if (isMobile) {
          const editButtons = container.querySelectorAll('.swipe-edit-btn');
          const deleteButtons = container.querySelectorAll('.swipe-delete-btn');
          
          // ìˆ˜ì • ë²„íŠ¼ í„°ì¹˜ ì´ë²¤íŠ¸
          editButtons.forEach(btn => {
            btn.addEventListener('touchstart', function(e) {
              e.stopPropagation();
              e.preventDefault();
              this.style.transform = 'scale(0.95)';
            }, { passive: false });
            
            btn.addEventListener('touchend', function(e) {
              e.stopPropagation();
              e.preventDefault();
              this.style.transform = 'scale(1)';
            }, { passive: false });
            
            btn.addEventListener('touchcancel', function(e) {
              e.stopPropagation();
              this.style.transform = 'scale(1)';
            }, { passive: true });
          });
          
          // ì‚­ì œ ë²„íŠ¼ í„°ì¹˜ ì´ë²¤íŠ¸
          deleteButtons.forEach(btn => {
            btn.addEventListener('touchstart', function(e) {
              e.stopPropagation();
              e.preventDefault();
              this.style.transform = 'scale(0.95)';
            }, { passive: false });
            
            btn.addEventListener('touchend', function(e) {
              e.stopPropagation();
              e.preventDefault();
              this.style.transform = 'scale(1)';
              
              const itemId = this.closest('.user-added-item, .checklist-item').getAttribute('data-item-id');
              if (itemId) {
                // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ í„°ì¹˜ í”¼ë“œë°±ì„ ë³´ì—¬ì¤Œ
                setTimeout(() => {
                  const itemType = this.closest('.user-added-item, .checklist-item').getAttribute('data-item-type');
                  if (itemType === 'user') {
                    deleteUserItem(itemId);
                  } else {
                    deleteExistingItem(itemId);
                  }
                }, 100);
              }
            }, { passive: false });
            
            btn.addEventListener('touchcancel', function(e) {
              e.stopPropagation();
              this.style.transform = 'scale(1)';
            }, { passive: true });
          });
        }
      }
      
      // í´ë¦­ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸(ë§í¬ ì—­í• ) ëì— â— í‘œì‹œë¥¼ ìœ„ì²¨ìì²˜ëŸ¼ ë§ë¶™ì´ëŠ” í•¨ìˆ˜
      function appendExclamationToLinks(rootEl) {
        try {
          if (!rootEl) return;
          const clickableSelectors = [
            'span[onclick]',
            'button.ticket-btn',
            'a[href]'
          ];
          const nodes = rootEl.querySelectorAll(clickableSelectors.join(','));
          nodes.forEach(node => {
            // ì´ë¯¸ í‘œì‹œê°€ ë¶™ì–´ ìˆë‹¤ë©´ ì¤‘ë³µ ë°©ì§€
            if (node.querySelector('.link-indicator')) return;
            const text = (node.textContent || '').trim();
            if (!text) return;
            if (text.endsWith('â—')) return;
            const indicator = document.createElement('span');
            indicator.className = 'link-indicator';
            indicator.textContent = 'â—';
            indicator.setAttribute('aria-hidden', 'true');
            indicator.style.cssText = [
              'display:inline-block',
              'font-size:0.6em',
              'line-height:1',
              'vertical-align:super',
              'margin-left:4px',
              'position:relative',
              'top:-0.1em'
            ].join(';');
            node.appendChild(indicator);
          });
        } catch (e) {
          console.warn('ë§í¬ ê°•ì¡° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', e);
        }
      }
      
      // ì˜¤í”„ë¼ì¸ ëª¨ë“œ í™œì„±í™”
      function enableOfflineMode() {
        console.log('ì˜¤í”„ë¼ì¸ ëª¨ë“œ í™œì„±í™”');
        updateSyncStatus('ì˜¤í”„ë¼ì¸ ëª¨ë“œ', 'warning');
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë§Œ ì‚¬ìš©
      }
      
      // ë™ê¸°í™” ìƒíƒœ í‘œì‹œê¸° ì¶”ê°€
      function addSyncStatusIndicator() {
        if (document.getElementById('syncStatusIndicator')) return;
        
        const statusDiv = document.createElement('div');
        statusDiv.id = 'syncStatusIndicator';
        statusDiv.style.cssText = `
          position: fixed;
          top: 10px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 1000;
          padding: 8px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
          color: white;
          background: rgba(0, 0, 0, 0.7);
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
          opacity: 0;
          transform: translateX(-50%) translateY(-20px);
        `;
        statusDiv.textContent = 'ë™ê¸°í™” ì¤€ë¹„ ì¤‘...';
        document.body.appendChild(statusDiv);
        
        // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ í‘œì‹œ
        setTimeout(() => {
          statusDiv.style.opacity = '1';
          statusDiv.style.transform = 'translateX(-50%) translateY(0)';
        }, 100);
      }
      
      // ë™ê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateSyncStatus(message, type = 'info') {
        const indicator = document.getElementById('syncStatusIndicator');
        if (!indicator) return;
        
        const colors = {
          success: '#10b981',
          error: '#ef4444',
          warning: '#f59e0b',
          info: '#3b82f6'
        };
        
        indicator.textContent = message;
        indicator.style.background = colors[type] || colors.info;
        
        // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
        setTimeout(() => {
          indicator.style.opacity = '0';
          indicator.style.transform = 'translateX(-50%) translateY(-20px)';
          setTimeout(() => {
            if (indicator.parentNode) {
              indicator.parentNode.removeChild(indicator);
            }
          }, 300);
        }, 3000);
      }
      

    </script>

         <!-- Firebase SDK ìŠ¤í¬ë¦½íŠ¸ -->
     <script type="module">
       // Import the functions you need from the SDKs you need
       import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
       import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
       import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
       // TODO: Add SDKs for Firebase products that you want to use
       // https://firebase.google.com/docs/web/setup#available-libraries

       // Your web app's Firebase configuration
       // For Firebase JS SDK v7.20.0 and later, measurementId is optional
       const firebaseConfig = {
         apiKey: "AIzaSyBhndv9tfh_Uu8Nkm7AZxjRCNIgvnGEj_c",
         authDomain: "travelplan250826.firebaseapp.com",
         projectId: "travelplan250826",
         storageBucket: "travelplan250826.firebasestorage.app",
         messagingSenderId: "918345537744",
         appId: "1:918345537744:web:08d0daace8cb0ec021e6d5",
         measurementId: "G-18R59NTNBT"
       };

       // Initialize Firebase
       const app = initializeApp(firebaseConfig);
       const analytics = getAnalytics(app);
       
       // Initialize Firestore
       const db = getFirestore(app);
       try {
         await enableIndexedDbPersistence(db);
         console.log('Firestore ì˜¤í”„ë¼ì¸ í¼ì‹œìŠ¤í„´ìŠ¤ í™œì„±í™”ë¨');
       } catch (err) {
         console.warn('ì˜¤í”„ë¼ì¸ í¼ì‹œìŠ¤í„´ìŠ¤ í™œì„±í™” ì‹¤íŒ¨:', err);
       }
       
       console.log('Firebase Firestore ì—°ê²° ì™„ë£Œ!');
       
       // ì „ì—­ ë³€ìˆ˜ë¡œ dbë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
       window.db = db;
       window.firestore = {
         collection,
         doc,
         setDoc,
         getDoc,
         updateDoc,
         arrayUnion,
         onSnapshot,
         serverTimestamp
       };
     </script>
    
    <!-- êµ¬ê¸€ ë§µ API ìŠ¤í¬ë¦½íŠ¸. API í‚¤ì™€ ì½œë°± í•¨ìˆ˜(initMap) ì§€ì • -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDVwJrvIcbqAOX24g9JODhD7DGtTz7z2Pg&libraries=geometry&callback=initMap" async defer></script>
</body>
</html>

