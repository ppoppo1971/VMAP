<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>브이월드 WFS 예제3</title>
  <link rel="stylesheet" href="https://openlayers.org/en/v6.15.1/css/ol.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    .ol-zoom { font-size: 1rem; }
    .toolbar { position: absolute; top: 10px; left: 10px; z-index: 1000; }
    .toolbar button { padding: 8px 12px; border: 1px solid #ccc; background: #fff; border-radius: 4px; cursor: pointer; }
    .toolbar button:disabled { opacity: .6; cursor: not-allowed; }
  </style>
  <!-- GitHub Pages 캐시 관련: 강제 새로고침 필요 시, 쿼리스트링 버전을 바꾸세요. -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="referrer" content="no-referrer-when-downgrade" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="description" content="브이월드 WMTS 배경지도 + WFS 피처 로딩 예제" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="preconnect" href="https://openlayers.org" />
  <link rel="preconnect" href="https://api.vworld.kr" />
  <link rel="dns-prefetch" href="https://openlayers.org" />
  <link rel="dns-prefetch" href="https://api.vworld.kr" />
  <link rel="icon" href="data:," />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; script-src 'self' https://openlayers.org 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://openlayers.org; img-src 'self' https://api.vworld.kr data:; connect-src 'self' https://api.vworld.kr;" />
</head>
<body>
  <div class="toolbar">
    <button id="btnCadastral">지적도근점 불러오기</button>
  </div>
  <div id="map"></div>

  <script src="https://openlayers.org/en/v6.15.1/build/ol.js"></script>
  <script>
    // 브이월드 인증 정보
    const VWORLD_KEY = '46F4304E-84DC-3F56-92F1-6A98A0370A31';
    const VWORLD_DOMAIN = encodeURIComponent('https://ppoppo1971.github.io');

    // 배경지도(WMTS)
    const baseLayer = new ol.layer.Tile({
      source: new ol.source.XYZ({
        url: `https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_KEY}/Base/{z}/{y}/{x}.png?domain=${VWORLD_DOMAIN}`,
        maxZoom: 19
      })
    });

    // WFS 설정
    // 대표 타입명:
    // - 시도: LT_C_ADSIDO_INFO
    // - 시군구: LT_C_ADSIGG_INFO
    // - 읍면동: LT_C_ADEMD_INFO
    const TYPE_NAME = 'LT_C_ADSIDO_INFO';

    const wfsSource = new ol.source.Vector({
      format: new ol.format.GeoJSON(),
      url: function(extent) {
        // EPSG:3857 기준 BBOX 요청
        const params = new URLSearchParams({
          service: 'WFS',
          version: '1.1.0',
          request: 'GetFeature',
          typename: TYPE_NAME,
          output: 'application/json',
          srsName: 'EPSG:3857',
          bbox: `${extent.join(',')},EPSG:3857`,
          key: VWORLD_KEY,
          domain: decodeURIComponent(VWORLD_DOMAIN)
        });
        return `https://api.vworld.kr/req/wfs?${params.toString()}`;
      },
      strategy: ol.loadingstrategy.bbox
    });

    const wfsLayer = new ol.layer.Vector({
      source: wfsSource,
      style: new ol.style.Style({
        stroke: new ol.style.Stroke({ color: '#0066ff', width: 2 }),
        fill: new ol.style.Fill({ color: 'rgba(0,102,255,0.10)' })
      })
    });

    // 지도 생성
    const map = new ol.Map({
      target: 'map',
      layers: [baseLayer, wfsLayer],
      view: new ol.View({
        center: ol.proj.fromLonLat([127.5, 36.5]),
        zoom: 7,
        minZoom: 4,
        maxZoom: 19
      }),
      controls: ol.control.defaults()
    });

    // 지적도근점 레이어 자동 추가: GetCapabilities에서 typename을 키워드로 탐색 후 추가
    const CADASTRAL_CONTROL_TYPENAME = '';
    const CADASTRAL_KEYWORDS = ['지적도근점', '지적 근점', '근점', 'cadastral', 'control'];

    function parseXml(text) {
      try {
        return new window.DOMParser().parseFromString(text, 'text/xml');
      } catch (e) {
        return null;
      }
    }

    function extractText(node, tagNames) {
      for (const tag of tagNames) {
        const el = node.getElementsByTagName(tag)[0] || node.getElementsByTagNameNS('*', tag)[0];
        if (el && el.textContent) return el.textContent.trim();
      }
      return '';
    }

    async function discoverCadastralControlTypeName() {
      try {
        const url = `https://api.vworld.kr/req/wfs?service=WFS&request=GetCapabilities&key=${VWORLD_KEY}&domain=${decodeURIComponent(VWORLD_DOMAIN)}`;
        const res = await fetch(url, { mode: 'cors' });
        const xmlText = await res.text();
        const doc = parseXml(xmlText);
        if (!doc) return null;

        const featureTypeLists = [
          ...Array.from(doc.getElementsByTagName('FeatureType')),
          ...Array.from(doc.getElementsByTagNameNS('*', 'FeatureType'))
        ];

        for (const ft of featureTypeLists) {
          const name = extractText(ft, ['Name', 'name']);
          const title = extractText(ft, ['Title', 'title']);
          const hay = `${name} ${title}`;
          if (!hay) continue;
          const matched = CADASTRAL_KEYWORDS.some(k => hay.includes(k));
          if (matched && name) return name;
        }
        return null;
      } catch (e) {
        console.warn('Capabilities 조회 실패', e);
        return null;
      }
    }

    function createCadastralLayer(typename) {
      const source = new ol.source.Vector({
        format: new ol.format.GeoJSON(),
        url: function(extent) {
          const params = new URLSearchParams({
            service: 'WFS',
            version: '1.1.0',
            request: 'GetFeature',
            typename: typename,
            output: 'application/json',
            srsName: 'EPSG:3857',
            bbox: `${extent.join(',')},EPSG:3857`,
            key: VWORLD_KEY,
            domain: decodeURIComponent(VWORLD_DOMAIN)
          });
          return `https://api.vworld.kr/req/wfs?${params.toString()}`;
        },
        strategy: ol.loadingstrategy.bbox
      });

      const layer = new ol.layer.Vector({
        source: source,
        style: new ol.style.Style({
          image: new ol.style.Circle({
            radius: 4,
            fill: new ol.style.Fill({ color: '#ff3b30' }),
            stroke: new ol.style.Stroke({ color: '#ffffff', width: 1 })
          })
        })
      });
      return layer;
    }

    let cadastralLayer = null;
    let discoveredCadastralTypeName = '';
    const btn = document.getElementById('btnCadastral');

    btn.addEventListener('click', async () => {
      if (cadastralLayer) return; // 이미 추가됨
      btn.disabled = true;
      btn.textContent = '불러오는 중...';

      try {
        let typeName = CADASTRAL_CONTROL_TYPENAME && CADASTRAL_CONTROL_TYPENAME.trim();
        if (!typeName) {
          if (!discoveredCadastralTypeName) {
            discoveredCadastralTypeName = await discoverCadastralControlTypeName() || '';
          }
          typeName = discoveredCadastralTypeName;
        }

        if (typeName) {
          cadastralLayer = createCadastralLayer(typeName);
          map.addLayer(cadastralLayer);
          console.info('지적도근점 typename:', typeName);
          btn.textContent = '지적도근점 추가됨';
        } else {
          console.warn('지적도근점 typename을 찾지 못했습니다.');
          alert('지적도근점 데이터를 찾지 못했습니다. typename을 수동으로 지정해 주세요.');
          btn.textContent = '지적도근점 불러오기';
          btn.disabled = false;
        }
      } catch (e) {
        console.error(e);
        alert('지적도근점 레이어 추가 중 오류가 발생했습니다.');
        btn.textContent = '지적도근점 불러오기';
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>


