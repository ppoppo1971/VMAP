<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>브이월드 지도 (OpenLayers 버전)</title>
    
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css" type="text/css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f5f5f5;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .controls h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .control-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-item label {
            font-weight: bold;
            color: #34495e;
            font-size: 14px;
        }

        select, button, input {
            padding: 10px 15px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            border-color: #3498db;
            outline: none;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        .map-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 600px;
            border: none;
        }

        .info-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .info-panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .coordinate-display {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .coordinate-display p {
            margin: 5px 0;
            font-family: monospace;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            #map {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🗺️ 브이월드 지도 웹페이지 (OpenLayers)</h1>
        <p>OpenLayers를 이용한 브이월드 지도 서비스</p>
    </div>

    <div class="container">
        <div class="controls">
            <h3>지도 설정</h3>
            <div class="control-group">
                <div class="control-item">
                    <label for="mapType">지도 종류</label>
                    <select id="mapType">
                        <option value="Base">기본지도</option>
                        <option value="Satellite">위성지도</option>
                        <option value="Hybrid">하이브리드</option>
                        <option value="Gray">회색지도</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label for="overlayType">지적정보 레이어</label>
                    <select id="overlayType">
                        <option value="">선택안함</option>
                        <option value="cadastral">연속지적도</option>
                        <option value="controlpoint">지적도근점</option>
                        <option value="both">모두 표시</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label for="searchLocation">위치 검색</label>
                    <input type="text" id="searchLocation" placeholder="예: 서울시청" />
                </div>
                
                <button onclick="searchAndMove()">위치 이동</button>
                <button onclick="getCurrentLocation()">현재 위치</button>
                <button onclick="resetView()">초기 화면</button>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>

        <div class="info-panel">
            <h3>지도 정보</h3>
            <div class="coordinate-display">
                <p><strong>현재 중심점:</strong></p>
                <p>위도: <span id="currentLat">37.5665</span></p>
                <p>경도: <span id="currentLng">126.9780</span></p>
                <p>줌 레벨: <span id="currentZoom">10</span></p>
                <p><strong>활성 레이어:</strong> <span id="activeLayer">기본지도</span></p>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: #e8f4fd; border-radius: 5px; font-size: 12px;">
                <h4 style="margin-bottom: 8px; color: #2c3e50;">💡 사용 팁</h4>
                <p>• 지적도근점/연속지적도를 선택하면 해당 레이어가 표시됩니다</p>
                <p>• 지적정보를 클릭하면 상세 정보를 확인할 수 있습니다</p>
                <p>• 줌 레벨이 높을수록 더 많은 정보가 로드됩니다</p>
            </div>
        </div>
    </div>

    <!-- OpenLayers JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
    
    <script>
        let map;
        let vectorSource;
        let vectorLayer;
        let cadastralLayer;
        let controlPointLayer;
        let wfsLayers = {};
        
        // VWorld 지도 레이어들
        const vworldLayers = {
            Base: new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://api.vworld.kr/req/wmts/1.0.0/46F4304E-84DC-3F56-92F1-6A98A0370A31/Base/{z}/{y}/{x}.png'
                })
            }),
            Satellite: new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://api.vworld.kr/req/wmts/1.0.0/46F4304E-84DC-3F56-92F1-6A98A0370A31/Satellite/{z}/{y}/{x}.jpeg'
                })
            }),
            Hybrid: new ol.layer.Group({
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.XYZ({
                            url: 'https://api.vworld.kr/req/wmts/1.0.0/46F4304E-84DC-3F56-92F1-6A98A0370A31/Satellite/{z}/{y}/{x}.jpeg'
                        })
                    }),
                    new ol.layer.Tile({
                        source: new ol.source.XYZ({
                            url: 'https://api.vworld.kr/req/wmts/1.0.0/46F4304E-84DC-3F56-92F1-6A98A0370A31/Hybrid/{z}/{y}/{x}.png'
                        })
                    })
                ]
            }),
            Gray: new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://api.vworld.kr/req/wmts/1.0.0/46F4304E-84DC-3F56-92F1-6A98A0370A31/gray/{z}/{y}/{x}.png'
                })
            })
        };

        // WFS 레이어 생성 함수
        function createWFSLayer(layerName, typeName, styleConfig) {
            const vectorSource = new ol.source.Vector({
                format: new ol.format.GeoJSON(),
                url: function(extent) {
                    const bbox = ol.proj.transformExtent(extent, 'EPSG:3857', 'EPSG:4326');
                    
                    // 현재 도메인 자동 감지 (등록된 도메인 사용)
                    let domain = window.location.origin;
                    
                    // GitHub Pages 도메인으로 설정 (브이월드에 등록된 도메인)
                    if (domain.includes('localhost') || domain.includes('127.0.0.1') || domain.includes('file:')) {
                        domain = 'https://ppoppo1971.github.io';
                    }
                    
                    console.log('사용할 도메인:', domain);
                    
                    return `https://api.vworld.kr/req/data?service=wfs&version=1.0.0&request=GetFeature&typename=${typeName}&outputformat=application/json&srsname=EPSG:4326&bbox=${bbox.join(',')}&apikey=46F4304E-84DC-3F56-92F1-6A98A0370A31&domain=${encodeURIComponent(domain)}`;
                },
                strategy: ol.loadingstrategy.bbox
            });

            return new ol.layer.Vector({
                source: vectorSource,
                style: styleConfig,
                visible: false
            });
        }

        // 지적도근점 스타일
        const controlPointStyle = new ol.style.Style({
            image: new ol.style.Circle({
                radius: 4,
                fill: new ol.style.Fill({
                    color: '#ff0000'
                }),
                stroke: new ol.style.Stroke({
                    color: '#ffffff',
                    width: 2
                })
            }),
            text: new ol.style.Text({
                font: '12px Arial',
                fill: new ol.style.Fill({
                    color: '#000000'
                }),
                stroke: new ol.style.Stroke({
                    color: '#ffffff',
                    width: 2
                }),
                offsetY: -15
            })
        });

        // 연속지적도 스타일
        const cadastralStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: '#0066cc',
                width: 1.5
            }),
            fill: new ol.style.Fill({
                color: 'rgba(0, 102, 204, 0.1)'
            })
        });

        // WFS 레이어들 초기화
        function initWFSLayers() {
            // 지적도근점 레이어
            controlPointLayer = createWFSLayer('controlpoint', 'lt_c_uq115', function(feature) {
                const style = controlPointStyle.clone();
                // 도근점 번호 표시
                const pointNo = feature.get('point_no') || feature.get('cp_no') || '';
                style.getText().setText(pointNo);
                return style;
            });

            // 연속지적도 레이어
            cadastralLayer = createWFSLayer('cadastral', 'lt_c_upis213', cadastralStyle);

            // 로딩 이벤트 리스너 추가
            controlPointLayer.getSource().on('loadstart', function() {
                console.log('지적도근점 데이터 로딩 시작...');
            });
            
            controlPointLayer.getSource().on('loadend', function() {
                console.log('지적도근점 데이터 로딩 완료');
            });
            
            controlPointLayer.getSource().on('loaderror', function(event) {
                console.error('지적도근점 데이터 로딩 오류:', event);
                alert('지적도근점 데이터를 불러오는데 실패했습니다.\n도메인 등록 상태를 확인해주세요.');
            });
            
            cadastralLayer.getSource().on('loadstart', function() {
                console.log('연속지적도 데이터 로딩 시작...');
            });
            
            cadastralLayer.getSource().on('loadend', function() {
                console.log('연속지적도 데이터 로딩 완료');
            });
            
            cadastralLayer.getSource().on('loaderror', function(event) {
                console.error('연속지적도 데이터 로딩 오류:', event);
                alert('연속지적도 데이터를 불러오는데 실패했습니다.\n도메인 등록 상태를 확인해주세요.');
            });

            wfsLayers = {
                controlpoint: controlPointLayer,
                cadastral: cadastralLayer
            };
        }

        // 지도 초기화
        function initMap() {
            console.log('OpenLayers 지도 초기화 시작');
            
            // WFS 레이어들 초기화
            initWFSLayers();
            
            // 마커용 벡터 소스와 레이어
            vectorSource = new ol.source.Vector();
            vectorLayer = new ol.layer.Vector({
                source: vectorSource,
                style: new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.5, 1],
                        src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDOC4xMyAyIDUgNS4xMyA1IDlDNSAxNC4yNSAxMiAyMiAxMiAyMkMxMiAyMiAxOSAxNC4yNSAxOSA5QzE5IDUuMTMgMTUuODcgMiAxMiAyWk0xMiAxMS41QzEwLjYyIDExLjUgOS41IDEwLjM4IDkuNSA5QzkuNSA3LjYyIDEwLjYyIDYuNSAxMiA2LjVDMTMuMzggNi41IDE0LjUgNy42MiAxNC41IDlDMTQuNSAxMC4zOCAxMy4zOCAxMS41IDEyIDExLjVaIiBmaWxsPSIjZTc0YzNjIi8+Cjwvc3ZnPgo=',
                        scale: 1.5
                    })
                })
            });

            // 지도 생성
            map = new ol.Map({
                target: 'map',
                layers: [
                    vworldLayers.Base,  // 기본 레이어
                    cadastralLayer,     // 연속지적도 레이어
                    controlPointLayer,  // 지적도근점 레이어
                    vectorLayer         // 마커 레이어
                ],
                view: new ol.View({
                    center: ol.proj.fromLonLat([126.9780, 37.5665]), // 서울시청
                    zoom: 10
                })
            });

            // 지도 클릭 이벤트
            map.on('click', function(evt) {
                const coordinate = evt.coordinate;
                const lonLat = ol.proj.toLonLat(coordinate);
                
                updateCoordinateDisplay(lonLat[0], lonLat[1]);
                
                // 클릭된 피처 확인
                const features = map.getFeaturesAtPixel(evt.pixel);
                
                if (features.length > 0) {
                    const feature = features[0];
                    const properties = feature.getProperties();
                    
                    // 지적정보 팝업 표시
                    showFeatureInfo(properties, lonLat);
                } else {
                    // 기존 마커 제거
                    vectorSource.clear();
                    
                    // 새 마커 추가
                    const marker = new ol.Feature({
                        geometry: new ol.geom.Point(coordinate)
                    });
                    
                    vectorSource.addFeature(marker);
                }
            });

            // 지도 이동 이벤트
            map.on('moveend', function() {
                const view = map.getView();
                const center = view.getCenter();
                const lonLat = ol.proj.toLonLat(center);
                const zoom = view.getZoom();
                
                updateCoordinateDisplay(lonLat[0], lonLat[1], Math.round(zoom));
            });

            // 지도 타입 변경 이벤트
            document.getElementById('mapType').addEventListener('change', function() {
                const selectedType = this.value;
                
                // 기존 지도 레이어 제거 (WFS 레이어와 마커 레이어 제외)
                map.getLayers().forEach(function(layer) {
                    if (layer !== vectorLayer && layer !== cadastralLayer && layer !== controlPointLayer) {
                        map.removeLayer(layer);
                    }
                });
                
                // 새 지도 레이어 추가 (가장 아래에)
                map.getLayers().insertAt(0, vworldLayers[selectedType]);
            });

            // 지적정보 레이어 변경 이벤트
            document.getElementById('overlayType').addEventListener('change', function() {
                const selectedType = this.value;
                
                // 모든 WFS 레이어 숨기기
                cadastralLayer.setVisible(false);
                controlPointLayer.setVisible(false);
                
                // 선택된 레이어만 표시
                switch(selectedType) {
                    case 'cadastral':
                        cadastralLayer.setVisible(true);
                        updateActiveLayerDisplay('기본지도 + 연속지적도');
                        console.log('연속지적도 레이어 활성화');
                        break;
                    case 'controlpoint':
                        controlPointLayer.setVisible(true);
                        updateActiveLayerDisplay('기본지도 + 지적도근점');
                        console.log('지적도근점 레이어 활성화');
                        break;
                    case 'both':
                        cadastralLayer.setVisible(true);
                        controlPointLayer.setVisible(true);
                        updateActiveLayerDisplay('기본지도 + 지적정보');
                        console.log('모든 지적정보 레이어 활성화');
                        break;
                    default:
                        updateActiveLayerDisplay('기본지도');
                        console.log('지적정보 레이어 비활성화');
                }
            });

            // 초기 좌표 표시
            updateCoordinateDisplay(126.9780, 37.5665, 10);
            
            console.log('OpenLayers 지도 초기화 완료');
        }

        // 좌표 표시 업데이트
        function updateCoordinateDisplay(lng, lat, zoom) {
            document.getElementById('currentLat').textContent = lat.toFixed(6);
            document.getElementById('currentLng').textContent = lng.toFixed(6);
            if (zoom !== undefined) {
                document.getElementById('currentZoom').textContent = zoom;
            }
        }

        // 활성 레이어 표시 업데이트
        function updateActiveLayerDisplay(layerInfo) {
            document.getElementById('activeLayer').textContent = layerInfo;
        }

        // 피처 정보 표시
        function showFeatureInfo(properties, coordinate) {
            let infoContent = '<div style="max-width: 300px;">';
            infoContent += '<h4 style="margin-bottom: 10px; color: #2c3e50;">📍 지적정보</h4>';
            
            // 속성 정보 표시
            Object.keys(properties).forEach(function(key) {
                if (key !== 'geometry' && properties[key] !== null && properties[key] !== '') {
                    const value = properties[key];
                    const displayKey = getDisplayName(key);
                    infoContent += `<p><strong>${displayKey}:</strong> ${value}</p>`;
                }
            });
            
            infoContent += `<p><strong>좌표:</strong> ${coordinate[1].toFixed(6)}, ${coordinate[0].toFixed(6)}</p>`;
            infoContent += '</div>';
            
            // 알림으로 표시 (실제 프로젝트에서는 팝업 오버레이 사용 권장)
            alert(infoContent.replace(/<[^>]*>/g, '\n').replace(/&nbsp;/g, ' '));
        }

        // 속성명을 한글로 변환
        function getDisplayName(key) {
            const nameMap = {
                'point_no': '도근점번호',
                'cp_no': '도근점번호',
                'instl_de': '설치일자',
                'manage_no': '관리번호',
                'pnu': '필지고유번호',
                'jibun': '지번',
                'bchk': '법정동코드',
                'sgg_oid': '시군구코드',
                'col_adm_se': '관할청구분',
                'geometry': '공간정보'
            };
            
            return nameMap[key] || key;
        }

        // 위치 검색 및 이동
        function searchAndMove() {
            const location = document.getElementById('searchLocation').value.trim();
            
            if (!location) {
                alert('검색할 위치를 입력해주세요.');
                return;
            }

            const locations = {
                '서울시청': { lat: 37.5665, lng: 126.9780 },
                '부산시청': { lat: 35.1796, lng: 129.0756 },
                '대구시청': { lat: 35.8714, lng: 128.6014 },
                '인천시청': { lat: 37.4563, lng: 126.7052 },
                '광주시청': { lat: 35.1595, lng: 126.8526 },
                '대전시청': { lat: 36.3504, lng: 127.3845 },
                '울산시청': { lat: 35.5384, lng: 129.3114 },
                '세종시청': { lat: 36.4800, lng: 127.2890 },
                '경기도청': { lat: 37.2636, lng: 127.0286 },
                '강원도청': { lat: 37.8228, lng: 128.1555 },
                '충청북도청': { lat: 36.6424, lng: 127.4890 },
                '충청남도청': { lat: 36.5184, lng: 126.8000 },
                '전라북도청': { lat: 35.7175, lng: 127.1530 },
                '전라남도청': { lat: 34.8679, lng: 126.9910 },
                '경상북도청': { lat: 36.4919, lng: 128.8889 },
                '경상남도청': { lat: 35.4606, lng: 128.2132 },
                '제주도청': { lat: 33.4890, lng: 126.4983 }
            };

            const coords = locations[location];
            
            if (coords) {
                moveToLocation(coords.lng, coords.lat);
                document.getElementById('searchLocation').value = '';
            } else {
                alert('해당 위치를 찾을 수 없습니다. 지원되는 위치:\n' + Object.keys(locations).join(', '));
            }
        }

        // 특정 위치로 이동
        function moveToLocation(lng, lat, zoom = 15) {
            const coordinate = ol.proj.fromLonLat([lng, lat]);
            
            map.getView().animate({
                center: coordinate,
                zoom: zoom,
                duration: 1000
            });
            
            // 마커 추가
            vectorSource.clear();
            const marker = new ol.Feature({
                geometry: new ol.geom.Point(coordinate)
            });
            vectorSource.addFeature(marker);
        }

        // 현재 위치 가져오기
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        moveToLocation(lng, lat);
                        alert(`현재 위치로 이동했습니다.\n위도: ${lat.toFixed(6)}, 경도: ${lng.toFixed(6)}`);
                    },
                    function(error) {
                        alert('현재 위치를 가져올 수 없습니다: ' + error.message);
                    }
                );
            } else {
                alert('이 브라우저는 위치 서비스를 지원하지 않습니다.');
            }
        }

        // 초기 화면으로 돌아가기
        function resetView() {
            moveToLocation(126.9780, 37.5665, 10);
            document.getElementById('mapType').value = 'Base';
            
            // 기본 지도로 변경
            map.getLayers().forEach(function(layer) {
                if (layer !== vectorLayer && layer !== cadastralLayer && layer !== controlPointLayer) {
                    map.removeLayer(layer);
                }
            });
            map.getLayers().insertAt(0, vworldLayers.Base);
            
            // 지적정보 레이어 초기화
            document.getElementById('overlayType').value = '';
            cadastralLayer.setVisible(false);
            controlPointLayer.setVisible(false);
        }

        // Enter 키로 검색
        document.getElementById('searchLocation').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchAndMove();
            }
        });

        // 페이지 로드 후 지도 초기화
        window.onload = function() {
            console.log('페이지 로드 완료 - OpenLayers 초기화');
            try {
                initMap();
            } catch (error) {
                console.error('지도 초기화 오류:', error);
                document.getElementById('map').innerHTML = 
                    '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; color: #666; flex-direction: column; padding: 20px; text-align: center;">' +
                    '<h3 style="color: #e74c3c; margin-bottom: 20px;">지도 로드 오류</h3>' +
                    '<p>지도를 로드하는 중 오류가 발생했습니다.</p>' +
                    '<p>브라우저 개발자 도구를 확인해주세요.</p>' +
                    '</div>';
            }
        };
    </script>
</body>
</html>
