<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>index02</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            width: 100vw;
            height: 100vh;
            min-height: 100%;
        }
        h1 {
            display: none;
        }
        /* 활성 지도 배지 */
        #activeMapBadge {
            position: absolute;
            top: 10px;
            left: 30px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 4px;
            padding: 8px 12px;
            font-weight: 800;
            font-size: 1rem;
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* 지도 타입 변경 버튼 */
        #mapTypeControl {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        #mapTypeControl button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Noto Sans KR', sans-serif;
        }
        #mapTypeControl button:hover {
            background: #f0f0f0;
        }
        #mapTypeControl button.active {
            background: #007cff;
            color: white;
        }
        /* 경계 컨트롤 */
        #boundaryControl {
            position: absolute;
            top: 80px;
            right: 10px;
            z-index: 1000;
            background: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        #boundaryControl button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Noto Sans KR', sans-serif;
        }
        #boundaryControl button:hover {
            background: #f0f0f0;
        }
        #boundaryControl button.active {
            background: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <h1>브이월드 지도</h1>
    <!-- 지도를 표시할 div 요소 -->
    <div id="map"></div>
    <!-- 현재 활성 지도 표시 배지 -->
    <div id="activeMapBadge" aria-live="polite">브이월드 - 일반</div>
    <!-- 지도 타입 변경 컨트롤 -->
    <div id="mapTypeControl">
        <button id="baseBtn" class="active" onclick="switchMapType('base')">일반</button>
        <button id="satelliteBtn" onclick="switchMapType('satellite')">영상</button>
    </div>
    <!-- 경계 표시 컨트롤 -->
    <div id="boundaryControl">
        <button id="sidoBtn" onclick="toggleBoundary('sido')">시도</button>
        <button id="sigunguBtn" onclick="toggleBoundary('sigungu')">시군구</button>
        <button id="emdBtn" onclick="toggleBoundary('emd')">읍면동</button>
        <button id="clearBtn" onclick="clearBoundaries()">경계지우기</button>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
      let map;
      let currentMapType = 'base';
      let baseLayer, satelliteLayer;
      let boundaryLayers = {};
      let activeBoundaryType = null;
      
      // 브이월드 API 설정
      const VWORLD_CONFIG = {
        API_KEY: '46F4304E-84DC-3F56-92F1-6A98A0370A31',
        DOMAIN: 'https://ppoppo1971.github.io/VMAP',
        WFS_URL: 'http://api.vworld.kr/ned/wfs/getAdresSpceWFS'
      };
      
      // 활성 지도 배지 갱신
      function setActiveMapBadge(text) {
        const el = document.getElementById('activeMapBadge');
        if (el && el.textContent !== text) el.textContent = text;
      }
      
      // 지도 타입 변경 함수
      function switchMapType(type) {
        if (type === currentMapType) return;
        
        // 기존 레이어 제거
        if (currentMapType === 'base' && baseLayer) {
          map.removeLayer(baseLayer);
        } else if (currentMapType === 'satellite' && satelliteLayer) {
          map.removeLayer(satelliteLayer);
        }
        
        // 새 레이어 추가
        if (type === 'base') {
          if (!baseLayer) {
            baseLayer = L.tileLayer('https://xdworld.vworld.kr/2d/Base/service/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '© VWorld'
            });
          }
          baseLayer.addTo(map);
          setActiveMapBadge('브이월드 - 일반');
          document.getElementById('baseBtn').classList.add('active');
          document.getElementById('satelliteBtn').classList.remove('active');
        } else if (type === 'satellite') {
          if (!satelliteLayer) {
            satelliteLayer = L.tileLayer('https://xdworld.vworld.kr/2d/Satellite/service/{z}/{x}/{y}.jpeg', {
              maxZoom: 19,
              attribution: '© VWorld'
            });
          }
          satelliteLayer.addTo(map);
          setActiveMapBadge('브이월드 - 영상');
          document.getElementById('satelliteBtn').classList.add('active');
          document.getElementById('baseBtn').classList.remove('active');
        }
        
        currentMapType = type;
      }
      
      // 지도 초기화
      function initMap() {
        // 서울 시청 중심으로 지도 생성
        map = L.map('map').setView([37.5665, 126.9780], 12);
        
        // 기본 브이월드 일반 지도 레이어 추가
        baseLayer = L.tileLayer('https://xdworld.vworld.kr/2d/Base/service/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '© VWorld'
        }).addTo(map);
        
        // 위성 지도 레이어 생성 (초기에는 추가하지 않음)
        satelliteLayer = L.tileLayer('https://xdworld.vworld.kr/2d/Satellite/service/{z}/{x}/{y}.jpeg', {
          maxZoom: 19,
          attribution: '© VWorld'
        });
        
        // 초기 배지 설정
        setActiveMapBadge('브이월드 - 일반');
      }
      
      // 브이월드 WFS API로 경계 데이터 조회
      async function fetchBoundaryData(typename, bbox) {
        const params = new URLSearchParams({
          key: VWORLD_CONFIG.API_KEY,
          domain: VWORLD_CONFIG.DOMAIN,
          typename: typename,
          bbox: bbox,
          maxFeatures: '50',
          resultType: 'results',
          srsName: 'EPSG:4326',
          output: 'application/json'
        });
        
        try {
          const response = await fetch(`${VWORLD_CONFIG.WFS_URL}?${params.toString()}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          return data;
        } catch (error) {
          console.error('경계 데이터 조회 오류:', error);
          return null;
        }
      }
      
      // 경계 표시/숨기기 토글
      async function toggleBoundary(type) {
        const typeMapping = {
          'sido': 'dt_d001_sig',
          'sigungu': 'dt_d001_sig', 
          'emd': 'dt_d001_emd'
        };
        
        const typename = typeMapping[type];
        if (!typename) return;
        
        // 이미 활성화된 경계라면 제거
        if (activeBoundaryType === type) {
          clearBoundaries();
          return;
        }
        
        // 기존 경계 제거
        clearBoundaries();
        
        // 현재 지도 영역의 bbox 계산
        const bounds = map.getBounds();
        const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()},EPSG:4326`;
        
        // 경계 데이터 조회
        const data = await fetchBoundaryData(typename, bbox);
        if (!data || !data.features) {
          alert('경계 데이터를 불러올 수 없습니다.');
          return;
        }
        
        // GeoJSON 레이어 생성 및 추가
        const geoJsonLayer = L.geoJSON(data, {
          style: {
            color: '#ff0000',
            weight: 2,
            opacity: 0.8,
            fillOpacity: 0.1,
            fillColor: '#ff0000'
          },
          onEachFeature: function(feature, layer) {
            if (feature.properties) {
              let popupContent = '<div style="font-family: Arial; font-size: 12px;">';
              for (const [key, value] of Object.entries(feature.properties)) {
                popupContent += `<b>${key}:</b> ${value}<br>`;
              }
              popupContent += '</div>';
              layer.bindPopup(popupContent);
            }
          }
        });
        
        geoJsonLayer.addTo(map);
        boundaryLayers[type] = geoJsonLayer;
        activeBoundaryType = type;
        
        // 버튼 상태 업데이트
        updateBoundaryButtons(type);
      }
      
      // 모든 경계 제거
      function clearBoundaries() {
        Object.values(boundaryLayers).forEach(layer => {
          map.removeLayer(layer);
        });
        boundaryLayers = {};
        activeBoundaryType = null;
        updateBoundaryButtons(null);
      }
      
      // 경계 버튼 상태 업데이트
      function updateBoundaryButtons(activeType) {
        const buttons = ['sidoBtn', 'sigunguBtn', 'emdBtn'];
        buttons.forEach(btnId => {
          const btn = document.getElementById(btnId);
          if (btn) {
            btn.classList.remove('active');
          }
        });
        
        if (activeType) {
          const activeBtn = document.getElementById(activeType + 'Btn');
          if (activeBtn) {
            activeBtn.classList.add('active');
          }
        }
      }
      
      // 페이지 로드 시 지도 초기화
      document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>

