<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í…ŒìŠ¤íŠ¸</title>
    <!-- Kakao Maps JavaScript SDK (ì§€ë„ ë Œë”ë§ìš©) -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f1268a7e77f3b182e700b92b45d98082&autoload=false&libraries=services"></script>
    
    <script>
      // íŒŒì¼ëª…ì— ë§ì¶° íƒ€ì´í‹€ ìë™ ì„¤ì •
      function setTitleFromFilename() {
        const filename = window.location.pathname.split('/').pop().replace('.html', '');
        document.title = filename;
      }
      // í˜ì´ì§€ ë¡œë“œ ì‹œ íƒ€ì´í‹€ ì„¤ì •
      window.addEventListener('load', setTitleFromFilename);
    </script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            width: 100vw;
            height: 100vh;
            min-height: 100%;
        }
        h1 {
            display: none;
        }
        /* í™œì„± ì§€ë„ ë°°ì§€ */
        #activeMapBadge {
            position: absolute;
            top: 10px;
            left: 30px;
            z-index: 15; /* ì‚¬ì´ë“œ íŒ¨ë„(z-index:10) ìœ„ */
            background: transparent;
            color: rgba(255, 255, 255, 0.95);
            border-radius: 0;
            padding: 0;
            font-weight: 700;
            font-size: 0.92rem;
            box-shadow: none;
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        #customMapMenu {
            position: absolute;
            top: 40px;
            left: 30px;
            z-index: 10;
            width: 220px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.18);
            padding: 12px 9px 9px 9px;
            display: flex;
            flex-direction: column;
            gap: 9px;
            font-family: 'Noto Sans KR', sans-serif;
            transition: box-shadow 0.2s, left 0.3s, opacity 0.3s;
        }
        #customMapMenu.hide {
            left: -260px;
            opacity: 0;
            pointer-events: none;
        }
        #customMapMenu h2 {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0 0 12px 0;
            color: #222;
        }
        .menu-group {
            margin-bottom: 5px;
        }
        .menu-group label {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 6px;
            display: block;
            color: #555;
        }
        .menu-group button {
            width: 100%;
            background: #f7f7f7;
            border: none;
            border-radius: 8px;
            padding: 5px 0;
            margin-bottom: 3px;
            font-size: 1rem;
            color: #333;
            cursor: pointer;
            transition: background 0.15s, color 0.15s;
        }
        .menu-group button:hover {
            background: #e0e7ff;
            color: #1d4ed8;
        }
        .menu-group .submenu {
            margin-left: 12px;
            margin-top: 4px;
        }
        .submenu button {
            width: 90%;
            margin-left: 5%;
        }
        /* ì‚¬ì´ë“œ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ */
        #menuToggleBtn {
            position: absolute;
            top: 50px;
            left: 18px;
            z-index: 20;
            background: #1d4ed8;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            display: none;
            align-items: center;
            justify-content: center;
        }
        #menuToggleBtn.show {
            display: flex;
        }
        #customMapMenu .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #888;
            cursor: pointer;
        }
        .toggle-btn {
            width: 100%;
            background: #f7f7f7;
            border: none;
            border-radius: 8px;
            padding: 5px 0;
            margin-bottom: 3px;
            font-size: 1rem;
            color: #333;
            cursor: pointer;
            text-align: left;
            font-weight: 600;
            transition: background 0.15s, color 0.15s;
        }
        .toggle-btn:hover {
            background: #e0e7ff;
            color: #1d4ed8;
        }
        /* í•˜ìœ„ ì˜µì…˜ ë“¤ì—¬ì“°ê¸° */
        .submenu {
            margin-left: 20px;
        }
        .submenu .submenu {
            margin-left: 20px;
        }
        .submenu button {
            width: 90%;
            margin-left: 0;
        }
        /* êµ¬ê¸€ë§µ í•˜ìœ„ ì˜µì…˜ ë“¤ì—¬ì“°ê¸° */
        #googleMapMenu > .toggle-btn {
            margin-left: 20px;
        }
        /* ë²•ì •ê²½ê³„ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        #vworldBoundaryMenu {
            margin-left: 20px;
        }
        #vworldBoundaryMenu button {
            width: 90%;
            margin-left: 0;
        }
        /* ê²€ìƒ‰ ê²°ê³¼ íŒ¨ë„ */
        #searchResultsPanel {
            display: none;
            max-height: 320px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }
        .search-results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
            font-weight: 700;
            color: #222;
        }
        .search-results-close {
            background: none;
            border: none;
            font-size: 1rem;
            color: #888;
            cursor: pointer;
        }
        .search-result-item {
            padding: 8px;
            border-radius: 8px;
            background: #f9fafb;
            margin-bottom: 6px;
            cursor: pointer;
            transition: background 0.15s, color 0.15s;
        }
        .search-result-item:hover {
            background: #e0e7ff;
            color: #1d4ed8;
        }
        .result-title {
            font-weight: 600;
            margin: 0 0 2px 0;
            font-size: 0.95rem;
        }
        .result-sub {
            margin: 0;
            font-size: 0.85rem;
            color: #555;
        }
        /* 50:50 ë¡œë“œë·° ë¶„í•  ë ˆì´ì•„ì›ƒ */
        #rvWrapper { position: absolute; top: 0; right: 0; width: 50vw; height: 100vh; z-index: 6; display: none; background: #fff; }
        body.rv-active #rvWrapper { display: block; }
        #roadview { width: 100%; height: 100%; }
        #rvWrapper .rv-close { position: absolute; top: 8px; right: 10px; z-index: 7; background: rgba(0,0,0,0.6); color: #fff; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.9rem; }
    </style>
</head>
<body>
    <h1>í…ŒìŠ¤íŠ¸</h1>
    <!-- ì§€ë„ë¥¼ í‘œì‹œí•  div ìš”ì†Œ -->
    <div id="map"></div>
    <!-- í˜„ì¬ í™œì„± ì§€ë„ í‘œì‹œ ë°°ì§€ -->
    <div id="activeMapBadge" aria-live="polite">êµ¬ê¸€ë§µ - ì¼ë°˜</div>
    <!-- ì‚¬ì´ë“œ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ (íŒ¨ë„ì´ ìˆ¨ê²¨ì¡Œì„ ë•Œë§Œ ë³´ì„) -->
    <button id="menuToggleBtn" class="show" onclick="showMenu()" title="ë©”ë‰´ ì—´ê¸°">â˜°</button>
    <!-- ì™¼ìª½ ê³ ì •í˜• ì‚¬ì´ë“œë°” ë©”ë‰´ -->
    <div id="customMapMenu" class="hide">
      <button class="close-btn" onclick="hideMenu()" title="ë‹«ê¸°">Ã—</button>
      <h2>ì§€ë„ ìœ í˜• ì„ íƒ</h2>
      <div class="menu-group">
        <input type="text" id="addressInput" placeholder="ì¥ì†Œ/ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width: 98%; margin-bottom: 6px;" onkeydown="if(event.key==='Enter'){searchAddress();}">
        <div id="searchResultsPanel">
          <div class="search-results-header">
            <span>ê²€ìƒ‰ ê²°ê³¼</span>
            <button class="search-results-close" onclick="hideSearchResults()">ë‹«ê¸°</button>
          </div>
          <div id="searchResultsList"></div>
        </div>
      </div>
      <div class="menu-group">
        <button id="googleMapToggleBtn" class="toggle-btn" onclick="toggleGoogleMapMenu()">+êµ¬ê¸€ë§µ</button>
        <div id="googleMapMenu" style="display:none; margin-top:8px; margin-left:20px;">
          <button id="roadmapToggleBtn" class="toggle-btn" style="margin-left:0;" onclick="toggleRoadmapMenuAndSetRoadmap()">+ì¼ë°˜</button>
          <div id="roadmapMenu" class="submenu" style="display:none;">
            <button onclick="setMapType('terrain')">ì§€í˜•</button>
          </div>
          <button id="satelliteToggleBtn" class="toggle-btn" style="margin-left:0;" onclick="toggleSatelliteMenuAndSetSatellite()">+ìœ„ì„±</button>
          <div id="satelliteMenu" class="submenu" style="display:none;">
            <button onclick="setMapType('hybrid')">í•˜ì´ë¸Œë¦¬ë“œ</button>
          </div>
        </div>
      </div>
      <div class="menu-group">
        <button id="vworldToggleBtn" class="toggle-btn" onclick="toggleVworldMenu()">+ë¸Œì´ì›”ë“œ</button>
        <div id="vworldMenu" class="submenu" style="display:none;">
          <button onclick="setMapType('ë¸Œì´ì›”ë“œì¼ë°˜')">ì¼ë°˜</button>
          <button onclick="setMapType('ë¸Œì´ì›”ë“œì˜ìƒ')">ì˜ìƒ</button>
        </div>
      </div>
      <div class="menu-group">
        <button id="kakaoMapToggleBtn" class="toggle-btn" onclick="toggleKakaoMapMenu()">+ì¹´ì¹´ì˜¤ë§µ</button>
      <div id="kakaoMapMenu" style="display:none; margin-top:8px; margin-left:20px;">
          <button onclick="loadKakaoMap('normal')">ì¼ë°˜</button>
          <button onclick="loadKakaoMap('skyview')">ìŠ¤ì¹´ì´ë·°</button>
          <button onclick="toggleRoadview()">ë¡œë“œë·°</button>
        </div>
      </div>
      <div class="menu-group">
        <button id="vworldBoundaryToggleBtn" class="toggle-btn" onclick="toggleVworldBoundaryMenu()">+ë²•ì •ê²½ê³„</button>
        <div id="vworldBoundaryMenu" class="submenu" style="display:none;">
          <button onclick="loadVworldBoundary('lt_c_adsigg')">ì‹œêµ°êµ¬</button>
          <button onclick="loadVworldBoundary('lt_c_ademd')">ìë©´ë™</button>
          <button onclick="loadVworldBoundary('lt_c_adri')">ë¦¬</button>
          <button onclick="clearVworldBoundary()">ê²½ê³„ì œê±°</button>
        </div>
      </div>
      <div class="menu-group">
        <button id="cadastralToggleBtn" class="toggle-btn" onclick="toggleCadastralOverlay()">ì—°ì†ì§€ì ë„</button>
      </div>
    </div>
    <div id="kakaoMapContainer" style="display:none; width:100vw; height:100vh; position:absolute; top:0; left:0; z-index:5;">
      <div id="kakaoMapDiv" style="width:100%; height:100%;"></div>
    </div>
    <!-- 50:50 ìš°ì¸¡ ë¡œë“œë·° íŒ¨ë„ -->
    <div id="rvWrapper">
      <button class="rv-close" onclick="closeRoadviewAll()" title="ë¡œë“œë·° ë‹«ê¸°">Ã—</button>
      <div id="roadview"></div>
    </div>
    <script>
      let map; // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸
      // ì¹´ì¹´ì˜¤ REST APIë¥¼ í†µí•œ ì£¼ì†Œ ë³€í™˜ ì‚¬ìš© (ë¸Œë¼ìš°ì € ì§ì ‘ í˜¸ì¶œ)
      let vworldBoundaryOverlay = null; // ë¸Œì´ì›”ë“œ ê²½ê³„ ì˜¤ë²„ë ˆì´
      let currentBoundaryLayer = null; // í˜„ì¬ ë¡œë“œëœ ê²½ê³„ ë ˆì´ì–´
      let cadastralOverlay = null;
      let addressMarkers = []; // ì£¼ì†Œ ê²€ìƒ‰ ë§ˆì»¤ ë°°ì—´
      let lastSearchResults = [];
      let lastSearchMode = 'keyword';
      let kakaoMap = null; // ì¹´ì¹´ì˜¤ ì§€ë„ ì¸ìŠ¤í„´ìŠ¤
      let kakaoMarkers = [];
      let kakaoCadastralOverlayEl = null; // ì¹´ì¹´ì˜¤ ì§€ì ë„ ì˜¤ë²„ë ˆì´ ì—˜ë¦¬ë¨¼íŠ¸
      let cadastralOverlayMode = null; // 'google' | 'kakao' | null
      let cadastralUpdateTimer = null; // êµ¬ê¸€ë§µ ì§€ì ë„ ê°±ì‹  ë””ë°”ìš´ì„œ
      // ì§€ë²ˆ ê²½ê³„ í´ë¦¬ê³¤ (í•˜ì´ë¼ì´íŠ¸)
      let parcelPolygonGoogle = null;
      let parcelPolygonKakao = null;
      // ë¡œë“œë·°
      let kakaoRoadview = null;
      let kakaoRoadviewClient = null;
      let isRoadviewClickMode = false;
      let roadviewOverlayOn = false;
      let roadviewMarker = null;
      // ì¹´ì¹´ì˜¤ë§µ ìš°í´ë¦­ ì£¼ì†Œ ì •ë³´ì°½ ê´€ë ¨ ë³€ìˆ˜
      let addressInfoWindow = null;
      let addressInfoMarker = null;
      // êµ¬ê¸€ë§µ ìš°í´ë¦­ ì£¼ì†Œ ì •ë³´ì°½ ê´€ë ¨ ë³€ìˆ˜
      let googleAddressInfoWindow = null;
      let googleAddressInfoMarker = null;
      // í™œì„± ì§€ë„ ë°°ì§€ ê°±ì‹ 
      function setActiveMapBadge(text) {
        const el = document.getElementById('activeMapBadge');
        if (el) el.textContent = text;
      }
      function updateActiveMapLabel() {
        try {
          if (isKakaoVisible() && kakaoMap) {
            const mt = kakaoMap.getMapTypeId && kakaoMap.getMapTypeId();
            const label = (mt === kakao.maps.MapTypeId.SKYVIEW) ? 'ì¹´ì¹´ì˜¤ë§µ - ìŠ¤ì¹´ì´ë·°' : 'ì¹´ì¹´ì˜¤ë§µ - ì¼ë°˜';
            setActiveMapBadge(label);
            return;
          }
          
          if (map && map.getMapTypeId) {
            const t = map.getMapTypeId();
            let label = 'êµ¬ê¸€ë§µ - ì¼ë°˜';
            switch (t) {
              case 'roadmap': label = 'êµ¬ê¸€ë§µ - ì¼ë°˜'; break;
              case 'terrain': label = 'êµ¬ê¸€ë§µ - ì§€í˜•'; break;
              case 'satellite': label = 'êµ¬ê¸€ë§µ - ìœ„ì„±'; break;
              case 'hybrid': label = 'êµ¬ê¸€ë§µ - í•˜ì´ë¸Œë¦¬ë“œ'; break;
              case 'ë¸Œì´ì›”ë“œì¼ë°˜': label = 'ë¸Œì´ì›”ë“œ - ì¼ë°˜'; break;
              case 'ë¸Œì´ì›”ë“œì˜ìƒ': label = 'ë¸Œì´ì›”ë“œ - ì˜ìƒ'; break;
            }
            setActiveMapBadge(label);
          }
        } catch (e) { 
          console.log('í™œì„± ì§€ë„ ë¼ë²¨ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', e);
        }
      }
      // êµ¬ê¸€ ì¤Œ <-> ì¹´ì¹´ì˜¤ ë ˆë²¨ ë³€í™˜ ìœ í‹¸ë¦¬í‹°
      function getGoogleZoom() {
        try {
          if (map && map.getZoom) {
            return map.getZoom();
          }
          return null;
        } catch (e) {
          console.log('êµ¬ê¸€ë§µ ì¤Œ ë ˆë²¨ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', e);
          return null;
        }
      }
      function googleZoomToKakaoLevel(googleZoom) {
        if (googleZoom == null) return 5;
        const level = 21 - googleZoom; // ëŒ€ëµì  ëŒ€ì‘ì‹
        return Math.min(14, Math.max(1, level));
      }
      function kakaoLevelToGoogleZoom(kakaoLevel) {
        if (kakaoLevel == null) return 12;
        const zoom = 21 - kakaoLevel;
        return Math.min(21, Math.max(3, zoom));
      }
      // êµ¬ê¸€ ë§µ ì´ˆê¸°í™” í•¨ìˆ˜
      function initMap() {
        // ì„œìš¸ ì‹œì²­ì˜ ìœ„ë„, ê²½ë„ ì¢Œí‘œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ì •
        var center = { lat: 37.5665, lng: 126.9780 }; // ì„œìš¸ ì‹œì²­ ì¢Œí‘œ
        // êµ¬ê¸€ ë§µ ê°ì²´ ìƒì„± ë° ì˜µì…˜ ì„¤ì •
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 12, // ì´ˆê¸° í™•ëŒ€ ë ˆë²¨
          center: center, // ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ
          mapTypeControl: false, // ê¸°ë³¸ ê°€ë¡œ ì§€ë„ íƒ€ì… ë©”ë‰´ ë¹„í™œì„±í™”
          mapTypeControlOptions: {
            // ì§€ë„ íƒ€ì… ì„ íƒ ì»¨íŠ¸ë¡¤ì— í‘œì‹œí•  ì§€ë„ íƒ€ì… ëª©ë¡
            mapTypeIds: ['roadmap', 'terrain', 'satellite', 'hybrid', 'ë¸Œì´ì›”ë“œì¼ë°˜', 'ë¸Œì´ì›”ë“œì˜ìƒ'],
            style: google.maps.MapTypeControlStyle.VERTICAL_BAR, // ì„¸ë¡œ ë©”ë‰´
            position: google.maps.ControlPosition.LEFT_TOP // ì›í•˜ëŠ” ìœ„ì¹˜
          }
        });
        // REST ë°©ì‹ ì‚¬ìš©ì´ë¯€ë¡œ ë³„ë„ ì´ˆê¸°í™” ë¶ˆí•„ìš”

        // ë¸Œì´ì›”ë“œ ì¼ë°˜ ì§€ë„(ê¸°ë³¸ ì§€ë„) íƒ€ì¼ ë ˆì´ì–´ ì •ì˜
        var cadastralMapType = new google.maps.ImageMapType({
          // ê° íƒ€ì¼ì˜ URLì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
          getTileUrl: function(coord, zoom) {
            // ë¸Œì´ì›”ë“œ ì¼ë°˜ ì§€ë„ íƒ€ì¼ ì„œë²„ URL
            return 'https://xdworld.vworld.kr/2d/Base/service/' + zoom + '/' + coord.x + '/' + coord.y + '.png';
          },
          tileSize: new google.maps.Size(256, 256), // íƒ€ì¼ í¬ê¸° ì§€ì •
          name: 'ë¸Œì´ì›”ë“œì¼ë°˜', // ì§€ë„ íƒ€ì… ì´ë¦„
          maxZoom: 19 // ìµœëŒ€ í™•ëŒ€ ë ˆë²¨
        });

        // ë¸Œì´ì›”ë“œ ì˜ìƒ ì§€ë„(ìœ„ì„± ì§€ë„) íƒ€ì¼ ë ˆì´ì–´ ì •ì˜
        var vworldSatelliteMapType = new google.maps.ImageMapType({
          // ê° íƒ€ì¼ì˜ URLì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
          getTileUrl: function(coord, zoom) {
            // ë¸Œì´ì›”ë“œ ì˜ìƒ ì§€ë„ íƒ€ì¼ ì„œë²„ URL
            return 'https://xdworld.vworld.kr/2d/Satellite/service/' + zoom + '/' + coord.x + '/' + coord.y + '.jpeg';
          },
          tileSize: new google.maps.Size(256, 256), // íƒ€ì¼ í¬ê¸° ì§€ì •
          name: 'ë¸Œì´ì›”ë“œì˜ìƒ', // ì§€ë„ íƒ€ì… ì´ë¦„
          maxZoom: 19 // ìµœëŒ€ í™•ëŒ€ ë ˆë²¨
        });

        // ì‚¬ìš©ì ì •ì˜ ì§€ë„ íƒ€ì…(ë¸Œì´ì›”ë“œ ì¼ë°˜, ë¸Œì´ì›”ë“œ ì˜ìƒ)ì„ êµ¬ê¸€ ë§µì— ì¶”ê°€
        map.mapTypes.set('ë¸Œì´ì›”ë“œì¼ë°˜', cadastralMapType);
        map.mapTypes.set('ë¸Œì´ì›”ë“œì˜ìƒ', vworldSatelliteMapType);
        // ê¸°ë³¸ ì§€ë„ íƒ€ì…ì„ 'roadmap'ìœ¼ë¡œ ì„¤ì •
        map.setMapTypeId('roadmap');
        
        // ì§€ë„ ì´ë™ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        map.addListener('bounds_changed', function() {
          if (currentBoundaryLayer && vworldBoundaryOverlay) {
            // ì§€ë„ ì´ë™ í›„ ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ê²½ê³„ ì—…ë°ì´íŠ¸
            setTimeout(() => { updateBoundaryOverlay(); }, 300);
          }
          if (cadastralOverlay) {
            // êµ¬ê¸€ë§µ ì§€ì ë„ë„ ì´ë™/í™•ëŒ€ì— ë§ì¶° ê°±ì‹ 
            if (cadastralUpdateTimer) clearTimeout(cadastralUpdateTimer);
            cadastralUpdateTimer = setTimeout(() => { updateCadastralOverlay(); }, 300);
          }
        });
        // ì´ˆê¸° í™œì„± ì§€ë„ ë°°ì§€ ê°±ì‹ 
        updateActiveMapLabel();
        // êµ¬ê¸€ë§µ ìš°í´ë¦­ ì£¼ì†Œ ì •ë³´ì°½ ë¦¬ìŠ¤ë„ˆ ë¶€ì°©
        attachGoogleMapRightClick();
      }
      function setMapType(type) {
        // ì¹´ì¹´ì˜¤ë§µì´ í™œì„±í™”ëœ ìƒíƒœë¼ë©´ êµ¬ê¸€ë§µìœ¼ë¡œ ì „í™˜
        if (isKakaoVisible()) {
          showGoogleMap();
        }
        // ì§€ë„ íƒ€ì… ì„¤ì •
        if (map && map.setMapTypeId) {
          map.setMapTypeId(type);
        }
        updateActiveMapLabel();
      }
      // êµ¬ê¸€ë§µ ë©”ë‰´ í† ê¸€
      function toggleGoogleMapMenu() {
        const menu = document.getElementById('googleMapMenu');
        const btn = document.getElementById('googleMapToggleBtn');
        if(menu.style.display === 'none') {
          menu.style.display = 'block';
          btn.textContent = '-êµ¬ê¸€ë§µ';
        } else {
          menu.style.display = 'none';
          btn.textContent = '+êµ¬ê¸€ë§µ';
          // í•˜ìœ„ ë©”ë‰´ë„ ë‹«ê¸°
          document.getElementById('roadmapMenu').style.display = 'none';
          document.getElementById('roadmapToggleBtn').textContent = '+ì¼ë°˜';
          document.getElementById('satelliteMenu').style.display = 'none';
          document.getElementById('satelliteToggleBtn').textContent = '+ìœ„ì„±';
        }
      }
      // +ì¼ë°˜ í´ë¦­ ì‹œ ë°”ë¡œ ì¼ë°˜ì§€ë„ë¥¼ ë¡œë“œí•˜ê³ , í•˜ìœ„ì— ì§€í˜•ë§Œ ë³´ì´ë„ë¡
      function toggleRoadmapMenuAndSetRoadmap() {
        const menu = document.getElementById('roadmapMenu');
        const btn = document.getElementById('roadmapToggleBtn');
        if(menu.style.display === 'none') {
          setMapType('roadmap');
          menu.style.display = 'block';
          btn.textContent = '-ì¼ë°˜';
        } else {
          menu.style.display = 'none';
          btn.textContent = '+ì¼ë°˜';
        }
      }
      // +ìœ„ì„± í´ë¦­ ì‹œ ë°”ë¡œ ìœ„ì„±ì§€ë„ë¥¼ ë¡œë“œí•˜ê³ , í•˜ìœ„ì— í•˜ì´ë¸Œë¦¬ë“œë§Œ ë³´ì´ë„ë¡
      function toggleSatelliteMenuAndSetSatellite() {
        const menu = document.getElementById('satelliteMenu');
        const btn = document.getElementById('satelliteToggleBtn');
        if(menu.style.display === 'none') {
          setMapType('satellite');
          menu.style.display = 'block';
          btn.textContent = '-ìœ„ì„±';
        } else {
          menu.style.display = 'none';
          btn.textContent = '+ìœ„ì„±';
        }
      }
      // ë¸Œì´ì›”ë“œ ë©”ë‰´ í† ê¸€
      function toggleVworldMenu() {
        const menu = document.getElementById('vworldMenu');
        const btn = document.getElementById('vworldToggleBtn');
        if(menu.style.display === 'none') {
          menu.style.display = 'block';
          btn.textContent = '-ë¸Œì´ì›”ë“œ';
        } else {
          menu.style.display = 'none';
          btn.textContent = '+ë¸Œì´ì›”ë“œ';
        }
      }
      // ì¹´ì¹´ì˜¤ë§µ ë©”ë‰´ í† ê¸€
      function toggleKakaoMapMenu() {
        const menu = document.getElementById('kakaoMapMenu');
        const btn = document.getElementById('kakaoMapToggleBtn');
        if(menu.style.display === 'none') {
          menu.style.display = 'block';
          btn.textContent = '-ì¹´ì¹´ì˜¤ë§µ';
        } else {
          menu.style.display = 'none';
          btn.textContent = '+ì¹´ì¹´ì˜¤ë§µ';
        }
      }
      function loadKakaoMap(type) {
        const container = document.getElementById('kakaoMapContainer');
        const googleDiv = document.getElementById('map');
        
        if (!container || !googleDiv) {
          console.log('ì¹´ì¹´ì˜¤ë§µ ì»¨í…Œì´ë„ˆ ë˜ëŠ” êµ¬ê¸€ë§µ divë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        const wasVisible = container.style.display !== 'none';
        
        // ì»¨í…Œì´ë„ˆ ì „í™˜
        googleDiv.style.display = 'none';
        container.style.display = 'block';
        
        // Kakao SDK ë¹„ë™ê¸° ë¡œë“œ í›„ ì§€ë„ ìƒì„±/ì—…ë°ì´íŠ¸
        if (window.kakao && kakao.maps && kakao.maps.load) {
          kakao.maps.load(function() {
            try {
              // ì²˜ìŒ ì¹´ì¹´ì˜¤ë¡œ ì „í™˜ë˜ëŠ” ìˆœê°„ì—ë§Œ êµ¬ê¸€ ì¤‘ì‹¬/ë°°ìœ¨ì„ ê°•ì œ ë™ê¸°í™”
              createOrUpdateKakaoMap(type, !wasVisible);
              updateActiveMapLabel();
              ensureRoadviewInitialized();
              attachOrDetachRoadviewClick();
            } catch (e) {
              console.log('ì¹´ì¹´ì˜¤ë§µ ìƒì„±/ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', e);
            }
          });
        } else {
          console.log('ì¹´ì¹´ì˜¤ë§µ SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
      }
      function showGoogleMap() {
        const kakaoContainer = document.getElementById('kakaoMapContainer');
        const googleDiv = document.getElementById('map');
        
        if (!googleDiv) return;
        
        // ì¹´ì¹´ì˜¤ì—ì„œ êµ¬ê¸€ë¡œ ì „í™˜ ì‹œ ì¤‘ì‹¬/ë°°ìœ¨ ë™ê¸°í™”
        if (kakaoMap && kakaoContainer && kakaoContainer.style.display !== 'none') {
          try {
            const kc = kakaoMap.getCenter();
            const kl = kakaoMap.getLevel();
            const gZoom = kakaoLevelToGoogleZoom(kl);
            if (map && map.setCenter && map.setZoom) {
              map.setCenter({ lat: kc.getLat(), lng: kc.getLng() });
              map.setZoom(gZoom);
            }
          } catch (e) { 
            console.log('ì¹´ì¹´ì˜¤ë§µì—ì„œ êµ¬ê¸€ë§µìœ¼ë¡œ ì „í™˜ ì‹œ ë™ê¸°í™” ì˜¤ë¥˜:', e);
          }
        }
        
        // ì»¨í…Œì´ë„ˆ ì „í™˜
        if (kakaoContainer) kakaoContainer.style.display = 'none';
        googleDiv.style.display = 'block';
        
        // ì¹´ì¹´ì˜¤ë§µ ì „í™˜ ì‹œ ì •ë³´ì°½ ì œê±°
        clearAddressInfoWindow();
        
        // í™œì„± ì§€ë„ ë°°ì§€ ì—…ë°ì´íŠ¸
        updateActiveMapLabel();
        
        // êµ¬ê¸€ë¡œ ì „í™˜ ì‹œ ë¡œë“œë·° ê°ì¶¤
        hideRoadview();
      }
      function isKakaoVisible() {
        const container = document.getElementById('kakaoMapContainer');
        return container && container.style.display !== 'none';
      }
      function createOrUpdateKakaoMap(type, syncFromGoogle) {
        try {
          const mapTypeId = (type === 'skyview') ? kakao.maps.MapTypeId.SKYVIEW : kakao.maps.MapTypeId.ROADMAP;
          const centerFromGoogle = getCurrentCenter();
          const gZoom = getGoogleZoom();
          const levelFromGoogle = googleZoomToKakaoLevel(gZoom);
          
          if (!kakaoMap) {
            const container = document.getElementById('kakaoMapDiv');
            if (!container) {
              console.log('ì¹´ì¹´ì˜¤ë§µ divë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            
            kakaoMap = new kakao.maps.Map(container, {
              center: new kakao.maps.LatLng(centerFromGoogle.lat, centerFromGoogle.lng),
              level: levelFromGoogle,
              mapTypeId: mapTypeId
            });
            
            attachOrDetachRoadviewClick();
            // ìš°í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            attachKakaoMapRightClick();
          } else {
            if (kakaoMap.setMapTypeId) {
              kakaoMap.setMapTypeId(mapTypeId);
            }
            
            if (syncFromGoogle && kakaoMap.setCenter && kakaoMap.setLevel) {
              kakaoMap.setCenter(new kakao.maps.LatLng(centerFromGoogle.lat, centerFromGoogle.lng));
              kakaoMap.setLevel(levelFromGoogle);
            }
          }
          
          // ì»¨í…Œì´ë„ˆ í‘œì‹œ ì§í›„ ë¦¬ë ˆì´ì•„ì›ƒ
          setTimeout(() => { 
            if (kakaoMap && kakaoMap.relayout) {
              kakaoMap.relayout(); 
            }
          }, 0);
          
          // ì§€ì ë„ê°€ í™œì„± ìƒíƒœì˜€ë‹¤ë©´ ì¹´ì¹´ì˜¤ì—ë„ í‘œì‹œ
          if (cadastralOverlay || cadastralOverlayMode === 'kakao') {
            loadCadastralOverlayKakao();
          }
          
          // êµ¬ê¸€ì—ì„œ ì¡´ì¬í•˜ëŠ” ë§ˆì»¤ë¥¼ ì¹´ì¹´ì˜¤ë¡œ ë™ê¸°í™”
          syncMarkersToKakao();
          updateActiveMapLabel();
          
        } catch (e) {
          console.log('ì¹´ì¹´ì˜¤ë§µ ìƒì„±/ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', e);
        }
      }

      // ë¡œë“œë·° ì´ˆê¸°í™”/í† ê¸€/ê°±ì‹ 
      function ensureRoadviewInitialized() {
        const rvContainer = document.getElementById('roadview');
        if (!rvContainer) return;
        if (!kakaoRoadviewClient) kakaoRoadviewClient = new kakao.maps.RoadviewClient();
        if (!kakaoRoadview) {
          kakaoRoadview = new kakao.maps.Roadview(rvContainer);
          // ë¡œë“œë·° ìœ„ì¹˜ ë³€í™” ì‹œ ì§€ë„/ë§ˆì»¤ ë™ê¸°í™”
          kakao.maps.event.addListener(kakaoRoadview, 'position_changed', function() {
            try {
              const pos = kakaoRoadview.getPosition();
              if (pos && kakaoMap) {
                updateRoadviewMarkerPosition(pos);
              }
            } catch (e) { /* ignore */ }
          });
        }
      }
      function showRoadviewAtLatLng(lat, lng) {
        ensureRoadviewInitialized();
        if (!kakaoRoadviewClient || !kakaoRoadview) return;
        const position = new kakao.maps.LatLng(lat, lng);
        kakaoRoadviewClient.getNearestPanoId(position, 50, function(panoId) {
          if (!!panoId) {
            document.body.classList.add('rv-active');
            kakaoRoadview.setPanoId(panoId, position);
            updateRoadviewMarkerPosition(position);
          } else {
            alert('í•´ë‹¹ ìœ„ì¹˜ ì£¼ë³€ì— ë¡œë“œë·°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          }
        });
      }
      function toggleRoadview() {
        if (!isKakaoVisible()) { alert('ì¹´ì¹´ì˜¤ë§µì„ ë¨¼ì € í™œì„±í™”í•˜ì„¸ìš”.'); return; }
        if (!isRoadviewClickMode) { openRoadview(); } else { closeRoadviewAll(); }
      }
      function openRoadview() {
        isRoadviewClickMode = true;
        document.body.classList.add('rv-active');
        toggleRoadviewOverlay(true);
        attachOrDetachRoadviewClick();
      }
      function closeRoadviewAll() {
        isRoadviewClickMode = false;
        document.body.classList.remove('rv-active');
        toggleRoadviewOverlay(false);
        attachOrDetachRoadviewClick();
      }
      
      function hideRoadview() {
        document.body.classList.remove('rv-active');
      }
      function attachOrDetachRoadviewClick() {
        if (!kakaoMap) return;
        // ê¸°ì¡´ í•¸ë“¤ëŸ¬ ì œê±° í›„ í•„ìš” ì‹œ ë¶€ì°©
        kakao.maps.event.removeListener(kakaoMap, 'click', onKakaoMapClickForRoadview);
        if (isKakaoVisible() && isRoadviewClickMode) {
          kakao.maps.event.addListener(kakaoMap, 'click', onKakaoMapClickForRoadview);
        }
      }
      
      // ì¹´ì¹´ì˜¤ë§µ ìš°í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¶€ì°©
      function attachKakaoMapRightClick() {
        if (!kakaoMap) return;
        kakao.maps.event.addListener(kakaoMap, 'rightclick', onKakaoMapRightClick);
      }
      // êµ¬ê¸€ë§µ ìš°í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¶€ì°©
      function attachGoogleMapRightClick() {
        if (!map || !map.addListener) return;
        map.addListener('rightclick', onGoogleMapRightClick);
      }
      
      // ì¹´ì¹´ì˜¤ë§µ ìš°í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      function onKakaoMapRightClick(mouseEvent) {
        const latlng = mouseEvent.latLng;
        if (!latlng) return;
        const lat = latlng.getLat();
        const lng = latlng.getLng();
        // ì—°ì†ì§€ì ë„ í™œì„± ì‹œ: ì§€ë²ˆ ìƒì„¸ ì •ë³´ í‘œì‹œ, ì•„ë‹ˆë©´ ê¸°ì¡´ ì£¼ì†Œ ì •ë³´ì°½
        if (isCadastralOn()) {
          handleParcelInfoAtLatLng(lat, lng);
        } else {
          // ê¸°ì¡´ ì •ë³´ì°½ê³¼ ë§ˆì»¤ ì œê±° í›„ ì£¼ì†Œ ì •ë³´ì°½ í‘œì‹œ
          clearAddressInfoWindow();
          addressInfoMarker = new kakao.maps.Marker({ position: latlng, map: kakaoMap });
          searchAddressFromCoordinates(lat, lng);
        }
      }
      // êµ¬ê¸€ë§µ ìš°í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      function onGoogleMapRightClick(mouseEvent) {
        const latlng = mouseEvent && mouseEvent.latLng;
        if (!latlng) return;
        const lat = typeof latlng.lat === 'function' ? latlng.lat() : latlng.lat;
        const lng = typeof latlng.lng === 'function' ? latlng.lng() : latlng.lng;
        // ì—°ì†ì§€ì ë„ í™œì„± ì‹œ: ì§€ë²ˆ ìƒì„¸ ì •ë³´ í‘œì‹œ, ì•„ë‹ˆë©´ ê¸°ì¡´ ì£¼ì†Œ ì •ë³´ì°½
        if (isCadastralOn()) {
          handleParcelInfoAtLatLng(lat, lng);
        } else {
          clearAddressInfoWindow();
          googleAddressInfoMarker = new google.maps.Marker({ position: latlng, map: map });
          searchAddressFromCoordinates(lat, lng);
        }
      }
      
      // ì¢Œí‘œë¡œ ì£¼ì†Œ ê²€ìƒ‰
      async function searchAddressFromCoordinates(lat, lng) {
        try {
          const response = await fetch(`https://dapi.kakao.com/v2/local/geo/coord2address.json?x=${lng}&y=${lat}`, {
            headers: { 
              'Authorization': 'KakaoAK c27024d37ac99abf233b12f0efa39099' 
            }
          });
          
          if (!response.ok) throw new Error('HTTP ' + response.status);
          
          const data = await response.json();
          console.log('ì¹´ì¹´ì˜¤ API ì‘ë‹µ ë°ì´í„°:', data);
          if (data.documents && data.documents.length > 0) {
            const doc = data.documents[0];
            console.log('ì£¼ì†Œ ë¬¸ì„œ:', doc);
            console.log('ì§€ë²ˆëª… ì£¼ì†Œ:', doc.address && doc.address.address_name);
            showAddressInfoWindow(lat, lng, doc);
          } else {
            showAddressInfoWindow(lat, lng, null);
          }
        } catch (error) {
          console.log('ì£¼ì†Œ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
          showAddressInfoWindow(lat, lng, null);
        }
      }
      
      // ì£¼ì†Œ ì •ë³´ì°½ í‘œì‹œ (ì¹´ì¹´ì˜¤/êµ¬ê¸€ ê³µìš©)
      function showAddressInfoWindow(lat, lng, addressDoc) {
        console.log('showAddressInfoWindow í˜¸ì¶œë¨:', { lat, lng, addressDoc });
        // ê¸°ì¡´ ì •ë³´ì°½ ì œê±°
        clearAddressInfoWindow();
        
        // ì •ë³´ì°½ ë‚´ìš© ìƒì„±
        let content = `
          <div style="padding: 10px; min-width: 200px;">
            <div style="font-weight: bold; margin-bottom: 8px; color: #333;">
              ğŸ¯ í´ë¦­í•œ ìœ„ì¹˜
            </div>
            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
              ìœ„ë„: ${lat.toFixed(6)}<br>
              ê²½ë„: ${lng.toFixed(6)}
            </div>
        `;
        
        if (addressDoc) {
          const jibun = addressDoc.address && addressDoc.address.address_name;
          content += `
            <div style="border-top: 1px solid #eee; padding-top: 8px;">
              <div style="font-weight: bold; color: #1d4ed8; margin-bottom: 4px;">
                ğŸ“ ì§€ë²ˆëª… ì£¼ì†Œ
              </div>
              <div style="font-size: 12px; color: #555;">
                ${jibun || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}
              </div>
            </div>
          `;
        } else {
          content += `
            <div style="border-top: 1px solid #eee; padding-top: 8px;">
              <div style="font-size: 12px; color: #999;">
                ì£¼ì†Œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
              </div>
            </div>
          `;
        }
        
        content += `
          <div style="margin-top: 8px; text-align: center;">
            <button onclick="clearAddressInfoWindow()" style="
              background: #f0f0f0; 
              border: 1px solid #ddd; 
              padding: 4px 8px; 
              border-radius: 4px; 
              font-size: 11px; 
              cursor: pointer;
            ">ë‹«ê¸°</button>
          </div>
        </div>
        `;
        // í™œì„± ë§µì— ë§ì¶° ì •ë³´ì°½ ìƒì„± ë° í‘œì‹œ
        if (isKakaoVisible() && kakaoMap) {
          addressInfoWindow = new kakao.maps.InfoWindow({
            content: content,
            position: new kakao.maps.LatLng(lat, lng),
            removable: false
          });
          addressInfoWindow.open(kakaoMap, addressInfoMarker);
        } else if (map) {
          googleAddressInfoWindow = new google.maps.InfoWindow({
            content: content
          });
          if (googleAddressInfoMarker) {
            googleAddressInfoWindow.open(map, googleAddressInfoMarker);
          } else {
            googleAddressInfoWindow.setPosition({ lat, lng });
            googleAddressInfoWindow.open(map);
          }
        }
        // ì£¼ì†Œ ë¬¸ì„œê°€ ìˆì„ ë•Œ ì§€ë²ˆ ê²½ê³„ í‘œì‹œ ì‹œë„ (ì¢Œí‘œë¡œ ë²•ì •ë™ì½”ë“œ ì¡°íšŒ í¬í•¨)
        renderParcelBoundaryFromAddress(lat, lng, addressDoc).catch(e => console.log('ì§€ë²ˆ ê²½ê³„ í‘œì‹œ ì˜¤ë¥˜:', e));
      }
      
      // ì£¼ì†Œ ì •ë³´ì°½ ì œê±° (ì¹´ì¹´ì˜¤/êµ¬ê¸€ ê³µìš©)
      function clearAddressInfoWindow() {
        // ì¹´ì¹´ì˜¤
        if (addressInfoWindow) {
          addressInfoWindow.close();
          addressInfoWindow = null;
        }
        if (addressInfoMarker) {
          addressInfoMarker.setMap(null);
          addressInfoMarker = null;
        }
        // êµ¬ê¸€
        if (googleAddressInfoWindow) {
          googleAddressInfoWindow.close();
          googleAddressInfoWindow = null;
        }
        if (googleAddressInfoMarker) {
          googleAddressInfoMarker.setMap(null);
          googleAddressInfoMarker = null;
        }
        // ê²½ê³„ í´ë¦¬ê³¤ë„ í•¨ê»˜ ì œê±°
        clearParcelPolygons();
      }

      // ===== ì§€ë²ˆ ê²½ê³„ í‘œì‹œ ë¡œì§ =====
      function isCadastralOn() {
        return !!(cadastralOverlay || cadastralOverlayMode === 'kakao');
      }
      function buildPnuFromKakaoAddress(address) {
        if (!address) return null;
        const bCode = (address.b_code || '').trim(); // 10ìë¦¬ ë²•ì •ë™ì½”ë“œ (ì—†ì„ ìˆ˜ ìˆìŒ)
        if (!bCode || bCode.length !== 10) return null;
        const isMountain = (address.mountain_yn || address.mountainYn || 'N').toUpperCase() === 'Y' ? '1' : '0';
        const mainNoRaw = String(address.main_address_no || address.mainAddressNo || '0');
        const subNoRaw = String(address.sub_address_no || address.subAddressNo || '0');
        const mainNo = mainNoRaw.padStart(4, '0');
        const subNo = subNoRaw.padStart(4, '0');
        return `${bCode}${isMountain}${mainNo}${subNo}`; // 19ìë¦¬ PNU
      }

      async function fetchParcelGeometryByPnu(pnu) {
        const key = '910896AA-BE88-363C-B54B-9FB421BD05DB';
        const base = 'https://api.vworld.kr/ned/wfs/getCtnlgsSpceWFS';
        const params = new URLSearchParams();
        params.set('key', key);
        // ë¸Œë¼ìš°ì €ì—ì„œ ë„ë©”ì¸ ìš”êµ¬ë  ìˆ˜ ìˆìŒ. file:// ì‹¤í–‰ ì‹œ ê³µë°±ì´ë¯€ë¡œ ì œì™¸
        const host = (location.protocol.startsWith('http') ? location.hostname : '');
        if (host) params.set('domain', host);
        params.set('typename', 'dt_d002');
        params.set('pnu', pnu);
        params.set('srsName', 'EPSG:4326');
        params.set('output', 'application/json');
        const url = `${base}?${params.toString()}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('WFS HTTP ' + res.status);
        const data = await res.json();
        const features = (data && (data.features || (data.featureCollection && data.featureCollection.features))) || [];
        if (!features.length) return null;
        return features[0].geometry || null; // GeoJSON geometry
      }

      async function fetchParcelsByBbox(bboxStr) {
        const key = '910896AA-BE88-363C-B54B-9FB421BD05DB';
        const base = 'https://api.vworld.kr/ned/wfs/getCtnlgsSpceWFS';
        const params = new URLSearchParams();
        params.set('key', key);
        const host = (location.protocol.startsWith('http') ? location.hostname : '');
        if (host) params.set('domain', host);
        params.set('typename', 'dt_d002');
        params.set('bbox', bboxStr);
        params.set('srsName', 'EPSG:4326');
        params.set('output', 'application/json');
        const url = `${base}?${params.toString()}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('WFS HTTP ' + res.status);
        const data = await res.json();
        return (data && data.features) || [];
      }

      function clearParcelPolygons() {
        try {
          if (parcelPolygonGoogle) {
            parcelPolygonGoogle.setMap(null);
            parcelPolygonGoogle = null;
          }
        } catch (_) {}
        try {
          if (parcelPolygonKakao) {
            parcelPolygonKakao.setMap && parcelPolygonKakao.setMap(null);
            parcelPolygonKakao = null;
          }
        } catch (_) {}
      }

      async function fetchBcodeByCoord(lat, lng) {
        const url = `https://dapi.kakao.com/v2/local/geo/coord2regioncode.json?x=${lng}&y=${lat}`;
        const res = await fetch(url, { headers: { 'Authorization': 'KakaoAK c27024d37ac99abf233b12f0efa39099' } });
        if (!res.ok) throw new Error('coord2regioncode HTTP ' + res.status);
        const data = await res.json();
        const docs = Array.isArray(data && data.documents) ? data.documents : [];
        // region_type==='B' ìš°ì„ , ì—†ìœ¼ë©´ ì²« 10ìë¦¬ ì½”ë“œ
        const bDoc = docs.find(d => d.region_type === 'B') || docs.find(d => (d.code || '').length === 10);
        return bDoc ? String(bDoc.code).slice(0, 10) : null;
      }

      async function renderParcelBoundaryFromAddress(lat, lng, addressDoc) {
        if (!addressDoc || !addressDoc.address) return;
        const address = { ...addressDoc.address };
        if (!address.b_code) {
          try {
            const bcode = await fetchBcodeByCoord(lat, lng);
            if (bcode) address.b_code = bcode;
          } catch (e) {
            console.log('b_code ì¡°íšŒ ì‹¤íŒ¨:', e);
          }
        }
        const pnu = buildPnuFromKakaoAddress(address);
        if (!pnu) return;
        const geometry = await fetchParcelGeometryByPnu(pnu);
        if (!geometry) return;
        if (isKakaoVisible() && kakaoMap) {
          drawParcelPolygonKakao(geometry);
        } else if (map) {
          drawParcelPolygonGoogle(geometry);
        }
      }

      function drawParcelPolygonGoogle(geometry) {
        // geometry: GeoJSON (Polygon | MultiPolygon) with [lng,lat]
        try { if (parcelPolygonGoogle) { parcelPolygonGoogle.setMap(null); } } catch (_) {}
        const paths = [];
        if (geometry.type === 'Polygon') {
          geometry.coordinates.forEach(ring => {
            paths.push(ring.map(([lng, lat]) => ({ lat, lng })));
          });
        } else if (geometry.type === 'MultiPolygon') {
          geometry.coordinates.forEach(polygon => {
            polygon.forEach(ring => {
              paths.push(ring.map(([lng, lat]) => ({ lat, lng })));
            });
          });
        } else {
          return;
        }
        parcelPolygonGoogle = new google.maps.Polygon({
          paths,
          strokeColor: '#ff3b30',
          strokeOpacity: 1.0,
          strokeWeight: 2,
          fillColor: '#ff3b30',
          fillOpacity: 0.15,
          clickable: false,
          geodesic: false
        });
        parcelPolygonGoogle.setMap(map);
      }

      function drawParcelPolygonKakao(geometry) {
        try { if (parcelPolygonKakao) { parcelPolygonKakao.setMap && parcelPolygonKakao.setMap(null); } } catch (_) {}
        const paths = [];
        if (geometry.type === 'Polygon') {
          geometry.coordinates.forEach(ring => {
            paths.push(ring.map(([lng, lat]) => new kakao.maps.LatLng(lat, lng)));
          });
        } else if (geometry.type === 'MultiPolygon') {
          geometry.coordinates.forEach(polygon => {
            polygon.forEach(ring => {
              paths.push(ring.map(([lng, lat]) => new kakao.maps.LatLng(lat, lng)));
            });
          });
        } else {
          return;
        }
        parcelPolygonKakao = new kakao.maps.Polygon({
          path: paths,
          strokeWeight: 2,
          strokeColor: '#ff3b30',
          strokeOpacity: 1,
          fillColor: '#ff3b30',
          fillOpacity: 0.15
        });
        parcelPolygonKakao.setMap(kakaoMap);
      }

      // ì§€ì ë„ ON ìƒíƒœì—ì„œ ìš°í´ë¦­ ì‹œ í•´ë‹¹ ìœ„ì¹˜ì˜ ì§€ë²ˆ ìƒì„¸ ì •ë³´ í‘œì‹œ
      async function handleParcelInfoAtLatLng(lat, lng) {
        try {
          // ì‘ì€ bbox êµ¬ì„± (ymin,xmin,ymax,xmax,EPSG:4326)
          const dy = 0.0006, dx = 0.0006;
          const bbox = `${(lat - dy)},${(lng - dx)},${(lat + dy)},${(lng + dx)},EPSG:4326`;
          const features = await fetchParcelsByBbox(bbox);
          if (!features || features.length === 0) {
            alert('í•´ë‹¹ ìœ„ì¹˜ì˜ ì§€ë²ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          const picked = pickFeatureContainingPoint(features, lat, lng) || features[0];
          if (picked && picked.geometry) {
            if (isKakaoVisible() && kakaoMap) {
              drawParcelPolygonKakao(picked.geometry);
            } else if (map) {
              drawParcelPolygonGoogle(picked.geometry);
            }
          }
          showParcelInfoWindow(lat, lng, picked && picked.properties ? picked.properties : {});
        } catch (e) {
          console.log('parcel info error:', e);
          alert('ì§€ë²ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }

      function pickFeatureContainingPoint(features, lat, lng) {
        const pt = { lat, lng };
        for (let i = 0; i < features.length; i++) {
          const g = features[i] && features[i].geometry;
          if (!g) continue;
          if (g.type === 'Polygon') {
            if (polygonContainsPoint(g.coordinates, pt)) return features[i];
          } else if (g.type === 'MultiPolygon') {
            for (let j = 0; j < g.coordinates.length; j++) {
              if (polygonContainsPoint(g.coordinates[j], pt)) return features[i];
            }
          }
        }
        return null;
      }

      // rings: [ [ [lng,lat], ... ] , ... ]
      function polygonContainsPoint(rings, point) {
        if (!Array.isArray(rings) || rings.length === 0) return false;
        const outer = rings[0];
        return pointInRing(outer, point);
      }

      function pointInRing(ring, point) {
        let inside = false;
        for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
          const xi = ring[i][0], yi = ring[i][1];
          const xj = ring[j][0], yj = ring[j][1];
          const intersect = ((yi > point.lat) !== (yj > point.lat)) &&
            (point.lng < (xj - xi) * (point.lat - yi) / ((yj - yi) || 1e-12) + xi);
          if (intersect) inside = !inside;
        }
        return inside;
      }

      function showParcelInfoWindow(lat, lng, props) {
        clearAddressInfoWindow();
        const pnu = props.pnu || '';
        const jibunText = props.lnm_lndcgr_smbol || '';
        const mnnm = props.mnnm || '';
        const slno = props.slno || '';
        const content = `
          <div style="padding:10px; min-width:220px;">
            <div style="font-weight:700; margin-bottom:6px; color:#333;">ì§€ë²ˆ ìƒì„¸ ì •ë³´</div>
            <div style="font-size:12px; color:#666; margin-bottom:6px;">ìœ„ë„: ${lat.toFixed(6)} / ê²½ë„: ${lng.toFixed(6)}</div>
            <div style="font-size:12px; color:#555;">
              <div><b>ì§€ë²ˆ</b>: ${jibunText || (mnnm ? `${mnnm}${slno?('-'+slno):''}` : '(ì•Œ ìˆ˜ ì—†ìŒ)')}</div>
              <div><b>PNU</b>: ${pnu || '(ì—†ìŒ)'}</div>
            </div>
            <div style="margin-top:8px; text-align:center;">
              <button onclick="clearAddressInfoWindow()" style="background:#f0f0f0; border:1px solid #ddd; padding:4px 8px; border-radius:4px; font-size:11px; cursor:pointer;">ë‹«ê¸°</button>
            </div>
          </div>
        `;
        if (isKakaoVisible() && kakaoMap) {
          addressInfoMarker = new kakao.maps.Marker({ position: new kakao.maps.LatLng(lat, lng), map: kakaoMap });
          addressInfoWindow = new kakao.maps.InfoWindow({ content, position: new kakao.maps.LatLng(lat, lng), removable: false });
          addressInfoWindow.open(kakaoMap, addressInfoMarker);
        } else if (map) {
          googleAddressInfoMarker = new google.maps.Marker({ position: { lat, lng }, map });
          googleAddressInfoWindow = new google.maps.InfoWindow({ content });
          googleAddressInfoWindow.open(map, googleAddressInfoMarker);
        }
      }
      function onKakaoMapClickForRoadview(mouseEvent) {
        const latlng = mouseEvent.latLng;
        if (!latlng) return;
        showRoadviewAtLatLng(latlng.getLat(), latlng.getLng());
      }

      // ì§€ë„ ìœ„ ë¡œë“œë·° ì˜¤ë²„ë ˆì´/ë§ˆì»¤
      function toggleRoadviewOverlay(active) {
        if (!kakaoMap) return;
        if (active) {
          if (!roadviewOverlayOn) {
            kakaoMap.addOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
            roadviewOverlayOn = true;
          }
          // ë§ˆì»¤ ì¤€ë¹„
          if (!roadviewMarker) {
            const markImage = new kakao.maps.MarkerImage(
              'https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png',
              new kakao.maps.Size(26, 46),
              {
                spriteSize: new kakao.maps.Size(1666, 168),
                spriteOrigin: new kakao.maps.Point(705, 114),
                offset: new kakao.maps.Point(13, 46)
              }
            );
            roadviewMarker = new kakao.maps.Marker({ image: markImage, draggable: true });
            kakao.maps.event.addListener(roadviewMarker, 'dragend', function() {
              const pos = roadviewMarker.getPosition();
              if (pos) showRoadviewAtLatLng(pos.getLat(), pos.getLng());
            });
          }
          if (roadviewMarker && !roadviewMarker.getMap()) {
            roadviewMarker.setMap(kakaoMap);
            roadviewMarker.setPosition(kakaoMap.getCenter());
          }
        } else {
          if (roadviewOverlayOn) {
            kakaoMap.removeOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
            roadviewOverlayOn = false;
          }
          if (roadviewMarker) roadviewMarker.setMap(null);
          hideRoadview();
        }
      }
      function updateRoadviewMarkerPosition(latlng) {
        if (!kakaoMap) return;
        if (roadviewMarker && roadviewOverlayOn) {
          roadviewMarker.setMap(kakaoMap);
          roadviewMarker.setPosition(latlng);
        }
      }
      function syncMarkersToKakao() {
        try {
          if (!kakaoMap) return;
          
          // ê¸°ì¡´ ì¹´ì¹´ì˜¤ ë§ˆì»¤ ì œê±°
          if (kakaoMarkers && kakaoMarkers.length) {
            kakaoMarkers.forEach(m => {
              try {
                if (m && m.setMap) m.setMap(null);
              } catch (e) { /* ignore individual marker errors */ }
            });
            kakaoMarkers = [];
          }
          
          // êµ¬ê¸€ ë§ˆì»¤ë¥¼ ì¹´ì¹´ì˜¤ ë§ˆì»¤ë¡œ ë³µì œ
          if (addressMarkers && addressMarkers.length) {
            addressMarkers.forEach(gm => {
              try {
                if (!gm || !gm.getPosition) return;
                
                const pos = gm.getPosition();
                if (!pos) return;
                
                const lat = typeof pos.lat === 'function' ? pos.lat() : (pos.lat || null);
                const lng = typeof pos.lng === 'function' ? pos.lng() : (pos.lng || null);
                
                if (lat == null || lng == null) return;
                
                const marker = new kakao.maps.Marker({
                  position: new kakao.maps.LatLng(lat, lng),
                  map: kakaoMap
                });
                
                kakao.maps.event.addListener(marker, 'click', function() { 
                  removeSpecificKakaoMarker(marker); 
                });
                
                kakaoMarkers.push(marker);
              } catch (e) { 
                console.log('ê°œë³„ ë§ˆì»¤ ë™ê¸°í™” ì˜¤ë¥˜:', e);
              }
            });
          }
        } catch (e) {
          console.log('ë§ˆì»¤ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜:', e);
        }
      }
      function getCurrentCenter() {
        let centerLat = 37.5665;
        let centerLng = 126.9780;
        
        try {
          if (map && map.getCenter) {
            const c = map.getCenter();
            if (c) {
              centerLat = (typeof c.lat === 'function') ? c.lat() : c.lat;
              centerLng = (typeof c.lng === 'function') ? c.lng() : c.lng;
            }
          }
        } catch (e) {
          console.log('êµ¬ê¸€ë§µ ì¤‘ì‹¬ì  ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', e);
        }
        
        return { lat: centerLat, lng: centerLng };
      }
      async function searchAddress() {
        const query = document.getElementById('addressInput').value;
        if (!query) {
          alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
          return;
        }

        try {
          // 1) ì¥ì†Œ(í‚¤ì›Œë“œ) ê²€ìƒ‰ì„ ìš°ì„  ì‹œë„
          let centerLng = null;
          let centerLat = null;
          if (map && map.getCenter) {
            const c = map.getCenter();
            if (c) {
              centerLat = typeof c.lat === 'function' ? c.lat() : c.lat;
              centerLng = typeof c.lng === 'function' ? c.lng() : c.lng;
            }
          }

          const keywordParams = new URLSearchParams({ query, size: '15' });
          if (centerLng != null && centerLat != null) {
            keywordParams.set('x', String(centerLng));
            keywordParams.set('y', String(centerLat));
            keywordParams.set('radius', '20000'); // 20km ìš°ì„ 
          }
          const keywordUrl = 'https://dapi.kakao.com/v2/local/search/keyword.json?' + keywordParams.toString();
          let res = await fetch(keywordUrl, {
            headers: { Authorization: 'KakaoAK c27024d37ac99abf233b12f0efa39099' }
          });
          if (!res.ok) throw new Error('HTTP ' + res.status + ' (keyword)');
          let data = await res.json();
          let documents = Array.isArray(data && data.documents) ? data.documents : [];
          let usedMode = 'keyword';

          // 2) í‚¤ì›Œë“œ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ì§€ë„ ìœ„ì¹˜ ì œì•½ ì—†ì´ ì „êµ­ ê²€ìƒ‰ ì¬ì‹œë„
          if (documents.length === 0) {
            const globalKeywordUrl = 'https://dapi.kakao.com/v2/local/search/keyword.json?query=' + encodeURIComponent(query) + '&size=15';
            res = await fetch(globalKeywordUrl, {
              headers: { Authorization: 'KakaoAK c27024d37ac99abf233b12f0efa39099' }
            });
            if (!res.ok) throw new Error('HTTP ' + res.status + ' (keyword-global)');
            data = await res.json();
            documents = Array.isArray(data && data.documents) ? data.documents : [];
          }

          // 3) ê·¸ë˜ë„ ì—†ìœ¼ë©´ ì£¼ì†Œ ê²€ìƒ‰ìœ¼ë¡œ í´ë°±
          if (documents.length === 0) {
            const addressUrl = 'https://dapi.kakao.com/v2/local/search/address.json?query=' + encodeURIComponent(query);
            res = await fetch(addressUrl, {
              headers: { Authorization: 'KakaoAK c27024d37ac99abf233b12f0efa39099' }
            });
            if (!res.ok) throw new Error('HTTP ' + res.status + ' (address)');
            data = await res.json();
            documents = Array.isArray(data && data.documents) ? data.documents : [];
            usedMode = 'address';
          }

          if (!documents || documents.length === 0) {
            alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          // 3) ê²°ê³¼ ëª©ë¡ì„ íŒ¨ë„ì— ë Œë”ë§í•˜ê³  ì‚¬ìš©ì ì„ íƒì„ ê¸°ë‹¤ë¦¼
          showSearchResults(documents, usedMode);
        } catch (e) {
          alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
        }
      }

      function showSearchResults(documents, mode) {
        lastSearchResults = documents.slice(0, 20);
        lastSearchMode = mode;
        const list = document.getElementById('searchResultsList');
        if (!list) return;
        list.innerHTML = '';
        lastSearchResults.forEach((doc, idx) => {
          const item = document.createElement('div');
          item.className = 'search-result-item';
          item.dataset.index = String(idx);
          const title = mode === 'keyword' ? (doc.place_name || '') : (doc.address_name || '');
          const sub = mode === 'keyword' ? (doc.road_address_name || doc.address_name || '') : ((doc.road_address && doc.road_address.address_name) || '');
          item.innerHTML = `
            <p class="result-title">${idx + 1}. ${title || '(ì´ë¦„ ì—†ìŒ)'}</p>
            <p class="result-sub">${sub}</p>
          `;
          item.addEventListener('click', () => selectSearchResult(idx));
          list.appendChild(item);
        });
        const panel = document.getElementById('searchResultsPanel');
        if (panel) panel.style.display = 'block';
      }

      function hideSearchResults() {
        const panel = document.getElementById('searchResultsPanel');
        if (panel) panel.style.display = 'none';
        const list = document.getElementById('searchResultsList');
        if (list) list.innerHTML = '';
        lastSearchResults = [];
      }

      function selectSearchResult(index) {
        const doc = lastSearchResults[index];
        if (!doc) return;
        const lat = parseFloat(doc.y);
        const lng = parseFloat(doc.x);
        if (isNaN(lat) || isNaN(lng)) return;
        const position = { lat, lng };

        const title = lastSearchMode === 'keyword' ? (doc.place_name || '') : (doc.address_name || '');

        if (isKakaoVisible() && kakaoMap) {
          kakaoMap.setCenter(new kakao.maps.LatLng(position.lat, position.lng));
          // êµ¬ê¸€ ì¤Œ 16ê³¼ ìœ ì‚¬í•œ ì¹´ì¹´ì˜¤ ë ˆë²¨ë¡œ ì„¤ì •
          kakaoMap.setLevel(googleZoomToKakaoLevel(16));
          const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(position.lat, position.lng),
            map: kakaoMap,
            title
          });
          kakao.maps.event.addListener(marker, 'click', function() { removeSpecificKakaoMarker(marker); });
          kakaoMarkers.push(marker);
        } else {
          map.setCenter(position);
          map.setZoom(16);
          const newMarker = new google.maps.Marker({
            position,
            map,
            title,
            animation: google.maps.Animation.DROP
          });
          newMarker.addListener('click', function () { removeSpecificMarker(newMarker); });
          addressMarkers.push(newMarker);
        }

        hideSearchResults();
      }
      
      // íŠ¹ì • ë§ˆì»¤ ì œê±° í•¨ìˆ˜
      function removeSpecificMarker(marker) {
        if (marker) {
          marker.setMap(null);
          // ë°°ì—´ì—ì„œ í•´ë‹¹ ë§ˆì»¤ ì œê±°
          const index = addressMarkers.indexOf(marker);
          if (index > -1) {
            addressMarkers.splice(index, 1);
          }
        }
      }
      function removeSpecificKakaoMarker(marker) {
        if (marker) {
          marker.setMap && marker.setMap(null);
          const idx = kakaoMarkers.indexOf(marker);
          if (idx > -1) kakaoMarkers.splice(idx, 1);
        }
      }
      
      // ëª¨ë“  ì£¼ì†Œ ë§ˆì»¤ ì œê±° í•¨ìˆ˜
      function clearAllAddressMarkers() {
        addressMarkers.forEach(marker => {
          marker.setMap(null);
        });
        addressMarkers = [];
        if (kakaoMarkers && kakaoMarkers.length) {
          kakaoMarkers.forEach(m => m.setMap && m.setMap(null));
          kakaoMarkers = [];
        }
        document.getElementById('addressInput').value = '';
      }
      // ì‚¬ì´ë“œ íŒ¨ë„ í† ê¸€ í•¨ìˆ˜
      function hideMenu() {
        document.getElementById('customMapMenu').classList.add('hide');
        document.getElementById('menuToggleBtn').classList.add('show');
      }
      function showMenu() {
        document.getElementById('customMapMenu').classList.remove('hide');
        document.getElementById('menuToggleBtn').classList.remove('show');
      }
      
      // ë¸Œì´ì›”ë“œ ê²½ê³„ ë©”ë‰´ í† ê¸€
      function toggleVworldBoundaryMenu() {
        const menu = document.getElementById('vworldBoundaryMenu');
        const btn = document.getElementById('vworldBoundaryToggleBtn');
        if(menu.style.display === 'none') {
          menu.style.display = 'block';
          btn.textContent = '-ë²•ì •ê²½ê³„';
        } else {
          menu.style.display = 'none';
          btn.textContent = '+ë²•ì •ê²½ê³„';
        }
      }
      
      // ë¸Œì´ì›”ë“œ ê²½ê³„ ë¡œë“œ í•¨ìˆ˜
      function loadVworldBoundary(layerType) {
        if (!map) {
          alert('ì§€ë„ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          return;
        }
        
        // í˜„ì¬ ì§€ë„ zoom ê°’ í™•ì¸
        const zoom = map.getZoom();
        // ê¸°ì¡´ ìµœëŒ€ í—ˆìš© zoomì€ 16(ì˜ˆì‹œ)ë¡œ ê°€ì •, ë‘ ë°°ë¡œ 32ë¡œ ì„¤ì •
        const MAX_BOUNDARY_ZOOM = 32;
        if (zoom > MAX_BOUNDARY_ZOOM) {
          alert('ì´ ê²½ê³„ëŠ” ë” ì´ìƒ í™•ëŒ€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ìµœëŒ€ í—ˆìš© zoom: ' + MAX_BOUNDARY_ZOOM + ')');
          return;
        }
        
        showGoogleMap();
        clearVworldBoundary();
        
        const bounds = map.getBounds();
        if (!bounds) {
          alert('ì§€ë„ ì˜ì—­ì„ í™•ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§€ë„ë¥¼ ì´ë™í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        const ne = bounds.getNorthEast();
        const sw = bounds.getSouthWest();
        
        // EPSG:4326ì˜ ê²½ìš° (ymin,xmin,ymax,xmax) í˜•ì‹
        const bbox = `${sw.lat()},${sw.lng()},${ne.lat()},${ne.lng()}`;
        
        // map divì˜ ì‹¤ì œ í¬ê¸° ì‚¬ìš©
        const mapDiv = document.getElementById('map');
        const width = mapDiv.offsetWidth;
        const height = mapDiv.offsetHeight;
        
        // ë¸Œì´ì›”ë“œ ê³µì‹ WMS API URL ìƒì„±
        const apiUrl = 'https://api.vworld.kr/req/wms';
        const params = new URLSearchParams({
          key: '910896AA-BE88-363C-B54B-9FB421BD05DB', // ë³¸ì¸ í‚¤ë¡œ êµì²´
          service: 'WMS',
          request: 'GetMap',
          version: '1.3.0',
          layers: layerType, // ê³µì‹ WMSëª…
          styles: '', // í•„ìš”ì‹œ ìŠ¤íƒ€ì¼ëª… ì…ë ¥
          crs: 'EPSG:4326',
          bbox: bbox,
          width: width,
          height: height,
          format: 'image/png',
          transparent: 'true',
          exceptions: 'text/xml'
        });
        const fullUrl = `${apiUrl}?${params.toString()}`;

        // ì´ë¯¸ì§€ ì˜¤ë²„ë ˆì´ ìƒì„±
        const imageBounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(sw.lat(), sw.lng()),
          new google.maps.LatLng(ne.lat(), ne.lng())
        );

        vworldBoundaryOverlay = new google.maps.GroundOverlay(fullUrl, imageBounds, {
          opacity: 0.8
        });

        vworldBoundaryOverlay.setMap(map);
        currentBoundaryLayer = layerType;

        // ë©”ë‰´ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateBoundaryMenuState(layerType);
      }
      
      // ë¸Œì´ì›”ë“œ ê²½ê³„ ì œê±° í•¨ìˆ˜
      function clearVworldBoundary() {
        if (vworldBoundaryOverlay) {
          vworldBoundaryOverlay.setMap(null);
          vworldBoundaryOverlay = null;
        }
        currentBoundaryLayer = null;
        updateBoundaryMenuState(null);
      }
      
      // ê²½ê³„ ë©”ë‰´ ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateBoundaryMenuState(activeLayer) {
        const buttons = document.querySelectorAll('#vworldBoundaryMenu button');
        buttons.forEach(btn => {
          btn.style.background = '#f7f7f7';
          btn.style.color = '#333';
        });
        
        if (activeLayer) {
          const activeBtn = document.querySelector(`#vworldBoundaryMenu button[onclick*="${activeLayer}"]`);
          if (activeBtn) {
            activeBtn.style.background = '#e0e7ff';
            activeBtn.style.color = '#1d4ed8';
          }
        }
      }
      
      // ê²½ê³„ ì˜¤ë²„ë ˆì´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateBoundaryOverlay() {
        if (!currentBoundaryLayer || !map) return;
        
        // í˜„ì¬ ì§€ë„ zoom ê°’ í™•ì¸
        const zoom = map.getZoom();
        const MAX_BOUNDARY_ZOOM = 32;
        if (zoom > MAX_BOUNDARY_ZOOM) {
          clearVworldBoundary();
          alert('ì´ ê²½ê³„ëŠ” ë” ì´ìƒ í™•ëŒ€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ìµœëŒ€ í—ˆìš© zoom: ' + MAX_BOUNDARY_ZOOM + ')');
          return;
        }
        
        const bounds = map.getBounds();
        if (!bounds) return;
        
        const ne = bounds.getNorthEast();
        const sw = bounds.getSouthWest();
        
        // EPSG:4326ì˜ ê²½ìš° (ymin,xmin,ymax,xmax) í˜•ì‹
        const bbox = `${sw.lat()},${sw.lng()},${ne.lat()},${ne.lng()}`;
        
        // map divì˜ ì‹¤ì œ í¬ê¸° ì‚¬ìš©
        const mapDiv = document.getElementById('map');
        const width = mapDiv.offsetWidth;
        const height = mapDiv.offsetHeight;
        
        // ë¸Œì´ì›”ë“œ ê³µì‹ WMS API URL ìƒì„±
        const apiUrl = 'https://api.vworld.kr/req/wms';
        const params = new URLSearchParams({
          key: '910896AA-BE88-363C-B54B-9FB421BD05DB',
          service: 'WMS',
          request: 'GetMap',
          version: '1.3.0',
          layers: currentBoundaryLayer,
          styles: '',
          crs: 'EPSG:4326',
          bbox: bbox,
          width: width,
          height: height,
          format: 'image/png',
          transparent: 'true',
          exceptions: 'text/xml'
        });
        const fullUrl = `${apiUrl}?${params.toString()}`;

        // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ì œê±°
        if (vworldBoundaryOverlay) {
          vworldBoundaryOverlay.setMap(null);
        }

        // ìƒˆë¡œìš´ ì´ë¯¸ì§€ ì˜¤ë²„ë ˆì´ ìƒì„±
        const imageBounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(sw.lat(), sw.lng()),
          new google.maps.LatLng(ne.lat(), ne.lng())
        );

        vworldBoundaryOverlay = new google.maps.GroundOverlay(fullUrl, imageBounds, {
          opacity: 0.8
        });

        vworldBoundaryOverlay.setMap(map);
      }
      function loadCadastralOverlay() {
        // ì¹´ì¹´ì˜¤ë§µì´ ë³´ì´ëŠ” ê²½ìš° ì¹´ì¹´ì˜¤ ë°©ì‹ìœ¼ë¡œ ë¡œë“œ
        if (isKakaoVisible()) {
          loadCadastralOverlayKakao();
          return;
        }
        if (!map) {
          alert('ì§€ë„ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          return;
        }
        const zoom = map.getZoom();
        const MAX_CADASTRAL_ZOOM = 32;
        if (zoom > MAX_CADASTRAL_ZOOM) {
          alert('ì´ ì§€ì ë„ëŠ” ë” ì´ìƒ í™•ëŒ€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ìµœëŒ€ í—ˆìš© zoom: ' + MAX_CADASTRAL_ZOOM + ')');
          return;
        }
        clearCadastralOverlay();
        const bounds = map.getBounds();
        if (!bounds) {
          alert('ì§€ë„ ì˜ì—­ì„ í™•ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§€ë„ë¥¼ ì´ë™í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          return;
        }
        const ne = bounds.getNorthEast();
        const sw = bounds.getSouthWest();
        const bbox = `${sw.lat()},${sw.lng()},${ne.lat()},${ne.lng()}`;
        const mapDiv = document.getElementById('map');
        const width = mapDiv.offsetWidth;
        const height = mapDiv.offsetHeight;
        const apiUrl = 'https://api.vworld.kr/req/wms';
        const params = new URLSearchParams({
          key: '910896AA-BE88-363C-B54B-9FB421BD05DB',
          service: 'WMS',
          request: 'GetMap',
          version: '1.3.0',
          layers: 'lp_pa_cbnd_bonbun,lp_pa_cbnd_bubun',
          styles: '',
          crs: 'EPSG:4326',
          bbox: bbox,
          width: width,
          height: height,
          format: 'image/png',
          transparent: 'true',
          exceptions: 'text/xml'
        });
        const fullUrl = `${apiUrl}?${params.toString()}`;
        const imageBounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(sw.lat(), sw.lng()),
          new google.maps.LatLng(ne.lat(), ne.lng())
        );
        cadastralOverlay = new google.maps.GroundOverlay(fullUrl, imageBounds, {
          opacity: 0.8
        });
        cadastralOverlay.setMap(map);
        
        // ë²„íŠ¼ ìƒíƒœ ìœ ì§€
        updateCadastralButtonState(true);
        
        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateCadastralButtonState(true);
      }
      function clearCadastralOverlay() {
        // ì¹´ì¹´ì˜¤ ì§€ì ë„ ì œê±° ìš°ì„  ì²˜ë¦¬
        if (kakaoCadastralOverlayEl) {
          clearCadastralOverlayKakao();
        }
        if (cadastralOverlay) {
          cadastralOverlay.setMap(null);
          cadastralOverlay = null;
        }
        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateCadastralButtonState(false);
      }
      
      // ì—°ì†ì§€ì ë„ í† ê¸€ í•¨ìˆ˜
      function toggleCadastralOverlay() {
        if (isKakaoVisible()) {
          // ì¹´ì¹´ì˜¤ë§µ í‘œì‹œ ìƒíƒœ
          if (kakaoCadastralOverlayEl) {
            clearCadastralOverlayKakao();
          } else {
            loadCadastralOverlayKakao();
          }
        } else {
          // êµ¬ê¸€ë§µ í‘œì‹œ ìƒíƒœ
          if (cadastralOverlay) {
            clearCadastralOverlay();
          } else {
            loadCadastralOverlay();
          }
        }
      }
      
      // ì—°ì†ì§€ì ë„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateCadastralButtonState(isLoaded) {
        const btn = document.getElementById('cadastralToggleBtn');
        if (isLoaded) {
          btn.textContent = '-ì§€ì ë„ì œê±°';
          btn.style.background = '#e0e7ff';
          btn.style.color = '#1d4ed8';
        } else {
          btn.textContent = '+ì—°ì†ì§€ì ë„';
          btn.style.background = '#f7f7f7';
          btn.style.color = '#333';
        }
      }
      // ì§€ë„ ì´ë™ ì‹œ ì—°ì†ì§€ì ë„ ì˜¤ë²„ë ˆì´ë„ ê°±ì‹ 
      map && map.addListener && map.addListener('bounds_changed', function() {
        if (cadastralOverlay) {
          setTimeout(() => {
            updateCadastralOverlay();
          }, 500);
        }
      });
      function updateCadastralOverlay() {
        // ì¹´ì¹´ì˜¤ ì§€ì ë„ ëª¨ë“œ
        if (cadastralOverlayMode === 'kakao') {
          updateCadastralOverlayKakao();
          return;
        }
        if (!map || !cadastralOverlay) return;
        const zoom = map.getZoom();
        const MAX_CADASTRAL_ZOOM = 32;
        if (zoom > MAX_CADASTRAL_ZOOM) {
          clearCadastralOverlay();
          alert('ì´ ì§€ì ë„ëŠ” ë” ì´ìƒ í™•ëŒ€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ìµœëŒ€ í—ˆìš© zoom: ' + MAX_CADASTRAL_ZOOM + ')');
          return;
        }
        const bounds = map.getBounds();
        if (!bounds) return;
        const ne = bounds.getNorthEast();
        const sw = bounds.getSouthWest();
        const bbox = `${sw.lat()},${sw.lng()},${ne.lat()},${ne.lng()}`;
        const mapDiv = document.getElementById('map');
        const width = mapDiv.offsetWidth;
        const height = mapDiv.offsetHeight;
        const apiUrl = 'https://api.vworld.kr/req/wms';
        const params = new URLSearchParams({
          key: '910896AA-BE88-363C-B54B-9FB421BD05DB',
          service: 'WMS',
          request: 'GetMap',
          version: '1.3.0',
          layers: 'lp_pa_cbnd_bonbun,lp_pa_cbnd_bubun',
          styles: '',
          crs: 'EPSG:4326',
          bbox: bbox,
          width: width,
          height: height,
          format: 'image/png',
          transparent: 'true',
          exceptions: 'text/xml'
        });
        const fullUrl = `${apiUrl}?${params.toString()}`;
        if (cadastralOverlay) {
          cadastralOverlay.setMap(null);
        }
        const imageBounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(sw.lat(), sw.lng()),
          new google.maps.LatLng(ne.lat(), ne.lng())
        );
        cadastralOverlay = new google.maps.GroundOverlay(fullUrl, imageBounds, {
          opacity: 0.8
        });
        cadastralOverlay.setMap(map);
      }
      // ì¹´ì¹´ì˜¤ ì§€ì ë„ ë¡œë“œ/ì—…ë°ì´íŠ¸/ì œê±°
      function loadCadastralOverlayKakao() {
        if (!kakaoMap) { alert('ì¹´ì¹´ì˜¤ë§µì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }
        const mapDiv = document.getElementById('kakaoMapDiv');
        if (!mapDiv) return;
        const bounds = kakaoMap.getBounds();
        if (!bounds) return;
        const sw = bounds.getSouthWest();
        const ne = bounds.getNorthEast();
        const bbox = `${sw.getLat()},${sw.getLng()},${ne.getLat()},${ne.getLng()}`;
        const width = mapDiv.offsetWidth;
        const height = mapDiv.offsetHeight;
        const apiUrl = 'https://api.vworld.kr/req/wms';
        const params = new URLSearchParams({
          key: '910896AA-BE88-363C-B54B-9FB421BD05DB',
          service: 'WMS',
          request: 'GetMap',
          version: '1.3.0',
          layers: 'lp_pa_cbnd_bonbun,lp_pa_cbnd_bubun',
          styles: '',
          crs: 'EPSG:4326',
          bbox: bbox,
          width: String(width),
          height: String(height),
          format: 'image/png',
          transparent: 'true',
          exceptions: 'text/xml'
        });
        const fullUrl = `${apiUrl}?${params.toString()}`;

        if (!kakaoCadastralOverlayEl) {
          const overlay = document.createElement('div');
          overlay.id = 'kakaoCadastralOverlay';
          overlay.style.position = 'absolute';
          overlay.style.top = '0';
          overlay.style.left = '0';
          overlay.style.width = '100%';
          overlay.style.height = '100%';
          overlay.style.pointerEvents = 'none';
          overlay.style.zIndex = '6';
          const img = document.createElement('img');
          img.id = 'kakaoCadastralImage';
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.imageRendering = 'pixelated';
          overlay.appendChild(img);
          const container = document.getElementById('kakaoMapContainer');
          container && container.appendChild(overlay);
          kakaoCadastralOverlayEl = overlay;

          // ì§€ë„ ì´ë™/í™•ëŒ€ ì‹œ ê°±ì‹ 
          kakao.maps.event.addListener(kakaoMap, 'idle', function() {
            if (cadastralOverlayMode === 'kakao') {
              setTimeout(() => updateCadastralOverlayKakao(), 300);
            }
          });
        }
        const imgEl = document.getElementById('kakaoCadastralImage');
        if (imgEl) imgEl.src = fullUrl;
        cadastralOverlayMode = 'kakao';
        updateCadastralButtonState(true);
      }
      function updateCadastralOverlayKakao() {
        if (!kakaoMap || !kakaoCadastralOverlayEl) return;
        const mapDiv = document.getElementById('kakaoMapDiv');
        if (!mapDiv) return;
        const bounds = kakaoMap.getBounds();
        if (!bounds) return;
        const sw = bounds.getSouthWest();
        const ne = bounds.getNorthEast();
        const bbox = `${sw.getLat()},${sw.getLng()},${ne.getLat()},${ne.getLng()}`;
        const width = mapDiv.offsetWidth;
        const height = mapDiv.offsetHeight;
        const apiUrl = 'https://api.vworld.kr/req/wms';
        const params = new URLSearchParams({
          key: '910896AA-BE88-363C-B54B-9FB421BD05DB',
          service: 'WMS',
          request: 'GetMap',
          version: '1.3.0',
          layers: 'lp_pa_cbnd_bonbun,lp_pa_cbnd_bubun',
          styles: '',
          crs: 'EPSG:4326',
          bbox: bbox,
          width: String(width),
          height: String(height),
          format: 'image/png',
          transparent: 'true',
          exceptions: 'text/xml'
        });
        const fullUrl = `${apiUrl}?${params.toString()}`;
        const imgEl = document.getElementById('kakaoCadastralImage');
        if (imgEl) imgEl.src = fullUrl;
      }
      function clearCadastralOverlayKakao() {
        if (kakaoCadastralOverlayEl) {
          kakaoCadastralOverlayEl.remove();
          kakaoCadastralOverlayEl = null;
        }
        if (cadastralOverlayMode === 'kakao') {
          cadastralOverlayMode = null;
        }
        updateCadastralButtonState(false);
      }
    </script>
    <!-- êµ¬ê¸€ ë§µ API ìŠ¤í¬ë¦½íŠ¸. API í‚¤ì™€ ì½œë°± í•¨ìˆ˜(initMap) ì§€ì • -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDVwJrvIcbqAOX24g9JODhD7DGtTz7z2Pg&callback=initMap" async defer></script>
</body>
</html>
