<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1d4ed8">
    <title>í™‹ì¹´ì´ë„ ì—¬í–‰</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }
        #map {
            width: 100vw;
            height: 100vh;
            min-height: 100%;
            touch-action: manipulation;
        }
        h1 {
            display: none;
        }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ - ëª¨ë°”ì¼ ìµœì í™” */
        #customMapMenu {
            position: absolute;
            top: 20px;
            left: 15px;
            z-index: 10;
            width: 200px;
            max-width: 85vw;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.05);
            padding: 15px 12px 12px 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: all 0.3s ease;
        }
        #customMapMenu.hide {
            left: -220px;
            opacity: 0;
            pointer-events: none;
        }
        #customMapMenu h2 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0 0 10px 0;
            color: #1a1a1a;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        .menu-group {
            margin-bottom: 4px;
        }
        .menu-group label {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 5px;
            display: block;
            color: #1a1a1a;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ - í„°ì¹˜ ì¹œí™”ì  */
        .menu-group button, .toggle-btn, .map-type-btn {
            width: 100%;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 8px;
            margin-bottom: 4px;
            font-size: 0.9rem;
            color: #1a1a1a;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        .menu-group button:hover, .toggle-btn:hover, .map-type-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.5);
            color: #000;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .menu-group button:active, .toggle-btn:active, .map-type-btn:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.98);
        }
        .menu-group .submenu {
            margin-left: 10px;
            margin-top: 3px;
        }
        
        /* ì‚¬ì´ë“œ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ - ëª¨ë°”ì¼ ìµœì í™” */
        #menuToggleBtn {
            position: absolute;
            top: 20px;
            left: 15px;
            z-index: 20;
            background: rgba(29, 78, 216, 0.5);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }
        #menuToggleBtn.show {
            display: flex;
        }
        #menuToggleBtn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .toggle-btn {
            text-align: left;
            font-weight: 600;
        }
        
        /* í•˜ìœ„ ì˜µì…˜ ë“¤ì—¬ì“°ê¸° */
        .submenu {
            margin-left: 15px;
        }
        .submenu .submenu {
            margin-left: 15px;
        }
        .submenu button {
            width: 90%;
            margin-left: 0;
        }
        
        /* êµ¬ê¸€ë§µ í•˜ìœ„ ì˜µì…˜ ë“¤ì—¬ì“°ê¸° */
        #googleMapMenu > .toggle-btn {
            margin-left: 15px;
        }
        
        /* ì˜¤ë¥¸ìª½ ìƒë‹¨ ì§€ë„ íƒ€ì… ì„ íƒ ë²„íŠ¼ - ëª¨ë°”ì¼ ìµœì í™” */
        #mapTypeSelector {
            position: absolute;
            top: 20px;
            right: 15px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 6px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.05);
        }
        
        #mapTypeSelector.hide {
            right: -180px;
            opacity: 0;
            pointer-events: none;
        }
        

        
        /* GPS ìœ„ì¹˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #locationBtn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 10;
            background: transparent;
            color: #333;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }
        
        #locationBtn:hover {
            background: rgba(51, 51, 51, 0.1);
            transform: scale(1.05);
        }
        
        #locationBtn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        #locationBtn.loading {
            background: #6b7280;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* ì˜¤ë¥¸ìª½ ìƒë‹¨ í† ê¸€ ë²„íŠ¼ - ëª¨ë°”ì¼ ìµœì í™” */
        #rightMenuToggleBtn {
            position: absolute;
            top: 20px;
            right: 15px;
            z-index: 20;
            background: rgba(29, 78, 216, 0.5);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }
        #rightMenuToggleBtn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .map-type-btn {
            justify-content: center;
            font-weight: 600;
            padding: 12px 16px;
        }
        

        
        .map-type-btn.active {
            background: #1d4ed8;
            color: white;
            border-color: #1d4ed8;
        }
        
        .map-type-btn.sub-option {
            margin-left: 15px;
            font-size: 0.8rem;
            padding: 10px 12px;
        }
        
        /* ëª¨ë°”ì¼ ìµœì í™”ë¥¼ ìœ„í•œ ë¯¸ë””ì–´ ì¿¼ë¦¬ */
        @media (max-width: 768px) {
            #customMapMenu {
                width: 180px;
                max-width: 80vw;
                top: 15px;
                left: 10px;
                padding: 12px 10px 10px 10px;
            }
            
            #customMapMenu.hide {
                left: -200px;
            }
            
            #menuToggleBtn, #rightMenuToggleBtn {
                width: 44px;
                height: 44px;
                font-size: 1.3rem;
                top: 15px;
            }
            
            #menuToggleBtn {
                left: 10px;
            }
            
            #rightMenuToggleBtn {
                right: 10px;
            }
            
            #mapTypeSelector {
                top: 15px;
                right: 10px;
            }
            
            .map-type-btn {
                padding: 10px 14px;
                font-size: 0.85rem;
                min-height: 40px;
            }
            
            .toggle-btn {
                padding: 10px 8px;
                min-height: 40px;
                font-size: 0.85rem;
            }
            
            #locationBtn {
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
                bottom: 15px;
                right: 15px;
            }
            

            
            /* ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ ìµœì í™” */
            .menu-group button, .toggle-btn, .map-type-btn {
                min-height: 48px; /* iOS ê¶Œì¥ ìµœì†Œ í„°ì¹˜ ì˜ì—­ */
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ ìµœì í™” */
            .info-content {
                max-height: 60vh;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media (max-width: 480px) {
            #customMapMenu {
                width: 160px;
                max-width: 75vw;
                top: 10px;
                left: 8px;
                padding: 10px 8px 8px 8px;
            }
            
            #customMapMenu.hide {
                left: -180px;
            }
            
            #menuToggleBtn, #rightMenuToggleBtn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
                top: 10px;
            }
            
            #menuToggleBtn {
                left: 8px;
            }
            
            #rightMenuToggleBtn {
                right: 8px;
            }
            
            #mapTypeSelector {
                top: 10px;
                right: 8px;
            }
            
            .map-type-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
                min-height: 36px;
            }
            
            .toggle-btn {
                padding: 8px 6px;
                min-height: 36px;
                font-size: 0.8rem;
            }
            
            #locationBtn {
                width: 37px;
                height: 37px;
                font-size: 1rem;
                bottom: 10px;
                right: 10px;
            }
            

            
            /* ì‘ì€ í™”ë©´ì—ì„œ ì •ë³´ì°½ ìµœì í™” */
            #preparationInfo, #routeSaveDialog, #markerSaveDialog {
                width: 95vw;
                max-width: 95vw;
                left: 2.5vw !important;
                transform: none !important;
            }
            

            
            .user-added-item .swipe-delete-btn {
                min-height: 52px;
                min-width: 80px;
                font-size: 1.1rem;
                padding: 14px 24px;
            }
        }
        
        /* í„°ì¹˜ ìµœì í™”ë¥¼ ìœ„í•œ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        * {
            -webkit-touch-callout: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
        ::-webkit-scrollbar {
            display: none;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ë”ë¸”íƒ­ ì¤Œ ë°©ì§€ ë° í•œ ì†ê°€ë½ ë“œë˜ê·¸ ìµœì í™” */
        #map {
            touch-action: manipulation;
            user-select: none;
            -webkit-overflow-scrolling: touch;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ í„°ì¹˜ ìµœì í™” */
        button, .toggle-btn, .map-type-btn {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            cursor: pointer;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ì…ë ¥ í•„ë“œ ìµœì í™” */
        input[type="text"], input[type="url"] {
            appearance: none;
            border-radius: 6px;
            font-size: 16px; /* iOSì—ì„œ ì¤Œ ë°©ì§€ */
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ì²´í¬ë°•ìŠ¤ ìµœì í™” */
        input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            position: relative;
        }
        
        input[type="checkbox"]:checked {
            background: #1d4ed8;
        }
        
        input[type="checkbox"]:checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ì¶”ê°€ ì„±ëŠ¥ ìµœì í™” */
        @media (max-width: 768px) {
            /* ëª¨ë°”ì¼ì—ì„œ í•˜ë“œì›¨ì–´ ê°€ì† í™œì„±í™” */
            #map, .info-content, .user-added-item {
                -webkit-transform: translateZ(0);
                -moz-transform: translateZ(0);
                -ms-transform: translateZ(0);
                transform: translateZ(0);
                will-change: transform;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ í”¼ë“œë°± ìµœì í™” */
            button:active, .toggle-btn:active, .map-type-btn:active {
                -webkit-transform: scale(0.95) translateZ(0);
                transform: scale(0.95) translateZ(0);
                transition: transform 0.1s ease;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ ì„±ëŠ¥ í–¥ìƒ */
            .info-content::-webkit-scrollbar {
                width: 4px;
            }
            
            .info-content::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.1);
                border-radius: 2px;
            }
            
            .info-content::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.3);
                border-radius: 2px;
            }
            

            
            .user-added-item .swipe-delete-btn {
                min-height: 48px;
                min-width: 70px;
                font-size: 1rem;
                padding: 12px 20px;
            }
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ì•ˆì „ ì˜ì—­ ì§€ì› */
        @supports (padding: max(0px)) {
            @media (max-width: 768px) {
                #customMapMenu {
                    padding-top: max(15px, env(safe-area-inset-top));
                    padding-left: max(10px, env(safe-area-inset-left));
                }
                
                #menuToggleBtn, #rightMenuToggleBtn {
                    top: max(15px, env(safe-area-inset-top));
                }
                
                #menuToggleBtn {
                    left: max(10px, env(safe-area-inset-left));
                }
                
                #rightMenuToggleBtn {
                    right: max(10px, env(safe-area-inset-right));
                }
            }
        }
        
      

        
        /* ì‚¬ì „ì¤€ë¹„ ì •ë³´ì°½ ìŠ¤íƒ€ì¼ */
        #preparationInfo {
            position: absolute;
            z-index: 15;
            width: 400px;
            max-width: 90vw;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .info-header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .info-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .info-content {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .info-section {
            margin-bottom: 12px;
        }
        
        .info-section:last-child {
            margin-bottom: 0;
        }
        
        .info-section h4 {
            margin: 0 0 6px 0;
            font-size: 0.77rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .info-section p {
            margin: 4px 0;
            font-size: 0.665rem;
            color: #374151;
            line-height: 1.5;
        }
        
        .info-section ul {
            margin: 4px 0;
            padding-left: 20px;
        }
        
        .info-section li {
            margin: 3px 0;
            font-size: 0.665rem;
            color: #374151;
            line-height: 1.5;
        }
        
        .ticket-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
            width: 100%;
        }
        
        .ticket-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .ticket-btn:active {
            transform: translateY(0);
        }
        
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            #preparationInfo {
                width: 350px;
                left: 50% !important;
                transform: translateX(-50%) !important;
                top: 80px !important;
                max-width: 90vw;
                margin: 0 auto;
            }
            
            #routeSaveDialog, #markerSaveDialog {
                width: 350px;
                left: 50% !important;
                transform: translateX(-50%) !important;
                top: 80px !important;
                max-width: 90vw;
                margin: 0 auto;
            }
        }
        
        @media (max-width: 480px) {
            #preparationInfo {
                width: 320px;
                top: 70px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                max-width: 95vw;
            }
            
            #routeSaveDialog, #markerSaveDialog {
                width: 320px;
                top: 70px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                max-width: 95vw;
            }
            
            .info-content {
                padding: 16px;
            }
            
            .info-header {
                padding: 14px 16px;
            }
        }
        
        /* ì²´í¬ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .checklist-item {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
            padding: 4px 0;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            position: relative; /* ìŠ¤ì™€ì´í”„ ë²„íŠ¼ ìœ„ì¹˜ë¥¼ ìœ„í•´ ì¶”ê°€ */
        }
        
        .checklist-item:hover {
            background-color: rgba(29, 78, 216, 0.05);
        }
        
        .prep-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            accent-color: #1d4ed8;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .prep-checkbox:checked {
            background-color: #1d4ed8;
        }
        
        .checklist-item label {
            cursor: default;
            user-select: none;
            flex: 1;
            line-height: 1.4;
            font-size: 0.665rem;
        }
        .checklist-item:last-child {
            margin-bottom: 0;
        }
        
        /* ê¸°ì¡´ í•­ëª©ì˜ item-content ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .checklist-item .item-content {
            display: flex;
            align-items: center;
            width: 100%;
            transition: transform 0.3s ease;
            flex: 1;
        }
        
        /* ì‚¬ìš©ì ì¶”ê°€ í•­ëª© í¼ ìŠ¤íƒ€ì¼ */
        .add-item-form {
            margin-top: 20px;
            padding: 16px;
            background: rgba(29, 78, 216, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(29, 78, 216, 0.1);
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 6px;
        }
        
        .form-group input {
            padding: 5px 12px;
            border: 1px solid rgba(29, 78, 216, 0.2);
            border-radius: 8px;
            font-size: 0.63rem;
            font-family: inherit;
            background: white;
            transition: border-color 0.2s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #1d4ed8;
            box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.1);
        }
        
        .form-buttons {
            display: flex;
            gap: 8px;
        }
        
                 .add-btn {
             width: 100%;
             padding: 14px 32px;
             border: none;
             border-radius: 12px;
             font-size: 15px;
             font-weight: 500;
             cursor: pointer;
             transition: all 0.2s ease;
             background: rgba(255, 255, 255, 0.12);
             color: #000;
             backdrop-filter: blur(10px);
             min-width: 120px;
         }
         
         .add-btn:hover {
             background: rgba(255, 255, 255, 0.18);
             transform: translateY(-1px);
         }
         
                 .add-btn:active {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(0);
        }
        
        /* ìˆ˜ì • í¼ ìŠ¤íƒ€ì¼ */
        .edit-item-form {
            position: fixed;
            z-index: 20;
            width: 400px;
            max-width: 90vw;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }
        
        .edit-form-header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .edit-form-header h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .edit-form-header .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .edit-form-header .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .edit-item-form .form-group {
            padding: 20px;
            margin: 0;
        }
        
        .edit-item-form .form-buttons {
            padding: 0 20px 20px 20px;
            gap: 12px;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }
        
        .save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }
        
        .cancel-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }
        
        /* ì‚¬ìš©ì ì¶”ê°€ í•­ëª© ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ì²´í¬ë¦¬ìŠ¤íŠ¸ì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼) */
        .user-added-item {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
            padding: 4px 0;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
        }
        
        .user-added-item:hover {
            background-color: rgba(29, 78, 216, 0.05);
        }
        
        /* ìŠ¤ì™€ì´í”„ ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ */
        .user-added-item .swipe-edit-btn,
        .checklist-item .swipe-edit-btn {
            position: absolute;
            right: -160px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            color: #000;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px;
            min-width: 60px;
        }
        
        /* ì¼ì • í•­ëª©(ì‚¬ì´ë“œíŒ¨ë„)ìš© ìŠ¤ì™€ì´í”„ ë²„íŠ¼ - ëª¨ë°”ì¼ í´ë¦­ ì •í™•ë„ ê°œì„  */
        .user-added-item[data-item-type="schedule"] .swipe-edit-btn {
            right: -350px;
            width: 60px;
            min-width: 60px;
            max-width: 60px;
            padding: 12px 8px;
            font-size: 0.8rem;
            height: 44px;
            min-height: 44px;
            max-height: 44px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-sizing: border-box;
        }
        
        .user-added-item[data-item-type="schedule"] .swipe-delete-btn {
            right: -250px;
            width: 60px;
            min-width: 60px;
            max-width: 60px;
            padding: 12px 8px;
            font-size: 0.8rem;
            height: 44px;
            min-height: 44px;
            max-height: 44px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-sizing: border-box;
        }
        
        .user-added-item .swipe-edit-btn:hover,
        .checklist-item .swipe-edit-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .user-added-item .swipe-edit-btn:active,
        .checklist-item .swipe-edit-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%);
        }
        
        /* ì¼ì • í•­ëª©ì˜ ìˆ˜ì • ë²„íŠ¼ì€ active ì• ë‹ˆë©”ì´ì…˜ ì œê±° */
        .user-added-item[data-item-type="schedule"] .swipe-edit-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%);
        }
        
        .user-added-item .swipe-delete-btn,
        .checklist-item .swipe-delete-btn {
            position: absolute;
            right: -80px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            color: #000;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px;
            min-width: 60px;
        }
        
        .user-added-item .swipe-delete-btn:hover,
        .checklist-item .swipe-delete-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }


        /* ìŠ¤ì™€ì´í”„ ë²„íŠ¼ hover ì‹œ ìœ„ì¹˜ ê³ ì • (ì¼ì •/ì„¸ë¶€ ê³µí†µ) */
        .user-added-item .swipe-edit-btn:hover,
        .user-added-item .swipe-delete-btn:hover,
        .user-added-item[data-item-type="schedule"] .swipe-edit-btn:hover,
        .user-added-item[data-item-type="schedule"] .swipe-delete-btn:hover {
            transform: translateY(-50%) !important;
        }


        
        .user-added-item .swipe-delete-btn:active,
        .checklist-item .swipe-delete-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%);
        }
        
        /* ì¼ì • í•­ëª©ì˜ ì‚­ì œ ë²„íŠ¼ì€ active ì• ë‹ˆë©”ì´ì…˜ ì œê±° */
        .user-added-item[data-item-type="schedule"] .swipe-delete-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%);
        }
        
        .user-added-item .item-content {
            display: flex;
            align-items: center;
            width: 100%;
            transition: transform 0.3s ease;
            font-size: inherit;
            flex: 1;
        }
        
        .user-added-item.swiped .item-content,
        .checklist-item.swiped .item-content {
            transform: translateX(-160px);
        }
        
        /* ì¼ì • í•­ëª©ì€ ì‚¬ì´ë“œíŒ¨ë„ì—ì„œ ë” ì‘ì€ ê±°ë¦¬ë¡œ ìŠ¤ì™€ì´í”„ - ë‘ ë²„íŠ¼ì´ ëª¨ë‘ ë³´ì´ë„ë¡ */
        .user-added-item[data-item-type="schedule"].swiped .item-content {
            transform: translateX(-120px);
        }
        
        .user-added-item.swiped .swipe-edit-btn,
        .checklist-item.swiped .swipe-edit-btn {
            right: 88px;
        }
        
        .user-added-item.swiped .swipe-delete-btn,
        .checklist-item.swiped .swipe-delete-btn {
            right: 8px;
        }
        
        /* ì¼ì • í•­ëª© ìŠ¤ì™€ì´í”„ ì™„ë£Œ ì‹œ ìœ„ì¹˜ ì¡°ì • - ìˆ˜ì • ë²„íŠ¼ì„ ì™¼ìª½ìœ¼ë¡œ ë” ì´ë™ */
        .user-added-item[data-item-type="schedule"].swiped .swipe-edit-btn {
            right: 70px;
        }
        
        .user-added-item[data-item-type="schedule"].swiped .swipe-delete-btn {
            right: 5px;
        }
        

        
        /* ìƒˆ í•­ëª© ì¶”ê°€ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .add-item-section {
            margin-top: 10px;
            text-align: center;
        }
        
        .toggle-add-btn {
            background: rgba(255, 255, 255, 0.12);
            color: #000;
            border: none;
            border-radius: 12px;
            padding: 14px 32px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            min-width: 120px;
        }
        
        .toggle-add-btn:hover {
            background: rgba(255, 255, 255, 0.18);
            transform: translateY(-1px);
        }
        
        .toggle-add-btn:active {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(0);
        }
        
        .toggle-add-btn.expanded {
            background: rgba(255, 255, 255, 0.18);
            margin-bottom: 8px;
        }
        
        /* ê²½ë¡œ ì €ì¥ ë‹¤ì´ì–¼ë¡œê·¸ ìŠ¤íƒ€ì¼ */
        #routeSaveDialog, #markerSaveDialog {
            position: absolute;
            z-index: 15;
            width: 400px;
            max-width: 90vw;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }
        
        .route-save-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }
        
        .route-save-btn {
            background: rgba(255, 255, 255, 0.12);
            color: #000;
            border: none;
            border-radius: 12px;
            padding: 14px 32px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            width: 100%;
            min-width: 120px;
        }
        
        .route-save-btn:hover {
            background: rgba(255, 255, 255, 0.18);
            transform: translateY(-1px);
        }
        
        .route-save-btn:active {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(0);
        }
        
        /* ê²½ë¡œì œê±° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .route-remove-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }
        
        .route-remove-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .route-remove-btn:active {
            transform: translateY(0);
        }
        
        /* ë¹„í™œì„±í™”ëœ ì œê±° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .route-remove-btn:disabled {
            opacity: 0.3 !important;
            cursor: not-allowed !important;
            pointer-events: none;
        }
        
        .route-remove-btn:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }


        
        /* ê²½ë¡œ/ë§ˆì»¤ ì œê±° ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        [id$="RemoveButtons"] .route-remove-btn {
            width: auto;
            flex: 1;
            min-width: 0;
            padding: 10px 12px;
            font-size: 0.9rem;
        }
        
        /* InfoWindow ìŠ¤íƒ€ì¼ ê°œì„  */
        .gm-style .gm-style-iw-c {
            max-width: none !important;
            border-radius: 20px !important;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12) !important;
            background: rgba(255, 255, 255, 0.2) !important;
            backdrop-filter: blur(24px) !important;
            -webkit-backdrop-filter: blur(24px) !important;
            border: 1px solid rgba(255, 255, 255, 0.12) !important;
        }
        
        .gm-style .gm-style-iw-d {
            overflow: hidden !important;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ InfoWindow ìµœì í™” */
        @media (max-width: 768px) {
            .gm-style .gm-style-iw-c {
                margin: 8px !important;
                max-width: calc(100vw - 40px) !important;
            }
            
            .gm-style .gm-style-iw-d {
                max-height: calc(100vh - 150px) !important;
                overflow-y: auto !important;
            }
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ í¬ê¸° ìµœì í™” */
        @media (max-width: 768px) {
            [id$="RemoveButtons"] .route-remove-btn {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
        }
        
        /* ì¼ì • ì¶”ê°€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #addScheduleBtn {
            background: rgba(255, 255, 255, 0.15) !important;
            color: #1a1a1a !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            font-weight: 600 !important;
            box-shadow: none !important;
            transition: all 0.2s ease !important;
        }
        
        #addScheduleBtn:hover {
            background: rgba(255, 255, 255, 0.4) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
            color: #000 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        
        #addScheduleBtn:active {
            background: rgba(255, 255, 255, 0.3) !important;
            transform: scale(0.98) !important;
        }
        
        /* ê°€ê³„ë¶€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #budgetBtn {
            background: rgba(134, 239, 172, 0.6) !important;
            color: #1a1a1a !important;
            border: none !important;
            font-weight: 600 !important;
            box-shadow: none !important;
            transition: all 0.2s ease !important;
        }
        
        #budgetBtn:hover {
            background: rgba(134, 239, 172, 0.8) !important;
            color: #000 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(134, 239, 172, 0.4) !important;
        }
        
        #budgetBtn:active {
            background: rgba(134, 239, 172, 0.9) !important;
            transform: scale(0.98) !important;
        }
        
        /* ì¶”ê°€ëœ ì¼ì • ë²„íŠ¼ë“¤ ìŠ¤íƒ€ì¼ */
        #additionalDays {
            overflow: hidden !important; /* ìŠ¤ì™€ì´í”„ ë²„íŠ¼ ìˆ¨ê¹€ì„ ìœ„í•´ í•„ìˆ˜ */
            position: relative !important;
        }
        
        /* ë©”ë‰´ ê·¸ë£¹ ìì²´ì—ë„ overflow ì ìš© */
        .menu-group {
            overflow: hidden !important;
        }
        
        #additionalDays .toggle-btn {
            background: rgba(255, 255, 255, 0.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            margin-bottom: 4px !important;
            position: relative !important;
            overflow: hidden !important;
            cursor: pointer !important;
        }
        
        #additionalDays .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.35) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
        }
        
        /* ìŠ¤ì™€ì´í”„ íŒíŠ¸ ìŠ¤íƒ€ì¼ */
        #additionalDays .toggle-btn::after {
            content: 'â† ìŠ¤ì™€ì´í”„í•˜ì—¬ í¸ì§‘/ì‚­ì œ â†’' !important;
            position: absolute !important;
            top: 50% !important;
            right: 8px !important;
            transform: translateY(-50%) !important;
            font-size: 0.7rem !important;
            color: rgba(255, 255, 255, 0.6) !important;
            pointer-events: none !important;
            opacity: 0 !important;
            transition: opacity 0.3s ease !important;
            white-space: nowrap !important;
            font-weight: 500 !important;
        }
        
        #additionalDays .toggle-btn:hover::after {
            opacity: 1 !important;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ìŠ¤ì™€ì´í”„ íŒíŠ¸ ìµœì í™” */
        @media (max-width: 768px) {
            #additionalDays .toggle-btn::after {
                content: 'â† ìŠ¤ì™€ì´í”„ â†’' !important;
                font-size: 0.6rem !important;
                right: 4px !important;
                opacity: 0.8 !important;
            }
            
            #additionalDays .toggle-btn:hover::after {
                opacity: 1 !important;
            }
        }
        

        
        /* ì¼ì • ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        #scheduleContextMenu button:hover {
            background-color: rgba(29, 78, 216, 0.1) !important;
        }
        
        #scheduleContextMenu button:active {
            background-color: rgba(29, 78, 216, 0.2) !important;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìµœì í™” */
        @media (max-width: 768px) {
            #scheduleContextMenu {
                min-width: 180px !important;
                font-size: 16px !important;
            }
            
            #scheduleContextMenu button {
                padding: 16px 20px !important;
                min-height: 48px !important;
            }
        }

        /* ë“œë˜ê·¸ì•¤ë“œë¡­ ì• ë‹ˆë©”ì´ì…˜ ê°œì„  */
        .user-added-item {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .user-added-item.dragging {
            transform: scale(1.05) rotate(3deg);
            box-shadow: 0 12px 30px rgba(0,0,0,0.25), 0 4px 15px rgba(0,0,0,0.1);
            z-index: 10000;
            border-radius: 12px;
            background-color: #ffffff;
        }

        .drag-placeholder {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border: 2px dashed #3b82f6;
            border-radius: 12px;
            opacity: 0.8;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .drag-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
        }

        .drag-placeholder.highlight {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border-color: #2563eb;
            transform: scale(1.02);
        }

        /* ë“œë˜ê·¸ ì¤‘ ë‹¤ë¥¸ í•­ëª©ë“¤ ì• ë‹ˆë©”ì´ì…˜ */
        .user-added-item:not(.dragging) {
            transition: transform 0.2s ease, margin 0.2s ease;
        }

    </style>
</head>
<body>
    <h1>í™‹ì¹´ì´ë„ ì—¬í–‰</h1>
    <!-- ì§€ë„ë¥¼ í‘œì‹œí•  div ìš”ì†Œ -->
    <div id="map"></div>
    <!-- ì‚¬ì´ë“œ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ (íŒ¨ë„ì´ ìˆ¨ê²¨ì¡Œì„ ë•Œë§Œ ë³´ì„) -->
    <button id="menuToggleBtn" class="show" onclick="showMenu()" title="ë©”ë‰´ ì—´ê¸°">P</button>
    
    <!-- ì˜¤ë¥¸ìª½ ìƒë‹¨ í† ê¸€ ë²„íŠ¼ -->
    <button id="rightMenuToggleBtn" onclick="toggleRightMenu()" title="ì§€ë„ íƒ€ì… ë©”ë‰´ ì—´ê¸°">M</button>
    
    <!-- ì˜¤ë¥¸ìª½ ìƒë‹¨ ì§€ë„ íƒ€ì… ì„ íƒ ë²„íŠ¼ -->
    <div id="mapTypeSelector" class="hide">
        <button class="map-type-btn" onclick="toggleMarkerMode()" id="topMarkerBtn">ë§ˆì»¤ìƒì„±</button>
        <button class="map-type-btn" onclick="toggleRouteMode()" id="topRouteBtn">ê²½ë¡œìƒì„±</button>
        <button class="map-type-btn" onclick="toggleRouteSearch()" id="topRouteSearchBtn">ê²½ë¡œíƒìƒ‰</button>
        <button class="map-type-btn" onclick="setMapTypeFromTop('roadmap')" id="topRoadmapBtn">ì¼ë°˜</button>
        <button class="map-type-btn" onclick="setMapTypeFromTop('satellite')" id="topSatelliteBtn">ìœ„ì„±</button>
        <button class="map-type-btn sub-option" onclick="toggleHybridLabel()" id="topHybridBtn">ë¼ë²¨</button>
    </div>
    
    <!-- GPS ìœ„ì¹˜ ë²„íŠ¼ -->
    <button id="locationBtn" onclick="getCurrentLocation()" title="í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™">ğŸ“</button>
    

    
    <!-- ì™¼ìª½ ê³ ì •í˜• ì‚¬ì´ë“œë°” ë©”ë‰´ -->
    <div id="customMapMenu" class="hide">
      <h2>í™‹ì¹´ì´ë„ ì—¬í–‰</h2>
      <div class="menu-group">
        <input type="text" id="addressInput" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width: 90%; margin-bottom: 4px; padding: 8px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #1a1a1a; font-size: 0.9rem;" onkeydown="if(event.key==='Enter'){searchAddress();}">
      </div>
      <div class="menu-group">
        <div id="additionalDays"></div>
      </div>
      <div class="menu-group">
        <button id="clearRouteBtn" class="toggle-btn" onclick="clearUserRoute()" style="display: none;">ê²½ë¡œ ì´ˆê¸°í™”</button>
      </div>
      <div class="menu-group">
        <button id="addScheduleBtn" class="toggle-btn" onclick="showAddScheduleDialog()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none;">
          + ì¼ì •ì¶”ê°€
        </button>
      </div>
      <div class="menu-group" style="position: relative; overflow: hidden;">
        <div id="budgetBtnContainer" style="display: flex; transition: transform 0.3s ease;">
          <button id="budgetBtn" class="toggle-btn" onclick="showBudgetDialog()" style="background: rgba(134, 239, 172, 0.6); color: #1a1a1a; border: none; font-weight: 600; min-width: 100%;">
            ê°€ê³„ë¶€
          </button>
          <button id="budgetViewBtn" class="toggle-btn" onclick="openBudgetTable()" style="background: rgba(59, 130, 246, 0.6); color: #1a1a1a; border: none; font-weight: 600; min-width: 100%;">
            ìƒì„¸ë³´ê¸°
          </button>
        </div>
      </div>
    </div>
    


    
    <script>
      // ì „ì—­ ë³€ìˆ˜ë“¤
      let map;
      let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      let currentLocationMarker = null; // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì „ì—­ ë³€ìˆ˜
      let geocoder = null; // ì£¼ì†Œ ë³€í™˜ìš© Geocoder
      let addressMarker = null; // ì£¼ì†Œ ê²€ìƒ‰ ë§ˆì»¤ (ê¸°ì¡´ í˜¸í™˜ì„±ìš©)
      let addressMarkers = []; // ì£¼ì†Œ ê²€ìƒ‰ ë§ˆì»¤ë“¤ (ì—¬ëŸ¬ ë§ˆì»¤ ì§€ì›)
      let currentInfoWindow = null; // í˜„ì¬ ì—´ë¦° ì •ë³´ì°½
      let addressSearchCandidates = []; // ì£¼ì†Œ ê²€ìƒ‰ í›„ë³´ë“¤
      
      // í•­ë¡œì™€ ë§ˆì»¤ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ë“¤
      let flightPath = null;
      let dottedPath = null;
      let planeMarker = null;
      let incheonMarker = null;
      let chitoseMarker = null;
      
      // ì‚¬ìš©ì ê²½ë¡œ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ë“¤
      let userRouteMarkers = []; // ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ìœ„ì¹˜ ë§ˆì»¤ë“¤ (ì„ì‹œ)
      let userRoutePath = null; // ì‚¬ìš©ì ê²½ë¡œ í´ë¦¬ë¼ì¸
      let userRouteDottedPath = null; // ì‚¬ìš©ì ê²½ë¡œ ì ì„  íš¨ê³¼
      let isRouteMode = false; // ê²½ë¡œ ìƒì„± ëª¨ë“œ
      
      // ë§ˆì»¤ìƒì„± ëª¨ë“œ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ë“¤
      let isMarkerMode = false; // ë§ˆì»¤ìƒì„± ëª¨ë“œ
      let customMarkers = []; // ì‚¬ìš©ìê°€ ìƒì„±í•œ ë§ˆì»¤ë“¤
      
      // ì €ì¥ëœ ì‚¬ìš©ì ê²½ë¡œë“¤
      let savedUserRoutes = []; // Firestoreê°€ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤. ë¡œì»¬ ë°±ì—… ì œê±°
      
      // ë§ˆì»¤ ì •ë³´ ì €ì¥ì†Œ (ì œëª©, ë‚´ìš©, ë§í¬)
      let markerInfoData = {}; // í˜•ì‹: { "markerGroupName-index": { title: "", content: "", link: "" } }
      
      // ê²½ë¡œ ì •ë³´ ì €ì¥ì†Œ (ë‚´ìš©, ë§í¬)
      let routeInfoData = {}; // í˜•ì‹: { routeId: { content: "", link: "" } }
      

      
      // ìµœì í™”ëœ DOM ìºì‹œ
      let cachedElements = {};
      function getElement(id) {
        if (!cachedElements[id]) {
          cachedElements[id] = document.getElementById(id);
        }
        return cachedElements[id];
      }
      
      // ìºì‹œ ë¬´íš¨í™” í•¨ìˆ˜ (ë™ì  ìš”ì†Œ ì¶”ê°€ ì‹œ ì‚¬ìš©)
      function invalidateCache(key) {
        if (key) {
          delete cachedElements[key];
        } else {
          cachedElements = {}; // ì „ì²´ ìºì‹œ í´ë¦¬ì–´
        }
      }
      
      // ëª¨ë°”ì¼ ìµœì í™” í•¨ìˆ˜
      function optimizeForMobile() {
        if (isMobile) {
          // ëª¨ë°”ì¼ì—ì„œ ë”ë¸”íƒ­ ì¤Œ ë°©ì§€
          let lastTouchEnd = 0;
          document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
              event.preventDefault();
            }
            lastTouchEnd = now;
          }, false);
          
          // ëª¨ë°”ì¼ì—ì„œ ì§€ë„ ì˜ì—­ì˜ í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™”
          const mapElement = document.getElementById('map');
          if (mapElement) {
            mapElement.addEventListener('touchstart', function(event) {
              // í•œ ì†ê°€ë½ í„°ì¹˜ë§Œ í—ˆìš©
              if (event.touches.length === 1) {
                event.stopPropagation();
              }
            }, { passive: true });
            
            mapElement.addEventListener('touchmove', function(event) {
              // í•œ ì†ê°€ë½ ë“œë˜ê·¸ í—ˆìš©
              if (event.touches.length === 1) {
                event.stopPropagation();
              }
            }, { passive: true });
            
            // ëª¨ë°”ì¼ì—ì„œ í•€ì¹˜ ì¤Œ ìµœì í™”
            mapElement.addEventListener('gesturestart', function(event) {
              event.preventDefault();
            }, { passive: false });
            
            mapElement.addEventListener('gesturechange', function(event) {
              event.preventDefault();
            }, { passive: false });
            
            mapElement.addEventListener('gestureend', function(event) {
              event.preventDefault();
            }, { passive: false });
          }
          
          // ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ ì„±ëŠ¥ ìµœì í™”
          document.addEventListener('touchmove', function(event) {
            if (event.target.closest('.info-content')) {
              event.stopPropagation();
            }
          }, { passive: true });
          
          // ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ í„°ì¹˜ í”¼ë“œë°± ìµœì í™” (ì¼ì • í•­ëª© ìŠ¤ì™€ì´í”„ ë²„íŠ¼ ì œì™¸)
          const buttons = document.querySelectorAll('button, .toggle-btn, .map-type-btn');
          buttons.forEach(button => {
            // ì¼ì • í•­ëª©ì˜ ìŠ¤ì™€ì´í”„ ë²„íŠ¼ì€ í„°ì¹˜ ì• ë‹ˆë©”ì´ì…˜ ì œì™¸
            const isScheduleSwipeBtn = button.closest('[data-item-type="schedule"]') && 
                                      (button.classList.contains('swipe-edit-btn') || button.classList.contains('swipe-delete-btn'));
            
            if (!isScheduleSwipeBtn) {
              button.addEventListener('touchstart', function() {
                this.style.transform = 'scale(0.95)';
              }, { passive: true });
              
              button.addEventListener('touchend', function() {
                this.style.transform = 'scale(1)';
              }, { passive: true });
            }
          });
        }
      }
      
      // URL í•´ì‹œì—ì„œ ë§µ ë·°(lat,lng,zoom) ë³µì›
      function parseMapViewFromUrl() {
        try {
          const hash = window.location.hash || '';
          if (!hash.startsWith('#')) return null;
          const params = new URLSearchParams(hash.slice(1));
          const lat = parseFloat(params.get('lat'));
          const lng = parseFloat(params.get('lng'));
          const z = parseInt(params.get('z'), 10);
          if (isFinite(lat) && isFinite(lng) && isFinite(z)) {
            return { center: { lat: lat, lng: lng }, zoom: z };
          }
          return null;
        } catch (e) { return null; }
      }
      
      // í˜„ì¬ ë§µ ë·°ë¥¼ URL í•´ì‹œì— ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ì‹œ ìœ ì§€)
      let _lastHashUpdateTs = 0;
      function updateMapViewInUrl(center, zoom) {
        try {
          const now = Date.now();
          if (now - _lastHashUpdateTs < 300) return; // ê³¼ë„í•œ ì—…ë°ì´íŠ¸ ë°©ì§€
          _lastHashUpdateTs = now;
          const lat = (center.lat || center.lat()).toFixed(6);
          const lng = (center.lng || center.lng()).toFixed(6);
          const z = zoom;
          const params = new URLSearchParams(window.location.hash.slice(1));
          params.set('lat', lat);
          params.set('lng', lng);
          params.set('z', z);
          const newHash = '#' + params.toString();
          if (newHash !== window.location.hash) {
            history.replaceState(null, '', newHash);
          }
        } catch (e) { /* noop */ }
      }
      
      // êµ¬ê¸€ë§µ ì´ˆê¸°í™” í•¨ìˆ˜
      function initMap() {
        // ëª¨ë°”ì¼ ìµœì í™” ì ìš©
        optimizeForMobile();
        
        // ì¸ì²œê³µí•­ê³¼ ì‚°ì¹˜í† ì„¸ê³µí•­ì˜ ì¢Œí‘œ
        const incheonAirport = { lat: 37.4602, lng: 126.4407 }; // ì¸ì²œê³µí•­
        const chitoseAirport = { lat: 42.7752, lng: 141.6928 }; // ì‚°ì¹˜í† ì„¸ê³µí•­
        
        // ë‘ ê³µí•­ ì‚¬ì´ì˜ ì¤‘ê°„ì  ê³„ì‚°
        const centerLat = (incheonAirport.lat + chitoseAirport.lat) / 2;
        const centerLng = (incheonAirport.lng + chitoseAirport.lng) / 2;
        let center = { lat: centerLat, lng: centerLng };
        
        // ëª¨ë°”ì¼ì—ì„œëŠ” ë” ë„“ì€ ë·°ë¥¼ ì œê³µ
        let zoom = isMobile ? 4 : 5;
        
        // URL í•´ì‹œì—ì„œ ë·° ë³µì› (ìˆìœ¼ë©´ ìš°ì„  ì ìš©)
        const savedView = parseMapViewFromUrl();
        if (savedView) {
          center = savedView.center;
          zoom = savedView.zoom;
        }
        
        // ì§€ë„ ìŠ¤íƒ€ì¼ - ì „ì—­ìœ¼ë¡œ ìŠ¹ê²© (ë¼ë²¨ on/offì— ê³µí†µ ì‚¬ìš©)
        window.mapStyle = [
          {
            featureType: 'all',
            elementType: 'labels',
            stylers: [{ visibility: 'on' }] // ë¼ë²¨ í‘œì‹œ
          },
          {
            featureType: 'road',
            elementType: 'geometry',
            stylers: [{ visibility: 'simplified' }] // ë„ë¡œ ë‹¨ìˆœí™”
          }
        ];
        window.hideLabelsStyle = [
          {
            featureType: 'all',
            elementType: 'labels',
            stylers: [{ visibility: 'off' }]
          },
          {
            featureType: 'all',
            elementType: 'labels.text',
            stylers: [{ visibility: 'off' }]
          },
          {
            featureType: 'all',
            elementType: 'labels.icon',
            stylers: [{ visibility: 'off' }]
          }
        ];
        
        // êµ¬ê¸€ ë§µ ê°ì²´ ìƒì„± ë° ì˜µì…˜ ì„¤ì • - ëª¨ë°”ì¼ ìµœì í™”
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: zoom,
          center: center,
          mapTypeControl: false,
          mapTypeControlOptions: {
            mapTypeIds: ['roadmap', 'satellite', 'hybrid'],
            style: google.maps.MapTypeControlStyle.VERTICAL_BAR,
            position: google.maps.ControlPosition.LEFT_TOP
          },
          // ëª¨ë°”ì¼ì—ì„œ ê¸°ë³¸ ì»¨íŠ¸ë¡¤ë“¤ ë¹„í™œì„±í™”
          fullscreenControl: false,
          streetViewControl: false,
          zoomControl: false,
          scaleControl: false,
          rotateControl: false,
          tilt: 0,
          // ëª¨ë°”ì¼ì—ì„œ í•œ ì†ê°€ë½ ë“œë˜ê·¸ í—ˆìš©
          gestureHandling: 'greedy',
          // ê¸°ë³¸: ë¼ë²¨ ìˆ¨ê¹€
          styles: window.hideLabelsStyle,
          // ëª¨ë°”ì¼ ì„±ëŠ¥ ìµœì í™”
          disableDefaultUI: true,
          clickableIcons: false,
          // ëª¨ë°”ì¼ì—ì„œ ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜
          animation: google.maps.Animation.NONE,
          // ëª¨ë°”ì¼ì—ì„œ ë°°í„°ë¦¬ ì ˆì•½
          backgroundColor: '#f5f5f5'
        });
        
        // ë§µ ì´ë™/ì¤Œ ë³€ê²½ ì‹œ URLì— í˜„ì¬ ë·° ì €ì¥
        map.addListener('idle', function() {
          try {
            const c = map.getCenter();
            const z = map.getZoom();
            updateMapViewInUrl(c, z);
          } catch (e) {}
        });
        
        geocoder = new google.maps.Geocoder(); // Geocoder ê°ì²´ ìƒì„±
        
        // ê³µí•­ ì•„ì´ì½˜ ë§ˆì»¤ ì¶”ê°€ - ì´ëª¨ì§€ ì‚¬ìš©
        incheonMarker = new google.maps.Marker({
          position: incheonAirport,
          map: map,
          title: 'ì¸ì²œêµ­ì œê³µí•­',
          zIndex: 1000, // ê²½ë¡œì™€ ë¼ë²¨ ìœ„ì— í‘œì‹œ
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: 'transparent',
            fillOpacity: 0,
            strokeColor: 'transparent',
            strokeWeight: 0,
            scale: 0
          },
          label: {
            text: 'âœˆï¸',
            fontSize: '18px',
            fontWeight: 'bold'
          }
        });
        
        chitoseMarker = new google.maps.Marker({
          position: chitoseAirport,
          map: map,
          title: 'ì‹ ì¹˜í† ì„¸ê³µí•­',
          zIndex: 1000, // ê²½ë¡œì™€ ë¼ë²¨ ìœ„ì— í‘œì‹œ
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: 'transparent',
            fillOpacity: 0,
            strokeColor: 'transparent',
            strokeWeight: 0,
            scale: 0
          },
          label: {
            text: 'âœˆï¸',
            fontSize: '18px',
            fontWeight: 'bold'
          }
        });
        
        // ì¸ì²œê³µí•­ì—ì„œ ì‹ ì¹˜í† ì„¸ê³µí•­ê¹Œì§€ì˜ í•­ë¡œ (ì ì„ )
        flightPath = new google.maps.Polyline({
          path: [incheonAirport, chitoseAirport],
          geodesic: true,
          strokeColor: '#60a5fa',
          strokeOpacity: 0.6,
          strokeWeight: isMobile ? 4 : 3,
          zIndex: 10 // ë¼ë²¨ ì•„ë˜ì— í‘œì‹œ
        });
        
        flightPath.setMap(map);
        
        // ì ì„  íš¨ê³¼ë¥¼ ìœ„í•œ ì¶”ê°€ ì„  (ë” ì–‡ì€ ì„ ìœ¼ë¡œ ì ì„  íš¨ê³¼)
        dottedPath = new google.maps.Polyline({
          path: [incheonAirport, chitoseAirport],
          geodesic: true,
          strokeColor: '#ffffff',
          strokeOpacity: 0.5,
          strokeWeight: 1,
          zIndex: 15, // ë©”ì¸ í•­ë¡œë³´ë‹¤ëŠ” ìœ„ì—, ë¼ë²¨ë³´ë‹¤ëŠ” ì•„ë˜
          icons: [{
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              fillColor: '#60a5fa',
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 1,
              scale: isMobile ? 6 : 5
            },
            offset: '0',
            repeat: isMobile ? '12px' : '10px'
          }]
        });
        
        dottedPath.setMap(map);
        
        // í•­ë¡œ ì •ì¤‘ì•™ì— í•­ê³µê¶Œ ë§ˆì»¤ ì¶”ê°€ - ì´ë¯¸ì§€ ì¤‘ì‹¬ê³¼ í•­ë¡œ ì¤‘ì‹¬ ì¼ì¹˜
        const flightCenter = { lat: centerLat, lng: centerLng };
        const planeIconSize = isMobile ? 48 : 40;
        
        const planeIcon = {
          url: 'https://raw.githubusercontent.com/ppoppo1971/VMAP/refs/heads/main/%ED%95%AD%EA%B3%B5%EA%B6%8C.png',
          scaledSize: new google.maps.Size(planeIconSize, planeIconSize),
          // ì´ë¯¸ì§€ ì˜¤ë¥¸ìª½ í•˜ë‹¨ì„ ê¸°ì¤€ìœ¼ë¡œ ë§ˆì»¤ ìœ„ì¹˜ ì„¤ì •
          anchor: new google.maps.Point(planeIconSize, planeIconSize),
          // ì´ë¯¸ì§€ê°€ í•­ë¡œ ìœ„ì— ì •í™•íˆ ìœ„ì¹˜í•˜ë„ë¡ ì¡°ì •
          origin: new google.maps.Point(0, 0)
        };
        
        planeMarker = new google.maps.Marker({
          position: flightCenter,
          map: map,
          title: 'í•­ê³µê¶Œ ì •ë³´ - í´ë¦­í•˜ì—¬ ì „ìí•­ê³µê¶Œ í™•ì¸',
          zIndex: 1000, // ê²½ë¡œì™€ ë¼ë²¨ ìœ„ì— í‘œì‹œ
          icon: planeIcon,
          opacity: 1.0,
          // ë§ˆì»¤ê°€ í•­ë¡œ ìœ„ì— ì •í™•íˆ ìœ„ì¹˜í•˜ë„ë¡ ì„¤ì •
          optimized: false
        });
        
        // ë¹„í–‰ê¸° ë§ˆì»¤ í´ë¦­ ì‹œ PDF ë·°ì–´ ì—´ê¸°
        planeMarker.addListener('click', function() {
          openPdfViewer();
        });
        
        // ì§€ë„ í´ë¦­ ì‹œ ì‚¬ì´ë“œíŒ¨ë„ í† ê¸€ ê¸°ëŠ¥ ì¶”ê°€ - ëª¨ë°”ì¼ ìµœì í™”
        map.addListener('click', function(event) {
          // ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™”
          if (isMobile && event.placeId) {
            return; // ì¥ì†Œ í´ë¦­ ì‹œ ë¬´ì‹œ
          }
          
          // ë§ˆì»¤ìƒì„± ëª¨ë“œì¼ ë•ŒëŠ” ë§ˆì»¤ ìƒì„±
          if (isMarkerMode) {
            addCustomMarker(event.latLng);
            return;
          }
          
          // ê²½ë¡œ ìƒì„± ëª¨ë“œì¼ ë•ŒëŠ” ìœ„ì¹˜ ì¶”ê°€
          if (isRouteMode) {
            addUserRoutePoint(event.latLng);
            return;
          }
          
          // ê²½ë¡œíƒìƒ‰ ëª¨ë“œì¼ ë•ŒëŠ” ì¶œë°œì§€/ë„ì°©ì§€ ì„¤ì •
          if (isRouteSearchMode) {
            addRouteSearchPoint(event.latLng);
            return;
          }
          
          // ê²€ìƒ‰ ë§ˆì»¤ í´ë¦­ì´ ì•„ë‹Œ ê²½ìš°ë§Œ ì •ë³´ì°½ ë‹«ê¸°
          if (!window.searchMarkerClicked && currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }
          
                  // ì‚¬ìš©ì ìƒì„± ë§ˆì»¤ ì •ë³´ì°½ ë‹«ê¸°
        if (window.currentInfoWindow) {
          window.currentInfoWindow.close();
          window.currentInfoWindow = null;
        }
        
        // ì‚¬ì´ë“œíŒ¨ë„ í„°ì¹˜ ì´ë²¤íŠ¸ ì„¤ì •
        setupSidePanelTouchEvents();
          
          // ìŠ¤ì™€ì´í”„ ìƒíƒœ í•´ì œ, ì¼ì •ì°½ ë‹«ê¸° (ì‚¬ì´ë“œíŒ¨ë„ì€ ìœ ì§€)
          clearAllSwipeStates();
          closeScheduleInfo();
          
          // ì •ë³´ì°½ ë‹«ê¸° (X ë²„íŠ¼ì´ ì œê±°ë˜ì—ˆìœ¼ë¯€ë¡œ ì§€ë„ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°)
          if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }
          
          // ì‚¬ì´ë“œíŒ¨ë„ë§Œ ì—´ë ¤ìˆëŠ” ìƒíƒœì—ì„œ ì§€ë„ í´ë¦­ì‹œ ë‹«ê¸°
          const customMapMenu = getElement('customMapMenu');
          const preparationInfo = document.getElementById('preparationInfo');
          
          if (!customMapMenu.classList.contains('hide') && !preparationInfo) {
            hideMenu();
          }
          if (!getElement('mapTypeSelector').classList.contains('hide')) {
            hideRightMenu();
          }
          // ì‚¬ì „ì¤€ë¹„ ì •ë³´ì°½ë„ ë‹«ê¸°
          closePreparationInfo();
        });
        
        // ì˜¤ë¥¸ìª½ ìƒë‹¨ ë²„íŠ¼ ì´ˆê¸° ìƒíƒœ ì„¤ì •
        updateTopButtonStates('roadmap');
        
        // ì¤Œ ë ˆë²¨ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ - ëª¨ë°”ì¼ ìµœì í™”
        let zoomTimeout;
        map.addListener('zoom_changed', function() {
            // ë””ë°”ìš´ì‹±ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
            clearTimeout(zoomTimeout);
            zoomTimeout = setTimeout(function() {

                toggleFlightElements(map.getZoom()); // ì¤Œ ë ˆë²¨ì— ë”°ë¼ í•­ë¡œì™€ ë§ˆì»¤ í‘œì‹œ/ìˆ¨ê¹€
            }, 100);
        });
        
        // ì§€ë„ ì´ë™ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ - ì£¼ì†Œ ë§ˆì»¤ì™€ í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ìë™ ì œê±° (ëª¨ë°”ì¼ ìµœì í™”)
        let boundsTimeout;
        map.addListener('bounds_changed', function() {
            // ë””ë°”ìš´ì‹±ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
            clearTimeout(boundsTimeout);
            boundsTimeout = setTimeout(function() {
                checkAddressMarkerVisibility();
                checkCurrentLocationMarkerVisibility();
            }, 200);
        });
        
        // ì°½ í¬ê¸° ì¡°ì • ì‹œ ìŠ¤ì™€ì´í”„ ìƒíƒœ í•´ì œ, ì‚¬ì´ë“œíŒ¨ë„ ë‹«ê¸°, ê²€ìƒ‰ ë§ˆì»¤ ì œê±°
        let resizeTimeout;
        window.addEventListener('resize', function() {
            // ë””ë°”ìš´ì‹±ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                clearAllSwipeStates();
                closeSidePanel();
                clearAllAddressMarkers();
            }, 150);
        });
        
        // ì´ˆê¸° ì¤Œ ë ˆë²¨ í‘œì‹œ

        toggleFlightElements(map.getZoom()); // ì´ˆê¸° ì¤Œ ë ˆë²¨ì— ë”°ë¼ í•­ë¡œì™€ ë§ˆì»¤ í‘œì‹œ/ìˆ¨ê¹€
        
        // Firebase ì´ˆê¸°í™” ì™„ë£Œ í›„ ë™ê¸°í™” ì‹œì‘
        waitForFirebaseAndStartSync();
        
        // ì €ì¥ëœ ì‚¬ìš©ì ê²½ë¡œë“¤ ë³µì›
        restoreSavedUserRoutes().then(() => {
          // ê²½ë¡œì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
          updateRouteRemoveButtons();
          // ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
          updateMarkerRemoveButtons();
        });
        
        // ì €ì¥ëœ ì‚¬ìš©ì ë§ˆì»¤ë“¤ ë³µì›
        restoreSavedUserMarkers();
        
        // ì €ì¥ëœ ì‚¬ìš©ì ì •ì˜ ì¼ì •ë“¤ ë³µì›
        restoreCustomSchedules();
        

        
        // GeoJSON ìŠ¤íƒ€ì¼ ì„¤ì • - í•­ë¡œ ìŠ¤íƒ€ì¼ë¡œ ê°œì„ 
        map.data.setStyle(function(feature) {
          const geometryType = feature.getGeometry().getType();
          
          if (geometryType === 'LineString' || geometryType === 'MultiLineString') {
            // ì„ í˜• ì§€ì˜¤ë©”íŠ¸ë¦¬: í•­ë¡œ ìŠ¤íƒ€ì¼ ì ìš©
            return {
              strokeColor: '#60a5fa',
              strokeWeight: 3,
              strokeOpacity: 0.5,
              fillColor: 'transparent',
              fillOpacity: 0
            };
          } else if (geometryType === 'Point' || geometryType === 'MultiPoint') {
            // ì í˜• ì§€ì˜¤ë©”íŠ¸ë¦¬: ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì ìš©
            return {
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: '#1d4ed8',
                fillOpacity: 1,
                strokeColor: '#ffffff',
                strokeWeight: 2,
                scale: 6
              }
            };
          } else {
            // ë©´í˜• ì§€ì˜¤ë©”íŠ¸ë¦¬: ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì ìš©
            return {
              fillColor: '#1d4ed8',
              fillOpacity: 0.3,
              strokeColor: '#1d4ed8',
              strokeWeight: 2,
              strokeOpacity: 0.6
            };
          }
        });
      }
      
      function setMapType(type) {
        // ì§€ë„ íƒ€ì… ì„¤ì •
        if (map && map.setMapTypeId) {
          map.setMapTypeId(type);
        }
        
        // ì§€ë„ íƒ€ì…ì— ë”°ë¼ ë¼ë²¨ í‘œì‹œ ì—¬ë¶€ ì œì–´
        if (map && map.setOptions) {
          if (type === 'roadmap') {
            // ì¼ë°˜ì§€ë„: ê¸°ë³¸ ë¼ë²¨ OFF
            map.setOptions({ styles: window.hideLabelsStyle });
          } else if (type === 'satellite') {
            // ìœ„ì„±ì§€ë„: ê¸°ë³¸ ë¼ë²¨
            map.setOptions({ styles: [] });
          } else if (type === 'hybrid') {
            // í•˜ì´ë¸Œë¦¬ë“œ: ê¸°ë³¸ ë¼ë²¨ ON (ìœ„ì„±+ë¼ë²¨)
            map.setOptions({ styles: [] });
          }
        }
        
        // ì˜¤ë¥¸ìª½ ìƒë‹¨ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateTopButtonStates(type);
      }
      
      // ì˜¤ë¥¸ìª½ ìƒë‹¨ ë²„íŠ¼ì—ì„œ ì§€ë„ íƒ€ì… ì„¤ì •
      function setMapTypeFromTop(type) {
        if (map && map.setMapTypeId) {
          map.setMapTypeId(type);
        }
        
        // ì˜¤ë¥¸ìª½ ìƒë‹¨ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateTopButtonStates(type);
        
        // ì‚¬ì´ë“œíŒ¨ë„ê³¼ ë™ê¸°í™”
        syncSidePanelWithTop(type);
      }
      
      // ì˜¤ë¥¸ìª½ ìƒë‹¨ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateTopButtonStates(activeType) {
        const topButtons = {
          roadmap: getElement('topRoadmapBtn'),
          satellite: getElement('topSatelliteBtn'),
          hybrid: getElement('topHybridBtn')
        };
        
        // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
        Object.values(topButtons).forEach(btn => {
          if (btn) btn.classList.remove('active');
        });
        
        // í™œì„± íƒ€ì…ì— ë”°ë¼ ë²„íŠ¼ ìƒíƒœ ì„¤ì •
        const activationMap = {
          roadmap: ['roadmap'],
          satellite: ['satellite'],
          hybrid: ['satellite', 'hybrid']
        };
        
        activationMap[activeType]?.forEach(btnType => {
          if (topButtons[btnType]) {
            topButtons[btnType].classList.add('active');
          }
        });
        
        // í•˜ì´ë¸Œë¦¬ë“œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
        if (topButtons.hybrid) {
          topButtons.hybrid.textContent = 'ë¼ë²¨';
        }
      }
      
      // ì‚¬ì´ë“œíŒ¨ë„ê³¼ ì˜¤ë¥¸ìª½ ìƒë‹¨ ë²„íŠ¼ ë™ê¸°í™”
      function syncSidePanelWithTop(activeType) {
        const menuConfigs = {
          roadmap: { roadmap: { show: true, text: '-ì¼ë°˜' }, satellite: { show: false, text: '+ìœ„ì„±' } },
          satellite: { roadmap: { show: false, text: '+ì¼ë°˜' }, satellite: { show: true, text: '-ìœ„ì„±' } },
          hybrid: { roadmap: { show: false, text: '+ì¼ë°˜' }, satellite: { show: true, text: '-ìœ„ì„±' } }
        };
        
        const config = menuConfigs[activeType];
        if (!config) return;
        
        Object.entries(config).forEach(([menuType, settings]) => {
          const menu = getElement(`${menuType}Menu`);
          const btn = getElement(`${menuType}ToggleBtn`);
          if (menu && btn) {
            menu.style.display = settings.show ? 'block' : 'none';
            btn.textContent = settings.text;
          }
        });
      }
      
      // ìµœì í™”ëœ ë©”ë‰´ í† ê¸€ í•¨ìˆ˜
      function toggleMenu(menuId, btnId, menuName, subMenus = []) {
        const menu = getElement(menuId);
        const btn = getElement(btnId);
        const isHidden = menu.style.display === 'none';
        
        menu.style.display = isHidden ? 'block' : 'none';
        btn.textContent = isHidden ? `-${menuName}` : `+${menuName}`;
        
        if (!isHidden && subMenus.length) {
          subMenus.forEach(({menuId, btnId, btnText}) => {
            getElement(menuId).style.display = 'none';
            getElement(btnId).textContent = btnText;
          });
        }
      }
      
      // êµ¬ê¸€ë§µ ë©”ë‰´ í† ê¸€
      function toggleGoogleMapMenu() {
        toggleMenu('googleMapMenu', 'googleMapToggleBtn', 'êµ¬ê¸€ë§µ', [
          {menuId: 'roadmapMenu', btnId: 'roadmapToggleBtn', btnText: '+ì¼ë°˜'},
          {menuId: 'satelliteMenu', btnId: 'satelliteToggleBtn', btnText: '+ìœ„ì„±'}
        ]);
      }
      
      // +ì¼ë°˜ í´ë¦­ ì‹œ ë°”ë¡œ ì¼ë°˜ì§€ë„ë¥¼ ë¡œë“œí•˜ê³ , í•˜ìœ„ ë©”ë‰´ë§Œ í† ê¸€
      function toggleRoadmapMenuAndSetRoadmap() {
        const menu = document.getElementById('roadmapMenu');
        const btn = document.getElementById('roadmapToggleBtn');
        if(menu.style.display === 'none') {
          setMapType('roadmap');
          menu.style.display = 'block';
          btn.textContent = '-ì¼ë°˜';
        } else {
          menu.style.display = 'none';
          btn.textContent = '+ì¼ë°˜';
        }
      }
      
      // +ìœ„ì„± í´ë¦­ ì‹œ ë°”ë¡œ ìœ„ì„±ì§€ë„ë¥¼ ë¡œë“œí•˜ê³ , í•˜ìœ„ì— í•˜ì´ë¸Œë¦¬ë“œë§Œ ë³´ì´ë„ë¡
      function toggleSatelliteMenuAndSetSatellite() {
        const menu = document.getElementById('satelliteMenu');
        const btn = document.getElementById('satelliteToggleBtn');
        if(menu.style.display === 'none') {
          setMapType('satellite');
          menu.style.display = 'block';
          btn.textContent = '-ìœ„ì„±';
        } else {
          menu.style.display = 'none';
          btn.textContent = '+ìœ„ì„±';
        }
      }

      // ë¼ë²¨ ë²„íŠ¼ í† ê¸€ í•¨ìˆ˜
      function toggleHybridLabel() {
        const hybridBtn = document.getElementById('topHybridBtn');
        const currentMapType = map.getMapTypeId();
        
        // ê¸°ë³¸ OFF ê¸°ì¤€ìœ¼ë¡œ í† ê¸€: active = ë¼ë²¨ ON
        const willActivate = !hybridBtn.classList.contains('active');
        if (currentMapType === 'roadmap') {
          map.setOptions({ styles: willActivate ? window.mapStyle : window.hideLabelsStyle });
        } else if (currentMapType === 'satellite') {
          setMapType(willActivate ? 'hybrid' : 'satellite');
        } else if (currentMapType === 'hybrid') {
          if (!willActivate) setMapType('satellite');
        }
        hybridBtn.classList.toggle('active', willActivate);
        
        // ì‚¬ì´ë“œíŒ¨ë„ê³¼ ë™ê¸°í™”
        syncSidePanelWithTop(currentMapType);
      }
                    // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì €ì¥ í•¨ìˆ˜ (localStorage ì œê±° ë²„ì „)
       async function saveCheckboxStates() {
         // ë™ê¸°í™” ì¤‘ì´ë©´ ë¬´ì‹œ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
         if (isSyncing) {
           console.log('ë™ê¸°í™” ì¤‘ì´ë¯€ë¡œ ì²´í¬ë°•ìŠ¤ ì €ì¥ ê±´ë„ˆëœ€');
           return;
         }
         
         const checkboxes = cachedElements['prep-checkboxes'] || (cachedElements['prep-checkboxes'] = document.querySelectorAll('.prep-checkbox'));
         const states = {};
         checkboxes.forEach(checkbox => {
           states[checkbox.id] = checkbox.checked;
         });
         
         try {
           // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
           isSyncing = true;
           updateSyncStatus('ì²´í¬ë°•ìŠ¤ ì €ì¥ ì¤‘...', 'info');
           
           // Firebaseì— ì €ì¥
           await window.firestore.setDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
             preparationCheckboxes: states,
             lastUpdated: window.firestore.serverTimestamp()
           }, { merge: true });
           
           // ì‚¬ìš©ì ì¶”ê°€ í•­ëª©ì˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœë„ ì—…ë°ì´íŠ¸
           updateUserItemsCheckboxStates();
           
                     console.log('Firebaseì— ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì €ì¥ ì™„ë£Œ');
          onFirebaseUploadSuccess('ì²´í¬ë°•ìŠ¤');
           
         } catch (error) {
           console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', error);
           updateSyncStatus('ì €ì¥ ì‹¤íŒ¨', 'error');
           
           // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
           setTimeout(() => {
             updateSyncStatus('Firebase ì—°ê²° ì‹¤íŒ¨', 'error');
           }, 2000);
         } finally {
           // ë™ê¸°í™” ìƒíƒœ í•´ì œ (ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í—ˆìš©)
           isSyncing = false;
         }
       }
       
       // ì‚¬ìš©ì ì¶”ê°€ í•­ëª©ì˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (Firebase ì €ì¥ í¬í•¨)
       async function updateUserItemsCheckboxStates() {
         if (!window.firebaseUserItems) return;
         
         const currentSection = window.currentActiveSection || '';
         let hasChanges = false;
         
         const updatedItems = window.firebaseUserItems.map(item => {
           // í˜„ì¬ ì„¹ì…˜ì˜ í•­ëª©ë§Œ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
           if (item.section === currentSection) {
             const checkbox = document.getElementById(item.id);
             if (checkbox && item.checked !== checkbox.checked) {
               item.checked = checkbox.checked;
               hasChanges = true;
               console.log(`ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³€ê²½: ${item.id} -> ${checkbox.checked}`);
             }
           }
           return item;
         });
         
         // ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ Firebaseì— ì €ì¥
         if (hasChanges) {
           try {
             await window.firestore.setDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
               userAddedItems: updatedItems,
               lastUpdated: window.firestore.serverTimestamp()
             }, { merge: true });
             
             console.log('ì‚¬ìš©ì í•­ëª© ì²´í¬ë°•ìŠ¤ ìƒíƒœ Firebase ì €ì¥ ì™„ë£Œ');
           } catch (error) {
             console.error('ì‚¬ìš©ì í•­ëª© ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:', error);
           }
         }
         
         // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
         window.firebaseUserItems = updatedItems;
       }
       
             // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì› í•¨ìˆ˜ (localStorage ì œê±° ë²„ì „)
      async function restoreCheckboxStates() {
        try {
          const docSnap = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'));
          if (docSnap.exists()) {
            const data = docSnap.data();
            
            // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì› (í˜„ì¬ ì„¹ì…˜ì˜ í•­ëª©ë§Œ)
            if (data.preparationCheckboxes) {
              const currentSection = window.currentActiveSection || '';
              Object.keys(data.preparationCheckboxes).forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                  // í˜„ì¬ ì„¹ì…˜ì˜ í•­ëª©ì¸ì§€ í™•ì¸
                  const item = window.firebaseUserItems?.find(item => item.id === id);
                  if (item && item.section === currentSection) {
                    checkbox.checked = data.preparationCheckboxes[id];
                  }
                }
              });
            }
            
            // ì‚¬ìš©ì ì¶”ê°€ í•­ëª© ë³µì› - ì¦‰ì‹œ í‘œì‹œ
            if (data.userAddedItems && data.userAddedItems.length > 0) {
              // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥í•˜ê³  UI ì—…ë°ì´íŠ¸
              window.firebaseUserItems = data.userAddedItems;
              setTimeout(() => {
                displayUserAddedItemsFromFirebase(data.userAddedItems);
              }, 100);
            } else {
              window.firebaseUserItems = [];
              setTimeout(() => {
                displayUserAddedItemsFromFirebase([]);
              }, 100);
            }
            
            // ê²½ë¡œì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateRouteRemoveButtons();
            // ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateMarkerRemoveButtons();
            
            console.log('Firebaseì—ì„œ ìƒíƒœ ë³µì› ì™„ë£Œ');
            // ê¸°ì¡´ í•­ëª© ìˆ¨ê¹€/ì˜¤ë²„ë¼ì´ë“œ ìƒíƒœ ë³µì› (ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’)
            window.hiddenExistingItems = data.hiddenExistingItems || [];
            window.existingItemOverrides = data.existingItemOverrides || {};
            if (typeof applyOverridesAndHides === 'function') {
              setTimeout(() => applyOverridesAndHides(), 0);
            }
          } else {
            // Firebase ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°
            console.log('Firebase ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
            
            // UI ì´ˆê¸°í™”
            window.firebaseUserItems = [];
            displayUserAddedItemsFromFirebase([]);
            updateRouteRemoveButtons();
            updateMarkerRemoveButtons();
          }
          
        } catch (error) {
          console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', error);
          updateSyncStatus('Firebase ë¡œë“œ ì‹¤íŒ¨', 'error');
          
          // UI ì´ˆê¸°í™”
          window.firebaseUserItems = [];
          displayUserAddedItemsFromFirebase([]);
          updateRouteRemoveButtons();
          updateMarkerRemoveButtons();
        }
      }
       
       // ì‚¬ì „ì¤€ë¹„ ì •ë³´ì°½ í‘œì‹œ í•¨ìˆ˜ (ì œê±°ë¨ - ì¼ì •ì¶”ê°€ë¡œ ëŒ€ì²´)
        // function showPreparationInfo() { ... }
      
      // ì‚¬ì „ì¤€ë¹„ ì •ë³´ì°½ ë‹«ê¸° í•¨ìˆ˜
      function closePreparationInfo() {
        const infoDiv = document.getElementById('preparationInfo');
        if (infoDiv) {
          infoDiv.remove();
        }
      }
      
      // 1ì¼ì°¨ ì •ë³´ì°½ í‘œì‹œ í•¨ìˆ˜ (ì œê±°ë¨ - ì¼ì •ì¶”ê°€ë¡œ ëŒ€ì²´)
      // function showDay1Info() { ... }
      

      


      // ê¸°ì¡´ í•­ëª© ìˆ¨ê¹€/ì˜¤ë²„ë¼ì´ë“œ ì ìš© í•¨ìˆ˜
      function applyOverridesAndHides() {
        try {
          const hidden = Array.isArray(window.hiddenExistingItems) ? window.hiddenExistingItems : [];
          const overrides = window.existingItemOverrides || {};
          document.querySelectorAll('.checklist-item[data-item-type="existing"]').forEach(el => {
            const id = el.getAttribute('data-item-id');
            // ìˆ¨ê¹€ ì ìš©
            if (hidden.includes(id)) {
              el.style.display = 'none';
              return;
            } else {
              el.style.display = '';
            }
            // ì œëª©/ë§í¬ ì˜¤ë²„ë¼ì´ë“œ ì ìš©
            if (overrides[id]) {
              const span = el.querySelector('.item-content span');
              if (span) {
                const { title, link } = overrides[id];
                if (link) {
                  span.innerHTML = `<span onclick="openUserItemLink('${link}')" style="cursor: pointer;">${title}</span>`;
                } else {
                  span.textContent = title;
                }
              }
            }
          });
        } catch (e) {
          console.error('applyOverridesAndHides ì‹¤íŒ¨:', e);
        }
      }
      
      // ì‚¬ì´ë“œ íŒ¨ë„ í† ê¸€ í•¨ìˆ˜
      function hideMenu() {
        getElement('customMapMenu').classList.add('hide');
        getElement('menuToggleBtn').classList.add('show');
      }
      
      function showMenu() {
        getElement('customMapMenu').classList.remove('hide');
        getElement('menuToggleBtn').classList.remove('show');
      }

      // ì˜¤ë¥¸ìª½ ë©”ë‰´ í† ê¸€ í•¨ìˆ˜
      function toggleRightMenu() {
        const mapTypeSelector = document.getElementById('mapTypeSelector');
        const rightMenuToggleBtn = document.getElementById('rightMenuToggleBtn');
        const isHidden = mapTypeSelector.classList.contains('hide');
        
        if (isHidden) {
          // ë©”ë‰´ë¥¼ ë³´ì—¬ì¤„ ë•Œ
          mapTypeSelector.classList.remove('hide');
          rightMenuToggleBtn.style.display = 'none'; // í† ê¸€ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        } else {
          // ë©”ë‰´ë¥¼ ìˆ¨ê¸¸ ë•Œ
          mapTypeSelector.classList.add('hide');
          rightMenuToggleBtn.style.display = 'flex'; // í† ê¸€ ë²„íŠ¼ ë³´ì´ê¸°
        }
      }
      
      // ì˜¤ë¥¸ìª½ ë©”ë‰´ ìˆ¨ê¸°ê¸° í•¨ìˆ˜
      function hideRightMenu() {
        getElement('mapTypeSelector').classList.add('hide');
        getElement('rightMenuToggleBtn').style.display = 'flex'; // í† ê¸€ ë²„íŠ¼ ë³´ì´ê¸°
      }
      
      // PDF íŒŒì¼ ì§ì ‘ ì—´ê¸° í•¨ìˆ˜
      function openPdfViewer() {
        // PDF íŒŒì¼ URL
        const pdfUrl = 'https://ppoppo1971.github.io/VMAP/%EC%A0%84%EC%9E%90%ED%95%AD%EA%B3%B5%EA%B6%8C.pdf';
        
        // í˜„ì¬ íƒ­ì—ì„œ PDF ì—´ê¸°
        try {
          window.location.href = pdfUrl;
        } catch (error) {
          console.error('PDF ì—´ê¸° ì‹¤íŒ¨:', error);
          alert('PDF íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ë§í¬ë¥¼ ë³µì‚¬í•˜ì—¬ ì‚¬ìš©í•´ì£¼ì„¸ìš”: ' + pdfUrl);
        }
      }
      
      
      

      
             // ìƒˆ í•­ëª© ì¶”ê°€ í•¨ìˆ˜ (localStorage ì œê±° ë²„ì „)
       async function addNewItem() {
         const titleInput = document.getElementById('newItemTitle');
         const linkInput = document.getElementById('newItemLink');
         
         const title = titleInput.value.trim();
         const link = linkInput.value.trim();
         
         if (!title) {
           updateSyncStatus('í•­ëª© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
           titleInput.focus();
           return;
         }
         
         // ë™ê¸°í™” ì¤‘ì´ë©´ ë¬´ì‹œ
         if (isSyncing) {
           updateSyncStatus('ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'warning');
           return;
         }
         
         // í˜„ì¬ í™œì„± ì„¹ì…˜ í™•ì¸
         const activeSection = window.currentActiveSection || '';
         
         // ìƒˆ í•­ëª© ìƒì„± (ê¸°ì¡´ í•­ëª©ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼)
         const newItem = {
           id: 'user_' + Date.now(),
           title: title,
           description: '', // ë¹ˆ ì„¤ëª…ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ê¸°ì¡´ í•­ëª©ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼ ìœ ì§€
           link: link || null,
           checked: false,
           timestamp: new Date().toISOString(),
           section: activeSection // ì„¹ì…˜ ì •ë³´ ì¶”ê°€
         };
         
         try {
           // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
           isSyncing = true;
           updateSyncStatus('ìƒˆ í•­ëª© ì €ì¥ ì¤‘...', 'info');
           
           // Firebaseì— ì €ì¥
           await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
             userAddedItems: window.firestore.arrayUnion(newItem)
           });
           
           // ì „ì—­ ë³€ìˆ˜ëŠ” Firebase ë™ê¸°í™”ë¥¼ í†µí•´ ì—…ë°ì´íŠ¸ë¨
           // UI ì—…ë°ì´íŠ¸ëŠ” Firebase onSnapshot ë¦¬ìŠ¤ë„ˆì—ì„œ ì²˜ë¦¬
           
           // í¼ ì´ˆê¸°í™”
           clearForm();
           
                     // ì„±ê³µ ë©”ì‹œì§€ (UI ì—…ë°ì´íŠ¸ëŠ” Firebase ë™ê¸°í™”ë¡œ ì²˜ë¦¬)
          onFirebaseUploadSuccess('ìƒˆ í•­ëª©');
           
           // í•­ëª© ì¶”ê°€ í›„ í¼ ìë™ ìˆ¨ê¸°ê¸°
           hideAddForm();
           
           console.log('Firebaseì— ìƒˆ í•­ëª© ì €ì¥ ì™„ë£Œ - ì‹¤ì‹œê°„ ë™ê¸°í™”ë¡œ UI ì—…ë°ì´íŠ¸');
           
         } catch (error) {
           console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', error);
           
           // ì‹¤ì œ Firebase ì˜¤ë¥˜ì¸ì§€ í™•ì¸
           if (error.code && error.code !== 'permission-denied') {
             updateSyncStatus('í•­ëª© ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
             
             // í¼ ì´ˆê¸°í™” ë° ìˆ¨ê¸°ê¸°
             clearForm();
             hideAddForm();
             
             updateSyncStatus('ì €ì¥ ì‹¤íŒ¨ - ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'error');
           } else {
             // ê¶Œí•œ ì˜¤ë¥˜ì´ê±°ë‚˜ ì¼ì‹œì  ì˜¤ë¥˜ì¸ ê²½ìš° ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
             console.log('ì¼ì‹œì  ì˜¤ë¥˜ ë˜ëŠ” ê¶Œí•œ ë¬¸ì œ, ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬');
             onFirebaseUploadSuccess('ìƒˆ í•­ëª©');
             
             // í¼ ì´ˆê¸°í™” ë° ìˆ¨ê¸°ê¸°
             clearForm();
             hideAddForm();
           }
         } finally {
           // ë™ê¸°í™” ìƒíƒœ í•´ì œ (ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í—ˆìš©)
           isSyncing = false;
         }
       }
      
      // í¼ ì§€ìš°ê¸° í•¨ìˆ˜
      function clearForm() {
        document.getElementById('newItemTitle').value = '';
        document.getElementById('newItemLink').value = '';
        document.getElementById('newItemTitle').focus();
      }
      
      // ì‚¬ìš©ì ì¶”ê°€ í•­ëª©ë“¤ í‘œì‹œ í•¨ìˆ˜ (localStorage ì œê±° - Firebase ì „ìš©)
      function displayUserAddedItems() {
        // ì´ í•¨ìˆ˜ëŠ” í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€í•˜ì§€ë§Œ, 
        // ì‹¤ì œë¡œëŠ” displayUserAddedItemsFromFirebaseë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤
        const userItems = window.firebaseUserItems || [];
        displayUserAddedItemsFromFirebase(userItems);
      }
      

      // ëª¨ë“  ìŠ¤ì™€ì´í”„ ìƒíƒœë¥¼ í•´ì œí•˜ëŠ” ê³µí†µ í•¨ìˆ˜
      function clearAllSwipeStates() {
        // ì‚¬ìš©ì ì¶”ê°€ í•­ëª©ë“¤ì˜ ìŠ¤ì™€ì´í”„ ìƒíƒœ í•´ì œ
        const userItems = document.querySelectorAll('.user-added-item.swiped');
        userItems.forEach(item => {
          item.classList.remove('swiped');
          const itemContent = item.querySelector('.item-content');
          if (itemContent) {
            itemContent.style.transform = 'translateX(0)';
          }
        });
        
        // ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª©ë“¤ì˜ ìŠ¤ì™€ì´í”„ ìƒíƒœ í•´ì œ
        const checklistItems = document.querySelectorAll('.checklist-item.swiped');
        checklistItems.forEach(item => {
          item.classList.remove('swiped');
          const itemContent = item.querySelector('.item-content');
          if (itemContent) {
            itemContent.style.transform = 'translateX(0)';
          }
        });
      }

      // ì‚¬ì´ë“œíŒ¨ë„ì„ ë‹«ëŠ” í•¨ìˆ˜
      function closeSidePanel() {
        const customMapMenu = document.getElementById('customMapMenu');
        if (customMapMenu && !customMapMenu.classList.contains('hide')) {
          hideMenu();
        }
      }
      
      // ì¼ì •ì°½ë§Œ ë‹«ëŠ” í•¨ìˆ˜
      function closeScheduleInfo() {
        const existingInfo = document.getElementById('preparationInfo');
        if (existingInfo) {
          existingInfo.remove();
        }
      }
      
      // ì‚¬ì´ë“œíŒ¨ë„ í„°ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ìŠ¤ì™€ì´í”„ ìƒíƒœ í•´ì œìš©)
      function setupSidePanelTouchEvents() {
        const customMapMenu = document.getElementById('customMapMenu');
        if (customMapMenu) {
          customMapMenu.addEventListener('touchstart', function(e) {
            // ìŠ¤ì™€ì´í”„ ë²„íŠ¼ì´ë‚˜ ì¼ì • ë²„íŠ¼ì„ í„°ì¹˜í•œ ê²½ìš°ê°€ ì•„ë‹ˆë©´ ìŠ¤ì™€ì´í”„ ìƒíƒœ í•´ì œ
            if (!e.target.classList.contains('swipe-edit-btn') &&
                !e.target.classList.contains('swipe-delete-btn') &&
                !e.target.classList.contains('toggle-btn') &&
                !e.target.closest('.user-added-item')) {
              clearAllSwipeStates();
            }
          });
        }
      }
      
      // ì‚¬ìš©ì ì¶”ê°€ í•­ëª© ì‚­ì œ í•¨ìˆ˜ (localStorage ì œê±° ë²„ì „)
      async function deleteUserItem(itemId) {
        if (!confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
        
        // ìŠ¤ì™€ì´í”„ ìƒíƒœ í•´ì œ
        const item = document.querySelector(`[data-item-id="${itemId}"]`);
        if (item) {
          item.classList.remove('swiped');
          const itemContent = item.querySelector('.item-content');
          if (itemContent) {
            itemContent.style.transform = 'translateX(0)';
          }
        }
        
        // ë™ê¸°í™” ì¤‘ì´ë©´ ë¬´ì‹œ
        if (isSyncing) {
          updateSyncStatus('ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'warning');
          return;
        }
        
        try {
          // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
          isSyncing = true;
          updateSyncStatus('í•­ëª© ì‚­ì œ ì¤‘...', 'info');
          
          // í˜„ì¬ Firebase í•­ëª©ë“¤ì—ì„œ í•´ë‹¹ í•­ëª© ì œê±°
          const currentItems = window.firebaseUserItems || [];
          const currentSection = window.currentActiveSection || '';
          
          // í˜„ì¬ ì„¹ì…˜ì˜ í•­ëª©ì¸ì§€ í™•ì¸
          const itemToDelete = currentItems.find(item => item.id === itemId);
          if (!itemToDelete || itemToDelete.section !== currentSection) {
            updateSyncStatus('í•´ë‹¹ ì„¹ì…˜ì˜ í•­ëª©ì´ ì•„ë‹™ë‹ˆë‹¤', 'error');
            return;
          }
          
          const updatedUserItems = currentItems.filter(item => item.id !== itemId);
          
          // Firebaseì—ì„œ í•­ëª© ì œê±°
          await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
            userAddedItems: updatedUserItems,
            lastUpdated: window.firestore.serverTimestamp()
          });
          
          // Firebaseì—ì„œ í•´ë‹¹ í•­ëª©ì˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœë„ ì œê±°
          const docSnap = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'));
          if (docSnap.exists() && docSnap.data().preparationCheckboxes) {
            const currentCheckboxStates = { ...docSnap.data().preparationCheckboxes };
            delete currentCheckboxStates[itemId];
            await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
              preparationCheckboxes: currentCheckboxStates,
              lastUpdated: window.firestore.serverTimestamp()
            });
          }
          
          // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
          window.firebaseUserItems = updatedUserItems;
          
          // í™”ë©´ì—ì„œ í•­ëª© ì œê±°
          displayUserAddedItemsFromFirebase(updatedUserItems);
          
          // ê²½ë¡œì œê±°/ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
          updateRouteRemoveButtons();
          
          onFirebaseUploadSuccess('í•­ëª© ì‚­ì œ');
          console.log('Firebaseì—ì„œ í•­ëª© ì‚­ì œ ì™„ë£Œ');
          
                 } catch (error) {
           console.error('Firebase ì‚­ì œ ì‹¤íŒ¨:', error);
           updateSyncStatus('ì‚­ì œ ì‹¤íŒ¨', 'error');
           
           // Firebase ì‹¤íŒ¨ ì‹œ UIë§Œ ì—…ë°ì´íŠ¸
           const currentItems = window.firebaseUserItems || [];
           const currentSection = window.currentActiveSection || '';
           
           // í˜„ì¬ ì„¹ì…˜ì˜ í•­ëª©ì¸ì§€ í™•ì¸
           const itemToDelete = currentItems.find(item => item.id === itemId);
           if (itemToDelete && itemToDelete.section === currentSection) {
             const updatedUserItems = currentItems.filter(item => item.id !== itemId);
             window.firebaseUserItems = updatedUserItems;
             displayUserAddedItemsFromFirebase(updatedUserItems);
           }
           
           // ê²½ë¡œì œê±°/ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
           updateRouteRemoveButtons();
           
           setTimeout(() => {
             updateSyncStatus('Firebase ì—°ê²° ì‹¤íŒ¨', 'error');
           }, 2000);
         } finally {
           // ë™ê¸°í™” ìƒíƒœ í•´ì œ (ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í—ˆìš©)
           isSyncing = false;
         }
      }
      
             // ì‚¬ìš©ì í•­ëª© ìˆ˜ì • í•¨ìˆ˜
      function editUserItem(itemId, currentTitle, currentDescription, currentLink) {
        // ìŠ¤ì™€ì´í”„ ìƒíƒœ í•´ì œ
        const item = document.querySelector(`[data-item-id="${itemId}"]`);
        if (item) {
          item.classList.remove('swiped');
          const itemContent = item.querySelector('.item-content');
          if (itemContent) {
            itemContent.style.transform = 'translateX(0)';
          }
        }
        
        // ìˆ˜ì • í¼ í‘œì‹œ
        showEditForm(itemId, currentTitle, currentDescription, currentLink, 'user');
      }
      
      // ê¸°ì¡´ í•­ëª© ìˆ˜ì • í•¨ìˆ˜
      function editExistingItem(itemId, currentTitle, currentDescription, currentLink) {
        // ìˆ˜ì • í¼ í‘œì‹œ
        showEditForm(itemId, currentTitle, currentDescription, currentLink, 'existing');
      }
      
      // ê¸°ì¡´ í•­ëª© ì‚­ì œ í•¨ìˆ˜
      function deleteExistingItem(itemId) {
        if (!confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
        
        // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì œê±°
        const checkbox = document.getElementById(itemId);
        if (checkbox) {
          checkbox.remove();
        }
        
        // í•­ëª© ì œê±°
        const itemElement = cachedElements[`item_${itemId}`] || document.querySelector(`[data-item-id="${itemId}"]`);
        if (itemElement) {
          itemElement.remove();
        }
        
        // ìˆ¨ê¹€ ëª©ë¡ì— ë°˜ì˜ ë° Firebase ì €ì¥
        (async () => {
          try {
            window.hiddenExistingItems = Array.isArray(window.hiddenExistingItems) ? window.hiddenExistingItems : [];
            if (!window.hiddenExistingItems.includes(itemId)) {
              window.hiddenExistingItems.push(itemId);
            }
            // ì¦‰ì‹œ UI ë°˜ì˜
            if (typeof applyOverridesAndHides === 'function') {
              applyOverridesAndHides();
            }
            // ì²´í¬ë°•ìŠ¤ ìƒíƒœë„ ë™ê¸° ì €ì¥
            saveCheckboxStates();
            // Firebase ì €ì¥
            await window.firestore.setDoc(
              window.firestore.doc(window.db, 'users', 'currentUser'),
              { hiddenExistingItems: window.firestore.arrayUnion(itemId), lastUpdated: window.firestore.serverTimestamp() },
              { merge: true }
            );
            updateSyncStatus('í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          } catch (e) {
            console.error('í•­ëª© ì‚­ì œ ë™ê¸°í™” ì‹¤íŒ¨:', e);
            updateSyncStatus('ì‚­ì œëŠ” ë¡œì»¬ì—ë§Œ ë°˜ì˜ë¨', 'warning');
          }
        })();
      }
      
      // ìˆ˜ì • í¼ í‘œì‹œ í•¨ìˆ˜ - ì¼ì • ìˆ˜ì • ë‹¤ì´ì–¼ë¡œê·¸ ìŠ¤íƒ€ì¼ ì ìš©
      function showEditForm(itemId, currentTitle, currentDescription, currentLink, itemType) {
        // ê¸°ì¡´ ìˆ˜ì • í¼ì´ ìˆìœ¼ë©´ ì œê±°
        const existingForm = document.getElementById('editItemForm');
        if (existingForm) {
          existingForm.remove();
        }
        
        // ìˆ˜ì • í¼ ìƒì„± - ì¼ì • ìˆ˜ì • ë‹¤ì´ì–¼ë¡œê·¸ì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼
        const editForm = document.createElement('div');
        editForm.id = 'editItemForm';
        editForm.style.cssText = `
          position: fixed;
          top: 120px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 1000;
          width: 400px;
          max-width: 90vw;
          background: rgba(255, 255, 255, 0.2);
          border: 1px solid rgba(255, 255, 255, 0.12);
          border-radius: 20px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.12);
          backdrop-filter: blur(24px);
          -webkit-backdrop-filter: blur(24px);
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          overflow: hidden;
        `;
        
        editForm.innerHTML = `
          <div style="padding: 28px 24px 24px 24px;">
            <div style="text-align: center; margin-bottom: 24px;">
              <h3 style="color: #000; margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">í•­ëª© ìˆ˜ì •</h3>
            </div>
            <div style="margin-bottom: 16px;">
              <input type="text" id="editItemTitle" placeholder="í•­ëª© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="50" value="${currentTitle}"
                     style="width: 100%; padding: 16px 18px; border: none; border-radius: 12px; font-size: 15px; background: rgba(255, 255, 255, 0.12); color: #000; box-sizing: border-box; outline: none; transition: all 0.2s ease; backdrop-filter: blur(10px);" 
                     onfocus="this.style.background='rgba(255, 255, 255, 0.18)'"
                     onblur="this.style.background='rgba(255, 255, 255, 0.12)'">
            </div>
            <div style="margin-bottom: 24px;">
              <input type="url" id="editItemLink" placeholder="ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)" maxlength="200" value="${currentLink}"
                     style="width: 100%; padding: 16px 18px; border: none; border-radius: 12px; font-size: 15px; background: rgba(255, 255, 255, 0.12); color: #000; box-sizing: border-box; outline: none; transition: all 0.2s ease; backdrop-filter: blur(10px);" 
                     onfocus="this.style.background='rgba(255, 255, 255, 0.18)'"
                     onblur="this.style.background='rgba(255, 255, 255, 0.12)'">
            </div>
            <div style="display: flex; gap: 12px;">
              <button onclick="saveEditedItem('${itemId}', '${itemType}')" style="flex: 1; background: rgba(255, 255, 255, 0.12); color: #000; border: none; border-radius: 12px; padding: 14px 16px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255, 255, 255, 0.18)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'">
                ì €ì¥
              </button>
              <button onclick="closeEditForm()" style="flex: 1; background: rgba(255, 255, 255, 0.12); color: #000; border: none; border-radius: 12px; padding: 14px 16px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255, 255, 255, 0.18)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'">
                ì·¨ì†Œ
              </button>
            </div>
          </div>
        `;
        
        // í¼ì„ í™”ë©´ì— ì¶”ê°€
        document.body.appendChild(editForm);
        
        // ì œëª© ì…ë ¥ë€ì— í¬ì»¤ìŠ¤
        setTimeout(() => {
          document.getElementById('editItemTitle').focus();
        }, 100);
      }
      
      // ìˆ˜ì • í¼ ë‹«ê¸° í•¨ìˆ˜
      function closeEditForm() {
        const editForm = document.getElementById('editItemForm');
        if (editForm) {
          editForm.remove();
        }
      }
      
      // ìˆ˜ì •ëœ í•­ëª© ì €ì¥ í•¨ìˆ˜
      async function saveEditedItem(itemId, itemType) {
        const titleInput = document.getElementById('editItemTitle');
        const linkInput = document.getElementById('editItemLink');
        
        const title = titleInput.value.trim();
        const link = linkInput.value.trim();
        
        if (!title) {
          updateSyncStatus('í•­ëª© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
          titleInput.focus();
          return;
        }
        
        if (itemType === 'user') {
          // ì‚¬ìš©ì ì¶”ê°€ í•­ëª© ìˆ˜ì •
          await updateUserItem(itemId, title, link);
        } else {
          // ê¸°ì¡´ í•­ëª© ìˆ˜ì •: ì˜¤ë²„ë¼ì´ë“œ ì €ì¥
          await updateExistingItem(itemId, title, link);
          // ì˜¤ë²„ë¼ì´ë“œ ì •ë³´ Firebase ì €ì¥ ë° ì¦‰ì‹œ ì ìš©
          try {
            window.existingItemOverrides = window.existingItemOverrides || {};
            window.existingItemOverrides[itemId] = { title, link };
            if (typeof applyOverridesAndHides === 'function') {
              applyOverridesAndHides();
            }
            await window.firestore.setDoc(
              window.firestore.doc(window.db, 'users', 'currentUser'),
              { existingItemOverrides: { [itemId]: { title, link } }, lastUpdated: window.firestore.serverTimestamp() },
              { merge: true }
            );
          } catch (e) {
            console.error('ì˜¤ë²„ë¼ì´ë“œ ì €ì¥ ì‹¤íŒ¨:', e);
          }
        }
        
        // ìˆ˜ì • í¼ ë‹«ê¸°
        closeEditForm();
      }
      
      // ì‚¬ìš©ì í•­ëª© ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      async function updateUserItem(itemId, title, link) {
        try {
          // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
          isSyncing = true;
          updateSyncStatus('í•­ëª© ìˆ˜ì • ì¤‘...', 'info');
          
          // í˜„ì¬ í•­ëª© ì°¾ê¸°
          const currentItems = window.firebaseUserItems || [];
          const currentSection = window.currentActiveSection || '';
          const itemIndex = currentItems.findIndex(item => item.id === itemId);
          
          if (itemIndex === -1) {
            updateSyncStatus('í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            return;
          }
          
          // í˜„ì¬ ì„¹ì…˜ì˜ í•­ëª©ì¸ì§€ í™•ì¸
          if (currentItems[itemIndex].section !== currentSection) {
            updateSyncStatus('í•´ë‹¹ ì„¹ì…˜ì˜ í•­ëª©ì´ ì•„ë‹™ë‹ˆë‹¤', 'error');
            return;
          }
          
          // í•­ëª© ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì†ì„± ëª¨ë‘ ìœ ì§€)
          const updatedItem = {
            ...currentItems[itemIndex],
            title: title,
            link: link || null,
            timestamp: new Date().toISOString(),
            section: currentItems[itemIndex].section, // ì„¹ì…˜ ì •ë³´ ìœ ì§€
            order: currentItems[itemIndex].order || 0, // ìˆœì„œ ì •ë³´ ìœ ì§€
            checked: currentItems[itemIndex].checked || false // ì²´í¬ ìƒíƒœ ìœ ì§€
          };
          
          currentItems[itemIndex] = updatedItem;
          
          // Firebaseì— ì €ì¥
          console.log('ì‚¬ìš©ì í•­ëª© ìˆ˜ì • - Firebase ì €ì¥ ì‹œë„:', {
            itemId,
            title,
            link,
            updatedItem
          });
          
          await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
            userAddedItems: currentItems,
            lastUpdated: window.firestore.serverTimestamp()
          });
          
          console.log('ì‚¬ìš©ì í•­ëª© ìˆ˜ì • - Firebase ì €ì¥ ì™„ë£Œ');
          
          // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
          window.firebaseUserItems = currentItems;
          
          // UI ì—…ë°ì´íŠ¸
          displayUserAddedItemsFromFirebase(currentItems);
          
          onFirebaseUploadSuccess('í•­ëª© ìˆ˜ì •');
          
        } catch (error) {
          console.error('Firebase ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
          updateSyncStatus('ìˆ˜ì • ì‹¤íŒ¨', 'error');
        } finally {
          isSyncing = false;
        }
      }
      
      // ê¸°ì¡´ í•­ëª© ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      async function updateExistingItem(itemId, title, link) {
        try {
          // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
          isSyncing = true;
          updateSyncStatus('í•­ëª© ìˆ˜ì • ì¤‘...', 'info');
          
          // HTML ìš”ì†Œ ì—…ë°ì´íŠ¸
          const itemElement = cachedElements[`item_${itemId}`] || document.querySelector(`[data-item-id="${itemId}"]`);
          if (itemElement) {
            const titleSpan = itemElement.querySelector('span');
            if (titleSpan) {
              titleSpan.innerHTML = `${title} - ${link || ''}`;
            }
          }
          
          // Firebaseì— ì €ì¥ (ê¸°ì¡´ í•­ëª©ì€ ì²´í¬ë°•ìŠ¤ ìƒíƒœë§Œ ì €ì¥)
          await saveCheckboxStates();
          
          // ì˜¤ë²„ë¼ì´ë“œ ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸ (í™”ë©´ ì¬ì˜¤í”ˆ ì‹œ ë°˜ì˜)
          window.existingItemOverrides = window.existingItemOverrides || {};
          window.existingItemOverrides[itemId] = { title, link };
          
          onFirebaseUploadSuccess('ê¸°ì¡´ í•­ëª© ìˆ˜ì •');
          
        } catch (error) {
          console.error('í•­ëª© ìˆ˜ì • ì‹¤íŒ¨:', error);
          updateSyncStatus('ìˆ˜ì • ì‹¤íŒ¨', 'error');
        } finally {
          isSyncing = false;
        }
      }
      
      // ì‚¬ìš©ì í•­ëª© ë§í¬ ì—´ê¸° í•¨ìˆ˜ (í˜„ì¬ íƒ­ì—ì„œ ì—´ê¸°)
       function openUserItemLink(link) {
         if (!link) return;
         
         try {
           // í˜„ì¬ íƒ­ì—ì„œ ë§í¬ ì—´ê¸° (ë’¤ë¡œê°€ê¸°ë¡œ ëŒì•„ì˜¬ ìˆ˜ ìˆìŒ)
           window.location.href = link;
         } catch (error) {
           console.error('ë§í¬ ì—´ê¸° ì‹¤íŒ¨:', error);
           alert('ë§í¬ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ë§í¬ë¥¼ ë³µì‚¬í•˜ì—¬ ì‚¬ìš©í•´ì£¼ì„¸ìš”: ' + link);
         }
       }


       
               // ì¶”ê°€ í¼ í‘œì‹œ í•¨ìˆ˜
        function showAddForm() {
          const form = document.getElementById('addItemForm');
          const toggleBtn = document.getElementById('toggleAddBtn');
          
          // í¼ì„ ë³´ì—¬ì¤„ ë•Œ
          form.style.display = 'block';
          toggleBtn.style.display = 'none'; // ë²„íŠ¼ ìˆ¨ê¸°ê¸°
          
          // ì œëª© ì…ë ¥ë€ì— í¬ì»¤ìŠ¤
          setTimeout(() => {
            document.getElementById('newItemTitle').focus();
          }, 100);
        }
        
        // ì¶”ê°€ í¼ ìˆ¨ê¸°ê¸° í•¨ìˆ˜
        function hideAddForm() {
          const form = document.getElementById('addItemForm');
          const toggleBtn = document.getElementById('toggleAddBtn');
          
          // í¼ì„ ìˆ¨ê¸°ê³  ë²„íŠ¼ì„ ë‹¤ì‹œ í‘œì‹œ
          form.style.display = 'none';
          toggleBtn.style.display = 'block';
          
          // í¼ ë‚´ìš© ì´ˆê¸°í™”
          document.getElementById('newItemTitle').value = '';
          document.getElementById('newItemDescription').value = '';
          document.getElementById('newItemLink').value = '';
        }
      // í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ - ëª¨ë°”ì¼ ìµœì í™”
      function getCurrentLocation() {
        const locationBtn = document.getElementById('locationBtn');
        const isLoading = locationBtn.classList.contains('loading');

        if (isLoading) {
          alert('í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.');
          return;
        }

        // ê¸°ì¡´ ë§ˆì»¤ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì œê±°
        if (currentLocationMarker) {
          // ì—´ë¦° ì •ë³´ì°½ ë‹«ê¸°
          if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }
          currentLocationMarker.setMap(null);
          currentLocationMarker = null;
        }

        locationBtn.classList.add('loading');
        locationBtn.textContent = 'ë¡œë”©ì¤‘...';

        if (navigator.geolocation) {
          // ëª¨ë°”ì¼ì—ì„œ ìœ„ì¹˜ ì •í™•ë„ ìµœì í™”
          const options = {
            enableHighAccuracy: isMobile ? false : true, // ëª¨ë°”ì¼ì—ì„œëŠ” ë°°í„°ë¦¬ ì ˆì•½
            timeout: isMobile ? 10000 : 5000, // ëª¨ë°”ì¼ì—ì„œëŠ” ë” ê¸´ íƒ€ì„ì•„ì›ƒ
            maximumAge: isMobile ? 60000 : 0 // ëª¨ë°”ì¼ì—ì„œëŠ” 1ë¶„ê°„ ìºì‹œëœ ìœ„ì¹˜ í—ˆìš©
          };
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              const currentLocation = { lat: lat, lng: lng };
              
              // í˜„ì¬ ìœ„ì¹˜ ì¤‘ì‹¬ìœ¼ë¡œ í™•ëŒ€
              const currentZoom = map.getZoom();
              map.setCenter(currentLocation);
              map.setZoom(Math.max(currentZoom, 15)); // ìµœì†Œ ì¤Œ ë ˆë²¨ 15ë¡œ í™•ëŒ€

              // ìƒˆë¡œìš´ í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€ - ëª¨ë°”ì¼ ìµœì í™”
              currentLocationMarker = new google.maps.Marker({
                position: currentLocation,
                map: map,
                icon: {
                  url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32">
                      <text x="12" y="20" font-family="Arial, sans-serif" font-size="24" text-anchor="middle" fill="#FF0000">ğŸ“</text>
                    </svg>
                  `),
                  scaledSize: new google.maps.Size(isMobile ? 28 : 32, isMobile ? 28 : 32),
                  anchor: new google.maps.Point(isMobile ? 14 : 16, isMobile ? 14 : 16)
                },
                title: 'í˜„ì¬ ìœ„ì¹˜',
                zIndex: 1000, // ë‹¤ë¥¸ ë§ˆì»¤ë³´ë‹¤ ìœ„ì— í‘œì‹œ
                optimized: isMobile ? false : true // ëª¨ë°”ì¼ì—ì„œëŠ” ìµœì í™” ë¹„í™œì„±í™”ë¡œ ì„±ëŠ¥ í–¥ìƒ
              });

              // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ì°½ í‘œì‹œ ë° ì¤Œ ë ˆë²¨ 15ë¡œ ì¡°ì •
              currentLocationMarker.addListener('click', function() {
                try {
                  map.setZoom(15);
                  map.panTo(currentLocation);
                } catch (_) {}
              });

              locationBtn.classList.remove('loading');
              locationBtn.textContent = 'ğŸ“';
            },
            (error) => {
              console.error('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error.message);
              let errorMessage = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
              
              // ëª¨ë°”ì¼ì—ì„œ ë” ìì„¸í•œ ì˜¤ë¥˜ ë©”ì‹œì§€
              if (isMobile) {
                switch(error.code) {
                  case error.PERMISSION_DENIED:
                    errorMessage = 'ìœ„ì¹˜ ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                    break;
                  case error.POSITION_UNAVAILABLE:
                    errorMessage = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    break;
                  case error.TIMEOUT:
                    errorMessage = 'ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    break;
                }
              }
              
              alert(errorMessage);
              locationBtn.classList.remove('loading');
              locationBtn.textContent = 'ğŸ“';
            },
            options
          );
        } else {
          alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          locationBtn.classList.remove('loading');
          locationBtn.textContent = 'ğŸ“';
        }
      }
      
      // ì¤Œ ë ˆë²¨ì— ë”°ë¼ í•­ë¡œì™€ ë§ˆì»¤ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
      function toggleFlightElements(zoomLevel) {
        if (zoomLevel < 10) {
          // ì¤Œ ë ˆë²¨ 10 ë¯¸ë§Œ: í•­ë¡œì™€ ë§ˆì»¤ë“¤ í‘œì‹œ
          if (flightPath) flightPath.setMap(map);
          if (dottedPath) dottedPath.setMap(map);
          if (planeMarker) planeMarker.setMap(map);
          if (incheonMarker) incheonMarker.setMap(map);
          if (chitoseMarker) chitoseMarker.setMap(map);
        } else {
          // ì¤Œ ë ˆë²¨ 10 ì´ìƒ: í•­ë¡œì™€ ë§ˆì»¤ë“¤ ìˆ¨ê¹€
          if (flightPath) flightPath.setMap(null);
          if (dottedPath) dottedPath.setMap(null);
          if (planeMarker) planeMarker.setMap(null);
          if (incheonMarker) incheonMarker.setMap(null);
          if (chitoseMarker) chitoseMarker.setMap(null);
        }
      }
      

      

      

      
              
        

      

      

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë°”ì¼ ìµœì í™” ë° ë™ê¸°í™” ìƒíƒœ í™•ì¸
      document.addEventListener('DOMContentLoaded', function() {
        optimizeForMobile();
        
        // ë™ê¸°í™” ìƒíƒœ ì´ˆê¸°í™”
        initializeSyncSystem();
        
        // ê°€ê³„ë¶€ ìŠ¤ì™€ì´í”„ ê¸°ëŠ¥ ì´ˆê¸°í™”
        initBudgetSwipe();
        
        // ëª¨ë°”ì¼ì—ì„œ ì¶”ê°€ ìµœì í™”
        if (isMobile) {
          // ëª¨ë°”ì¼ì—ì„œ ë©”íƒ€ íƒœê·¸ ë™ì  ì„¤ì •
          const viewport = document.querySelector('meta[name="viewport"]');
          if (viewport) {
            viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
          }
          
          // ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™” (ì´ë¯¸ optimizeForMobileì—ì„œ ì²˜ë¦¬ë¨)
          
          // ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ ì„±ëŠ¥ ìµœì í™”
          document.body.style.webkitOverflowScrolling = 'touch';
          
          // ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ ì§€ì—° ì œê±°
          document.body.style.touchAction = 'manipulation';
          
          // ëª¨ë°”ì¼ì—ì„œ ë°°í„°ë¦¬ ì ˆì•½ì„ ìœ„í•œ ì• ë‹ˆë©”ì´ì…˜ ìµœì í™”
          if ('IntersectionObserver' in window) {
            // ë·°í¬íŠ¸ ë°–ì˜ ì• ë‹ˆë©”ì´ì…˜ì€ ì¼ì‹œì •ì§€ (ëª¨ë°”ì¼ ë°°í„°ë¦¬ ì ˆì•½)
            const observer = new IntersectionObserver((entries) => {
              entries.forEach(entry => {
                if (!entry.isIntersecting && entry.target.style.transform) {
                  entry.target.style.willChange = 'auto';
                } else {
                  entry.target.style.willChange = 'transform';
                }
              });
            });
            
            // ë³€í™˜ ìš”ì†Œë“¤ ê´€ì°°
            document.querySelectorAll('[style*="transform"]').forEach(el => {
              observer.observe(el);
            });
          }
        }
        
        // ëª¨ë°”ì¼ ìµœì í™” ì ìš© ì™„ë£Œ
      });
      
      // ë™ê¸°í™” ì‹œìŠ¤í…œ ì´ˆê¸°í™”
      function initializeSyncSystem() {
        // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
        window.addEventListener('online', function() {
          console.log('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨ - ë™ê¸°í™” ì¬ì‹œë„');
          updateSyncStatus('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨ - ë™ê¸°í™” ì¬ì‹œë„', 'info');
          
          // Firebase ë™ê¸°í™” ì¬ì„¤ì •
          if (window.unsubscribeFirebase) {
            window.unsubscribeFirebase();
          }
          setTimeout(() => {
            setupFirebaseSync();
          }, 1000);
        });
        
        // í˜ì´ì§€ ë³µê·€ ê°ì§€ ì„¤ì •
        setupPageVisibilityListener();
        
        window.addEventListener('offline', function() {
          console.log('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€ - ì˜¤í”„ë¼ì¸ ëª¨ë“œ');
          updateSyncStatus('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€ - ì˜¤í”„ë¼ì¸ ëª¨ë“œ', 'warning');
          enableOfflineMode();
        });
        
        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ë™ê¸°í™” ìƒíƒœ í™•ì¸
        document.addEventListener('visibilitychange', function() {
          if (!document.hidden && navigator.onLine) {
            console.log('í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ - ë™ê¸°í™” ìƒíƒœ í™•ì¸');
            updateSyncStatus('ë™ê¸°í™” ìƒíƒœ í™•ì¸ ì¤‘...', 'info');
            
            // Firebase ì—°ê²° ìƒíƒœ í™•ì¸
            setTimeout(() => {
              if (window.db) {
                updateSyncStatus('ë™ê¸°í™” ì—°ê²°ë¨', 'success');
              } else {
                updateSyncStatus('ë™ê¸°í™” ì—°ê²° ì‹¤íŒ¨', 'error');
              }
            }, 1000);
          }
        });
        
        // ì£¼ê¸°ì  ë™ê¸°í™” ìƒíƒœ í™•ì¸ (5ë¶„ë§ˆë‹¤)
        setInterval(() => {
          if (navigator.onLine && window.db && !isSyncing) {
            console.log('ì£¼ê¸°ì  ë™ê¸°í™” ìƒíƒœ í™•ì¸');
            updateSyncStatus('ë™ê¸°í™” ìƒíƒœ í™•ì¸ ì¤‘...', 'info');
            
            // ê°„ë‹¨í•œ ì—°ê²° í…ŒìŠ¤íŠ¸
            window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'))
              .then(() => {
                updateSyncStatus('ë™ê¸°í™” ì •ìƒ', 'success');
              })
              .catch(() => {
                updateSyncStatus('ë™ê¸°í™” ì—°ê²° ì‹¤íŒ¨', 'error');
                enableOfflineMode();
              });
          }
        }, 5 * 60 * 1000); // 5ë¶„
      }
      
      // ë§ˆì»¤ìƒì„± ëª¨ë“œ í† ê¸€ í•¨ìˆ˜
      function toggleMarkerMode() {
        console.log('toggleMarkerMode í˜¸ì¶œë¨, isMarkerMode:', isMarkerMode, 'customMarkers.length:', customMarkers.length);
        
        if (isMarkerMode) {
          console.log('ë§ˆì»¤ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìŒ');
          console.log('customMarkers ë°°ì—´:', customMarkers);
          console.log('customMarkers.length:', customMarkers.length);
          
          // ë²„íŠ¼ í…ìŠ¤íŠ¸ í™•ì¸
          const markerBtn = document.getElementById('topMarkerBtn');
          const buttonText = markerBtn.textContent;
          console.log('í˜„ì¬ ë²„íŠ¼ í…ìŠ¤íŠ¸:', buttonText);
          
          // ë§ˆì»¤ê°€ ìƒì„±ë˜ì–´ ìˆê³  "ë§ˆì»¤ì™„ì„±" ìƒíƒœë¼ë©´ ì €ì¥ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
          if (customMarkers.length > 0 || buttonText === 'ë§ˆì»¤ì™„ì„±') {
            console.log('ë§ˆì»¤ì™„ì„± ìƒíƒœ: showMarkerSaveDialog í˜¸ì¶œ');
            
            try {
              showMarkerSaveDialog();
              console.log('showMarkerSaveDialog í˜¸ì¶œ ì„±ê³µ');
            } catch (error) {
              console.error('showMarkerSaveDialog í˜¸ì¶œ ì‹¤íŒ¨:', error);
              // ëŒ€ì•ˆ: ì§ì ‘ ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
              createMarkerSaveDialogDirectly();
            }
            
            // ë§ˆì»¤ ëª¨ë“œ ë¹„í™œì„±í™”í•˜ì—¬ ë” ì´ìƒ ë§ˆì»¤ ìƒì„± ë°©ì§€
            isMarkerMode = false;
            markerBtn.textContent = 'ë§ˆì»¤ìƒì„±';
            markerBtn.style.background = 'rgba(255, 255, 255, 0.12)';
            markerBtn.style.color = '#1a1a1a';
            return;
          }
          
          // ë§ˆì»¤ìƒì„± ëª¨ë“œ ë¹„í™œì„±í™”
          isMarkerMode = false;
          markerBtn.textContent = 'ë§ˆì»¤ìƒì„±';
          markerBtn.style.background = 'rgba(255, 255, 255, 0.12)';
          markerBtn.style.color = '#1a1a1a';
          
          // ë§ˆì»¤ìƒì„± ëª¨ë“œ ì•ˆë‚´ ë©”ì‹œì§€ ì œê±°
          if (window.markerModeMessage) {
            window.markerModeMessage.remove();
            window.markerModeMessage = null;
          }
          
          console.log('ë§ˆì»¤ìƒì„± ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          // ê²½ë¡œ ìƒì„± ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë¹„í™œì„±í™”
          if (isRouteMode) {
            // ê²½ë¡œ ìƒì„± ëª¨ë“œ ë¹„í™œì„±í™”
            isRouteMode = false;
            const routeBtn = document.getElementById('topRouteBtn');
            routeBtn.textContent = 'ê²½ë¡œìƒì„±';
            routeBtn.style.background = 'rgba(255, 255, 255, 0.12)';
            routeBtn.style.color = '#1a1a1a';
            
            // ê²½ë¡œ ê´€ë ¨ ë§ˆì»¤ë“¤ ì œê±°
            userRouteMarkers.forEach(marker => marker.setMap(null));
            userRouteMarkers = [];
            
            // ê²½ë¡œ í´ë¦¬ë¼ì¸ ì œê±°
            if (userRoutePath) {
              userRoutePath.setMap(null);
              userRoutePath = null;
            }
            if (userRouteDottedPath) {
              userRouteDottedPath.setMap(null);
              userRouteDottedPath = null;
            }
          }
          
          // ê²½ë¡œíƒìƒ‰ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë¹„í™œì„±í™”
          if (isRouteSearchMode) {
            toggleRouteSearch();
          }
          
          // ë§ˆì»¤ìƒì„± ëª¨ë“œ í™œì„±í™”
          isMarkerMode = true;
          const markerBtn = document.getElementById('topMarkerBtn');
          markerBtn.textContent = 'ë§ˆì»¤ìƒì„± ì¤‘...';
          markerBtn.style.background = 'linear-gradient(135deg, #8b5cf6, #7c3aed)';
          markerBtn.style.color = 'white';
          
          // ì•ˆë‚´ ë©”ì‹œì§€ ì—†ì´ ë°”ë¡œ ì‹œì‘
          console.log('ë§ˆì»¤ìƒì„± ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ë§ˆì»¤ë¥¼ ìƒì„±í•˜ì„¸ìš”.');
        }
      }
      
      // ë§ˆì»¤ìƒì„± ëª¨ë“œ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
      function showMarkerModeMessage() {
        // ê¸°ì¡´ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì œê±°
        if (window.markerModeMessage) {
          window.markerModeMessage.remove();
        }
        
        // ì•ˆë‚´ ë©”ì‹œì§€ ìƒì„±
        const message = document.createElement('div');
        message.id = 'markerModeMessage';
        message.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          z-index: 1000;
          font-size: 16px;
          max-width: 300px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        `;
        message.innerHTML = `
          <div style="margin-bottom: 15px;">ğŸ“</div>
          <div style="font-weight: bold; margin-bottom: 10px;">ë§ˆì»¤ìƒì„± ëª¨ë“œ</div>
          <div>ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì›í•˜ëŠ” ìœ„ì¹˜ì— ë§ˆì»¤ë¥¼ ìƒì„±í•˜ì„¸ìš”.</div>
          <div style="margin-top: 10px; font-size: 14px; opacity: 0.8;">ë§ˆì»¤ë¥¼ í´ë¦­í•˜ë©´ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        `;
        
        document.body.appendChild(message);
        window.markerModeMessage = message;
        
        // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ë©”ì‹œì§€ ì œê±°
        setTimeout(() => {
          if (message.parentNode) {
            message.remove();
            window.markerModeMessage = null;
          }
        }, 3000);
      }
      
      // ì‚¬ìš©ì ì •ì˜ ë§ˆì»¤ ì¶”ê°€ í•¨ìˆ˜
      function addCustomMarker(latLng) {
        // ë§ˆì»¤ ìƒì„±
        const marker = new google.maps.Marker({
          position: latLng,
          map: map,
          title: `ì‚¬ìš©ì ë§ˆì»¤ ${customMarkers.length + 1}`,
          zIndex: 1000, // ê²½ë¡œì™€ ë¼ë²¨ ìœ„ì— í‘œì‹œ
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#8b5cf6',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2,
            scale: 15 // 10 * 1.5 = 15
          },
          label: {
            text: (customMarkers.length + 1).toString(),
            fontSize: '21px', // 14px * 1.5 = 21px
            fontWeight: 'bold',
            color: '#ffffff'
          }
        });
        
        // ë§ˆì»¤ í´ë¦­ ì‹œ ì œê±° ê¸°ëŠ¥
        marker.addListener('click', function() {
          if (confirm('ì´ ë§ˆì»¤ë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            removeCustomMarker(marker);
          }
        });
        
        customMarkers.push(marker);
        console.log('ë§ˆì»¤ ì¶”ê°€ë¨, í˜„ì¬ customMarkers.length:', customMarkers.length);
        
        // ë§ˆì»¤ê°€ ìƒì„±ë˜ë©´ ë²„íŠ¼ì„ "ë§ˆì»¤ì™„ì„±"ìœ¼ë¡œ ë³€ê²½
        if (customMarkers.length >= 1) {
          const markerBtn = document.getElementById('topMarkerBtn');
          markerBtn.textContent = 'ë§ˆì»¤ì™„ì„±';
          markerBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          markerBtn.style.color = 'white';
          console.log('ë²„íŠ¼ì„ "ë§ˆì»¤ì™„ì„±"ìœ¼ë¡œ ë³€ê²½');
        }
        
        // ì„±ê³µ ë©”ì‹œì§€
        console.log(`ë§ˆì»¤ ${customMarkers.length}ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
      
      // ì‚¬ìš©ì ì •ì˜ ë§ˆì»¤ ì œê±° í•¨ìˆ˜
      function removeCustomMarker(marker) {
        console.log('removeCustomMarker í˜¸ì¶œë¨, í˜„ì¬ customMarkers.length:', customMarkers.length);
        const index = customMarkers.indexOf(marker);
        if (index > -1) {
          marker.setMap(null);
          customMarkers.splice(index, 1);
          console.log('ë§ˆì»¤ ì œê±°ë¨, í˜„ì¬ customMarkers.length:', customMarkers.length);
          
          // ë§ˆì»¤ ë²ˆí˜¸ ì¬ì •ë ¬
          customMarkers.forEach((m, i) => {
            m.setTitle(`ì‚¬ìš©ì ë§ˆì»¤ ${i + 1}`);
            m.setLabel({
              text: (i + 1).toString(),
              fontSize: '21px', // 14px * 1.5 = 21px
              fontWeight: 'bold',
              color: '#ffffff'
            });
          });
          
          // ë§ˆì»¤ê°€ ëª¨ë‘ ì œê±°ë˜ë©´ ë²„íŠ¼ì„ "ë§ˆì»¤ìƒì„± ì¤‘..."ìœ¼ë¡œ ë³€ê²½
          if (customMarkers.length === 0) {
            const markerBtn = document.getElementById('topMarkerBtn');
            markerBtn.textContent = 'ë§ˆì»¤ìƒì„± ì¤‘...';
            markerBtn.style.background = 'linear-gradient(135deg, #8b5cf6, #7c3aed)';
            markerBtn.style.color = 'white';
            console.log('ë²„íŠ¼ì„ "ë§ˆì»¤ìƒì„± ì¤‘..."ìœ¼ë¡œ ë³€ê²½');
          }
          
          console.log(`ë§ˆì»¤ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚¨ì€ ë§ˆì»¤: ${customMarkers.length}ê°œ`);
        }
      }
      
      // ì‚¬ìš©ì ê²½ë¡œ ëª¨ë“œ í† ê¸€ í•¨ìˆ˜
      function toggleRouteMode() {
        // ë§ˆì»¤ìƒì„± ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë¹„í™œì„±í™”
        if (isMarkerMode) {
          toggleMarkerMode();
        }
        
        // ê²½ë¡œíƒìƒ‰ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë¹„í™œì„±í™”
        if (isRouteSearchMode) {
          toggleRouteSearch();
        }
        
        if (userRouteMarkers.length === 0) {
          // ì²« ë²ˆì§¸ í´ë¦­: ê²½ë¡œ ìƒì„± ëª¨ë“œ ì‹œì‘
          isRouteMode = true;
          const routeBtn = document.getElementById('topRouteBtn');
          routeBtn.textContent = 'ê²½ë¡œìƒì„± ì¤‘...';
          routeBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
          routeBtn.style.color = 'white';
          
          console.log('ê²½ë¡œìƒì„± ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ê²½ë¡œì˜ ì²« ë²ˆì§¸ ìœ„ì¹˜ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
        } else if (userRouteMarkers.length >= 2) {
          // ë§ˆì»¤ê°€ 2ê°œ ì´ìƒì¼ ë•Œ: ê²½ë¡œì™„ì„± ëª¨ë“œ
          const routeBtn = document.getElementById('topRouteBtn');
          routeBtn.textContent = 'ê²½ë¡œì™„ì„±';
          routeBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          routeBtn.style.color = 'white';
          
          // ê²½ë¡œ ì €ì¥ ìœ„ì¹˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
          showRouteSaveDialog();
        }
      }
      
      // ê²½ë¡œíƒìƒ‰ ëª¨ë“œ ê´€ë ¨ ë³€ìˆ˜
      let isRouteSearchMode = false;
      let searchStartMarker = null;
      let searchEndMarker = null;
      let directionsService = null;
      let directionsRenderer = null;
      
      // ê²½ë¡œíƒìƒ‰ ëª¨ë“œ í† ê¸€ í•¨ìˆ˜
      function toggleRouteSearch() {
        // ë‹¤ë¥¸ ëª¨ë“œë“¤ ë¹„í™œì„±í™”
        if (isMarkerMode) {
          toggleMarkerMode();
        }
        if (isRouteMode) {
          // ê²½ë¡œìƒì„± ëª¨ë“œ ë¹„í™œì„±í™”
          isRouteMode = false;
          const routeBtn = document.getElementById('topRouteBtn');
          routeBtn.textContent = 'ê²½ë¡œìƒì„±';
          routeBtn.style.background = 'rgba(255, 255, 255, 0.12)';
          routeBtn.style.color = '#1a1a1a';
          
          // ê²½ë¡œ ê´€ë ¨ ë§ˆì»¤ë“¤ ì œê±°
          userRouteMarkers.forEach(marker => marker.setMap(null));
          userRouteMarkers = [];
          
          // ê²½ë¡œ í´ë¦¬ë¼ì¸ ì œê±°
          if (userRoutePath) {
            userRoutePath.setMap(null);
            userRoutePath = null;
          }
          if (userRouteDottedPath) {
            userRouteDottedPath.setMap(null);
            userRouteDottedPath = null;
          }
        }
        
        const searchBtn = document.getElementById('topRouteSearchBtn');
        
        if (!isRouteSearchMode) {
          // ê²½ë¡œíƒìƒ‰ ëª¨ë“œ í™œì„±í™”
          isRouteSearchMode = true;
          searchBtn.textContent = 'íƒìƒ‰ ì¤‘...';
          searchBtn.style.background = 'linear-gradient(135deg, #8b5cf6, #7c3aed)';
          searchBtn.style.color = 'white';
          
          // Directions ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
          if (!directionsService) {
            try {
              directionsService = new google.maps.DirectionsService();
              directionsRenderer = new google.maps.DirectionsRenderer({
                draggable: true,
                strokeColor: '#ff6b35',
                strokeOpacity: 0.1,
                strokeWeight: 6
              });
              directionsRenderer.setMap(map);
              console.log('Directions ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
              console.error('Directions ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
              alert('ê²½ë¡œíƒìƒ‰ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Directions APIê°€ í™œì„±í™”ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              return;
            }
          }
          
          console.log('ê²½ë¡œíƒìƒ‰ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ í´ë¦­í•˜ì„¸ìš”.');
          
          // API ìƒíƒœ í™•ì¸
          checkDirectionsApiStatus();
        } else {
          // ê²½ë¡œíƒìƒ‰ ëª¨ë“œ ë¹„í™œì„±í™”
          isRouteSearchMode = false;
          searchBtn.textContent = 'ê²½ë¡œíƒìƒ‰';
          searchBtn.style.background = 'rgba(255, 255, 255, 0.12)';
          searchBtn.style.color = '#1a1a1a';
          
          // ê²€ìƒ‰ ë§ˆì»¤ë“¤ ì œê±°
          if (searchStartMarker) {
            searchStartMarker.setMap(null);
            searchStartMarker = null;
          }
          if (searchEndMarker) {
            searchEndMarker.setMap(null);
            searchEndMarker = null;
          }
          
          // ê²½ë¡œ ì œê±°
          if (directionsRenderer) {
            directionsRenderer.setMap(null);
          }
          
          console.log('ê²½ë¡œíƒìƒ‰ ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      }
      
      // ê²½ë¡œíƒìƒ‰ í¬ì¸íŠ¸ ì¶”ê°€ í•¨ìˆ˜
      function addRouteSearchPoint(latLng) {
        if (!isRouteSearchMode) return;
        
        if (!searchStartMarker) {
          // ì¶œë°œì§€ ì„¤ì •
          searchStartMarker = new google.maps.Marker({
            position: latLng,
            map: map,
            title: 'ì¶œë°œì§€',
            zIndex: 1000, // ê²½ë¡œì™€ ë¼ë²¨ ìœ„ì— í‘œì‹œ
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              fillColor: '#22c55e',
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 3,
              scale: 15
            },
            label: {
              text: 'A',
              fontSize: '18px',
              fontWeight: 'bold',
              color: '#ffffff'
            }
          });
          
          console.log('ì¶œë°œì§€ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë„ì°©ì§€ë¥¼ í´ë¦­í•˜ì„¸ìš”.');
        } else if (!searchEndMarker) {
          // ë„ì°©ì§€ ì„¤ì •
          searchEndMarker = new google.maps.Marker({
            position: latLng,
            map: map,
            title: 'ë„ì°©ì§€',
            zIndex: 1000, // ê²½ë¡œì™€ ë¼ë²¨ ìœ„ì— í‘œì‹œ
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              fillColor: '#ef4444',
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 3,
              scale: 15
            },
            label: {
              text: 'B',
              fontSize: '18px',
              fontWeight: 'bold',
              color: '#ffffff'
            }
          });
          
          // ê²½ë¡œ ê²€ìƒ‰ ì‹¤í–‰
          searchRoute();
        } else {
          // ì´ë¯¸ ì¶œë°œì§€ì™€ ë„ì°©ì§€ê°€ ì„¤ì •ëœ ê²½ìš° - ìƒˆë¡œìš´ ê²€ìƒ‰ ì‹œì‘
          searchStartMarker.setMap(null);
          searchEndMarker.setMap(null);
          if (directionsRenderer) {
            directionsRenderer.setDirections({routes: []});
          }
          
          // ìƒˆë¡œìš´ ì¶œë°œì§€ë¡œ ì„¤ì •
          searchStartMarker = new google.maps.Marker({
            position: latLng,
            map: map,
            title: 'ì¶œë°œì§€',
            zIndex: 1000, // ê²½ë¡œì™€ ë¼ë²¨ ìœ„ì— í‘œì‹œ
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              fillColor: '#22c55e',
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 3,
              scale: 15
            },
            label: {
              text: 'A',
              fontSize: '18px',
              fontWeight: 'bold',
              color: '#ffffff'
            }
          });
          
          searchEndMarker = null;
          console.log('ìƒˆë¡œìš´ ì¶œë°œì§€ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë„ì°©ì§€ë¥¼ í´ë¦­í•˜ì„¸ìš”.');
        }
      }
      
      // ê²½ë¡œ ê²€ìƒ‰ ì‹¤í–‰ í•¨ìˆ˜
      function searchRoute() {
        if (!searchStartMarker || !searchEndMarker || !directionsService) return;
        
        const request = {
          origin: searchStartMarker.getPosition(),
          destination: searchEndMarker.getPosition(),
          travelMode: google.maps.TravelMode.DRIVING,
          unitSystem: google.maps.UnitSystem.METRIC
          // region ì œí•œ ì œê±°: ì „ ì„¸ê³„ ê²½ë¡œíƒìƒ‰ ê°€ëŠ¥
        };
        
        console.log('ê²½ë¡œë¥¼ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
        
        directionsService.route(request, (result, status) => {
          console.log('ê²½ë¡œ ê²€ìƒ‰ ì‘ë‹µ:', { status, result });
          
          if (status === 'OK') {
            directionsRenderer.setDirections(result);
            
            // ê²½ë¡œ ì •ë³´ í‘œì‹œ
            const route = result.routes[0];
            const leg = route.legs[0];
            const distance = leg.distance.text;
            const duration = leg.duration.text;
            
            console.log(`ê²½ë¡œ ê²€ìƒ‰ ì™„ë£Œ: ê±°ë¦¬ ${distance}, ì†Œìš”ì‹œê°„ ${duration}`);
            
            // ê¸°ê¸°ë³„ ì²˜ë¦¬ - íŒ¨ë„ ì—†ì´ ë°”ë¡œ ì—°ê²°
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            // ì „ì—­ isMobile ë³€ìˆ˜ ì‚¬ìš©
            
            if (isMobile) {
              // ëª¨ë°”ì¼: ì§ì ‘ ì•± ìŠ¤í‚´ìœ¼ë¡œ ë°”ë¡œ êµ¬ê¸€ë§µ ì•± ì‹¤í–‰
              const origin = searchStartMarker.getPosition();
              const destination = searchEndMarker.getPosition();
              
              const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
              const isAndroid = /Android/.test(navigator.userAgent);
              
              // ëª¨ë°”ì¼: êµ¬ê¸€ë§µ ì•± ì§ì ‘ ì‹¤í–‰ (í”Œë«í¼ ë¬´ê´€)
              const appUrl = buildGoogleMapsAppUrl(origin, destination, 'driving');
              
              // ì•± ì‹¤í–‰ í‘œì‹œ ì„¤ì • (í˜ì´ì§€ ë³µê·€ ê°ì§€ìš©)
              window.routeSearchExecuted = true;
              
              // ì¦‰ì‹œ ì•± ì‹¤í–‰
              window.location.href = appUrl;
              console.log(`${isIOS ? 'iOS' : isAndroid ? 'Android' : 'ê¸°íƒ€ ëª¨ë°”ì¼'}ì—ì„œ êµ¬ê¸€ë§µ ì•± ì§ì ‘ ì‹¤í–‰:`, appUrl);
              console.log(`ê²€ìƒ‰ëœ ê²½ë¡œ: ê±°ë¦¬ ${distance}, ì†Œìš”ì‹œê°„ ${duration}`);
            } else {
              // ë°ìŠ¤í¬íƒ‘: ë°”ë¡œ êµ¬ê¸€ë§µ ì›¹í˜ì´ì§€ë¡œ ì´ë™
              const webUrl = buildGoogleMapsUrlWithNames(searchStartMarker.getPosition(), searchEndMarker.getPosition(), 'driving');
              window.open(webUrl, '_blank');
              console.log('ë°ìŠ¤í¬íƒ‘ì—ì„œ êµ¬ê¸€ë§µ ì›¹ìœ¼ë¡œ ë°”ë¡œ ì´ë™:', webUrl);
              console.log(`ê²€ìƒ‰ëœ ê²½ë¡œ: ê±°ë¦¬ ${distance}, ì†Œìš”ì‹œê°„ ${duration}`);
            }
            
          } else {
            console.error('ê²½ë¡œ ê²€ìƒ‰ ì‹¤íŒ¨:', status);
            let errorMessage = 'ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            
            switch (status) {
              case 'NOT_FOUND':
                errorMessage = 'ì¶œë°œì§€ ë˜ëŠ” ë„ì°©ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                break;
              case 'ZERO_RESULTS':
                errorMessage = 'ì¶œë°œì§€ì™€ ë„ì°©ì§€ ì‚¬ì´ì˜ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                break;
              case 'MAX_WAYPOINTS_EXCEEDED':
                errorMessage = 'ê²½ìœ ì§€ê°€ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤.';
                break;
              case 'INVALID_REQUEST':
                errorMessage = 'ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.';
                break;
              case 'OVER_QUERY_LIMIT':
                errorMessage = 'API ì‚¬ìš©ëŸ‰ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.';
                break;
              case 'REQUEST_DENIED':
                errorMessage = 'Directions API ì‚¬ìš©ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
                break;
              case 'UNKNOWN_ERROR':
                errorMessage = 'ì„œë²„ ì˜¤ë¥˜ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                break;
            }
            
            alert(errorMessage);
          }
        });
      }
      // Directions API ìƒíƒœ í™•ì¸ í•¨ìˆ˜
      function checkDirectionsApiStatus() {
        console.log('=== Directions API ìƒíƒœ í™•ì¸ ===');
        
        // í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ API í‚¤ í‘œì‹œ
        console.log('ğŸ”‘ í˜„ì¬ API í‚¤:', 'AIzaSyDVwJrvIcbqAOX24g9JODhD7DGtTz7z2Pg');
        
        // ê¸°ë³¸ í™•ì¸ì‚¬í•­
        if (typeof google === 'undefined') {
          console.error('âŒ Google Maps APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          return;
        }
        
        if (typeof google.maps === 'undefined') {
          console.error('âŒ Google Maps ê°ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        if (typeof google.maps.DirectionsService === 'undefined') {
          console.error('âŒ DirectionsServiceê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. directions ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
          return;
        }
        
        if (typeof google.maps.DirectionsRenderer === 'undefined') {
          console.error('âŒ DirectionsRendererê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. directions ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
          return;
        }
        
        console.log('âœ… Directions API ê¸°ë³¸ ê°ì²´ë“¤ì´ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        console.log('âœ… DirectionsService:', typeof google.maps.DirectionsService);
        console.log('âœ… DirectionsRenderer:', typeof google.maps.DirectionsRenderer);
        console.log('âœ… í˜„ì¬ directionsService ì¸ìŠ¤í„´ìŠ¤:', directionsService ? 'ìƒì„±ë¨' : 'ë¯¸ìƒì„±');
        console.log('âœ… í˜„ì¬ directionsRenderer ì¸ìŠ¤í„´ìŠ¤:', directionsRenderer ? 'ìƒì„±ë¨' : 'ë¯¸ìƒì„±');
        
        // API ê¶Œí•œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ê°„ë‹¨í•œ ìš”ì²­
        console.log('ğŸ§ª API ê¶Œí•œ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
        testDirectionsApiPermission();
      }
      
      // API ê¶Œí•œ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
      function testDirectionsApiPermission() {
        if (!directionsService) {
          console.log('DirectionsService ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ì–´ í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.');
          return;
        }
        
        // ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ìš”ì²­ (ì„œìš¸ì—­ â†’ ê°•ë‚¨ì—­ - ì „ ì„¸ê³„ í…ŒìŠ¤íŠ¸)
        const testRequest = {
          origin: new google.maps.LatLng(37.5547, 126.9707), // ì„œìš¸ì—­
          destination: new google.maps.LatLng(37.4979, 127.0276), // ê°•ë‚¨ì—­
          travelMode: google.maps.TravelMode.DRIVING
        };
        
        console.log('ğŸ§ª í…ŒìŠ¤íŠ¸ ê²½ë¡œ ìš”ì²­:', testRequest);
        
        directionsService.route(testRequest, (result, status) => {
          console.log('ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼:', { status, result });
          
          if (status === 'OK') {
            console.log('âœ… Directions API ê¶Œí•œ í…ŒìŠ¤íŠ¸ ì„±ê³µ! ê²½ë¡œíƒìƒ‰ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          } else if (status === 'REQUEST_DENIED') {
            console.error('âŒ API í‚¤ì— Directions API ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            console.error('ğŸ“‹ í•´ê²° ë°©ë²•:');
            console.error('   1. Google Cloud Console (https://console.cloud.google.com/) ì ‘ì†');
            console.error('   2. API ë° ì„œë¹„ìŠ¤ â†’ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë©”ë‰´');
            console.error('   3. "Directions API" ê²€ìƒ‰ í›„ í™œì„±í™”');
            console.error('   4. API í‚¤ ê¶Œí•œ ì„¤ì •ì—ì„œ Directions API ì¶”ê°€');
          } else {
            console.warn('âš ï¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', status);
          }
        });
      }
      

      

      

      

      

      

      
      // êµ¬ê¸€ë§µ URL ìƒì„± í•¨ìˆ˜
      function buildGoogleMapsUrl(origin, destination, travelMode = 'driving') {
        const baseUrl = 'https://www.google.com/maps/dir/';
        
        // ì¢Œí‘œë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
        const originStr = `${origin.lat()},${origin.lng()}`;
        const destinationStr = `${destination.lat()},${destination.lng()}`;
        
        // êµí†µìˆ˜ë‹¨ë³„ íŒŒë¼ë¯¸í„°
        let modeParam = '';
        switch(travelMode) {
          case 'walking':
            modeParam = '&dirflg=w';
            break;
          case 'transit':
            modeParam = '&dirflg=r';
            break;
          case 'bicycling':
            modeParam = '&dirflg=b';
            break;
          case 'driving':
          default:
            modeParam = '&dirflg=d';
            break;
        }
        
        // ìµœì¢… URL êµ¬ì„±
        const fullUrl = `${baseUrl}${originStr}/${destinationStr}/@${originStr},15z${modeParam}&hl=ko`;
        
        return fullUrl;
      }
      
      // ê²½ë¡œíƒìƒ‰ ìƒíƒœ ì´ˆê¸°í™” í•¨ìˆ˜
      function resetRouteSearchState() {
        console.log('ê²½ë¡œíƒìƒ‰ ìƒíƒœ ì´ˆê¸°í™” ì¤‘...');
        
        // ê²€ìƒ‰ ë§ˆì»¤ë“¤ ì œê±°
        if (searchStartMarker) {
          searchStartMarker.setMap(null);
          searchStartMarker = null;
        }
        if (searchEndMarker) {
          searchEndMarker.setMap(null);
          searchEndMarker = null;
        }
        
        // ê²½ë¡œ ì œê±°
        if (directionsRenderer) {
          directionsRenderer.setDirections({routes: []});
        }
        
        // ê²½ë¡œíƒìƒ‰ ëª¨ë“œ ë¹„í™œì„±í™”
        isRouteSearchMode = false;
        const searchBtn = document.getElementById('topRouteSearchBtn');
        if (searchBtn) {
          searchBtn.textContent = 'ê²½ë¡œíƒìƒ‰';
          searchBtn.style.background = 'rgba(255, 255, 255, 0.12)';
          searchBtn.style.color = '#1a1a1a';
        }
        
        // ì•± ì‹¤í–‰ í”Œë˜ê·¸ ë¦¬ì…‹
        window.routeSearchExecuted = false;
        
        console.log('ê²½ë¡œíƒìƒ‰ ì´ˆê¸°í™” ì™„ë£Œ');
      }
      
      // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ê°ì§€ (ì•±ì—ì„œ ë³µê·€ ê°ì§€)
      function setupPageVisibilityListener() {
        document.addEventListener('visibilitychange', function() {
          if (document.visibilityState === 'visible' && window.routeSearchExecuted) {
            console.log('ì•±ì—ì„œ ì›¹í˜ì´ì§€ë¡œ ë³µê·€ ê°ì§€ë¨');
            // ì•½ê°„ì˜ ì§€ì—° í›„ ì´ˆê¸°í™” (ì•ˆë‚´ì°½ ì—†ì´)
            setTimeout(() => {
              resetRouteSearchState();
            }, 500);
          }
        });
        
        // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ë„ ê°ì§€ (iOS Safari í˜¸í™˜ì„±)
        window.addEventListener('focus', function() {
          if (window.routeSearchExecuted) {
            console.log('ì•±ì—ì„œ ì›¹í˜ì´ì§€ë¡œ í¬ì»¤ìŠ¤ ë³µê·€ ê°ì§€ë¨');
            setTimeout(() => {
              resetRouteSearchState();
            }, 500);
          }
        });
        
        console.log('í˜ì´ì§€ ë³µê·€ ê°ì§€ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
      }
      
      // ëª¨ë°”ì¼ êµ¬ê¸€ë§µ ì•± ì§ì ‘ ì—°ê²° URL ìŠ¤í‚´ ìƒì„± í•¨ìˆ˜
      function buildGoogleMapsAppUrl(origin, destination, travelMode = 'driving') {
        // ì¢Œí‘œë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
        const originStr = `${origin.lat()},${origin.lng()}`;
        const destinationStr = `${destination.lat()},${destination.lng()}`;
        
        // iOS/Android ê¸°ê¸° ê°ì§€
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        
        // êµí†µìˆ˜ë‹¨ë³„ íŒŒë¼ë¯¸í„° (êµ¬ê¸€ë§µ ì•± ìŠ¤í‚´ìš©)
        let modeParam = '';
        switch(travelMode) {
          case 'walking':
            modeParam = '&travelmode=walking';
            break;
          case 'transit':
            modeParam = '&travelmode=transit';
            break;
          case 'bicycling':
            modeParam = '&travelmode=bicycling';
            break;
          case 'driving':
          default:
            modeParam = '&travelmode=driving';
            break;
        }
        
        let appUrl;
        
        if (isIOS) {
          // iOS: êµ¬ê¸€ë§µ ì•± ì§ì ‘ ìŠ¤í‚´ ì‚¬ìš©
          // comgooglemaps:// ìŠ¤í‚´ìœ¼ë¡œ ë°”ë¡œ ì•± ì‹¤í–‰
          appUrl = `comgooglemaps://?saddr=${originStr}&daddr=${destinationStr}${modeParam}`;
          
          console.log('iOSì—ì„œ êµ¬ê¸€ë§µ ì•± ì§ì ‘ ìŠ¤í‚´:', appUrl);
          
        } else if (isAndroid) {
          // Android: êµ¬ê¸€ë§µ ì•± ì§ì ‘ ì¸í…íŠ¸ ì‚¬ìš©
          // google.navigation:// ìŠ¤í‚´ìœ¼ë¡œ ë°”ë¡œ ë„¤ë¹„ê²Œì´ì…˜ ì‹œì‘
          appUrl = `google.navigation:q=${destinationStr}&mode=${travelMode}`;
          
          console.log('Androidì—ì„œ êµ¬ê¸€ë§µ ë„¤ë¹„ê²Œì´ì…˜ ì§ì ‘ ìŠ¤í‚´:', appUrl);
        } else {
          // ê¸°íƒ€ ëª¨ë°”ì¼: êµ¬ê¸€ë§µ ì•± ìŠ¤í‚´ ì‹œë„
          appUrl = `comgooglemaps://?saddr=${originStr}&daddr=${destinationStr}${modeParam}`;
          
          console.log('ê¸°íƒ€ ëª¨ë°”ì¼ì—ì„œ êµ¬ê¸€ë§µ ì•± ìŠ¤í‚´:', appUrl);
        }
        
        return appUrl;
      }
      

      
      // êµ¬ê¸€ë§µ URLì„ ë” ì‚¬ìš©ì ì¹œí™”ì ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ëŒ€ì•ˆ í•¨ìˆ˜
      function buildGoogleMapsUrlWithNames(origin, destination, travelMode = 'driving') {
        const directionsResult = window.currentDirectionsResult;
        if (!directionsResult) return buildGoogleMapsUrl(origin, destination, travelMode);
        
        const route = directionsResult.routes[0];
        const leg = route.legs[0];
        
        // ì£¼ì†Œëª…ì´ ìˆëŠ” ê²½ìš° ì‚¬ìš©
        const startAddress = encodeURIComponent(leg.start_address);
        const endAddress = encodeURIComponent(leg.end_address);
        
        const baseUrl = 'https://www.google.com/maps/dir/';
        
        // êµí†µìˆ˜ë‹¨ë³„ íŒŒë¼ë¯¸í„°
        let modeParam = '';
        switch(travelMode) {
          case 'walking':
            modeParam = '&dirflg=w';
            break;
          case 'transit':
            modeParam = '&dirflg=r';
            break;
          case 'bicycling':
            modeParam = '&dirflg=b';
            break;
          case 'driving':
          default:
            modeParam = '&dirflg=d';
            break;
        }
        
        // ì£¼ì†Œëª…ìœ¼ë¡œ URL êµ¬ì„±
        const fullUrl = `${baseUrl}${startAddress}/${endAddress}${modeParam}&hl=ko`;
        
        return fullUrl;
      }
      

      

      

      
      // ê²€ìƒ‰ëœ ê²½ë¡œìš© ì €ì¥ ë‹¤ì´ì–¼ë¡œê·¸
      function showRouteSaveDialogForSearched(routeData) {
        // ê¸°ì¡´ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ìˆìœ¼ë©´ ì œê±°
        const existingDialog = document.getElementById('routeSaveDialog');
        if (existingDialog) {
          existingDialog.remove();
        }
        
        // í˜„ì¬ í™œì„±í™”ëœ ì¼ì • í•­ëª©ë“¤ ê°€ì ¸ì˜¤ê¸°
        const scheduleItems = getActiveScheduleItems();
        
        // ì¼ì • í•­ëª© ë²„íŠ¼ë“¤ ìƒì„±
        let scheduleButtons = '';
        if (scheduleItems.length === 0) {
          scheduleButtons = '<p style="text-align: center; color: #666; margin: 20px 0;">ë¨¼ì € ì¼ì •ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>';
        } else {
          scheduleItems.forEach(item => {
            scheduleButtons += `<button class="route-save-btn" onclick="saveSearchedRouteToLocation('${item.title}', '${routeData.id}')">${item.title}</button>`;
          });
        }
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
        const dialogDiv = document.createElement('div');
        dialogDiv.id = 'routeSaveDialog';
        dialogDiv.innerHTML = `
          <div style="padding: 28px 24px 24px 24px;">
            <div style="text-align: center; margin-bottom: 24px;">
              <h3 style="color: #000; margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">ê²½ë¡œ ì €ì¥ ìœ„ì¹˜ ì„ íƒ</h3>
              <p style="color: #000; font-size: 0.9rem; margin-top: 8px; margin-bottom: 0; opacity: 0.7;">
                ê±°ë¦¬: ${routeData.distance} | ì†Œìš”ì‹œê°„: ${routeData.duration}
              </p>
            </div>
            <div class="route-save-options">
              ${scheduleButtons}
            </div>
          </div>
        `;
        
        // ì„ì‹œë¡œ routeDataë¥¼ ì „ì—­ì— ì €ì¥
        window.tempSearchedRoute = routeData;
        
        // ë‹¤ì´ì–¼ë¡œê·¸ë¥¼ ì§€ë„ ìœ„ì— í‘œì‹œ
        document.body.appendChild(dialogDiv);
      }
      
      // ê²€ìƒ‰ëœ ê²½ë¡œë¥¼ íŠ¹ì • ìœ„ì¹˜ì— ì €ì¥
      function saveSearchedRouteToLocation(location, routeId) {
        const routeData = window.tempSearchedRoute;
        if (!routeData) {
          alert('ì €ì¥í•  ê²½ë¡œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        // ê¸°ì¡´ saveRouteToLocation í•¨ìˆ˜ì™€ ë™ì¼í•œ ë¡œì§ ì‚¬ìš©
        routeData.section = location;
        savedUserRoutes.push(routeData);
        
        // Firebaseì— ì €ì¥
        saveUserRoutesToFirebase();
        
        // ì €ì¥ëœ ê²½ë¡œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        drawAllSavedRoutes();
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
        closeRouteSaveDialog();
        
        // ê²½ë¡œíƒìƒ‰ ëª¨ë“œ ì¢…ë£Œ
        toggleRouteSearch();
        
        // ì„ì‹œ ë°ì´í„° ì •ë¦¬
        delete window.tempSearchedRoute;
        
        alert(`ê²€ìƒ‰ëœ ê²½ë¡œê°€ "${location}"ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        console.log('ê²€ìƒ‰ëœ ê²½ë¡œ ì €ì¥ ì™„ë£Œ:', routeData);
      }
      
      // ì‚¬ìš©ì ê²½ë¡œì— ìœ„ì¹˜ ì¶”ê°€ í•¨ìˆ˜
      function addUserRoutePoint(latLng) {
        if (!isRouteMode) return;
        
        // ë§ˆì»¤ ìƒì„±
        const marker = new google.maps.Marker({
          position: latLng,
          map: map,
          title: `ìœ„ì¹˜ ${userRouteMarkers.length + 1}`,
          zIndex: 1000, // ê²½ë¡œì™€ ë¼ë²¨ ìœ„ì— í‘œì‹œ
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#ef4444',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2,
            scale: 12 // 8 * 1.5 = 12
          },
          label: {
            text: (userRouteMarkers.length + 1).toString(),
            fontSize: '18px', // 12px * 1.5 = 18px
            fontWeight: 'bold',
            color: '#ffffff'
          }
        });
        
        // ë§ˆì»¤ í´ë¦­ ì‹œ ì œê±° ê¸°ëŠ¥
        marker.addListener('click', function() {
          if (confirm('ì´ ìœ„ì¹˜ë¥¼ ê²½ë¡œì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            removeUserRoutePoint(marker);
          }
        });
        
        userRouteMarkers.push(marker);
        
        // ê²½ë¡œ ì—…ë°ì´íŠ¸
        updateUserRoute();
        
        // ë§ˆì»¤ê°€ 2ê°œ ì´ìƒì¼ ë•Œ ë²„íŠ¼ì„ "ê²½ë¡œì™„ì„±"ìœ¼ë¡œ ë³€ê²½
        if (userRouteMarkers.length >= 2) {
          const routeBtn = document.getElementById('topRouteBtn');
          routeBtn.textContent = 'ê²½ë¡œì™„ì„±';
          routeBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          routeBtn.style.color = 'white';
        }
        
        // ì„±ê³µ ë©”ì‹œì§€
        const message = userRouteMarkers.length === 1 ? 
          'ì²« ë²ˆì§¸ ìœ„ì¹˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ê³„ì†í•´ì„œ ë‹¤ìŒ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.' :
          `ìœ„ì¹˜ ${userRouteMarkers.length}ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`;
        console.log(message);
      }
      
      // ì‚¬ìš©ì ê²½ë¡œì—ì„œ ìœ„ì¹˜ ì œê±° í•¨ìˆ˜
      function removeUserRoutePoint(marker) {
        const index = userRouteMarkers.indexOf(marker);
        if (index > -1) {
          marker.setMap(null);
          userRouteMarkers.splice(index, 1);
          
          // ë§ˆì»¤ ë²ˆí˜¸ ì¬ì •ë ¬
          userRouteMarkers.forEach((m, i) => {
            m.setTitle(`ìœ„ì¹˜ ${i + 1}`);
            m.setLabel({
              text: (i + 1).toString(),
              fontSize: '12px',
              fontWeight: 'bold',
              color: '#ffffff'
            });
          });
          
          // ê²½ë¡œ ì—…ë°ì´íŠ¸
          updateUserRoute();
          
          // ë§ˆì»¤ê°€ 2ê°œ ë¯¸ë§Œì¼ ë•Œ ë²„íŠ¼ì„ "ê²½ë¡œ ìƒì„± ì¤‘..."ìœ¼ë¡œ ë³€ê²½
          if (userRouteMarkers.length < 2) {
            const routeBtn = document.getElementById('topRouteBtn');
            routeBtn.textContent = 'ê²½ë¡œìƒì„± ì¤‘...';
            routeBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            routeBtn.style.color = 'white';
          }
        }
      }
      
      // ì‚¬ìš©ì ê²½ë¡œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateUserRoute() {
        // ê¸°ì¡´ ê²½ë¡œ ì œê±°
        if (userRoutePath) {
          userRoutePath.setMap(null);
        }
        if (userRouteDottedPath) {
          userRouteDottedPath.setMap(null);
        }
        
        // ë§ˆì»¤ê°€ 2ê°œ ì´ìƒì¼ ë•Œë§Œ ê²½ë¡œ ìƒì„±
        if (userRouteMarkers.length >= 2) {
          const path = userRouteMarkers.map(marker => marker.getPosition());
          
          // ë©”ì¸ ê²½ë¡œ (íŒŒë€ìƒ‰)
          userRoutePath = new google.maps.Polyline({
            path: path,
            geodesic: true,
            strokeColor: '#3b82f6',
            strokeOpacity: 0.1,
            strokeWeight: 4,
            zIndex: 10 // ë¼ë²¨ ì•„ë˜ì— í‘œì‹œ
          });
          userRoutePath.setMap(map);
          
          // ì„ì‹œ ê²½ë¡œ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
          userRoutePath.addListener('click', function(event) {
            const tempRoute = {
              name: 'ìƒì„± ì¤‘ì¸ ê²½ë¡œ',
              path: path
            };
            showRouteInfo(tempRoute, event.latLng);
          });
          
          // ì ì„  íš¨ê³¼ (í°ìƒ‰ ì ë“¤)
          userRouteDottedPath = new google.maps.Polyline({
            path: path,
            geodesic: true,
            strokeColor: '#ffffff',
            strokeOpacity: 0.1,
            strokeWeight: 2,
            zIndex: 15, // ë©”ì¸ ê²½ë¡œë³´ë‹¤ëŠ” ìœ„ì—, ë¼ë²¨ë³´ë‹¤ëŠ” ì•„ë˜
            icons: [{
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: '#3b82f6',
                fillOpacity: 1,
                strokeColor: '#ffffff',
                strokeWeight: 1,
                scale: 6
              },
              offset: '0',
              repeat: '15px'
            }]
          });
          userRouteDottedPath.setMap(map);
          
          // ì ì„  ê²½ë¡œì—ë„ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
          userRouteDottedPath.addListener('click', function(event) {
            const tempRoute = {
              name: 'ìƒì„± ì¤‘ì¸ ê²½ë¡œ',
              path: path
            };
            showRouteInfo(tempRoute, event.latLng);
          });
          
          // ê²½ë¡œ ì •ë³´ í‘œì‹œ
          const totalDistance = calculateRouteDistance(path);
          console.log(`ê²½ë¡œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ê±°ë¦¬: ${formatDistance(totalDistance)}`);
        }
      }
      
      // ì‚¬ìš©ì ê²½ë¡œ ì´ˆê¸°í™” í•¨ìˆ˜
      function clearUserRoute() {
        if (!confirm('ìƒì„±ëœ ê²½ë¡œë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì €ì¥ëœ ê²½ë¡œë„ í•¨ê»˜ ì œê±°ë©ë‹ˆë‹¤)')) {
          return;
        }
        
        // ëª¨ë“  ë§ˆì»¤ ì œê±°
        userRouteMarkers.forEach(marker => {
          marker.setMap(null);
        });
        userRouteMarkers = [];
        
        // ê²½ë¡œ ì œê±°
        if (userRoutePath) {
          userRoutePath.setMap(null);
          userRoutePath = null;
        }
        if (userRouteDottedPath) {
          userRouteDottedPath.setMap(null);
          userRouteDottedPath = null;
        }
        
        // ì €ì¥ëœ ëª¨ë“  ê²½ë¡œ ì œê±°
        savedUserRoutes.forEach(route => {
          if (route.pathElement) {
            route.pathElement.setMap(null);
          }
          if (route.dottedPathElement) {
            route.dottedPathElement.setMap(null);
          }
        });
        savedUserRoutes = [];
        
        // ê²½ë¡œ ëª¨ë“œ ë¹„í™œì„±í™”
        isRouteMode = false;
        const routeBtn = document.getElementById('topRouteBtn');
        const clearRouteBtn = document.getElementById('clearRouteBtn');
        
        routeBtn.textContent = 'ê²½ë¡œìƒì„±';
        routeBtn.style.background = 'rgba(255, 255, 255, 0.12)';
        routeBtn.style.color = '#1a1a1a';
        clearRouteBtn.style.display = 'none';
        
        alert('ëª¨ë“  ê²½ë¡œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
      
      // ê²½ë¡œ ì´ˆê¸°í™” ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜
      function updateClearRouteButton() {
        const clearRouteBtn = document.getElementById('clearRouteBtn');
        if (clearRouteBtn) {
          clearRouteBtn.style.display = userRouteMarkers.length > 0 ? 'block' : 'none';
        }
      }
      
      // í˜„ì¬ í™œì„±í™”ëœ ì¼ì • í•­ëª©ë“¤ ê°€ì ¸ì˜¤ê¸°
      function getActiveScheduleItems() {
        const scheduleItems = [];
        
        // ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ì¼ì •ë“¤ë§Œ ê°€ì ¸ì˜¤ê¸°
        const customScheduleButtons = document.querySelectorAll('#additionalDays [data-item-type="schedule"]');
        customScheduleButtons.forEach(item => {
          const scheduleId = item.getAttribute('data-schedule-id');
          const scheduleTitle = item.getAttribute('data-schedule-title');
          if (scheduleId && scheduleTitle) {
            scheduleItems.push({ id: scheduleId, title: scheduleTitle });
          }
        });
        
        return scheduleItems;
      }

      // ê²½ë¡œ ì €ì¥ ìœ„ì¹˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
      function showRouteSaveDialog() {
        // ê¸°ì¡´ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ìˆìœ¼ë©´ ì œê±°
        const existingDialog = document.getElementById('routeSaveDialog');
        if (existingDialog) {
          existingDialog.remove();
        }
        
        // í˜„ì¬ í™œì„±í™”ëœ ì¼ì • í•­ëª©ë“¤ ê°€ì ¸ì˜¤ê¸°
        const scheduleItems = getActiveScheduleItems();
        
        // ì¼ì • í•­ëª© ë²„íŠ¼ë“¤ ìƒì„±
        let scheduleButtons = '';
        if (scheduleItems.length === 0) {
          scheduleButtons = '<p style="text-align: center; color: #666; margin: 20px 0;">ë¨¼ì € ì¼ì •ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>';
        } else {
          scheduleItems.forEach(item => {
            scheduleButtons += `<button class="route-save-btn" onclick="saveRouteToLocation('${item.title}')">${item.title}</button>`;
          });
        }
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
        const dialogDiv = document.createElement('div');
        dialogDiv.id = 'routeSaveDialog';
        dialogDiv.innerHTML = `
          <div style="padding: 28px 24px 24px 24px;">
            <div style="text-align: center; margin-bottom: 24px;">
              <h3 style="color: #000; margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">ê²½ë¡œ ì €ì¥ ìœ„ì¹˜ ì„ íƒ</h3>
            </div>
            <div class="route-save-options">
              ${scheduleButtons}
            </div>
          </div>
        `;
        
        // ë‹¤ì´ì–¼ë¡œê·¸ë¥¼ ì§€ë„ ìœ„ì— í‘œì‹œ
        document.body.appendChild(dialogDiv);
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ìœ„ì¹˜ ì¡°ì • - ëª¨ë°”ì¼ ìµœì í™”
        setTimeout(() => {
          const mapElement = document.getElementById('map');
          const mapRect = mapElement.getBoundingClientRect();
          
          if (isMobile) {
            // ëª¨ë°”ì¼: í™”ë©´ ì¤‘ì•™ì— í‘œì‹œ
            dialogDiv.style.left = '50%';
            dialogDiv.style.transform = 'translateX(-50%)';
            dialogDiv.style.top = '80px';
          } else {
            // ë°ìŠ¤í¬í†±: ì§€ë„ ì¤‘ì•™ì— í‘œì‹œ
            dialogDiv.style.left = (mapRect.width / 2 - 200) + 'px';
            dialogDiv.style.top = (mapRect.height / 2 - 150) + 'px';
            dialogDiv.style.transform = 'none';
          }
        }, 100);
      }
      
      // ê²½ë¡œ ì €ì¥ ìœ„ì¹˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
      function closeRouteSaveDialog() {
        const dialog = document.getElementById('routeSaveDialog');
        if (dialog) {
          dialog.remove();
        }
      }
      
      // ì„ íƒëœ ìœ„ì¹˜ì— ê²½ë¡œ ì €ì¥ (ê°œì„ ëœ ë²„ì „)
      async function saveRouteToLocation(location) {
        if (userRouteMarkers.length < 2) {
          updateSyncStatus('ê²½ë¡œë¥¼ ìƒì„±í•˜ë ¤ë©´ ìµœì†Œ 2ê°œì˜ ìœ„ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤', 'error');
          return;
        }
        
        // ë™ê¸°í™” ì¤‘ì´ë©´ ë¬´ì‹œ
        if (isSyncing) {
          updateSyncStatus('ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'warning');
          return;
        }
        
        // ê²½ë¡œ ë°ì´í„° ìƒì„±
        const routeData = {
          id: 'route_' + Date.now(),
          name: `${location} ê²½ë¡œ`,
          location: location,
          path: userRouteMarkers.map(marker => ({
            lat: marker.getPosition().lat(),
            lng: marker.getPosition().lng()
          })),
          distance: calculateRouteDistance(userRouteMarkers.map(marker => marker.getPosition())),
          createdAt: new Date().toISOString()
        };
        
        try {
          // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
          isSyncing = true;
          updateSyncStatus('ê²½ë¡œ ì €ì¥ ì¤‘...', 'info');
          
          // Firebaseì— ì €ì¥
          await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
            savedUserRoutes: window.firestore.arrayUnion(routeData),
            lastUpdated: window.firestore.serverTimestamp()
          });
          
          // ì „ì—­ ë³€ìˆ˜ì— ì¶”ê°€
          savedUserRoutes.push(routeData);
          
          onFirebaseUploadSuccess('ê²½ë¡œ ì €ì¥');
          
          // ë¡œì»¬ ë°±ì—… ì œê±°: Firestoreë§Œ ì‚¬ìš©
          
          console.log('Firebaseì— ê²½ë¡œ ì €ì¥ ì™„ë£Œ');
          
        } catch (error) {
          console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', error);
          updateSyncStatus('Firebase ì €ì¥ ì‹¤íŒ¨', 'error');
          
          // ì „ì—­ ë³€ìˆ˜ì— ì¶”ê°€
          savedUserRoutes.push(routeData);
          
          setTimeout(() => {
            updateSyncStatus('Firebase ì—°ê²° ì‹¤íŒ¨', 'error');
          }, 2000);
        } finally {
          // ë™ê¸°í™” ìƒíƒœ í•´ì œ (ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í—ˆìš©)
          isSyncing = false;
        }
        
        // ì„ì‹œ ë§ˆì»¤ë“¤ ì œê±°
        userRouteMarkers.forEach(marker => {
          marker.setMap(null);
        });
        userRouteMarkers = [];
        
        // ì„ì‹œ ê²½ë¡œ ì œê±°
        if (userRoutePath) {
          userRoutePath.setMap(null);
          userRoutePath = null;
        }
        if (userRouteDottedPath) {
          userRouteDottedPath.setMap(null);
          userRouteDottedPath = null;
        }
        
        // ê²½ë¡œ ëª¨ë“œ ë¹„í™œì„±í™”
        isRouteMode = false;
        
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        const routeBtn = document.getElementById('topRouteBtn');
        routeBtn.textContent = 'ê²½ë¡œìƒì„±';
        routeBtn.style.background = 'rgba(255, 255, 255, 0.12)';
        routeBtn.style.color = '#1a1a1a';
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
        closeRouteSaveDialog();
        
        // ì €ì¥ëœ ê²½ë¡œë“¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        drawAllSavedRoutes();
        
        // ê²½ë¡œì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateRouteRemoveButtons();
        // ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateMarkerRemoveButtons();
      }
      // ë§ˆì»¤ ì €ì¥ ìœ„ì¹˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ì§ì ‘ ìƒì„± (ëŒ€ì•ˆ í•¨ìˆ˜)
      function createMarkerSaveDialogDirectly() {
        console.log('createMarkerSaveDialogDirectly í•¨ìˆ˜ í˜¸ì¶œë¨');
        
        // ê¸°ì¡´ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ìˆìœ¼ë©´ ì œê±°
        const existingDialog = document.getElementById('markerSaveDialog');
        if (existingDialog) {
          existingDialog.remove();
        }
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
        const dialogDiv = document.createElement('div');
        dialogDiv.id = 'markerSaveDialog';
        dialogDiv.style.cssText = `
          position: fixed;
          z-index: 1000;
          width: 400px;
          max-width: 90vw;
          background: rgba(255, 255, 255, 0.95);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 16px;
          box-shadow: 0 12px 32px rgba(0,0,0,0.15);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          overflow: hidden;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
        `;
        
        // í˜„ì¬ í™œì„±í™”ëœ ì¼ì • í•­ëª©ë“¤ ê°€ì ¸ì˜¤ê¸°
        const scheduleItems = getActiveScheduleItems();
        
        // ì¼ì • í•­ëª© ë²„íŠ¼ë“¤ ìƒì„±
        let scheduleButtons = '';
        if (scheduleItems.length === 0) {
          scheduleButtons = '<p style="text-align: center; color: #666; margin: 20px 0;">ë¨¼ì € ì¼ì •ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>';
        } else {
          scheduleItems.forEach(item => {
            scheduleButtons += `<button onclick="saveMarkersToLocation('${item.title}')" style="background: rgba(255, 255, 255, 0.12); color: #000; border: none; border-radius: 12px; padding: 14px 32px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; backdrop-filter: blur(10px); width: 100%; margin-bottom: 8px; min-width: 120px;" onmouseover="this.style.background='rgba(255, 255, 255, 0.18)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'">${item.title}</button>`;
          });
        }
        
        dialogDiv.innerHTML = `
          <div style="padding: 28px 24px 24px 24px;">
            <div style="text-align: center; margin-bottom: 24px;">
              <h3 style="color: #000; margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">ë§ˆì»¤ ì €ì¥ ìœ„ì¹˜ ì„ íƒ</h3>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              ${scheduleButtons}
            </div>
          </div>
        `;
        
        console.log('ëŒ€ì•ˆ ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„± ì™„ë£Œ');
        document.body.appendChild(dialogDiv);
      }
      
      // ë§ˆì»¤ ì €ì¥ ìœ„ì¹˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
      function showMarkerSaveDialog() {
        console.log('showMarkerSaveDialog í•¨ìˆ˜ í˜¸ì¶œë¨');
        
        // ê¸°ì¡´ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ìˆìœ¼ë©´ ì œê±°
        const existingDialog = document.getElementById('markerSaveDialog');
        if (existingDialog) {
          existingDialog.remove();
        }
        
        // í˜„ì¬ í™œì„±í™”ëœ ì¼ì • í•­ëª©ë“¤ ê°€ì ¸ì˜¤ê¸°
        const scheduleItems = getActiveScheduleItems();
        
        // ì¼ì • í•­ëª© ë²„íŠ¼ë“¤ ìƒì„±
        let scheduleButtons = '';
        if (scheduleItems.length === 0) {
          scheduleButtons = '<p style="text-align: center; color: #666; margin: 20px 0;">ë¨¼ì € ì¼ì •ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>';
        } else {
          scheduleItems.forEach(item => {
            scheduleButtons += `<button class="route-save-btn" onclick="saveMarkersToLocation('${item.title}')">${item.title}</button>`;
          });
        }
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
        const dialogDiv = document.createElement('div');
        dialogDiv.id = 'markerSaveDialog';
        dialogDiv.innerHTML = `
          <div style="padding: 28px 24px 24px 24px;">
            <div style="text-align: center; margin-bottom: 24px;">
              <h3 style="color: #000; margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">ë§ˆì»¤ ì €ì¥ ìœ„ì¹˜ ì„ íƒ</h3>
            </div>
            <div class="route-save-options">
              ${scheduleButtons}
            </div>
          </div>
        `;
        
        // ë‹¤ì´ì–¼ë¡œê·¸ë¥¼ ì§€ë„ ìœ„ì— í‘œì‹œ
        console.log('ë‹¤ì´ì–¼ë¡œê·¸ DOMì— ì¶”ê°€:', dialogDiv);
        document.body.appendChild(dialogDiv);
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ìœ„ì¹˜ ì¡°ì • - ëª¨ë°”ì¼ ìµœì í™”
        setTimeout(() => {
          const mapElement = document.getElementById('map');
          const mapRect = mapElement.getBoundingClientRect();
          
          if (isMobile) {
            // ëª¨ë°”ì¼: í™”ë©´ ì¤‘ì•™ì— í‘œì‹œ
            dialogDiv.style.left = '50%';
            dialogDiv.style.transform = 'translateX(-50%)';
            dialogDiv.style.top = '80px';
          } else {
            // ë°ìŠ¤í¬í†±: ì§€ë„ ì¤‘ì•™ì— í‘œì‹œ
            dialogDiv.style.left = (mapRect.width / 2 - 200) + 'px';
            dialogDiv.style.top = (mapRect.height / 2 - 150) + 'px';
            dialogDiv.style.transform = 'none';
          }
          console.log('ë‹¤ì´ì–¼ë¡œê·¸ ìœ„ì¹˜ ì„¤ì • ì™„ë£Œ');
        }, 100);
      }
      
      // ë§ˆì»¤ ì €ì¥ ìœ„ì¹˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
      function closeMarkerSaveDialog() {
        const dialog = document.getElementById('markerSaveDialog');
        if (dialog) {
          dialog.remove();
        }
        
        // ë‹¤ì´ì–¼ë¡œê·¸ê°€ ë‹«í ë•Œ ë§ˆì»¤ ëª¨ë“œê°€ ì™„ì „íˆ ë¹„í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (isMarkerMode) {
          isMarkerMode = false;
          const markerBtn = document.getElementById('topMarkerBtn');
          markerBtn.textContent = 'ë§ˆì»¤ìƒì„±';
          markerBtn.style.background = 'rgba(255, 255, 255, 0.12)';
          markerBtn.style.color = '#1a1a1a';
        }
      }
      
      // ì„ íƒëœ ìœ„ì¹˜ì— ë§ˆì»¤ ì €ì¥
      // ì„ íƒëœ ìœ„ì¹˜ì— ë§ˆì»¤ ì €ì¥ (ê°œì„ ëœ ë²„ì „)
      async function saveMarkersToLocation(location) {
        if (customMarkers.length === 0) {
          updateSyncStatus('ì €ì¥í•  ë§ˆì»¤ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
          return;
        }
        
        // ë™ê¸°í™” ì¤‘ì´ë©´ ë¬´ì‹œ
        if (isSyncing) {
          updateSyncStatus('ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'warning');
          return;
        }
        
        // ë§ˆì»¤ ë°ì´í„° ìƒì„±
        const markerData = {
          id: 'marker_' + Date.now(),
          name: `${location} ë§ˆì»¤`,
          location: location,
          markers: customMarkers.map(marker => ({
            lat: marker.getPosition().lat(),
            lng: marker.getPosition().lng(),
            title: marker.getTitle()
          })),
          createdAt: new Date().toISOString()
        };
        
        try {
          // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
          isSyncing = true;
          updateSyncStatus('ë§ˆì»¤ ì €ì¥ ì¤‘...', 'info');
          
          // Firebaseì— ì €ì¥
          await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
            savedUserMarkers: window.firestore.arrayUnion(markerData),
            lastUpdated: window.firestore.serverTimestamp()
          });
          
          // ì „ì—­ ë³€ìˆ˜ì— ì¶”ê°€
          if (!window.savedUserMarkers) {
            window.savedUserMarkers = [];
          }
          window.savedUserMarkers.push(markerData);
          
          onFirebaseUploadSuccess('ë§ˆì»¤ ì €ì¥');
          
          // ë¡œì»¬ ë°±ì—… ì œê±°: Firestoreë§Œ ì‚¬ìš©
          
          console.log('Firebaseì— ë§ˆì»¤ ì €ì¥ ì™„ë£Œ');
          
        } catch (error) {
          console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', error);
          updateSyncStatus('Firebase ì €ì¥ ì‹¤íŒ¨', 'error');
          
          // ì „ì—­ ë³€ìˆ˜ì— ì¶”ê°€
          if (!window.savedUserMarkers) {
            window.savedUserMarkers = [];
          }
          window.savedUserMarkers.push(markerData);
          
          setTimeout(() => {
            updateSyncStatus('Firebase ì—°ê²° ì‹¤íŒ¨', 'error');
          }, 2000);
        } finally {
          // ë™ê¸°í™” ìƒíƒœ í•´ì œ (ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í—ˆìš©)
          isSyncing = false;
        }
        
        // ì„ì‹œ ë§ˆì»¤ë“¤ ì œê±°
        customMarkers.forEach(marker => {
          marker.setMap(null);
        });
        customMarkers = [];
        
        // ë§ˆì»¤ ëª¨ë“œê°€ ì•„ì§ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ë¹„í™œì„±í™” (ì¤‘ë³µ ë°©ì§€)
        if (isMarkerMode) {
          isMarkerMode = false;
          
          // ë²„íŠ¼ ìƒíƒœ ë³µì›
          const markerBtn = document.getElementById('topMarkerBtn');
          markerBtn.textContent = 'ë§ˆì»¤ìƒì„±';
          markerBtn.style.background = 'rgba(255, 255, 255, 0.12)';
          markerBtn.style.color = '#1a1a1a';
        }
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
        closeMarkerSaveDialog();
        
        // ì €ì¥ëœ ë§ˆì»¤ë“¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        clearAllRenderedMarkers();
        drawAllSavedMarkers();
        
        // ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateMarkerRemoveButtons();
      }
      
      // ì €ì¥ëœ ëª¨ë“  ë§ˆì»¤ ê·¸ë¦¬ê¸°
      function drawAllSavedMarkers() {
        // ê¸°ì¡´ ì €ì¥ëœ ë§ˆì»¤ë“¤ ì œê±°
        if (window.savedUserMarkers) {
          window.savedUserMarkers.forEach(markerGroup => {
            if (markerGroup.markerElements) {
              markerGroup.markerElements.forEach(marker => {
                marker.setMap(null);
              });
            }
          });
        }
        
        // ì €ì¥ëœ ë§ˆì»¤ë“¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        if (window.savedUserMarkers) {
          window.savedUserMarkers.forEach(markerGroup => {
            if (markerGroup.markers && markerGroup.markers.length > 0) {
              markerGroup.markerElements = [];
              
              markerGroup.markers.forEach((markerData, index) => {
                const idKey = (markerGroup && markerGroup.id) ? `${markerGroup.id}-${index}` : null;
                const nameKey = `${markerGroup.name}-${index}`;
                const infoForMarker = markerInfoData
                  ? (idKey && markerInfoData[idKey]) || markerInfoData[nameKey] || null
                  : null;
                const emoji = (infoForMarker && infoForMarker.emoji) ? infoForMarker.emoji : '';
                const useEmoji = !!emoji;
                const markerOptions = {
                  position: new google.maps.LatLng(markerData.lat, markerData.lng),
                  map: map,
                  title: markerData.title || `${markerGroup.name} ${index + 1}`,
                  zIndex: 1000
                };
                if (useEmoji) {
                  markerOptions.icon = {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: 'transparent',
                    fillOpacity: 0,
                    strokeColor: 'transparent',
                    strokeWeight: 0,
                    scale: 12
                  };
                  markerOptions.label = {
                    text: emoji,
                    fontSize: '20px',
                    fontWeight: 'bold'
                  };
                } else {
                  markerOptions.icon = {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: '#8b5cf6',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2,
                    scale: 12
                  };
                  markerOptions.label = {
                    text: (index + 1).toString(),
                    fontSize: '18px',
                    fontWeight: 'bold',
                    color: '#ffffff'
                  };
                }
                const marker = new google.maps.Marker(markerOptions);
                
                // ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ í‘œì‹œ ë° ì¤Œ 15ë¡œ ì¤‘ì‹¬ ì´ë™
                marker.addListener('click', function() {
                  if (isMarkerMode) { addCustomMarker(marker.getPosition()); return; }
                  if (isRouteMode) { addUserRoutePoint(marker.getPosition()); return; }
                  
                  // ì‚¬ìš©ì ë§ˆì»¤ í´ë¦­ í”Œë˜ê·¸ ì„¤ì • (ì •ë³´ì°½ì´ ë‹«íˆì§€ ì•Šë„ë¡)
                  window.searchMarkerClicked = true;
                  showMarkerInfo(markerGroup, markerData, index);
                  
                  // í”Œë˜ê·¸ í•´ì œ (ë‹¤ìŒ í´ë¦­ì„ ìœ„í•´)
                  setTimeout(() => {
                    window.searchMarkerClicked = false;
                  }, 100);
                });
                
                markerGroup.markerElements.push(marker);
              });
            }
          });
        }
      }

      // í˜„ì¬ ì§€ë„ì— ê·¸ë ¤ì§„ ëª¨ë“  ì‚¬ìš©ì ë§ˆì»¤ë¥¼ ì œê±° (ì‹¤ì‹œê°„ ë™ê¸°í™”ìš©)
      function clearAllRenderedMarkers() {
        try {
          (window.savedUserMarkers || []).forEach(function(markerGroup) {
            if (markerGroup && markerGroup.markerElements) {
              markerGroup.markerElements.forEach(function(marker) {
                if (marker) {
                  marker.setMap(null);
                }
              });
            }
          });
        } catch (e) {
          console.warn('ë§ˆì»¤ ìš”ì†Œ ì œê±° ì¤‘ ê²½ê³ :', e);
        }
      }
      
      // Firestore ì €ì¥ìš©ìœ¼ë¡œ ì‚¬ìš©ì ë§ˆì»¤ ë°ì´í„°ë¥¼ ì •ì œ (ë¹„ì§ë ¬í™” í•„ë“œ ì œê±°)
      function sanitizeSavedUserMarkersForFirestore(markers) {
        try {
          return (markers || []).map(function(group) {
            return {
              id: group && group.id ? group.id : undefined,
              name: group && group.name ? group.name : undefined,
              location: group && group.location ? group.location : undefined,
              createdAt: group && group.createdAt ? group.createdAt : undefined,
              markers: Array.isArray(group && group.markers)
                ? group.markers.map(function(m) {
                    return {
                      lat: m && typeof m.lat === 'number' ? m.lat : (m && m.lat ? Number(m.lat) : undefined),
                      lng: m && typeof m.lng === 'number' ? m.lng : (m && m.lng ? Number(m.lng) : undefined),
                      title: (m && m.title) ? m.title : ''
                    };
                  })
                : []
            };
          });
        } catch (e) {
          console.error('ë§ˆì»¤ ë°ì´í„° ì •ì œ ì‹¤íŒ¨:', e);
          return [];
        }
      }
      
      // ë§ˆì»¤ ì •ë³´ í‘œì‹œ
      function showMarkerInfo(markerGroup, markerData, index) {
        // ìƒì„± ëª¨ë“œì—ì„œëŠ” ì •ë³´ì°½ì„ í‘œì‹œí•˜ì§€ ì•ŠìŒ
        if (isMarkerMode || isRouteMode) {
          return;
        }
         // ê¸°ì¡´ ì •ë³´ì°½ì´ ìˆìœ¼ë©´ ì œê±°
         if (window.currentInfoWindow) {
           window.currentInfoWindow.close();
           window.currentInfoWindow = null;
         }
        
        // ì €ì¥ëœ ì •ë³´ë¡œ ì •ë³´ì°½ í‘œì‹œ
        showMarkerInfoWithData(markerGroup.name, index);
        
        // X ë²„íŠ¼ ì œê±°ë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ ì¶”ê°€
        google.maps.event.addListener(window.currentInfoWindow, 'domready', function() {
          const closeBtn = document.querySelector('.gm-ui-hover-effect');
          if (closeBtn) {
            closeBtn.style.display = 'none';
          }
        });
        
        // ë§ˆì»¤ ìœ„ì¹˜ì— ì •ë³´ì°½ í‘œì‹œ
        const marker = markerGroup.markerElements[index];
        window.currentInfoWindow.open(map, marker);
        try {
          const currentZoom = map.getZoom();
          // í˜„ì¬ ì¤Œë ˆë²¨ì´ 15 ë¯¸ë§Œì¼ ë•Œë§Œ ì¤Œë ˆë²¨ 15ë¡œ í™•ëŒ€
          if (currentZoom < 15) {
            map.setZoom(15);
          }
          map.panTo(marker.getPosition());
        } catch (_) {}
      }
      
      // ê²½ë¡œ ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜
      function calculateRouteDistance(path) {
        if (!path || path.length < 2) return 0;
        
        let totalDistance = 0;
        for (let i = 0; i < path.length - 1; i++) {
          const from = path[i];
          const to = path[i + 1];
          
          // ë‘ ì§€ì  ê°„ì˜ ê±°ë¦¬ ê³„ì‚° (ë¯¸í„° ë‹¨ìœ„)
          totalDistance += google.maps.geometry.spherical.computeDistanceBetween(from, to);
        }
        
        return totalDistance;
      }
      
      // ê±°ë¦¬ë¥¼ ì‚¬ìš©ì ì¹œí™”ì  í˜•íƒœë¡œ í¬ë§·
      function formatDistance(distanceInMeters) {
        if (distanceInMeters < 1000) {
          return `${Math.round(distanceInMeters)}m`;
        } else {
          const kilometers = distanceInMeters / 1000;
          if (kilometers < 10) {
            return `${kilometers.toFixed(1)}km`;
          } else {
            return `${Math.round(kilometers)}km`;
          }
        }
      }
      
      // ê²½ë¡œ ì •ë³´ì°½ í‘œì‹œ í•¨ìˆ˜
      function showRouteInfo(route, clickPosition) {
        // ìƒì„± ëª¨ë“œì—ì„œëŠ” ì •ë³´ì°½ì„ í‘œì‹œí•˜ì§€ ì•ŠìŒ
        if (isMarkerMode || isRouteMode) {
          return;
        }
         const path = route.path || route.getPath();
         const distance = calculateRouteDistance(path);
         const formattedDistance = formatDistance(distance);
         
         // ê²½ë¡œ ì „ì²´ê°€ ë³´ì´ë„ë¡ ì§€ë„ ì´ë™
         if (path && path.length >= 2) {
           const bounds = new google.maps.LatLngBounds();
           path.forEach(point => {
             if (point instanceof google.maps.LatLng) {
               bounds.extend(point);
             } else {
               bounds.extend(new google.maps.LatLng(point.lat, point.lng));
             }
           });
           map.fitBounds(bounds);
           
           // ì—¬ë°±ì„ ìœ„í•´ ì•½ê°„ ì¤Œ ì•„ì›ƒ
           setTimeout(() => {
             const currentZoom = map.getZoom();
             if (currentZoom > 2) {
               map.setZoom(currentZoom - 1);
             }
           }, 100);
         }
         
         // ìƒì„± ì¤‘ì¸ ê²½ë¡œì¸ì§€ í™•ì¸ (ì‚­ì œ ë²„íŠ¼ì„ í‘œì‹œí•˜ì§€ ì•ŠìŒ)
         const isTemporaryRoute = route.name === 'ìƒì„± ì¤‘ì¸ ê²½ë¡œ';
         
         // ê²½ë¡œì— ì €ì¥ëœ ì¶”ê°€ ì •ë³´ í‘œì‹œ (ë‚´ìš©/ë§í¬)
         const routeExtra = (routeInfoData && route.id) ? (routeInfoData[route.id] || { content: '', link: '' }) : { content: '', link: '' };
         const hasLink = !!(routeExtra.link);
         const contentLabel = (routeExtra.content && routeExtra.content.trim()) || (hasLink ? routeExtra.link : '');
         const contentText = contentLabel
           ? (hasLink
               ? `<div style=\"margin-top:6px; font-size:12px; line-height:1.4;\"><a href=\"${routeExtra.link}\" target=\"_self\" style=\"color:#2563eb; text-decoration:underline;\">${contentLabel}</a></div>`
               : `<div style=\"margin-top:6px; color:#111827; font-size:12px; line-height:1.4;\">${contentLabel}</div>`)
           : '';
         const info = `
           <div style="padding: 10px; min-width: 180px; position: relative;">
             ${!isTemporaryRoute ? `
               <button onclick="editRouteInfo('${route.id}', '${route.name}')" 
                       style="position: absolute; top: 8px; right: 8px; 
                              background: transparent; color: #3b82f6; border: none; 
                              border-radius: 4px; padding: 4px 8px; font-size: 12px; 
                              cursor: pointer; z-index: 1000;"
                       title="ìˆ˜ì •">ìˆ˜ì •</button>
             ` : ''}
             <p style="margin: 0; font-size: 14px; font-weight: bold; color: #3b82f6; ${!isTemporaryRoute ? 'padding-right: 50px;' : ''}">${formattedDistance}</p>
             ${contentText}
           </div>
         `;
         
         // ê¸°ì¡´ ì •ë³´ì°½ì´ ìˆìœ¼ë©´ ì œê±°
         if (window.currentInfoWindow) {
           window.currentInfoWindow.close();
         }
         
         // ìƒˆ ì •ë³´ì°½ ìƒì„±
         window.currentInfoWindow = new google.maps.InfoWindow({
           content: info,
           position: clickPosition,
           disableAutoPan: false,
           maxWidth: 200
         });
         
         // X ë²„íŠ¼ ì œê±°
         google.maps.event.addListener(window.currentInfoWindow, 'domready', function() {
           const closeBtn = document.querySelector('.gm-ui-hover-effect');
           if (closeBtn) {
             closeBtn.style.display = 'none';
           }
         });
         
         window.currentInfoWindow.open(map);
       }
      
      // Firestore ì €ì¥ìš©ìœ¼ë¡œ ê²½ë¡œ ë°°ì—´ì„ ì •ì œ (UI ì „ìš© í•„ë“œ ì œê±°)
      function sanitizeRoutesForFirestore(routes) {
        try {
          return (routes || []).map(function(r) {
            if (!r) return r;
            var rest = {};
            for (var k in r) {
              if (k !== 'pathElement' && k !== 'dottedPathElement') rest[k] = r[k];
            }
            // pathëŠ” ìˆœìˆ˜ lat/lng ë°°ì—´ë§Œ ìœ ì§€
            var cleanPath = Array.isArray(rest.path)
              ? rest.path.map(function(p){ return { lat: Number(p.lat), lng: Number(p.lng) }; })
              : [];
            rest.path = cleanPath;
            return rest;
          });
        } catch (e) {
          console.error('sanitizeRoutesForFirestore ì‹¤íŒ¨:', e);
          return [];
        }
      }
      
      // ì •ë³´ì°½ì—ì„œ ê²½ë¡œ ì‚­ì œ í•¨ìˆ˜
      async function deleteRouteFromInfo(routeId, routeName) {
        if (!confirm(`"${routeName}" ê²½ë¡œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          return;
        }
        
        console.log('ê²½ë¡œ ì‚­ì œ ì‹œì‘ - isSyncing í”Œë˜ê·¸ ë¬´ì‹œí•˜ê³  ì¦‰ì‹œ ì²˜ë¦¬');
        
        try {
          // ì •ë³´ì°½ ë‹«ê¸°
          if (window.currentInfoWindow) {
            window.currentInfoWindow.close();
            window.currentInfoWindow = null;
          }
          
          // ì €ì¥ëœ ê²½ë¡œë“¤ì—ì„œ í•´ë‹¹ ê²½ë¡œ ì°¾ê¸°
          const routeIndex = savedUserRoutes.findIndex(route => route.id === routeId);
          
          if (routeIndex === -1) {
            alert('ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          
          const route = savedUserRoutes[routeIndex];
          
          console.log('ê²½ë¡œ ì‚­ì œ ì‹œë„:', { routeId, routeName, routeIndex });
          
          // ì§€ë„ì—ì„œ ê²½ë¡œ ì‹œê°ì  ì œê±° (ì¦‰ì‹œ í”¼ë“œë°±ì„ ìœ„í•´)
          if (route.pathElement) {
            route.pathElement.setMap(null);
          }
          if (route.dottedPathElement) {
            route.dottedPathElement.setMap(null);
          }
          
          // Firebase ì €ì¥ìš© ë°°ì—´ ìƒì„± (ë¡œì»¬ ë°°ì—´ì€ ì‹¤ì‹œê°„ ë™ê¸°í™”ë¡œë§Œ ì—…ë°ì´íŠ¸)
          const updatedRoutes = [...savedUserRoutes];
          updatedRoutes.splice(routeIndex, 1);
          
          console.log('ë¡œì»¬ ë°°ì—´ ë³´ì¡´ - ì‹¤ì‹œê°„ ë™ê¸°í™” ê°ì§€ë¥¼ ìœ„í•´:', {
            ë¡œì»¬ë°°ì—´ìˆ˜: savedUserRoutes.length,
            Firebaseì €ì¥ë°°ì—´ìˆ˜: updatedRoutes.length
          });
          
          // Firebaseì— ì—…ë°ì´íŠ¸
          if (window.db && window.firestore) {
            console.log('Firebaseì— ê²½ë¡œ ì‚­ì œ ì €ì¥ ì‹œë„ ì¤‘...', {
              routeId,
              routeName,
              í˜„ì¬ê²½ë¡œìˆ˜: savedUserRoutes.length,
              ì €ì¥í• ê²½ë¡œìˆ˜: updatedRoutes.length
            });
            
            const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
            const sanitizedRoutes = sanitizeRoutesForFirestore(updatedRoutes);
            await window.firestore.updateDoc(userDocRef, {
              savedUserRoutes: sanitizedRoutes,
              lastUpdated: window.firestore.serverTimestamp()
            });
            
            console.log('Firebase ê²½ë¡œ ì‚­ì œ ì €ì¥ ì„±ê³µ - ì‹¤ì‹œê°„ ë™ê¸°í™”ë¡œ UI ì—…ë°ì´íŠ¸ ì˜ˆì •');
            
            // UI ì—…ë°ì´íŠ¸ëŠ” ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ í†µí•´ ì²˜ë¦¬ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” í•˜ì§€ ì•ŠìŒ
            console.log('ë¡œì»¬ UI ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€ - Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ëŒ€ê¸° ì¤‘...');
          } else {
            console.warn('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ - ê²½ë¡œ ì‚­ì œê°€ ì €ì¥ë˜ì§€ ì•ŠìŒ');
            alert('Firebase ì—°ê²°ì´ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê²½ë¡œ ì‚­ì œê°€ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          }
          
        } catch (error) {
          console.error('ê²½ë¡œ ì‚­ì œ ì‹¤íŒ¨:', error);
          console.error('Error details:', {
            code: error.code,
            message: error.message,
            stack: error.stack
          });
          alert(`ê²½ë¡œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
        }
      }
      
      // Firebase ì—°ê²° ìƒíƒœ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
      async function testFirebaseConnection() {
        try {
          console.log('Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...');
          console.log('window.db:', !!window.db);
          console.log('window.firestore:', !!window.firestore);
          
          if (window.db && window.firestore) {
            const testDoc = window.firestore.doc(window.db, 'users', 'currentUser');
            const docSnap = await window.firestore.getDoc(testDoc);
            console.log('Firebase ì—°ê²° ì„±ê³µ, ë¬¸ì„œ ì¡´ì¬:', docSnap.exists());
            return true;
          } else {
            console.error('Firebase ê°ì²´ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
            return false;
          }
        } catch (error) {
          console.error('Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
          return false;
        }
      }
      
      // ê²½ë¡œ ì •ë³´ ìˆ˜ì • ë‹¤ì´ì–¼ë¡œê·¸
      function editRouteInfo(routeId, routeName) {
        // í˜„ì¬ ì €ì¥ëœ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const current = (routeInfoData && routeInfoData[routeId]) ? routeInfoData[routeId] : { content: '', link: '' };
        const isMobileView = window.innerWidth <= 768;
        const dialogWidth = isMobileView ? Math.min(280, window.innerWidth - 40) : 320;
        const maxWidth = isMobileView ? '90vw' : '400px';
        
        const html = `
          <div style="padding: 28px 24px 24px 24px; width: ${dialogWidth}px; max-width: ${maxWidth}; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
            <div style="text-align: center; margin-bottom: 24px;">
              <h3 style="color: #000; margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">ê²½ë¡œ ìˆ˜ì •</h3>
            </div>
            <div style="margin-bottom: 16px;">
              <textarea id="route-edit-content" rows="${isMobileView ? '3':'4'}" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%; padding: 16px 18px; border: none; border-radius: 12px; font-size: 15px; background: rgba(255, 255, 255, 0.12); color: #000; box-sizing: border-box; outline: none; transition: all 0.2s ease; backdrop-filter: blur(10px); resize:vertical;" onfocus="this.style.background='rgba(255, 255, 255, 0.18)'" onblur="this.style.background='rgba(255, 255, 255, 0.12)'">${(current.content||'').replace(/"/g,'&quot;')}</textarea>
            </div>
            <div style="margin-bottom: 24px;">
              <input id="route-edit-link" type="text" placeholder="ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš” (https://...)" value="${(current.link||'').replace(/"/g,'&quot;')}" style="width:100%; padding: 16px 18px; border: none; border-radius: 12px; font-size: 15px; background: rgba(255, 255, 255, 0.12); color: #000; box-sizing: border-box; outline: none; transition: all 0.2s ease; backdrop-filter: blur(10px);" onfocus="this.style.background='rgba(255, 255, 255, 0.18)'" onblur="this.style.background='rgba(255, 255, 255, 0.12)'" />
            </div>
            <div style="display:flex; gap:12px; ${isMobileView ? 'flex-direction:column;':''}">
              <button onclick="saveRouteInfo('${routeId}', '${routeName}')" style="flex: 1; background: rgba(255, 255, 255, 0.12); color: #000; border: none; border-radius: 12px; padding: 14px 16px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255, 255, 255, 0.18)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'">ì €ì¥</button>
              <button onclick="deleteRouteFromInfo('${routeId}', '${routeName}')" style="flex: 1; background: rgba(255, 255, 255, 0.12); color: #000; border: none; border-radius: 12px; padding: 14px 16px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255, 255, 255, 0.18)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'">ì‚­ì œ</button>
            </div>
          </div>
        `;
        
        if (window.currentInfoWindow) {
          window.currentInfoWindow.setContent(html);
        }
      }
      
      // ê²½ë¡œ ì •ë³´ ì €ì¥
      async function saveRouteInfo(routeId, routeName) {
        try {
          const contentInput = document.getElementById('route-edit-content');
          const linkInput = document.getElementById('route-edit-link');
          const newContent = (contentInput && contentInput.value) || '';
          const newLink = (linkInput && linkInput.value) || '';
          
          // ë¡œì»¬ ë°˜ì˜
          routeInfoData = routeInfoData || {};
          routeInfoData[routeId] = { content: newContent, link: newLink };
          
          // Firebase ë°˜ì˜
          if (window.db && window.firestore) {
            const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
            await window.firestore.updateDoc(userDocRef, {
              routeInfoData: routeInfoData,
              lastUpdated: window.firestore.serverTimestamp()
            });
          }
          
          // ì €ì¥ í›„ í˜„ì¬ ì •ë³´ì°½ì— ë‚´ìš© í‘œì‹œë¡œ ê°±ì‹ 
          const route = savedUserRoutes.find(r => r.id === routeId) || { id: routeId, name: routeName, path: [] };
          showRouteInfo(route, null);
        } catch (e) {
          console.error('ê²½ë¡œ ì •ë³´ ì €ì¥ ì‹¤íŒ¨:', e);
          alert('ê²½ë¡œ ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }
      // ë§ˆì»¤ ì •ë³´ ìˆ˜ì • í•¨ìˆ˜
      function editMarkerInfo(markerGroupName, index) {
        // group id ìš°ì„  í‚¤ ì‚¬ìš© (í•˜ìœ„ í˜¸í™˜ìœ¼ë¡œ name-index ìœ ì§€)
        const savedMarkers = window.savedUserMarkers || [];
        const group = savedMarkers.find(g => g && (g.name === markerGroupName));
        const idKey = (group && group.id) ? `${group.id}-${index}` : null;
        const nameKey = `${markerGroupName}-${index}`;
        const markerId = idKey || nameKey;
        
        // í˜„ì¬ ì €ì¥ëœ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ë˜ëŠ” ê¸°ë³¸ê°’ ì„¤ì • (id ìš°ì„ , name ëŒ€ì²´)
        const baseInfo = (idKey && markerInfoData[idKey]) || markerInfoData[nameKey] || null;
        const currentInfo = baseInfo || {
          title: markerGroupName,
          content: '',
          link: ''
        };
        const currentEmoji = (baseInfo && baseInfo.emoji) ? baseInfo.emoji : '';
        
        // í™”ë©´ í¬ê¸°ì— ë”°ë¥¸ ë‹¤ì´ì–¼ë¡œê·¸ í¬ê¸° ì¡°ì •
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const isMobileView = viewportWidth <= 768;
        
        // ëª¨ë°”ì¼ì—ì„œëŠ” ë” ì‘ì€ í¬ê¸°ë¡œ, ë°ìŠ¤í¬í†±ì—ì„œëŠ” ì ì ˆí•œ í¬ê¸°ë¡œ ì¡°ì •
        const dialogWidth = isMobileView ? Math.min(280, viewportWidth - 40) : 320;
        const maxWidth = isMobileView ? '90vw' : '400px';
        
        const editInfo = `
          <div style="
            padding: 28px 24px 24px 24px; 
            width: ${dialogWidth}px; 
            max-width: ${maxWidth};
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          ">
            <div style="text-align: center; margin-bottom: 24px;">
              <h3 style="color: #000; margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">ë§ˆì»¤ ìˆ˜ì •</h3>
            </div>
            <div style="margin-bottom: 16px;">
              <input type="text" id="edit-title-${markerId}" value="${currentInfo.title}" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                     style="width: 100%; padding: 16px 18px; border: none; border-radius: 12px; font-size: 15px; background: rgba(255, 255, 255, 0.12); color: #000; box-sizing: border-box; outline: none; transition: all 0.2s ease; backdrop-filter: blur(10px);"
                     onfocus="this.style.background='rgba(255, 255, 255, 0.18)'"
                     onblur="this.style.background='rgba(255, 255, 255, 0.12)'">
            </div>
            <div style="margin-bottom: 16px;">
              <textarea id="edit-content-${markerId}" rows="${isMobileView ? '2' : '3'}" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
                        style="width: 100%; padding: 16px 18px; border: none; border-radius: 12px; font-size: 15px; background: rgba(255, 255, 255, 0.12); color: #000; box-sizing: border-box; outline: none; transition: all 0.2s ease; backdrop-filter: blur(10px); resize: vertical; min-height: ${isMobileView ? '60px' : '80px'};max-height: ${isMobileView ? '120px' : '150px'};"
                        onfocus="this.style.background='rgba(255, 255, 255, 0.18)'"
                        onblur="this.style.background='rgba(255, 255, 255, 0.12)'">${currentInfo.content}</textarea>
            </div>
            <div style="margin-bottom: 16px;">
              <input type="text" id="edit-link-${markerId}" value="${currentInfo.link}" placeholder="ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš” (https://...)"
                     style="width: 100%; padding: 16px 18px; border: none; border-radius: 12px; font-size: 15px; background: rgba(255, 255, 255, 0.12); color: #000; box-sizing: border-box; outline: none; transition: all 0.2s ease; backdrop-filter: blur(10px);"
                     onfocus="this.style.background='rgba(255, 255, 255, 0.18)'"
                     onblur="this.style.background='rgba(255, 255, 255, 0.12)'">
            </div>
            <div style="margin-bottom: 24px;">
              <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: center;">
                <button type="button" onclick="selectEmoji('${markerId}', '')" style="padding:8px 12px; background: ${!currentEmoji ? 'rgba(255, 255, 255, 0.25)' : 'rgba(255, 255, 255, 0.12)'}; border: none; border-radius:8px; cursor:pointer; transition: all 0.2s ease; font-size: 14px; color:#000;">ë²ˆí˜¸</button>
                <button type="button" onclick="selectEmoji('${markerId}', 'ğŸ›ï¸')" style="padding:8px 12px; background: ${currentEmoji === 'ğŸ›ï¸' ? 'rgba(255, 255, 255, 0.25)' : 'rgba(255, 255, 255, 0.12)'}; border: none; border-radius:8px; cursor:pointer; transition: all 0.2s ease; font-size: 18px;">ğŸ›ï¸</button>
                <button type="button" onclick="selectEmoji('${markerId}', 'ğŸ½ï¸')" style="padding:8px 12px; background: ${currentEmoji === 'ğŸ½ï¸' ? 'rgba(255, 255, 255, 0.25)' : 'rgba(255, 255, 255, 0.12)'}; border: none; border-radius:8px; cursor:pointer; transition: all 0.2s ease; font-size: 18px;">ğŸ½ï¸</button>
                <button type="button" onclick="selectEmoji('${markerId}', 'ğŸ¥¤')" style="padding:8px 12px; background: ${currentEmoji === 'ğŸ¥¤' ? 'rgba(255, 255, 255, 0.25)' : 'rgba(255, 255, 255, 0.12)'}; border: none; border-radius:8px; cursor:pointer; transition: all 0.2s ease; font-size: 18px;">ğŸ¥¤</button>
                <button type="button" onclick="selectEmoji('${markerId}', 'ğŸ“·')" style="padding:8px 12px; background: ${currentEmoji === 'ğŸ“·' ? 'rgba(255, 255, 255, 0.25)' : 'rgba(255, 255, 255, 0.12)'}; border: none; border-radius:8px; cursor:pointer; transition: all 0.2s ease; font-size: 18px;">ğŸ“·</button>
                <button type="button" onclick="selectEmoji('${markerId}', 'ğŸ›’')" style="padding:8px 12px; background: ${currentEmoji === 'ğŸ›’' ? 'rgba(255, 255, 255, 0.25)' : 'rgba(255, 255, 255, 0.12)'}; border: none; border-radius:8px; cursor:pointer; transition: all 0.2s ease; font-size: 18px;">ğŸ›’</button>
                <button type="button" onclick="selectEmoji('${markerId}', 'ğŸŒ³')" style="padding:8px 12px; background: ${currentEmoji === 'ğŸŒ³' ? 'rgba(255, 255, 255, 0.25)' : 'rgba(255, 255, 255, 0.12)'}; border: none; border-radius:8px; cursor:pointer; transition: all 0.2s ease; font-size: 18px;">ğŸŒ³</button>
                <button type="button" onclick="selectEmoji('${markerId}', 'ğŸšŒ')" style="padding:8px 12px; background: ${currentEmoji === 'ğŸšŒ' ? 'rgba(255, 255, 255, 0.25)' : 'rgba(255, 255, 255, 0.12)'}; border: none; border-radius:8px; cursor:pointer; transition: all 0.2s ease; font-size: 18px;">ğŸšŒ</button>
              </div>
            </div>
            <div style="display: flex; gap: 12px; ${isMobileView ? 'flex-direction: column;' : ''}">
              <button onclick="saveMarkerInfo('${markerGroupName}', ${index})" 
                      style="flex: 1; background: rgba(255, 255, 255, 0.12); color: #000; border: none; border-radius: 12px; padding: 14px 16px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; backdrop-filter: blur(10px);"
                      onmouseover="this.style.background='rgba(255, 255, 255, 0.18)'"
                      onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'">
                ì €ì¥
              </button>
              <button onclick="deleteMarkerFromEdit('${markerGroupName}', ${index})" 
                      style="flex: 1; background: rgba(255, 255, 255, 0.12); color: #000; border: none; border-radius: 12px; padding: 14px 16px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; backdrop-filter: blur(10px);"
                      onmouseover="this.style.background='rgba(255, 255, 255, 0.18)'"
                      onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'">
                ì‚­ì œ
              </button>
            </div>
          </div>
        `;
        
        // ì •ë³´ì°½ ë‚´ìš© ì—…ë°ì´íŠ¸ ë° ì˜µì…˜ ì„¤ì •
        if (window.currentInfoWindow) {
          window.currentInfoWindow.setContent(editInfo);
          
          // ëª¨ë°”ì¼ì—ì„œ InfoWindow ì˜µì…˜ ì¡°ì •
          if (isMobileView) {
            window.currentInfoWindow.setOptions({
              maxWidth: Math.min(dialogWidth + 20, viewportWidth - 20),
              pixelOffset: new google.maps.Size(0, -10),
              disableAutoPan: false
            });
          } else {
            window.currentInfoWindow.setOptions({
              maxWidth: 400,
              disableAutoPan: false
            });
          }
          
          // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ ë° ì •ë³´ì°½ ìœ„ì¹˜ ì¡°ì •
          setTimeout(() => {
            const titleInput = document.getElementById(`edit-title-${markerId}`);
            if (titleInput) {
              titleInput.focus();
              titleInput.select();
            }
            
            // ì •ë³´ì°½ì´ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ìœ„ì¹˜ ë³´ì •
            if (window.currentInfoWindow && map) {
              const markerPosition = window.currentInfoWindow.getPosition();
              if (markerPosition) {
                // í™”ë©´ ì¤‘ì•™ì— ê°€ê¹ê²Œ ì´ë™í•˜ì—¬ ì •ë³´ì°½ì´ ì˜ë¦¬ì§€ ì•Šë„ë¡ í•¨
                const bounds = map.getBounds();
                if (bounds && !bounds.contains(markerPosition)) {
                  map.panTo(markerPosition);
                } else {
                  // ë§ˆì»¤ê°€ í™”ë©´ ê°€ì¥ìë¦¬ì— ìˆìœ¼ë©´ ì¤‘ì•™ìª½ìœ¼ë¡œ ì‚´ì§ ì´ë™
                  const center = map.getCenter();
                  const lat = markerPosition.lat();
                  const lng = markerPosition.lng();
                  const centerLat = center.lat();
                  const centerLng = center.lng();
                  
                  // ë§ˆì»¤ê°€ ê°€ì¥ìë¦¬ì— ìˆìœ¼ë©´ ì¤‘ì•™ ìª½ìœ¼ë¡œ ì¡°ì •
                  const adjustedLat = lat + (centerLat - lat) * 0.1;
                  const adjustedLng = lng + (centerLng - lng) * 0.1;
                  
                  map.panTo(new google.maps.LatLng(adjustedLat, adjustedLng));
                }
              }
            }
          }, 150);
        }
      }
      // ë§ˆì»¤ ì •ë³´ ì €ì¥ í•¨ìˆ˜
      // ì´ëª¨ì§€ ì„ íƒ í•¨ìˆ˜
      function selectEmoji(markerId, emoji) {
        // ì„ íƒëœ ì´ëª¨ì§€ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
        window.selectedEmoji = window.selectedEmoji || {};
        window.selectedEmoji[markerId] = emoji;
        
        // UI ì—…ë°ì´íŠ¸ - ëª¨ë“  ì´ëª¨ì§€ ë²„íŠ¼ì˜ ë°°ê²½ì„ ë¦¬ì…‹í•˜ê³  ì„ íƒëœ ê²ƒë§Œ í•˜ì´ë¼ì´íŠ¸
        const buttons = document.querySelectorAll(`button[onclick*="selectEmoji('${markerId}'"]`);
        buttons.forEach(button => {
          if (button.onclick.toString().includes(`'${emoji}'`)) {
            button.style.background = 'rgba(255, 255, 255, 0.25)';
          } else {
            button.style.background = 'rgba(255, 255, 255, 0.12)';
          }
        });
        
        // ë§ˆì»¤ ì•„ì´ì½˜ì„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        updateMarkerIcon(markerId, emoji);
      }
      
      // ë§ˆì»¤ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateMarkerIcon(markerId, emoji) {
        const savedMarkers = window.savedUserMarkers || [];
        
        // markerIdë¡œ í•´ë‹¹ ë§ˆì»¤ ì°¾ê¸°
        for (let group of savedMarkers) {
          if (group && group.markerElements) {
            for (let i = 0; i < group.markerElements.length; i++) {
              const currentMarkerId = group.id ? `${group.id}-${i}` : `${group.name}-${i}`;
              if (currentMarkerId === markerId) {
                const marker = group.markerElements[i];
                if (marker) {
                  // ìƒˆ ì•„ì´ì½˜ ì„¤ì •
                  const iconUrl = emoji ? 
                    `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"><text x="12" y="20" font-family="Arial, sans-serif" font-size="20" text-anchor="middle">${emoji}</text></svg>`)}` :
                    `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"><circle cx="12" cy="12" r="8" fill="#8b5cf6"/><text x="12" y="17" font-family="Arial, sans-serif" font-size="12" fill="white" text-anchor="middle">${i + 1}</text></svg>`)}`;
                  
                  marker.setIcon({
                    url: iconUrl,
                    scaledSize: new google.maps.Size(32, 32),
                    anchor: new google.maps.Point(16, 16)
                  });
                  return;
                }
              }
            }
          }
        }
      }

      async function saveMarkerInfo(markerGroupName, index) {
        // group id ìš°ì„  í‚¤ ì‚¬ìš© (í•˜ìœ„ í˜¸í™˜ìœ¼ë¡œ name-index ìœ ì§€)
        const savedMarkers = window.savedUserMarkers || [];
        const group = savedMarkers.find(g => g && (g.name === markerGroupName));
        const markerId = (group && group.id) ? `${group.id}-${index}` : `${markerGroupName}-${index}`;
        
        // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
        const titleInput = document.getElementById(`edit-title-${markerId}`);
        const contentInput = document.getElementById(`edit-content-${markerId}`);
        const linkInput = document.getElementById(`edit-link-${markerId}`);
        
        if (!titleInput || !contentInput || !linkInput) {
          alert('ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        // ì„ íƒëœ ì´ëª¨ì§€ ê°€ì ¸ì˜¤ê¸°
        const selectedEmoji = window.selectedEmoji && window.selectedEmoji[markerId] !== undefined ? 
                             window.selectedEmoji[markerId] : 
                             (markerInfoData[markerId] && markerInfoData[markerId].emoji) || '';
        
        const newInfo = {
          title: titleInput.value.trim() || markerGroupName,
          content: contentInput.value.trim(),
          link: linkInput.value.trim(),
          emoji: selectedEmoji
        };
        
        // ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥
        markerInfoData[markerId] = newInfo;
        
        try {
          // Firebaseì— ì €ì¥
          if (window.db && window.firestore) {
            console.log('Firebase ì €ì¥ ì‹œë„ ì¤‘...', { markerId, newInfo });
            console.log('ì €ì¥í•  ì „ì²´ markerInfoData:', markerInfoData);
            const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
            await window.firestore.updateDoc(userDocRef, {
              markerInfoData: markerInfoData,
              lastUpdated: window.firestore.serverTimestamp()
            });
            console.log('Firebase ì €ì¥ ì„±ê³µ - ì‹¤ì‹œê°„ ë™ê¸°í™” ëŒ€ê¸° ì¤‘...');
            
            // ì €ì¥ ì§í›„ ì ì‹œ ëŒ€ê¸°í•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í™•ì¸
            setTimeout(() => {
              console.log('ì €ì¥ í›„ í˜„ì¬ markerInfoData:', markerInfoData);
            }, 1000);
          } else {
            console.warn('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:', { 
              db: !!window.db, 
              firestore: !!window.firestore 
            });
            alert('Firebase ì—°ê²°ì´ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            return;
          }
          
          // ì„±ê³µ ë©”ì‹œì§€
          console.log('ë§ˆì»¤ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
          onFirebaseUploadSuccess('ë§ˆì»¤ ì •ë³´');
          
          // ì •ë³´ì°½ì„ ì¼ë°˜ ë³´ê¸° ëª¨ë“œë¡œ ë˜ëŒë¦¬ê¸°
          showMarkerInfoWithData(markerGroupName, index);

          // ì €ì¥ ì§í›„ ì§€ë„ìƒì˜ ë§ˆì»¤ ë¼ë²¨/ì•„ì´ì½˜ ì¦‰ì‹œ ê°±ì‹ 
          try {
            const savedMarkers = window.savedUserMarkers || [];
            const group = savedMarkers.find(g => g && g.name === markerGroupName);
            if (group && group.markerElements && group.markerElements[index]) {
              const markerEl = group.markerElements[index];
              if (newInfo.emoji) {
                markerEl.setIcon({
                  path: google.maps.SymbolPath.CIRCLE,
                  fillColor: 'transparent',
                  fillOpacity: 0,
                  strokeColor: 'transparent',
                  strokeWeight: 0,
                  scale: 12
                });
                markerEl.setLabel({
                  text: newInfo.emoji,
                  fontSize: '20px',
                  fontWeight: 'bold'
                });
              } else {
                markerEl.setIcon({
                  path: google.maps.SymbolPath.CIRCLE,
                  fillColor: '#8b5cf6',
                  fillOpacity: 1,
                  strokeColor: '#ffffff',
                  strokeWeight: 2,
                  scale: 12
                });
                markerEl.setLabel({
                  text: (index + 1).toString(),
                  fontSize: '18px',
                  fontWeight: 'bold',
                  color: '#ffffff'
                });
              }
            }
          } catch (_) {}
          
        } catch (error) {
          console.error('ë§ˆì»¤ ì •ë³´ ì €ì¥ ì‹¤íŒ¨:', error);
          console.error('Error details:', {
            code: error.code,
            message: error.message,
            stack: error.stack
          });
          alert(`ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
        }
      }
      
      // ë§ˆì»¤ ìˆ˜ì • ì·¨ì†Œ í•¨ìˆ˜
      function cancelMarkerEdit(markerGroupName, index) {
        // ì •ë³´ì°½ì„ ì¼ë°˜ ë³´ê¸° ëª¨ë“œë¡œ ë˜ëŒë¦¬ê¸°
        showMarkerInfoWithData(markerGroupName, index);
      }
      // í¸ì§‘ ëª¨ë“œì—ì„œ ë§ˆì»¤ ì‚­ì œ í•¨ìˆ˜
      async function deleteMarkerFromEdit(markerGroupName, index) {
        if (!confirm('ì´ ë§ˆì»¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
        
        console.log('ë§ˆì»¤ ì‚­ì œ ì‹œì‘ - isSyncing í”Œë˜ê·¸ ë¬´ì‹œí•˜ê³  ì¦‰ì‹œ ì²˜ë¦¬');
        
        try {
          // ì •ë³´ì°½ ë‹«ê¸°
          if (window.currentInfoWindow) {
            window.currentInfoWindow.close();
            window.currentInfoWindow = null;
          }
          
          // ì €ì¥ëœ ë§ˆì»¤ë“¤ì—ì„œ í•´ë‹¹ ë§ˆì»¤ ê·¸ë£¹ ì°¾ê¸°
          const savedMarkers = window.savedUserMarkers || [];
          const markerGroupIndex = savedMarkers.findIndex(group => group.name === markerGroupName);
          
          if (markerGroupIndex === -1) {
            alert('ë§ˆì»¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          
          const markerGroup = savedMarkers[markerGroupIndex];
          
          // í•´ë‹¹ ì¸ë±ìŠ¤ì˜ ë§ˆì»¤ë§Œ ì‚­ì œ
          if (markerGroup.markerElements && markerGroup.markerElements[index]) {
            console.log('ë§ˆì»¤ ì‚­ì œ ì „ ë°ì´í„° êµ¬ì¡°:', {
              markerElements: markerGroup.markerElements.length,
              locations: markerGroup.locations?.length || 0,
              markers: markerGroup.markers?.length || 0
            });
            
            // ì§€ë„ì—ì„œ ë§ˆì»¤ ì œê±° (ì¦‰ì‹œ í”¼ë“œë°±ì„ ìœ„í•´)
            markerGroup.markerElements[index].setMap(null);
            
            console.log('ì§€ë„ì—ì„œë§Œ ë§ˆì»¤ ì œê±° - ë¡œì»¬ ë°ì´í„° ë³´ì¡´í•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” ê°ì§€ ìœ ì§€');
            
            // Firebase ì €ì¥ìš© ë°ì´í„° ìƒì„± (ë¡œì»¬ ë°ì´í„°ëŠ” ì‹¤ì‹œê°„ ë™ê¸°í™”ë¡œë§Œ ì—…ë°ì´íŠ¸)
            const updatedMarkers = [...savedMarkers];
            const updatedMarkerGroup = { ...updatedMarkers[markerGroupIndex] };
            
            // ë§ˆì»¤ ê·¸ë£¹ ë³µì‚¬ë³¸ì—ì„œ ì‚­ì œ ì²˜ë¦¬
            if (updatedMarkerGroup.markerElements) {
              updatedMarkerGroup.markerElements = [...updatedMarkerGroup.markerElements];
              updatedMarkerGroup.markerElements.splice(index, 1);
            }
            if (updatedMarkerGroup.locations) {
              updatedMarkerGroup.locations = [...updatedMarkerGroup.locations];
              updatedMarkerGroup.locations.splice(index, 1);
            }
            if (updatedMarkerGroup.markers) {
              updatedMarkerGroup.markers = [...updatedMarkerGroup.markers];
              updatedMarkerGroup.markers.splice(index, 1);
            }
            
            // ë§ˆì»¤ ì •ë³´ ë°ì´í„° ë³µì‚¬ë³¸ ìƒì„±
            const updatedMarkerInfoData = { ...markerInfoData };
            const groupForId = (window.savedUserMarkers || []).find(g => g && (g.name === markerGroupName));
            const markerId = (groupForId && groupForId.id) ? `${groupForId.id}-${index}` : `${markerGroupName}-${index}`;
            delete updatedMarkerInfoData[markerId];
            
            // ì¸ë±ìŠ¤ ì¬ì •ë ¬
            const remainingCount = updatedMarkerGroup.markers?.length || updatedMarkerGroup.locations?.length || 0;
            for (let i = index; i < remainingCount; i++) {
              const oldKey = (groupForId && groupForId.id) ? `${groupForId.id}-${i + 1}` : `${markerGroupName}-${i + 1}`;
              const newKey = (groupForId && groupForId.id) ? `${groupForId.id}-${i}` : `${markerGroupName}-${i}`;
              if (updatedMarkerInfoData[oldKey]) {
                updatedMarkerInfoData[newKey] = updatedMarkerInfoData[oldKey];
                delete updatedMarkerInfoData[oldKey];
              }
            }
            
            // ë§ˆì»¤ ê·¸ë£¹ì´ ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´ ì‚­ì œ
            const isEmpty = (updatedMarkerGroup.markers?.length || 0) === 0 && 
                           (updatedMarkerGroup.locations?.length || 0) === 0;
            if (isEmpty) {
              console.log('ë§ˆì»¤ ê·¸ë£¹ì´ ë¹„ì–´ìˆì–´ ì „ì²´ ì‚­ì œ:', markerGroupName);
              updatedMarkers.splice(markerGroupIndex, 1);
            } else {
              updatedMarkers[markerGroupIndex] = updatedMarkerGroup;
            }
            
            // Firebaseì— ì—…ë°ì´íŠ¸ (ì§ë ¬í™” ê°€ëŠ¥í•œ ë°ì´í„°ë§Œ ì „ì†¡)
            if (window.db && window.firestore) {
              console.log('Firebaseì— ë§ˆì»¤ ì‚­ì œ ì €ì¥ ì‹œë„ ì¤‘...', {
                markerGroupName,
                index,
                deletedMarkerId: markerId,
                í˜„ì¬ë§ˆì»¤ìˆ˜: savedMarkers.length,
                ì €ì¥í• ë§ˆì»¤ìˆ˜: updatedMarkers.length,
                updatedMarkerInfoData
              });
              
              const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
              const sanitizedSavedUserMarkers = sanitizeSavedUserMarkersForFirestore(updatedMarkers);
              await window.firestore.updateDoc(userDocRef, {
                savedUserMarkers: sanitizedSavedUserMarkers,
                markerInfoData: updatedMarkerInfoData,
                lastUpdated: window.firestore.serverTimestamp()
              });
              
              console.log('Firebase ë§ˆì»¤ ì‚­ì œ ì €ì¥ ì„±ê³µ - ì‹¤ì‹œê°„ ë™ê¸°í™”ë¡œ UI ì—…ë°ì´íŠ¸ ì˜ˆì •');
            
            // UI ì—…ë°ì´íŠ¸ëŠ” ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ í†µí•´ ì²˜ë¦¬ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” í•˜ì§€ ì•ŠìŒ
            console.log('ë¡œì»¬ UI ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€ - Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ëŒ€ê¸° ì¤‘...');
            } else {
              console.warn('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ - ë§ˆì»¤ ì‚­ì œê°€ ì €ì¥ë˜ì§€ ì•ŠìŒ');
              alert('Firebase ì—°ê²°ì´ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë§ˆì»¤ ì‚­ì œê°€ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
            
          } else {
            alert('ì‚­ì œí•  ë§ˆì»¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
          
        } catch (error) {
          console.error('ë§ˆì»¤ ì‚­ì œ ì‹¤íŒ¨:', error);
          alert('ë§ˆì»¤ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }
      
      // ì €ì¥ëœ ì •ë³´ë¡œ ë§ˆì»¤ ì •ë³´ì°½ í‘œì‹œ
      function showMarkerInfoWithData(markerGroupName, index) {
        // group id ìš°ì„  í‚¤ ì‚¬ìš©
        const savedMarkers = window.savedUserMarkers || [];
        const group = savedMarkers.find(g => g && (g.name === markerGroupName));
        const markerId = (group && group.id) ? `${group.id}-${index}` : `${markerGroupName}-${index}`;
        const savedInfo = markerInfoData[markerId] || {
          title: markerGroupName,
          content: '',
          link: ''
        };
        
        // ë‚´ìš©ê³¼ ë§í¬ ì²˜ë¦¬
        let contentDisplay = '';
        if (savedInfo.content) {
          if (savedInfo.link && savedInfo.link.trim()) {
            // ë§í¬ê°€ ìˆìœ¼ë©´ ë‚´ìš© í…ìŠ¤íŠ¸ì— ë§í¬ ì—°ê²°
            const validLink = savedInfo.link.startsWith('http') ? savedInfo.link : `https://${savedInfo.link}`;
            contentDisplay = `<p style="margin: 5px 0;">
              <span onclick="openUserItemLink('${validLink}')" 
                    style="color: #333; text-decoration: none; cursor: pointer; border-bottom: 1px dotted #3b82f6;"
                    onmouseover="this.style.color='#3b82f6'; this.style.textDecoration='underline';"
                    onmouseout="this.style.color='#333'; this.style.textDecoration='none';">${savedInfo.content}</span>
            </p>`;
          } else {
            // ë§í¬ê°€ ì—†ìœ¼ë©´ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
            contentDisplay = `<p style="margin: 5px 0; color: #333;">${savedInfo.content}</p>`;
          }
        }
        
        const info = `
          <div style="padding: 10px; min-width: 200px; position: relative;">
            <button onclick="editMarkerInfo('${markerGroupName}', ${index})" 
                    style="position: absolute; top: 8px; right: 8px; 
                           background: transparent; color: #8b5cf6; border: none; 
                           border-radius: 4px; padding: 4px 8px; font-size: 12px; 
                           cursor: pointer; z-index: 1000;"
                    title="ìˆ˜ì •">ìˆ˜ì •</button>
            <h4 style="margin: 0 0 10px 0; color: #8b5cf6; padding-right: 50px;">${savedInfo.title}</h4>
            ${contentDisplay}
          </div>
        `;
        
        if (window.currentInfoWindow) {
          window.currentInfoWindow.setContent(info);
        } else {
          // ìƒˆ ì •ë³´ì°½ ìƒì„±
          window.currentInfoWindow = new google.maps.InfoWindow({
            content: info,
            disableAutoPan: false,
            maxWidth: 300,
            pixelOffset: new google.maps.Size(0, -10)
          });
        }
      }
      
      // ì €ì¥ëœ ëª¨ë“  ê²½ë¡œ ê·¸ë¦¬ê¸°
      function drawAllSavedRoutes() {
        // ê¸°ì¡´ ê²½ë¡œë“¤ ì œê±°
        savedUserRoutes.forEach(route => {
          if (route.pathElement) {
            route.pathElement.setMap(null);
          }
          if (route.dottedPathElement) {
            route.dottedPathElement.setMap(null);
          }
        });
        
        // ì €ì¥ëœ ê²½ë¡œë“¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        savedUserRoutes.forEach(route => {
          if (route.path && route.path.length >= 2) {
            const path = route.path.map(point => new google.maps.LatLng(point.lat, point.lng));
            
            // ë©”ì¸ ê²½ë¡œ
            route.pathElement = new google.maps.Polyline({
              path: path,
              geodesic: true,
              strokeColor: '#3b82f6',
              strokeOpacity: 0.1,
              strokeWeight: 4,
              zIndex: 10 // ë¼ë²¨ ì•„ë˜ì— í‘œì‹œ
            });
            route.pathElement.setMap(map);
            
            // ê²½ë¡œ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            route.pathElement.addListener('click', function(event) {
              if (isRouteMode) { addUserRoutePoint(event.latLng); return; }
              if (isMarkerMode) { addCustomMarker(event.latLng); return; }
              showRouteInfo(route, event.latLng);
            });
            
            // ì ì„  íš¨ê³¼
            route.dottedPathElement = new google.maps.Polyline({
              path: path,
              geodesic: true,
              strokeColor: '#ffffff',
              strokeOpacity: 0.1,
              strokeWeight: 2,
              zIndex: 15, // ë©”ì¸ ê²½ë¡œë³´ë‹¤ëŠ” ìœ„ì—, ë¼ë²¨ë³´ë‹¤ëŠ” ì•„ë˜
              icons: [{
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  fillColor: '#3b82f6',
                  fillOpacity: 1,
                  strokeColor: '#ffffff',
                  strokeWeight: 1,
                  scale: 6
                },
                offset: '0',
                repeat: '15px'
              }]
            });
            route.dottedPathElement.setMap(map);
            
            // ì ì„  ê²½ë¡œì—ë„ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            route.dottedPathElement.addListener('click', function(event) {
              if (isRouteMode) { addUserRoutePoint(event.latLng); return; }
              if (isMarkerMode) { addCustomMarker(event.latLng); return; }
              showRouteInfo(route, event.latLng);
            });
          }
        });
      }

      // í˜„ì¬ ì§€ë„ì— ê·¸ë ¤ì§„ ëª¨ë“  ê²½ë¡œ ìš”ì†Œë¥¼ ì œê±° (ì‹¤ì‹œê°„ ë™ê¸°í™”ìš©)
      function clearAllRenderedRoutes() {
        try {
          (savedUserRoutes || []).forEach(function(route) {
            if (route && route.pathElement) {
              route.pathElement.setMap(null);
            }
            if (route && route.dottedPathElement) {
              route.dottedPathElement.setMap(null);
            }
          });
        } catch (e) {
          console.warn('ê²½ë¡œ ìš”ì†Œ ì œê±° ì¤‘ ê²½ê³ :', e);
        }
      }
             // ì €ì¥ëœ ì‚¬ìš©ì ê²½ë¡œë“¤ ë³µì›
       async function restoreSavedUserRoutes() {
         try {
           // Firebaseì—ì„œ ë³µì› ì‹œë„
           const docSnap = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'));
           if (docSnap.exists()) {
             const data = docSnap.data();
             if (data.savedUserRoutes && data.savedUserRoutes.length > 0) {
               savedUserRoutes = data.savedUserRoutes;
               drawAllSavedRoutes();
               // ê²½ë¡œì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
               updateRouteRemoveButtons();
               // ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
               updateMarkerRemoveButtons();
               console.log('Firebaseì—ì„œ ê²½ë¡œ ë³µì› ì™„ë£Œ');
               return;
             }
           }
         } catch (error) {
           console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', error);
         }
       }
       
       // ì €ì¥ëœ ì‚¬ìš©ì ë§ˆì»¤ë“¤ ë³µì›
       async function restoreSavedUserMarkers() {
         try {
           // Firebaseì—ì„œ ë³µì› ì‹œë„
           const docSnap = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'));
           if (docSnap.exists()) {
             const data = docSnap.data();
             // ë§ˆì»¤ ì •ë³´ ë°ì´í„°(ì´ëª¨ì§€ í¬í•¨)ë¥¼ ë¨¼ì € ë³µì›í•œ ë’¤ ë§ˆì»¤ë¥¼ ê·¸ë¦°ë‹¤
             if (data.markerInfoData) {
               markerInfoData = data.markerInfoData;
               console.log('ë§ˆì»¤ ì •ë³´ ë°ì´í„°ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
             }
             if (data.savedUserMarkers && data.savedUserMarkers.length > 0) {
               window.savedUserMarkers = data.savedUserMarkers;
               drawAllSavedMarkers();
               console.log('Firebaseì—ì„œ ë§ˆì»¤ ë³µì› ì™„ë£Œ');
             }
             
             if (data.savedUserMarkers && data.savedUserMarkers.length > 0) {
               return;
             }
           }
         } catch (error) {
           console.error('Firebase ë§ˆì»¤ ë¡œë“œ ì‹¤íŒ¨:', error);
         }
       }
       
       // íŠ¹ì • ìœ„ì¹˜ì˜ ê²½ë¡œë¥¼ ì œê±°í•˜ëŠ” í•¨ìˆ˜
       async function removeRoutesByLocation(location) {
         // ë™ê¸°í™” ì¤‘ì´ë©´ ë¬´ì‹œ
         if (isSyncing) {
           updateSyncStatus('ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'warning');
           return;
         }
         
         // í•´ë‹¹ ìœ„ì¹˜ì˜ ê²½ë¡œê°€ ìˆëŠ”ì§€ í™•ì¸
         const locationRoutes = savedUserRoutes.filter(route => route.location === location);
         
         if (locationRoutes.length === 0) {
           alert(`${location}ì— ì €ì¥ëœ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.`);
           return;
         }
         
         // ì‚¬ìš©ì í™•ì¸
         if (!confirm(`${location}ì— ì €ì¥ëœ ê²½ë¡œ ${locationRoutes.length}ê°œë¥¼ ëª¨ë‘ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
           return;
         }
         
         try {
           // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
           isSyncing = true;
           updateSyncStatus('ê²½ë¡œ ì œê±° ì¤‘...', 'info');
           
           // í•´ë‹¹ ìœ„ì¹˜ì˜ ê²½ë¡œë“¤ë§Œ ì œê±°
           locationRoutes.forEach(route => {
             if (route.pathElement) {
               route.pathElement.setMap(null);
             }
             if (route.dottedPathElement) {
               route.dottedPathElement.setMap(null);
             }
           });
           
           // ë°°ì—´ì—ì„œ í•´ë‹¹ ìœ„ì¹˜ ê²½ë¡œë“¤ ì œê±°
           const updatedRoutes = savedUserRoutes.filter(route => route.location !== location);
           
           // Firestoreì— ì €ì¥í•˜ê¸° ì „ì— UI ì „ìš© í•„ë“œ ì œê±°
           const sanitizedRoutes = sanitizeRoutesForFirestore(updatedRoutes);
           
           // Firebaseì—ì„œ í•´ë‹¹ ìœ„ì¹˜ ê²½ë¡œë“¤ ì œê±°
           await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
             savedUserRoutes: sanitizedRoutes,
             lastUpdated: window.firestore.serverTimestamp()
           });
           
           // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
           savedUserRoutes = updatedRoutes;
           
           // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
           drawAllSavedRoutes();
           updateRouteRemoveButtons();
           
           updateSyncStatus('ê²½ë¡œ ì œê±° ì™„ë£Œ', 'success');
           console.log(`Firebaseì—ì„œ ${location} ê²½ë¡œ ì œê±° ì™„ë£Œ`);
           
           // ì„±ê³µ ë©”ì‹œì§€
           alert(`${location} ê²½ë¡œ ${locationRoutes.length}ê°œê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
           
           // ì •ë³´ì°½ ë‹«ê¸°
           closePreparationInfo();
           
         } catch (error) {
           console.error('Firebase ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
           updateSyncStatus('ê²½ë¡œ ì œê±° ì‹¤íŒ¨', 'error');
           
           // Firebase ì‹¤íŒ¨ ì‹œ UIë§Œ ì—…ë°ì´íŠ¸
           const updatedRoutes = savedUserRoutes.filter(route => route.location !== location);
           savedUserRoutes = updatedRoutes;
           drawAllSavedRoutes();
           updateRouteRemoveButtons();
           
           setTimeout(() => {
             updateSyncStatus('Firebase ì—°ê²° ì‹¤íŒ¨', 'error');
           }, 2000);
           
           alert('Firebase ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œì»¬ì—ë§Œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
         } finally {
           // ë™ê¸°í™” ìƒíƒœ í•´ì œ (ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í—ˆìš©)
           isSyncing = false;
         }
       }
       
       // íŠ¹ì • ìœ„ì¹˜ì˜ ë§ˆì»¤ë¥¼ ì œê±°í•˜ëŠ” í•¨ìˆ˜
       async function removeMarkersByLocation(location) {
         // ë™ê¸°í™” ì¤‘ì´ë©´ ë¬´ì‹œ
         if (isSyncing) {
           updateSyncStatus('ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'warning');
           return;
         }
         
         // í•´ë‹¹ ìœ„ì¹˜ì˜ ë§ˆì»¤ê°€ ìˆëŠ”ì§€ í™•ì¸
         const locationMarkers = (window.savedUserMarkers || []).filter(marker => marker.location === location);
         
         if (locationMarkers.length === 0) {
           alert(`${location}ì— ì €ì¥ëœ ë§ˆì»¤ê°€ ì—†ìŠµë‹ˆë‹¤.`);
           return;
         }
         
         // ì‚¬ìš©ì í™•ì¸
         if (!confirm(`${location}ì— ì €ì¥ëœ ë§ˆì»¤ ${locationMarkers.length}ê°œë¥¼ ëª¨ë‘ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
           return;
         }
         
         try {
           // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
           isSyncing = true;
           updateSyncStatus('ë§ˆì»¤ ì œê±° ì¤‘...', 'info');
           
           // í•´ë‹¹ ìœ„ì¹˜ì˜ ë§ˆì»¤ë“¤ë§Œ ì œê±°
           locationMarkers.forEach(markerGroup => {
             if (markerGroup.markerElements) {
               markerGroup.markerElements.forEach(marker => {
                 marker.setMap(null);
               });
             }
           });
           
           // ë°°ì—´ì—ì„œ í•´ë‹¹ ìœ„ì¹˜ ë§ˆì»¤ë“¤ ì œê±°
           const updatedMarkers = (window.savedUserMarkers || []).filter(marker => marker.location !== location);
           
           // markerInfoDataì—ì„œ í•´ë‹¹ ìœ„ì¹˜ì˜ ë§ˆì»¤ ì •ë³´ í‚¤ ì œê±°
           const updatedMarkerInfoData = { ...markerInfoData };
           locationMarkers.forEach(function(group) {
             const groupName = (group && group.name) ? group.name : ((group && group.location) ? (group.location + ' ë§ˆì»¤') : '');
             const count = Array.isArray(group && group.markers) ? group.markers.length : 0;
             for (let i = 0; i < count; i++) {
               const key = (group && group.id) ? `${group.id}-${i}` : `${groupName}-${i}`;
               if (updatedMarkerInfoData[key]) {
                 delete updatedMarkerInfoData[key];
               }
             }
           });
           
           // Firebaseì—ì„œ í•´ë‹¹ ìœ„ì¹˜ ë§ˆì»¤ë“¤ ì œê±° (ì§ë ¬í™” ê°€ëŠ¥í•œ ë°ì´í„°ë§Œ ì „ì†¡)
           const sanitizedForDeleteByLocation = sanitizeSavedUserMarkersForFirestore(updatedMarkers);
           await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
             savedUserMarkers: sanitizedForDeleteByLocation,
             markerInfoData: updatedMarkerInfoData,
             lastUpdated: window.firestore.serverTimestamp()
           });
           
           // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
           window.savedUserMarkers = updatedMarkers;
           markerInfoData = updatedMarkerInfoData;
           
           // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
           clearAllRenderedMarkers();
           drawAllSavedMarkers();
           updateRouteRemoveButtons();
           
           updateSyncStatus('ë§ˆì»¤ ì œê±° ì™„ë£Œ', 'success');
           console.log(`Firebaseì—ì„œ ${location} ë§ˆì»¤ ì œê±° ì™„ë£Œ`);
           
           // ì„±ê³µ ë©”ì‹œì§€
           alert(`${location} ë§ˆì»¤ ${locationMarkers.length}ê°œê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
           
           // ì •ë³´ì°½ ë‹«ê¸°
           closePreparationInfo();
           
         } catch (error) {
           console.error('Firebase ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
           updateSyncStatus('ë§ˆì»¤ ì œê±° ì‹¤íŒ¨', 'error');
           
           // Firebase ì‹¤íŒ¨ ì‹œ UIë§Œ ì—…ë°ì´íŠ¸
           const updatedMarkers = (window.savedUserMarkers || []).filter(marker => marker.location !== location);
           // markerInfoDataì—ì„œë„ í•´ë‹¹ í‚¤ë“¤ì„ ì œê±°
           const fallbackMarkerInfoData = { ...markerInfoData };
           locationMarkers.forEach(function(group) {
             const groupName = (group && group.name) ? group.name : ((group && group.location) ? (group.location + ' ë§ˆì»¤') : '');
             const count = Array.isArray(group && group.markers) ? group.markers.length : 0;
             for (let i = 0; i < count; i++) {
               const key = (group && group.id) ? `${group.id}-${i}` : `${groupName}-${i}`;
               if (fallbackMarkerInfoData[key]) {
                 delete fallbackMarkerInfoData[key];
               }
             }
           });
           window.savedUserMarkers = updatedMarkers;
           markerInfoData = fallbackMarkerInfoData;
           clearAllRenderedMarkers();
           drawAllSavedMarkers();
           updateRouteRemoveButtons();
           
           setTimeout(() => {
             updateSyncStatus('Firebase ì—°ê²° ì‹¤íŒ¨', 'error');
           }, 2000);
           
           alert('Firebase ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œì»¬ì—ë§Œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
         } finally {
           // ë™ê¸°í™” ìƒíƒœ í•´ì œ (ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í—ˆìš©)
           isSyncing = false;
         }
       }
       
       // ê²½ë¡œ/ë§ˆì»¤ ì œê±° ë²„íŠ¼ë“¤ì„ ë™ì ìœ¼ë¡œ í‘œì‹œ/ìˆ¨ê¹€í•˜ëŠ” í•¨ìˆ˜
       function updateRouteRemoveButtons() {
         // í˜„ì¬ í™œì„± ì„¹ì…˜ì˜ ê²½ë¡œ/ë§ˆì»¤ ì œê±° ë²„íŠ¼ ì—…ë°ì´íŠ¸
         const currentSection = window.currentActiveSection || '';
         if (currentSection) {
           const currentRoutes = savedUserRoutes.filter(route => route.location === currentSection);
           const currentMarkers = (window.savedUserMarkers || []).filter(marker => marker.location === currentSection);
           
           // í˜„ì¬ ì„¹ì…˜ì˜ removeButtons ìš”ì†Œ ì°¾ê¸° (ë™ì ìœ¼ë¡œ ìƒì„±ëœ ì¼ì •ë“¤)
           const removeButtonsId = currentSection.replace(/[^a-zA-Z0-9ê°€-í£]/g, '') + 'RemoveButtons';
           const removeButtons = document.getElementById(removeButtonsId);
           if (removeButtons) {
             const hasRoutes = currentRoutes.length > 0;
             const hasMarkers = currentMarkers.length > 0;
             
             // í˜„ì¬ ì„¹ì…˜ì˜ removeButtons ìš”ì†Œ ì°¾ê¸° (ë™ì ìœ¼ë¡œ ìƒì„±ëœ ì¼ì •ë“¤)
             const removeButtonsId = currentSection.replace(/[^a-zA-Z0-9ê°€-í£]/g, '') + 'RemoveButtons';
             const removeButtons = document.getElementById(removeButtonsId);
             if (removeButtons) {
               const hasRoutes = currentRoutes.length > 0;
               const hasMarkers = currentMarkers.length > 0;
               
               // ê²½ë¡œë‚˜ ë§ˆì»¤ê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ í‘œì‹œ
               removeButtons.style.display = (hasRoutes || hasMarkers) ? 'block' : 'none';
               
               // ê° ë²„íŠ¼ì˜ ìƒíƒœì— ë”°ë¼ íˆ¬ëª…ë„ ì¡°ì •
               const routeBtn = removeButtons.querySelector('button[onclick*="removeRoutesByLocation"]');
               const markerBtn = removeButtons.querySelector('button[onclick*="removeMarkersByLocation"]');
               
               if (routeBtn) {
                 if (hasRoutes) {
                   // ê²½ë¡œê°€ ìˆìœ¼ë©´ ì •ìƒ í‘œì‹œ
                   routeBtn.style.opacity = '1';
                   routeBtn.style.cursor = 'pointer';
                   routeBtn.disabled = false;
                 } else {
                   // ê²½ë¡œê°€ ì—†ìœ¼ë©´ í¬ë¯¸í•˜ê²Œ í‘œì‹œ
                   routeBtn.style.opacity = '0.3';
                   routeBtn.style.cursor = 'not-allowed';
                   routeBtn.disabled = true;
                 }
               }
               
               if (markerBtn) {
                 if (hasMarkers) {
                   // ë§ˆì»¤ê°€ ìˆìœ¼ë©´ ì •ìƒ í‘œì‹œ
                   markerBtn.style.opacity = '1';
                   markerBtn.style.cursor = 'pointer';
                   markerBtn.disabled = false;
                 } else {
                   // ë§ˆì»¤ê°€ ì—†ìœ¼ë©´ í¬ë¯¸í•˜ê²Œ í‘œì‹œ
                   markerBtn.style.opacity = '0.3';
                   markerBtn.style.cursor = 'not-allowed';
                   markerBtn.disabled = true;
                 }
               }
             }
           }
         }
       }
       
       // ë§ˆì»¤ì œê±° ë²„íŠ¼ë“¤ì„ ë™ì ìœ¼ë¡œ í‘œì‹œ/ìˆ¨ê¹€í•˜ëŠ” í•¨ìˆ˜ (í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€)
       function updateMarkerRemoveButtons() {
         // ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•Šìœ¼ë©°, updateRouteRemoveButtonsì—ì„œ í†µí•© ì²˜ë¦¬ë©ë‹ˆë‹¤.
         updateRouteRemoveButtons();
       }
       
       // í¬ê´„ì ì¸ ì¥ì†Œ ê²€ìƒ‰ í•¨ìˆ˜ - ë¶€ë¶„ ê²€ìƒ‰ì–´ ì§€ì›
       function searchAddress() {
         const searchQuery = document.getElementById('addressInput').value.trim();
         if (!searchQuery) {
           alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
           return;
         }
         if (!map) {
           alert('ì§€ë„ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
           return;
         }
         
         // ëª¨ë°”ì¼ì—ì„œ ê²€ìƒ‰ ì¤‘ í‘œì‹œ
         let searchBtn = null;
         let originalText = '';
         if (isMobile) {
           searchBtn = document.querySelector('#addressInput + button') || document.getElementById('addressInput');
           originalText = searchBtn.textContent || searchBtn.placeholder || 'ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”';
           if (searchBtn.tagName === 'INPUT') {
             searchBtn.placeholder = 'ê²€ìƒ‰ì¤‘...';
           } else {
           searchBtn.textContent = 'ê²€ìƒ‰ì¤‘...';
           }
           searchBtn.disabled = true;
         }
         
         // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
         if (addressMarker) {
           addressMarker.setMap(null);
           addressMarker = null;
         }
         
         // í¬ê´„ì  ê²€ìƒ‰ ì‹¤í–‰
         performComprehensiveSearch(searchQuery, searchBtn, originalText);
       }
       
       // í¬ê´„ì  ê²€ìƒ‰ ì‹¤í–‰ í•¨ìˆ˜
       function performComprehensiveSearch(query, searchBtn, originalText) {
         console.log('í¬ê´„ì  ê²€ìƒ‰ ì‹œì‘:', query);
         
         // ê²€ìƒ‰ ê²°ê³¼ë¥¼ ìˆ˜ì§‘í•  ë°°ì—´
         let allResults = [];
         let searchesCompleted = 0;
         const totalSearches = 2; // Geocoding + Places Text Search
         
         // ê²€ìƒ‰ ì™„ë£Œ í›„ ì²˜ë¦¬ í•¨ìˆ˜
         function handleSearchComplete() {
           searchesCompleted++;
           if (searchesCompleted >= totalSearches) {
             processAllSearchResults(allResults, query, searchBtn, originalText);
           }
         }
         
         // 1. ê¸°ì¡´ Geocoding API ê²€ìƒ‰
         if (geocoder) {
         const boundsForQuery = map.getBounds ? map.getBounds() : null;
         geocoder.geocode({ 
             address: query, 
           bounds: boundsForQuery,
             region: 'JP', // ì¼ë³¸ ì§€ì—­ ìš°ì„  ê²€ìƒ‰
             language: 'ko' // í•œêµ­ì–´ ê²°ê³¼ ìš”ì²­
         }, function(results, status) {
             if (status === 'OK' && results && results.length) {
               console.log('Geocoding ê²°ê³¼:', results.length, 'ê°œ');
               results.forEach(result => {
                 allResults.push({
                   ...result,
                   source: 'geocoding',
                   name: result.formatted_address,
                   place_id: result.place_id
                 });
               });
             }
             handleSearchComplete();
           });
         } else {
           handleSearchComplete();
         }
         
         // 2. Places Text Search API ê²€ìƒ‰
         if (google.maps.places && google.maps.places.PlacesService) {
           const service = new google.maps.places.PlacesService(map);
           const bounds = map.getBounds();
           
           const request = {
             query: query,
             bounds: bounds,
             region: 'jp',
             language: 'ko' // í•œêµ­ì–´ ê²°ê³¼ ìš”ì²­
           };
           
           service.textSearch(request, function(results, status) {
             if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length) {
               console.log('Places Text Search ê²°ê³¼:', results.length, 'ê°œ');
               results.forEach(result => {
                 allResults.push({
                   geometry: { location: result.geometry.location },
                   formatted_address: result.formatted_address || result.name,
                   name: result.name,
                   place_id: result.place_id,
                   source: 'places_text',
                   types: result.types,
                   rating: result.rating,
                   vicinity: result.vicinity
                 });
               });
             }
             handleSearchComplete();
           });
         } else {
           handleSearchComplete();
         }
       }
       
       // ëª¨ë“  ê²€ìƒ‰ ê²°ê³¼ ì²˜ë¦¬ í•¨ìˆ˜
       function processAllSearchResults(allResults, query, searchBtn, originalText) {
           // ëª¨ë°”ì¼ì—ì„œ ê²€ìƒ‰ ì™„ë£Œ í‘œì‹œ ë³µì›
         if (isMobile && searchBtn) {
           if (searchBtn.tagName === 'INPUT') {
             searchBtn.placeholder = originalText;
           } else {
             searchBtn.textContent = originalText;
           }
             searchBtn.disabled = false;
           }
           
         console.log('ì „ì²´ ê²€ìƒ‰ ê²°ê³¼:', allResults.length, 'ê°œ');
         
         if (!allResults.length) {
           alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.');
             return;
           }

         // ì¤‘ë³µ ì œê±° (place_id ê¸°ì¤€)
         const uniqueResults = [];
         const seenPlaceIds = new Set();
         const seenLocations = new Set();
         
         allResults.forEach(result => {
           const locationKey = `${result.geometry.location.lat().toFixed(6)},${result.geometry.location.lng().toFixed(6)}`;
           
           if (result.place_id && !seenPlaceIds.has(result.place_id)) {
             seenPlaceIds.add(result.place_id);
             uniqueResults.push(result);
           } else if (!result.place_id && !seenLocations.has(locationKey)) {
             seenLocations.add(locationKey);
             uniqueResults.push(result);
           }
         });
         
         console.log('ì¤‘ë³µ ì œê±° í›„:', uniqueResults.length, 'ê°œ');
         
         // í˜„ì¬ ì§€ë„ ë²”ìœ„ ë‚´ ê²°ê³¼ë§Œ í•„í„°ë§
         const bounds = map.getBounds();
         const filteredResults = bounds ? 
           uniqueResults.filter(result => bounds.contains(result.geometry.location)) : 
           uniqueResults;
         
         if (!filteredResults.length) {
           alert('í˜„ì¬ í™”ë©´ ë²”ìœ„ ë‚´ì—ì„œ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§€ë„ë¥¼ ì´ë™/í™•ëŒ€ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
             return;
           }
         
         console.log('ì§€ë„ ë²”ìœ„ ë‚´ ê²°ê³¼:', filteredResults.length, 'ê°œ');
         
         // ê´€ë ¨ì„± ì ìˆ˜ ê³„ì‚° ë° ì •ë ¬
         const scoredResults = filteredResults.map(result => {
           let score = 0;
           const name = (result.name || result.formatted_address || '').toLowerCase();
           const queryLower = query.toLowerCase();
           
           // ì™„ì „ ì¼ì¹˜
           if (name === queryLower) score += 100;
           // ì‹œì‘ ì¼ì¹˜
           else if (name.startsWith(queryLower)) score += 80;
           // í¬í•¨ ì¼ì¹˜
           else if (name.includes(queryLower)) score += 60;
           // ë¶€ë¶„ ì¼ì¹˜ (ê° ë‹¨ì–´ë³„)
           else {
             const queryWords = queryLower.split(/\s+/);
             queryWords.forEach(word => {
               if (name.includes(word)) score += 30;
             });
           }
           
           // Places API ê²°ê³¼ì— ì¶”ê°€ ì ìˆ˜
           if (result.source === 'places_text') score += 10;
           
           // í‰ì ì´ ìˆëŠ” ê²½ìš° ì¶”ê°€ ì ìˆ˜
           if (result.rating) score += Math.min(result.rating, 5);
           
           return { ...result, relevanceScore: score };
         });
         
         // ê´€ë ¨ì„± ì ìˆ˜ë¡œ ì •ë ¬
         scoredResults.sort((a, b) => b.relevanceScore - a.relevanceScore);

                    // ëª¨ë“  ê²°ê³¼ë¥¼ ë§ˆì»¤ë¡œ í‘œì‹œ
         createMultipleAddressMarkers(scoredResults, query);
       }
       
       // ê°œì„ ëœ ì£¼ì†Œ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸
       function showEnhancedAddressSelection(results, queryText) {
         // ê¸°ì¡´ ì„ íƒì°½ ì œê±°
         const existing = document.getElementById('addressSelectDialog');
         if (existing) existing.remove();

         const dialog = document.createElement('div');
         dialog.id = 'addressSelectDialog';
         dialog.style.cssText = `
           position: fixed;
           z-index: 1000;
           width: 400px;
           max-width: 90vw;
           max-height: 70vh;
           background: white;
           border: 1px solid #e5e7eb;
           border-radius: 16px;
           box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
           overflow: hidden;
           top: 50%;
           left: 50%;
           transform: translate(-50%, -50%);
         `;

         dialog.innerHTML = `
           <div style="background: linear-gradient(135deg, #1d4ed8, #2563eb); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center;">
             <div style="font-weight: 700; font-size: 16px;">ê²€ìƒ‰ ê²°ê³¼ (${results.length}ê°œ)</div>
             <button style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;" onclick="closeAddressSelection()" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'">Ã—</button>
           </div>
           <div style="padding: 16px; max-height: 50vh; overflow: auto;">
             <div style="margin-bottom: 12px; color: #6b7280; font-size: 14px;">
               '<strong>${queryText}</strong>' ê²€ìƒ‰ ê²°ê³¼ì…ë‹ˆë‹¤. ì›í•˜ëŠ” ì¥ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”.
             </div>
             <div id="addressSelectList"></div>
           </div>
         `;

         document.body.appendChild(dialog);

         // ê²°ê³¼ ëª©ë¡ ìƒì„±
         const list = document.getElementById('addressSelectList');
         let html = '';
         results.forEach((result, index) => {
           const name = result.name || 'ì´ë¦„ ì—†ìŒ';
           const address = result.formatted_address || result.vicinity || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ';
           const source = result.source === 'places_text' ? 'ì¥ì†Œ' : 'ì£¼ì†Œ';
           const rating = result.rating ? ` â­ ${result.rating}` : '';
           
           html += `
             <button onclick="chooseAddressResult(${index})" style="
               width: 100%;
               text-align: left;
               padding: 12px;
               margin-bottom: 8px;
               border: 1px solid #e5e7eb;
               border-radius: 8px;
               background: white;
               cursor: pointer;
               transition: all 0.2s ease;
               display: block;
             " onmouseover="this.style.background='#f8fafc'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb';">
               <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">${name}${rating}</div>
               <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">${address}</div>
               <div style="font-size: 12px; color: #9ca3af;">
                 <span style="background: #e0e7ff; color: #3730a3; padding: 2px 6px; border-radius: 4px; margin-right: 4px;">${source}</span>
                 ê´€ë ¨ì„±: ${result.relevanceScore || 0}ì 
               </div>
             </button>
           `;
         });
         list.innerHTML = html;
       }
       // ì£¼ì†Œ ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
       function createAddressMarker(result, originalQuery) {
         const location = result.geometry.location;
         const name = result.name || originalQuery;
         const address = result.formatted_address || result.vicinity || '';
           
           // í˜„ì¬ ì¤Œ ë ˆë²¨ ìœ ì§€í•˜ë©´ì„œ ì¤‘ì‹¬ë§Œ ì´ë™
           const currentZoom = map.getZoom();
           map.setCenter(location);
         map.setZoom(Math.max(currentZoom, 14)); // ìµœì†Œ ì¤Œ ë ˆë²¨ 14

         // ìƒˆë¡œìš´ ë§ˆì»¤ ìƒì„± ë° í‘œì‹œ
           addressMarker = new google.maps.Marker({
             position: location,
             map: map,
           title: name,
             zIndex: 1000, // ê²½ë¡œì™€ ë¼ë²¨ ìœ„ì— í‘œì‹œ
             icon: {
               url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
             scaledSize: new google.maps.Size(isMobile ? 32 : 36, isMobile ? 32 : 36)
           },
           animation: isMobile ? google.maps.Animation.NONE : google.maps.Animation.DROP,
           optimized: false
         });

                  // ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ì°½ í‘œì‹œ (í•œêµ­ì–´)
         const infoContent = `
           <div style="padding: 16px; max-width: 320px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
             <div style="font-weight: 700; font-size: 16px; color: #1f2937; margin-bottom: 8px; line-height: 1.4;">
               ${name}
               <span style="background: #ef4444; color: white; font-size: 12px; padding: 2px 6px; border-radius: 12px; margin-left: 8px;">ì¶”ì²œ</span>
             </div>
             ${address ? `<div style="font-size: 14px; color: #6b7280; margin-bottom: 8px; line-height: 1.3;">${address}</div>` : ''}
             ${result.rating ? `<div style="font-size: 14px; color: #f59e0b; margin-bottom: 8px;">â­ ${result.rating}ì  (í‰ì )</div>` : ''}
             <div style="font-size: 12px; color: #9ca3af; margin-bottom: 12px;">
               <span style="background: ${result.source === 'places_text' ? '#e0e7ff' : '#f3f4f6'}; color: ${result.source === 'places_text' ? '#3730a3' : '#6b7280'}; padding: 2px 6px; border-radius: 4px; margin-right: 4px;">
                 ${result.source === 'places_text' ? 'ì¥ì†Œ ì •ë³´' : 'ì£¼ì†Œ ì •ë³´'}
               </span>
               ì—°ê´€ë„: ${result.relevanceScore || 0}ì 
             </div>
             <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
               <button onclick="openInGoogleMaps('${location.lat()}', '${location.lng()}', '${name.replace(/'/g, "\\'")}', '${encodeURIComponent(address || name)}')" 
                       style="
                         width: 100%;
                         background: rgba(255, 255, 255, 0.12);
                         color: #000;
                         border: none;
                         border-radius: 12px;
                         padding: 14px 32px;
                         font-size: 15px;
                         font-weight: 500;
                         cursor: pointer;
                         transition: all 0.2s ease;
                         backdrop-filter: blur(10px);
                         min-width: 120px;
                         display: flex;
                         align-items: center;
                         justify-content: center;
                         gap: 8px;
                       "
                       onmouseover="this.style.background='rgba(255, 255, 255, 0.18)'; this.style.transform='translateY(-1px)';"
                       onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.transform='translateY(0)';">
                 ìƒì„¸ë³´ê¸°
               </button>
             </div>
           </div>
         `;
         
         const infoWindow = new google.maps.InfoWindow({
           content: infoContent,
           disableAutoPan: false,
           maxWidth: isMobile ? 300 : 350
         });
         
         // ì •ë³´ì°½ ì—´ë¦° í›„ X ë²„íŠ¼ ì œê±°
         google.maps.event.addListener(infoWindow, 'domready', function() {
           const closeBtn = document.querySelector('.gm-ui-hover-effect');
           if (closeBtn) {
             closeBtn.style.display = 'none';
           }
         });
         
           addressMarker.addListener('click', function() {
             // ê¸°ì¡´ ì •ë³´ì°½ ë‹«ê¸°
             if (currentInfoWindow) {
               currentInfoWindow.close();
             }
             
             // Places APIì—ì„œ ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ í•œêµ­ì–´ ì´ë¦„ í™•ì¸
             if (result.place_id && google.maps.places && google.maps.places.PlacesService) {
               const service = new google.maps.places.PlacesService(map);
               const detailRequest = {
                 placeId: result.place_id,
                 fields: ['name', 'formatted_address', 'rating', 'types'],
                 language: 'ko'
               };
               
               service.getDetails(detailRequest, function(placeResult, status) {
                 if (status === google.maps.places.PlacesServiceStatus.OK && placeResult) {
                   // í•œêµ­ì–´ ì´ë¦„ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ë²ˆì—­ ì‹œë„
                   const koreanName = placeResult.name || name;
                   const koreanAddress = placeResult.formatted_address || address;
                   
                   // í•œêµ­ì–´ ì •ë³´ë¡œ ì •ë³´ì°½ ë‚´ìš© ì—…ë°ì´íŠ¸
                   const updatedInfoContent = `
                     <div style="padding: 16px; max-width: 320px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                       <div style="font-weight: 700; font-size: 16px; color: #1f2937; margin-bottom: 8px; line-height: 1.4;">
                         ${koreanName}
                         <span style="background: #ef4444; color: white; font-size: 12px; padding: 2px 6px; border-radius: 12px; margin-left: 8px;">ì¶”ì²œ</span>
                       </div>
                       ${koreanAddress ? `<div style="font-size: 14px; color: #6b7280; margin-bottom: 8px; line-height: 1.3;">${koreanAddress}</div>` : ''}
                       ${(placeResult.rating || result.rating) ? `<div style="font-size: 14px; color: #f59e0b; margin-bottom: 8px;">â­ ${(placeResult.rating || result.rating)}ì  (í‰ì )</div>` : ''}
                       <div style="font-size: 12px; color: #9ca3af; margin-bottom: 12px;">
                         <span style="background: ${result.source === 'places_text' ? '#e0e7ff' : '#f3f4f6'}; color: ${result.source === 'places_text' ? '#3730a3' : '#6b7280'}; padding: 2px 6px; border-radius: 4px; margin-right: 4px;">
                           ${result.source === 'places_text' ? 'ì¥ì†Œ ì •ë³´' : 'ì£¼ì†Œ ì •ë³´'}
                         </span>
                         ì—°ê´€ë„: ${result.relevanceScore || 0}ì 
                       </div>
                       <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
                         <button onclick="openInGoogleMaps('${location.lat()}', '${location.lng()}', '${koreanName.replace(/'/g, "\\'")}', '${encodeURIComponent(koreanAddress || koreanName)}')" 
                                 style="
                                   width: 100%;
                                   background: rgba(255, 255, 255, 0.12);
                                   color: #000;
                                   border: none;
                                   border-radius: 12px;
                                   padding: 14px 32px;
                                   font-size: 15px;
                                   font-weight: 500;
                                   cursor: pointer;
                                   transition: all 0.2s ease;
                                   backdrop-filter: blur(10px);
                                   min-width: 120px;
                                   display: flex;
                                   align-items: center;
                                   justify-content: center;
                                   gap: 8px;
                                 "
                                 onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(66, 133, 244, 0.3)';"
                                 onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                           ìƒì„¸ë³´ê¸°
                         </button>
                       </div>
                     </div>
                   `;
                   
                   infoWindow.setContent(updatedInfoContent);
                 }
                 
                 // ì •ë³´ì°½ í‘œì‹œ
                 infoWindow.open(map, addressMarker);
                 currentInfoWindow = infoWindow;
                 
                 // ë§ˆì»¤ ì£¼ìœ„ë¡œ ì¤Œ ë ˆë²¨ 15ë¡œ ì¡°ì •
                 map.setCenter(location);
                 map.setZoom(15);
               });
             } else {
               // place_idê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ì •ë³´ì°½ í‘œì‹œ
               infoWindow.open(map, addressMarker);
               currentInfoWindow = infoWindow;
               
               // ë§ˆì»¤ ì£¼ìœ„ë¡œ ì¤Œ ë ˆë²¨ 15ë¡œ ì¡°ì •
               map.setCenter(location);
               map.setZoom(15);
             }
           });

                    // ì£¼ì†Œ ì…ë ¥ì°½ ì´ˆê¸°í™”
         document.getElementById('addressInput').value = '';
         
         // ì‚¬ì´ë“œíŒ¨ë„ ë‹«ê¸°
         closeSidePanel();
         
         console.log('ë§ˆì»¤ ìƒì„± ì™„ë£Œ:', name, 'at', location.toString());
       }
       // ì—¬ëŸ¬ ì£¼ì†Œ ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
       function createMultipleAddressMarkers(results, originalQuery) {
         console.log('ì—¬ëŸ¬ ë§ˆì»¤ ìƒì„± ì‹œì‘:', results.length, 'ê°œ');
         
         // ê¸°ì¡´ ê²€ìƒ‰ ë§ˆì»¤ë“¤ ëª¨ë‘ ì œê±°
         clearAllAddressMarkers();
         
         if (!results.length) {
           alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
           return;
         }
         
         // ì§€ë„ ì˜ì—­ì„ ëª¨ë“  ë§ˆì»¤ë¥¼ í¬í•¨í•˜ë„ë¡ ì¡°ì •í•  bounds ìƒì„±
         const bounds = new google.maps.LatLngBounds();
         let markersCreated = 0;
         
         results.forEach((result, index) => {
           const location = result.geometry.location;
           const name = result.name || result.formatted_address || `ê²€ìƒ‰ ê²°ê³¼ ${index + 1}`;
           const address = result.formatted_address || result.vicinity || '';
           
           // ë§ˆì»¤ ì•„ì´ì½˜ ìƒ‰ìƒ - ê´€ë ¨ì„±ì— ë”°ë¼ ë‹¤ë¥¸ ìƒ‰ìƒ
           let iconUrl;
           if (index === 0) {
             // ê°€ì¥ ê´€ë ¨ì„± ë†’ì€ ê²°ê³¼ëŠ” ë¹¨ê°„ìƒ‰
             iconUrl = 'https://maps.google.com/mapfiles/ms/icons/red-dot.png';
           } else if (index < 3) {
             // ìƒìœ„ 3ê°œëŠ” ì£¼í™©ìƒ‰
             iconUrl = 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png';
           } else {
             // ë‚˜ë¨¸ì§€ëŠ” ë…¸ë€ìƒ‰
             iconUrl = 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png';
           }
           
           // ë§ˆì»¤ ìƒì„±
           const marker = new google.maps.Marker({
             position: location,
             map: map,
             title: name,
             zIndex: 1000, // ê²½ë¡œì™€ ë¼ë²¨ ìœ„ì— í‘œì‹œ
             icon: {
               url: iconUrl,
               scaledSize: new google.maps.Size(isMobile ? 28 : 32, isMobile ? 28 : 32)
             },
             animation: google.maps.Animation.DROP,
             optimized: false,
             zIndex: 1000 - index // ê´€ë ¨ì„± ë†’ì€ ìˆœìœ¼ë¡œ ìœ„ì— í‘œì‹œ
           });
           
           // ë§ˆì»¤ ë°°ì—´ì— ì¶”ê°€
           addressMarkers.push(marker);
           bounds.extend(location);
           markersCreated++;
           
           // ì •ë³´ì°½ ë‚´ìš© êµ¬ì„± (í•œêµ­ì–´)
           const infoContent = `
             <div style="padding: 16px; max-width: 320px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
               <div style="font-weight: 700; font-size: 16px; color: #1f2937; margin-bottom: 8px; line-height: 1.4;">
                 ${name}
                 ${index < 3 ? '<span style="background: #ef4444; color: white; font-size: 12px; padding: 2px 6px; border-radius: 12px; margin-left: 8px;">ì¶”ì²œ</span>' : ''}
               </div>
               ${address ? `<div style="font-size: 14px; color: #6b7280; margin-bottom: 8px; line-height: 1.3;">${address}</div>` : ''}
               ${result.rating ? `<div style="font-size: 14px; color: #f59e0b; margin-bottom: 8px;">â­ ${result.rating}ì  (í‰ì )</div>` : ''}
               <div style="font-size: 12px; color: #9ca3af; margin-bottom: 12px;">
                 <span style="background: ${result.source === 'places_text' ? '#e0e7ff' : '#f3f4f6'}; color: ${result.source === 'places_text' ? '#3730a3' : '#6b7280'}; padding: 2px 6px; border-radius: 4px; margin-right: 4px;">
                   ${result.source === 'places_text' ? 'ì¥ì†Œ ì •ë³´' : 'ì£¼ì†Œ ì •ë³´'}
                 </span>
                 ì—°ê´€ë„: ${result.relevanceScore || 0}ì 
               </div>
               <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
                 <button onclick="openInGoogleMaps('${location.lat()}', '${location.lng()}', '${name.replace(/'/g, "\\'")}', '${encodeURIComponent(address || name)}')" 
                         style="
                           width: 100%;
                           background: linear-gradient(135deg, #4285f4, #34a853);
                           color: white;
                           border: none;
                           border-radius: 8px;
                           padding: 12px 16px;
                           font-size: 14px;
                           font-weight: 600;
                           cursor: pointer;
                           transition: all 0.2s ease;
                           display: flex;
                           align-items: center;
                           justify-content: center;
                           gap: 8px;
                         "
                         onmouseover="this.style.background='rgba(255, 255, 255, 0.18)'; this.style.transform='translateY(-1px)';"
                         onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.transform='translateY(0)';">
                   ìƒì„¸ë³´ê¸°
                 </button>
               </div>
             </div>
           `;
           
           // ì •ë³´ì°½ ìƒì„± (X ë²„íŠ¼ ì œê±°)
           const infoWindow = new google.maps.InfoWindow({
             content: infoContent,
             disableAutoPan: false,
             maxWidth: isMobile ? 300 : 350
           });
           
           // ì •ë³´ì°½ ì—´ë¦° í›„ X ë²„íŠ¼ ì œê±°
           google.maps.event.addListener(infoWindow, 'domready', function() {
             const closeBtn = document.querySelector('.gm-ui-hover-effect');
             if (closeBtn) {
               closeBtn.style.display = 'none';
             }
           });
           
           // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
           marker.addListener('click', function() {
             // ê²€ìƒ‰ ë§ˆì»¤ í´ë¦­ í”Œë˜ê·¸ ì„¤ì • (ì •ë³´ì°½ì´ ë‹«íˆì§€ ì•Šë„ë¡)
             window.searchMarkerClicked = true;
             
             // ê¸°ì¡´ ì •ë³´ì°½ ë‹«ê¸°
             if (currentInfoWindow) {
               currentInfoWindow.close();
             }
             
             // Places APIì—ì„œ ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ í•œêµ­ì–´ ì´ë¦„ í™•ì¸
             if (result.place_id && google.maps.places && google.maps.places.PlacesService) {
               const service = new google.maps.places.PlacesService(map);
               const detailRequest = {
                 placeId: result.place_id,
                 fields: ['name', 'formatted_address', 'rating', 'types'],
                 language: 'ko'
               };
               
               service.getDetails(detailRequest, function(placeResult, status) {
                 if (status === google.maps.places.PlacesServiceStatus.OK && placeResult) {
                   // í•œêµ­ì–´ ì´ë¦„ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ë²ˆì—­ ì‹œë„
                   const koreanName = placeResult.name || name;
                   const koreanAddress = placeResult.formatted_address || address;
                   
                   // í•œêµ­ì–´ ì •ë³´ë¡œ ì •ë³´ì°½ ë‚´ìš© ì—…ë°ì´íŠ¸
                   const updatedInfoContent = `
                     <div style="padding: 16px; max-width: 320px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                       <div style="font-weight: 700; font-size: 16px; color: #1f2937; margin-bottom: 8px; line-height: 1.4;">
                         ${koreanName}
                         ${index < 3 ? '<span style="background: #ef4444; color: white; font-size: 12px; padding: 2px 6px; border-radius: 12px; margin-left: 8px;">ì¶”ì²œ</span>' : ''}
                       </div>
                       ${koreanAddress ? `<div style="font-size: 14px; color: #6b7280; margin-bottom: 8px; line-height: 1.3;">${koreanAddress}</div>` : ''}
                       ${(placeResult.rating || result.rating) ? `<div style="font-size: 14px; color: #f59e0b; margin-bottom: 8px;">â­ ${(placeResult.rating || result.rating)}ì  (í‰ì )</div>` : ''}
                       <div style="font-size: 12px; color: #9ca3af; margin-bottom: 12px;">
                         <span style="background: ${result.source === 'places_text' ? '#e0e7ff' : '#f3f4f6'}; color: ${result.source === 'places_text' ? '#3730a3' : '#6b7280'}; padding: 2px 6px; border-radius: 4px; margin-right: 4px;">
                           ${result.source === 'places_text' ? 'ì¥ì†Œ ì •ë³´' : 'ì£¼ì†Œ ì •ë³´'}
                         </span>
                         ì—°ê´€ë„: ${result.relevanceScore || 0}ì 
                       </div>
                       <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
                         <button onclick="openInGoogleMaps('${location.lat()}', '${location.lng()}', '${koreanName.replace(/'/g, "\\'")}', '${encodeURIComponent(koreanAddress || koreanName)}')" 
                                 style="
                                   width: 100%;
                                   background: rgba(255, 255, 255, 0.12);
                                   color: #000;
                                   border: none;
                                   border-radius: 12px;
                                   padding: 14px 32px;
                                   font-size: 15px;
                                   font-weight: 500;
                                   cursor: pointer;
                                   transition: all 0.2s ease;
                                   backdrop-filter: blur(10px);
                                   min-width: 120px;
                                   display: flex;
                                   align-items: center;
                                   justify-content: center;
                                   gap: 8px;
                                 "
                                 onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(66, 133, 244, 0.3)';"
                                 onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                           ìƒì„¸ë³´ê¸°
                         </button>
                       </div>
                     </div>
                   `;
                   
                   infoWindow.setContent(updatedInfoContent);
                 }
                 
                 // ì •ë³´ì°½ í‘œì‹œ
                 infoWindow.open(map, marker);
                 currentInfoWindow = infoWindow;
                 
                                 // ë§ˆì»¤ ì¤‘ì‹¬ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ì´ë™í•˜ê³  í•„ìš”ì‹œ ì¤Œë ˆë²¨ 15ë¡œ í™•ëŒ€
                const currentZoom = map.getZoom();
                map.panTo(location);
                // í˜„ì¬ ì¤Œë ˆë²¨ì´ 15 ë¯¸ë§Œì¼ ë•Œë§Œ ì¤Œë ˆë²¨ 15ë¡œ í™•ëŒ€
                if (currentZoom < 15) {
                  map.setZoom(15);
                }
                
                // í”Œë˜ê·¸ í•´ì œ (ë‹¤ìŒ í´ë¦­ì„ ìœ„í•´)
                setTimeout(() => {
                  window.searchMarkerClicked = false;
                }, 100);
               });
             } else {
               // place_idê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ì •ë³´ì°½ í‘œì‹œ
               infoWindow.open(map, marker);
               currentInfoWindow = infoWindow;
               
                               // ë§ˆì»¤ ì¤‘ì‹¬ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ì´ë™í•˜ê³  í•„ìš”ì‹œ ì¤Œë ˆë²¨ 15ë¡œ í™•ëŒ€
                const currentZoom = map.getZoom();
                map.panTo(location);
                // í˜„ì¬ ì¤Œë ˆë²¨ì´ 15 ë¯¸ë§Œì¼ ë•Œë§Œ ì¤Œë ˆë²¨ 15ë¡œ í™•ëŒ€
                if (currentZoom < 15) {
                  map.setZoom(15);
                }
                
                // í”Œë˜ê·¸ í•´ì œ (ë‹¤ìŒ í´ë¦­ì„ ìœ„í•´)
                setTimeout(() => {
                  window.searchMarkerClicked = false;
                }, 100);
             }
           });
         });
         
         // ì²« ë²ˆì§¸ ë§ˆì»¤ë¥¼ addressMarkerë¡œë„ ì„¤ì • (ê¸°ì¡´ í˜¸í™˜ì„±)
         if (addressMarkers.length > 0) {
           addressMarker = addressMarkers[0];
         }
         
         // ëª¨ë“  ë§ˆì»¤ê°€ ë³´ì´ë„ë¡ ì§€ë„ ë²”ìœ„ ì¡°ì •
         if (markersCreated > 1) {
           map.fitBounds(bounds);
           // ë„ˆë¬´ í™•ëŒ€ë˜ì§€ ì•Šë„ë¡ ìµœëŒ€ ì¤Œ ë ˆë²¨ ì œí•œ
           google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
             if (map.getZoom() > 16) {
               map.setZoom(16);
             }
           });
         } else if (markersCreated === 1) {
           // ë§ˆì»¤ê°€ í•˜ë‚˜ë§Œ ìˆìœ¼ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
           map.setCenter(results[0].geometry.location);
           map.setZoom(15);
         }
         
         // ì£¼ì†Œ ì…ë ¥ì°½ ì´ˆê¸°í™”
         document.getElementById('addressInput').value = '';
         
         console.log('ë§ˆì»¤ ìƒì„± ì™„ë£Œ:', markersCreated, 'ê°œì˜ ë§ˆì»¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
         
         // ì‚¬ì´ë“œíŒ¨ë„ ë‹«ê¸°
         closeSidePanel();
         
         // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
         const message = `"${originalQuery}" ê²€ìƒ‰ ê²°ê³¼ ${markersCreated}ê°œ ì¥ì†Œê°€ ì§€ë„ì— í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.`;
         showSearchResultNotification(message);
       }
       
       // ëª¨ë“  ì£¼ì†Œ ê²€ìƒ‰ ë§ˆì»¤ ì œê±° í•¨ìˆ˜
       function clearAllAddressMarkers() {
         // ê¸°ì¡´ ë‹¨ì¼ ë§ˆì»¤ ì œê±°
         if (addressMarker) {
           addressMarker.setMap(null);
           addressMarker = null;
         }
         
         // ëª¨ë“  ê²€ìƒ‰ ë§ˆì»¤ë“¤ ì œê±°
         addressMarkers.forEach(marker => {
           marker.setMap(null);
         });
         addressMarkers = [];
         
         // í˜„ì¬ ì—´ë¦° ì •ë³´ì°½ ë‹«ê¸°
         if (currentInfoWindow) {
           currentInfoWindow.close();
           currentInfoWindow = null;
         }
       }
       
       // ê²€ìƒ‰ ê²°ê³¼ ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
       function showSearchResultNotification(message) {
         // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
         const existingNotification = document.getElementById('searchResultNotification');
         if (existingNotification) {
           existingNotification.remove();
         }
         
         // ì•Œë¦¼ ìƒì„±
         const notification = document.createElement('div');
         notification.id = 'searchResultNotification';
         notification.style.cssText = `
           position: fixed;
           top: 20px;
           left: 50%;
           transform: translateX(-50%);
           z-index: 10000;
           background: linear-gradient(135deg, #10b981, #059669);
           color: white;
           padding: 16px 24px;
           border-radius: 12px;
           box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
           font-size: 14px;
           font-weight: 600;
           max-width: 90vw;
           text-align: center;
           animation: slideInFromTop 0.3s ease-out;
         `;
         
         notification.textContent = message;
         document.body.appendChild(notification);
         
         // 3ì´ˆ í›„ ìë™ ì œê±°
         setTimeout(() => {
           if (notification && notification.parentNode) {
             notification.style.animation = 'fadeOut 0.3s ease-out';
             setTimeout(() => {
               if (notification && notification.parentNode) {
                 notification.remove();
               }
             }, 300);
           }
         }, 3000);
       }
       

       
       // êµ¬ê¸€ë§µì—ì„œ ì¥ì†Œ ì—´ê¸° í•¨ìˆ˜
       function openInGoogleMaps(lat, lng, placeName, encodedAddress) {
         try {
           // ëª¨ë°”ì¼ ê¸°ê¸°ì¸ì§€ í™•ì¸
           // ì „ì—­ isMobile ë³€ìˆ˜ ì‚¬ìš© (isMobileDevice â†’ isMobile)
           const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
           const isAndroid = /Android/i.test(navigator.userAgent);
           
           if (isMobile) {
             // ëª¨ë°”ì¼: êµ¬ê¸€ë§µ ì•±ìœ¼ë¡œ ì§ì ‘ ì—°ê²°
             let appUrl;
             
             if (isIOS) {
               // iOS: êµ¬ê¸€ë§µ ì•± ì§ì ‘ ìŠ¤í‚´ ì‚¬ìš©
               appUrl = `comgooglemaps://?center=${lat},${lng}&zoom=16&q=${lat},${lng}`;
             } else if (isAndroid) {
               // Android: êµ¬ê¸€ë§µ ì•± ì§ì ‘ ì¸í…íŠ¸ ì‚¬ìš©
               appUrl = `geo:${lat},${lng}?q=${lat},${lng}(${placeName || ''})?z=16`;
             } else {
               // ê¸°íƒ€ ëª¨ë°”ì¼: êµ¬ê¸€ë§µ ì•± ìŠ¤í‚´ ì‹œë„
               appUrl = `comgooglemaps://?center=${lat},${lng}&zoom=16&q=${lat},${lng}`;
             }
             
             // ì•±ìœ¼ë¡œ ë°”ë¡œ ì´ë™
             window.location.href = appUrl;
             console.log(`${isIOS ? 'iOS' : isAndroid ? 'Android' : 'ê¸°íƒ€ ëª¨ë°”ì¼'}ì—ì„œ êµ¬ê¸€ë§µ ì•± ì§ì ‘ ì‹¤í–‰:`, appUrl);
             console.log('ì¥ì†Œ:', placeName, 'at', lat, lng);
             
           } else {
             // ë°ìŠ¤í¬í†±: ì›¹ ë¸Œë¼ìš°ì €ë¡œ êµ¬ê¸€ë§µ ì—´ê¸°
             const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}&zoom=16`;
             window.open(googleMapsUrl, '_blank', 'noopener,noreferrer');
             console.log('ë°ìŠ¤í¬í†±ì—ì„œ êµ¬ê¸€ë§µ ì›¹ìœ¼ë¡œ ì—´ê¸°:', placeName, 'at', lat, lng);
           }
           
           // ì‚¬ìš©ìì—ê²Œ í”¼ë“œë°± ì œê³µ
           showSearchResultNotification(`"${decodeURIComponent(encodedAddress)}" êµ¬ê¸€ë§µì—ì„œ ì—´ê¸°`);
           
         } catch (error) {
           console.error('êµ¬ê¸€ë§µ ì—´ê¸° ì‹¤íŒ¨:', error);
           alert('êµ¬ê¸€ë§µì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
         }
       }
       
       // ì£¼ì†Œ ë§ˆì»¤ ê°€ì‹œì„± í™•ì¸ ë° ìë™ ì œê±° í•¨ìˆ˜
       function checkAddressMarkerVisibility() {
         if (map) {
           const bounds = map.getBounds();
           if (!bounds) return;
           
           // ì—¬ëŸ¬ ë§ˆì»¤ë“¤ ì¤‘ ë·°ì—ì„œ ë²—ì–´ë‚œ ê²ƒë“¤ í™•ì¸
           let removedCount = 0;
           for (let i = addressMarkers.length - 1; i >= 0; i--) {
             const marker = addressMarkers[i];
             const markerPosition = marker.getPosition();
             if (!bounds.contains(markerPosition)) {
               marker.setMap(null);
               addressMarkers.splice(i, 1);
               removedCount++;
             }
           }
           
           if (removedCount > 0) {
             console.log(`${removedCount}ê°œì˜ ê²€ìƒ‰ ë§ˆì»¤ê°€ ë·°ì—ì„œ ë²—ì–´ë‚˜ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
           }
           
           // ê¸°ì¡´ ë‹¨ì¼ ë§ˆì»¤ë„ í™•ì¸ (í˜¸í™˜ì„±)
           if (addressMarker && !bounds.contains(addressMarker.getPosition())) {
             // ì—´ë¦° ì •ë³´ì°½ ë‹«ê¸°
             if (currentInfoWindow) {
               currentInfoWindow.close();
               currentInfoWindow = null;
             }
             // ë§ˆì»¤ê°€ ë·°ì—ì„œ ë²—ì–´ë‚˜ë©´ ìë™ìœ¼ë¡œ ì œê±°
             addressMarker.setMap(null);
             addressMarker = null;
             document.getElementById('addressInput').value = '';
             console.log('ì£¼ì†Œ ë§ˆì»¤ê°€ ì§€ë„ ë·°ì—ì„œ ë²—ì–´ë‚˜ ìë™ìœ¼ë¡œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
           }
         }
       }
       
       // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ê°€ì‹œì„± í™•ì¸ ë° ìë™ ì œê±° í•¨ìˆ˜
       function checkCurrentLocationMarkerVisibility() {
         if (currentLocationMarker && map) {
           const bounds = map.getBounds();
           const markerPosition = currentLocationMarker.getPosition();
           
           // ë§ˆì»¤ê°€ í˜„ì¬ ì§€ë„ ë·°ì˜ ê²½ê³„ ë°–ì— ìˆëŠ”ì§€ í™•ì¸
           if (bounds && !bounds.contains(markerPosition)) {
             // ì—´ë¦° ì •ë³´ì°½ ë‹«ê¸°
             if (currentInfoWindow) {
               currentInfoWindow.close();
               currentInfoWindow = null;
             }
             // ë§ˆì»¤ê°€ ë·°ì—ì„œ ë²—ì–´ë‚˜ë©´ ìë™ìœ¼ë¡œ ì œê±°
             currentLocationMarker.setMap(null);
             currentLocationMarker = null;
             console.log('í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ê°€ ì§€ë„ ë·°ì—ì„œ ë²—ì–´ë‚˜ ìë™ìœ¼ë¡œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
           }
         }
       }
       
       // ì£¼ì†Œ ë§ˆì»¤ ì œê±° í•¨ìˆ˜ (ìˆ˜ë™ ì œê±°ìš©)
       function clearAddressMarker() {
         // ìƒˆë¡œìš´ ì—¬ëŸ¬ ë§ˆì»¤ ì œê±° í•¨ìˆ˜ í˜¸ì¶œ
         clearAllAddressMarkers();
       }
       
       // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì œê±° í•¨ìˆ˜ (ìˆ˜ë™ ì œê±°ìš©)
       function clearCurrentLocationMarker() {
         if (currentLocationMarker) {
           // ì—´ë¦° ì •ë³´ì°½ ë‹«ê¸°
           if (currentInfoWindow) {
             currentInfoWindow.close();
             currentInfoWindow = null;
           }
           currentLocationMarker.setMap(null);
           currentLocationMarker = null;
         }
       }

      function showAddressSelection(results, queryText) {
        // í˜¸í™˜ì„±ì„ ìœ„í•´ ìƒˆë¡œìš´ ê°œì„ ëœ í•¨ìˆ˜ë¡œ ë¦¬ë””ë ‰ì…˜
        showEnhancedAddressSelection(results, queryText);
      }

      function closeAddressSelection() {
        var dialog = document.getElementById('addressSelectDialog');
        if (dialog) dialog.remove();
      }

      function chooseAddressResult(index) {
        try {
          var candidates = addressSearchCandidates || [];
          if (!candidates.length || !candidates[index]) {
            closeAddressSelection();
            alert('ì„ íƒí•  ìˆ˜ ìˆëŠ” ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          var result = candidates[index];
          
          // ìƒˆë¡œìš´ ë§ˆì»¤ ìƒì„± í•¨ìˆ˜ ì‚¬ìš©
          createAddressMarker(result, result.name || result.formatted_address || 'ì„ íƒëœ ìœ„ì¹˜');
        } finally {
          closeAddressSelection();
          addressSearchCandidates = [];
        }
      }
      // ìŠ¤ì™€ì´í”„ ì‚­ì œ/ìˆ˜ì • ê¸°ëŠ¥ ì´ˆê¸°í™” - ëª¨ë°”ì¼ ìµœì í™”
      function initializeSwipeDelete() {
        const allItems = document.querySelectorAll('.user-added-item, .checklist-item');
        
        allItems.forEach(item => {
          let startX = 0;
          let currentX = 0;
          let startY = 0;
          let currentY = 0;
          let isSwiping = false;
          let hasSwiped = false;
          let startTime = 0;
          
          // í„°ì¹˜ ì‹œì‘ - ëª¨ë°”ì¼ ìµœì í™”
          item.addEventListener('touchstart', function(e) {
            // ì‚­ì œ ë²„íŠ¼ì´ë‚˜ ì²´í¬ë°•ìŠ¤ í´ë¦­ ì‹œì—ëŠ” ìŠ¤ì™€ì´í”„ ë°©ì§€
            if (e.target.classList.contains('swipe-delete-btn') ||
                e.target.classList.contains('prep-checkbox') ||
                e.target.classList.contains('swipe-edit-btn')) {
              console.log('í„°ì¹˜ ì‹œì‘ ì·¨ì†Œ: ë²„íŠ¼ í´ë¦­');
              return;
            }
            
            // ë‹¤ë¥¸ ì•„ì´í…œì˜ ìŠ¤ì™€ì´í”„ ìƒíƒœ í•´ì œ
            clearAllSwipeStates();
            
            console.log('í„°ì¹˜ ì‹œì‘:', this.dataset.itemId);
            
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            startTime = Date.now();
            isSwiping = true;
            hasSwiped = false;
            this.classList.add('swiping');
            
            // ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ
            if (currentLongPressTimer) {
              clearTimeout(currentLongPressTimer);
            }
            
            // í˜„ì¬ ë“œë˜ê·¸ ì•„ì´í…œ ì„¤ì •
            currentDragItem = this;
            
            // ë¡±í”„ë ˆìŠ¤ íƒ€ì´ë¨¸ ì‹œì‘ (800ms í›„ ë“œë˜ê·¸ ëª¨ë“œ í™œì„±í™”)
            currentLongPressTimer = setTimeout(() => {
              console.log('ë¡±í”„ë ˆìŠ¤ íƒ€ì´ë¨¸ ì‹¤í–‰:', {
                isSwiping,
                hasSwiped,
                currentDragItem: currentDragItem === this,
                element: this.dataset.itemId
              });
              
              if (isSwiping && !hasSwiped && currentDragItem === this) {
                // ê°€ìƒ ì´ë²¤íŠ¸ ê°ì²´ ìƒì„± (í˜„ì¬ í„°ì¹˜ ìœ„ì¹˜ ê¸°ì¤€)
                const mockEvent = {
                  touches: [{
                    clientX: startX,
                    clientY: startY
                  }]
                };
                startDragMode(this, mockEvent);
              }
            }, 800);
          }, { passive: false });
          
          // í„°ì¹˜ ì´ë™ - ëª¨ë°”ì¼ ìµœì í™”
          item.addEventListener('touchmove', function(e) {
            if (!isSwiping) return;
            
            currentX = e.touches[0].clientX;
            currentY = e.touches[0].clientY;
            const diffX = startX - currentX;
            const diffY = Math.abs(startY - currentY);
            const diffTime = Date.now() - startTime;
            
            // ë“œë˜ê·¸ ëª¨ë“œì¼ ë•Œ
            if (isDraggingGlobal) {
              e.preventDefault();
              handleDragMove(this, e);
              return;
            }
            
            // ë¡±í”„ë ˆìŠ¤ íƒ€ì´ë¨¸ ì·¨ì†Œ (ì›€ì§ì„ì´ ê°ì§€ë˜ë©´)
            if (currentLongPressTimer && (Math.abs(diffX) > 10 || diffY > 10)) {
              clearTimeout(currentLongPressTimer);
              currentLongPressTimer = null;
              currentDragItem = null;
            }
            
            // ì„¸ë¡œ ì›€ì§ì„ì´ ê°€ë¡œë³´ë‹¤ í¬ë©´ ìŠ¤ì™€ì´í”„ ì·¨ì†Œ
            if (diffY > Math.abs(diffX) && diffY > 20) {
              clearTimeout(currentLongPressTimer);
              currentLongPressTimer = null;
              currentDragItem = null;
              return;
            }
            
            // ë¹ ë¥¸ ìŠ¤ì™€ì´í”„ ê°ì§€ (ëª¨ë°”ì¼ì—ì„œ ë” ë¯¼ê°í•˜ê²Œ)
            if (diffX > 30 && diffTime < 500 && diffY < 30) {
              const translateX = Math.min(diffX, 160);
              this.querySelector('.item-content').style.transform = `translateX(-${translateX}px)`;
              hasSwiped = true;
            }
          }, { passive: false });
          
          // í„°ì¹˜ ì¢…ë£Œ - ëª¨ë°”ì¼ ìµœì í™”
          item.addEventListener('touchend', function(e) {
            // ë¡±í”„ë ˆìŠ¤ íƒ€ì´ë¨¸ ì·¨ì†Œ
            if (currentLongPressTimer) {
              clearTimeout(currentLongPressTimer);
              currentLongPressTimer = null;
              currentDragItem = null;
            }
            
            if (!isSwiping) return;
            
            // ë“œë˜ê·¸ ëª¨ë“œ ì¢…ë£Œ
            if (isDraggingGlobal) {
              handleDragEnd(this, e);
              isDraggingGlobal = false;
              isSwiping = false;
              this.classList.remove('swiping');
              return;
            }
            
            isSwiping = false;
            this.classList.remove('swiping');
            
            const diffX = startX - currentX;
            const diffTime = Date.now() - startTime;
            
            // ëª¨ë°”ì¼ì—ì„œ ë” ë¯¼ê°í•œ ìŠ¤ì™€ì´í”„ ê°ì§€
            if (hasSwiped && diffX > 30 && diffTime < 1000) {
              // ìŠ¤ì™€ì´í”„ ì™„ë£Œ - ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
              this.classList.add('swiped');
            } else {
              // ìŠ¤ì™€ì´í”„ ì·¨ì†Œ - ì›ë˜ ìœ„ì¹˜ë¡œ ë³µì›
              this.classList.remove('swiped');
              this.querySelector('.item-content').style.transform = 'translateX(0)';
            }
          }, { passive: false });
          
          // í´ë¦­ ì‹œ ìŠ¤ì™€ì´í”„ ìƒíƒœ í•´ì œ - ëª¨ë°”ì¼ ìµœì í™”
          item.addEventListener('click', function(e) {
            // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í´ë¦­ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ìŠ¤ì™€ì´í”„ í•´ì œ
            if (!e.target.classList.contains('swipe-edit-btn') &&
                !e.target.classList.contains('swipe-delete-btn') &&
                !e.target.classList.contains('prep-checkbox')) {
              clearAllSwipeStates();
            }
          });
          
          // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ (ë°ìŠ¤í¬í†± ì§€ì›) - ë“œë˜ê·¸ì•¤ë“œë¡­ í¬í•¨
          if (!isMobile) {
            let mouseStartTime = 0;
            let mouseHasMoved = false;
            let mouseDragTimer = null;
            
            item.addEventListener('mousedown', function(e) {
              if (e.button !== 0) return; // ì™¼ìª½ ë²„íŠ¼ë§Œ
              
              // ì‚­ì œ ë²„íŠ¼ì´ë‚˜ ì²´í¬ë°•ìŠ¤ í´ë¦­ ì‹œì—ëŠ” ë“œë˜ê·¸ ë°©ì§€
              if (e.target.classList.contains('swipe-delete-btn') ||
                  e.target.classList.contains('prep-checkbox') ||
                  e.target.classList.contains('swipe-edit-btn')) {
                return;
              }
              
              startX = e.clientX;
              startY = e.clientY;
              mouseStartTime = Date.now();
              isSwiping = true;
              hasSwiped = false;
              mouseHasMoved = false;
              this.classList.add('swiping');
              currentDragItem = this;
              
              console.log('ë°ìŠ¤í¬íƒ‘ ë§ˆìš°ìŠ¤ ë‹¤ìš´:', this.dataset.itemId);
              
              // ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” 300ms í›„ ë“œë˜ê·¸ ëª¨ë“œ (ë” ë¹ ë¦„)
              mouseDragTimer = setTimeout(() => {
                if (isSwiping && !hasSwiped && !mouseHasMoved && currentDragItem === this) {
                  console.log('ë°ìŠ¤í¬íƒ‘ ë“œë˜ê·¸ ëª¨ë“œ ì‹œì‘');
                  const mockEvent = {
                    touches: null,
                    clientX: startX,
                    clientY: startY
                  };
                  startDragMode(this, mockEvent);
                }
              }, 300);
              
              const handleMouseMove = (e) => {
                if (!isSwiping) return;
                
                currentX = e.clientX;
                currentY = e.clientY;
                const diffX = startX - currentX;
                const diffY = Math.abs(startY - currentY);
                
                // ì›€ì§ì„ ê°ì§€
                if (Math.abs(diffX) > 5 || diffY > 5) {
                  mouseHasMoved = true;
                }
                
                // ë“œë˜ê·¸ ëª¨ë“œì¼ ë•Œ
                if (isDraggingGlobal) {
                  e.preventDefault();
                  const mockEvent = {
                    touches: null,
                    clientX: e.clientX,
                    clientY: e.clientY
                  };
                  handleDragMove(this, mockEvent);
                  return;
                }
                
                // ì„¸ë¡œ ì›€ì§ì„ì´ í¬ë©´ ë“œë˜ê·¸ íƒ€ì´ë¨¸ ì·¨ì†Œ
                if (diffY > Math.abs(diffX) && diffY > 20) {
                  if (mouseDragTimer) {
                    clearTimeout(mouseDragTimer);
                    mouseDragTimer = null;
                  }
                  return;
                }
                
                // ìŠ¤ì™€ì´í”„ ì²˜ë¦¬ (ê°€ë¡œ ì›€ì§ì„)
                if (diffX > 50 && diffY < 30) {
                  const translateX = Math.min(diffX, 160);
                  this.querySelector('.item-content').style.transform = `translateX(-${translateX}px)`;
                  hasSwiped = true;
                  
                  // ë“œë˜ê·¸ íƒ€ì´ë¨¸ ì·¨ì†Œ (ìŠ¤ì™€ì´í”„ ì¤‘)
                  if (mouseDragTimer) {
                    clearTimeout(mouseDragTimer);
                    mouseDragTimer = null;
                  }
                }
              };
              
              const handleMouseUp = (e) => {
                if (mouseDragTimer) {
                  clearTimeout(mouseDragTimer);
                  mouseDragTimer = null;
                }
                
                console.log('ë°ìŠ¤í¬íƒ‘ ë§ˆìš°ìŠ¤ ì—…:', { isDraggingGlobal, isSwiping });
                
                if (!isSwiping) return;
                
                // ë“œë˜ê·¸ ëª¨ë“œ ì¢…ë£Œ
                if (isDraggingGlobal) {
                  const mockEvent = {
                    touches: null,
                    clientX: e.clientX,
                    clientY: e.clientY
                  };
                  handleDragEnd(this, mockEvent);
                  isDraggingGlobal = false;
                  isSwiping = false;
                  this.classList.remove('swiping');
                  currentDragItem = null;
                  
                  document.removeEventListener('mousemove', handleMouseMove);
                  document.removeEventListener('mouseup', handleMouseUp);
                  return;
                }
                
                isSwiping = false;
                this.classList.remove('swiping');
                currentDragItem = null;
                
                if (hasSwiped && (startX - currentX) > 50) {
                  // ìŠ¤ì™€ì´í”„ ì™„ë£Œ - ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
                  this.classList.add('swiped');
                } else {
                  // ìŠ¤ì™€ì´í”„ ì·¨ì†Œ - ì›ë˜ ìœ„ì¹˜ë¡œ ë³µì›
                  this.classList.remove('swiped');
                  this.querySelector('.item-content').style.transform = 'translateX(0)';
                }
                
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
              };
              
              document.addEventListener('mousemove', handleMouseMove);
              document.addEventListener('mouseup', handleMouseUp);
            });
          }
        });
      }
      
      // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
      let dragElement = null;
      let dragPlaceholder = null;
      let dragOffset = { x: 0, y: 0 };
      let isDraggingGlobal = false;
      let draggedItemType = 'user'; // ë“œë˜ê·¸ëœ í•­ëª© íƒ€ì…
      let currentLongPressTimer = null;
      let currentDragItem = null;
      
      // ë“œë˜ê·¸ ëª¨ë“œ ì‹œì‘
      function startDragMode(element, event) {
        console.log('ë“œë˜ê·¸ ëª¨ë“œ ì‹œì‘');
        isDraggingGlobal = true;
        dragElement = element;
        
        // ë“œë˜ê·¸ëœ í•­ëª© íƒ€ì… ì„¤ì •
        draggedItemType = element.getAttribute('data-item-type') || 'user';
        console.log('ë“œë˜ê·¸ëœ í•­ëª© íƒ€ì…:', draggedItemType);
        
        // ìŠ¤ì™€ì´í”„ ìƒíƒœ ì´ˆê¸°í™”
        element.classList.remove('swiped');
        if (element.querySelector('.item-content')) {
          element.querySelector('.item-content').style.transform = 'translateX(0)';
        }
        
        // í–…í‹± í”¼ë“œë°± (ì§€ì›í•˜ëŠ” ê¸°ê¸°ì—ì„œ)
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
        
        // ì›ë˜ ìœ„ì¹˜ì™€ í¬ê¸° ì €ì¥
        const rect = element.getBoundingClientRect();
        const computedStyle = getComputedStyle(element);
        
        // í”Œë ˆì´ìŠ¤í™€ë” ìƒì„± (ë” ìì—°ìŠ¤ëŸ¬ìš´ ë””ìì¸)
        dragPlaceholder = document.createElement('div');
        dragPlaceholder.className = 'drag-placeholder';
        dragPlaceholder.style.height = rect.height + 'px';
        dragPlaceholder.style.margin = computedStyle.margin;
        dragPlaceholder.style.backgroundColor = '#f3f4f6';
        dragPlaceholder.style.border = '2px dashed #3b82f6';
        dragPlaceholder.style.borderRadius = '12px';
        dragPlaceholder.style.opacity = '0.8';
        dragPlaceholder.style.transition = 'all 0.2s ease';
        dragPlaceholder.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; font-size: 14px;">ì—¬ê¸°ì— ë†“ê¸°</div>';
        
        // í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì›ë˜ ìœ„ì¹˜ì— ì‚½ì…
        element.parentNode.insertBefore(dragPlaceholder, element);
        
        // ë“œë˜ê·¸ ìš”ì†Œë¥¼ bodyë¡œ ì´ë™ (ì •í™•í•œ ìœ„ì¹˜ ê³„ì‚°)
        document.body.appendChild(element);
        
        // í„°ì¹˜ ìœ„ì¹˜ì— ë”°ë¥¸ ì˜¤í”„ì…‹ ê³„ì‚°
        const touch = event.touches ? event.touches[0] : event;
        dragOffset.x = touch.clientX - rect.left;
        dragOffset.y = touch.clientY - rect.top;
        
        // ë“œë˜ê·¸ ìš”ì†Œ ìŠ¤íƒ€ì¼ ì„¤ì • (ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜)
        element.style.position = 'fixed';
        element.style.left = (touch.clientX - dragOffset.x) + 'px';
        element.style.top = (touch.clientY - dragOffset.y) + 'px';
        element.style.width = rect.width + 'px';
        element.style.height = rect.height + 'px';
        element.style.zIndex = '10000';
        element.style.opacity = '0.9';
        element.style.transform = 'scale(1.02) rotate(2deg)';
        element.style.boxShadow = '0 12px 30px rgba(0,0,0,0.25), 0 4px 15px rgba(0,0,0,0.1)';
        element.style.transition = 'transform 0.1s ease-out';
        element.style.pointerEvents = 'none';
        element.style.borderRadius = '12px';
        element.style.backgroundColor = '#ffffff';
        
        // ë“œë˜ê·¸ ì‹œì‘ ì• ë‹ˆë©”ì´ì…˜
        requestAnimationFrame(() => {
          element.style.transform = 'scale(1.05) rotate(3deg)';
        });
      }
      
      // ë“œë˜ê·¸ ì´ë™ ì²˜ë¦¬ (ê°œì„ ëœ ë²„ì „)
      function handleDragMove(element, event) {
        if (!isDraggingGlobal || !dragElement) return;
        
        const pointer = event.touches ? event.touches[0] : event;
        
        // ë“œë˜ê·¸ ìš”ì†Œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (ë¶€ë“œëŸ¬ìš´ ì´ë™)
        const newX = pointer.clientX - dragOffset.x;
        const newY = pointer.clientY - dragOffset.y;
        
        dragElement.style.left = newX + 'px';
        dragElement.style.top = newY + 'px';
        
        // ë“œë˜ê·¸ ì¤‘ ë¯¸ë¬˜í•œ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
        dragElement.style.transform = 'scale(1.05) rotate(3deg)';
        
        // ë“œë¡­ ëŒ€ìƒ ì°¾ê¸° (ë” ì •í™•í•œ ê°ì§€)
        dragElement.style.pointerEvents = 'none'; // ë“œë˜ê·¸ ìš”ì†Œ ë¬´ì‹œ
        const elementBelow = document.elementFromPoint(pointer.clientX, pointer.clientY);
        dragElement.style.pointerEvents = 'auto';
        
        // ë“œë˜ê·¸ ì¤‘ì¸ í•­ëª©ì˜ íƒ€ì…ì— ë”°ë¼ ëŒ€ìƒ ê²°ì •
        const dragItemType = dragElement.getAttribute('data-item-type');
        const targetSelector = dragItemType === 'schedule' 
          ? '.user-added-item[data-item-type="schedule"]' 
          : '.user-added-item[data-item-type="user"]';
        const targetItem = elementBelow ? elementBelow.closest(targetSelector) : null;
        
        if (targetItem && targetItem !== dragElement && targetItem !== dragPlaceholder) {
          const container = targetItem.parentNode;
          const targetRect = targetItem.getBoundingClientRect();
          const targetCenter = targetRect.top + targetRect.height / 2;
          
          // ìŠ¤í¬ë¡¤ ì˜ì—­ ê°ì§€ ë° ìë™ ìŠ¤í¬ë¡¤
          const scrollContainer = container.closest('.scrollable-area') || container.closest('.user-items-container');
          if (scrollContainer) {
            const scrollRect = scrollContainer.getBoundingClientRect();
            const scrollThreshold = 50;
            
            if (pointer.clientY < scrollRect.top + scrollThreshold) {
              // ìœ„ë¡œ ìŠ¤í¬ë¡¤
              scrollContainer.scrollTop -= 5;
            } else if (pointer.clientY > scrollRect.bottom - scrollThreshold) {
              // ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
              scrollContainer.scrollTop += 5;
            }
          }
          
          // í”Œë ˆì´ìŠ¤í™€ë” ìœ„ì¹˜ ê²°ì • (ë” ìì—°ìŠ¤ëŸ¬ìš´ ê°ì§€)
          const insertBefore = pointer.clientY < targetCenter;
          const newPosition = insertBefore ? targetItem : targetItem.nextSibling;
          
          // í”Œë ˆì´ìŠ¤í™€ë”ê°€ ì´ë¯¸ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ì— ìˆëŠ”ì§€ í™•ì¸
          if (dragPlaceholder.nextSibling !== newPosition) {
            // í”Œë ˆì´ìŠ¤í™€ë” ì´ë™ ì• ë‹ˆë©”ì´ì…˜
            dragPlaceholder.style.transform = 'scale(0.95)';
            
            requestAnimationFrame(() => {
              container.insertBefore(dragPlaceholder, newPosition);
              dragPlaceholder.style.transform = 'scale(1)';
              
              // í”Œë ˆì´ìŠ¤í™€ë” ê°•ì¡° íš¨ê³¼
              dragPlaceholder.style.backgroundColor = '#dbeafe';
              dragPlaceholder.style.borderColor = '#2563eb';
              
              setTimeout(() => {
                dragPlaceholder.style.backgroundColor = '#f3f4f6';
                dragPlaceholder.style.borderColor = '#3b82f6';
              }, 150);
            });
          }
        }
      }
      
      // ë“œë˜ê·¸ ì¢…ë£Œ ì²˜ë¦¬ (ê°œì„ ëœ ë²„ì „)
      function handleDragEnd(element, event) {
        if (!isDraggingGlobal || !dragElement) return;
        
        console.log('ë“œë˜ê·¸ ì¢…ë£Œ');
        
        // ë“œë¡­ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
        dragElement.style.transition = 'all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
        dragElement.style.transform = 'scale(1) rotate(0deg)';
        dragElement.style.opacity = '1';
        
        // ìµœì¢… ìœ„ì¹˜ ê³„ì‚°
        let finalContainer;
        if (dragPlaceholder && dragPlaceholder.parentNode) {
          finalContainer = dragPlaceholder.parentNode;
          const placeholderRect = dragPlaceholder.getBoundingClientRect();
          
          // ìµœì¢… ìœ„ì¹˜ë¡œ ì• ë‹ˆë©”ì´ì…˜
          dragElement.style.left = placeholderRect.left + 'px';
          dragElement.style.top = placeholderRect.top + 'px';
          
          // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì •ë¦¬
          setTimeout(() => {
            // ë“œë˜ê·¸ ìš”ì†Œë¥¼ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ì— ì‚½ì…
            finalContainer.insertBefore(dragElement, dragPlaceholder);
            
            // ë“œë˜ê·¸ ìš”ì†Œ ìŠ¤íƒ€ì¼ ì™„ì „ ë³µì›
            dragElement.style.position = '';
            dragElement.style.zIndex = '';
            dragElement.style.opacity = '';
            dragElement.style.transform = '';
            dragElement.style.boxShadow = '';
            dragElement.style.transition = '';
            dragElement.style.pointerEvents = '';
            dragElement.style.left = '';
            dragElement.style.top = '';
            dragElement.style.width = '';
            dragElement.style.height = '';
            dragElement.style.borderRadius = '';
            dragElement.style.backgroundColor = '';
            
            // í”Œë ˆì´ìŠ¤í™€ë” ì œê±°
            if (dragPlaceholder) {
              dragPlaceholder.remove();
            }
            
            // ì„±ê³µ í–…í‹± í”¼ë“œë°±
            if (navigator.vibrate) {
              navigator.vibrate([30, 10, 30]);
            }
            
            // Firebaseì—ë§Œ ì €ì¥ (ë‹¨ì¼ í•¨ìˆ˜ë¡œ ê°„ì†Œí™”)
            saveItemOrderToFirebaseOnly();
            
            // ì •ë¦¬
            dragElement = null;
            dragPlaceholder = null;
            isDraggingGlobal = false;
            currentDragItem = null;
            if (currentLongPressTimer) {
              clearTimeout(currentLongPressTimer);
              currentLongPressTimer = null;
            }
            
            console.log('ë“œë˜ê·¸ì•¤ë“œë¡­ ì™„ë£Œ ë° Firebase ë™ê¸°í™” ì‹œì‘');
          }, 300);
          
        } else {
          // í”Œë ˆì´ìŠ¤í™€ë”ê°€ ì—†ëŠ” ê²½ìš° ì¦‰ì‹œ ì •ë¦¬
          resetDragState();
        }
      }
      
      // ë“œë˜ê·¸ ìƒíƒœ ë¦¬ì…‹ í•¨ìˆ˜
      function resetDragState() {
        if (dragElement) {
          // ë“œë˜ê·¸ ìš”ì†Œ ìŠ¤íƒ€ì¼ ë³µì›
          dragElement.style.position = '';
          dragElement.style.zIndex = '';
          dragElement.style.opacity = '';
          dragElement.style.transform = '';
          dragElement.style.boxShadow = '';
          dragElement.style.transition = '';
          dragElement.style.pointerEvents = '';
          dragElement.style.left = '';
          dragElement.style.top = '';
          dragElement.style.width = '';
          dragElement.style.height = '';
          dragElement.style.borderRadius = '';
          dragElement.style.backgroundColor = '';
        }
        
        if (dragPlaceholder) {
          dragPlaceholder.remove();
        }
        
        dragElement = null;
        dragPlaceholder = null;
        isDraggingGlobal = false;
        currentDragItem = null;
        if (currentLongPressTimer) {
          clearTimeout(currentLongPressTimer);
          currentLongPressTimer = null;
        }
      }
      
      // Firebase ì „ìš© ê°„ì†Œí™”ëœ í•­ëª© ìˆœì„œ ì €ì¥
      async function saveItemOrderToFirebaseOnly() {
        try {
          console.log('ë“œë˜ê·¸ì•¤ë“œë¡­ ìˆœì„œ ë³€ê²½ - Firebase ì €ì¥ ì‹œì‘');
          
          // ë™ê¸°í™” ì¤‘ì´ë©´ ë¬´ì‹œ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
          if (isSyncing) {
            console.log('ë™ê¸°í™” ì¤‘ì´ë¯€ë¡œ ìˆœì„œ ì €ì¥ ê±´ë„ˆëœ€');
            return;
          }
          
          // ë“œë˜ê·¸ëœ í•­ëª© íƒ€ì…ì— ë”°ë¼ ì»¨í…Œì´ë„ˆ ì„ íƒ
          let container;
          if (draggedItemType === 'schedule') {
            container = document.getElementById('additionalDays');
          } else {
            container = document.getElementById('userAddedItems');
          }
          if (!container) {
            console.error('ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', { draggedItemType, currentActiveSection: window.currentActiveSection });
            return;
          }
          
          // ë™ê¸°í™” ìƒíƒœ ì„¤ì •
          isSyncing = true;
          
          // ë“œë˜ê·¸ëœ í•­ëª©ì˜ íƒ€ì…ì— ë”°ë¼ êµ¬ë¶„í•˜ì—¬ ì²˜ë¦¬
          const items = Array.from(container.querySelectorAll('.user-added-item[data-item-id], .user-added-item[data-schedule-id]'));
          const newOrder = items.map((item, index) => {
            const itemId = item.getAttribute('data-item-id') || item.getAttribute('data-schedule-id');
            const itemType = item.getAttribute('data-item-type');
            const title = item.querySelector('.item-content .item-title')?.textContent || 
                         item.querySelector('.item-content span')?.textContent || 
                         item.querySelector('button')?.textContent || 
                         'Unknown';
            
            return {
              id: itemId,
              title: title,
              order: index,
              type: itemType
            };
          });
          
          console.log('ìƒˆë¡œìš´ í•­ëª© ìˆœì„œ:', newOrder);
          console.log('ë“œë˜ê·¸ëœ í•­ëª© íƒ€ì…:', draggedItemType);
          
          if (draggedItemType === 'schedule') {
            // ì¼ì • í•­ëª© ìˆœì„œ ì €ì¥
            await saveScheduleOrderDirect(newOrder);
          } else {
            // ì‚¬ìš©ì ì¶”ê°€ í•­ëª© ìˆœì„œ ì €ì¥  
            await saveUserItemOrderDirect(newOrder);
          }
          
        } catch (error) {
          console.error('ë“œë˜ê·¸ì•¤ë“œë¡­ ìˆœì„œ ì €ì¥ ì‹¤íŒ¨:', error);
          updateSyncStatus('ìˆœì„œ ì €ì¥ ì‹¤íŒ¨', 'error');
          
          // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
          setTimeout(() => {
            updateSyncStatus('Firebase ì—°ê²° ì‹¤íŒ¨', 'error');
          }, 2000);
        } finally {
          // ë™ê¸°í™” ìƒíƒœ í•´ì œ (ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™” í—ˆìš©)
          isSyncing = false;
        }
      }
      
      // ì‚¬ìš©ì í•­ëª© ìˆœì„œ ì§ì ‘ Firebase ì €ì¥
      async function saveUserItemOrderDirect(newOrder) {
        try {
          console.log('ì‚¬ìš©ì í•­ëª© ìˆœì„œ Firebase ì €ì¥ ì‹œì‘');
          
          if (!window.db || !window.firestore) {
            console.error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
          }
          
          // í˜„ì¬ ì „ì—­ ìƒíƒœì—ì„œ í•­ëª©ë“¤ ê°€ì ¸ì˜¤ê¸°
          const currentItems = window.firebaseUserItems || [];
          const currentSection = window.currentActiveSection || '';
          
          // ì‚¬ìš©ì í•­ëª©ë§Œ í•„í„°ë§
          const userItems = newOrder.filter(item => item.type === 'user');
          
          // ìˆœì„œ ì—…ë°ì´íŠ¸
          userItems.forEach((orderInfo, index) => {
            const item = currentItems.find(item => item.id === orderInfo.id && item.section === currentSection);
            if (item) {
              item.order = index;
            }
          });
          
          // Firebaseì— ì €ì¥
          await window.firestore.setDoc(window.firestore.doc(window.db, 'users', 'currentUser'), {
            userAddedItems: currentItems,
            lastUpdated: window.firestore.serverTimestamp()
          }, { merge: true });
          
          // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
          window.firebaseUserItems = currentItems;
          
          console.log('ì‚¬ìš©ì í•­ëª© ìˆœì„œ Firebase ì €ì¥ ì™„ë£Œ');
          onFirebaseUploadSuccess('í•­ëª© ìˆœì„œ');
          
        } catch (error) {
          console.error('ì‚¬ìš©ì í•­ëª© ìˆœì„œ ì €ì¥ ì‹¤íŒ¨:', error);
          throw error;
        }
      }
      
      // ì¼ì • ìˆœì„œ ì§ì ‘ Firebase ì €ì¥
      async function saveScheduleOrderDirect(newOrder) {
        try {
          console.log('ì¼ì • ìˆœì„œ Firebase ì €ì¥ ì‹œì‘');
          
          if (!window.db || !window.firestore) {
            console.error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
          }
          
          // Firebaseì—ì„œ í˜„ì¬ ì¼ì •ë“¤ì„ ê°€ì ¸ì˜¤ê¸°
          const docSnap = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'));
          if (docSnap.exists() && docSnap.data().customSchedules) {
            const customSchedules = docSnap.data().customSchedules;
            
            // ì¼ì • í•­ëª©ë§Œ í•„í„°ë§
            const scheduleItems = newOrder.filter(item => item.type === 'schedule');
            
            // ìƒˆë¡œìš´ ìˆœì„œë¡œ ì¬ì •ë ¬
            const reorderedSchedules = [];
            scheduleItems.forEach(orderInfo => {
              const schedule = customSchedules.find(s => s.id === orderInfo.id);
              if (schedule) {
                reorderedSchedules.push(schedule);
              }
            });
            
            // Firebaseì— ì €ì¥
            await window.firestore.updateDoc(
              window.firestore.doc(window.db, 'users', 'currentUser'),
              {
                customSchedules: reorderedSchedules,
                lastUpdated: window.firestore.serverTimestamp()
              }
            );
            
            console.log('ì¼ì • ìˆœì„œ Firebase ì €ì¥ ì™„ë£Œ');
            onFirebaseUploadSuccess('ì¼ì • ìˆœì„œ');
          }
        } catch (error) {
          console.error('ì¼ì • ìˆœì„œ ì €ì¥ ì‹¤íŒ¨:', error);
          throw error;
        }
      }
      

      

      

      
      // ì „ì—­ ë™ê¸°í™” ìƒíƒœ ê´€ë¦¬
      let isSyncing = false;
      let lastSyncTimestamp = 0;
      let syncRetryCount = 0;
      const MAX_SYNC_RETRIES = 3;
              const SYNC_COOLDOWN = 100; // 0.1ì´ˆ ì¿¨ë‹¤ìš´ (ì¤‘ë³µ ì—…ë°ì´íŠ¸ ë°©ì§€)
      
      // Firebase ì´ˆê¸°í™” ì™„ë£Œ ëŒ€ê¸° ë° ë™ê¸°í™” ì‹œì‘
      function waitForFirebaseAndStartSync() {
        // ë™ê¸°í™” ìƒíƒœ í‘œì‹œê¸° ì¶”ê°€
        addSyncStatusIndicator();
        updateSyncStatus('Firebase ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...', 'info');
        
        // Firebaseê°€ ì´ë¯¸ ì´ˆê¸°í™”ëœ ê²½ìš°
        if (window.db && window.firestore) {
          console.log('Firebase ì´ë¯¸ ì´ˆê¸°í™”ë¨ - ë™ê¸°í™” ì‹œì‘');
          updateSyncStatus('Firebase ì—°ê²°ë¨ - ë™ê¸°í™” ì‹œì‘', 'success');
          setupFirebaseSync();
          return;
        }
        
        // Firebase ì´ˆê¸°í™” ì™„ë£Œ ì´ë²¤íŠ¸ ëŒ€ê¸°
        const maxWaitTime = 10000; // ìµœëŒ€ 10ì´ˆ ëŒ€ê¸°
        let timeoutId;
        
        const firebaseReadyHandler = () => {
          console.log('Firebase ì´ˆê¸°í™” ì™„ë£Œ ì´ë²¤íŠ¸ ìˆ˜ì‹  - ë™ê¸°í™” ì‹œì‘');
          clearTimeout(timeoutId);
          window.removeEventListener('firebaseReady', firebaseReadyHandler);
          updateSyncStatus('Firebase ì´ˆê¸°í™” ì™„ë£Œ - ë™ê¸°í™” ì‹œì‘', 'success');
          setupFirebaseSync();
        };
        
        // íƒ€ì„ì•„ì›ƒ ì„¤ì •
        timeoutId = setTimeout(() => {
          console.warn('Firebase ì´ˆê¸°í™” ì‹œê°„ ì´ˆê³¼ - ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì „í™˜');
          window.removeEventListener('firebaseReady', firebaseReadyHandler);
          updateSyncStatus('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ - ì˜¤í”„ë¼ì¸ ëª¨ë“œ', 'error');
          enableOfflineMode();
        }, maxWaitTime);
        
        // Firebase ì´ˆê¸°í™” ì™„ë£Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        window.addEventListener('firebaseReady', firebaseReadyHandler);
      }
      // Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ì„¤ì • (localStorage ì œê±° ë²„ì „)
      function setupFirebaseSync() {
        try {
          // Firebase ì—°ê²° ìƒíƒœ í™•ì¸
          if (!window.db || !window.firestore) {
            console.error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
            updateSyncStatus('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨', 'error');
            enableOfflineMode();
            return;
          }
          
          // ë™ê¸°í™” ìƒíƒœ í‘œì‹œê¸° ì¶”ê°€
          addSyncStatusIndicator();
          
          const unsubscribe = window.firestore.onSnapshot(
            window.firestore.doc(window.db, 'users', 'currentUser'), 
            (doc) => {
              if (doc.exists()) {
                const data = doc.data();
                const currentTime = Date.now();
                
                // ë§ˆì§€ë§‰ ë™ê¸°í™” í›„ ì¿¨ë‹¤ìš´ ì‹œê°„ í™•ì¸
                if (currentTime - lastSyncTimestamp < SYNC_COOLDOWN) {
                  console.log(`ì¿¨ë‹¤ìš´ ì‹œê°„ìœ¼ë¡œ ì¸í•´ ë™ê¸°í™” ê±´ë„ˆëœ€ (${currentTime - lastSyncTimestamp}ms < ${SYNC_COOLDOWN}ms)`);
                  return;
                }
                
                console.log('Firebaseì—ì„œ ë°ì´í„° ìˆ˜ì‹ :', Object.keys(data));
                console.log('ì‹¤ì‹œê°„ ë™ê¸°í™” ì²˜ë¦¬ ì‹œì‘ - lastUpdated:', data.lastUpdated);
                
                // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë™ê¸°í™” (Firebaseì—ì„œ ì§ì ‘ - í˜„ì¬ ì„¹ì…˜ë§Œ)
                if (data.preparationCheckboxes) {
                  console.log('ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë™ê¸°í™” ì¤‘...');
                  const currentSection = window.currentActiveSection || '';
                  Object.keys(data.preparationCheckboxes).forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox && checkbox.checked !== data.preparationCheckboxes[id]) {
                      // í˜„ì¬ ì„¹ì…˜ì˜ í•­ëª©ì¸ì§€ í™•ì¸
                      const item = window.firebaseUserItems?.find(item => item.id === id);
                      if (item && item.section === currentSection) {
                        checkbox.checked = data.preparationCheckboxes[id];
                      }
                    }
                  });
                  updateSyncStatus('ì²´í¬ë°•ìŠ¤ ë™ê¸°í™” ì™„ë£Œ', 'success');
                }
                
                // ì‚¬ìš©ì ì¶”ê°€ í•­ëª© ë™ê¸°í™” (Firebaseì—ì„œ ì§ì ‘)
                if (data.userAddedItems) {
                  console.log('ì‚¬ìš©ì í•­ëª© ë™ê¸°í™” ì¤‘...');
                  
                  // ê¸°ì¡´ í•­ëª©ê³¼ ë¹„êµí•˜ì—¬ ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
                  const currentItems = window.firebaseUserItems || [];
                  const newItems = data.userAddedItems;
                  
                  // í•­ëª© ê°œìˆ˜, ID, ë˜ëŠ” ìˆœì„œê°€ ë‹¤ë¥´ë©´ ì—…ë°ì´íŠ¸
                  const currentItemsJson = JSON.stringify(currentItems.map(item => ({id: item.id, order: item.order})));
                  const newItemsJson = JSON.stringify(newItems.map(item => ({id: item.id, order: item.order})));
                  
                  if (currentItems.length !== newItems.length || 
                      JSON.stringify(currentItems.map(item => item.id).sort()) !== 
                      JSON.stringify(newItems.map(item => item.id).sort()) ||
                      currentItemsJson !== newItemsJson) {
                    
                    console.log('ì‚¬ìš©ì í•­ëª© ë³€ê²½ ê°ì§€ - UI ì—…ë°ì´íŠ¸');
                    console.log('ê¸°ì¡´ í•­ëª© ìˆ˜:', currentItems.length, 'ìƒˆ í•­ëª© ìˆ˜:', newItems.length);
                    console.log('ìˆœì„œ ë³€ê²½ ê°ì§€:', currentItemsJson !== newItemsJson);
                    
                    // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                    window.firebaseUserItems = newItems;
                    
                    // í˜„ì¬ í™œì„± ì„¹ì…˜ì— ë§ëŠ” í•­ëª©ë§Œ í•„í„°ë§í•˜ì—¬ UI ì—…ë°ì´íŠ¸
                    const currentSection = window.currentActiveSection || '';
                    const filteredItems = newItems.filter(item => item.section === currentSection);
                    
                    console.log('í˜„ì¬ ì„¹ì…˜:', currentSection, 'í•„í„°ë§ëœ í•­ëª© ìˆ˜:', filteredItems.length);
                    
                    // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ë™ê¸°í™”ë§Œìœ¼ë¡œ ì²˜ë¦¬)
                    displayUserAddedItemsFromFirebase(filteredItems);
                    updateSyncStatus('ì‚¬ìš©ì í•­ëª© ë™ê¸°í™” ì™„ë£Œ', 'success');
                  } else {
                    console.log('ì‚¬ìš©ì í•­ëª© ë³€ê²½ ì—†ìŒ - UI ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€');
                  }
                }
                // ê¸°ì¡´ í•­ëª© ìˆ¨ê¹€/ì˜¤ë²„ë¼ì´ë“œ ì‹¤ì‹œê°„ ë™ê¸°í™”
                window.hiddenExistingItems = data.hiddenExistingItems || [];
                window.existingItemOverrides = data.existingItemOverrides || {};
                if (typeof applyOverridesAndHides === 'function') {
                  applyOverridesAndHides();
                }
                
                // ê²½ë¡œ ë™ê¸°í™” (Firebaseì—ì„œ ì§ì ‘)
                if (data.savedUserRoutes) {
                  console.log('ê²½ë¡œ ë™ê¸°í™” ì¤‘...');
                  
                  // ê¸°ì¡´ ê²½ë¡œì™€ ë¹„êµí•˜ì—¬ ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
                  const currentRoutes = savedUserRoutes || [];
                  const newRoutes = data.savedUserRoutes;
                  
                  // ê²½ë¡œ ê°œìˆ˜ë‚˜ IDê°€ ë‹¤ë¥´ë©´ ì—…ë°ì´íŠ¸ (ê°•ì œ ì—…ë°ì´íŠ¸ ì˜µì…˜ ì¶”ê°€)
                  const routesChanged = currentRoutes.length !== newRoutes.length || 
                      JSON.stringify(currentRoutes.map(route => route.id).sort()) !== 
                      JSON.stringify(newRoutes.map(route => route.id).sort());
                  
                  // ì‹¤ì‹œê°„ ë™ê¸°í™” ê°•ì œ ì‹¤í–‰ (ì‚­ì œ ê°ì§€ë¥¼ ìœ„í•´)
                  console.log('ê²½ë¡œ ë™ê¸°í™” ê°•ì œ ì‹¤í–‰ - ì‚­ì œ ê°ì§€ë¥¼ ìœ„í•´');
                  if (true) {  // í•­ìƒ ì—…ë°ì´íŠ¸í•˜ì—¬ ì‚­ì œ ë°˜ì˜
                    
                    console.log('ê²½ë¡œ ë³€ê²½ ê°ì§€ - UI ì—…ë°ì´íŠ¸', {
                      ì´ì „ê°œìˆ˜: currentRoutes.length,
                      ìƒˆê°œìˆ˜: newRoutes.length,
                      ì´ì „IDs: currentRoutes.map(route => route.id),
                      ìƒˆIDs: newRoutes.map(route => route.id)
                    });
                    
                    // ê¸°ì¡´ ë Œë” ìš”ì†Œë¥¼ ë¨¼ì € ì œê±°í•˜ê³  ìƒˆ ë°ì´í„°ë¡œ ê°±ì‹ 
                    clearAllRenderedRoutes();
                    savedUserRoutes = newRoutes;
                    drawAllSavedRoutes();
                    updateRouteRemoveButtons();
                    updateSyncStatus('ê²½ë¡œ ë™ê¸°í™” ì™„ë£Œ', 'success');
                  } else {
                    console.log('ê²½ë¡œ ë³€ê²½ ì—†ìŒ - UI ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€', {
                      routesChanged,
                      lastUpdated: !!data.lastUpdated,
                      í˜„ì¬ê²½ë¡œìˆ˜: currentRoutes.length,
                      ìƒˆê²½ë¡œìˆ˜: newRoutes.length
                    });
                  }
                }
                
                // ë§ˆì»¤ ë™ê¸°í™” (Firebaseì—ì„œ ì§ì ‘)
                if (data.savedUserMarkers) {
                  console.log('ë§ˆì»¤ ë™ê¸°í™” ì¤‘...');
                  
                  // ê¸°ì¡´ ë§ˆì»¤ì™€ ë¹„êµí•˜ì—¬ ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
                  const currentMarkers = window.savedUserMarkers || [];
                  const newMarkers = data.savedUserMarkers;
                  
                  // ë§ˆì»¤ ê°œìˆ˜ë‚˜ IDê°€ ë‹¤ë¥´ë©´ ì—…ë°ì´íŠ¸ (ê°•ì œ ì—…ë°ì´íŠ¸ ì˜µì…˜ ì¶”ê°€)
                  const markersChanged = currentMarkers.length !== newMarkers.length || 
                      JSON.stringify(currentMarkers.map(marker => marker.id).sort()) !== 
                      JSON.stringify(newMarkers.map(marker => marker.id).sort());
                  
                  // ì‹¤ì‹œê°„ ë™ê¸°í™” ê°•ì œ ì‹¤í–‰ (ì‚­ì œ ê°ì§€ë¥¼ ìœ„í•´)
                  console.log('ë§ˆì»¤ ë™ê¸°í™” ê°•ì œ ì‹¤í–‰ - ì‚­ì œ ê°ì§€ë¥¼ ìœ„í•´');
                  if (true) {  // í•­ìƒ ì—…ë°ì´íŠ¸í•˜ì—¬ ì‚­ì œ ë°˜ì˜
                    
                    console.log('ë§ˆì»¤ ë³€ê²½ ê°ì§€ - UI ì—…ë°ì´íŠ¸', {
                      ì´ì „ê°œìˆ˜: currentMarkers.length,
                      ìƒˆê°œìˆ˜: newMarkers.length,
                      ì´ì „IDs: currentMarkers.map(marker => marker.id),
                      ìƒˆIDs: newMarkers.map(marker => marker.id)
                    });
                    
                    // ê¸°ì¡´ ë Œë” ìš”ì†Œë¥¼ ë¨¼ì € ì œê±°í•˜ê³  ìƒˆ ë°ì´í„°ë¡œ ê°±ì‹ 
                    clearAllRenderedMarkers();
                    window.savedUserMarkers = newMarkers;
                    drawAllSavedMarkers();
                    updateMarkerRemoveButtons();
                    updateSyncStatus('ë§ˆì»¤ ë™ê¸°í™” ì™„ë£Œ', 'success');
                  } else {
                    console.log('ë§ˆì»¤ ë³€ê²½ ì—†ìŒ - UI ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€', {
                      markersChanged,
                      lastUpdated: !!data.lastUpdated,
                      í˜„ì¬ë§ˆì»¤ìˆ˜: currentMarkers.length,
                      ìƒˆë§ˆì»¤ìˆ˜: newMarkers.length
                    });
                  }
                }
                
                // ë§ˆì»¤ ì •ë³´ ë°ì´í„° ë™ê¸°í™” (Firebaseì—ì„œ ì§ì ‘)
                if (data.markerInfoData) {
                  console.log('ë§ˆì»¤ ì •ë³´ ë°ì´í„° ë™ê¸°í™” ì¤‘...');
                  
                  // ê¸°ì¡´ ë§ˆì»¤ ì •ë³´ì™€ ë¹„êµí•˜ì—¬ ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
                  const currentMarkerInfo = markerInfoData || {};
                  const newMarkerInfo = data.markerInfoData;
                  
                  // ë§ˆì»¤ ì •ë³´ê°€ ë‹¤ë¥´ë©´ ì—…ë°ì´íŠ¸
                  if (JSON.stringify(currentMarkerInfo) !== JSON.stringify(newMarkerInfo)) {
                    console.log('ë§ˆì»¤ ì •ë³´ ë³€ê²½ ê°ì§€ - ë°ì´í„° ì—…ë°ì´íŠ¸');
                    markerInfoData = newMarkerInfo;
                    
                    // ë§ˆì»¤ í‘œì‹œ ì¦‰ì‹œ ì¬ë Œë”ë§ (ì´ëª¨ì§€ ë°˜ì˜)
                    clearAllRenderedMarkers();
                    drawAllSavedMarkers();
                    
                    updateSyncStatus('ë§ˆì»¤ ì •ë³´ ë™ê¸°í™” ì™„ë£Œ', 'success');
                  } else {
                    console.log('ë§ˆì»¤ ì •ë³´ ë³€ê²½ ì—†ìŒ - ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€');
                  }
                }

                // ê²½ë¡œ ì •ë³´ ë°ì´í„° ë™ê¸°í™” (ë‚´ìš©/ë§í¬)
                if (data.routeInfoData) {
                  console.log('ê²½ë¡œ ì •ë³´ ë°ì´í„° ë™ê¸°í™” ì¤‘...');
                  const currentRouteInfo = routeInfoData || {};
                  const newRouteInfo = data.routeInfoData;
                  if (JSON.stringify(currentRouteInfo) !== JSON.stringify(newRouteInfo)) {
                    routeInfoData = newRouteInfo;
                    // í˜„ì¬ ì—´ë¦° ì •ë³´ì°½ì´ ê²½ë¡œ ì •ë³´ì°½ì´ë©´ ê°±ì‹ 
                    // (ê°„ë‹¨íˆ ì¬ì˜¤í”ˆ ì—†ì´ setContentë¥¼ ìœ„í•´ ë‹¤ì‹œ showRouteInfo í˜¸ì¶œ)
                    // ì—´ë¦° ìƒíƒœì—ì„œ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ clickPositionì€ null ì „ë‹¬
                    try {
                      if (window.currentInfoWindow && window.currentInfoWindow.getContent) {
                        // ê²½ë¡œ ì¤‘ í•˜ë‚˜ë¥¼ ì°¾ì•„ ì—…ë°ì´íŠ¸ ì‹œë„ (ì •í™•í•œ ëŒ€ìƒì€ ë‹¤ìŒ í´ë¦­ì—ì„œ ìµœì‹  í‘œì‹œ)
                        // íŠ¹ë³„íˆ ì¦‰ì‹œ ê°±ì‹ í•˜ì§€ ì•Šì•„ë„ ë‹¤ìŒ í´ë¦­ì— ë°˜ì˜ë˜ë¯€ë¡œ ë¡œê·¸ë§Œ ë‚¨ê¹€
                        console.log('ê²½ë¡œ ì •ë³´ ë™ê¸°í™” ë°˜ì˜ ì™„ë£Œ');
                      }
                    } catch (_) {}
                  }
                }
                
                // ì‚¬ìš©ì ì •ì˜ ì¼ì • ë™ê¸°í™”
                if (data.customSchedules) {
                  console.log('ì‚¬ìš©ì ì •ì˜ ì¼ì • ë™ê¸°í™” ì¤‘...');
                  restoreCustomSchedules();
                  updateSyncStatus('ì¼ì • ë™ê¸°í™” ì™„ë£Œ', 'success');
                }
                
                lastSyncTimestamp = currentTime;
                syncRetryCount = 0;
                updateSyncStatus('ë™ê¸°í™” ì™„ë£Œ', 'success');
                
              } else {
                // ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°
                console.log('Firebase ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ - ë°ì´í„° ì´ˆê¸°í™”');
                clearAllData();
                updateSyncStatus('ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ', 'warning');
              }
            }, 
            (error) => {
              console.error('Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ì˜¤ë¥˜:', error);
              syncRetryCount++;
              
              if (syncRetryCount <= MAX_SYNC_RETRIES) {
                updateSyncStatus(`ë™ê¸°í™” ì˜¤ë¥˜ (${syncRetryCount}/${MAX_SYNC_RETRIES})`, 'error');
                // ìë™ ì¬ì‹œë„
                setTimeout(() => {
                  console.log('ë™ê¸°í™” ì¬ì‹œë„ ì¤‘...');
                  setupFirebaseSync();
                }, 2000 * syncRetryCount);
              } else {
                updateSyncStatus('ë™ê¸°í™” ì‹¤íŒ¨ - ì˜¤í”„ë¼ì¸ ëª¨ë“œ', 'error');
                // ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì „í™˜
                enableOfflineMode();
              }
            }
          );
          
          // êµ¬ë… í•´ì œ í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ì €ì¥
          window.unsubscribeFirebase = unsubscribe;
          
          console.log('Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ì„¤ì • ì™„ë£Œ');
          updateSyncStatus('ë™ê¸°í™” ì—°ê²°ë¨', 'success');
          
        } catch (error) {
          console.error('Firebase ë™ê¸°í™” ì„¤ì • ì‹¤íŒ¨:', error);
          updateSyncStatus('ë™ê¸°í™” ì„¤ì • ì‹¤íŒ¨', 'error');
          enableOfflineMode();
        }
      }
      
      // Firebase ë°ì´í„° ì´ˆê¸°í™” í•¨ìˆ˜ (localStorage ì œê±°)
      function clearAllData() {
        // UI ì´ˆê¸°í™”
        document.querySelectorAll('.prep-checkbox').forEach(cb => cb.checked = false);
        
        // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
        savedUserRoutes = [];
        window.savedUserMarkers = [];
        window.firebaseUserItems = [];
        markerInfoData = {}; // ë§ˆì»¤ ì •ë³´ ë°ì´í„° ì´ˆê¸°í™”
        
        // UI ì—…ë°ì´íŠ¸
        displayUserAddedItemsFromFirebase([]);
        drawAllSavedRoutes();
        drawAllSavedMarkers();
        updateRouteRemoveButtons();
      }
      
      // Firebaseì—ì„œ ì§ì ‘ ì‚¬ìš©ì í•­ëª© í‘œì‹œ (localStorage ì œê±°)
      function displayUserAddedItemsFromFirebase(userItems) {
        const container = document.getElementById('userAddedItems');
        if (!container) return;
        
        if (!userItems || userItems.length === 0) {
          container.innerHTML = '';
          return;
        }
        
        // í˜„ì¬ í™œì„± ì„¹ì…˜ì— ë§ëŠ” í•­ëª©ë§Œ í•„í„°ë§í•˜ê³  ìˆœì„œëŒ€ë¡œ ì •ë ¬
        const currentSection = window.currentActiveSection || '';
        const filteredItems = userItems
          .filter(item => item.section === currentSection)
          .sort((a, b) => (a.order || 0) - (b.order || 0)); // order ì†ì„±ìœ¼ë¡œ ì •ë ¬
        
        if (filteredItems.length === 0) {
          container.innerHTML = '';
          return;
        }
        
        console.log('ìˆœì„œëŒ€ë¡œ ì •ë ¬ëœ í•­ëª©ë“¤:', filteredItems.map(item => `${item.title}(order:${item.order})`));
        
        let html = '';
        filteredItems.forEach(item => {
          const titleElement = item.link 
            ? `<span onclick="openUserItemLink('${item.link}')" style="cursor: pointer;">${item.title}</span>`
            : `${item.title}`;
          
          html += `
            <div class="user-added-item" data-item-id="${item.id}" data-item-type="user">
              <div class="item-content">
                <input type="checkbox" id="${item.id}" class="prep-checkbox" onchange="saveCheckboxStates()" ${item.checked ? 'checked' : ''}>
                <span>${titleElement}</span>
              </div>
              <button class="swipe-edit-btn" onclick="editUserItem('${item.id}', '${item.title}', '${item.description || ''}', '${item.link || ''}')" title="ìˆ˜ì •">ìˆ˜ì •</button>
              <button class="swipe-delete-btn" onclick="deleteUserItem('${item.id}')" title="ì‚­ì œ">ì‚­ì œ</button>
            </div>
          `;
        });
        
        container.innerHTML = html;
        
        // í´ë¦­ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸ ëì— â— í‘œì‹œ ì¶”ê°€
        if (typeof appendExclamationToLinks === 'function') {
          appendExclamationToLinks(container);
        }
        
        // ìŠ¤ì™€ì´í”„ ì‚­ì œ ê¸°ëŠ¥ ì´ˆê¸°í™”
        initializeSwipeDelete();
        
        // ì‚¬ì´ë“œíŒ¨ë„ í„°ì¹˜ ì´ë²¤íŠ¸ ì„¤ì •
        setupSidePanelTouchEvents();
        
        // ëª¨ë°”ì¼ì—ì„œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€
        if (isMobile) {
          const editButtons = container.querySelectorAll('.swipe-edit-btn');
          const deleteButtons = container.querySelectorAll('.swipe-delete-btn');
          
          // ìˆ˜ì • ë²„íŠ¼ í„°ì¹˜ ì´ë²¤íŠ¸ - ëª¨ë°”ì¼ í´ë¦­ ì •í™•ë„ ê°œì„ 
          editButtons.forEach(btn => {
            btn.addEventListener('touchstart', function(e) {
              e.stopPropagation();
              e.preventDefault();
              this.style.transform = 'translateY(-50%)';
              this.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
            }, { passive: false });
            
            btn.addEventListener('touchend', function(e) {
              e.stopPropagation();
              e.preventDefault();
              this.style.transform = 'translateY(-50%)';
              this.style.backgroundColor = 'transparent';
              
              // í„°ì¹˜ ì¢…ë£Œ ì‹œ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ
              const clickEvent = new Event('click', { bubbles: true });
              this.dispatchEvent(clickEvent);
            }, { passive: false });
            
            btn.addEventListener('touchcancel', function(e) {
              e.stopPropagation();
              this.style.transform = 'translateY(-50%)';
              this.style.backgroundColor = 'transparent';
            }, { passive: true });
          });
          
          // ì‚­ì œ ë²„íŠ¼ í„°ì¹˜ ì´ë²¤íŠ¸ - ëª¨ë°”ì¼ í´ë¦­ ì •í™•ë„ ê°œì„ 
          deleteButtons.forEach(btn => {
            btn.addEventListener('touchstart', function(e) {
              e.stopPropagation();
              e.preventDefault();
              this.style.transform = 'translateY(-50%)';
              this.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
            }, { passive: false });
            
            btn.addEventListener('touchend', function(e) {
              e.stopPropagation();
              e.preventDefault();
              this.style.transform = 'translateY(-50%)';
              this.style.backgroundColor = 'transparent';
              
              // í„°ì¹˜ ì¢…ë£Œ ì‹œ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ
              const clickEvent = new Event('click', { bubbles: true });
              this.dispatchEvent(clickEvent);
            }, { passive: false });
            
            btn.addEventListener('touchcancel', function(e) {
              e.stopPropagation();
              this.style.transform = 'translateY(-50%)';
              this.style.backgroundColor = 'transparent';
            }, { passive: true });
          });
            btn.addEventListener('touchstart', function(e) {
              e.stopPropagation();
              e.preventDefault();
              // ì¼ì • í•­ëª©ì€ ìŠ¤ì¼€ì¼ ë³€í™” ì—†ì´ translateYë§Œ ìœ ì§€
              this.style.transform = 'translateY(-50%)';
            }, { passive: false });
            
            btn.addEventListener('touchend', function(e) {
              e.stopPropagation();
              e.preventDefault();
              // ì¼ì • í•­ëª©ì€ ì›ë˜ ìœ„ì¹˜ ìœ ì§€
              this.style.transform = 'translateY(-50%)';
              
              const itemId = this.closest('.user-added-item, .checklist-item').getAttribute('data-item-id');
              if (itemId) {
                // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ í„°ì¹˜ í”¼ë“œë°±ì„ ë³´ì—¬ì¤Œ
                setTimeout(() => {
                  const itemType = this.closest('.user-added-item, .checklist-item').getAttribute('data-item-type');
                  if (itemType === 'user') {
                    deleteUserItem(itemId);
                  } else {
                    deleteExistingItem(itemId);
                  }
                }, 100);
              }
            }, { passive: false });
            
            btn.addEventListener('touchcancel', function(e) {
              e.stopPropagation();
              // ì¼ì • í•­ëª©ì€ ì›ë˜ ìœ„ì¹˜ ìœ ì§€
              this.style.transform = 'translateY(-50%)';
            }, { passive: true });
          });
        }
      }
      
      // í´ë¦­ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸(ë§í¬ ì—­í• ) ëì— â— í‘œì‹œë¥¼ ìœ„ì²¨ìì²˜ëŸ¼ ë§ë¶™ì´ëŠ” í•¨ìˆ˜
      function appendExclamationToLinks(rootEl) {
        try {
          if (!rootEl) return;
          const clickableSelectors = [
            'span[onclick]',
            'button.ticket-btn',
            'a[href]'
          ];
          const nodes = rootEl.querySelectorAll(clickableSelectors.join(','));
          nodes.forEach(node => {
            // ì´ë¯¸ í‘œì‹œê°€ ë¶™ì–´ ìˆë‹¤ë©´ ì¤‘ë³µ ë°©ì§€
            if (node.querySelector('.link-indicator')) return;
            const text = (node.textContent || '').trim();
            if (!text) return;
            if (text.endsWith('â—')) return;
            const indicator = document.createElement('span');
            indicator.className = 'link-indicator';
            indicator.textContent = 'â—';
            indicator.setAttribute('aria-hidden', 'true');
            indicator.style.cssText = [
              'display:inline-block',
              'font-size:0.6em',
              'line-height:1',
              'vertical-align:super',
              'margin-left:4px',
              'position:relative',
              'top:-0.1em'
            ].join(';');
            node.appendChild(indicator);
          });
        } catch (e) {
          console.warn('ë§í¬ ê°•ì¡° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', e);
        }
      }
      
      // ì˜¤í”„ë¼ì¸ ëª¨ë“œ í™œì„±í™”
      function enableOfflineMode() {
        console.log('ì˜¤í”„ë¼ì¸ ëª¨ë“œ í™œì„±í™”');
        updateSyncStatus('ì˜¤í”„ë¼ì¸ ëª¨ë“œ', 'warning');
      }
      
      // ë™ê¸°í™” ìƒíƒœ í‘œì‹œê¸° ì¶”ê°€
      function addSyncStatusIndicator() {
        if (document.getElementById('syncStatusIndicator')) return;
        
        const statusDiv = document.createElement('div');
        statusDiv.id = 'syncStatusIndicator';
        statusDiv.style.cssText = `
          position: fixed;
          top: 10px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 1000;
          padding: 8px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
          color: white;
          background: rgba(0, 0, 0, 0.7);
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
          opacity: 0;
          transform: translateX(-50%) translateY(-20px);
        `;
        statusDiv.textContent = 'ë™ê¸°í™” ì¤€ë¹„ ì¤‘...';
        document.body.appendChild(statusDiv);
        
        // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ í‘œì‹œ
        setTimeout(() => {
          statusDiv.style.opacity = '1';
          statusDiv.style.transform = 'translateX(-50%) translateY(0)';
        }, 100);
      }
      
      // ë™ê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateSyncStatus(message, type = 'info') {
        // indicatorê°€ ì—†ìœ¼ë©´ ìƒì„±
        let indicator = document.getElementById('syncStatusIndicator');
        if (!indicator) {
          addSyncStatusIndicator();
          indicator = document.getElementById('syncStatusIndicator');
        }
        
        if (!indicator) return; // ì—¬ì „íˆ ì—†ìœ¼ë©´ ì¢…ë£Œ
        
        const colors = {
          success: '#10b981',
          error: '#ef4444',
          warning: '#f59e0b',
          info: '#3b82f6'
        };
        
        indicator.textContent = message;
        indicator.style.background = colors[type] || colors.info;
        
        // í‘œì‹œí•˜ê¸°
        indicator.style.opacity = '1';
        indicator.style.transform = 'translateX(-50%) translateY(0)';
        
        // ë™ê¸°í™” ì™„ë£Œ ì‹œ 1.5ì´ˆ, ê·¸ ì™¸ì—” 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
        const hideDelay = (type === 'success' && message.includes('ë™ê¸°í™” ì™„ë£Œ')) ? 1500 : 3000;
        
        setTimeout(() => {
          indicator.style.opacity = '0';
          indicator.style.transform = 'translateX(-50%) translateY(-20px)';
          setTimeout(() => {
            if (indicator.parentNode) {
              indicator.parentNode.removeChild(indicator);
            }
          }, 300);
        }, hideDelay);
      }
      
      // ë™ê¸°í™” ì™„ë£Œ ë°°ì§€ í‘œì‹œ (ê¸°ì¡´ ì¤‘ì•™ ìƒë‹¨ ìŠ¤íƒ€ì¼ í™œìš©)
      function showSyncBadge() {
        // ê¸°ì¡´ updateSyncStatus ì‹œìŠ¤í…œì„ í™œìš©í•˜ì—¬ ê°„ë‹¨í•˜ê²Œ ì²˜ë¦¬
        // ë³„ë„ ë°°ì§€ ìƒì„±í•˜ì§€ ì•Šê³  ê¸°ì¡´ ì‹œìŠ¤í…œ ì‚¬ìš©
        console.log('ë™ê¸°í™” ì™„ë£Œ - ê¸°ì¡´ ìƒíƒœ í‘œì‹œê¸° í™œìš©');
      }
      
      // Firebase ì—…ë¡œë“œ ì„±ê³µ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
      function onFirebaseUploadSuccess(operationType = 'ë°ì´í„°') {
        const message = `${operationType} ë™ê¸°í™” ì™„ë£Œ`;
        
        // ì¦‰ì‹œ ë™ê¸°í™” ì™„ë£Œ ë°°ì§€ í‘œì‹œ
        console.log(`Firebase ì—…ë¡œë“œ ì„±ê³µ: ${operationType} - ë°°ì§€ í‘œì‹œ`);
        updateSyncStatus(message, 'success');
        
        // ì¶”ê°€ ë¡œê¹…ìœ¼ë¡œ í™•ì¸
        setTimeout(() => {
          const indicator = document.getElementById('syncStatusIndicator');
          console.log('ë°°ì§€ í‘œì‹œ ìƒíƒœ:', indicator ? 'í‘œì‹œë¨' : 'ì—†ìŒ');
        }, 100);
      }
      
      // ì¼ì • ì¶”ê°€ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ í•¨ìˆ˜
      function showAddScheduleDialog() {
        // ê¸°ì¡´ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ìˆìœ¼ë©´ ì œê±°
        const existingDialog = document.getElementById('addScheduleDialog');
        const existingOverlay = document.getElementById('dialogOverlay');
        if (existingDialog) {
          existingDialog.remove();
        }
        if (existingOverlay) {
          existingOverlay.remove();
        }
        
        // ë°°ê²½ ì˜¤ë²„ë ˆì´ ìƒì„±
        const overlay = document.createElement('div');
        overlay.id = 'dialogOverlay';
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: 999;
          background: transparent;
        `;
        overlay.onclick = function() {
          closeAddScheduleDialog();
        };
        overlay.ontouchstart = function(e) {
          e.preventDefault();
          closeAddScheduleDialog();
        };
        overlay.ontouchend = function(e) {
          e.preventDefault();
          closeAddScheduleDialog();
        };
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
        const dialog = document.createElement('div');
        dialog.id = 'addScheduleDialog';
        dialog.style.cssText = `
          position: fixed;
          top: 120px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 1000;
          width: 380px;
          max-width: 90vw;
          background: rgba(255, 255, 255, 0.2);
          border: 1px solid rgba(255, 255, 255, 0.12);
          border-radius: 20px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.12);
          backdrop-filter: blur(24px);
          -webkit-backdrop-filter: blur(24px);
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          overflow: hidden;
          transition: all 0.3s ease;
        `;
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ë‚´ë¶€ í´ë¦­/í„°ì¹˜ ì‹œ ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
        dialog.onclick = function(e) {
          e.stopPropagation();
        };
        dialog.ontouchstart = function(e) {
          e.stopPropagation();
        };
        dialog.ontouchend = function(e) {
          e.stopPropagation();
        };
        
        dialog.innerHTML = `
          <style>
            #scheduleTitle::placeholder {
              color: rgba(0, 0, 0, 0.5);
            }
          </style>
          <div style="padding: 28px 24px 24px 24px;">
            <div style="text-align: center; margin-bottom: 24px;">
              <h3 style="color: #000; margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">ìƒˆ ì¼ì • ì¶”ê°€</h3>
            </div>
            <div style="margin-bottom: 24px;">
              <input type="text" id="scheduleTitle" placeholder="ì¼ì • ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" 
                     style="width: 100%; padding: 16px 18px; border: none; border-radius: 12px; font-size: 15px; background: rgba(255, 255, 255, 0.12); color: #000; box-sizing: border-box; outline: none; transition: all 0.2s ease; backdrop-filter: blur(10px);" 
                     onfocus="this.style.background='rgba(255, 255, 255, 0.18)'; this.style.boxShadow='0 0 0 2px rgba(16, 185, 129, 0.3)'"
                     onblur="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.boxShadow='none'"
                     onkeypress="if(event.key==='Enter') addNewSchedule()">
            </div>

            <div style="text-align: center;">
              <button onclick="addNewSchedule()" style="background: rgba(255, 255, 255, 0.12); color: #000; border: none; border-radius: 12px; padding: 14px 32px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; backdrop-filter: blur(10px); min-width: 120px;" onmouseover="this.style.background='rgba(255, 255, 255, 0.18)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.transform='translateY(0)'">
                ì¶”ê°€
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(overlay);
        document.body.appendChild(dialog);
        
        // ì œëª© ì…ë ¥ë€ì— í¬ì»¤ìŠ¤
        setTimeout(() => {
          document.getElementById('scheduleTitle').focus();
        }, 100);
      }
      
      // ì¼ì • ì¶”ê°€ ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸° í•¨ìˆ˜
      function closeAddScheduleDialog() {
        const dialog = document.getElementById('addScheduleDialog');
        const overlay = document.getElementById('dialogOverlay');
        if (dialog) {
          dialog.remove();
        }
        if (overlay) {
          overlay.remove();
        }
      }
      
      // ìƒˆ ì¼ì • ì¶”ê°€ í•¨ìˆ˜
      async function addNewSchedule() {
        const titleInput = document.getElementById('scheduleTitle');
        
        const title = titleInput.value.trim();
        
        if (!title) {
          alert('ì¼ì • ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          titleInput.focus();
          return;
        }
        
        try {
          // ìƒˆ ì¼ì • ë²„íŠ¼ ìƒì„± (HTML ë¬¸ìì—´ ë°©ì‹)
          const scheduleId = 'schedule_' + Date.now();
          
          const scheduleHtml = `
            <div class="user-added-item" data-item-id="${scheduleId}" data-item-type="schedule" data-schedule-id="${scheduleId}" data-schedule-title="${title}">
              <div class="item-content">
                <button class="toggle-btn" onclick="showScheduleInfo('${title}')" data-schedule-id="${scheduleId}" data-schedule-title="${title}">${title}</button>
              </div>
              <button class="swipe-edit-btn" onclick="editSchedule('${scheduleId}', '${title}')" title="ìˆ˜ì •">ìˆ˜ì •</button>
              <button class="swipe-delete-btn" onclick="deleteSchedule('${scheduleId}', '${title}')" title="ì‚­ì œ">ì‚­ì œ</button>
            </div>
          `;
          
          // additionalDays ì»¨í…Œì´ë„ˆì— ì¶”ê°€
          const additionalDaysContainer = document.getElementById('additionalDays');
          additionalDaysContainer.innerHTML += scheduleHtml;
          
          // ìŠ¤ì™€ì´í”„ ë° ë“œë˜ê·¸ ì´ˆê¸°í™”
          initializeSwipeDelete();
          
          // Firebaseì— ì €ì¥
          if (window.db && window.firestore) {
            const scheduleData = {
              id: scheduleId,
              title: title,
              timestamp: new Date().toISOString(),
              type: 'custom_schedule'
            };
            
            await window.firestore.updateDoc(
              window.firestore.doc(window.db, 'users', 'currentUser'),
              {
                customSchedules: window.firestore.arrayUnion(scheduleData),
                lastUpdated: window.firestore.serverTimestamp()
              }
            );
            
            onFirebaseUploadSuccess('ì¼ì • ì¶”ê°€');
          }
          
          // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
          closeAddScheduleDialog();
          
        } catch (error) {
          console.error('ì¼ì • ì¶”ê°€ ì‹¤íŒ¨:', error);
          alert('ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }
      
      // ê°€ê³„ë¶€ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ í•¨ìˆ˜
      function showBudgetDialog() {
        // ê¸°ì¡´ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ìˆìœ¼ë©´ ì œê±°
        const existingDialog = document.getElementById('budgetDialog');
        const existingOverlay = document.getElementById('budgetOverlay');
        if (existingDialog) {
          existingDialog.remove();
        }
        if (existingOverlay) {
          existingOverlay.remove();
        }
        
        // ë°°ê²½ ì˜¤ë²„ë ˆì´ ìƒì„±
        const overlay = document.createElement('div');
        overlay.id = 'budgetOverlay';
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: 999;
          background: transparent;
        `;
        
        // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
        overlay.onclick = function(e) {
          if (e.target === overlay) {
            closeBudgetDialog();
          }
        };
        
        overlay.ontouchstart = function(e) {
          if (e.target === overlay) {
            e.preventDefault();
            closeBudgetDialog();
          }
        };
        
        overlay.ontouchend = function(e) {
          if (e.target === overlay) {
            e.preventDefault();
          }
        };
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
        const dialog = document.createElement('div');
        dialog.id = 'budgetDialog';
        dialog.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          z-index: 1000;
          background: rgba(255, 255, 255, 0.2);
          backdrop-filter: blur(20px);
          border-radius: 20px;
          padding: 28px 24px 24px 24px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.12);
          border: 1px solid rgba(255, 255, 255, 0.12);
          min-width: 320px;
          max-width: 90vw;
        `;
        
        dialog.innerHTML = `
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; color: #000; font-size: 14px; font-weight: 500;">ë‚ ì§œ</label>
            <input type="date" id="budgetDate" value="${new Date().toISOString().split('T')[0]}" style="
              width: 100%; 
              padding: 16px 18px; 
              border: none; 
              border-radius: 12px; 
              font-size: 15px; 
              background: rgba(255, 255, 255, 0.12); 
              color: #000; 
              box-sizing: border-box; 
              outline: none; 
              transition: all 0.2s ease; 
              backdrop-filter: blur(10px);
            " onfocus="this.style.background='rgba(255, 255, 255, 0.18)'" onblur="this.style.background='rgba(255, 255, 255, 0.12)'">
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; color: #000; font-size: 14px; font-weight: 500;">í•­ëª©</label>
            <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: center;">
              <button type="button" onclick="selectBudgetCategory('ğŸ½ï¸', 'ì‹ë¹„')" id="btn-ì‹ë¹„" style="padding:8px 12px; background: rgba(255, 255, 255, 0.12); border: none; border-radius:8px; cursor:pointer; transition: all 0.2s ease; font-size: 14px; color:#000;">ì‹ë¹„</button>
              <button type="button" onclick="selectBudgetCategory('ğŸšŒ', 'êµí†µë¹„')" id="btn-êµí†µë¹„" style="padding:8px 12px; background: rgba(255, 255, 255, 0.12); border: none; border-radius:8px; cursor:pointer; transition: all 0.2s ease; font-size: 14px; color:#000;">êµí†µë¹„</button>
              <button type="button" onclick="selectBudgetCategory('ğŸ¨', 'ìˆ™ë°•ë¹„')" id="btn-ìˆ™ë°•ë¹„" style="padding:8px 12px; background: rgba(255, 255, 255, 0.12); border: none; border-radius:8px; cursor:pointer; transition: all 0.2s ease; font-size: 14px; color:#000;">ìˆ™ë°•ë¹„</button>
              <button type="button" onclick="selectBudgetCategory('ğŸ›’', 'ì‡¼í•‘')" id="btn-ì‡¼í•‘" style="padding:8px 12px; background: rgba(255, 255, 255, 0.12); border: none; border-radius:8px; cursor:pointer; transition: all 0.2s ease; font-size: 14px; color:#000;">ì‡¼í•‘</button>
              <button type="button" onclick="selectBudgetCategory('ğŸ’¡', 'ê¸°íƒ€')" id="btn-ê¸°íƒ€" style="padding:8px 12px; background: rgba(255, 255, 255, 0.12); border: none; border-radius:8px; cursor:pointer; transition: all 0.2s ease; font-size: 14px; color:#000;">ê¸°íƒ€</button>
            </div>
            <input type="hidden" id="budgetCategory" value="">
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; color: #000; font-size: 14px; font-weight: 500;">ê²°ì œ ë°©ë²•</label>
            <div style="display: flex; gap: 8px;">
              <button type="button" onclick="selectPaymentMethod('ì¹´ë“œ')" id="btn-ì¹´ë“œ" style="flex: 1; padding: 12px; background: rgba(255, 255, 255, 0.12); border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; color: #000; font-size: 14px;">ì¹´ë“œ</button>
              <button type="button" onclick="selectPaymentMethod('í˜„ê¸ˆ')" id="btn-í˜„ê¸ˆ" style="flex: 1; padding: 12px; background: rgba(255, 255, 255, 0.12); border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; color: #000; font-size: 14px;">í˜„ê¸ˆ</button>
            </div>
            <input type="hidden" id="budgetPayment" value="">
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; color: #000; font-size: 14px; font-weight: 500;">í†µí™”</label>
            <div style="display: flex; gap: 8px;">
              <button type="button" onclick="selectCurrency('ì›í™”')" id="btn-ì›í™”" style="flex: 1; padding: 12px; background: rgba(255, 255, 255, 0.12); border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; color: #000; font-size: 14px;">ì›í™”</button>
              <button type="button" onclick="selectCurrency('ì—”í™”')" id="btn-ì—”í™”" style="flex: 1; padding: 12px; background: rgba(255, 255, 255, 0.12); border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; color: #000; font-size: 14px;">ì—”í™”</button>
            </div>
            <input type="hidden" id="budgetCurrency" value="">
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; color: #000; font-size: 14px; font-weight: 500;">ë‚´ìš©</label>
            <input type="text" id="budgetContent" placeholder="ìƒì„¸ ë‚´ìš© ì…ë ¥" style="
              width: 100%; 
              padding: 16px 18px; 
              border: none; 
              border-radius: 12px; 
              font-size: 15px; 
              background: rgba(255, 255, 255, 0.12); 
              color: #000; 
              box-sizing: border-box; 
              outline: none; 
              transition: all 0.2s ease; 
              backdrop-filter: blur(10px);
            " onfocus="this.style.background='rgba(255, 255, 255, 0.18)'" onblur="this.style.background='rgba(255, 255, 255, 0.12)'">
          </div>
          <div style="margin-bottom: 24px;">
            <label style="display: block; margin-bottom: 8px; color: #000; font-size: 14px; font-weight: 500;">ê¸ˆì•¡</label>
            <input type="number" id="budgetAmount" placeholder="ê¸ˆì•¡ ì…ë ¥" style="
              width: 100%; 
              padding: 16px 18px; 
              border: none; 
              border-radius: 12px; 
              font-size: 15px; 
              background: rgba(255, 255, 255, 0.12); 
              color: #000; 
              box-sizing: border-box; 
              outline: none; 
              transition: all 0.2s ease; 
              backdrop-filter: blur(10px);
            " onfocus="this.style.background='rgba(255, 255, 255, 0.18)'" onblur="this.style.background='rgba(255, 255, 255, 0.12)'">
          </div>
          <div style="display: flex; gap: 12px;">
            <button onclick="addBudgetItem()" style="
              flex: 1; 
              background: rgba(255, 255, 255, 0.12); 
              color: #000; 
              border: none; 
              border-radius: 12px; 
              padding: 14px 32px; 
              font-size: 15px; 
              font-weight: 500; 
              cursor: pointer; 
              transition: all 0.2s ease; 
              backdrop-filter: blur(10px); 
              min-width: 120px;
            " onmouseover="this.style.background='rgba(255, 255, 255, 0.18)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.transform='translateY(0)'">
              ì¶”ê°€
            </button>
            <button onclick="closeBudgetDialog()" style="
              flex: 1; 
              background: rgba(255, 255, 255, 0.12); 
              color: #000; 
              border: none; 
              border-radius: 12px; 
              padding: 14px 32px; 
              font-size: 15px; 
              font-weight: 500; 
              cursor: pointer; 
              transition: all 0.2s ease; 
              backdrop-filter: blur(10px); 
              min-width: 120px;
            " onmouseover="this.style.background='rgba(255, 255, 255, 0.18)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.transform='translateY(0)'">
              ì·¨ì†Œ
            </button>
          </div>
        `;
        
        // ë‹¤ì´ì–¼ë¡œê·¸ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨
        dialog.onclick = function(e) {
          e.stopPropagation();
        };
        
        dialog.ontouchstart = function(e) {
          e.stopPropagation();
        };
        
        dialog.ontouchend = function(e) {
          e.stopPropagation();
        };
        
        // DOMì— ì¶”ê°€
        document.body.appendChild(overlay);
        document.body.appendChild(dialog);
        
        // ë‚ ì§œ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
        setTimeout(() => {
          document.getElementById('budgetDate').focus();
        }, 100);
      }
      
      // ê°€ê³„ë¶€ í‘œë¡œë³´ê¸° ì—´ê¸° í•¨ìˆ˜ (Firebase ì—°ë™)
      function openBudgetTable() {
        // í˜„ì¬ í˜ì´ì§€ì˜ ê¸°ë³¸ URLì„ ì‚¬ìš©í•˜ì—¬ ë™ì ìœ¼ë¡œ account.html ê²½ë¡œ ìƒì„±
        const baseUrl = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '/');
        const url = baseUrl + 'account.html';
        
        // openUserItemLinkì™€ ì™„ì „íˆ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ êµ¬í˜„
        openUserItemLink(url);
      }
      
      // ê°€ê³„ë¶€ ë²„íŠ¼ ìŠ¤ì™€ì´í”„ ê¸°ëŠ¥ ì´ˆê¸°í™”
      function initBudgetSwipe() {
        const container = document.getElementById('budgetBtnContainer');
        if (!container) return;
        
        let startX = 0;
        let currentX = 0;
        let startY = 0;
        let currentY = 0;
        let isSwiping = false;
        let hasSwiped = false;
        let startTime = 0;
        let isSwipeRight = false;
        
        // í„°ì¹˜ ì‹œì‘ - ì¼ì • ìŠ¤ì™€ì´í”„ì™€ ë™ì¼í•œ ë°©ì‹
        container.addEventListener('touchstart', function(e) {
          console.log('ê°€ê³„ë¶€ ìŠ¤ì™€ì´í”„ í„°ì¹˜ ì‹œì‘');
          
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
          startTime = Date.now();
          isSwiping = true;
          hasSwiped = false;
        }, { passive: false });
        
        // í„°ì¹˜ ì´ë™ - ì¼ì • ìŠ¤ì™€ì´í”„ì™€ ë™ì¼í•œ ë°©ì‹
        container.addEventListener('touchmove', function(e) {
          if (!isSwiping) return;
          
          currentX = e.touches[0].clientX;
          currentY = e.touches[0].clientY;
          const diffX = startX - currentX;
          const diffY = Math.abs(startY - currentY);
          const diffTime = Date.now() - startTime;
          
          // ì„¸ë¡œ ì›€ì§ì„ì´ ê°€ë¡œë³´ë‹¤ í¬ë©´ ìŠ¤ì™€ì´í”„ ì·¨ì†Œ
          if (diffY > Math.abs(diffX) && diffY > 20) {
            return;
          }
          
          // ë¹ ë¥¸ ìŠ¤ì™€ì´í”„ ê°ì§€ (ì¼ì •ê³¼ ë™ì¼í•œ ë°©ì‹, ì¢Œì¸¡ìœ¼ë¡œ ìŠ¤ì™€ì´í”„)
          if (diffX > 30 && diffTime < 500 && diffY < 30) {
            const translateX = Math.min(diffX, 100);
            container.style.transform = `translateX(-${translateX}px)`;
            hasSwiped = true;
          }
        }, { passive: false });
        
        // í„°ì¹˜ ì¢…ë£Œ - ì¼ì • ìŠ¤ì™€ì´í”„ì™€ ë™ì¼í•œ ë°©ì‹
        container.addEventListener('touchend', function(e) {
          if (!isSwiping) return;
          
          isSwiping = false;
          
          const diffX = startX - currentX;
          const diffTime = Date.now() - startTime;
          
          // ëª¨ë°”ì¼ì—ì„œ ë” ë¯¼ê°í•œ ìŠ¤ì™€ì´í”„ ê°ì§€ (ì¼ì •ê³¼ ë™ì¼)
          if (hasSwiped && diffX > 30 && diffTime < 1000) {
            // ìŠ¤ì™€ì´í”„ ì™„ë£Œ - ìƒì„¸ë³´ê¸° í‘œì‹œ
            container.style.transform = 'translateX(-100%)';
            isSwipeRight = true;
            console.log('ê°€ê³„ë¶€ ìŠ¤ì™€ì´í”„ ì™„ë£Œ - ìƒì„¸ë³´ê¸° í‘œì‹œ');
          } else {
            // ìŠ¤ì™€ì´í”„ ì·¨ì†Œ - ì›ë˜ ìœ„ì¹˜ë¡œ ë³µì›
            container.style.transform = 'translateX(0)';
            isSwipeRight = false;
          }
        }, { passive: false });
        
        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ (ë°ìŠ¤í¬íƒ‘ ì§€ì›) ì¶”ê°€
        container.addEventListener('mousedown', function(e) {
          console.log('ê°€ê³„ë¶€ ìŠ¤ì™€ì´í”„ ë§ˆìš°ìŠ¤ ì‹œì‘');
          
          startX = e.clientX;
          startY = e.clientY;
          startTime = Date.now();
          isSwiping = true;
          hasSwiped = false;
          e.preventDefault();
        });
        
        document.addEventListener('mousemove', function(e) {
          if (!isSwiping) return;
          
          currentX = e.clientX;
          currentY = e.clientY;
          const diffX = startX - currentX;
          const diffY = Math.abs(startY - currentY);
          const diffTime = Date.now() - startTime;
          
          // ì„¸ë¡œ ì›€ì§ì„ì´ ê°€ë¡œë³´ë‹¤ í¬ë©´ ìŠ¤ì™€ì´í”„ ì·¨ì†Œ
          if (diffY > Math.abs(diffX) && diffY > 20) {
            return;
          }
          
          // ë¹ ë¥¸ ìŠ¤ì™€ì´í”„ ê°ì§€ (ë°ìŠ¤í¬íƒ‘ìš©)
          if (diffX > 30 && diffTime < 500 && diffY < 30) {
            const translateX = Math.min(diffX, 100);
            container.style.transform = `translateX(-${translateX}px)`;
            hasSwiped = true;
          }
        });
        
        document.addEventListener('mouseup', function(e) {
          if (!isSwiping) return;
          
          isSwiping = false;
          
          const diffX = startX - currentX;
          const diffTime = Date.now() - startTime;
          
          // ë°ìŠ¤í¬íƒ‘ì—ì„œ ìŠ¤ì™€ì´í”„ ê°ì§€
          if (hasSwiped && diffX > 30 && diffTime < 1000) {
            // ìŠ¤ì™€ì´í”„ ì™„ë£Œ - ìƒì„¸ë³´ê¸° í‘œì‹œ
            container.style.transform = 'translateX(-100%)';
            isSwipeRight = true;
            console.log('ê°€ê³„ë¶€ ìŠ¤ì™€ì´í”„ ì™„ë£Œ - ìƒì„¸ë³´ê¸° í‘œì‹œ (ë°ìŠ¤í¬íƒ‘)');
          } else {
            // ìŠ¤ì™€ì´í”„ ì·¨ì†Œ - ì›ë˜ ìœ„ì¹˜ë¡œ ë³µì›
            container.style.transform = 'translateX(0)';
            isSwipeRight = false;
          }
        });
        
        // í´ë¦­ ì‹œ ìƒíƒœ ê´€ë¦¬
        document.getElementById('budgetBtn').addEventListener('click', () => {
          if (isSwipeRight) {
            container.style.transform = 'translateX(0)';
            isSwipeRight = false;
          }
        });
        
        document.getElementById('budgetViewBtn').addEventListener('click', () => {
          console.log('ìƒì„¸ë³´ê¸° ë²„íŠ¼ í´ë¦­');
          openBudgetTable();
        });
      }
      
      // ê°€ê³„ë¶€ ì¹´í…Œê³ ë¦¬ ì„ íƒ í•¨ìˆ˜
      function selectBudgetCategory(emoji, category) {
        // ëª¨ë“  í•­ëª© ë²„íŠ¼ ì´ˆê¸°í™”
        const categoryButtons = ['ì‹ë¹„', 'êµí†µë¹„', 'ìˆ™ë°•ë¹„', 'ì‡¼í•‘', 'ê¸°íƒ€'];
        categoryButtons.forEach(cat => {
          const btn = document.getElementById(`btn-${cat}`);
          if (btn) {
            btn.style.background = 'rgba(79, 70, 229, 0.08)';
            btn.style.color = '#000';
            btn.style.boxShadow = 'none';
          }
        });
        
        // ì„ íƒëœ ë²„íŠ¼ ê°•ì¡°
        const selectedBtn = document.getElementById(`btn-${category}`);
        if (selectedBtn) {
          selectedBtn.style.background = '#4f46e5';
          selectedBtn.style.color = '#fff';
          selectedBtn.style.boxShadow = '0 0 0 2px rgba(79, 70, 229, 0.25) inset';
        }
        
        // hidden inputì— ê°’ ì„¤ì •
        document.getElementById('budgetCategory').value = category;
      }
      
      // ê²°ì œ ë°©ë²• ì„ íƒ í•¨ìˆ˜
      function selectPaymentMethod(method) {
        // ëª¨ë“  ê²°ì œ ë°©ë²• ë²„íŠ¼ ì´ˆê¸°í™”
        const paymentButtons = ['ì¹´ë“œ', 'í˜„ê¸ˆ'];
        paymentButtons.forEach(payment => {
          const btn = document.getElementById(`btn-${payment}`);
          if (btn) {
            btn.style.background = 'rgba(79, 70, 229, 0.08)';
            btn.style.color = '#000';
            btn.style.boxShadow = 'none';
          }
        });
        
        // ì„ íƒëœ ë²„íŠ¼ ê°•ì¡°
        const selectedBtn = document.getElementById(`btn-${method}`);
        if (selectedBtn) {
          selectedBtn.style.background = '#4f46e5';
          selectedBtn.style.color = '#fff';
          selectedBtn.style.boxShadow = '0 0 0 2px rgba(79, 70, 229, 0.25) inset';
        }
        
        // hidden inputì— ê°’ ì„¤ì •
        document.getElementById('budgetPayment').value = method;
      }
      
      // í†µí™” ì„ íƒ í•¨ìˆ˜
      function selectCurrency(currency) {
        // ëª¨ë“  í†µí™” ë²„íŠ¼ ì´ˆê¸°í™”
        const currencyButtons = ['ì›í™”', 'ì—”í™”'];
        currencyButtons.forEach(curr => {
          const btn = document.getElementById(`btn-${curr}`);
          if (btn) {
            btn.style.background = 'rgba(79, 70, 229, 0.08)';
            btn.style.color = '#000';
            btn.style.boxShadow = 'none';
          }
        });
        
        // ì„ íƒëœ ë²„íŠ¼ ê°•ì¡°
        const selectedBtn = document.getElementById(`btn-${currency}`);
        if (selectedBtn) {
          selectedBtn.style.background = '#4f46e5';
          selectedBtn.style.color = '#fff';
          selectedBtn.style.boxShadow = '0 0 0 2px rgba(79, 70, 229, 0.25) inset';
        }
        
        // hidden inputì— ê°’ ì„¤ì •
        document.getElementById('budgetCurrency').value = currency;
      }
      
      // ê°€ê³„ë¶€ ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸° í•¨ìˆ˜
      function closeBudgetDialog() {
        const dialog = document.getElementById('budgetDialog');
        const overlay = document.getElementById('budgetOverlay');
        
        if (dialog) {
          dialog.remove();
        }
        if (overlay) {
          overlay.remove();
        }
      }
      
      // ê°€ê³„ë¶€ í•­ëª© ì¶”ê°€ í•¨ìˆ˜ (localStorage ì„ì‹œ ì €ì¥ë§Œ)
      function addBudgetItem() {
        const date = document.getElementById('budgetDate').value;
        const category = document.getElementById('budgetCategory').value;
        const payment = document.getElementById('budgetPayment').value;
        const currency = document.getElementById('budgetCurrency').value;
        const content = document.getElementById('budgetContent').value.trim();
        const amount = document.getElementById('budgetAmount').value.trim();
        
        if (!date) {
          alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (!category) {
          alert('í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (!payment) {
          alert('ê²°ì œ ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (!currency) {
          alert('í†µí™”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (!content) {
          alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (!amount) {
          alert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (isNaN(amount) || Number(amount) <= 0) {
          alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        try {
          // ê°€ê³„ë¶€ ë°ì´í„° êµ¬ì¡°
          const budgetData = {
            id: Date.now().toString(),
            date: date,
            category: category,
            payment: payment,
            currency: currency,
            content: content,
            amount: Number(amount),
            timestamp: Date.now()
          };
          
          // ê°€ê³„ë¶€ ë°ì´í„°ëŠ” account.htmlì—ì„œë§Œ Firebase ê´€ë¦¬
          // index47m.htmlì—ì„œëŠ” localStorage ì„ì‹œ ì €ì¥ë§Œ (ì¤‘ë³µ ë°©ì§€)
          let budgetList = JSON.parse(localStorage.getItem('budgetList') || '[]');
          budgetList.push(budgetData);
          localStorage.setItem('budgetList', JSON.stringify(budgetList));
          
          console.log('ê°€ê³„ë¶€ ë°ì´í„° ì„ì‹œ ì €ì¥ ì™„ë£Œ (FirebaseëŠ” account.htmlì—ì„œ ì „ë‹´ ê´€ë¦¬)');
          
          const currencySymbol = currency === 'ì›í™”' ? 'ì›' : 'Â¥';
          alert(`ê°€ê³„ë¶€ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!\n${content}\n${category}: ${Number(amount).toLocaleString()}${currencySymbol} (${payment})`);
          
          // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
          document.getElementById('budgetDate').value = new Date().toISOString().split('T')[0];
          document.getElementById('budgetContent').value = '';
          document.getElementById('budgetAmount').value = '';
          
          // ì„ íƒëœ ë²„íŠ¼ ì´ˆê¸°í™”
          ['ì‹ë¹„', 'êµí†µë¹„', 'ìˆ™ë°•ë¹„', 'ì‡¼í•‘', 'ê¸°íƒ€'].forEach(cat => {
            const btn = document.getElementById(`btn-${cat}`);
            if (btn) btn.style.background = 'rgba(255, 255, 255, 0.12)';
          });
          ['ì¹´ë“œ', 'í˜„ê¸ˆ'].forEach(method => {
            const btn = document.getElementById(`btn-${method}`);
            if (btn) btn.style.background = 'rgba(255, 255, 255, 0.12)';
          });
          ['ì›í™”', 'ì—”í™”'].forEach(curr => {
            const btn = document.getElementById(`btn-${curr}`);
            if (btn) btn.style.background = 'rgba(255, 255, 255, 0.12)';
          });
          
          // hidden input ì´ˆê¸°í™”
          document.getElementById('budgetCategory').value = '';
          document.getElementById('budgetPayment').value = '';
          document.getElementById('budgetCurrency').value = '';
          
          // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
          closeBudgetDialog();
          
        } catch (error) {
          console.error('ê°€ê³„ë¶€ ì¶”ê°€ ì‹¤íŒ¨:', error);
          alert('ê°€ê³„ë¶€ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }
      
      // ì¼ì • ì •ë³´ í‘œì‹œ í•¨ìˆ˜
      function showScheduleInfo(title) {
        // ê¸°ì¡´ ì •ë³´ì°½ì´ ìˆìœ¼ë©´ ì œê±°
        const existingInfo = document.getElementById('preparationInfo');
        if (existingInfo) {
          existingInfo.remove();
        }
        
        // ë‹¤ë¥¸ ì¼ì • í´ë¦­ì‹œ ìŠ¤ì™€ì´í”„ ìƒíƒœ í•´ì œ
        clearAllSwipeStates();
        
        // í˜„ì¬ í™œì„± ì„¹ì…˜ ì„¤ì •
        window.currentActiveSection = title;
        
        // ì •ë³´ì°½ ìƒì„±
        const infoDiv = document.createElement('div');
        infoDiv.id = 'preparationInfo';
        infoDiv.innerHTML = `
          <div style="padding: 28px 24px 8px 24px; text-align: center;">
            <h3 style="color: #000; margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">${title}</h3>
          </div>
                      <div class="info-content">
              <div class="info-section">
                <!-- ì‚¬ìš©ì ì¶”ê°€ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
              <div id="userAddedItems"></div>
              
              <!-- ìƒˆ í•­ëª© ì¶”ê°€ ë²„íŠ¼ -->
              <div class="add-item-section">
                <button type="button" onclick="showAddForm()" class="toggle-add-btn" id="toggleAddBtn">+ ìƒˆ í•­ëª© ì¶”ê°€</button>
              </div>
              
              <!-- ìƒˆ í•­ëª© ì¶”ê°€ í¼ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
              <div class="add-item-form" id="addItemForm" style="display: none;">
                <div class="form-group">
                  <input type="text" id="newItemTitle" placeholder="í•­ëª© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="50">
                  <input type="url" id="newItemLink" placeholder="ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)" maxlength="200">
                </div>
                <div class="form-buttons">
                  <button type="button" onclick="addNewItem()" class="add-btn">ì¶”ê°€</button>
                </div>
              </div>
            </div>
            
            <!-- ì €ì¥ëœ ê²½ë¡œ/ë§ˆì»¤ ì œê±° ë²„íŠ¼ ì„¹ì…˜ -->
            <div class="info-section">
              <div id="${title.replace(/[^a-zA-Z0-9ê°€-í£]/g, '')}RemoveButtons" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                  <button class="route-remove-btn" onclick="removeRoutesByLocation('${title}')" style="flex: 1;">ê²½ë¡œì œê±°</button>
                  <button class="route-remove-btn" onclick="removeMarkersByLocation('${title}')" style="flex: 1;">ë§ˆì»¤ì œê±°</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // ì •ë³´ì°½ì„ ì§€ë„ ìœ„ì— í‘œì‹œ
        document.body.appendChild(infoDiv);
        
        // í´ë¦­ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸ ëì— â— í‘œì‹œ ì¶”ê°€
        if (typeof appendExclamationToLinks === 'function') {
          appendExclamationToLinks(infoDiv);
        }
        
        // ì €ì¥ëœ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì›
        setTimeout(() => {
          restoreCheckboxStates();
          // ìŠ¤ì™€ì´í”„ ê¸°ëŠ¥ ì´ˆê¸°í™”
          initializeSwipeDelete();
          if (typeof applyOverridesAndHides === 'function') {
            applyOverridesAndHides();
          }
        }, 50);
        
        // ê²½ë¡œì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateRouteRemoveButtons();
        // ë§ˆì»¤ì œê±° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateMarkerRemoveButtons();
        
        // ì •ë³´ì°½ ìœ„ì¹˜ ì¡°ì • - ëª¨ë°”ì¼ ìµœì í™”
        setTimeout(() => {
          const menu = document.getElementById('customMapMenu');
          const menuRect = menu.getBoundingClientRect();
          const mapElement = document.getElementById('map');
          const mapRect = mapElement.getBoundingClientRect();
          
          if (isMobile) {
            // ëª¨ë°”ì¼: í™”ë©´ ì¤‘ì•™ì— í‘œì‹œ
            infoDiv.style.left = '50%';
            infoDiv.style.transform = 'translateX(-50%)';
            infoDiv.style.top = '80px';
          } else {
            // ë°ìŠ¤í¬í†±: ì‚¬ì´ë“œë©”ë‰´ ì˜¤ë¥¸ìª½ì— í‘œì‹œ
            infoDiv.style.left = (menuRect.right + 10) + 'px';
            infoDiv.style.top = menuRect.top + 'px';
            infoDiv.style.transform = 'none';
          }
        }, 100);
      }
      // ì €ì¥ëœ ì‚¬ìš©ì ì •ì˜ ì¼ì •ë“¤ ë³µì› í•¨ìˆ˜
      async function restoreCustomSchedules() {
        try {
          if (!window.db || !window.firestore) return;
          
          const docSnap = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'));
          if (docSnap.exists() && docSnap.data().customSchedules) {
            const customSchedules = docSnap.data().customSchedules;
            
            const additionalDaysContainer = document.getElementById('additionalDays');
            if (additionalDaysContainer) {
              let html = '';
              
              customSchedules.forEach(schedule => {
                html += `
                  <div class="user-added-item" data-item-id="${schedule.id}" data-item-type="schedule" data-schedule-id="${schedule.id}" data-schedule-title="${schedule.title}">
                    <div class="item-content">
                      <button class="toggle-btn" onclick="showScheduleInfo('${schedule.title}', '${schedule.description || ''}')" data-schedule-id="${schedule.id}" data-schedule-title="${schedule.title}">${schedule.title}</button>
                    </div>
                    <button class="swipe-edit-btn" onclick="editSchedule('${schedule.id}', '${schedule.title}')" title="ìˆ˜ì •">ìˆ˜ì •</button>
                    <button class="swipe-delete-btn" onclick="deleteSchedule('${schedule.id}', '${schedule.title}')" title="ì‚­ì œ">ì‚­ì œ</button>
                  </div>
                `;
              });
              
              additionalDaysContainer.innerHTML = html;
              
              // ìŠ¤ì™€ì´í”„ ë° ë“œë˜ê·¸ ì´ˆê¸°í™”
              initializeSwipeDelete();
            }
          }
        } catch (error) {
          console.error('ì‚¬ìš©ì ì •ì˜ ì¼ì • ë³µì› ì‹¤íŒ¨:', error);
        }
      }
      // ì¼ì • ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í‘œì‹œ í•¨ìˆ˜
      function showScheduleContextMenu(e, scheduleBtn) {
        // ê¸°ì¡´ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ê°€ ìˆìœ¼ë©´ ì œê±°
        const existingMenu = document.getElementById('scheduleContextMenu');
        if (existingMenu) {
          existingMenu.remove();
        }
        
        // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìƒì„±
        const contextMenu = document.createElement('div');
        contextMenu.id = 'scheduleContextMenu';
        contextMenu.style.cssText = `
          position: fixed;
          z-index: 1000;
          background: rgba(255, 255, 255, 0.95);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 12px;
          box-shadow: 0 8px 25px rgba(0,0,0,0.15);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          overflow: hidden;
          animation: slideIn 0.2s ease-out;
          min-width: 150px;
        `;
        
        const scheduleId = scheduleBtn.getAttribute('data-schedule-id');
        const scheduleTitle = scheduleBtn.getAttribute('data-schedule-title');
        
        contextMenu.innerHTML = `
          <div style="padding: 8px 0;">
            <button onclick="editSchedule('${scheduleId}', '${scheduleTitle}')" 
                    style="width: 100%; padding: 12px 16px; background: none; border: none; text-align: left; cursor: pointer; font-size: 14px; color: #1f2937; transition: background-color 0.2s ease;">
              âœï¸ ìˆ˜ì •
            </button>
            <button onclick="deleteSchedule('${scheduleId}', '${scheduleTitle}')" 
                    style="width: 100%; padding: 12px 16px; background: none; border: none; text-align: left; cursor: pointer; font-size: 14px; color: #ef4444; transition: background-color 0.2s ease;">
              ğŸ—‘ï¸ ì‚­ì œ
            </button>
          </div>
        `;
        
        // ë©”ë‰´ ìœ„ì¹˜ ì„¤ì •
        contextMenu.style.left = e.clientX + 'px';
        contextMenu.style.top = e.clientY + 'px';
        
        document.body.appendChild(contextMenu);
        
        // ë©”ë‰´ ì™¸ë¶€ í´ë¦­/í„°ì¹˜ ì‹œ ë‹«ê¸°
        setTimeout(() => {
          const closeMenu = () => {
            contextMenu.remove();
            document.removeEventListener('click', closeMenu);
            document.removeEventListener('touchend', closeMenu);
          };
          
          document.addEventListener('click', closeMenu);
          document.addEventListener('touchend', closeMenu);
        }, 100);
      }
      
      // ì¼ì • ìˆ˜ì • í•¨ìˆ˜
      function editSchedule(scheduleId, currentTitle) {
        // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ë‹«ê¸°
        const contextMenu = document.getElementById('scheduleContextMenu');
        if (contextMenu) {
          contextMenu.remove();
        }
        
        // ìŠ¤ì™€ì´í”„ ìƒíƒœ í•´ì œ
        const item = document.querySelector(`[data-schedule-id="${scheduleId}"]`);
        if (item) {
          item.classList.remove('swiped');
          const itemContent = item.querySelector('.item-content');
          if (itemContent) {
            itemContent.style.transform = 'translateX(0)';
          }
        }
        
        // ì¼ì • ìˆ˜ì • ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
        showEditScheduleDialog(scheduleId, currentTitle);
      }
      
      // ì¼ì • ìˆ˜ì • ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ í•¨ìˆ˜
      function showEditScheduleDialog(scheduleId, currentTitle) {
        // ê¸°ì¡´ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ìˆìœ¼ë©´ ì œê±°
        const existingDialog = document.getElementById('editScheduleDialog');
        if (existingDialog) {
          existingDialog.remove();
        }
        
        // ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
        const dialog = document.createElement('div');
        dialog.id = 'editScheduleDialog';
        dialog.style.cssText = `
          position: fixed;
          top: 120px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 1000;
          width: 400px;
          max-width: 90vw;
          background: rgba(255, 255, 255, 0.2);
          border: 1px solid rgba(255, 255, 255, 0.12);
          border-radius: 20px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.12);
          backdrop-filter: blur(24px);
          -webkit-backdrop-filter: blur(24px);
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          overflow: hidden;
        `;
        
        dialog.innerHTML = `
          <div style="padding: 28px 24px 24px 24px;">
            <div style="text-align: center; margin-bottom: 24px;">
              <h3 style="color: #000; margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">ì¼ì • ìˆ˜ì •</h3>
            </div>
            <div style="margin-bottom: 24px;">
              <input type="text" id="editScheduleTitle" placeholder="ì¼ì • ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" 
                     value="${currentTitle}" maxlength="50"
                     style="width: 100%; padding: 16px 18px; border: none; border-radius: 12px; font-size: 15px; background: rgba(255, 255, 255, 0.12); color: #000; box-sizing: border-box; outline: none; transition: all 0.2s ease; backdrop-filter: blur(10px);" 
                     onfocus="this.style.background='rgba(255, 255, 255, 0.18)'"
                     onblur="this.style.background='rgba(255, 255, 255, 0.12)'">
            </div>
            <div style="display: flex; gap: 12px;">
              <button onclick="saveScheduleEdit('${scheduleId}')" style="flex: 1; background: rgba(255, 255, 255, 0.12); color: #000; border: none; border-radius: 12px; padding: 14px 16px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255, 255, 255, 0.18)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'">
                ì €ì¥
              </button>
              <button onclick="closeEditScheduleDialog()" style="flex: 1; background: rgba(255, 255, 255, 0.12); color: #000; border: none; border-radius: 12px; padding: 14px 16px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255, 255, 255, 0.18)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'">
                ì·¨ì†Œ
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(dialog);
        
        // ì œëª© ì…ë ¥ë€ì— í¬ì»¤ìŠ¤
        setTimeout(() => {
          document.getElementById('editScheduleTitle').focus();
        }, 100);
      }
      
      // ì¼ì • ìˆ˜ì • ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸° í•¨ìˆ˜
      function closeEditScheduleDialog() {
        const dialog = document.getElementById('editScheduleDialog');
        if (dialog) {
          dialog.remove();
        }
      }
      
      // ì¼ì • ìˆ˜ì • ì €ì¥ í•¨ìˆ˜
      async function saveScheduleEdit(scheduleId) {
        const titleInput = document.getElementById('editScheduleTitle');
        
        const newTitle = titleInput.value.trim();
        
        if (!newTitle) {
          alert('ì¼ì • ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          titleInput.focus();
          return;
        }
        
        try {
          // Firebaseì—ì„œ í•´ë‹¹ ì¼ì • ì°¾ê¸° ë° ì—…ë°ì´íŠ¸
          if (window.db && window.firestore) {
            const docSnap = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'));
            if (docSnap.exists() && docSnap.data().customSchedules) {
              const customSchedules = docSnap.data().customSchedules;
              const scheduleIndex = customSchedules.findIndex(schedule => schedule.id === scheduleId);
              
              if (scheduleIndex !== -1) {
                // ê¸°ì¡´ ì œëª© ì €ì¥ (ì—°ê´€ ë°ì´í„° ì—…ë°ì´íŠ¸ìš©)
                const oldTitle = customSchedules[scheduleIndex].title;
                
                // ì¼ì • ì—…ë°ì´íŠ¸
                customSchedules[scheduleIndex].title = newTitle;
                customSchedules[scheduleIndex].timestamp = new Date().toISOString();
                
                // Firebaseì— ì €ì¥ (1ì°¨: ì¼ì • ì œëª©ë§Œ ìš°ì„  ì €ì¥)
                await window.firestore.updateDoc(
                  window.firestore.doc(window.db, 'users', 'currentUser'),
                  {
                    customSchedules: customSchedules,
                    lastUpdated: window.firestore.serverTimestamp()
                  }
                );
                
                // ì—°ê´€ ë°ì´í„°(userAddedItems, savedUserRoutes, savedUserMarkers)ì˜ section/locationì„ ìƒˆ ì œëª©ìœ¼ë¡œ ê°±ì‹ 
                try {
                  const userDocRef = window.firestore.doc(window.db, 'users', 'currentUser');
                  const currentDoc = await window.firestore.getDoc(userDocRef);
                  if (currentDoc.exists()) {
                    const data = currentDoc.data();
                    const updates = {};
                    let hasUpdates = false;
                    
                    // ì„¸ë¶€í•­ëª© ì„¹ì…˜ëª… ì—…ë°ì´íŠ¸
                    if (Array.isArray(data.userAddedItems)) {
                      const updatedUserItems = data.userAddedItems.map(function(item) {
                        if (item && item.section === oldTitle) {
                          return { ...item, section: newTitle };
                        }
                        return item;
                      });
                      updates.userAddedItems = updatedUserItems;
                      window.firebaseUserItems = updatedUserItems;
                      hasUpdates = true;
                    }
                    
                    // ê²½ë¡œ location ì—…ë°ì´íŠ¸
                    if (Array.isArray(data.savedUserRoutes)) {
                      const updatedRoutes = data.savedUserRoutes.map(function(route) {
                        if (route && route.location === oldTitle) {
                          return { ...route, location: newTitle };
                        }
                        return route;
                      });
                      updates.savedUserRoutes = updatedRoutes;
                      if (typeof savedUserRoutes !== 'undefined') {
                        savedUserRoutes = updatedRoutes;
                      }
                      hasUpdates = true;
                    }
                    
                    // ë§ˆì»¤ location ì—…ë°ì´íŠ¸
                    if (Array.isArray(data.savedUserMarkers)) {
                      const updatedMarkers = data.savedUserMarkers.map(function(marker) {
                        if (marker && marker.location === oldTitle) {
                          return { ...marker, location: newTitle };
                        }
                        return marker;
                      });
                      updates.savedUserMarkers = updatedMarkers;
                      window.savedUserMarkers = updatedMarkers;
                      hasUpdates = true;
                    }
                    
                    if (hasUpdates) {
                      updates.lastUpdated = window.firestore.serverTimestamp();
                      await window.firestore.updateDoc(userDocRef, updates);
                      
                      // UI ê°±ì‹ 
                      try {
                        displayUserAddedItemsFromFirebase(window.firebaseUserItems || []);
                        drawAllSavedRoutes();
                        drawAllSavedMarkers();
                        updateRouteRemoveButtons();
                      } catch (uiErr) {
                        console.warn('ì¼ì • ì œëª© ë³€ê²½ í›„ UI ê°±ì‹  ê²½ê³ :', uiErr);
                      }
                    }
                  }
                } catch (relErr) {
                  console.error('ì—°ê´€ ë°ì´í„° ì œëª©/ìœ„ì¹˜ ê°±ì‹  ì‹¤íŒ¨:', relErr);
                }
                
                // UI ì—…ë°ì´íŠ¸ (í•´ë‹¹ ì»¨í…Œì´ë„ˆ í…ìŠ¤íŠ¸/ì†ì„± ë°˜ì˜)
                const scheduleBtn = cachedElements[`schedule_${scheduleId}`] || document.querySelector(`[data-schedule-id="${scheduleId}"] .toggle-btn`);
                const scheduleContainer = document.querySelector(`[data-schedule-id="${scheduleId}"]`);
                if (scheduleBtn && scheduleContainer) {
                  scheduleBtn.textContent = newTitle;
                  scheduleBtn.setAttribute('data-schedule-title', newTitle);
                  scheduleContainer.setAttribute('data-schedule-title', newTitle);
                }
                
                onFirebaseUploadSuccess('ì¼ì • ìˆ˜ì •');
              }
            }
          }
          
          // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
          closeEditScheduleDialog();
          
        } catch (error) {
          console.error('ì¼ì • ìˆ˜ì • ì‹¤íŒ¨:', error);
          alert('ì¼ì • ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }
      
      // ì¼ì • ì‚­ì œ í•¨ìˆ˜
      async function deleteSchedule(scheduleId, scheduleTitle) {
        // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ë‹«ê¸°
        const contextMenu = document.getElementById('scheduleContextMenu');
        if (contextMenu) {
          contextMenu.remove();
        }
        
        // ìŠ¤ì™€ì´í”„ ìƒíƒœ í•´ì œ
        const item = document.querySelector(`[data-schedule-id="${scheduleId}"]`);
        if (item) {
          item.classList.remove('swiped');
          const itemContent = item.querySelector('.item-content');
          if (itemContent) {
            itemContent.style.transform = 'translateX(0)';
          }
        }
        
        if (!confirm(`"${scheduleTitle}" ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          return;
        }
        
        try {
          // Firebaseì—ì„œ í•´ë‹¹ ì¼ì • ì œê±°
          if (window.db && window.firestore) {
            const docSnap = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', 'currentUser'));
            if (docSnap.exists() && docSnap.data().customSchedules) {
              const customSchedules = docSnap.data().customSchedules;
              const updatedSchedules = customSchedules.filter(schedule => schedule.id !== scheduleId);
              
              // Firebaseì— ì €ì¥
              await window.firestore.updateDoc(
                window.firestore.doc(window.db, 'users', 'currentUser'),
                {
                  customSchedules: updatedSchedules,
                  lastUpdated: window.firestore.serverTimestamp()
                }
              );
              
              // UIì—ì„œ ì¼ì • ì»¨í…Œì´ë„ˆ ì œê±°
              const scheduleContainer = cachedElements[`schedule_${scheduleId}`] || document.querySelector(`[data-schedule-id="${scheduleId}"]`);
              if (scheduleContainer) {
                scheduleContainer.remove();
              }
              
              onFirebaseUploadSuccess('ì¼ì • ì‚­ì œ');
            }
          }
          
        } catch (error) {
          console.error('ì¼ì • ì‚­ì œ ì‹¤íŒ¨:', error);
          alert('ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }

    </script>

         <!-- Firebase SDK ìŠ¤í¬ë¦½íŠ¸ -->
     <script type="module">
       // Import the functions you need from the SDKs you need
       import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
       import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
       import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
       // TODO: Add SDKs for Firebase products that you want to use
       // https://firebase.google.com/docs/web/setup#available-libraries

       // Your web app's Firebase configuration
       // For Firebase JS SDK v7.20.0 and later, measurementId is optional
       const firebaseConfig = {
         apiKey: "AIzaSyBhndv9tfh_Uu8Nkm7AZxjRCNIgvnGEj_c",
         authDomain: "travelplan250826.firebaseapp.com",
         projectId: "travelplan250826",
         storageBucket: "travelplan250826.firebasestorage.app",
         messagingSenderId: "918345537744",
         appId: "1:918345537744:web:08d0daace8cb0ec021e6d5",
         measurementId: "G-18R59NTNBT"
       };

       // Initialize Firebase
       const app = initializeApp(firebaseConfig);
       const analytics = getAnalytics(app);
       
       // Initialize Firestore
       const db = getFirestore(app);
       
       console.log('Firebase Firestore ì—°ê²° ì™„ë£Œ!');
       
       // ì „ì—­ ë³€ìˆ˜ë¡œ dbë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
       window.db = db;
       window.firestore = {
         collection,
         doc,
         setDoc,
         getDoc,
         updateDoc,
         arrayUnion,
         onSnapshot,
         serverTimestamp
       };
       
       // ì—°ê²° í…ŒìŠ¤íŠ¸ í›„ ì´ˆê¸°í™” ì™„ë£Œ ì´ë²¤íŠ¸ ë°œìƒ
       try {
         // ê°„ë‹¨í•œ ì—°ê²° í…ŒìŠ¤íŠ¸
         const testDoc = doc(db, 'users', 'testConnection');
         await getDoc(testDoc);
         console.log('Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ');
         
         // Firebase ì´ˆê¸°í™” ì™„ë£Œ ì´ë²¤íŠ¸ ë°œìƒ
         window.dispatchEvent(new CustomEvent('firebaseReady'));
       } catch (error) {
         console.warn('Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
         // ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨í•´ë„ ì´ˆê¸°í™”ëŠ” ì™„ë£Œë¡œ ê°„ì£¼
         window.dispatchEvent(new CustomEvent('firebaseReady'));
       }
     </script>
    
    <!-- êµ¬ê¸€ ë§µ API ìŠ¤í¬ë¦½íŠ¸. API í‚¤ì™€ ì½œë°± í•¨ìˆ˜(initMap) ì§€ì • -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDVwJrvIcbqAOX24g9JODhD7DGtTz7z2Pg&libraries=geometry,directions,places&callback=initMap" async defer></script>
</body>
</html>
